<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora RPM/Avance + Material + ae%</title>

  <!-- PWA -->
  <link rel="manifest" href="/pwa/calc-vibracion/manifest.json">
  <meta name="theme-color" content="#0b1220">

  <!-- iOS + Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="RPM+Vib">

  <!-- Iconos iOS -->
  <link rel="apple-touch-icon" href="/pwa/calc-vibracion/icons/icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/pwa/calc-vibracion/icons/icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/pwa/calc-vibracion/icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/pwa/calc-vibracion/icons/icon-120.png">

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent-teal:#0996BE; --accent-blue:#1D4ED8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    .hdr{max-width:960px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;gap:12px}
    .brand{width:40px;height:40px;border-radius:12px}
    .title{font-size:1.1rem;margin:0}
    .wrap{max-width:960px;margin:auto;padding:0 24px 24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    h2{font-size:1rem;margin:0 0 8px}
    p{margin:6px 0;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media(min-width:780px){ .grid2{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:repeat(3,1fr)} }
    label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
    input,select{width:100%;padding:.65rem;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--ink)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));color:#061521;border:none;border-radius:12px;padding:.65rem 1rem;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .out{border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:12px}
    .tag{display:inline-block;background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;margin:.15rem .25rem .15rem 0}
    .ok{color:#7dd3fc}.warn{color:#fde68a}.bad{color:#fca5a5}
    small{color:var(--muted)}
    footer{max-width:960px;margin:16px auto 24px;padding:0 24px;color:var(--muted);font-size:.85rem}
    .subtle{opacity:.85}
  </style>
</head>
<body>
  <header class="hdr">
    <img src="/pwa/calc-vibracion/icons/icon-192.png" alt="Prestige Tools" class="brand" width="40" height="40">
    <h1 class="title">Calculadora RPM/Avance + Material + ae%</h1>
  </header>

  <main class="wrap">
    <section class="card">
      <p>Selecciona material. Se calculan **RPM y Avance** automáticamente con rango de **Vc** recomendado. <span class="subtle">TPF para riesgo de vibración.</span></p>

      <div class="grid grid3">
        <div>
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div>
          <label>Diámetro D (mm)</label>
          <input id="d" type="number" step="0.01" value="10">
        </div>
        <div>
          <label>Dientes z</label>
          <input id="z" type="number" step="1" value="4">
        </div>

        <div>
          <label>f<sub>z</sub> sugerido (mm/diente)</label>
          <input id="fz" type="number" step="0.001">
          <small id="fzHint"></small>
        </div>
        <div>
          <label>ae (% del D)</label>
          <input id="aePct" type="number" step="0.1" value="50">
          <small id="aeMmHint"></small>
        </div>
        <div>
          <label>ap (mm)</label>
          <input id="ap" type="number" step="0.01" value="2">
        </div>

        <div>
          <label>Banda estable min (Hz)</label>
          <input id="hzMin" type="number" step="1" value="600">
        </div>
        <div>
          <label>Banda estable max (Hz)</label>
          <input id="hzMax" type="number" step="1" value="900">
        </div>
        <div>
          <label>Límite máx. husillo (RPM)</label>
          <input id="rpmMax" type="number" step="1" value="12000">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCalc">Calcular automático</button>
        <button class="btn" id="shareBtn">Compartir</button>
        <small id="msg"></small>
      </div>

      <div class="out" id="out"></div>
      <small>Notas: Vc y fz son orientativos; ajusta por máquina/holder/herramienta. ae en % se convierte automáticamente a mm.</small>
    </section>
  </main>

  <footer>© Prestige Tools — Paleta turquesa-azul sobre tema oscuro.</footer>

  <script>
    // ===== Presets de materiales (puedes ajustar valores a tu librería) =====
    const MATERIALS = {
      "Acero al carbono (P)": { vc_min:120, vc_max:200, fz_min:0.03, fz_max:0.08 },
      "Acero aleado (P duro)": { vc_min:80, vc_max:160, fz_min:0.02, fz_max:0.06 },
      "Acero inoxidable (M)": { vc_min:80, vc_max:160, fz_min:0.02, fz_max:0.06 },
      "Aluminio (N)": { vc_min:300, vc_max:800, fz_min:0.05, fz_max:0.15 },
      "Fundición gris (K)": { vc_min:120, vc_max:220, fz_min:0.03, fz_max:0.10 },
      "Titanio (S)": { vc_min:40, vc_max:90, fz_min:0.02, fz_max:0.06 },
      "Superaleaciones Ni/Co (S)": { vc_min:25, vc_max:60, fz_min:0.01, fz_max:0.04 }
    };

    // ===== Utilidades =====
    const $ = id => document.getElementById(id);
    const fmt = (n,d=2)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));

    // ===== Inicialización de UI =====
    (function initMaterials(){
      const sel = $("material");
      Object.keys(MATERIALS).forEach(k=>{
        const o = document.createElement("option");
        o.value = k; o.textContent = k;
        sel.appendChild(o);
      });
      sel.value = "Acero al carbono (P)";
    })();

    function updateHints(){
      const d = +$("d").value || 0;
      const aePct = +$("aePct").value || 0;
      const ae_mm = d>0 ? d * aePct / 100 : 0;
      $("aeMmHint").textContent = d>0 ? `≈ ${fmt(ae_mm,2)} mm` : "";
      const m = MATERIALS[$("material").value];
      if(m){
        $("fzHint").textContent = `Sugerencia fz: ${m.fz_min}–${m.fz_max} mm/diente`;
        const fzVal = +$("fz").value || 0;
        if(fzVal===0){
          const fzMid = ((m.fz_min + m.fz_max)/2);
          $("fz").value = fzMid.toFixed(3);
        }
      }
    }

    // ===== Cálculo principal =====
    function calcular(){
      const mat = MATERIALS[$("material").value];
      const d = +$("d").value, z = +$("z").value;
      const fz = +$("fz").value, ap = +$("ap").value;
      const aePct = +$("aePct").value;
      const ae = d>0 ? d * aePct / 100 : 0;                 // mm a partir de %
      const rpmMax = +$("rpmMax").value || Infinity;
      const hzMin = +$("hzMin").value, hzMax = +$("hzMax").value;

      if(!mat || d<=0 || z<=0 || fz<=0 || ap<0 || aePct<0 || hzMin<=0 || hzMax<=hzMin){
        $("out").textContent = "Completa datos válidos."; return;
      }

      // Rango de Vc según material
      const Vc_min = mat.vc_min, Vc_max = mat.vc_max;

      // RPM por Vc
      let rpm_min_vc = Math.floor((1000 * Vc_min) / (Math.PI * d));
      let rpm_max_vc = Math.floor((1000 * Vc_max) / (Math.PI * d));
      rpm_min_vc = clamp(rpm_min_vc, 1, rpmMax);
      rpm_max_vc = clamp(rpm_max_vc, 1, rpmMax);
      if(rpm_max_vc < rpm_min_vc){ // si el husillo recorta
        rpm_max_vc = rpm_min_vc;
      }
      const rpm_sugerida = Math.floor((rpm_min_vc + rpm_max_vc)/2);

      // Avance automático
      const Vf = rpm_sugerida * z * fz;                 // mm/min

      // MRR usando ae(ap desde % ya convertido)
      const MRR = (ae * ap * Vf)/1000;                  // cm³/min

      // TPF y riesgo vs banda
      const TPF = (rpm_sugerida * z) / 60;              // Hz
      let riskClass="bad", riskText="Alto";
      if(TPF>=hzMin && TPF<=hzMax){ riskClass="ok"; riskText="Bajo"; }
      else{
        const low=(1-0.10)*hzMin, high=(1+0.10)*hzMax;
        if(TPF>=low && TPF<=high){ riskClass="warn"; riskText="Medio"; }
      }

      // Mostrar
      $("out").innerHTML = `
        <div class="grid grid2">
          <div>
            <h2>Material</h2>
            <span class="tag">${$("material").value}</span><br>
            <span class="tag">Vc min: ${Vc_min} m/min</span>
            <span class="tag">Vc max: ${Vc_max} m/min</span>
          </div>
          <div>
            <h2>RPM por Vc</h2>
            <span class="tag">RPM min: ${rpm_min_vc}</span>
            <span class="tag">RPM max: ${rpm_max_vc}</span><br>
            <span class="tag"><b>RPM sugerida: ${rpm_sugerida}</b></span>
          </div>
          <div>
            <h2>Condiciones</h2>
            <span class="tag">fz: ${fz} mm/diente</span>
            <span class="tag">z: ${z}</span>
            <span class="tag">Vf: ${fmt(Vf,1)} mm/min</span>
          </div>
          <div>
            <h2>Carga</h2>
            <span class="tag">ae: ${fmt(ae,2)} mm (${fmt(aePct,1)}%)</span>
            <span class="tag">ap: ${fmt(ap,2)} mm</span>
            <span class="tag">MRR: ${fmt(MRR,2)} cm³/min</span>
          </div>
          <div>
            <h2>Vibración</h2>
            <span class="tag">Banda: ${hzMin}–${hzMax} Hz</span>
            <span class="tag">TPF: ${fmt(TPF,1)} Hz</span>
            <span class="tag ${riskClass}">Riesgo: ${riskText}</span>
          </div>
        </div>
      `;

      // Persistir
      const state = {
        material:$("material").value, d, z, fz, ap, aePct, rpmMax, hzMin, hzMax
      };
      localStorage.setItem("calc_vib_v2", JSON.stringify(state));
    }

    // ===== Compartir =====
    async function shareResults(){
      const t = document.getElementById('out')?.innerText || 'Resultados';
      if (navigator.share){
        try{ await navigator.share({title:'RPM+Vib', text:t}); }catch(_){}
      } else {
        try{
          await navigator.clipboard.writeText(t);
          $("msg").textContent="Resultados copiados";
          setTimeout(()=>{$("msg").textContent="";},1500);
        }catch(_){}
      }
    }

    // ===== Init / Eventos =====
    window.addEventListener("DOMContentLoaded", ()=>{
      // Cargar estado si existe
      try{
        const s = JSON.parse(localStorage.getItem("calc_vib_v2")||"{}");
        if(s.material && MATERIALS[s.material]) $("material").value = s.material;
        ["d","z","fz","ap","aePct","rpmMax","hzMin","hzMax"].forEach(k=>{
          if(s[k]!=null && $(k)) $(k).value = s[k];
        });
      }catch(_){}
      updateHints();
      ["material","d","aePct","fz"].forEach(id=> $(id).addEventListener("input", updateHints));
      ["material","d","z","fz","ap","aePct","rpmMax","hzMin","hzMax"].forEach(id=> $(id).addEventListener("input", ()=>{}));
      $("btnCalc").addEventListener("click", calcular);
      $("shareBtn").addEventListener("click", shareResults);

      // Primer cálculo
      calcular();

      // SW
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/pwa/calc-vibracion/sw.js').catch(()=>{});
      }
    });
  </script>
</body>
</html>
