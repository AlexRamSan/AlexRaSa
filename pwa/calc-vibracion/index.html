<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora RPM/Avance — Material + ae%</title>

  <!-- PWA básico -->
  <link rel="manifest" href="/pwa/calc-vibracion/manifest.json">
  <meta name="theme-color" content="#0b1220">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent-teal:#0996BE; --accent-blue:#1D4ED8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    .hdr{max-width:960px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;gap:12px}
    .brand{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));display:flex;align-items:center;justify-content:center}
    .brand svg{width:26px;height:26px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.5))}
    .title{font-size:1.1rem;margin:0}
    .wrap{max-width:960px;margin:auto;padding:0 24px 24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    h2{font-size:1rem;margin:0 0 8px}
    p{margin:6px 0;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media(min-width:780px){ .grid2{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:repeat(3,1fr)} }
    label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
    input,select{width:100%;padding:.65rem;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--ink)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));color:#061521;border:none;border-radius:12px;padding:.65rem 1rem;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .out{border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:12px}
    .tag{display:inline-block;background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;margin:.15rem .25rem .15rem 0}
    .ok{color:#7dd3fc}.warn{color:#fde68a}.bad{color:#fca5a5}
    small{color:var(--muted)}
    footer{max-width:960px;margin:16px auto 24px;padding:0 24px;color:var(--muted);font-size:.85rem}
    .subtle{opacity:.85}

    /* Cuadro de resultados */
    .results{display:grid;gap:8px;margin-top:12px}
    @media(min-width:780px){ .results{grid-template-columns:1fr 1fr} }
    .resbox{background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:12px}
    .resbox h3{margin:0 0 8px;font-size:.95rem;color:#cfe6ff}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-variant-numeric:tabular-nums}
    .kv b{color:#eaf4ff}
  </style>
</head>
<body>
  <header class="hdr">
    <div class="brand" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="#e5eefb" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z"/>
      </svg>
    </div>
    <h1 class="title">Calculadora RPM/Avance — Material + ae%</h1>
  </header>

  <main class="wrap">
    <section class="card">
      <p>Material con presets de <b>Vc</b> y <b>fz</b>. Banda TPF <b>automática</b>. Calcula <b>RPM</b> y <b>Vf</b> mínimos, máximos y óptimos. <b>ae</b> en % del diámetro.</p>

      <div class="grid grid3">
        <div>
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div>
          <label>Diámetro D (mm)</label>
          <input id="d" type="number" step="0.01" value="10">
        </div>
        <div>
          <label>Dientes z</label>
          <input id="z" type="number" step="1" value="4">
        </div>

        <div>
          <label>f<sub>z</sub> (mm/diente)</label>
          <input id="fz" type="number" step="0.001">
          <small id="fzHint"></small>
        </div>
        <div>
          <label>ae (% del D)</label>
          <input id="aePct" type="number" step="0.1" value="50">
          <small id="aeMmHint"></small>
        </div>
        <div>
          <label>ap (mm)</label>
          <input id="ap" type="number" step="0.01" value="2">
        </div>

        <div>
          <label>Límite máx. husillo (RPM)</label>
          <input id="rpmMax" type="number" step="1" value="12000">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCalc">Calcular</button>
        <button class="btn" id="btnOpt">Condiciones óptimas</button>
        <button class="btn" id="shareBtn">Compartir</button>
        <small id="msg"></small>
      </div>

      <div class="out" id="out"></div>

      <!-- Cuadro de resultados -->
      <div class="results">
        <div class="resbox">
          <h3>RPM</h3>
          <div class="kv"><span>Mínimo</span><b id="rpmMin">—</b></div>
          <div class="kv"><span>Máximo</span><b id="rpmMaxOut">—</b></div>
          <div class="kv"><span>Óptimo</span><b id="rpmOpt">—</b></div>
        </div>
        <div class="resbox">
          <h3>Avance (Vf)</h3>
          <div class="kv"><span>Mínimo</span><b id="vfMin">—</b></div>
          <div class="kv"><span>Máximo</span><b id="vfMax">—</b></div>
          <div class="kv"><span>Óptimo</span><b id="vfOpt">—</b></div>
        </div>
      </div>

      <small>Para que el ícono se vea: coloca tus PNG en <code>/pwa/calc-vibracion/icons/</code> con los nombres del manifest.</small>
    </section>
  </main>

  <footer>© Prestige Tools</footer>

  <script>
    // ===== Presets de materiales y bandas TPF =====
    const MATERIALS = {
      "Acero al carbono (P)": { vc_min:120, vc_max:200, fz_min:0.03, fz_max:0.08, hz_min:600, hz_max:900 },
      "Acero aleado (P duro)": { vc_min:80,  vc_max:160, fz_min:0.02, fz_max:0.06, hz_min:550, hz_max:850 },
      "Acero inoxidable (M)": { vc_min:80,  vc_max:160, fz_min:0.02, fz_max:0.06, hz_min:550, hz_max:850 },
      "Aluminio (N)":        { vc_min:300, vc_max:800, fz_min:0.05, fz_max:0.15, hz_min:800, hz_max:1200 },
      "Fundición gris (K)":  { vc_min:120, vc_max:220, fz_min:0.03, fz_max:0.10, hz_min:600, hz_max:900 },
      "Titanio (S)":         { vc_min:40,  vc_max:90,  fz_min:0.02, fz_max:0.06, hz_min:450, hz_max:750 },
      "Superaleaciones Ni/Co (S)": { vc_min:25, vc_max:60, fz_min:0.01, fz_max:0.04, hz_min:450, hz_max:700 }
    };

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const fmt = (n,d=2)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
    const LSKEY = "calc_vib_threefiles_v2";

    // ===== UI =====
    function populateMaterials(){
      const sel = $("material");
      sel.innerHTML = "";
      Object.keys(MATERIALS).forEach(k=>{
        const o = document.createElement("option");
        o.value = k; o.textContent = k;
        sel.appendChild(o);
      });
      const s = JSON.parse(localStorage.getItem(LSKEY)||"{}");
      if(s.material && MATERIALS[s.material]) sel.value = s.material; else sel.selectedIndex = 0;
    }

    function updateHints(){
      const d = +$("d").value || 0;
      const aePct = +$("aePct").value || 0;
      const ae_mm = d>0 ? d * aePct / 100 : 0;
      $("aeMmHint").textContent = d>0 ? `≈ ${fmt(ae_mm,2)} mm` : "";

      const m = MATERIALS[$("material").value];
      if(m){
        $("fzHint").textContent = `Sugerencia fz: ${m.fz_min}–${m.fz_max} mm/diente`;
        const fzVal = +$("fz").value || 0;
        if(fzVal===0){ $("fz").value = ((m.fz_min + m.fz_max)/2).toFixed(3); }
      }
    }

    function readModel(){
      return {
        material:$("material").value,
        d:+$("d").value, z:+$("z").value, fz:+$("fz").value,
        ap:+$("ap").value, aePct:+$("aePct").value,
        rpmMax:+$("rpmMax").value || Infinity
      };
    }

    function compute(model){
      const { material, d, z, fz, ap, aePct, rpmMax } = model;
      const m = MATERIALS[material];
      if(!m || d<=0 || z<=0 || fz<=0 || ap<0 || aePct<0) return {error:"Completa datos válidos."};

      const ae = d * aePct / 100; // mm
      const Vc_min = m.vc_min, Vc_max = m.vc_max;

      // RPM por Vc
      let rpm_min_vc = Math.floor((1000 * Vc_min) / (Math.PI * d));
      let rpm_max_vc = Math.floor((1000 * Vc_max) / (Math.PI * d));
      rpm_min_vc = clamp(rpm_min_vc, 1, rpmMax);
      rpm_max_vc = clamp(rpm_max_vc, 1, rpmMax);
      if(rpm_max_vc < rpm_min_vc) rpm_max_vc = rpm_min_vc;

      // TPF auto
      const hzMin = m.hz_min, hzMax = m.hz_max;
      const rpm_min_tpf = Math.floor(60*hzMin / z);
      const rpm_max_tpf = Math.floor(60*hzMax / z);

      // Solape Vc ∩ TPF
      const rpm_overlap_min = Math.max(rpm_min_vc, rpm_min_tpf);
      const rpm_overlap_max = Math.min(rpm_max_vc, rpm_max_tpf);
      const hasOverlap = rpm_overlap_max >= rpm_overlap_min;

      // RPM óptima
      const rpm_opt = hasOverlap
        ? Math.floor((rpm_overlap_min + rpm_overlap_max)/2)
        : Math.floor((rpm_min_vc + rpm_max_vc)/2);

      // Avances min/máx/óptimo
      const Vf_min = rpm_min_vc * z * m.fz_min;
      const Vf_max = rpm_max_vc * z * m.fz_max;
      const fz_mid = (m.fz_min + m.fz_max)/2;
      const Vf_opt = rpm_opt * z * fz_mid;

      const MRR = (ae * ap * Vf_opt)/1000; // cm³/min
      const TPF = (rpm_opt * z) / 60;      // Hz
      let riskClass="bad", riskText="Alto";
      if(TPF>=hzMin && TPF<=hzMax){ riskClass="ok"; riskText="Bajo"; }
      else{
        const low=(1-0.10)*hzMin, high=(1+0.10)*hzMax;
        if(TPF>=low && TPF<=high){ riskClass="warn"; riskText="Medio"; }
      }

      return {
        Vc_min, Vc_max,
        rpm_min_vc, rpm_max_vc, rpm_opt,
        rpm_min_tpf, rpm_max_tpf, hasOverlap,
        fz_mid,
        Vf_min, Vf_max, Vf_opt,
        ae, MRR, TPF, hzMin, hzMax, riskClass, riskText
      };
    }

    function render(res, model){
      if(res.error){ $("out").textContent = res.error; return; }
      $("out").innerHTML = `
        <div class="grid grid2">
          <div>
            <h2>Material</h2>
            <span class="tag">${model.material}</span><br>
            <span class="tag">Vc: ${res.Vc_min}–${res.Vc_max} m/min</span>
            <span class="tag">TPF auto: ${res.hzMin}–${res.hzMax} Hz</span>
          </div>
          <div>
            <h2>Estado</h2>
            <span class="tag">fz actual: ${model.fz} mm/diente</span>
            <span class="tag">fz óptimo: ${res.fz_mid.toFixed(3)}</span>
            <span class="tag ${res.riskClass}">Riesgo: ${res.riskText}</span>
            <span class="tag">TPF: ${fmt(res.TPF,1)} Hz</span>
          </div>
          <div>
            <h2>Carga</h2>
            <span class="tag">ae: ${fmt(res.ae,2)} mm (${fmt(model.aePct,1)}%)</span>
            <span class="tag">ap: ${fmt(model.ap,2)} mm</span>
            <span class="tag">MRR: ${fmt(res.MRR,2)} cm³/min</span>
          </div>
        </div>
      `;

      // Cuadro de resultados
      $("rpmMin").textContent   = `${res.rpm_min_vc}`;
      $("rpmMaxOut").textContent= `${res.rpm_max_vc}`;
      $("rpmOpt").textContent   = `${res.rpm_opt}`;
      $("vfMin").textContent    = `${fmt(res.Vf_min,1)} mm/min`;
      $("vfMax").textContent    = `${fmt(res.Vf_max,1)} mm/min`;
      $("vfOpt").textContent    = `${fmt(res.Vf_opt,1)} mm/min`;
    }

    function saveState(){
      const s = {
        material:$("material").value,
        d:+$("d").value, z:+$("z").value, fz:+$("fz").value,
        ap:+$("ap").value, aePct:+$("aePct").value, rpmMax:+$("rpmMax").value
      };
      localStorage.setItem(LSKEY, JSON.stringify(s));
    }

    function calcAndRender(){
      const model = readModel();
      const res = compute(model);
      render(res, model);
      saveState();
    }

    function setOptimas(){
      const m = MATERIALS[$("material").value];
      if(!m) return;
      $("fz").value = ((m.fz_min + m.fz_max)/2).toFixed(3);
      calcAndRender();
      $("msg").textContent = "Condiciones óptimas aplicadas";
      setTimeout(()=>{$("msg").textContent="";},1500);
    }

    async function shareResults(){
      const t = document.body.innerText;
      if (navigator.share){
        try{ await navigator.share({title:'RPM+Avance', text:t}); }catch(_){}
      } else {
        try{
          await navigator.clipboard.writeText(t);
          $("msg").textContent="Resultados copiados";
          setTimeout(()=>{$("msg").textContent="";},1500);
        }catch(_){}
      }
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      populateMaterials();
      try{
        const s = JSON.parse(localStorage.getItem(LSKEY)||"{}");
        ["d","z","fz","ap","aePct","rpmMax"].forEach(k=>{ if(s[k]!=null && $(k)) $(k).value = s[k]; });
        if(s.material && MATERIALS[s.material]) $("material").value = s.material;
      }catch(_){}
      updateHints();
      ["material","d","z","fz","ap","aePct","rpmMax"].forEach(id=> $(id).addEventListener("input", updateHints));
      $("btnCalc").addEventListener("click", calcAndRender);
      $("btnOpt").addEventListener("click", setOptimas);
      $("shareBtn").addEventListener("click", shareResults);
      calcAndRender();

      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/pwa/calc-vibracion/sw.js').catch(()=>{});
      }
    });
  </script>
</body>
</html>
