<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora RPM/Avance — Material + ae%</title>

  <!-- PWA -->
  <link rel="manifest" href="/pwa/calc-vibracion/manifest.json">
  <meta name="theme-color" content="#0b1220">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent-teal:#0996BE; --accent-blue:#1D4ED8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    .hdr{max-width:960px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;gap:12px}
    .brand{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));display:flex;align-items:center;justify-content:center}
    .brand svg{width:26px;height:26px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.5))}
    .title{font-size:1.1rem;margin:0}
    .wrap{max-width:960px;margin:auto;padding:0 24px 24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    h2{font-size:1rem;margin:0 0 8px}
    p{margin:6px 0;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media(min-width:780px){ .grid2{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:repeat(3,1fr)} }
    label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
    input,select{width:100%;padding:.65rem;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--ink)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));color:#061521;border:none;border-radius:12px;padding:.65rem 1rem;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .out{border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:12px}
    .tag{display:inline-block;background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;margin:.15rem .25rem .15rem 0}
    .ok{color:#7dd3fc}.warn{color:#fde68a}.bad{color:#fca5a5}
    small{color:var(--muted)}
    footer{max-width:960px;margin:16px auto 24px;padding:0 24px;color:var(--muted);font-size:.85rem}
    .subtle{opacity:.85}
  </style>
</head>
<body>
  <header class="hdr">
    <div class="brand" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="#e5eefb" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z"/>
      </svg>
    </div>
    <h1 class="title">Calculadora RPM/Avance — Material + ae%</h1>
  </header>

  <main class="wrap">
    <section class="card">
      <p>Elige material. Calcula <b>RPM</b> y <b>avance</b> min/máx y sugeridos. <b>Vc</b> y <b>TPF</b> automáticos por material. <b>ae</b> en % del diámetro.</p>

      <div class="grid grid3">
        <div>
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div>
          <label>Diámetro D (mm)</label>
          <input id="d" type="number" step="0.01" value="10">
        </div>
        <div>
          <label>Dientes z</label>
          <input id="z" type="number" step="1" value="4">
        </div>

        <div>
          <label>f<sub>z</sub> (mm/diente)</label>
          <input id="fz" type="number" step="0.001">
          <small id="fzHint"></small>
        </div>
        <div>
          <label>ae (% del D)</label>
          <input id="aePct" type="number" step="0.1" value="50">
          <small id="aeMmHint"></small>
        </div>
        <div>
          <label>ap (mm)</label>
          <input id="ap" type="number" step="0.01" value="2">
        </div>

        <div>
          <label>Límite máx. husillo (RPM)</label>
          <input id="rpmMax" type="number" step="1" value="12000">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCalc">Calcular</button>
        <button class="btn" id="btnOpt">Condiciones óptimas</button>
        <button class="btn" id="shareBtn">Compartir</button>
        <small id="msg"></small>
      </div>

      <div class="out" id="out"></div>
      <small>Instalable y offline con este mismo folder.</small>
    </section>
  </main>

  <footer>© Prestige Tools</footer>

  <script>
    // ===== Presets de materiales y bandas TPF (todo dentro del HTML) =====
    const MATERIALS = {
      "Acero al carbono (P)": { vc_min:120, vc_max:200, fz_min:0.03, fz_max:0.08, hz_min:600, hz_max:900 },
      "Acero aleado (P duro)": { vc_min:80,  vc_max:160, fz_min:0.02, fz_max:0.06, hz_min:550, hz_max:850 },
      "Acero inoxidable (M)": { vc_min:80,  vc_max:160, fz_min:0.02, fz_max:0.06, hz_min:550, hz_max:850 },
      "Aluminio (N)":        { vc_min:300, vc_max:800, fz_min:0.05, fz_max:0.15, hz_min:800, hz_max:1200 },
      "Fundición gris (K)":  { vc_min:120, vc_max:220, fz_min:0.03, fz_max:0.10, hz_min:600, hz_max:900 },
      "Titanio (S)":         { vc_min:40,  vc_max:90,  fz_min:0.02, fz_max:0.06, hz_min:450, hz_max:750 },
      "Superaleaciones Ni/Co (S)": { vc_min:25, vc_max:60, fz_min:0.01, fz_max:0.04, hz_min:450, hz_max:700 }
    };

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const fmt = (n,d=2)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
    const LSKEY = "calc_vib_threefiles_v1";

    // ===== UI =====
    function populateMaterials(){
      const sel = $("material");
      sel.innerHTML = "";
      Object.keys(MATERIALS).forEach(k=>{
        const o = document.createElement("option");
        o.value = k; o.textContent = k;
        sel.appendChild(o);
      });
      const s = JSON.parse(localStorage.getItem(LSKEY)||"{}");
      if(s.material && MATERIALS[s.material]) sel.value = s.material;
      else sel.selectedIndex = 0;
    }

    function updateHints(){
      const d = +$("d").value || 0;
      const aePct = +$("aePct").value || 0;
      const ae_mm = d>0 ? d * aePct / 100 : 0;
      $("aeMmHint").textContent = d>0 ? `≈ ${fmt(ae_mm,2)} mm` : "";

      const m = MATERIALS[$("material").value];
      if(m){
        $("fzHint").textContent = `Sugerencia fz: ${m.fz_min}–${m.fz_max} mm/diente`;
        const fzVal = +$("fz").value || 0;
        if(fzVal===0){
          const fzMid = ((m.fz_min + m.fz_max)/2);
          $("fz").value = fzMid.toFixed(3);
        }
      }
    }

    function readModel(){
      return {
        material: $("material").value,
        d:+$("d").value, z:+$("z").value, fz:+$("fz").value,
        ap:+$("ap").value, aePct:+$("aePct").value,
        rpmMax:+$("rpmMax").value || Infinity
      };
    }

    function compute(model){
      const { material, d, z, fz, ap, aePct, rpmMax } = model;
      const m = MATERIALS[material];
      if(!m || d<=0 || z<=0 || fz<=0 || ap<0 || aePct<0) return {error:"Completa datos válidos."};

      const ae = d * aePct / 100;        // mm
      const Vc_min = m.vc_min, Vc_max = m.vc_max;

      // RPM por Vc
      let rpm_min_vc = Math.floor((1000 * Vc_min) / (Math.PI * d));
      let rpm_max_vc = Math.floor((1000 * Vc_max) / (Math.PI * d));
      rpm_min_vc = clamp(rpm_min_vc, 1, rpmMax);
      rpm_max_vc = clamp(rpm_max_vc, 1, rpmMax);
      if(rpm_max_vc < rpm_min_vc){ rpm_max_vc = rpm_min_vc; }

      // Banda TPF automática por material
      const hzMin = m.hz_min, hzMax = m.hz_max;
      const rpm_min_tpf = Math.floor(60*hzMin / z);
      const rpm_max_tpf = Math.floor(60*hzMax / z);

      // Solape Vc ∩ TPF
      const rpm_overlap_min = Math.max(rpm_min_vc, rpm_min_tpf);
      const rpm_overlap_max = Math.min(rpm_max_vc, rpm_max_tpf);
      const hasOverlap = rpm_overlap_max >= rpm_overlap_min;

      // RPM sugerida
      const rpm_sugerida = hasOverlap
        ? Math.floor((rpm_overlap_min + rpm_overlap_max)/2)
        : Math.floor((rpm_min_vc + rpm_max_vc)/2);

      // Avances min/máx y sugerido
      const Vf_min = rpm_min_vc * z * m.fz_min;
      const Vf_max = rpm_max_vc * z * m.fz_max;
      const fz_mid = (m.fz_min + m.fz_max)/2;
      const Vf_sugerido = rpm_sugerida * z * fz_mid;

      const MRR = (ae * ap * Vf_sugerido)/1000; // cm³/min
      const TPF = (rpm_sugerida * z) / 60;      // Hz
      let riskClass="bad", riskText="Alto";
      if(TPF>=hzMin && TPF<=hzMax){ riskClass="ok"; riskText="Bajo"; }
      else{
        const low=(1-0.10)*hzMin, high=(1+0.10)*hzMax;
        if(TPF>=low && TPF<=high){ riskClass="warn"; riskText="Medio"; }
      }

      return {
        Vc_min, Vc_max,
        rpm_min_vc, rpm_max_vc,
        rpm_min_tpf, rpm_max_tpf,
        rpm_overlap_min, rpm_overlap_max, hasOverlap,
        rpm_sugerida,
        fz_mid,
        Vf_min, Vf_max, Vf_sugerido,
        ae, MRR, TPF, hzMin, hzMax, riskClass, riskText
      };
    }

    function render(result, model){
      if(result.error){ $("out").textContent = result.error; return; }
      const mat = model.material;
      $("out").innerHTML = `
        <div class="grid grid2">
          <div>
            <h2>Material</h2>
            <span class="tag">${mat}</span><br>
            <span class="tag">Vc min: ${result.Vc_min} m/min</span>
            <span class="tag">Vc max: ${result.Vc_max} m/min</span><br>
            <span class="tag">TPF aut.: ${result.hzMin}–${result.hzMax} Hz</span>
          </div>
          <div>
            <h2>RPM</h2>
            <span class="tag">por Vc: ${result.rpm_min_vc}–${result.rpm_max_vc}</span><br>
            <span class="tag">por TPF: ${result.rpm_min_tpf}–${result.rpm_max_tpf}</span><br>
            <span class="tag"><b>RPM sugerida: ${result.rpm_sugerida}</b></span>
          </div>
          <div>
            <h2>Avance</h2>
            <span class="tag">fz actual: ${model.fz} mm/diente</span>
            <span class="tag">fz óptimo: ${result.fz_mid.toFixed(3)}</span><br>
            <span class="tag">Vf min: ${fmt(result.Vf_min,1)} mm/min</span>
            <span class="tag">Vf max: ${fmt(result.Vf_max,1)} mm/min</span><br>
            <span class="tag"><b>Vf sugerido: ${fmt(result.Vf_sugerido,1)} mm/min</b></span>
          </div>
          <div>
            <h2>Carga</h2>
            <span class="tag">ae: ${fmt(result.ae,2)} mm (${fmt(model.aePct,1)}%)</span>
            <span class="tag">ap: ${fmt(model.ap,2)} mm</span>
            <span class="tag">MRR: ${fmt(result.MRR,2)} cm³/min</span>
          </div>
          <div>
            <h2>Vibración</h2>
            <span class="tag">TPF: ${fmt(result.TPF,1)} Hz</span>
            <span class="tag ${result.riskClass}">Riesgo: ${result.riskText}</span>
            ${result.hasOverlap ? '' : '<br><small class="subtle">Sin solape Vc–TPF: usando centro del rango por Vc.</small>'}
          </div>
        </div>
      `;
    }

    function saveState(){
      const s = {
        material:$("material").value,
        d:+$("d").value, z:+$("z").value, fz:+$("fz").value,
        ap:+$("ap").value, aePct:+$("aePct").value, rpmMax:+$("rpmMax").value
      };
      localStorage.setItem(LSKEY, JSON.stringify(s));
    }

    function calcAndRender(){
      const model = {
        material:$("material").value,
        d:+$("d").value, z:+$("z").value, fz:+$("fz").value,
        ap:+$("ap").value, aePct:+$("aePct").value, rpmMax:+$("rpmMax").value || Infinity
      };
      const res = compute(model);
      render(res, model);
      saveState();
    }

    function setOptimas(){
      const m = MATERIALS[$("material").value];
      if(!m) return;
      $("fz").value = ((m.fz_min + m.fz_max)/2).toFixed(3);
      calcAndRender();
      $("msg").textContent = "Condiciones óptimas aplicadas";
      setTimeout(()=>{$("msg").textContent="";},1500);
    }

    async function shareResults(){
      const t = document.getElementById('out')?.innerText || 'Resultados';
      if (navigator.share){
        try{ await navigator.share({title:'RPM+Avance', text:t}); }catch(_){}
      } else {
        try{
          await navigator.clipboard.writeText(t);
          $("msg").textContent="Resultados copiados";
          setTimeout(()=>{$("msg").textContent="";},1500);
        }catch(_){}
      }
    }

    // ===== Init =====
    window.addEventListener("DOMContentLoaded", ()=>{
      populateMaterials();

      try{
        const s = JSON.parse(localStorage.getItem(LSKEY)||"{}");
        ["d","z","fz","ap","aePct","rpmMax"].forEach(k=>{ if(s[k]!=null && $(k)) $(k).value = s[k]; });
        if(s.material && MATERIALS[s.material]) $("material").value = s.material;
      }catch(_){}

      updateHints();
      ["material","d","z","fz","ap","aePct","rpmMax"].forEach(id=> $(id).addEventListener("input", ()=>{ updateHints(); }));
      $("btnCalc").addEventListener("click", calcAndRender);
      $("btnOpt").addEventListener("click", setOptimas);
      $("shareBtn").addEventListener("click", shareResults);

      calcAndRender();

      // Registrar SW para offline (archivo aparte obligatorio en iOS)
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/pwa/calc-vibracion/sw.js').catch(()=>{});
      }
    });
  </script>
</body>
</html>
