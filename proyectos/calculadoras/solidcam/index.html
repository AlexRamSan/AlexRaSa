<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SolidCAM ROI — Calculadora de Costo‑Beneficio</title>
<meta name="description" content="Calculadora ROI para SolidCAM: escenarios rápidos, pagos 30/3, ROI, payback y flujo mensual." />
<meta name="theme-color" content="#0F172A" />
<meta name="robots" content="index,follow" />
<link rel="canonical" href="https://alexrasa.store/proyectos/calculadoras/solidcam/" />

<!-- Manifest + PWA -->
<link rel="manifest" href="/proyectos/calculadoras/solidcam/solidcam.webmanifest">
<meta name="color-scheme" content="dark">

<!-- Íconos (ajusta rutas según tus archivos) -->
<link rel="icon" type="image/png" sizes="32x32" href="/proyectos/calculadoras/solidcam/icons/icon-256.png" />
<link rel="apple-touch-icon" href="/proyectos/calculadoras/solidcam/icons/icon-192.png" />

<!-- Preload de hero para evitar flash -->
<link rel="preload" as="image" href="/assets/hero-industrial.png">

<!-- Tailwind CDN para prototipo. Para producción instala Tailwind con CLI/PostCSS. -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    color-scheme: dark;
    --bg:#071027;
    --card:#0f172a;
    --text:#e6eef8;
    --accent:#60a5fa;
    --accent-2:#6366F1;
    --good:#22C55E;
    --warn:#F59E0B;
    --bad:#EF4444;
  }
  html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  a{color:var(--accent)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); border-radius:14px}
  input,select,textarea{background:rgba(255,255,255,0.02); color:var(--text); border:1px solid rgba(255,255,255,0.06); padding:.55rem .65rem; border-radius:.6rem}
  input:focus,select:focus{box-shadow:0 0 0 6px rgba(99,102,241,0.10); outline:none}

  .hero-bg{ position:relative; background-size:cover; background-position:center; min-height:360px; overflow:hidden; }
  .hero-bg::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.25), rgba(2,6,23,0.65));z-index:1}
  .hero-content{position:relative;z-index:2}

  .stat{border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:12px}
  .badge{display:inline-block;padding:.25rem .55rem;border-radius:999px;font-weight:700;font-size:11px;min-width:56px;text-align:center;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03)}
  .badge.up{background:linear-gradient(180deg,#16a34a,#059669);color:#fff;border-color:rgba(5,118,78,0.25)}
  .badge.mid{background:linear-gradient(180deg,#f59e0b,#d97706);color:#111;border-color:rgba(217,119,6,0.25)}
  .badge.down{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff;border-color:rgba(220,38,38,0.25)}

  table{border-collapse:separate;border-spacing:0 8px}
  thead th{font-weight:600;color:#cbd5e1}
  tbody tr{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)}
  tbody td{border-top:1px solid rgba(255,255,255,0.04);border-bottom:1px solid rgba(255,255,255,0.04)}
  .viz-lg{ min-height:520px }
</style>
</head>
<body class="antialiased">

<!-- HEADER -->
<header class="sticky top-0 z-40 backdrop-blur" style="background:rgba(2,6,23,0.55);border-bottom:1px solid rgba(255,255,255,0.04)">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between gap-3">
      <a href="/" class="flex items-center gap-2 shrink-0" aria-label="Inicio">
        <img src="/assets/logo.png" alt="AlexRaSa" class="h-9 w-auto" />
        <span class="hidden sm:inline text-base font-semibold tracking-tight">AlexRaSa<span style="color:var(--accent)">.store</span></span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="/SolidCAM/" class="hover:text-sky-400">Soluciones</a>
        <a href="/#recursos" class="hover:text-sky-400">Recursos</a>
        <a href="/#contacto" class="hover:text-sky-400">Contacto</a>
      </nav>
    </div>
  </div>
</header>

<!-- HERO -->
<section class="hero-bg" style="background-image:url('/assets/hero-industrial.png')">
  <div class="hero-content max-w-6xl mx-auto px-4 py-12 md:py-20">
    <h1 class="text-3xl md:text-5xl font-extrabold">SolidCAM ROI — <span style="color:var(--accent)">Calculadora</span></h1>
    <p class="mt-3 max-w-3xl text-slate-200">Escoge escenarios rápidos o captura tus ahorros por área. Calcula ROI, payback y flujo con pago contado o 30/3.</p>
  </div>
</section>

<!-- MAIN -->
<main class="max-w-6xl mx-auto px-4 pt-8 pb-24 grid gap-5 lg:grid-cols-12">
  <!-- FORM -->
  <section class="card p-5 lg:col-span-4 lg:sticky lg:top-20 max-h-[calc(100vh-6rem)] overflow-auto">
    <h2 class="text-lg font-semibold">Entradas</h2>

    <div class="mt-4 space-y-6">
      <!-- Escenarios rápidos -->
      <div class="space-y-2">
        <div class="text-sm font-semibold">Escenarios rápidos</div>
        <div class="flex flex-wrap gap-2 text-sm">
          <button type="button" class="px-2 py-1 rounded border" data-scn="100">100 NC/mes → $18,000</button>
          <button type="button" class="px-2 py-1 rounded border" data-scn="150">150 NC/mes → $27,000</button>
          <button type="button" class="px-2 py-1 rounded border" data-scn="200">200 NC/mes → $36,000</button>
          <button type="button" class="px-2 py-1 rounded border" id="btnClearScn">Limpiar</button>
        </div>
        <p class="text-xs text-slate-400">Los escenarios fijan un ahorro mensual total directo. Para un desglose propio usa los campos de abajo y pulsa Limpiar.</p>
      </div>

      <!-- Ahorros por área (editable) -->
      <fieldset class="space-y-3">
        <legend class="text-sm font-semibold">Ahorros mensuales por área (USD)</legend>
        <div class="grid grid-cols-2 gap-3">
          <label class="text-sm">iMachining (ciclo)
            <input id="ah_iMach" type="number" value="8000">
          </label>
          <label class="text-sm">Programación (tiempo)
            <input id="ah_prog" type="number" value="3500">
          </label>
          <label class="text-sm">Herramental/colisiones
            <input id="ah_tools" type="number" value="1800">
          </label>
          <label class="text-sm">Setup/doc estandarizada
            <input id="ah_setup" type="number" value="1200">
          </label>
        </div>
        <p class="text-xs text-slate-400">Estos campos construyen el total cuando no hay escenario activo.</p>
      </fieldset>

      <!-- Finanzas -->
      <fieldset class="space-y-3">
        <legend class="text-sm font-semibold">Finanzas</legend>
        <div class="grid grid-cols-2 gap-3">
          <label class="text-sm">Inversión inicial (USD)
            <input id="capex" type="number" value="46526.20">
          </label>
          <label class="text-sm">Mensualidad (USD) — si aplica
            <input id="mensualidad" type="number" value="0">
          </label>
        </div>
        <div class="mt-2 flex gap-4 text-sm">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="paymode" id="payContado" checked> Contado/cuota fija
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="paymode" id="pay303"> 30% inicial + 3 meses
          </label>
        </div>
      </fieldset>

      <button id="btnCalc" class="w-full py-2.5 rounded-md font-semibold" style="background:var(--accent-2);color:white">Calcular</button>
    </div>
  </section>

  <!-- OUTPUT: KPIs + Tabla + Gráficos -->
  <section class="lg:col-span-8 grid gap-5">
    <!-- KPIs -->
    <div class="card p-4">
      <h3 class="text-sm font-semibold mb-3">KPIs</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="stat">
          <div class="text-xs text-slate-300">ROI anual</div>
          <div id="kpiROI" class="text-xl font-bold">0%</div>
        </div>
        <div class="stat">
          <div class="text-xs text-slate-300">Payback (meses)</div>
          <div id="kpiPayback" class="text-xl font-bold">—</div>
        </div>
        <div class="stat">
          <div class="text-xs text-slate-300">Neto en M1</div>
          <div id="kpiNeto" class="text-xl font-bold">$0</div>
        </div>
        <div class="stat">
          <div class="text-xs text-slate-300">Caso dominante</div>
          <div id="kpiTop" class="text-sm"><span class="badge">—</span></div>
        </div>
      </div>
    </div>

    <!-- Tabla a todo el ancho -->
    <div class="card p-5">
      <h2 class="text-lg font-semibold">Comparativa de ahorros</h2>
      <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
        <table class="w-full text-sm">
          <thead>
            <tr>
              <th class="text-left px-2 py-1">Concepto</th>
              <th class="text-right px-2 py-1">Ahorro mensual (USD)</th>
              <th class="text-right px-2 py-1">Estado</th>
            </tr>
          </thead>
          <tbody id="tbodyAhorros"></tbody>
          <tfoot>
            <tr>
              <td class="px-2 py-2 font-semibold">Total</td>
              <td id="tdTotal" class="px-2 py-2 text-right font-semibold"></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Gráficos en columna, uno debajo del otro -->
    <div class="card p-4">
      <h3 class="text-sm font-semibold">Distribución de ahorros</h3>
      <div id="vizDonut" class="mt-3 viz-lg"></div>
    </div>
    <div class="card p-4">
      <h3 class="text-sm font-semibold">Flujo mensual y payback</h3>
      <div id="vizCash" class="mt-3 viz-lg"></div>
    </div>
  </section>
</main>

<footer class="py-8 text-center text-sm text-slate-400">© 2025 AlexRaSa — SolidCAM ROI</footer>

<script>
  // Utilidades
  const fmt = (n, d=2) => Number(n||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});

  // Estado de escenarios
  let overrideAhorro = null;   // número directo de ahorro mensual
  let presetActivo = null;     // "100" | "150" | "200" | null

  // Lectores de entradas de ahorro por área
  function partsFromInputs(){
    const p = [
      ['iMachining (ciclo)', +document.getElementById('ah_iMach').value||0],
      ['Programación (tiempo)', +document.getElementById('ah_prog').value||0],
      ['Herramental/colisiones', +document.getElementById('ah_tools').value||0],
      ['Setup/doc estandarizada', +document.getElementById('ah_setup').value||0],
    ];
    return p;
  }

  function calcular(){
    // Construcción de parts y total
    let parts = partsFromInputs();
    let total = parts.reduce((s,p)=>s+p[1],0);

    // Si hay escenario, sustituye total y muestra una sola fila
    if (overrideAhorro !== null) {
      total = overrideAhorro;
    }

    // Finanzas
    const capex = +document.getElementById('capex').value||0;
    const cuota = +document.getElementById('mensualidad').value||0;
    const is303 = document.getElementById('pay303')?.checked;

    // Plan de pagos
    let payments = null; // arreglo de 12 meses
    let netoRef = 0;     // neto en M1

    if (is303) {
      const anticipo = 0.30 * capex;
      const resto = 0.70 * capex;
      const m1 = Math.round((resto/3)*100)/100;
      const m2 = Math.round((resto/3)*100)/100;
      const m3 = Math.round((resto - m1 - m2)*100)/100;
      payments = Array(12).fill(0);
      payments[0] = anticipo + m1;
      payments[1] = m2;
      payments[2] = m3;
      netoRef = total - payments[0];
    } else {
      payments = Array(12).fill(cuota);
      if (capex > 0) payments[0] += capex;
      netoRef = total - payments[0];
    }

    // ROI anual y Payback
    const roiAnual = capex>0 ? ((total*12)/capex)*100 : 0;
    let acc = 0, idxPay = -1;
    for (let i=0;i<12;i++){
      const out = payments[i] || 0;
      const netoMes = total - out;
      acc += netoMes;
      if (idxPay === -1 && acc >= capex) idxPay = i+1; // meses 1..12
    }

    // Render tabla: si hay escenario, una sola fila. Si no, desglose por áreas
    const body = document.getElementById('tbodyAhorros');
    if (overrideAhorro !== null) {
      body.innerHTML = `
        <tr>
          <td class="px-2 py-2">Escenario ${presetActivo} NC/mes</td>
          <td class="px-2 py-2 text-right font-mono">$${fmt(overrideAhorro)}</td>
          <td class="px-2 py-2 text-right"><span class="badge up">+100%</span></td>
        </tr>`;
    } else {
      body.innerHTML = parts
        .filter(([_,v]) => v>0.0001)
        .map(([k,v]) => `
          <tr>
            <td class="px-2 py-2">${k}</td>
            <td class="px-2 py-2 text-right font-mono">$${fmt(v)}</td>
            <td class="px-2 py-2 text-right"><span class="badge up">+${fmt((v/Math.max(total,1))*100,0)}%</span></td>
          </tr>
        `).join('') || `<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Sin ahorros activos</td></tr>`;
    }
    document.getElementById('tdTotal').textContent = `$${fmt(total)}`;

    // KPIs
    document.getElementById('kpiROI').textContent = `${fmt(roiAnual)}%`;
    document.getElementById('kpiPayback').textContent = idxPay>0 ? idxPay : '—';
    const kN = document.getElementById('kpiNeto');
    kN.textContent = `$${fmt(netoRef)}`;
    kN.style.color = netoRef>=0 ? 'var(--good)' : 'var(--bad)';

    const top = (overrideAhorro!==null)
      ? ['Escenario', overrideAhorro]
      : parts.slice().sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('kpiTop').innerHTML = top && top[1]>0 ? `<span class="badge up">${top[0]}</span>` : '<span class="badge">—</span>';

    // Gráficos
    const partsForViz = (overrideAhorro!==null) ? [['Escenario', overrideAhorro]] : parts;
    renderDonut('vizDonut', partsForViz);
    renderCashflow('vizCash', { ahorroMes: total, payments, capex });
  }

  // Donut SVG responsivo
  function renderDonut(targetId, parts){
    const el = document.getElementById(targetId);
    if(!el) return;

    const data = parts.filter(p=>p[1]>0);
    const total = data.reduce((s,p)=>s+p[1],0);

    const W = Math.max(el.clientWidth || 980, 980);
    const H = Math.max(el.clientHeight || 520, 520);
    const cx = Math.round(W*0.33);
    const cy = Math.round(H*0.52);
    const r  = Math.round(Math.min(W,H)*0.28);
    const th = Math.round(r*0.34);

    let start=0;
    const colors=['#6366F1','#16A34A','#F59E0B','#06B6D4','#EF4444'];

    const segs = data.map((p,i)=>{
      const v=p[1], frac = total>0 ? v/total : 0;
      const a0=start*2*Math.PI, a1=(start+frac)*2*Math.PI; start+=frac;
      const large=(a1-a0)>Math.PI?1:0;
      const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0);
      const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
      const x0i=cx+(r-th)*Math.cos(a0), y0i=cy+(r-th)*Math.sin(a0);
      const x1i=cx+(r-th)*Math.cos(a1), y1i=cy+(r-th)*Math.sin(a1);
      const d=`M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${large} 0 ${x0i} ${y0i} Z`;
      const pct = total>0 ? Math.round(frac*100) : 0;
      const lx = Math.round(W*0.62), ly = 40 + 28*i;
      return `<path d="${d}" fill="${colors[i%colors.length]}" opacity="0.95"></path>
              <text x="${lx}" y="${ly}" font-size="16" fill="var(--text)">${p[0]}: ${pct}%</text>`;
    }).join('');

    const center =
      `<circle cx="${cx}" cy="${cy}" r="${r-th+14}" fill="rgba(255,255,255,0.04)"></circle>
       <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle"
             font-size="22" fill="var(--text)">${total>0?('$'+total.toLocaleString()):'—'}</text>`;

    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}" role="img"
                     aria-label="Distribución de ahorros">${segs}${center}</svg>`;
  }

  // Cashflow con pagos variables por mes
  function renderCashflow(targetId, {ahorroMes, payments, capex}){
    const el = document.getElementById(targetId);
    if(!el) return;

    const meses = Array.from({length:12}, (_,i)=>`M${i+1}`);
    const H = Math.max(el.clientHeight || 520, 520);
    const pad = 36, barW = 28, gap = 18;
    const cols = meses.length;

    const minW = pad*2 + cols*(barW*2 + gap) + 160;
    const W = Math.max(el.clientWidth || minW, minW);

    const pay = payments || Array(12).fill(0);
    const netos = meses.map((_,i)=> (ahorroMes||0) - (pay[i]||0));

    let acc = 0; const accArr = netos.map(v=>{acc+=v; return acc;});
    const maxY = Math.max(
      Math.abs(ahorroMes||0),
      ...pay.map(v=>Math.abs(v||0)),
      ...accArr.map(v=>Math.abs(v||0)),
      capex||0,
      1
    );
    const scale = v => Math.round((Math.abs(v)/maxY) * (H - pad*2));

    let x = pad + 12;
    const bars = meses.map((m, i)=>{
      const yA = H - pad - scale(ahorroMes);
      const yP = H - pad - scale(pay[i]||0);
      const hA = scale(ahorroMes);
      const hP = scale(pay[i]||0);
      const xa = x, xp = x + barW + 8;
      const labelY = H - 10;
      const txt = `<text x="${x}" y="${labelY}" font-size="14" fill="var(--text)">${m}</text>`;
      const rects = `
        <rect x="${xa}" y="${Math.min(yA, yA+hA)}" width="${barW}" height="${hA}" fill="#22C55E"></rect>
        <rect x="${xp}" y="${Math.min(yP, yP+hP)}" width="${barW}" height="${hP}" fill="#EF4444"></rect>
      `;
      x += (barW*2 + gap);
      return rects + txt;
    }).join('');

    const linePts = accArr.map((v,i)=>{
      const xi = pad + 12 + i*(barW*2 + gap) + barW;
      const yi = H - pad - Math.round((Math.max(0,v)/maxY) * (H - pad*2));
      return `${xi},${yi}`;
    }).join(' ');

    let marker = '';
    if ((capex||0) > 0){
      const idx = accArr.findIndex(v => v >= capex);
      if (idx !== -1){
        const mx = pad + 12 + idx*(barW*2 + gap) + barW;
        const my = H - pad - Math.round((Math.max(0, accArr[idx])/maxY) * (H - pad*2));
        marker = `<circle cx="${mx}" cy="${my}" r="6" fill="#A78BFA"></circle>
                  <text x="${mx+10}" y="${my-10}" font-size="14" fill="#A78BFA">Payback M${idx+1}</text>`;
      }
    }

    const yCapex = H - pad - Math.round(((capex||0)/maxY) * (H - pad*2));
    const capexLine = capex>0 ? `
      <line x1="${pad}" y1="${yCapex}" x2="${W-pad}" y2="${yCapex}" stroke="#60A5FA" stroke-dasharray="6 6"></line>
      <text x="${pad+10}" y="${yCapex-10}" font-size="14" fill="#60A5FA">CAPEX $${(capex||0).toLocaleString()}</text>
    ` : '';

    const legendX = W - pad - 300, legendY = pad;
    const legend = `
      <rect x="${legendX}" y="${legendY-14}" width="290" height="56" rx="10" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.06)"></rect>
      <rect x="${legendX+12}" y="${legendY}" width="14" height="14" fill="#22C55E"></rect>
      <text x="${legendX+32}" y="${legendY+11}" font-size="14" fill="var(--text)">Ahorro mensual</text>
      <rect x="${legendX+12}" y="${legendY+24}" width="14" height="14" fill="#EF4444"></rect>
      <text x="${legendX+32}" y="${legendY+35}" font-size="14" fill="var(--text)">Pago del mes</text>
      <polyline points="${legendX+12},${legendY+48} ${legendX+32},${legendY+48}" stroke="#A78BFA" stroke-width="3"></polyline>
      <text x="${legendX+38}" y="${legendY+51}" font-size="14" fill="var(--text)">Acumulado</text>
    `;

    const axis = `
      <line x1="${pad-10}" y1="${pad-6}" x2="${pad-10}" y2="${H-pad}" stroke="rgba(255,255,255,0.2)"></line>
      <text x="${pad-14}" y="${H-pad+8}" font-size="14" text-anchor="end" fill="rgba(255,255,255,0.65)">$0</text>
    `;

    const polyline = `<polyline points="${linePts}" fill="none" stroke="#A78BFA" stroke-width="3"></polyline>`;

    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}" role="img"
                     aria-label="Flujo mensual y payback">
      ${axis}${capexLine}${bars}${polyline}${marker}${legend}
    </svg>`;
  }

  // Eventos
  document.getElementById('btnCalc').addEventListener('click', calcular);

  // Escenarios rápidos
  document.querySelectorAll('[data-scn]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const scn = btn.getAttribute('data-scn');
      presetActivo = scn;
      const mapa = { '100': 18000, '150': 27000, '200': 36000 };
      overrideAhorro = mapa[scn] || null;
      calcular();
    });
  });
  document.getElementById('btnClearScn')?.addEventListener('click', ()=>{
    overrideAhorro = null; presetActivo = null; calcular();
  });

  // Cambios de inputs y modo de pago
  ['ah_iMach','ah_prog','ah_tools','ah_setup','capex','mensualidad'].forEach(id=>{
    document.getElementById(id).addEventListener('input', ()=>{ calcular(); });
  });
  ['payContado','pay303'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', ()=>calcular());
  });

  // Init
  calcular();

  // Registro SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/proyectos/calculadoras/solidcam/sw-solidcam.js', { scope: '/proyectos/calculadoras/solidcam/' })
      .catch(console.error);
  }
</script>
</body>
</html>
