<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SolidCAM ROI — Calculadora</title>
<meta name="description" content="Calculadora ROI de SolidCAM por casos: Tiempo-Máquina, Menos Silos de Software, Calidad y Riesgo, Mix Complejo Mill-Turn/Swiss." />
<meta name="theme-color" content="#0F172A" />
<meta name="color-scheme" content="dark" />
<link rel="manifest" href="/proyectos/calculadoras/solidcam/solidcam.webmanifest">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{ --bg:#071027; --card:#0f172a; --text:#e6eef8; --accent:#60a5fa; --accent2:#6366F1; --ok:#22C55E; --warn:#F59E0B; --bad:#EF4444}
html,body{background:var(--bg);color:var(--text)}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);border-radius:14px}
input,select{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.55rem .65rem}
.badge{display:inline-block;padding:.35rem .75rem;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-size:.75rem; text-align:center; line-height: 1.2;}
.badge.up{background:linear-gradient(180deg,#16a34a,#059669);color:#fff}
.stat{border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
.viz{min-height:400px}

/* --- Nuevos estilos para iconos de KPI --- */
.stat-content {
  display: flex;
  align-items: center;
  gap: 0.5rem; /* 8px */
}
.kpi-icon {
  width: 1.5rem; /* 24px */
  height: 1.5rem; /* 24px */
  color: currentColor;
  flex-shrink: 0;
}
/* --- Estilo para tooltips (ayuda) --- */
label[title] {
  cursor: help;
  text-decoration: underline;
  text-decoration-style: dotted;
  text-decoration-color: rgba(255,255,255,0.4);
}

/* --- ESTILOS DE IMPRESIÓN (REPORTE PDF) --- */
@media print {
  /* --- Configuración de página --- */
  @page {
    size: Letter; /* O A4 */
    margin: 0.5in; /* Media pulgada de margen */
  }
  html, body {
    font-size: 10pt !important; /* Reduce fuente base */
    background: #fff !important;
    color: #000 !important;
  }

  /* --- 1. Ocultar lo que no queremos --- */
  header, footer, section[class*="lg:col-span-5"], .hero-bg { /* Oculta header, hero, footer y el formulario */
    display: none !important;
  }

  /* --- 2. Preparar el Contenedor del Reporte --- */
  main {
    display: block !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  #reportSection {
    visibility: visible;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    display: grid !important;
    grid-template-columns: 1fr !important; /* Asegura una columna */
    gap: 0.5rem !important; /* Reduce el gap entre tarjetas */
  }
  
  /* --- 3. Estilos de las tarjetas --- */
  .card {
    border: 1px solid #ccc !important;
    box-shadow: none !important;
    background: #fff !important;
    page-break-inside: avoid; /* Evita que las tarjetas se corten */
    padding: 0.75rem !important; /* Reduce padding */
  }
  .stat { border-color: #eee !important; padding: 0.5rem !important; }
  tbody tr { background: #f9f9f9 !important; }
  
  /* --- 4. Poner gráficos lado a lado --- */
  #graphsWrapper {
    grid-template-columns: repeat(2, 1fr) !important; /* 2 columnas */
    gap: 1rem !important; /* Espacio entre los 2 gráficos */
  }

  /* --- 5. Reducir altura de gráficos --- */
  .viz {
    min-height: 280px !important; /* Altura reducida para que quepan */
  }

  /* --- 6. Fuentes y Colores --- */
  h2 { font-size: 1.25rem !important; }
  h3 { font-size: 1rem !important; }
  .text-lg { font-size: 1rem !important; }
  .text-sm { font-size: 0.8rem !important; }
  .kpi-icon { width: 1.25rem !important; height: 1.25rem !important; }
  
  /* Forzar colores de texto e iconos a negro */
  h1, h2, h3, p, span, div, text, svg, path {
    color: #000 !important;
    fill: #000 !important;
    stroke: #000 !important;
  }
  
  /* Estilos específicos para elementos con color */
  .badge.up {
    background: #16a34a !important; color: #fff !important;
    border: 1px solid #16a34a !important;
    -webkit-print-color-adjust: exact; /* Fuerza el fondo en impresión */
  }
  #kpiNeto[style*="var(--ok)"] {
    color: #16a34a !important; fill: #16a34a !important; stroke: #16a34a !important;
  }
  #kpiNeto[style*="var(--bad)"] {
    color: #dc2626 !important; fill: #dc2626 !important; stroke: #dc2626 !important;
  }
  /* Colores de gráficos */
  path[fill^="#6366F1"], polyline[stroke^="#A78BFA"], circle[fill^="#A78BFA"] {
    fill: #5A5A9C !important; stroke: #5A5A9C !important; -webkit-print-color-adjust: exact;
  }
  path[fill^="#16A34A"], rect[fill^="#22C55E"] {
    fill: #16a34a !important; stroke: #16a34a !important; -webkit-print-color-adjust: exact;
  }
  path[fill^="#F59E0B"] {
    fill: #f59e0b !important; stroke: #f59e0b !important; -webkit-print-color-adjust: exact;
  }
  rect[fill^="#EF4444"] {
    fill: #dc2626 !important; stroke: #dc2626 !important; -webkit-print-color-adjust: exact;
  }
  /* Reducir fuentes de los gráficos */
  svg text { font-size: 10px !important; }
  #vizDonut svg text[font-size="18"] { font-size: 12px !important; }
  #vizDonut svg text[font-size="20"] { font-size: 14px !important; }
  #vizCash svg text[font-size="14"] { font-size: 10px !important; }
}
  /* --- Corrección para Dropdowns --- */
select option {
  color: #000; /* Fuerza el texto a negro */
  background: #fff; /* Asegura fondo blanco */
}
</style>
</head>
<body class="antialiased">

<header class="sticky top-0 z-40 backdrop-blur" style="background:rgba(2,6,23,.55);border-bottom:1px solid rgba(255,255,255,.06)">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <img src="/assets/logo.png" class="h-9 w-auto" alt="AlexRaSa" />
        <span class="hidden sm:inline font-semibold">AlexRaSa<span style="color:var(--accent)">.store</span></span>
      </a>
      <nav class="hidden md:flex gap-6 text-sm">
        <a href="/SolidCAM/" class="hover:text-sky-400">Soluciones</a>
        <a href="/#recursos" class="hover:text-sky-400">Recursos</a>
        <a href="/#contacto" class="hover:text-sky-400">Contacto</a>
      </nav>
    </div>
  </div>
</header>

<section class="hero-bg" style="background-image:url('/assets/hero-industrial.png');background-size:cover;background-position:center">
  <div class="hero-content max-w-6xl mx-auto px-4 py-10 md:py-16">
    <h1 class="text-3xl md:text-5xl font-extrabold">SolidCAM ROI — <span style="color:var(--accent)">Casos A–D</span></h1>
    <p class="mt-3 max-w-3xl text-slate-200">Activa los casos, captura supuestos y obtén ahorros mensuales, ROI, payback y flujo.</p>
  </div>
</section>

<main class="max-w-6xl mx-auto px-4 pt-8 pb-20 grid gap-5 lg:grid-cols-12">
  <section class="lg:col-span-5">
    <div class="card p-5 lg:sticky lg:top-20 max-h-[calc(100vh-6rem)] overflow-auto">
      <h2 class="text-lg font-semibold">Entradas</h2>

      <div class="mt-4 space-y-6">
        <fieldset class="space-y-2">
          <legend class="text-sm font-semibold mb-1">Casos a incluir</legend>
          <label class="flex items-center gap-2 text-sm"><input id="incA" type="checkbox" class="h-4 w-4" checked> A) Tiempo-máquina</label>
          <label class="flex items-center gap-2 text-sm"><input id="incB" type="checkbox" class="h-4 w-4" checked> B) Menos silos de software</label>
          <label class="flex items-center gap-2 text-sm"><input id="incC" type="checkbox" class="h-4 w-4" checked> C) Calidad y riesgo</label>
          <label class="flex items-center gap-2 text-sm"><input id="incD" type="checkbox" class="h-4 w-4"> D) Mix complejo Mill-Turn/Swiss</label>
        </fieldset>

        <fieldset id="fsA" class="space-y-3">
          <legend class="text-sm font-semibold">A) Tiempo-máquina (iMachining)</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Tiempo de ciclo actual (sin SolidCAM) para la pieza.">Min/pieza baseline
              <input id="a_min_base" type="number" value="12">
            </label>
            <label class="text-sm" title="Tiempo de ciclo objetivo usando iMachining.">Min/pieza con iMachining
              <input id="a_min_imach" type="number" value="6">
            </label>
            <label class="text-sm" title="Volumen de producción mensual para las piezas afectadas.">Piezas/mes (3 jobs)
              <input id="a_pzas_mes" type="number" value="1800">
            </label>
            <label class="text-sm" title="Costo total de operar la máquina por hora (incluye depreciación, energía, herramental y mano de obra directa).">$ /h máquina
              <input id="a_costo_hm" type="number" value="45">
            </label>
          </div>
          <p class="text-xs text-slate-400">Fórmula: (baseline − iMach) × piezas/mes × ($/h)/60.</p>
        </fieldset>

        <fieldset id="fsB" class="space-y-3">
          <legend class="text-sm font-semibold">B) Menos silos de software</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Número de licencias de software (ej. otro CAM, un verificador) que se pueden dar de baja.">Licencias eliminadas (#)
              <input id="b_lic_del" type="number" value="2">
            </label>
            <label class="text-sm" title="Costo mensual o anualidad (dividida entre 12) de esas licencias.">Costo licencia eliminada (USD/mes)
              <input id="b_lic_cost" type="number" value="200">
            </label>
            <label class="text-sm" title="Tiempo perdido por semana en exportar/importar archivos, re-trabajo por cambios de ingeniería, etc.">Horas semanales ahorradas (handoffs)
              <input id="b_horas_sem" type="number" value="8">
            </label>
            <label class="text-sm" title="Costo promedio por hora de un programador CAM (salario + prestaciones / horas trabajadas).">$ /h programador
              <input id="b_costo_hp" type="number" value="18">
            </label>
          </div>
          <p class="text-xs text-slate-400">Fórmula: licencias×$ + (horas/sem × 4.33 × $/h).</p>
        </fieldset>

        <fieldset id="fsC" class="space-y-3 hidden">
          <legend class="text-sm font-semibold">C) Calidad y riesgo</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Porcentaje de piezas desechadas (scrap) antes de SolidCAM."> % scrap antes
              <input id="c_scrap_a" type="number" value="2.5">
            </label>
            <label class="text-sm" title="Porcentaje de scrap objetivo con simulación y control mejorados.">% scrap después
              <input id="c_scrap_d" type="number" value="0.8">
            </label>
            <label class="text-sm" title="Volumen total de piezas/mes para esta área.">Piezas/mes
              <input id="c_pzas_mes" type="number" value="3000">
            </label>
            <label class="text-sm" title="Costo de material y tiempo-máquina de una pieza desechada.">Costo por pieza (USD)
              <input id="c_costo_pza" type="number" value="12">
            </label>
            <label class="text-sm" title="Número de colisiones (choques) de máquina que ocurren por mes (ej. 0.3 = 1 cada 3 meses).">Choques evitados/mes
              <input id="c_crash_mes" type="number" value="0.3">
            </label>
            <label class="text-sm" title="Costo promedio de una colisión (incluye herramental dañado, paro de máquina y mano de obra de reparación).">Costo promedio por choque (USD)
              <input id="c_costo_crash" type="number" value="1800">
            </label>
          </div>
          <p class="text-xs text-slate-400">Fórmula: Δscrap×pzas×costo + choques×costo.</p>
        </fieldset>

        <fieldset id="fsD" class="space-y-3 hidden">
          <legend class="text-sm font-semibold">D) Mix complejo Mill-Turn/Swiss</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Minutos para programar una parte compleja (Mill-Turn o Swiss) con el método actual.">Min programación/parte (antes)
              <input id="d_prog_a" type="number" value="60">
            </label>
            <label class="text-sm" title="Minutos para programar la misma parte con SolidCAM.">Min programación/parte (después)
              <input id="d_prog_d" type="number" value="35">
            </label>
            <label class="text-sm" title="Número de partes nuevas o con revisión que se programan al mes.">Partes/mes afectadas
              <input id="d_partes_mes" type="number" value="120">
            </label>
            <label class="text-sm" title="Costo promedio por hora de un programador CAM.">$ /h programador
              <input id="d_costo_hp" type="number" value="18">
            </label>
            <label class="text-sm" title="Minutos ahorrados en el setup físico de la máquina gracias a una mejor simulación y preparación.">Min setup ahorrados/orden
              <input id="d_setup_min" type="number" value="25">
            </label>
            <label class="text-sm" title="Número de órdenes de trabajo (setups) al mes.">Órdenes/mes
              <input id="d_orders_mes" type="number" value="60">
            </label>
            <label class="text-sm" title="Costo total de operar la máquina por hora (incluye depreciación, energía, herramental y mano de obra directa).">$ /h máquina
              <input id="d_costo_hm" type="number" value="45">
            </label>
          </div>
          <p class="text-xs text-slate-400">Fórmula: Δprog×partes×$/h_prog + setup_min×órdenes×$/h_máq.</p>
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="text-sm font-semibold">Finanzas</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Inversión total única (licencias perpetuas, implementación, capacitación).">Inversión (CAPEX) USD
              <input id="capex" type="number" value="46526.2">
            </label>
            <label class="text-sm" title="Método de pago para la inversión inicial.">Plan de pago
              <select id="plan">
                <option value="contado">Contado</option>
                <option value="30_3">30% inicial + 3 meses</option>
                <option value="20_6">20% inicial + 6 meses</option>
                <option value="0_12" selected>12 mensualidades iguales (0% enganche)</option>
              </select>
            </label>
          </div>
        </fieldset>

        <div class="space-y-3">
          <button id="btnCalc" class="w-full py-2.5 rounded-md font-semibold" style="background:var(--accent2);color:white">Calcular</button>
          <button id="btnPrint" class="w-full py-2.5 rounded-md font-semibold" style="background:var(--accent);color:white">Generar Reporte (PDF)</button>
        </div>
      </div>
    </div>
  </section>

  <section id="reportSection" class="lg:col-span-7 grid gap-5">
    
    <div class="card p-4">
      <h3 class="text-sm font-semibold mb-3">KPIs</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        
        <div class="stat">
          <div class="text-xs text-slate-300">ROI anual</div>
          <div id="kpiROI" class="text-lg font-bold stat-content">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>
            <span id="valROI">0%</span>
          </div>
        </div>

        <div class="stat">
          <div class="text-xs text-slate-300">Payback (meses)</div>
          <div id="kpiPayback" class="text-lg font-bold stat-content">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
            <span id="valPayback">—</span>
          </div>
        </div>
        
        <div class="stat">
          <div class="text-xs text-slate-300">Ahorro mensual</div>
          <div id="kpiNeto" class="text-lg font-bold stat-content">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
            <span id="valNeto">$0</span>
          </div>
        </div>

        <div class="stat">
          <div class="text-xs text-slate-300">Caso dominante</div>
          <div id="kpiTop" class="text-sm mt-1"><span class="badge up">—</span></div>
        </div>
      </div>
    </div>
    
    <div class="card p-5">
      <h2 class="text-lg font-semibold">Comparativa de ahorros</h2>
      <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
        <table class="w-full text-sm">
          <thead>
            <tr><th class="text-left px-2 py-1">Concepto</th><th class="text-right px-2 py-1">Ahorro mensual (USD)</th><th class="text-right px-2 py-1">Estado</th></tr>
          </thead>
          <tbody id="tbodyAhorros"></tbody>
          <tfoot><tr><td class="px-2 py-2 font-semibold">Total</td><td id="tdTotal" class="px-2 py-2 text-right font-semibold"></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-5" id="graphsWrapper">
      <div class="card p-4">
        <h3 class="text-sm font-semibold">Distribución de ahorros</h3>
        <div id="vizDonut" class="mt-3 viz"></div>
      </div>

      <div class="card p-4">
        <h3 class="text-sm font-semibold">Flujo mensual y payback</h3>
        <div id="vizCash" class="mt-3 viz"></div>
      </div>
    </div>
    
  </section>
</main>

<footer class="py-8 text-center text-sm text-slate-400">© 2025 AlexRaSa — SolidCAM ROI</footer>

<script>
// --- Selectores para fieldsets ---
const fsA = document.getElementById('fsA');
const fsB = document.getElementById('fsB');
const fsC = document.getElementById('fsC');
const fsD = document.getElementById('fsD');

// util
const fmt = (n,d=2)=>Number(n||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});

// payment plan helper
function planPagos(capex, plan){
  const m = Array(12).fill(0); let eng=0;
  if(plan==='contado'){ eng=capex; }
  else if(plan==='30_3'){ eng=capex*0.30; const cuota=(capex*0.70)/3; m[0]+=cuota; m[1]+=cuota; m[2]+=cuota; }
  else if(plan==='20_6'){ eng=capex*0.20; const cuota=(capex*0.80)/6; for(let i=0;i<6;i++) m[i]+=cuota; }
  else if(plan==='0_12'){ const cuota=capex/12; for(let i=0;i<12;i++) m[i]+=cuota; }
  return {enganche:eng, cuotas:m};
}

// cases
function caseA(){
  if(!document.getElementById('incA').checked) return 0;
  const a = +a_min_base.value, b = +a_min_imach.value, p = +a_pzas_mes.value, hm = +a_costo_hm.value;
  return Math.max(0, a-b) * p * (hm/60);
}
function caseB(){
  if(!document.getElementById('incB').checked) return 0;
  const lic = +b_lic_del.value, licc = +b_lic_cost.value, hsem = +b_horas_sem.value, hp = +b_costo_hp.value;
  return lic*licc + hsem*4.33*hp;
}
function caseC(){
  if(!document.getElementById('incC').checked) return 0;
  const sa = (+c_scrap_a.value||0)/100, sd = (+c_scrap_d.value||0)/100, pm = +c_pzas_mes.value, cp = +c_costo_pza.value;
  const crash = +c_crash_mes.value, ccr = +c_costo_crash.value;
  const ahScrap = Math.max(0, sa - sd) * pm * cp;
  const ahCrash = crash * ccr;
  return ahScrap + ahCrash;
}
function caseD(){
  if(!document.getElementById('incD').checked) return 0;
  const pa = +d_prog_a.value, pd = +d_prog_d.value, parts = +d_partes_mes.value, hp = +d_costo_hp.value;
  const setup = +d_setup_min.value, orders = +d_orders_mes.value, hm = +d_costo_hm.value;
  const ahProg = Math.max(0, pa-pd) * parts * (hp/60);
  const ahSetup = setup * orders * (hm/60);
  return ahProg + ahSetup;
}

// --- Función para ocultar/mostrar casos ---
function toggleFieldsets(){
  incA.checked ? fsA.classList.remove('hidden') : fsA.classList.add('hidden');
  incB.checked ? fsB.classList.remove('hidden') : fsB.classList.add('hidden');
  incC.checked ? fsC.classList.remove('hidden') : fsC.classList.add('hidden');
  incD.checked ? fsD.classList.remove('hidden') : fsD.classList.add('hidden');
}

function calcular(){
  const parts = [
    ['Tiempo-máquina (A)', caseA()],
    ['Menos silos (B)', caseB()],
    ['Calidad y riesgo (C)', caseC()],
    ['Mix complejo (D)', caseD()]
  ];
  const total = parts.reduce((s,p)=>s+p[1],0);

  // tabla
  const body = document.getElementById('tbodyAhorros');
  body.innerHTML = parts.filter(p=>p[1]>0.0001).map(p=>{
    const pct = total>0 ? (p[1]/total)*100 : 0;
    return `<tr>
      <td class="px-2 py-2">${p[0]}</td>
      <td class="px-2 py-2 text-right font-mono">$${fmt(p[1])}</td>
      <td class="px-2 py-2 text-right"><span class="badge up">+${fmt(pct,0)}%</span></td>
    </tr>`;
  }).join('') || `<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Sin ahorros activos</td></tr>`;
  tdTotal.textContent = `$${fmt(total)}`;

  // finanzas
  const capex = +document.getElementById('capex').value||0;
  const planSel = document.getElementById('plan').value;
  const {enganche, cuotas} = planPagos(capex, planSel);

  const roiAnual = capex>0 ? ((total*12)/capex)*100 : 0;
  const acc = []; let acum = -enganche;
  for(let i=0;i<12;i++){ acum += (total - cuotas[i]); acc.push(acum); }
  const payIdx = capex>0 ? acc.findIndex(v=>v>=(capex-enganche)) : -1;
  const payback = payIdx>=0 ? (payIdx+1) : '—';

  // KPIs (ACTUALIZADO para apuntar a los <span>)
  valROI.textContent = `${fmt(roiAnual)}%`;
  valPayback.textContent = payback;
  valNeto.textContent = `$${fmt(total)}`;
  kpiNeto.style.color = 'var(--ok)';
  
  const top = parts.slice().sort((a,b)=>b[1]-a[1])[0];
  kpiTop.innerHTML = top && top[1]>0 ? `<span class="badge up">${top[0]}</span>` : '<span class="badge">—</span>';

  // gráficos
  renderDonut('vizDonut', parts);
  renderCashflow('vizCash', { ahorroMes: total, capex, planSel, enganche, cuotas });
}

// donut svg (VERSIÓN CORREGIDA)
function renderDonut(targetId, parts){
  const el=document.getElementById(targetId); if(!el) return;
  const data=parts.filter(p=>p[1]>0); const total=data.reduce((s,p)=>s+p[1],0);
  
  const W=600, H=400; 
  const cx = 210, cy = H / 2, r = H * 0.4, th = 50;
  let start=0; const colors=['#6366F1','#16A34A','#F59E0B','#06B6D4','#EF4444'];

  const legendX = 390;
  const legendFontSize = 18;
  const legendLineHeight = 30;
  const legendBlockHeight = data.length * legendLineHeight;
  const legendStartY = (H - legendBlockHeight) / 2 + (legendFontSize / 2);

  const segs=data.map((p,i)=>{ 
    const f= total? p[1]/total:0; const a0=start*2*Math.PI, a1=(start+f)*2*Math.PI; start+=f;
    const L=(a1-a0)>Math.PI?1:0;
    const x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0),x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
    const x0i=cx+(r-th)*Math.cos(a0),y0i=cy+(r-th)*Math.sin(a0),x1i=cx+(r-th)*Math.cos(a1),y1i=cy+(r-th)*Math.sin(a1);
    const d=`M ${x0} ${y0} A ${r} ${r} 0 ${L} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${L} 0 ${x0i} ${y0i} Z`;
    
    const pct=Math.round(f*100);
    const ly = legendStartY + (i * legendLineHeight);

    return `<path d="${d}" fill="${colors[i%colors.length]}" opacity="0.95"></path>
            <text x="${legendX}" y="${ly}" font-size="${legendFontSize}" fill="var(--text)">${p[0]}: ${pct}%</text>`;
  }).join('');

  const centerFontSize = Math.max(20, Math.round(r * 0.2));
  const centerText = total ? ('$' + fmt(total, 0)) : '—'; // sin decimales

  const center = `<circle cx="${cx}" cy="${cy}" r="${r-th+1}" fill="rgba(255,255,255,0.04)"></circle>
                <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" font-size="${centerFontSize}" fill="var(--text)">${centerText}</text>`;
  
  el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${segs}${center}</svg>`;
}

// cashflow svg (VERSIÓN CORREGIDA)
function renderCashflow(targetId, {ahorroMes, capex, planSel, enganche, cuotas}){
  const el=document.getElementById(targetId); if(!el) return;
  const meses=Array.from({length:12},(_,i)=>`M${i+1}`);
  
  const W = 800, H = 400;
  const pad = { top: 40, right: 10, bottom: 50, left: 60 };
  const barW = 18, barGap = 6, gap = 38;
  const H_drawable = H - pad.top - pad.bottom;
  
  const pagos = cuotas.slice(); pagos[0]+=enganche;
  const netoMes = meses.map((_,i)=> (ahorroMes - pagos[i]));
  let acc = 0; const accArr = netoMes.map(v=>{ acc+=v; return acc; });

  const allValues = [ahorroMes||0, capex||0, ...pagos, ...accArr];
  const dataMax = Math.max(1, ...allValues.map(v => Math.max(0, v)));
  const dataMin = Math.min(0, ...allValues.map(v => Math.min(0, v)));
  const totalRange = dataMax - dataMin;

  const scaleY = (v) => {
    if (totalRange === 0) return H - pad.bottom;
    return (H - pad.bottom) - (((v - dataMin) / totalRange) * H_drawable);
  };

  const yZero = scaleY(0);

  let x = pad.left + gap/2;
  
  const bars = meses.map((m,i)=>{
    const yA = scaleY(ahorroMes); const hA = yZero - yA;
    const yP = scaleY(pagos[i]); const hP = yZero - yP;
    const xa = x, xp = x + barW + barGap;
    const labelY = H - pad.bottom + 20;
    
    const rects = `<rect x="${xa}" y="${yA}" width="${barW}" height="${hA}" fill="#22C55E"></rect>
                   <rect x="${xp}" y="${yP}" width="${barW}" height="${hP}" fill="#EF4444"></rect>`;
    const txt = `<text x="${x + barW + barGap/2}" y="${labelY}" font-size="14" fill="var(--text)" text-anchor="middle">${m}</text>`;
    
    x += (barW * 2 + barGap + gap);
    return rects+txt;
  }).join('');

  const linePts = accArr.map((v,i)=>{
    const xi = pad.left + gap/2 + i*(barW*2+barGap+gap) + (barW + barGap/2);
    const yi = scaleY(v);
    return `${xi},${yi}`;
  }).join(' ');
  const polyline = `<polyline points="${linePts}" fill="none" stroke="#A78BFA" stroke-width="3"></polyline>`;

  let marker=''; 
  if ((capex||0) > 0){
    const idx = accArr.findIndex(v=>v>=capex);
    if(idx!==-1){
      const xi_marker = pad.left + gap/2 + idx*(barW*2+barGap+gap) + (barW + barGap/2);
      const yi_marker = scaleY(accArr[idx]);
      
      marker = `<circle cx="${xi_marker}" cy="${yi_marker}" r="6" fill="#A78BFA" stroke="var(--bg)" stroke-width="2"></circle>
                <text x="${xi_marker + 10}" y="${yi_marker - 10}" font-size="14" fill="#A78BFA">Payback M${idx+1}</text>`;
    }
  }

  const yCapex = scaleY(capex || 0);
  const capexLine = capex > 0 ? `<line x1="${pad.left}" y1="${yCapex}" x2="${W - (pad.right + 150)}" y2="${yCapex}" stroke="#60A5FA" stroke-dasharray="6 6"></line>
                              <text x="${pad.left + 8}" y="${yCapex-8}" font-size="14" fill="#60A5FA">CAPEX $${fmt(capex, 0)}</text>` : '';

  const legendX = W - pad.right - 150, legendY = pad.top;
  const legend = `
      <rect x="${legendX}" y="${legendY - 12}" width="140" height="82" rx="10" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.06)"></rect>
      <rect x="${legendX+12}" y="${legendY}" width="12" height="12" fill="#22C55E"></rect>
      <text x="${legendX+30}" y="${legendY+10}" font-size="14" fill="var(--text)">Ahorro</text>
      <rect x="${legendX+12}" y="${legendY+26}" width="12" height="12" fill="#EF4444"></rect>
      <text x="${legendX+30}" y="${legendY+36}" font-size="14" fill="var(--text)">Pago</text>
      <line x1="${legendX+12}" y1="${legendY+60}" x2="${legendX+24}" y2="${legendY+60}" stroke="#A78BFA" stroke-width="2.5"></line>
      <text x="${legendX+30}" y="${legendY+62}" font-size="14" fill="var(--text)">Acumulado</text>`;

  const axis = `
      <line x1="${pad.left}" y1="${pad.top - 10}" x2="${pad.left}" y2="${H - pad.bottom}" stroke="rgba(255,255,255,.2)"></line>
      <line x1="${pad.left}" y1="${yZero}" x2="${W - pad.right}" y2="${yZero}" stroke="rgba(255,255,255,.2)"></line>
      <text x="${pad.left - 10}" y="${yZero + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$0</text>
      <text x="${pad.left - 10}" y="${scaleY(dataMax) + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$${fmt(dataMax, 0)}</text>
      ${dataMin < 0 ? `<text x="${pad.left - 10}" y="${scaleY(dataMin) + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$${fmt(dataMin, 0)}</text>` : ''}
  `;

  el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">
    ${axis}${capexLine}${bars}${polyline}${marker}${legend}
  </svg>`;
}

// events
btnCalc.addEventListener('click', calcular);
// --- EVENTO DE IMPRESIÓN AÑADIDO ---
document.getElementById('btnPrint').addEventListener('click', () => window.print());

['incA','incB','incC','incD'].forEach(id=>document.getElementById(id).addEventListener('change', ()=>{
  toggleFieldsets();
  calcular(); // <- Llama a calcular también
}));
document.getElementById('plan').addEventListener('change', calcular);
// ---
document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', calcular));

// init
toggleFieldsets(); // <-- Llamar en la carga inicial
calcular();

// SW
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/proyectos/calculadoras/solidcam/sw-solidcam.js', {scope:'/proyectos/calculadoras/solidcam/'}).catch(()=>{});
}
</script>

<script src="/assets/chatbot.js"></script>
</body>
</html>
