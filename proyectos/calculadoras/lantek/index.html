<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lantek ROI — Calculadora de Costo-Beneficio</title>
<meta name="description" content="Calculadora ROI para Lantek: aprovechamiento de material, nesting, trazabilidad, programación y expansión a tubo. Calcula ahorros, ROI, payback y flujo." />
<meta name="theme-color" content="#0F172A" />
<meta name="robots" content="index,follow" />
<link rel="canonical" href="https://alexrasa.store/proyectos/calculadoras/lantek/" />
<link rel="manifest" href="/proyectos/calculadoras/lantek/lantek.webmanifest">
<meta name="color-scheme" content="dark">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
<link rel="preload" as="image" href="/assets/hero-industrial.png">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    color-scheme: dark;
    --bg:#071027;
    --card:#0f172a;
    --text:#e6eef8;
    --accent:#60a5fa;
    --accent-2:#6366F1;
    --good:#22C55E;
    --warn:#F59E0B;
    --bad:#EF4444;
  }
  html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  a{color:var(--accent)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); border-radius:14px}
  input,select,textarea{background:rgba(255,255,255,0.02); color:var(--text); border:1px solid rgba(255,255,255,0.06); padding:.55rem .65rem; border-radius:.6rem}
  input:focus,select:focus{box-shadow:0 0 0 6px rgba(99,102,241,0.10); outline:none}

  .hero-bg{
    position:relative; background-size:cover; background-position:center; min-height:360px; overflow:hidden;
  }
  .hero-bg::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.25), rgba(2,6,23,0.65));z-index:1}
  .hero-content{position:relative;z-index:2}

  .stat{border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:12px}
  .badge{display:inline-block;padding:.25rem .55rem;border-radius:999px;font-weight:700;font-size:11px;min-width:56px;text-align:center;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03)}
  .badge.up{background:linear-gradient(180deg,#16a34a,#059669);color:#fff;border-color:rgba(5,118,78,0.25)}
  .badge.mid{background:linear-gradient(180deg,#f59e0b,#d97706);color:#111;border-color:rgba(217,119,6,0.25)}
  .badge.down{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff;border-color:rgba(220,38,38,0.25)}

  table{border-collapse:separate;border-spacing:0 8px}
  thead th{font-weight:600;color:#cbd5e1}
  tbody tr{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)}
  tbody td{border-top:1px solid rgba(255,255,255,0.04);border-bottom:1px solid rgba(255,255,255,0.04)}
  
  /* --- ESTILOS MEJORADOS --- */
  .viz{min-height:400px}
  
  .stat-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .kpi-icon {
    width: 1.5rem;
    height: 1.5rem;
    color: currentColor;
    flex-shrink: 0;
  }
  label[title] {
    cursor: help;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: rgba(255,255,255,0.4);
  }
  
  /* --- Corrección para Dropdowns --- */
  select option {
    color: #000; /* Fuerza el texto a negro */
    background: #fff; /* Asegura fondo blanco */
  }

  /* --- ESTILOS DE IMPRESIÓN (REPORTE PDF) --- */
  @media print {
    @page {
      size: Letter;
      margin: 0.5in;
    }
    html, body {
      font-size: 10pt !important;
      background: #fff !important;
      color: #000 !important;
    }
    header, footer, .hero-bg, .lg\:col-span-4 {
      display: none !important;
    }
    main {
      display: block !important;
      padding: 0 !important;
      margin: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    #reportSection {
      visibility: visible;
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: 0.5rem !important;
    }
    .card {
      border: 1px solid #ccc !important;
      box-shadow: none !important;
      background: #fff !important;
      page-break-inside: avoid;
      padding: 0.75rem !important;
    }
    .stat { border-color: #eee !important; padding: 0.5rem !important; }
    tbody tr { background: #f9f9f9 !important; }
    
    #graphsWrapper {
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 1rem !important;
    }
    .viz {
      min-height: 280px !important;
    }
    h2 { font-size: 1.25rem !important; }
    h3 { font-size: 1rem !important; }
    .text-lg { font-size: 1rem !important; }
    .text-sm { font-size: 0.8rem !important; }
    .kpi-icon { width: 1.25rem !important; height: 1.25rem !important; }
    
    h1, h2, h3, p, span, div, text, svg, path {
      color: #000 !important;
      fill: #000 !important;
      stroke: #000 !important;
    }
    .badge.up {
      background: #16a34a !important; color: #fff !important;
      border: 1px solid #16a34a !important;
      -webkit-print-color-adjust: exact;
    }
    #kpiAhorroBruto, #kpiNetoM1[style*="var(--good)"] {
      color: #16a34a !important; fill: #16a34a !important; stroke: #16a34a !important;
    }
    #kpiNetoM1[style*="var(--bad)"] {
      color: #dc2626 !important; fill: #dc2626 !important; stroke: #dc2626 !important;
    }
    path[fill^="#6366F1"], polyline[stroke^="#A78BFA"], circle[fill^="#A78BFA"] {
      fill: #5A5A9C !important; stroke: #5A5A9C !important; -webkit-print-color-adjust: exact;
    }
    path[fill^="#16A34A"], rect[fill^="#22C55E"] {
      fill: #16a34a !important; stroke: #16a34a !important; -webkit-print-color-adjust: exact;
    }
    path[fill^="#F59E0B"] {
      fill: #f59e0b !important; stroke: #f59e0b !important; -webkit-print-color-adjust: exact;
    }
    rect[fill^="#EF4444"] {
      fill: #dc2626 !important; stroke: #dc2626 !important; -webkit-print-color-adjust: exact;
    }
    svg text { font-size: 10px !important; }
    #vizDonut svg text[font-size="18"] { font-size: 12px !important; }
    #vizDonut svg text[font-size="20"] { font-size: 14px !important; }
    #vizCash svg text[font-size="14"] { font-size: 10px !important; }
  }
</style>
</head>
<body class="antialiased">

<header class="sticky top-0 z-40 backdrop-blur" style="background:rgba(2,6,23,0.55);border-bottom:1px solid rgba(255,255,255,0.04)">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between gap-3">
      <a href="/" class="flex items-center gap-2 shrink-0" aria-label="Inicio">
        <img src="/assets/logo.png" alt="AlexRaSa" class="h-9 w-auto" />
        <span class="hidden sm:inline text-base font-semibold tracking-tight">AlexRaSa<span style="color:var(--accent)">.store</span></span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="/SolidCAM/" class="hover:text-sky-400">Soluciones</a>
        <a href="/#recursos" class="hover:text-sky-400">Recursos</a>
        <a href="/#contacto" class="hover:text-sky-400">Contacto</a>
      </nav>
    </div>
  </div>
</header>

<section class="hero-bg" style="background-image:url('/assets/hero-industrial.png')">
  <div class="hero-content max-w-6xl mx-auto px-4 py-12 md:py-20">
    <h1 class="text-3xl md:text-5xl font-extrabold">Lantek ROI — <span style="color:var(--accent)">Calculadora</span></h1>
    <p class="mt-3 max-w-3xl text-slate-200">Elige los casos A–E que aplican y calcula ahorros mensuales, ROI, payback y flujo con inversión inicial o esquema mensual.</p>
  </div>
</section>

<main class="max-w-6xl mx-auto px-4 pt-8 pb-24 grid gap-5 lg:grid-cols-12">
  <section class="lg:col-span-4">
    <div class="card p-5 lg:sticky lg:top-20 max-h-[calc(100vh-6rem)] overflow-auto">
      <h2 class="text-lg font-semibold">Entradas</h2>

      <div class="mt-4 space-y-6">
        <fieldset class="space-y-2">
          <legend class="text-sm font-semibold mb-1">Casos a incluir</legend>
          <label class="flex items-center gap-2 text-sm"><input id="incA" type="checkbox" class="h-4 w-4" checked> A) Material y nesting</label>
          <label class="flex items-center gap-2 text-sm"><input id="incB" type="checkbox" class="h-4 w-4" checked> B) Programación y throughput</label>
          <label class="flex items-center gap-2 text-sm"><input id="incC" type="checkbox" class="h-4 w-4"> C) Velocidad comercial</label>
          <label class="flex items-center gap-2 text-sm"><input id="incD" type="checkbox" class="h-4 w-4"> D) Trazabilidad y planeación</label>
          <label class="flex items-center gap-2 text-sm"><input id="incE" type="checkbox" class="h-4 w-4"> E) Consolidación chapa+tubo</label>
        </fieldset>

        <fieldset id="fsA" class="space-y-3">
          <legend class="text-sm font-semibold">A) Material y nesting</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Promedio de aprovechamiento de material (scrap) actual.">Aprovechamiento actual (%)
              <input id="aprovA" type="number" value="78">
            </label>
            <label class="text-sm" title="Aprovechamiento esperado con nesting avanzado y gestión de remanentes.">Aprovechamiento propuesto (%)
              <input id="aprovP" type="number" value="86">
            </label>
            <label class="text-sm" title="Costo promedio de una hoja/placa del material principal.">Costo material por hoja (USD)
              <input id="costoHoja" type="number" value="95">
            </label>
            <label class="text-sm" title="Total de hojas/placas procesadas al mes.">Hojas por mes
              <input id="hojasMes" type="number" value="420">
            </label>
          </div>
        </fieldset>

        <fieldset id="fsB" class="space-y-3">
          <legend class="text-sm font-semibold">B) Programación y throughput</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Minutos promedio para crear un programa NC (nesting y post-proceso) con el método actual.">Min/NC manual
              <input id="minNCManual" type="number" value="18">
            </label>
            <label class="text-sm" title="Minutos promedio para crear el mismo programa NC con Lantek (automatizado).">Min/NC con Lantek
              <input id="minNCLantek" type="number" value="8">
            </label>
            <label class="text-sm" title="Total de programas NC (nestings) generados al mes.">NC por mes
              <input id="ncMes" type="number" value="260">
            </label>
            <label class="text-sm" title="Costo por hora del programador (salario + prestaciones / horas).">Costo hora programador (USD)
              <input id="costoProg" type="number" value="18">
            </label>
            <label class="text-sm" title="Tiempo ahorrado por no tener que cambiar entre diferentes softwares (ej. CAD a CAM).">Min de cambio de software eliminados/NC
              <input id="minCambio" type="number" value="3">
            </label>
          </div>
        </fieldset>

        <fieldset id="fsC" class="space-y-3 hidden">
          <legend class="text-sm font-semibold">C) Velocidad comercial</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Tiempo de respuesta (Turnaround Time) actual para generar una cotización.">TAT cotización actual (h)
              <input id="tatA" type="number" value="24">
            </label>
            <label class="text-sm" title="Nivel de servicio (SLA) objetivo para cotizar con Lantek.">SLA objetivo (h)
              <input id="tatP" type="number" value="8">
            </label>
            <label class="text-sm" title="Número total de cotizaciones generadas al mes.">Cotizaciones por mes
              <input id="cotsMes" type="number" value="120">
            </label>
            <label class="text-sm" title="Costo por hora del personal de ventas/cotizaciones.">Costo hora ventas (USD)
              <input id="costoVentas" type="number" value="16">
            </label>
          </div>
        </fieldset>

        <fieldset id="fsD" class="space-y-3 hidden">
          <legend class="text-sm font-semibold">D) Trazabilidad y planeación</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Tiempo perdido buscando material, piezas o rehaciendo trabajo por falta de trazabilidad.">Min perdidos/orden
              <input id="minPerdidos" type="number" value="6">
            </label>
            <label class="text-sm" title="Total de órdenes de producción procesadas al mes.">Órdenes por mes
              <input id="ordenesMes" type="number" value="900">
            </label>
            <label class="text-sm" title="Costo de hora-hombre en piso de producción (operarios, supervisores).">Costo hora producción (USD)
              <input id="costoProd" type="number" value="28">
            </label>
          </div>
        </fieldset>

        <fieldset id="fsE" class="space-y-3 hidden">
          <legend class="text-sm font-semibold">E) Consolidación chapa+tubo</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Costo mensual (suscripción o prorrateo de mantenimiento) de software de tubo que se dará de baja.">Licencias antiguas eliminadas (USD/mes)
              <input id="licenciasElim" type="number" value="350">
            </label>
            <label class="text-sm" title="Número de jobs que requerían cambiar entre software de chapa y tubo.">Jobs/mes afectados por cambio de software
              <input id="jobsMes" type="number" value="120">
            </label>
          </div>
          <p class="text-xs text-slate-400">Considera ahorros por dejar múltiples softwares y por tiempos de cambio evitados.</p>
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="text-sm font-semibold">Finanzas</legend>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Inversión total única (CAPEX) en licencias perpetuas, implementación y capacitación.">Inversión (CAPEX) USD
              <input id="capex" type="number" value="12000">
            </label>
            <label class="text-sm" title="Método de pago para la inversión inicial.">Plan de pago
              <select id="plan">
                <option value="contado">Contado</option>
                <option value="30_3">30% inicial + 3 meses</option>
                <option value="20_6">20% inicial + 6 meses</option>
                <option value="0_12" selected>12 mensualidades iguales (0% enganche)</option>
              </select>
            </label>
          </div>
        </fieldset>

        <div class="space-y-3">
          <button id="btnCalc" class="w-full py-2.5 rounded-md font-semibold" style="background:var(--accent-2);color:white">Calcular</button>
          <button id="btnPrint" class="w-full py-2.5 rounded-md font-semibold" style="background:var(--accent);color:white">Generar Reporte (PDF)</button>
        </div>
      </div>
    </div>
  </section>

  <section id="reportSection" class="lg:col-span-8 grid gap-5">
    
    <div class="card p-4">
      <h3 class="text-sm font-semibold mb-3">KPIs</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        
        <div class="stat">
          <div class="text-xs text-slate-300">Ahorro Bruto Mensual</div>
          <div id="kpiAhorroBruto" class="text-lg font-bold stat-content" style="color:var(--good)">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v1.5m0-1.5H3.375m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H5.625m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H7.875m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H10.125m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H12.375m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H14.625m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H16.875m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H19.125m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m-1.5 0H20.25v-1.5m0 1.5H19.125M3.75 18.75v-1.5m0 1.5H3.375m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H5.625m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H7.875m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H10.125m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H12.375m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H14.625m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H16.875m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m2.121-3.121v1.5m0-1.5H19.125m0 0h1.5m-1.5 0h1.5m-1.5 0h1.5m-1.5 0H20.25v-1.5m0 1.5H19.125" /></svg>
            <span id="valAhorroBruto">$0</span>
          </div>
        </div>
        
        <div class="stat">
          <div class="text-xs text-slate-300">Neto en M1</div>
          <div id="kpiNetoM1" class="text-lg font-bold stat-content">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
            <span id="valNetoM1">$0</span>
          </div>
        </div>

        <div class="stat">
          <div class="text-xs text-slate-300">ROI anual</div>
          <div id="kpiROI" class="text-lg font-bold stat-content">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>
            <span id="valROI">0%</span>
          </div>
        </div>
        
        <div class="stat">
          <div class="text-xs text-slate-300">Payback (meses)</div>
          <div id="kpiPayback" class="text-lg font-bold stat-content">
            <svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
            <span id="valPayback">—</span>
          </div>
        </div>
      </div>
    </div>
    <div class="card p-5">
      <h2 class="text-lg font-semibold">Comparativa de ahorros</h2>
      <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
        <table class="w-full text-sm">
          <thead>
            <tr>
              <th class="text-left px-2 py-1">Concepto</th>
              <th class="text-right px-2 py-1">Ahorro mensual (USD)</th>
              <th class="text-right px-2 py-1">Estado</th>
            </tr>
          </thead>
          <tbody id="tbodyAhorros"></tbody>
          <tfoot>
            <tr>
              <td class="px-2 py-2 font-semibold">Total Ahorro Bruto</td>
              <td id="tdTotal" class="px-2 py-2 text-right font-semibold"></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-5" id="graphsWrapper">
      <div class="card p-4">
        <h3 class="text-sm font-semibold">Distribución de ahorros</h3>
        <div id="vizDonut" class="mt-3 viz"></div>
      </div>

      <div class="card p-4">
        <h3 class="text-sm font-semibold">Flujo mensual y payback</h3>
        <div id="vizCash" class="mt-3 viz"></div>
      </div>
    </div>
  </section>
</main>


<footer class="py-8 text-center text-sm text-slate-400">© 2025 AlexRaSa — Lantek ROI</footer>

<script>
  // --- Selectores para fieldsets ---
  const fsA = document.getElementById('fsA');
  const fsB = document.getElementById('fsB');
  const fsC = document.getElementById('fsC');
  const fsD = document.getElementById('fsD');
  const fsE = document.getElementById('fsE');

  // Utilidad
  const fmt = (n, d=2) => Number(n||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});

  // --- FUNCIÓN planPagos (AÑADIDA) ---
  function planPagos(capex, plan){
    const m = Array(12).fill(0); let eng=0;
    if(plan==='contado'){ eng=capex; }
    else if(plan==='30_3'){ eng=capex*0.30; const cuota=(capex*0.70)/3; m[0]+=cuota; m[1]+=cuota; m[2]+=cuota; }
    else if(plan==='20_6'){ eng=capex*0.20; const cuota=(capex*0.80)/6; for(let i=0;i<6;i++) m[i]+=cuota; }
    else if(plan==='0_12'){ const cuota=capex/12; for(let i=0;i<12;i++) m[i]+=cuota; }
    return {enganche:eng, cuotas:m};
  }

  // Habilita/Deshabilita y Oculta/Muestra grupos
  function applyToggles(){
    incA.checked ? fsA.classList.remove('hidden') : fsA.classList.add('hidden');
    incB.checked ? fsB.classList.remove('hidden') : fsB.classList.add('hidden');
    incC.checked ? fsC.classList.remove('hidden') : fsC.classList.add('hidden');
    incD.checked ? fsD.classList.remove('hidden') : fsD.classList.add('hidden');
    incE.checked ? fsE.classList.remove('hidden') : fsE.classList.add('hidden');
  }

  // Cálculo por caso
  function calcA(){
    if(!document.getElementById('incA').checked) return 0;
    const aprovA = +document.getElementById('aprovA').value||0;
    const aprovP = +document.getElementById('aprovP').value||0;
    const costoHoja = +document.getElementById('costoHoja').value||0;
    const hojasMes = +document.getElementById('hojasMes').value||0;
    const wasteA = Math.max(0, 100 - aprovA)/100;
    const wasteP = Math.max(0, 100 - aprovP)/100;
    return Math.max(0, (wasteA - wasteP)) * costoHoja * hojasMes;
  }
  function calcB(){
    if(!document.getElementById('incB').checked) return 0;
    const minManual = +document.getElementById('minNCManual').value||0;
    const minLantek = +document.getElementById('minNCLantek').value||0;
    const ncMes = +document.getElementById('ncMes').value||0;
    const costoProg = +document.getElementById('costoProg').value||0;
    const minCambio = +document.getElementById('minCambio').value||0;
    const ahMin = Math.max(0, (minManual - minLantek) + minCambio);
    return (ahMin/60) * costoProg * ncMes;
  }
  function calcC(){
    if(!document.getElementById('incC').checked) return 0;
    const tatA = +document.getElementById('tatA').value||0;
    const tatP = +document.getElementById('tatP').value||0;
    const cotsMes = +document.getElementById('cotsMes').value||0;
    const costoVentas = +document.getElementById('costoVentas').value||0;
    const ahH = Math.max(0, tatA - tatP);
    return ahH * cotsMes * costoVentas;
  }
  function calcD(){
    if(!document.getElementById('incD').checked) return 0;
    const minPerdidos = +document.getElementById('minPerdidos').value||0;
    const ordenesMes = +document.getElementById('ordenesMes').value||0;
    const costoProd = +document.getElementById('costoProd').value||0;
    return (minPerdidos/60) * ordenesMes * costoProd;
  }
  function calcE(){
    if(!document.getElementById('incE').checked) return 0;
    const licenciasElim = +document.getElementById('licenciasElim').value||0;
    const jobsMes = +document.getElementById('jobsMes').value||0;
    const minCambio = +document.getElementById('minCambio').value||0; 
    const costoProg = +document.getElementById('costoProg').value||0;
    const ahorroTiempo = (minCambio/60) * jobsMes * costoProg;
    return licenciasElim + ahorroTiempo;
  }

  // --- FUNCIÓN calcular() ACTUALIZADA ---
  function calcular(){
    const parts = [
      ['Material y nesting (A)', calcA()],
      ['Programación (B)', calcB()],
      ['Velocidad comercial (C)', calcC()],
      ['Trazabilidad (D)', calcD()],
      ['Consolidación (E)', calcE()]
    ];
    const total = parts.reduce((s, p)=> s + p[1], 0); // Ahorro Bruto

    // KPIs (Lógica SolidCAM)
    const capex = +document.getElementById('capex').value||0;
    const planSel = document.getElementById('plan').value;
    const {enganche, cuotas} = planPagos(capex, planSel);

    // ROI se basa en Ahorro Bruto Anual vs CAPEX
    const roiAnual = capex > 0 ? ((total * 12) / capex) * 100 : (total > 0 ? Infinity : 0);
    
    // Payback
    const acc = []; let acum = -enganche;
    for(let i=0;i<12;i++){ acum += (total - cuotas[i]); acc.push(acum); }
    const payIdx = capex > 0 ? acc.findIndex(v => v >= capex) : -1;
    const payback = payIdx >= 0 ? (payIdx + 1) : '—';
    
    // Neto en M1
    const netoM1 = total - (enganche + cuotas[0]);

    // Render tabla
    const body = document.getElementById('tbodyAhorros');
    body.innerHTML = parts
      .filter(([_,v]) => v>0.0001)
      .map(([k,v]) => `
        <tr>
          <td class="px-2 py-2">${k}</td>
          <td class="px-2 py-2 text-right font-mono">$${fmt(v)}</td>
          <td class="px-2 py-2 text-right"><span class="badge up">+${fmt((v/Math.max(total,1))*100,0)}%</span></td>
        </tr>
      `).join('') || `<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Sin ahorros activos</td></tr>`;
    document.getElementById('tdTotal').textContent = `$${fmt(total)}`;

    // Popular KPIs
    document.getElementById('valAhorroBruto').textContent = `$${fmt(total)}`;
    document.getElementById('valROI').textContent = isFinite(roiAnual) ? `${fmt(roiAnual)}%` : '∞%';
    document.getElementById('valPayback').textContent = payback;
    document.getElementById('valNetoM1').textContent = `$${fmt(netoM1)}`;
    
    const kN = document.getElementById('kpiNetoM1');
    kN.style.color = netoM1 >= 0 ? 'var(--good)' : 'var(--bad)';
    
    // Gráficos
    renderDonut('vizDonut', parts);
    renderCashflow('vizCash', { ahorroMes: total, capex, planSel, enganche, cuotas });
  }

  // --- GRÁFICA DE DONA MEJORADA ---
  function renderDonut(targetId, parts){
    const el=document.getElementById(targetId); if(!el) return;
    const data=parts.filter(p=>p[1]>0); const total=data.reduce((s,p)=>s+p[1],0);
    
    const W=600, H=400; 
    const cx = 210, cy = H / 2, r = H * 0.4, th = 50;
    let start=0; const colors=['#6366F1','#16A34A','#F59E0B','#06B6D4','#EF4444'];

    const legendX = 390;
    const legendFontSize = 18;
    const legendLineHeight = 30;
    const legendBlockHeight = data.length * legendLineHeight;
    const legendStartY = (H - legendBlockHeight) / 2 + (legendFontSize / 2);

    const segs=data.map((p,i)=>{ 
      const f= total? p[1]/total:0; const a0=start*2*Math.PI, a1=(start+f)*2*Math.PI; start+=f;
      const L=(a1-a0)>Math.PI?1:0;
      const x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0),x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
      const x0i=cx+(r-th)*Math.cos(a0),y0i=cy+(r-th)*Math.sin(a0),x1i=cx+(r-th)*Math.cos(a1),y1i=cy+(r-th)*Math.sin(a1);
      const d=`M ${x0} ${y0} A ${r} ${r} 0 ${L} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${L} 0 ${x0i} ${y0i} Z`;
      
      const pct=Math.round(f*100);
      const ly = legendStartY + (i * legendLineHeight);

      return `<path d="${d}" fill="${colors[i%colors.length]}" opacity="0.95"></path>
              <text x="${legendX}" y="${ly}" font-size="${legendFontSize}" fill="var(--text)">${p[0]}: ${pct}%</text>`;
    }).join('');

    const centerFontSize = Math.max(20, Math.round(r * 0.2));
    const centerText = total ? ('$' + fmt(total, 0)) : '—';

    const center = `<circle cx="${cx}" cy="${cy}" r="${r-th+1}" fill="rgba(255,255,255,0.04)"></circle>
                  <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" font-size="${centerFontSize}" fill="var(--text)">${centerText}</text>`;
    
    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${segs}${center}</svg>`;
  }

  // --- GRÁFICA DE FLUJO REEMPLAZADA (LÓGICA SOLIDCAM) ---
  function renderCashflow(targetId, {ahorroMes, capex, planSel, enganche, cuotas}){
    const el=document.getElementById(targetId); if(!el) return;
    const meses=Array.from({length:12},(_,i)=>`M${i+1}`);
    
    const W = 800, H = 400;
    const pad = { top: 40, right: 10, bottom: 50, left: 60 };
    const barW = 18, barGap = 6, gap = 38;
    const H_drawable = H - pad.top - pad.bottom;
    
    const pagos = cuotas.slice(); pagos[0]+=enganche; // sumar enganche en M1
    const netoMes = meses.map((_,i)=> (ahorroMes - pagos[i]));
    let acc = 0; const accArr = netoMes.map(v=>{ acc+=v; return acc; });

    // --- Nueva escala Y que maneja negativos ---
    const allValues = [ahorroMes||0, capex||0, ...pagos, ...accArr];
    const dataMax = Math.max(1, ...allValues.map(v => Math.max(0, v)));
    const dataMin = Math.min(0, ...allValues.map(v => Math.min(0, v)));
    const totalRange = dataMax - dataMin;

    const scaleY = (v) => {
      if (totalRange === 0) return H - pad.bottom;
      return (H - pad.bottom) - (((v - dataMin) / totalRange) * H_drawable);
    };

    const yZero = scaleY(0);

    // --- Lógica de barras y líneas ---
    let x = pad.left + gap/2;
    
    const bars = meses.map((m,i)=>{
      const yA = scaleY(ahorroMes); const hA = yZero - yA;
      const yP = scaleY(pagos[i]); const hP = yZero - yP; // "pagos"
      const xa = x, xp = x + barW + barGap;
      const labelY = H - pad.bottom + 20;
      
      const rects = `<rect x="${xa}" y="${yA}" width="${barW}" height="${hA}" fill="#22C55E"></rect>
                     <rect x="${xp}" y="${yP}" width="${barW}" height="${hP}" fill="#EF4444"></rect>`;
      const txt = `<text x="${x + barW + barGap/2}" y="${labelY}" font-size="14" fill="var(--text)" text-anchor="middle">${m}</text>`;
      
      x += (barW * 2 + barGap + gap);
      return rects+txt;
    }).join('');

    // --- Polilínea de Acumulado ---
    const linePts = accArr.map((v,i)=>{
      const xi = pad.left + gap/2 + i*(barW*2+barGap+gap) + (barW + barGap/2);
      const yi = scaleY(v);
      return `${xi},${yi}`;
    }).join(' ');
    const polyline = `<polyline points="${linePts}" fill="none" stroke="#A78BFA" stroke-width="3"></polyline>`;

    // --- Marcador de Payback (lógica SolidCAM) ---
    let marker=''; 
    if ((capex||0) > 0){
      const idx = accArr.findIndex(v=>v>=capex);
      if(idx!==-1){
        const xi_marker = pad.left + gap/2 + idx*(barW*2+barGap+gap) + (barW + barGap/2);
        const yi_marker = scaleY(accArr[idx]);
        marker = `<circle cx="${xi_marker}" cy="${yi_marker}" r="6" fill="#A78BFA" stroke="var(--bg)" stroke-width="2"></circle>
                  <text x="${xi_marker + 10}" y="${yi_marker - 10}" font-size="14" fill="#A78BFA">Payback M${idx+1}</text>`;
      }
    }
    
    // --- Línea de CAPEX ---
    const yCapex = scaleY(capex || 0);
    const capexLine = capex > 0 ? `<line x1="${pad.left}" y1="${yCapex}" x2="${W - (pad.right + 150)}" y2="${yCapex}" stroke="#60A5FA" stroke-dasharray="6 6"></line>
                                <text x="${pad.left + 8}" y="${yCapex-8}" font-size="14" fill="#60A5FA">CAPEX $${fmt(capex, 0)}</text>` : '';
    
    // --- Leyenda ---
    const legendX = W - pad.right - 150, legendY = pad.top;
    const legend = `
        <rect x="${legendX}" y="${legendY - 12}" width="140" height="82" rx="10" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.06)"></rect>
        <rect x="${legendX+12}" y="${legendY}" width="12" height="12" fill="#22C55E"></rect>
        <text x="${legendX+30}" y="${legendY+10}" font-size="14" fill="var(--text)">Ahorro</text>
        <rect x="${legendX+12}" y="${legendY+26}" width="12" height="12" fill="#EF4444"></rect>
        <text x="${legendX+30}" y="${legendY+36}" font-size="14" fill="var(--text)">Pago</text>
        <line x1="${legendX+12}" y1="${legendY+60}" x2="${legendX+24}" y2="${legendY+60}" stroke="#A78BFA" stroke-width="2.5"></line>
        <text x="${legendX+30}" y="${legendY+62}" font-size="14" fill="var(--text)">Acumulado</text>`;

    // --- Ejes Y (vertical) y X (horizontal en $0) ---
    const axis = `
        <line x1="${pad.left}" y1="${pad.top - 10}" x2="${pad.left}" y2="${H - pad.bottom}" stroke="rgba(255,255,255,.2)"></line>
        <line x1="${pad.left}" y1="${yZero}" x2="${W - pad.right}" y2="${yZero}" stroke="rgba(255,255,255,.2)"></line>
        <text x="${pad.left - 10}" y="${yZero + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$0</text>
        <text x="${pad.left - 10}" y="${scaleY(dataMax) + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$${fmt(dataMax, 0)}</text>
        ${dataMin < 0 ? `<text x="${pad.left - 10}" y="${scaleY(dataMin) + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$${fmt(dataMin, 0)}</text>` : ''}
    `;

    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">
      ${axis}${capexLine}${bars}${polyline}${marker}${legend}
    </svg>`;
  }

  // Eventos
  document.getElementById('btnCalc').addEventListener('click', calcular);
  document.getElementById('btnPrint').addEventListener('click', () => window.print());
  
  ['incA','incB','incC','incD','incE'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=>{ applyToggles(); calcular(); });
  });
  document.querySelectorAll('input,select').forEach(el=>{
    el.addEventListener('input', ()=>{ calcular(); });
  });

  // Init
  applyToggles();
  calcular();

  // Registro SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/proyectos/calculadoras/lantek/sw-lantek.js', { scope: '/proyectos/calculadoras/lantek/' })
      .catch(console.error);
  }
</script>
</body>
</html>
