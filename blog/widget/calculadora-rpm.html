<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora RPM & Avance — AlexRaSa</title>
  <meta name="description" content="Calculadora extendida integrada con cutting-data.json: fresado, torneado, holders, análisis de vibración y comparador A vs P." />
  <link rel="canonical" href="https://alexrasa.store/calculadora-rpm-avance" />
  <meta property="og:title" content="Calculadora RPM & Avance — AlexRaSa" />
  <meta property="og:description" content="Cálculos integrados: MRR, potencia, vida herramienta, coste, deflexión, vibración, fresado y torneado." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/assets/hero-industrial.png" />
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#0b1220;--card:#0f172a;--ink:#e6eef8;--muted:#9fb3c8;--accent:#0ea5e9}
    body{background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    .sidebar{width:380px;min-width:300px}
    .main{flex:1}
    .muted{color:var(--muted)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:1rem;border-radius:0.6rem}
    .small{font-size:0.85rem}
    .section-title{font-weight:700;color:var(--accent)}
    .result-value{font-weight:700;font-size:1.05rem}
    .toggle{appearance:none;width:44px;height:24px;background:#111827;border-radius:999px;position:relative;cursor:pointer}
    .toggle:checked{background:var(--accent)}
    .toggle:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:all .18s}
    .toggle:checked:before{transform:translateX(20px)}
    .risk-dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px}
    .site-header{border-bottom:1px solid rgba(255,255,255,0.03);padding:0.75rem 1rem;margin-bottom:1rem}
    .logo {font-weight:800;letter-spacing:.4px}
    .hero{background:linear-gradient(90deg, rgba(14,165,233,0.06), rgba(16,185,129,0.03));padding:1.25rem;border-radius:0.6rem;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.02)}
    .cta{background:linear-gradient(90deg,#10b981,#06b6d4);color:#041018;padding:.6rem .9rem;border-radius:0.5rem;font-weight:700}
    .mode-btn{background:#071122;padding:.35rem .6rem;border-radius:0.35rem;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    label.small.muted{display:block;margin-bottom:0.25rem}
    .inline-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem}
    .hero-visual{width:100%;height:140px;background-image:url('/assets/hero-industrial.png');background-size:cover;background-position:center;border-radius:6px}
  </style>
</head>
<body class="p-4">
  <!-- HEADER -->
  <header class="site-header flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="logo text-lg">AlexRaSa</div>
      <nav class="hidden md:flex gap-4 muted small">
        <a href="/#servicios" class="hover:underline">Servicios</a>
        <a href="/blog" class="hover:underline">Blog</a>
        <a href="/contacto" class="hover:underline">Contacto</a>
      </nav>
    </div>
    <div class="flex items-center gap-3">
      <a href="https://wa.me/524425992802" class="muted small">WhatsApp</a>
      <a href="/agenda" class="cta">Agendar visita</a>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero flex flex-col md:flex-row items-start gap-6">
    <div class="flex-1">
      <h1 class="text-2xl font-bold">Calculadora RPM & Avance — Fresado y Torneado</h1>
      <p class="muted mt-2">Cálculos integrados: MRR, potencia, vida herramienta, coste por pieza, deflexión, análisis de vibración. Selecciona modo y presets.</p>
      <div class="mt-4 flex gap-3">
        <button id="heroStart" class="cta">Empezar</button>
        <a href="#results" class="muted small self-center">Ir a resultados</a>
      </div>
      <div class="mt-3 muted small">Consejo: selecciona material y operación primero. Luego ajusta avance y profundidad.</div>
    </div>
    <div class="w-full md:w-72">
      <div class="hero-visual" aria-hidden="true"></div>
      <div class="card small mt-3">
        <div class="font-bold">Preset rápido</div>
        <div class="mt-2 grid grid-cols-2 gap-1 muted small">
          <div>Material</div><div>Acero 1045</div>
          <div>Operación</div><div>Desbaste</div>
          <div>Holder</div><div>Shrinkfit</div>
          <div>Modo</div><div id="presetMode">Fresado</div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN LAYOUT -->
  <div class="flex gap-4">
    <div class="main">
      <div class="card mb-4 flex items-center justify-between">
        <div>
          <h2 class="text-lg font-bold">Calculadora — entradas</h2>
          <div class="muted small">Rellena o usa presets.</div>
        </div>
        <div class="flex items-center gap-2">
          <div class="mode-btn active" id="modeF">Fresado</div>
          <div class="mode-btn" id="modeT">Torneado</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <!-- Inputs column -->
        <div class="card">
          <div class="section-title">Entradas — Parámetros</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Material</label>
            <select id="materialSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Operación</label>
            <select id="operationSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Sujeción / Holder</label>
            <select id="holderSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Tipo herramienta</label>
            <select id="toolTypeSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <div id="modeFresadoFields">
              <label class="small muted">Diámetro herramienta D (mm)</label>
              <input id="diam" type="number" step="0.01" value="12" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

              <label class="small muted">Dientes / cortantes (z)</label>
              <input id="z" type="number" step="1" value="4" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

              <label class="small muted">Velocidad de corte Vc (m/min)</label>
              <input id="vc" type="number" step="0.1" value="180" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

              <label class="small muted">Avance por diente fz (mm/tooth)</label>
              <input id="fz" type="number" step="0.0001" value="0.06" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="small muted">Ae (mm) ancho de corte</label>
                  <input id="ae" type="number" step="0.01" value="10" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
                </div>
                <div>
                  <label class="small muted">Ap (mm) profundidad</label>
                  <input id="ap" type="number" step="0.01" value="2" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
                </div>
              </div>
            </div>

            <div id="modeTorneadoFields" style="display:none">
              <label class="small muted">Diámetro pieza D (mm)</label>
              <input id="diamT" type="number" step="0.01" value="60" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              <label class="small muted">Profundidad de corte ap (mm)</label>
              <input id="apT" type="number" step="0.01" value="2" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              <label class="small muted">Velocidad de corte Vc (m/min)</label>
              <input id="vcT" type="number" step="0.1" value="120" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              <label class="small muted">Avance f (mm/rev)</label>
              <input id="fT" type="number" step="0.001" value="0.15" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            </div>

            <label class="small muted">Stickout L (mm)</label>
            <input id="stickout" type="number" step="1" value="60" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
          </div>
        </div>

        <!-- Costs and options -->
        <div class="card">
          <div class="section-title">Costos, vida y opciones</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Costo hora máquina (MXN)</label>
            <input id="machineCost" type="number" step="0.1" value="400" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Costo herramienta (MXN)</label>
            <input id="toolCost" type="number" step="0.1" value="1200" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Volumen a remover por pieza (cm³) — fresado</label>
            <input id="volumen" type="number" step="0.01" value="18" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Constante Taylor C</label>
            <input id="C" type="number" step="1" value="40000" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">Exponente n (Taylor)</label>
            <input id="n" type="number" step="0.01" value="0.25" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <div class="mt-2">
              <label class="small muted">Opciones — mostrar cálculos</label>
              <div class="inline-grid-3 mt-2">
                <label class="flex items-center gap-2"><input id="enableCycle" type="checkbox" class="toggle" checked /> <span class="small">Tiempo</span></label>
                <label class="flex items-center gap-2"><input id="enableKc" type="checkbox" class="toggle" checked /> <span class="small">Kc/ Pot</span></label>
                <label class="flex items-center gap-2"><input id="enableStability" type="checkbox" class="toggle" checked /> <span class="small">Vibración</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 card">
        <div class="flex items-center justify-between">
          <div class="section-title">Comparador A vs P</div>
          <div class="small muted">Introduce escenario B</div>
        </div>
        <div class="mt-3 grid grid-cols-4 gap-2">
          <input id="vcB" type="number" step="0.1" value="120" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="Vc B" />
          <input id="fzB" type="number" step="0.0001" value="0.04" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="fz B" />
          <input id="aeB" type="number" step="0.01" value="8" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="ae B" />
          <input id="apB" type="number" step="0.01" value="1" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="ap B" />
        </div>
        <div class="mt-3">
          <button id="btnCompare" class="px-4 py-2 bg-accent text-black rounded font-bold">Comparar</button>
        </div>
      </div>

    </div>

    <!-- Sidebar results -->
    <aside class="sidebar card">
      <div class="flex items-center justify-between mb-2">
        <div class="section-title">Resultados</div>
        <div class="small muted">Panel derecho — exportable</div>
      </div>

      <div id="results" class="space-y-3 small"></div>

      <div class="mt-3">
        <button id="btnExportPdf" class="w-full px-4 py-2 rounded bg-[#10b981] text-black font-bold">Exportar PDF</button>
        <button id="btnExportCsv" class="w-full mt-2 px-4 py-2 rounded bg-[#0ea5e9] text-black font-bold">Exportar CSV</button>
      </div>

      <div class="mt-4 card">
        <div class="section-title">Gráficos</div>
        <canvas id="chartMRR" height="160"></canvas>
      </div>

      <div class="mt-3 card">
        <div class="section-title">Tabla comparativa</div>
        <div class="mt-2 overflow-auto" style="max-height:240px">
          <table id="tableCompare" class="w-full text-left small">
            <thead><tr><th class="muted">Métrica</th><th class="muted">A</th><th class="muted">B</th><th class="muted">Δ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </aside>
  </div>

<script>
/* ---------- Preferencia: cargar cutting-data.json externo y fallback embebido ---------- */
const EMBEDDED_CUTTING_DATA = {
  "version":"3.1",
  "defaults":{"rpm_limit":12000,"efficiency":0.8,"vibe_gauss":{"mu":0.7,"sigma":0.2},"default_flutes":4},
  "vibration":{"avoid_band_hz":[600,900],"risk_threshold":0.8,"weights":{"ld":0.5,"ae":0.2,"ap":0.2,"fz":0.1}},
  "holders":[
    {"id":"ER Collet","label":"Portapinzas ER","stiffness_factor":1.0},
    {"id":"Heavy ER","label":"Portapinzas ER reforzado","stiffness_factor":1.12},
    {"id":"REGOFIX_powRgrip","label":"REGO-FIX powRgrip","stiffness_factor":1.45},
    {"id":"Shrinkfit","label":"Shrink-fit","stiffness_factor":1.35},
    {"id":"MillingChuck","label":"Milling Chuck","stiffness_factor":1.2}
  ],
  "materials":[
    {"id":"alu_6061","name":"Aluminio 6061","Kc_N_per_mm2":800,"taylor":{"C":1000,"n":0.12}},
    {"id":"alu_7075","name":"Aluminio 7075","Kc_N_per_mm2":950,"taylor":{"C":900,"n":0.12}},
    {"id":"steel_1045","name":"Acero 1045","Kc_N_per_mm2":2000,"taylor":{"C":300,"n":0.2}},
    {"id":"steel_4140_ph","name":"Acero 4140 PH","Kc_N_per_mm2":3200,"taylor":{"C":120,"n":0.12}},
    {"id":"inox_304","name":"Inox 304","Kc_N_per_mm2":2200,"taylor":{"C":200,"n":0.18}},
    {"id":"ti_64","name":"Titanio Ti-6Al-4V","Kc_N_per_mm2":1200,"taylor":{"C":150,"n":0.18}},
    {"id":"cast_iron","name":"Fundición gris","Kc_N_per_mm2":1800,"taylor":{"C":500,"n":0.15}}
  ],
  "operations":[
    {"id":"rough","label":"Desbaste","default_ae_pct":30,"default_ap_per_d":0.5},
    {"id":"semi","label":"Semidesbaste","default_ae_pct":18,"default_ap_per_d":0.4},
    {"id":"finish","label":"Acabado","default_ae_pct":12,"default_ap_per_d":0.2},
    {"id":"adaptive","label":"Trocoidal/Adaptativo","default_ae_pct":25,"default_ap_per_d":1.0},
    {"id":"turn_rough","label":"Torneado - Desbaste","default_ap":2,"note":"Torneado: ap en mm, f en mm/rev"}
  ],
  "tool_types":[
    {"id":"endmill","label":"Fresa (Endmill)","vc_factor":1.0,"fz_factor":1.0,"default_flutes":4},
    {"id":"ball","label":"Fresa bola","vc_factor":0.9,"fz_factor":0.9,"default_flutes":4}
  ]
};

let CUTTING_DATA = null;
async function loadCuttingData(){
  try{
    const resp = await fetch('/data/cutting-data.json', {cache:'no-store'});
    if(!resp.ok) throw new Error('no externo');
    CUTTING_DATA = await resp.json();
    console.log('cutting-data.json cargado desde /data/cutting-data.json');
  }catch(e){
    CUTTING_DATA = EMBEDDED_CUTTING_DATA;
    console.warn('No se encontró cutting-data.json externo. Usando embedded fallback.');
  }
}
/****** PATCH: soporte torneado con porta-insertos (reemplaza el patch anterior) ******/
function ensureTurningEntries(){
  // Añade tool types y holders específicos para torneado si no existen
  const toolIds = ['turn_insert','boring_bar','external_turn_tool'];
  const holderIds = ['PortaInsertos','PortaTorreta','PortaBarrenador'];

  // tool types
  toolIds.forEach(id=>{
    if(!CUTTING_DATA.tool_types.some(t=>t.id===id)){
      if(id==='turn_insert'){
        CUTTING_DATA.tool_types.push({id:'turn_insert', label:'Herramienta de torneado (insertos)', vc_factor:1.0, fz_factor:1.0, default_flutes:1});
      }
      if(id==='boring_bar'){
        CUTTING_DATA.tool_types.push({id:'boring_bar', label:'Barra de mandrinado', vc_factor:0.9, fz_factor:1.0, default_flutes:1});
      }
      if(id==='external_turn_tool'){
        CUTTING_DATA.tool_types.push({id:'external_turn_tool', label:'Herram. externa (torneado)', vc_factor:1.0, fz_factor:1.0, default_flutes:1});
      }
    }
  });

  // holders (portainsertos / torreta)
  holderIds.forEach(id=>{
    if(!CUTTING_DATA.holders.some(h=>h.id===id)){
      if(id==='PortaInsertos'){
        CUTTING_DATA.holders.push({id:'PortaInsertos', label:'Porta-insertos para tornear', stiffness_factor:1.15});
      }
      if(id==='PortaTorreta'){
        CUTTING_DATA.holders.push({id:'PortaTorreta', label:'Porta en torreta (indexable)', stiffness_factor:1.2});
      }
      if(id==='PortaBarrenador'){
        CUTTING_DATA.holders.push({id:'PortaBarrenador', label:'Porta para barras/mandrinado', stiffness_factor:1.05});
      }
    }
  });
}

// Mapas ajustados: mostraremos porta-insertos en torneado
const HOLDERS_BY_MODE = {
  fresado: [ 'ER Collet','Heavy ER','REGOFIX_powRgrip','Shrinkfit','MillingChuck' ],
  torneado: [ 'PortaInsertos','PortaTorreta','PortaBarrenador','REGOFIX_powRgrip' ]
};
const TOOLTYPES_BY_MODE = {
  fresado: [ 'endmill','ball' ],
  torneado: [ 'turn_insert','boring_bar','external_turn_tool' ]
};

function updateModeOptions(mode){
  ensureTurningEntries();

  // actualizar holders
  const holderSel = $('holderSelect');
  holderSel.innerHTML = '';
  const idsH = (mode === 'torneado') ? HOLDERS_BY_MODE.torneado : HOLDERS_BY_MODE.fresado;
  const knownHolderIds = CUTTING_DATA.holders.map(h=>h.id);
  const finalHolderIds = idsH.filter(id=>knownHolderIds.includes(id));
  const holdersToShow = finalHolderIds.length ? finalHolderIds : CUTTING_DATA.holders.map(h=>h.id);
  holdersToShow.forEach(id=>{
    const h = CUTTING_DATA.holders.find(x=>x.id===id);
    if(h){
      const opt = document.createElement('option'); opt.value = h.id; opt.textContent = h.label || h.id;
      holderSel.appendChild(opt);
    }
  });

  // actualizar tool types
  const toolSel = $('toolTypeSelect');
  toolSel.innerHTML = '';
  const idsT = (mode === 'torneado') ? TOOLTYPES_BY_MODE.torneado : TOOLTYPES_BY_MODE.fresado;
  const knownToolIds = CUTTING_DATA.tool_types.map(t=>t.id);
  const finalToolIds = idsT.filter(id=>knownToolIds.includes(id));
  const toolsToShow = finalToolIds.length ? finalToolIds : CUTTING_DATA.tool_types.map(t=>t.id);
  toolsToShow.forEach(id=>{
    const t = CUTTING_DATA.tool_types.find(x=>x.id===id);
    if(t){
      const opt = document.createElement('option'); opt.value = t.id; opt.textContent = t.label || t.id;
      toolSel.appendChild(opt);
    }
  });

  // seleccionar primer elemento si existe
  if(holderSel.options.length) holderSel.value = holderSel.options[0].value;
  if(toolSel.options.length) toolSel.value = toolSel.options[0].value;
}

// Llamada inicial para asegurar selects correctos tras carga
(async ()=>{
  if(CUTTING_DATA){
    populateFromData();
    updateModeOptions('fresado');
  } else {
    await loadCuttingData();
    populateFromData();
    updateModeOptions('fresado');
  }
})();
/****** END PATCH ******/


/* ------------------- Helpers ------------------- */
const $ = id => document.getElementById(id);
function fmt(n,dec=2){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec}); }

/* ---------- UI population y lógica de modo (Fresado/Torneado) ---------- */
function populateFromData(){
  const mSel = $('materialSelect'); mSel.innerHTML='';
  CUTTING_DATA.materials.forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.name; mSel.appendChild(opt); });
  const oSel = $('operationSelect'); oSel.innerHTML='';
  CUTTING_DATA.operations.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=o.label; oSel.appendChild(opt); });
  const hSel = $('holderSelect'); hSel.innerHTML='';
  CUTTING_DATA.holders.forEach(h=>{ const opt=document.createElement('option'); opt.value=h.id; opt.textContent=h.label; hSel.appendChild(opt); });
  const tSel = $('toolTypeSelect'); tSel.innerHTML='';
  CUTTING_DATA.tool_types.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.label; tSel.appendChild(opt); });

  if(CUTTING_DATA.materials.length) mSel.value = CUTTING_DATA.materials[0].id;
  if(CUTTING_DATA.operations.length) oSel.value = CUTTING_DATA.operations[0].id;
  if(CUTTING_DATA.holders.length) hSel.value = CUTTING_DATA.holders[0].id;
  if(CUTTING_DATA.tool_types.length) tSel.value = CUTTING_DATA.tool_types[0].id;

  document.getElementById('presetMode').textContent = 'Fresado';
}

function applyOperationDefaults(){
  const op = CUTTING_DATA.operations.find(x=>x.id==$('operationSelect').value);
  const D = parseFloat($('diam')?.value)||12;
  if(!op) return;
  if(op.default_ae_pct && $('ae')) $('ae').value = Math.max(1, Math.round((op.default_ae_pct/100)*D*100)/100);
  if(op.default_ap_per_d && $('ap')) $('ap').value = Math.max(0.01, Math.round((op.default_ap_per_d*D)*100)/100);
  if(op.default_ap && $('apT')) $('apT').value = op.default_ap;
}

/* ---------------- Vibration scoring (same approach) ---------------- */
function vibrationRiskScore(params){
  const w = CUTTING_DATA.vibration.weights;
  const Lnorm = Math.min(1, (params.L||0)/200);
  const aenorm = Math.min(1, ((params.ae||0) / (params.D||1)));
  const apnorm = Math.min(1, ((params.ap||0) / ((params.D||1)*1.5)));
  const fznorm = Math.min(1, ((params.fz||0) / 0.5));
  const score = ( (w.ld||0.5)*Lnorm + (w.ae||0.2)*aenorm + (w.ap||0.2)*apnorm + (w.fz||0.1)*fznorm );
  const mu = CUTTING_DATA.defaults.vibe_gauss.mu || 0.7;
  const sigma = CUTTING_DATA.defaults.vibe_gauss.sigma || 0.2;
  const z = (score - mu)/sigma;
  const p = 1/(1+Math.exp(-z));
  return {raw:score,prob:p};
}

/* ------------------ Cálculos (Fresado y Torneado) ------------------ */
function computeFresado(){
  const D = parseFloat($('diam').value) || 0.001;
  const z = parseInt($('z').value) || 1;
  const vc = parseFloat($('vc').value) || 0.1;
  const fz = parseFloat($('fz').value) || 0.0001;
  const ae = parseFloat($('ae').value) || 0.1;
  const ap = parseFloat($('ap').value) || 0.1;
  const mat = CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value) || CUTTING_DATA.materials[0];
  const holder = CUTTING_DATA.holders.find(h=>h.id==$('holderSelect').value) || CUTTING_DATA.holders[0];
  const Kc0 = mat.Kc_N_per_mm2 || 2000;
  const mexp = parseFloat($('mexp')?.value) || 0.2;
  const entryAngle = 90 * Math.PI/180;
  const rpm = (vc*1000)/(Math.PI*D);
  const feed_mm_min = rpm * z * fz;
  const mrr_mm3_min = feed_mm_min * ae * ap;
  const mrr_cm3_min = mrr_mm3_min / 1000;
  const chip_h = fz * Math.abs(Math.sin(entryAngle));
  const Kc_h = Kc0 * Math.pow(chip_h + 1e-6, -mexp);
  const eta = CUTTING_DATA.defaults.efficiency || 0.8;
  const power_kW = (Kc_h * mrr_mm3_min) / (60*1000) / eta;
  const volumen = parseFloat($('volumen').value)||0.001;
  const time_min = volumen / Math.max(mrr_cm3_min,1e-9);
  const cost_machine = (time_min/60) * (parseFloat($('machineCost').value)||0);
  const life_min = (CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value)?.taylor?.C) || parseFloat($('C').value) || 40000;
  const n = (CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value)?.taylor?.n) || parseFloat($('n').value) || 0.25;
  const toolLife_min = life_min / Math.pow(Math.max(vc,1e-6), n);
  const pieces_per_tool = Math.max(Math.floor(toolLife_min / Math.max(time_min,1e-9)),1);
  const tool_cost_per_piece = (parseFloat($('toolCost').value)||0) / pieces_per_tool;
  const F_radial = Kc_h * ae * ap * 0.001;
  const E = (parseFloat($('E')?.value)||210) * 1000;
  const I = Math.PI * Math.pow(D,4) / 64;
  const L = parseFloat($('stickout').value||60);
  const stiffness_factor = holder.stiffness_factor || 1.0;
  const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
  const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
  const m_eff = 0.02;
  const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
  const toothHz = (rpm/60) * z;
  const vib = vibrationRiskScore({L, ae, ap, fz, D});
  return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, power_kW, time_min, cost_machine, pieces_per_tool, tool_cost_per_piece, delta_mm, f_n, toothHz, F_radial, vib, mode:'fresado'};
}

function computeTorneado(){
  const D = parseFloat($('diamT').value) || 0.001;
  const ap = parseFloat($('apT').value) || 0.5;
  const vc = parseFloat($('vcT').value) || 0.1;
  const f = parseFloat($('fT').value) || 0.1;
  const mat = CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value) || CUTTING_DATA.materials[0];
  const holder = CUTTING_DATA.holders.find(h=>h.id==$('holderSelect').value) || CUTTING_DATA.holders[0];
  const Kc0 = mat.Kc_N_per_mm2 || 2000;
  const rpm = (vc*1000)/(Math.PI*D);
  const feed_mm_min = rpm * f;
  const mrr_mm3_min = Math.PI * D * ap * f * rpm / 4;
  const mrr_cm3_min = mrr_mm3_min / 1000;
  const chip_h = f;
  const mexp = parseFloat($('mexp')?.value) || 0.2;
  const Kc_h = Kc0 * Math.pow(chip_h + 1e-6, -mexp);
  const eta = CUTTING_DATA.defaults.efficiency || 0.8;
  const power_kW = (Kc_h * mrr_mm3_min) / (60*1000) / eta;
  const volumen = parseFloat($('volumen').value)||0.001;
  const time_min = volumen / Math.max(mrr_cm3_min,1e-9);
  const cost_machine = (time_min/60) * (parseFloat($('machineCost').value)||0);
  const life_min = (CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value)?.taylor?.C) || parseFloat($('C').value) || 40000;
  const n = (CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value)?.taylor?.n) || parseFloat($('n').value) || 0.25;
  const toolLife_min = life_min / Math.pow(Math.max(vc,1e-6), n);
  const pieces_per_tool = Math.max(Math.floor(toolLife_min / Math.max(time_min,1e-9)),1);
  const tool_cost_per_piece = (parseFloat($('toolCost').value)||0) / pieces_per_tool;
  const F_radial = Kc_h * ap * f * 0.001;
  const E = (parseFloat($('E')?.value)||210) * 1000;
  const I = Math.PI * Math.pow(D,4) / 64;
  const L = parseFloat($('stickout').value||60);
  const stiffness_factor = holder.stiffness_factor || 1.0;
  const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
  const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
  const m_eff = 0.02;
  const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
  const toothHz = rpm/60;
  const vib = vibrationRiskScore({L, ae:ap, ap, fz:f, D});
  return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, power_kW, time_min, cost_machine, pieces_per_tool, tool_cost_per_piece, delta_mm, f_n, toothHz, F_radial, vib, mode:'torneado'};
}

/* -------------------- Render resultados -------------------- */
function render(){
  applyOperationDefaults();
  const modeT = document.getElementById('modeT').classList.contains('active');
  const A = modeT ? computeTorneado() : computeFresado();
  const out = $('results'); out.innerHTML = '';
  const s = document.createElement('div'); s.className='card small';
  s.innerHTML = `<div class="font-bold">Resumen rápido — ${A.mode}</div>
    <div class="mt-2 grid grid-cols-2 gap-1">
      <div class="muted">RPM</div><div class="result-value">${fmt(A.rpm,0)}</div>
      <div class="muted">Avance (mm/min)</div><div class="result-value">${fmt(A.feed_mm_min,2)}</div>
      <div class="muted">MRR (cm³/min)</div><div class="result-value">${fmt(A.mrr_cm3_min,3)}</div>
      <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
    </div>`;
  out.appendChild(s);

  if($('enableCycle').checked){
    const c = document.createElement('div'); c.className='card small';
    c.innerHTML = `<div class="font-bold">Tiempo & Coste</div>
      <div class="mt-2 grid grid-cols-2 gap-1">
        <div class="muted">Tiempo por pieza (min)</div><div class="result-value">${fmt(A.time_min,2)}</div>
        <div class="muted">Costo máquina (MXN)</div><div class="result-value">${fmt(A.cost_machine,2)}</div>
        <div class="muted">Costo herramienta por pieza (MXN)</div><div class="result-value">${fmt(A.tool_cost_per_piece,2)}</div>
      </div>`;
    out.appendChild(c);
  }

  if($('enableKc').checked){
    const k = document.createElement('div'); k.className='card small';
    k.innerHTML = `<div class="font-bold">Kc(h) y Potencia</div>
      <div class="mt-2 grid grid-cols-2 gap-1">
        <div class="muted">Chip thickness (mm)</div><div class="result-value">${fmt(A.chip_h,4)}</div>
        <div class="muted">Kc(h) (N/mm²)</div><div class="result-value">${fmt(A.Kc_h,1)}</div>
        <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
      </div>
      <div class="mt-2 muted small">Nota: fórmulas aproximadas. Valida en banco de pruebas.</div>`;
    out.appendChild(k);
  }

  if($('enableStability').checked){
    const st = document.createElement('div'); st.className='card small';
    const riskColor = A.vib.prob > CUTTING_DATA.vibration.risk_threshold ? '#e11d48' : (A.vib.prob > 0.5 ? '#f59e0b' : '#10b981');
    st.innerHTML = `<div class="font-bold">Análisis de Vibración</div>
      <div class="mt-2 grid grid-cols-2 gap-1">
        <div class="muted">f_n (Hz aprox)</div><div class="result-value">${fmt(A.f_n,1)}</div>
        <div class="muted">Freq relevante (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
        <div class="muted">Score raw</div><div class="result-value">${fmt(A.vib.raw,3)}</div>
        <div class="muted">Prob riesgo</div><div class="result-value"><span style="display:inline-block;background:${riskColor};width:10px;height:10px;border-radius:999px;margin-right:6px"></span>${fmt(A.vib.prob,2)}</div>
      </div>
      <div class="mt-2 muted small">Evitar bandas: ${CUTTING_DATA.vibration.avoid_band_hz.join('-')} Hz. Si la probabilidad es alta, reduce avances o cambia holder.</div>`;
    out.appendChild(st);
  }

  renderChart(A);
  renderCompareTable(A, null);
}

/* --------------- Chart y tabla comparativa -------------- */
let chartMRR = null;
function renderChart(A){
  const ctx = $('chartMRR').getContext('2d');
  const labels=[]; const dataMRR=[];
  const base = (A.mode === 'torneado') ? parseFloat($('vcT').value||120) : parseFloat($('vc').value||180);
  for(let k=0;k<=10;k++){
    const vcx = base*(0.6 + 0.08*k);
    labels.push(Math.round(vcx));
    if(A.mode==='torneado'){
      const D = parseFloat($('diamT').value)||60;
      const ap = parseFloat($('apT').value)||2;
      const f = parseFloat($('fT').value)||0.15;
      const rpm = (vcx*1000)/(Math.PI*D);
      const mrr = Math.PI * D * ap * f * rpm / 4 / 1000;
      dataMRR.push(mrr);
    }else{
      const D = parseFloat($('diam').value)||12;
      const z = parseInt($('z').value)||4;
      const fz = parseFloat($('fz').value)||0.06;
      const rpm = (vcx*1000)/(Math.PI*D);
      const feed = rpm*z*fz;
      const mrr = feed * parseFloat($('ae').value||10) * parseFloat($('ap').value||2)/1000;
      dataMRR.push(mrr);
    }
  }
  if(chartMRR) chartMRR.destroy();
  chartMRR = new Chart(ctx,{type:'line',data:{labels, datasets:[{label:'MRR (cm3/min)', data:dataMRR, fill:true, tension:0.25}]}, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

function renderCompareTable(A,B){
  const tbody = $('tableCompare').querySelector('tbody'); tbody.innerHTML='';
  if(!B){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="muted">Comparador</td><td colspan="3" class="small muted">Activa "Comparador A vs P" y presiona Comparar</td>`;
    tbody.appendChild(tr);
    return;
  }
  const vibB = vibrationRiskScore({
    L: parseFloat($('stickout').value || 60),
    ae: parseFloat($('aeB').value || 8),
    ap: parseFloat($('apB').value || 1),
    fz: parseFloat($('fzB').value || 0.04),
    D: parseFloat($('diam').value || 12)
  });
  const rows = [
    ['RPM', fmt(A.rpm,0), fmt(B.rpm,0), fmt(B.rpm - A.rpm,0)],
    ['MRR (cm3/min)', fmt(A.mrr_cm3_min,3), fmt(B.mrr_cm3_min,3), fmt(B.mrr_cm3_min - A.mrr_cm3_min,3)],
    ['Tiempo/pieza (min)', fmt(A.time_min,2), fmt(B.time_min,2), fmt(B.time_min - A.time_min,2)],
    ['Costo/pieza (MXN)', fmt(A.cost_machine,2), fmt(B.cost_machine,2), fmt(B.cost_machine - A.cost_machine,2)],
    ['Piezas por herramienta', fmt(A.pieces_per_tool,0), fmt(B.pieces_per_tool,0), fmt(B.pieces_per_tool - A.pieces_per_tool,0)],
    ['Vib. prob', fmt(A.vib.prob,2), fmt(vibB.prob,2), fmt(vibB.prob - A.vib.prob,2)]
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="muted small">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------------- Exports (CSV/PDF) --------------- */
document.getElementById('btnExportCsv').addEventListener('click', ()=>{
  const modeT = document.getElementById('modeT').classList.contains('active');
  const A = modeT ? computeTorneado() : computeFresado();
  const vibBprob = '';
  const rows = [
    ['metric','A','B'],
    ['RPM', A.rpm, ''],
    ['MRR_cm3_min', A.mrr_cm3_min, ''],
    ['time_min', A.time_min, ''],
    ['cost_piece', A.cost_machine, ''],
    ['vib_prob', A.vib.prob, vibBprob]
  ];
  const csv = rows.map(r=> r.join(',') ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'calculadora_rpm_export.csv'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('btnExportPdf').addEventListener('click', async ()=>{
  const element = document.body;
  const canvas = await html2canvas(element, {scale:1.5});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'portrait',unit:'px',format:[canvas.width, canvas.height]});
  pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
  pdf.save('reporte_calculadora_rpm.pdf');
});

/* --------------- UI events y arranque -------------- */
document.getElementById('modeF').addEventListener('click', ()=>{
  document.getElementById('modeF').classList.add('active'); document.getElementById('modeT').classList.remove('active');
  document.getElementById('modeFresadoFields').style.display='block'; document.getElementById('modeTorneadoFields').style.display='none';
  document.getElementById('presetMode').textContent='Fresado';
  render();
});
document.getElementById('modeT').addEventListener('click', ()=>{
  document.getElementById('modeT').classList.add('active'); document.getElementById('modeF').classList.remove('active');
  document.getElementById('modeFresadoFields').style.display='none'; document.getElementById('modeTorneadoFields').style.display='block';
  document.getElementById('presetMode').textContent='Torneado';
  render();
});

document.getElementById('heroStart').addEventListener('click', ()=>{ document.querySelector('#materialSelect').focus(); });
document.getElementById('btnCompare').addEventListener('click', ()=>{
  const modeT = document.getElementById('modeT').classList.contains('active');
  const A = modeT ? computeTorneado() : computeFresado();
  const vcB = parseFloat($('vcB').value) || (modeT? parseFloat($('vcT').value): parseFloat($('vc').value));
  const fzB = parseFloat($('fzB').value) || parseFloat($('fz').value);
  const aeB = parseFloat($('aeB').value) || parseFloat($('ae').value);
  const apB = parseFloat($('apB').value) || parseFloat($('ap').value);
  let B;
  if(!modeT){
    const D = parseFloat($('diam').value)||12; const z = parseInt($('z').value)||4;
    const rpmB = (vcB*1000)/(Math.PI*D);
    const feedB = rpmB * z * fzB;
    const mrrB = feedB * aeB * apB / 1000;
    const chip_hB = fzB;
    const Kc0 = (CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value)||{}).Kc_N_per_mm2 || 2000;
    const mexp = parseFloat($('mexp')?.value) || 0.2;
    const Kc_hB = Kc0 * Math.pow(chip_hB + 1e-6, -mexp);
    const powerB = (Kc_hB * feedB * aeB * apB) / (60*1000) / (CUTTING_DATA.defaults.efficiency||0.8);
    const time_minB = (parseFloat($('volumen').value)||1) / Math.max(mrrB,1e-9);
    const cost_machineB = (time_minB/60) * (parseFloat($('machineCost').value)||0);
    B = {rpm:rpmB, mrr_cm3_min:mrrB, time_min:time_minB, cost_machine:cost_machineB, pieces_per_tool:0};
  }else{
    const D = parseFloat($('diamT').value)||60; const ap = parseFloat($('apT').value)||2; const fT = parseFloat($('fT').value)||0.15;
    const rpmB = (vcB*1000)/(Math.PI*D);
    const mrrB = Math.PI * D * ap * fT * rpmB / 4 / 1000;
    const time_minB = (parseFloat($('volumen').value)||1) / Math.max(mrrB,1e-9);
    const cost_machineB = (time_minB/60) * (parseFloat($('machineCost').value)||0);
    B = {rpm:rpmB, mrr_cm3_min:mrrB, time_min:time_minB, cost_machine:cost_machineB, pieces_per_tool:0};
  }
  renderCompareTable(A,B);
});

['input','change'].forEach(ev=> document.querySelectorAll('input,select').forEach(i=>i.addEventListener(ev, ()=>{ render(); })));

/* --------------- Inicializar: cargar datos y render -------------- */
(async ()=>{ await loadCuttingData(); populateFromData(); applyOperationDefaults(); render(); })();

</script>
</body>
</html>
