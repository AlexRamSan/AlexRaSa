<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de RPM y avance — extendida</title>
  <meta name="description" content="Calcula RPM, avance, MRR, potencia, torque, deflexión, Ra y riesgo de vibración. Presets cargados desde cutting-data.json." />
  <link rel="canonical" href="https://alexrasa.store/blog/calculadora-rpm-avance.html" />
  <meta name="color-scheme" content="dark" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent:#0ea5e9; --rose:#e11d48; --emerald:#10b981; --indigo:#6366f1;
    }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu;}
    .container{max-width:1180px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px}
    .lead{color:var(--muted)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);padding:.5rem .8rem;border-radius:8px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
    .tab{padding:.5rem .8rem;border-radius:8px;border:1px solid var(--border);background:rgba(148,163,184,.06)}
    .tab.is-on{background:var(--accent);border-color:var(--accent);color:#061018}
    .field>label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:.25rem}
    .field>input,.field>select{width:100%;border-radius:8px;padding:.5rem .6rem;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--ink)}
    .kpi-value{font-size:1.35rem;color:#eaf2ff}
    .pill{font-size:.7rem;border:1px solid var(--border);border-radius:999px;padding:.12rem .5rem;color:var(--muted)}
    .vibe-box{background:rgba(148,163,184,.04);border:1px dashed var(--border);border-radius:10px;padding:12px;transition:background .18s,border-color .18s}
    .vibe-box.ok   { border-color:#16a34a; background:rgba(22,163,74,.04) }
    .vibe-box.warn { border-color:#f59e0b; background:rgba(245,158,11,.04) }
    .vibe-box.bad  { border-color:#ef4444; background:rgba(239,68,68,.04) }
    .badge{font-size:.72rem;border-radius:999px;padding:.15rem .5rem;border:1px solid var(--border)}
    .badge.ok{background:#052e1b;color:#86efac;border-color:#166534}
    .badge.warn{background:#3a2801;color:#fde68a;border-color:#b45309}
    .badge.bad{background:#3b0a0a;color:#fecaca;border-color:#b91c1c}
    .hint{color:var(--muted);font-size:.75rem}
    .canvas-wrap{width:100%;height:220px}
    .canvas-wrap canvas{width:100%;height:100%}
    #pdf-report{ box-sizing: border-box; width: 794px; min-height: 1123px; margin: 0; padding: 0; transform: none !important; -webkit-transform: none !important; }
    select, option{ color: var(--ink); background-color: var(--card); }
    select:focus{ outline:2px solid var(--accent); outline-offset:1px }
  </style>
</head>
<body>
  <section class="relative mb-4">
    <div class="container mx-auto px-4 py-6">
      <h1 class="text-2xl font-extrabold">Calculadora RPM & Avance — Pro</h1>
      <p class="lead mt-1">MRR, potencia, torque, vibración. Presets cargados desde cutting-data.json.</p>
    </div>
  </section>

  <main class="container mx-auto px-4 pb-24">
    <section class="card p-4">
      <div class="flex gap-2 items-center">
        <div>
          <button id="uMetric" class="tab is-on" type="button" title="Selecciona unidades métricas (mm, m/min, kW)">Métrico</button>
          <button id="uImperial" class="tab" type="button" title="Selecciona unidades imperiales (in, SFM, HP)">Imperial</button>
        </div>
        <div class="ml-auto text-sm text-slate-400 select-none">Modo avanzado activo</div>
      </div>

      <div class="grid md:grid-cols-6 gap-3 mt-4">
        <div class="field md:col-span-2">
          <label>Material</label>
          <select id="material" title="Material de la pieza. Afecta vc, fz y Kc."></select>
        </div>
        <div class="field">
          <label>Operación</label>
          <select id="operation" title="Tipo de operación: desbaste, acabado, ranurado, etc."></select>
        </div>
        <div class="field">
          <label>Tipo de herramienta</label>
          <select id="toolType" title="Tipo de herramienta (fresa, broca, careador, etc.)."></select>
        </div>
        <div class="field">
          <label>Material de herramienta</label>
          <select id="toolMat" title="Material de la herramienta (carburo, HSS). Ajusta vc y fz."></select>
        </div>
        <div class="field">
          <label>Máquina</label>
          <select id="machine" title="Perfil de máquina con límites de RPM, potencia y avance."></select>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mt-5">
        <div class="field">
          <label>Diámetro herramienta</label>
          <input id="diam" type="number" step="0.001" placeholder="mm o in según unidad" title="Diámetro de la herramienta. En mm o in según la unidad seleccionada.">
        </div>
        <div class="field">
          <label>Filos (z)</label>
          <input id="flutes" type="number" min="1" step="1" value="3" title="Número de filos de la herramienta.">
        </div>
        <div class="field">
          <label>Límite de RPM de máquina</label>
          <input id="rpmLimit" type="number" step="1" placeholder="p. ej. 12000" title="Límite máximo de RPM que permite la máquina.">
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="field">
          <label>Velocidad de corte (Vc / SFM)</label>
          <input id="vc" type="number" step="0.1" placeholder="m/min o SFM" title="Velocidad de corte. En m/min si usas métricas o SFM en imperial.">
        </div>
        <div class="field">
          <label>Chip por diente f<sub>z</sub></label>
          <input id="fz" type="number" step="0.001" placeholder="mm o in" title="Chip por diente. Distancia retirada por filo en mm (o in si está en imperial).">
        </div>
        <div class="field">
          <label>Factor prudencia F</label>
          <input id="prudence" type="number" step="0.01" placeholder="0.7–1.0" value="0.9" title="Factor de prudencia para reducir el avance. 0.7–1.0 (menor = más conservador).">
        </div>
      </div>

      <!-- Geometría opcional -->
      <div class="mt-4 grid md:grid-cols-4 gap-3 items-end">
        <div class="flex items-center gap-2">
          <input id="useGeom" type="checkbox" title="Activar correcciones por geometría como efecto helix y radio de esquina"> <label for="useGeom" class="hint">Usar corrección por geometría</label>
        </div>
        <div class="field">
          <label>Ángulo de hélice (°)</label>
          <input id="helix" type="number" step="0.1" value="30" placeholder="p. ej. 30" title="Ángulo de hélice de la fresa. Afecta el chip thinning y fz efectivo.">
        </div>
        <div class="field">
          <label>Radio de esquina (mm)</label>
          <input id="cornerRad" type="number" step="0.01" value="0" placeholder="p. ej. 0.2" title="Radio de esquina de la herramienta en mm. Afecta corte y fz efectivo.">
        </div>
        <div class="field">
          <label>Holder</label>
          <select id="holder" title="Holder o sujeción. Afecta rigidez y riesgo de vibración."></select>
        </div>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="apply" class="btn" title="Aplica el preset seleccionado al formulario">Aplicar preset</button>
        <button id="calcBtn" class="btn btn-primary" title="Realiza los cálculos y actualiza los resultados">Calcular</button>
        <button id="resetBtn" class="btn" title="Reinicia todos los campos a valores por defecto">Reiniciar</button>
        <button id="pdfBtn" class="btn" title="Genera un PDF con el reporte de condiciones">PDF</button>
      </div>
      <!-- Parámetros de corte adicionales (re-añadir) -->
<div class="mt-3 grid md:grid-cols-3 gap-3 items-end">
  <div class="field">
    <label>Participación radial aₑ (%)</label>
    <input id="aePct" type="number" step="0.1" placeholder="ej. 25" value="" title="Participación radial (aₑ) expresada como % del diámetro.">
  </div>
  <div class="field">
    <label>Profundidad de corte aₚ (mm)</label>
    <input id="ap" type="number" step="0.01" placeholder="ej. 5" value="" title="Profundidad de corte (aₚ) en mm.">
  </div>
  <div class="field">
    <label>Longitud de herramienta / stickout (mm)</label>
    <input id="stickout" type="number" step="1" placeholder="ej. 25" value="" title="Longitud de herramienta sobresaliente (stickout) en mm. Afecta L/D y vibración.">
  </div>
</div>


      <!-- Resultados -->
      <div class="grid md:grid-cols-3 gap-4 mt-6">
        <div class="bg-black/10 rounded-lg p-3">
          <div class="kpi">RPM teórico</div>
          <div class="kpi-value" id="rpmOut" title="RPM calculada en base a Vc y diámetro">—</div>
          <div id="rpmCap" class="text-xs text-amber-300 mt-1 hidden" title="Indica que la RPM fue limitada por el tope de la máquina">Limitado por máquina</div>
        </div>
        <div class="bg-black/10 rounded-lg p-3">
          <div class="kpi">Avance programado</div>
          <div class="kpi-value"><span id="feedOut" title="Avance programado (mm/min o IPM)">—</span> <span id="feedUnit" class="text-slate-400 text-base align-middle" title="Unidad del avance">mm/min</span></div>
          <div class="text-xs" id="feedAdjNote" title="Notas sobre ajustes del avance"></div>
        </div>
        <div class="bg-black/10 rounded-lg p-3">
          <div class="kpi">Resumen</div>
          <div class="text-sm text-slate-300 mt-1" id="sumOut" title="Resumen breve de condiciones">Ingresa datos y calcula.</div>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-4 mt-4">
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">MRR</div><div class="kpi-value"><span id="mrrOut" title="Material Removal Rate (cm³/min)">—</span> <span class="text-slate-400 text-base">cm³/min</span></div></div>
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">Potencia</div><div class="kpi-value"><span id="pwrOut" title="Potencia estimada requerida (kW)">—</span> <span class="text-slate-400 text-base">kW</span></div><div class="text-xs" id="pwrNote" title="Detalle de potencia vs capacidad de máquina"></div></div>
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">Torque</div><div class="kpi-value"><span id="tqOut" title="Torque estimado en N·m">—</span> <span class="text-slate-400 text-base">N·m</span></div></div>
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">Carga husillo</div><div class="kpi-value"><span id="loadOut" title="Porcentaje de carga del husillo respecto a la potencia nominal">—</span> <span class="text-slate-400 text-base">%</span></div></div>
      </div>

      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">Ra estimado</div><div class="kpi-value"><span id="raOut" title="Rugosidad estimada Ra en µm">—</span> <span class="text-slate-400 text-base">µm</span></div></div>
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">f<sub>tp</sub></div><div class="kpi-value"><span id="toothHzOut" title="Frecuencia por diente (Hz)">—</span> <span class="text-slate-400 text-base">Hz</span></div></div>
        <div class="bg-black/10 rounded-lg p-3"><div class="kpi">Vida (Taylor)</div><div class="kpi-value"><span id="lifeOut" title="Vida estimada según la ley de Taylor (min)">—</span> <span class="text-slate-400 text-base">min</span></div></div>
      </div>

      <div id="sweetspot-dual" class="mt-6 bg-slate-800 p-4 rounded-lg border border-slate-700">
        <h3 class="text-sm text-cyan-400">Ajuste fino — RPM / Avance</h3>
        <label class="block text-slate-300 text-sm mb-1">RPM</label>
        <input type="range" id="rpmSlider" min="0.6" max="1.4" step="0.01" value="1" class="w-full" title="Ajuste fino de RPM relativo al valor calculado (60–140%)">
        <div id="rpmLabel" class="text-center mt-1 text-sm text-slate-400" title="Etiqueta del ajuste de RPM">100 % — RPM base</div>
        <label class="block text-slate-300 text-sm mt-3 mb-1">Avance</label>
        <input type="range" id="feedSlider" min="0.6" max="1.4" step="0.01" value="1" class="w-full" title="Ajuste fino del avance relativo al valor calculado (60–140%)">
        <div id="feedLabel" class="text-center mt-1 text-sm text-slate-400" title="Etiqueta del ajuste de avance">100 % — Avance base</div>
        <div id="sweetBarDual" class="h-3 mt-4 rounded-full bg-gradient-to-r from-rose-600 to-emerald-500" title="Barra visual del riesgo relativo"></div>
      </div>

      <div class="vibe-box mt-6">
        <h3 class="font-semibold mb-2">Vibración estimada</h3>
        <div class="text-sm" id="vibeInfo" title="Información sobre los parámetros que se usan para estimar vibración">L/D, a<sub>e</sub> y a<sub>p</sub> se estiman del diámetro, operación y L.</div>
        <div class="canvas-wrap mt-3"><canvas id="vibeChart" title="Gráfica de riesgo de vibración"></canvas></div>
        <p class="text-sm mt-2" id="vibeMsg" title="Mensaje con estado de vibración y recomendaciones"></p>
        <div class="text-xs hint" id="avoidBandNote" title="Banda de frecuencias que conviene evitar"></div>
      </div>
    </section>

    <section class="mt-6">
      <h2 class="text-lg font-semibold mb-3">Entradas relacionadas</h2>
      <div id="refQuick" class="text-slate-400 text-sm"></div>
    </section>

    <!-- PDF template -->
    <template id="pdf-template">
      <div id="pdf-report" style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; width:794px; min-height:1123px; background:#f3f4f6; color:#0f172a; margin:0; padding:0;">
        <div style="background:#0f172a; color:white; padding:12px 16px; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-size:12px; opacity:.8;">Reporte de condiciones</div>
            <div style="font-size:16px; font-weight:700;">Calculadora RPM y Avance — Pro</div>
          </div>
          <div style="text-align:right;">
            <div style="background:rgba(255,255,255,.06); padding:6px 10px; border-radius:999px; font-size:12px;">AlexRaSa — Manufactura CNC</div>
            <div id="rptDate" style="font-size:11px; opacity:.6; margin-top:6px;"></div>
          </div>
        </div>

        <div style="padding:14px 16px;">
          <div style="font-size:11px; color:#4b5563; margin-bottom:8px;">Contexto</div>
          <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px;">
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
              <div style="font-size:11px; color:#6b7280;">Material</div><div id="rptMaterial" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
              <div style="font-size:11px; color:#6b7280;">Operación</div><div id="rptOp" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
              <div style="font-size:11px; color:#6b7280;">Máquina</div><div id="rptMachine" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
              <div style="font-size:11px; color:#6b7280;">Holder</div><div id="rptHolder" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
              <div style="font-size:11px; color:#6b7280;">Tipo herramienta</div><div id="rptToolType" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
              <div style="font-size:11px; color:#6b7280;">Material herramienta</div><div id="rptToolMat" style="font-size:13px; font-weight:600;">—</div>
            </div>
          </div>

          <div style="font-size:11px; color:#4b5563; margin-bottom:8px;">Parámetros calculados</div>
          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:12px;">
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">Diámetro</div><div id="rptDiam" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">RPM</div><div id="rptRPM" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">Avance</div><div id="rptFeed" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">MRR</div><div id="rptMRR" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">Potencia</div><div id="rptPwr" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">Torque</div><div id="rptTq" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">Carga</div><div id="rptLoad" style="font-size:15px;font-weight:700">—</div></div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:8px;"><div style="font-size:11px; color:#6b7280;">Ra</div><div id="rptRa" style="font-size:15px;font-weight:700">—</div></div>
          </div>

          <div style="font-size:11px; color:#4b5563; margin-bottom:8px;">Vibración</div>
          <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <div id="rptVibeState" style="font-size:11px; font-weight:600; background:#e5e7eb; padding:4px 10px; border-radius:999px;">—</div>
              <div style="font-size:11px; color:#6b7280;">Evaluación dinámica por L/D, ae, ap y banda evitada</div>
            </div>
            <div id="rptVibe" style="font-size:12px; color:#111827; line-height:1.4;">—</div>
            <img id="rptVibeImg" alt="Gráfica vibración" style="width:100%;height:120px;object-fit:contain;margin-top:8px;display:block;" src="">
          </div>

          <div style="display:flex; gap:12px;">
            <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:10px; flex:1;">
              <div style="font-size:11px; color:#6b7280; margin-bottom:4px;">Notas</div>
              <div style="font-size:12px; color:#111827;">Ajustar en máquina real según herramienta instalada y sujeción. Generado desde alexrasa.store.</div>
            </div>
            <div style="width:220px; background:white; border:1px solid #e5e7eb; border-radius:8px; padding:10px;">
              <div style="font-size:11px; color:#6b7280; margin-bottom:8px;">Aprobación</div>
              <div style="height:38px; border-bottom:1px solid #e5e7eb;"></div>
              <div style="font-size:10px; color:#6b7280; margin-top:6px;">Firma / fecha</div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px; padding:8px 16px 14px 16px; text-align:right; font-size:10px; color:#9ca3af;">Reporte generado automáticamente · alexrasa.store · Página 1/1</div>
      </div>
    </template>
    <!-- end template -->
  </main>

  <script>
/* Helper DOM & formatos */
const $ = id => document.getElementById(id);
const fmt0 = n => Number.isFinite(n) ? Math.round(n).toLocaleString('es-MX') : '—';
const fmt1 = n => Number.isFinite(n) ? (Math.round(n*10)/10).toLocaleString('es-MX') : '—';
const fmt2 = n => Number.isFinite(n) ? (Math.round(n*100)/100).toLocaleString('es-MX') : '—';

/* DATA inicial */
let DATA = {
  materials: [], holders: [], vibration: {}, defaults: {},
  machine_profiles: [], tool_types: [], tool_materials: [], operations: []
};
let units = 'metric';

/* Carga robusta de cutting-data.json */
async function loadData(){
  try{
    const url = '/data/cutting-data.json';
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok){ console.warn('fetch fallo', r.status, r.statusText); return; }
    const j = await r.json();
    DATA = Object.assign(DATA, j || {});
    DATA.materials = Array.isArray(DATA.materials) ? DATA.materials : [];
    DATA.holders = Array.isArray(DATA.holders) ? DATA.holders : [];
    DATA.machine_profiles = Array.isArray(DATA.machine_profiles) ? DATA.machine_profiles : (DATA.machines_profiles||[]);
    DATA.tool_types = Array.isArray(DATA.tool_types) ? DATA.tool_types : [];
    DATA.tool_materials = Array.isArray(DATA.tool_materials) ? DATA.tool_materials : [];
    DATA.operations = Array.isArray(DATA.operations) ? DATA.operations : [];
    DATA.vibration = DATA.vibration || {};
    DATA.defaults = DATA.defaults || {};
    if(!DATA.machine_profiles.length && Array.isArray(j.machines_profiles)) DATA.machine_profiles = j.machines_profiles;
    window.DATA = DATA;
    console.log('cutting-data.json cargado', DATA.materials.length, 'materials,', DATA.machine_profiles.length, 'machines');
  }catch(e){ console.warn('No se cargó cutting-data.json', e); }
}

/* Relleno selects */
function fillSelectors(){
  const sel = $('material'); if(sel) sel.innerHTML = '';
  (DATA.materials || []).forEach(m => sel?.insertAdjacentHTML('beforeend', `<option value="${m.id}">${m.name}</option>`));

  const ops = (DATA.operations && DATA.operations.length) ? DATA.operations : [
    {id:'rough',label:'Desbaste'},{id:'finish',label:'Acabado'},{id:'adaptive',label:'Trocoidal/Adaptativo'},{id:'slot',label:'Ranurado'},
    {id:'cut',label:'Corte'},{id:'part',label:'Tronzado'},{id:'drill',label:'Barrenado'}
  ];
  const opSel = $('operation'); if(opSel){ opSel.innerHTML=''; ops.forEach(o=>opSel.insertAdjacentHTML('beforeend',`<option value="${o.id}">${o.label}</option>`)); }

  const tSel = $('toolType'); if(tSel){ tSel.innerHTML=''; const ttypes = (DATA.tool_types && DATA.tool_types.length)?DATA.tool_types:[ {id:'endmill',label:'Fresa (Endmill)'},{id:'drill',label:'Broca'},{id:'face_mill',label:'Careador/Planeado'},{id:'slot_saw',label:'Sierra ranuradora'} ]; ttypes.forEach(t => tSel.insertAdjacentHTML('beforeend', `<option value="${t.id}">${t.label}</option>`)); }

  const tmSel = $('toolMat'); if(tmSel){
    tmSel.innerHTML = '';
    const tmats = (DATA.tool_materials && DATA.tool_materials.length) ? DATA.tool_materials : [
      {id:'carbide',label:'Carburo',vc_factor:1,fz_factor:1},
      {id:'hss',label:'Acero rápido (HSS)',vc_factor:0.5,fz_factor:0.85}
    ];
    tmats.forEach(t=>tmSel.insertAdjacentHTML('beforeend',`<option value="${t.id}">${t.label}</option>`));
  }

  const holderSel = $('holder'); if(holderSel){ holderSel.innerHTML=''; (DATA.holders||[]).forEach(h=>holderSel.insertAdjacentHTML('beforeend',`<option value="${h.id}">${h.label}</option>`)); }

  const mach = $('machine'); if(mach){ mach.innerHTML=''; (DATA.machine_profiles||[]).forEach(m=>mach.insertAdjacentHTML('beforeend',`<option value="${m.id}">${m.brand?m.brand+' '+m.model:m.id}</option>`)); }

  if($('rpmLimit')) $('rpmLimit').value = DATA.defaults?.rpm_limit || 12000;
  if($('prudence')) $('prudence').value = DATA.defaults?.prudence || 0.9;
  if($('stickout')) $('stickout').value = DATA.defaults?.stickout_mm || 25;
  if($('ap')) $('ap').value = DATA.defaults?.ap_mm || 5;

  const mat = getMaterial();
  if($('matNotes')) $('matNotes').textContent = mat?.notes || '';
  buildQuickRef(mat);
}

/* getters */
function getMaterial(){ const el = $('material'); const id = el?.value; return (DATA.materials||[]).find(m=>m.id===id); }
function getMachine(){ const id = $('machine')?.value; return (DATA.machine_profiles||[]).find(m=>m.id===id) || {}; }
function getToolType(){ const id = $('toolType')?.value; return (DATA.tool_types||[]).find(t=>t.id===id) || {}; }
function getToolMat(){ const id = $('toolMat')?.value; return (DATA.tool_materials||[]).find(t=>t.id===id) || {vc_factor:1,fz_factor:1}; }
function getHolder(){ const id = $('holder')?.value; return (DATA.holders||[]).find(h=>h.id===id); }

/* unidades */
function setUnits(u){
  units = u;
  $('uMetric')?.classList.toggle('is-on', u==='metric');
  $('uImperial')?.classList.toggle('is-on', u==='imperial');
  if($('feedUnit')) $('feedUnit').textContent = (u==='metric') ? 'mm/min' : 'IPM';
  if($('sumOut')) $('sumOut').textContent = 'Unidad: ' + (u==='metric' ? 'métrico' : 'imperial');
  window.units = units;
}

/* Estimadores */
function estimateVibeParams(Dmm,op){
  const L = Number(parseFloat($('stickout')?.value)) || Math.max(DATA.defaults?.stickout_mm||25, (op==='finish'?2.0:3.0)*Dmm);
  const opDef = (DATA.operations||[]).find(o=>o.id===op);
  const ae_pct = Number.isFinite(opDef?.default_ae_pct) ? opDef.default_ae_pct : (op==='finish'?12:(op==='adaptive'?25:30));
  const ap_mm = Number(parseFloat($('ap')?.value)) || Math.min((op==='finish'?0.2:0.5)*Dmm, Math.max(Dmm, DATA.defaults?.ap_mm||5));
  return { L, ae_pct, ap_mm };
}

/* buckets fz */
function diaBucketFz(mat,Dmm,op){
  if(!mat?.fz_mm) return null;
  const arr = [...mat.fz_mm].sort((a,b)=>a.dia_max_mm - b.dia_max_mm);
  const picked = arr.find(b=>Dmm <= b.dia_max_mm) || arr[arr.length-1];
  const range = picked?.[op] || picked?.[op==='finish'?'finish':'rough'];
  return Array.isArray(range) ? range : null;
}

/* chip thinning */
function chipThinningAdjustedFz(fz_mm, Dmm, ae_pct, helix_deg=30, corner_mm=0){
  const r = Math.max(0.001, Math.min(1.0, ae_pct/100.0));
  const s = Math.sqrt(r * (2.0 - r));
  let k = s > 0 ? 1.0 / s : 1.0;
  k = Math.min(k, 6.0);
  const helix_rad = Math.max(0, Math.min(75, helix_deg)) * Math.PI/180.0;
  let helixFactor = 1.0 / Math.max(1e-6, Math.cos(helix_rad));
  helixFactor = Math.min(helixFactor, 1.6);
  let cornerFactor = 1.0;
  if (corner_mm > 0){
    cornerFactor = 1.0 - Math.min(0.4, corner_mm / Math.max(0.001, 0.5 * Dmm));
    cornerFactor = Math.max(0.6, cornerFactor);
  }
  const fzEff = fz_mm * k * helixFactor * cornerFactor;
  return { fzEff, k, helixFactor, cornerFactor };
}

/* --- chart (canvas) --- (sin tocar mucho) */
/* ---------- CHART (reemplazo seguro) ---------- */
const chart = {
  el: null, ctx: null, xMin: 0, xMax: 2,
  init(){
  this.el = document.getElementById('vibeChart');
  if(!this.el) return;
  this.ctx = this.el.getContext('2d');
  const doResize = () => {
    const dpr = window.devicePixelRatio || 1;
    const wCss = Math.max(320, Math.round(this.el.clientWidth));
    const hCss = Math.max(110, Math.round(this.el.clientHeight));
    this.el.width = Math.max(640, Math.round(wCss * dpr));
    this.el.height = Math.max(220, Math.round(hCss * dpr));
    // ajustar canvas CSS tamaño por si cambia
    this.el.style.width = wCss + 'px';
    this.el.style.height = hCss + 'px';
    // escalar contexto para trabajar en device pixels
    this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    this.draw(0.5, false);
  };
  if(this.el.parentElement) new ResizeObserver(doResize).observe(this.el.parentElement);
  doResize();
},

  pdf(x, mu = 0.75, sigma = 0.2){
    const a = 1 / (sigma * Math.sqrt(2 * Math.PI));
    const e = Math.exp(-0.5 * ((x - mu) / sigma) ** 2);
    return a * e;
  },

  xToPx(x){
    return (x - this.xMin) / (this.xMax - this.xMin) * (this.el.width - 60) + 30;
  },

  yToPx(y){
    const top = 20, bottom = this.el.height - 30;
    return bottom - y * (bottom - top);
  },

  drawBase(){
    const ctx = this.ctx; if(!ctx) return;
    ctx.clearRect(0, 0, this.el.width, this.el.height);

    const segments = [
      { from: 0, to: 0.65, c: 'rgba(34,197,94,0.25)' },
      { from: 0.65, to: 1.0, c: 'rgba(245,158,11,0.25)' },
      { from: 1.0, to: 2.0, c: 'rgba(239,68,68,0.25)' }
    ];

    segments.forEach(s => {
      ctx.beginPath();
      let first = true;
      const step = (this.xMax - this.xMin) / 240;
      for(let x = s.from; x <= s.to + 1e-6; x += step){
        const X = this.xToPx(x), Y = this.yToPx(this.pdf(x));
        if(first){ ctx.moveTo(X, this.yToPx(0)); ctx.lineTo(X, Y); first = false; }
        else ctx.lineTo(X, Y);
      }
      ctx.lineTo(this.xToPx(s.to), this.yToPx(0));
      ctx.closePath();
      ctx.fillStyle = s.c;
      ctx.fill();
    });

    // curva blanca
    ctx.beginPath();
    ctx.lineWidth = 4;
    ctx.strokeStyle = 'rgba(226,232,240,0.9)';
    const step2 = (this.xMax - this.xMin) / 280;
    for(let x = this.xMin; x <= this.xMax; x += step2){
      const X = this.xToPx(x), Y = this.yToPx(this.pdf(x));
      if(x === this.xMin) ctx.moveTo(X, Y); else ctx.lineTo(X, Y);
    }
    ctx.stroke();

    // eje y=0
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = 'rgba(148,163,184,0.5)';
    ctx.beginPath();
    ctx.moveTo(30, this.yToPx(0));
    ctx.lineTo(this.el.width - 30, this.yToPx(0));
    ctx.stroke();

    // líneas divisoras
    [0.65, 1.0].forEach((x, i) => {
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = i ? 'rgba(239,68,68,0.6)' : 'rgba(245,158,11,0.6)';
      ctx.beginPath();
      ctx.moveTo(this.xToPx(x), 20);
      ctx.lineTo(this.xToPx(x), this.el.height - 30);
      ctx.stroke();
    });
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(148,163,184,0.95)';
    ctx.font = '16px system-ui';
    ctx.fillText('Riesgo de vibración', 30, 34);
  },

  drawMarker(risk, inBand = false){
    if(!this.ctx) return;
    const ctx = this.ctx;
    const X = this.xToPx(Math.max(this.xMin, Math.min(this.xMax, risk)));
    let col = 'rgba(34,197,94,1)';
    if(inBand) col = 'rgba(239,68,68,1)';
    else if(risk >= 1.0) col = 'rgba(239,68,68,1)';
    else if(risk >= 0.65) col = 'rgba(245,158,11,1)';

    ctx.lineWidth = 3;
    ctx.strokeStyle = col;
    ctx.beginPath();
    ctx.moveTo(X, 20);
    ctx.lineTo(X, this.el.height - 30);
    ctx.stroke();

    ctx.fillStyle = col;
    ctx.beginPath();
    ctx.arc(X, this.yToPx(this.pdf(risk)), 9, 0, Math.PI * 2);
    ctx.fill();
  },

  draw(risk = 0.5, inBand = false){
    this.drawBase();
    this.drawMarker(risk, inBand);
  }
};

window.chart = chart;
/* ---------- END CHART ---------- */


/* UI helpers */
function buildQuickRef(mat){
  const el = $('refQuick'); if(!el) return;
  if(!mat){ el.textContent=''; return; }
  const ops = mat.vc_m_min || {};
  let html = '<div class="flex flex-wrap gap-2 items-center">';
  html += `<div class="text-xs text-slate-400">Ref. rápida para ${mat.name}:</div>`;
  Object.entries(ops).forEach(([k,v])=>{ if(!Array.isArray(v)) return; html += `<span class="badge">${k}: ${v[0]}–${v[1]} m/min</span>`; });
  html += '</div>';
  el.innerHTML = html;
}

/* aplicar preset */
function applyPreset(){
  const mat = getMaterial() || {};
  const op = $('operation')?.value || 'rough';
  const D = parseFloat($('diam')?.value) || 10; if($('diam')) $('diam').value = D;
  const vcBase = (mat.vc_m_min && (mat.vc_m_min[op] || mat.vc_m_min.rough)) || [100,200];
  const fzBase = diaBucketFz(mat, (units==='metric'?D:(D*25.4)), op) || [0.03,0.08];
  const ttype = getToolType(); const tmat = getToolMat();
  const vcF = (ttype?.vc_factor ?? 1) * (tmat?.vc_factor ?? 1);
  const fzF = (ttype?.fz_factor ?? 1) * (tmat?.fz_factor ?? 1);
  const vcRange = [ Math.round(vcBase[0]*vcF), Math.round(vcBase[1]*vcF) ];
  const fzRange = [ +(fzBase[0]*fzF).toFixed(3), +(fzBase[1]*fzF).toFixed(3) ];
  if(units==='metric'){
    if($('vc')) $('vc').value = Math.round((vcRange[0]+vcRange[1])/2);
    if($('fz')) $('fz').value = ((fzRange[0]+fzRange[1])/2).toFixed(3);
  } else {
    if($('vc')) $('vc').value = Math.round(((vcRange[0]+vcRange[1])/2)*3.281);
    if($('fz')) $('fz').value = (((fzRange[0]+fzRange[1])/2)/25.4).toFixed(3);
  }
  if($('matNotes')) $('matNotes').textContent = mat?.notes || '';
  buildQuickRef(mat);
  const est = estimateVibeParams(((units==='metric')?D:D*25.4), op);
  if($('aePct')) $('aePct').value = Math.round(est.ae_pct);
  if(!$('ap')?.value) if($('ap')) $('ap').value = fmt2(est.ap_mm);
}

/* cálculo principal */
function calc(){
  const D = parseFloat($('diam')?.value);
  const z = parseInt($('flutes')?.value,10);
  let rpmLimit = parseFloat($('rpmLimit')?.value||'0');
  const prud = parseFloat($('prudence')?.value||'1');
  const V = parseFloat($('vc')?.value);
  let FZ = parseFloat($('fz')?.value);
  const op = $('operation')?.value;
  const mat = getMaterial();
  const mach = getMachine();
  if(mach?.rpm_max && !rpmLimit) rpmLimit = mach.rpm_max;

  if(!(D>0 && z>0 && V>0 && FZ>0)){
    if($('rpmOut')) $('rpmOut').textContent='—';
    if($('feedOut')) $('feedOut').textContent='—';
    if($('vibeMsg')) $('vibeMsg').textContent='Faltan datos.';
    chart.draw(0.5);
    return;
  }

  const Dmm = (units==='metric') ? D : D*25.4;
  const Vc_m_min = (units==='metric') ? V : (V/3.281);
  let fz_mm = (units==='metric') ? FZ : FZ*25.4;

  let aePct = Number(parseFloat($('aePct')?.value));
  if(!Number.isFinite(aePct) || aePct<=0){ const est = estimateVibeParams(Dmm,op); aePct = est.ae_pct; }

  const useGeom = $('useGeom')?.checked;
  const helix = parseFloat($('helix')?.value) || 30;
  const corner = parseFloat($('cornerRad')?.value) || 0;

  let fzEff = fz_mm, ctK = 1, helixFactor = 1, cornerFactor = 1;
  if(useGeom){
    const res = chipThinningAdjustedFz(fz_mm, Dmm, aePct, helix, corner);
    fzEff = res.fzEff; ctK = res.k; helixFactor = res.helixFactor; cornerFactor = res.cornerFactor;
  } else {
    const res = chipThinningAdjustedFz(fz_mm, Dmm, aePct, 0, 0);
    fzEff = res.fzEff; ctK = res.k;
  }

  if($('feedAdjNote')) $('feedAdjNote').textContent = (ctK>1?`Chip-thinning ×${fmt2(ctK)} (ae=${Math.round(aePct)}%D)`:'') + (useGeom?` · Helix×${fmt2(helixFactor)} Corner×${fmt2(cornerFactor)}`:'');

  let rpm = (Vc_m_min*1000)/(Math.PI*Dmm);
  let capped = false;
  if(rpmLimit>0 && rpm>rpmLimit){ rpm = rpmLimit; capped = true; }

  let feed_mm_min = rpm*z*fzEff*(Number.isFinite(prud)?prud:1);
  let effFeed = feed_mm_min;
  if(mach?.feed_max_mm_min && feed_mm_min > mach.feed_max_mm_min){
    effFeed = mach.feed_max_mm_min;
    if($('feedAdjNote')) $('feedAdjNote').textContent += ` Cap: ${fmt0(mach.feed_max_mm_min)} ${(units==='metric')?'mm/min':'IPM'}`;
  }

  if($('rpmOut')) $('rpmOut').textContent = fmt0(rpm);
  if($('feedOut')) $('feedOut').textContent = (units==='metric') ? fmt0(effFeed) : fmt1(effFeed/25.4);
  if($('feedUnit')) $('feedUnit').textContent = (units==='metric') ? 'mm/min' : 'IPM';
  if($('rpmCap')) $('rpmCap').classList.toggle('hidden', !capped);
  if($('sumOut')) $('sumOut').textContent = `D=${fmt1(D)} ${(units==='metric')?'mm':'in'}, z=${z}, Vc=${fmt1(V)} ${(units==='metric')?'m/min':'SFM'}, fz=${fmt2(FZ)} ${(units==='metric')?'mm':'in'}.`;

  const ap_input = Number(parseFloat($('ap')?.value));
  const L_input = Number(parseFloat($('stickout')?.value));
  const est = estimateVibeParams(Dmm,op);
  const ae_ratio = Math.max(0.01, Math.min(1, (aePct/100)));
  const ae_mm = ae_ratio * Dmm;
  const ap_mm = Number.isFinite(ap_input) && ap_input>0 ? ap_input : est.ap_mm;
  const L_mm = Number.isFinite(L_input) && L_input>0 ? L_input : est.L;
  if($('vibeInfo')) $('vibeInfo').innerHTML = `Estimado: <code>L=${fmt1(L_mm)} mm</code>, <code>ae≈${Math.round(ae_ratio*100)}% D</code>, <code>ap≈${fmt1(ap_mm)} mm</code>`;

  const MRR_mm3_min = ap_mm * ae_mm * effFeed;
  const MRR_cm3_min = MRR_mm3_min / 1000;
  if($('mrrOut')) $('mrrOut').textContent = fmt1(MRR_cm3_min);

  /* POTENCIA / TORQUE (unificado y con unidades correctas) */
  const Kc = mat?.Kc_N_per_mm2 || 1500;
  const eta = DATA.defaults?.efficiency || 0.8;
  const mrr_mm3_s = MRR_mm3_min / 60; // mm^3/s
  // Kc [N/mm^2] * (mm^3/s) => N·mm/s . Dividir 1000 => N·m/s => W
  const P_W = (Kc * mrr_mm3_s) / 1000 / (eta || 1); // W
  const P_kW = P_W / 1000; // kW
  let T_Nm = NaN;
  if (rpm > 0) T_Nm = (60 * P_W) / (2 * Math.PI * rpm);
  if($('pwrOut')) $('pwrOut').textContent = fmt2(P_kW);
  if($('tqOut')) $('tqOut').textContent = Number.isFinite(T_Nm) ? fmt2(T_Nm) : '—';

  let loadPct = NaN;
  if(mach?.power_kw) loadPct = Math.min(200, 100 * P_kW / mach.power_kw);
  if($('loadOut')) $('loadOut').textContent = Number.isFinite(loadPct) ? fmt1(loadPct) : '—';
  if($('pwrNote')) $('pwrNote').textContent = Number.isFinite(loadPct) ? `${fmt1(P_kW)} kW de ${mach.power_kw||'?' } kW` : '';

  const toothHz = (rpm*z)/60; if($('toothHzOut')) $('toothHzOut').textContent = fmt1(toothHz);
  const band = DATA.vibration?.avoid_band_hz || [600,900];
  if($('avoidBandNote')) $('avoidBandNote').textContent = `Evitar banda ${band[0]}–${band[1]} Hz`;

  const Re = 0.02 * Dmm;
  const Ra_um = (fzEff * fzEff) / (8 * Re) * 1000;
  if($('raOut')) $('raOut').textContent = fmt2(Ra_um);

  let lifeMin = NaN;
  if(mat?.taylor?.n && mat?.taylor?.C){ lifeMin = Math.pow((mat.taylor.C / Vc_m_min), (1/(mat.taylor.n))); }
  if($('lifeOut')) $('lifeOut').textContent = Number.isFinite(lifeMin) ? fmt1(lifeMin) : '—';

  /* VIBRACIÓN */
  const holder = getHolder();
  const W = DATA.vibration?.weights || { ld:0.55, ae:0.20, ap:0.15, fz:0.10 };
  const stiff = holder?.stiffness_factor || 1.0;
  const L_over_D = L_mm / Dmm;
  const ap_ratio = Math.min(1.2, ap_mm / Math.max(1, Dmm));
  let risk = (W.ld*(L_over_D/2.0) + W.ae*ae_ratio + W.ap*ap_ratio + W.fz*Math.min(1, (fzEff/(0.1*Dmm+0.02)))) / stiff;
  risk = Math.max(0, Math.min(2, risk));
  const inBand = (toothHz >= band[0] && toothHz <= band[1]);
  const SWEET = 0.65, WARN = 1.00;
  let state = 'ok'; if(risk >= WARN || inBand) state='bad'; else if(risk >= SWEET) state='warn';
  const vb = document.querySelector('.vibe-box'); if(vb){ vb.classList.remove('ok','warn','bad'); vb.classList.add(state); }
  const badge = `<span class="badge ${state}">${state==='ok'?'Sweet spot':state==='warn'?'Atento':'Vibra'}</span>`;
  let msg = `${badge} · L/D=${fmt2(L_over_D)} · f<sub>tp</sub>=${fmt1(toothHz)} Hz · riesgo=${fmt2(risk)}.`;
  if(state==='bad' && inBand){
    const shift = DATA.vibration?.rpm_shift_pct || 0.12;
    const targetHz = (Math.abs(toothHz - band[0]) < Math.abs(toothHz - band[1])) ? band[0] : band[1];
    let rpmAlt = (targetHz * 60) / z; rpmAlt *= (toothHz < targetHz ? (1+shift) : (1-shift));
    if(rpmLimit>0 && rpmAlt > rpmLimit) rpmAlt = rpmLimit;
    const feedAlt = rpmAlt * z * fzEff * (Number.isFinite(prud)?prud:1);
    msg += ` Sugerido: ${fmt0(rpmAlt)} RPM y ${(units==='metric')?`${fmt0(feedAlt)} mm/min`:`${fmt1(feedAlt/25.4)} IPM`}.`;
  }
  if($('vibeMsg')) $('vibeMsg').innerHTML = msg;

  window.feed = effFeed; window.rpm = rpm; window.rpmLimit = rpmLimit;
  chart.draw(risk, inBand);
}

/* recalc cuando mueves sliders */
function recalc(){
  if(!(window.rpm>0 && window.feed>0)) return;
  const rpmScale = parseFloat(($('rpmSlider')||{value:1}).value||'1');
  const feedScale = parseFloat(($('feedSlider')||{value:1}).value||'1');
  const D = parseFloat($('diam')?.value);
  const z = parseInt($('flutes')?.value,10);
  const mat = getMaterial();
  const mach = getMachine();
  const unitsLocal = window.units||'metric';
  const rpmLimit = window.rpmLimit||parseFloat($('rpmLimit')?.value)||mach?.rpm_max||12000;
  const rpmAdj = Math.min(window.rpm * rpmScale, rpmLimit);
  const feedAdj = window.feed * feedScale;
  let effFeed = feedAdj;
  if(feedScale >= 1) effFeed = (mach?.feed_max_mm_min && feedAdj > mach.feed_max_mm_min) ? mach.feed_max_mm_min : feedAdj;
  if($('rpmOut')) $('rpmOut').textContent = fmt0(rpmAdj);
  if($('feedOut')) $('feedOut').textContent = (unitsLocal==='metric') ? fmt0(effFeed) : fmt1(effFeed/25.4);
  if($('rpmCap')) $('rpmCap').classList.toggle('hidden', !(rpmAdj >= rpmLimit-1));
  const aePct = parseFloat($('aePct')?.value) || 30;
  const ap = parseFloat($('ap')?.value) || 5;
  const L = parseFloat($('stickout')?.value) || 25;
  const Dmm = (unitsLocal==='metric')?D:D*25.4;
  const ae = (aePct/100) * Dmm;
  const Kc = mat?.Kc_N_per_mm2 || 1500;
  const eta = DATA.defaults?.efficiency || 0.8;
  const MRR_mm3_min = ae * ap * effFeed;
  if($('mrrOut')) $('mrrOut').textContent = fmt1(MRR_mm3_min/1000);
  const mrr_mm3_s = MRR_mm3_min / 60;
  const P_W = (Kc * mrr_mm3_s) / 1000 / (eta || 1);
  const P_kW = P_W / 1000;
  let T_Nm = NaN;
  if (rpmAdj > 0) T_Nm = (60 * P_W) / (2 * Math.PI * rpmAdj);
  if($('pwrOut')) $('pwrOut').textContent = fmt2(P_kW);
  if($('tqOut')) $('tqOut').textContent = Number.isFinite(T_Nm) ? fmt2(T_Nm) : '—';
  let loadPct = NaN;
  if(mach?.power_kw) loadPct = Math.min(200, 100 * P_kW / mach.power_kw);
  if($('loadOut')) $('loadOut').textContent = Number.isFinite(loadPct)?fmt1(loadPct):'—';
  if($('pwrNote')) $('pwrNote').textContent = Number.isFinite(loadPct)?`${fmt1(P_kW)} kW de ${mach.power_kw||'?'} kW` : '';
  const toothHz = (rpmAdj*z)/60; if($('toothHzOut')) $('toothHzOut').textContent = fmt1(toothHz);
  const band = DATA.vibration?.avoid_band_hz || [600,900];
  if($('avoidBandNote')) $('avoidBandNote').textContent = `Evitar banda ${band[0]}–${band[1]} Hz`;
  const fz_mm = effFeed / (rpmAdj*z);
  const Re = 0.02 * Dmm;
  const Ra_um = (fz_mm * fz_mm) / (8 * Re) * 1000;
  if($('raOut')) $('raOut').textContent = fmt2(Ra_um);
  const Vc_m_min = (Math.PI * Dmm * rpmAdj) / 1000;
  let lifeMin = NaN;
  if(mat?.taylor?.n && mat?.taylor?.C) lifeMin = Math.pow((mat.taylor.C / Vc_m_min),(1/(mat.taylor.n)));
  const holder = getHolder();
  const W = DATA.vibration?.weights || {ld:0.55,ae:0.20,ap:0.15,fz:0.10};
  const stiff = holder?.stiffness_factor || 1.0;
  const L_over_D = L / Dmm;
  const ap_ratio = Math.min(1.2, ap / Math.max(1, Dmm));
  let risk = (W.ld*(L_over_D/2.0) + W.ae*(aePct/100) + W.ap*ap_ratio + W.fz*Math.min(1,(fz_mm/(0.1*Dmm+0.02))))/stiff;
  const inBand = (toothHz >= band[0] && toothHz <= band[1]);
  if(inBand) risk = Math.min(2, risk + 0.3);
  risk = Math.max(0, Math.min(2, risk));
  if(Number.isFinite(lifeMin)) lifeMin *= (1 - (risk*0.4));
  if($('lifeOut')) $('lifeOut').textContent = Number.isFinite(lifeMin)?fmt1(lifeMin):'—';
  const SWEET = 0.65, WARN = 1.00;
  let state = 'ok';
  if(risk >= WARN || inBand) state='bad';
  else if(risk >= SWEET) state='warn';
  const vb = document.querySelector('.vibe-box'); if(vb){ vb.classList.remove('ok','warn','bad'); vb.classList.add(state); }
  const badge = `<span class="badge ${state}">${state==='ok'?'Sweet spot':state==='warn'?'Atento':'Vibra'}</span>`;
  if($('vibeMsg')) $('vibeMsg').innerHTML = `${badge} · L/D=${fmt2(L_over_D)} · f<sub>tp</sub>=${fmt1(toothHz)} Hz · riesgo=${fmt2(risk)}.`;  
  const bar = $('sweetBarDual');
  let color = "from-rose-600 to-rose-700";
  if(risk < 0.65) color = "from-emerald-500 to-emerald-600";
  else if(risk < 1.0) color = "from-yellow-400 to-yellow-500";
  if(bar) bar.className = `h-3 mt-4 rounded-full bg-gradient-to-r ${color}`;
  if($('rpmLabel')) $('rpmLabel').textContent = `${Math.round(rpmScale*100)} % — RPM`;
  if($('feedLabel')) $('feedLabel').textContent = `${Math.round(feedScale*100)} % — Avance`;
  chart.draw(risk, inBand);
}

/* reset */
function resetAll(){
  if($('diam')) $('diam').value='';
  if($('flutes')) $('flutes').value=3;
  if($('rpmLimit')) $('rpmLimit').value = DATA.defaults?.rpm_limit || 12000;
  if($('vc')) $('vc').value=''; if($('fz')) $('fz').value=''; if($('prudence')) $('prudence').value = DATA.defaults?.prudence || 0.9;
  if($('aePct')) $('aePct').value=''; if($('ap')) $('ap').value=DATA.defaults?.ap_mm || 5; if($('stickout')) $('stickout').value = DATA.defaults?.stickout_mm || 25;
  if($('helix')) $('helix').value='30'; if($('cornerRad')) $('cornerRad').value='0'; if($('useGeom')) $('useGeom').checked=false;
  applyPreset(); chart.draw(0.5);
  if($('sumOut')) $('sumOut').textContent='Ingresa datos y calcula.';
  ['mrrOut','pwrOut','tqOut','loadOut','raOut','toothHzOut','lifeOut'].forEach(id=>{ if($(id)) $(id).textContent='—'; });
  if($('vibeMsg')) $('vibeMsg').textContent=''; if($('vibeInfo')) $('vibeInfo').textContent='L/D, aₑ y aₚ se estiman del diámetro, operación y L.';
}

/* PDF population (igual que antes) */
function populatePdfClone(root){
  const q = (sel)=>root.querySelector(sel);
  const matSel = $('material'), opSel = $('operation'), toolSel = $('toolType'),
        toolMatSel = $('toolMat'), machSel = $('machine'), holderSel = $('holder');

  if(q('#rptMaterial')) q('#rptMaterial').textContent = matSel?.options[matSel.selectedIndex]?.text || '—';
  if(q('#rptOp')) q('#rptOp').textContent = opSel?.options[opSel.selectedIndex]?.text || '—';
  if(q('#rptToolType')) q('#rptToolType').textContent = toolSel?.options[toolSel.selectedIndex]?.text || '—';
  if(q('#rptToolMat')) q('#rptToolMat').textContent = toolMatSel?.options[toolMatSel.selectedIndex]?.text || '—';
  if(q('#rptMachine')) q('#rptMachine').textContent = machSel?.options[machSel.selectedIndex]?.text || '—';
  if(q('#rptHolder')) q('#rptHolder').textContent = holderSel?.options[holderSel.selectedIndex]?.text || '—';

  if(q('#rptDiam')) q('#rptDiam').textContent = ($('diam')?.value||'—') + (units==='metric'?' mm':' in');
  if(q('#rptRPM')) q('#rptRPM').textContent = ($('rpmOut')?.textContent||'—') + ' rpm';
  if(q('#rptFeed')) q('#rptFeed').textContent = ($('feedOut')?.textContent||'—') + ' ' + ($('feedUnit')?.textContent||'');
  if(q('#rptMRR')) q('#rptMRR').textContent = ($('mrrOut')?.textContent||'—') + ' cm³/min';
  if(q('#rptPwr')) q('#rptPwr').textContent = ($('pwrOut')?.textContent||'—') + ' kW';
  if(q('#rptTq')) q('#rptTq').textContent = ($('tqOut')?.textContent||'—') + ' N·m';
  if(q('#rptLoad')) q('#rptLoad').textContent = ($('loadOut')?.textContent||'—') + ' %';
  if(q('#rptRa')) q('#rptRa').textContent = ($('raOut')?.textContent||'—') + ' µm';

  const vibeBox = document.querySelector('.vibe-box');
  let state = '—';
  if(vibeBox?.classList.contains('ok')) state='Sweet spot';
  else if(vibeBox?.classList.contains('warn')) state='Atento';
  else if(vibeBox?.classList.contains('bad')) state='Vibra';
  if(q('#rptVibeState')) q('#rptVibeState').textContent = state;

  const raw = $('vibeMsg')?.innerHTML.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
  if(q('#rptVibe')) q('#rptVibe').textContent = raw || '—';

  try{
    const imgEl = q('#rptVibeImg');
    if(imgEl && window.chart && window.chart.el) imgEl.src = window.chart.el.toDataURL('image/png');
  }catch(e){ console.warn('No se pudo volcar gráfica al PDF', e); }

  if(q('#rptDate')) q('#rptDate').textContent = new Date().toLocaleString('es-MX');
}

/* descargar pdf (igual que antes) */
async function downloadPdf(){
  const tpl = document.getElementById('pdf-template');
  if(!tpl){ alert('No se encontró #pdf-template'); return; }
  const cloneEl = tpl.content.firstElementChild.cloneNode(true);
  cloneEl.style.position = 'fixed'; cloneEl.style.left = '-9999px'; cloneEl.style.top = '0'; cloneEl.style.display = 'block';
  document.body.appendChild(cloneEl);
  try{
    populatePdfClone(cloneEl);
    if (document.fonts && document.fonts.ready) await document.fonts.ready;
    const imgs = Array.from(cloneEl.querySelectorAll('img'));
    await Promise.all(imgs.map(img => new Promise(res => {
      if (!img) return res(); if (img.complete) return res(); img.onload = img.onerror = res; setTimeout(res, 3000);
    })));
    await new Promise(r=>setTimeout(r,120));
    const canvas = await html2canvas(cloneEl, { scale: 2, useCORS: true, backgroundColor: '#ffffff', width: cloneEl.scrollWidth, height: cloneEl.scrollHeight, windowWidth: cloneEl.scrollWidth, windowHeight: cloneEl.scrollHeight });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
    const pageWidth = doc.internal.pageSize.getWidth(), pageHeight = doc.internal.pageSize.getHeight(), margin = 20;
    let imgWidth = pageWidth - margin * 2;
    let imgHeight = (canvas.height * imgWidth) / canvas.width;
    if (imgHeight > pageHeight - margin * 2) { imgHeight = pageHeight - margin * 2; imgWidth = (canvas.width * imgHeight) / canvas.height; }
    const x = (pageWidth - imgWidth) / 2, y = (pageHeight - imgHeight) / 2;
    doc.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
    doc.save('reporte-condiciones-maquinado.pdf');
  }catch(e){ console.error('Error generando PDF', e); alert('Ocurrió un error generando el PDF. Revisa la consola.'); }
  finally{ cloneEl.remove(); }
}

/* INIT */
(async function(){
  await loadData();
  fillSelectors();
  buildQuickRef(getMaterial());
  $('uMetric')?.addEventListener('click',()=>{ setUnits('metric'); applyPreset(); });
  $('uImperial')?.addEventListener('click',()=>{ setUnits('imperial'); applyPreset(); });
  $('apply')?.addEventListener('click',applyPreset);
  $('calcBtn')?.addEventListener('click',()=>{ calc(); recalc(); });
  $('resetBtn')?.addEventListener('click',()=>{ resetAll(); recalc(); });
  $('pdfBtn')?.addEventListener('click',downloadPdf);
  ['material','operation','toolType','toolMat','holder','machine'].forEach(id=>{
    const el = $(id); if(el) el.addEventListener('change', ()=>{ applyPreset(); calc(); recalc(); });
  });
  $('useGeom')?.addEventListener('change', (e)=>{ const on = e.target.checked; if($('helix')) $('helix').disabled = !on; if($('cornerRad')) $('cornerRad').disabled = !on; });
  setUnits('metric');
  applyPreset();
  /* --- Drag marker: arrastrar campana y obtener condiciones --- */
chart._dragging = false;
chart._dragX = null;

function pxToChartX(px){
  if(!chart || !chart.el) return 0.5;
  const rect = chart.el.getBoundingClientRect(); // css pixels
  const dpr = window.devicePixelRatio || 1; // device / css
  // padding en device pixels es 30 original. Convertimos a css px:
  const padCss = 30 / dpr;
  const leftCss = padCss;
  const rightCss = rect.width - padCss;
  const clamped = Math.max(leftCss, Math.min(rightCss, px));
  const rel = (clamped - leftCss) / Math.max(1e-6, (rightCss - leftCss));
  return chart.xMin + rel * (chart.xMax - chart.xMin);
}

function chartXToTargetHz(xVal){
  // mapea el eje x (0..chart.xMax) a una banda de frecuencias útil.
  // Ajusta factor si quieres más rango. Actualmente usa 2x banda superior.
  const band = DATA.vibration?.avoid_band_hz || [600,900];
  const maxHz = Math.max(200, band[1] * 2);
  const targetHz = Math.round( (xVal / chart.xMax) * maxHz );
  return Math.max(1, targetHz);
}

function applyDragToConditions(xVal){
  const z = parseInt($('flutes')?.value || 3,10);
  const fzInput = parseFloat($('fz')?.value) || 0.05;
  const prud = parseFloat($('prudence')?.value) || 0.9;
  const unitsLocal = window.units || 'metric';
  const D = parseFloat($('diam')?.value) || 10;
  const Dmm = unitsLocal==='metric' ? D : D*25.4;
  // recalcula fz_eff con chip thinning si corresponde
  const useGeom = $('useGeom')?.checked;
  const helix = parseFloat($('helix')?.value) || 30;
  const corner = parseFloat($('cornerRad')?.value) || 0;
  const res = chipThinningAdjustedFz( unitsLocal==='metric'?fzInput:(fzInput*25.4), Dmm, Number(parseFloat($('aePct')?.value)||30), helix, corner );
  const fzEff = res.fzEff;

  const targetHz = chartXToTargetHz(xVal);
  let rpmAlt = Math.round((targetHz * 60) / z);
  const rpmLimitVal = window.rpmLimit || parseFloat($('rpmLimit')?.value) || getMachine()?.rpm_max || 12000;
  if(rpmLimitVal && rpmAlt > rpmLimitVal) rpmAlt = rpmLimitVal;

  const feedAlt = Math.round(rpmAlt * z * fzEff * (Number.isFinite(prud)?prud:1));

  // Mostrar sugerencia en UI (temporal)
  const inBand = (targetHz >= (DATA.vibration?.avoid_band_hz?.[0]||600) && targetHz <= (DATA.vibration?.avoid_band_hz?.[1]||900));
  const hint = `Desde campana → fₜg=${targetHz} Hz · Sugerido: ${rpmAlt} RPM · ${unitsLocal==='metric' ? feedAlt+' mm/min' : ( (feedAlt/25.4).toFixed(2)+' IPM') }${ inBand ? ' · Atención: en banda evitada' : '' }`;
  if($('vibeMsg')) $('vibeMsg').textContent = hint;
  if($('rpmOut')) $('rpmOut').textContent = fmt0(rpmAlt);
  if($('feedOut')) $('feedOut').textContent = unitsLocal==='metric' ? fmt0(feedAlt) : fmt1(feedAlt/25.4);

  // redibuja marcador donde el usuario lo dejó (fuerza inBand para color)
  chart.draw(xVal, inBand);
  // commit selección para que recalc() la use
window.rpm = rpmAlt;
window.feed = feedAlt;
recalc();
}

/* eventos pointer para arrastrar */
function onPointerDown(e){
  if(!chart.el) return;
  chart._dragging = true;
  chart.el.setPointerCapture && chart.el.setPointerCapture(e.pointerId);
  const rect = chart.el.getBoundingClientRect();
  const px = e.clientX - rect.left;
  chart._dragX = px;
  const xVal = pxToChartX(px);
  applyDragToConditions(xVal);
  e.preventDefault();
}

let _rafPending = false;
function onPointerMove(e){
  if(!chart._dragging || !chart.el) return;
  const rect = chart.el.getBoundingClientRect();
  const px = e.clientX - rect.left;
  chart._dragX = px;
  if(_rafPending) return;
  _rafPending = true;
  requestAnimationFrame(()=>{ 
    const xVal = pxToChartX(chart._dragX);
    applyDragToConditions(xVal);
    _rafPending = false;
  });
  e.preventDefault();
}

function onPointerUp(e){
  if(!chart._dragging) return;
  chart._dragging = false;
  try{ chart.el.releasePointerCapture && chart.el.releasePointerCapture(e.pointerId); }catch(e){}
  chart._dragX = null;
}



  chart.init(); chart.draw(0.5);
  // attach listeners después de init
if(chart && chart.el){
  chart.el.style.cursor = 'ew-resize';
  // evita gestos de scroll al arrastrar
  chart.el.style.touchAction = 'none';

  chart.el.addEventListener('pointerdown', onPointerDown, {passive:false});
  window.addEventListener('pointermove', onPointerMove, {passive:false});
  window.addEventListener('pointerup', onPointerUp, {passive:false});
  // soporte para cancel pointer (por ejemplo al perder foco)
  chart.el.addEventListener('pointercancel', onPointerUp, {passive:false});
}

  calc(); recalc();
  try{ loadRelated(); }catch(e){}
  $('rpmSlider')?.addEventListener('input',recalc);
  $('feedSlider')?.addEventListener('input',recalc);
})();

/* related posts (mínimo) */
async function loadRelated(){ try{ const r = await fetch('/api/list-posts',{cache:'no-store'}); if(!r.ok) return; const j = await r.json(); renderRel((j.items||[]).slice(0,3)); }catch(e){} }
function renderRel(items){ const GRID=$('relGrid'),EMPTY=$('relEmpty'); if(!items||!items.length){ if(EMPTY) EMPTY.classList.remove('hidden'); return;} if(EMPTY) EMPTY.classList.add('hidden'); if(GRID) GRID.innerHTML=''; items.forEach(p=>{ const url = p.url?.startsWith('http')||p.url?.startsWith('/')?p.url:`/blog/${p.url}`; const img = p.image||'/assets/blog/placeholder.jpg'; const el=document.createElement('article'); el.className='card overflow-hidden'; el.innerHTML=`<a href="${url}" class="block"><img src="${img}" class="w-full aspect-[1200/630] object-cover bg-slate-800" alt=""></a><div class="p-3"><a href="${url}"><h3 class="text-base font-semibold">${p.title||'Post'}</h3></a><p class="text-sm text-slate-400">${(p.description||'').slice(0,120)}</p></div>`; GRID.appendChild(el); }); }
</script>


</body>
</html>
