<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora RPM & Avance — AlexRaSa (Extendida)</title>
  <meta name="description" content="Calculadora extendida: RPM, avance, MRR, potencia, vida de herramienta, coste por pieza, deflexión, estabilidad y comparador A vs P." />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas + jsPDF para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#0b1220;--card:#0f172a;--ink:#e6eef8;--muted:#9fb3c8;--accent:#0ea5e9}
    body{background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    .sidebar{width:380px;min-width:300px}
    .main{flex:1}
    .muted{color:var(--muted)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:1rem;border-radius:0.6rem}
    .small{font-size:0.85rem}
    .section-title{font-weight:700;color:var(--accent)}
    .result-value{font-weight:700;font-size:1.05rem}
    .toggle{appearance:none;width:44px;height:24px;background:#111827;border-radius:999px;position:relative;cursor:pointer}
    .toggle:checked{background:var(--accent)}
    .toggle:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:all .18s}
    .toggle:checked:before{transform:translateX(20px)}
  </style>
</head>
<body class="p-4">
  <div class="flex gap-4">
    <div class="main">
      <div class="card mb-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-xl font-bold">Calculadora RPM & Avance — Extendida</h1>
            <div class="muted small">Secciones activables. Usa presets o llena manualmente.</div>
          </div>
          <div class="text-right small muted">Archivo: <span class="font-mono">calculadora-rpm-extendida.html</span></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="card">
          <div class="section-title">Entradas — Parámetros principales</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Diámetro herramienta D (mm)</label>
            <input id="diam" type="number" step="0.01" value="12" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Dientes / cortantes (z)</label>
            <input id="z" type="number" step="1" value="4" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Velocidad de corte Vc (m/min)</label>
            <input id="vc" type="number" step="0.1" value="180" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Avance por diente fz (mm/tooth)</label>
            <input id="fz" type="number" step="0.0001" value="0.06" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="small muted">Ae (mm) ancho de corte</label>
                <input id="ae" type="number" step="0.01" value="10" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              </div>
              <div>
                <label class="small muted">Ap (mm) profundidad</label>
                <input id="ap" type="number" step="0.01" value="2" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              </div>
            </div>

            <label class="small muted">Ángulo de entrada (°) (chip-thinning)</label>
            <input id="entryAngle" type="number" step="0.1" value="90" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

          </div>
        </div>

        <div class="card">
          <div class="section-title">Costos y producción</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Costo hora máquina (MXN)</label>
            <input id="machineCost" type="number" step="0.1" value="400" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Costo herramienta (MXN)</label>
            <input id="toolCost" type="number" step="0.1" value="1200" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Volumen a remover por pieza (cm³)</label>
            <input id="volumen" type="number" step="0.01" value="18" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Producción objetivo (piezas/hora)</label>
            <input id="prodRate" type="number" step="0.1" value="30" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

          </div>
        </div>

        <div class="card">
          <div class="section-title">Parámetros de herramienta / vida</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Constante Taylor C (m/min * min^n)</label>
            <input id="C" type="number" step="1" value="40000" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">Exponente n (Taylor)</label>
            <input id="n" type="number" step="0.01" value="0.25" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
          </div>
        </div>

        <div class="card">
          <div class="section-title">Datos Kc & material</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Kc0 (N/mm²) — referencia</label>
            <input id="Kc0" type="number" step="1" value="2000" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">Exponente m (chip thickness)</label>
            <input id="mexp" type="number" step="0.01" value="0.2" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">E (Young modulus GPa)</label>
            <input id="E" type="number" step="1" value="210" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">Stickout L (mm)</label>
            <input id="L" type="number" step="1" value="60" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
          </div>
        </div>

      </div>

      <div class="mt-4 card">
        <div class="flex items-center justify-between">
          <div class="section-title">Opciones — habilitar cálculos</div>
          <div class="small muted">Activa para ver más resultados</div>
        </div>
        <div class="mt-3 grid grid-cols-3 gap-3">
          <label class="flex items-center gap-2"><input id="enableCycle" type="checkbox" class="toggle" checked /> <span class="small">Tiempo & Coste</span></label>
          <label class="flex items-center gap-2"><input id="enableToolLife" type="checkbox" class="toggle" checked /> <span class="small">Vida herramienta</span></label>
          <label class="flex items-center gap-2"><input id="enableKc" type="checkbox" class="toggle" checked /> <span class="small">Kc(h) & Potencia</span></label>
          <label class="flex items-center gap-2"><input id="enableDeflection" type="checkbox" class="toggle" /> <span class="small">Deflexión</span></label>
          <label class="flex items-center gap-2"><input id="enableStability" type="checkbox" class="toggle" /> <span class="small">Estabilidad (f_n)</span></label>
          <label class="flex items-center gap-2"><input id="enableCompare" type="checkbox" class="toggle" /> <span class="small">Comparador A vs P</span></label>
        </div>
      </div>

      <div class="mt-4 card">
        <div class="flex items-center justify-between">
          <div class="section-title">Comparador A vs P (si activado)</div>
          <div class="small muted">Introduce un segundo escenario y presiona "Comparar"</div>
        </div>
        <div class="mt-3 grid grid-cols-4 gap-2">
          <input id="vcB" type="number" step="0.1" value="120" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="Vc B" />
          <input id="fzB" type="number" step="0.0001" value="0.04" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="fz B" />
          <input id="aeB" type="number" step="0.01" value="8" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="ae B" />
          <input id="apB" type="number" step="0.01" value="1" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="ap B" />
        </div>
        <div class="mt-3">
          <button id="btnCompare" class="px-4 py-2 bg-accent text-black rounded font-bold">Comparar</button>
        </div>
      </div>

    </div>

    <aside class="sidebar card">
      <div class="flex items-center justify-between mb-2">
        <div class="section-title">Resultados</div>
        <div class="small muted">Panel derecho — exportable</div>
      </div>

      <div id="results" class="space-y-3 small">
        <!-- Results injected here -->
      </div>

      <div class="mt-3">
        <button id="btnExportPdf" class="w-full px-4 py-2 rounded bg-[#10b981] text-black font-bold">Exportar PDF</button>
        <button id="btnExportCsv" class="w-full mt-2 px-4 py-2 rounded bg-[#0ea5e9] text-black font-bold">Exportar CSV</button>
      </div>

      <div class="mt-4 card">
        <div class="section-title">Gráficos</div>
        <canvas id="chartMRR" height="160"></canvas>
      </div>

      <div class="mt-3 card">
        <div class="section-title">Tabla comparativa</div>
        <div class="mt-2 overflow-auto" style="max-height:200px">
          <table id="tableCompare" class="w-full text-left small">
            <thead><tr><th class="muted">Métrica</th><th class="muted">A</th><th class="muted">B</th><th class="muted">Δ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </aside>
  </div>

  <script>
    // Helpers
    const $ = id => document.getElementById(id);
    function fmt(n,dec=2){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec}); }

    function computeAll(useB=false){
      // Read inputs A
      const D = parseFloat($('diam').value) || 0.001; // mm
      const z = parseInt($('z').value) || 1;
      const vc = parseFloat($('vc').value) || 0.1; // m/min
      const fz = parseFloat($('fz').value) || 0.0001; // mm
      const ae = parseFloat($('ae').value) || 0.1; // mm
      const ap = parseFloat($('ap').value) || 0.1; // mm
      const entryAngle = parseFloat($('entryAngle').value)||90; // deg

      const machineCost = parseFloat($('machineCost').value) || 0;
      const toolCost = parseFloat($('toolCost').value) || 0;
      const volumen = parseFloat($('volumen').value) || 0; // cm3
      const prodRate = parseFloat($('prodRate').value) || 1; // p/h

      const C = parseFloat($('C').value) || 1;
      const n = parseFloat($('n').value) || 0.25;

      const Kc0 = parseFloat($('Kc0').value) || 2000; // N/mm^2
      const mexp = parseFloat($('mexp').value) || 0.2;
      const E = (parseFloat($('E').value)||210) * 1e3; // GPa -> MPa -> N/mm2? convert to N/mm2: 210000 N/mm2? We'll keep units consistent approx
      const L = parseFloat($('L').value)||60; // mm

      // Basic conversions
      const rpm = (vc*1000)/(Math.PI*D); // rpm, D in mm, vc m/min
      const feed_mm_min = rpm * z * fz; // mm/min
      const mrr_mm3_min = feed_mm_min * ae * ap; // mm3/min
      const mrr_cm3_min = mrr_mm3_min / 1000; // cm3/min

      // chip thickness approx: fz * sin(entryAngle)
      const entryRad = entryAngle * Math.PI/180;
      const chip_h = fz * Math.abs(Math.sin(entryRad));
      // Kc as function of h
      const Kc_h = Kc0 * Math.pow(chip_h + 1e-6, -mexp); // avoid div0

      // Power estimation (approx). Efficiency
      const eta = 0.7;
      // P [kW] = (Kc_h [N/mm2] * mrr_mm3_min [mm3/min]) / (60*1000) / eta
      const power_kW = (Kc_h * mrr_mm3_min) / (60*1000) / eta;

      // Time & costs
      const time_min = volumen / Math.max(mrr_cm3_min, 1e-9);
      const time_h = time_min/60;
      const cost_machine = time_h * machineCost;

      // Tool life (Taylor) using Vc (m/min). Taylor T = C / Vc^n (min)
      const life_min = C / Math.pow(Math.max(vc,1e-6), n);
      const pieces_per_tool = Math.max(Math.floor(life_min / Math.max(time_min,1e-9)),1);
      const tool_cost_per_piece = toolCost / pieces_per_tool;
      const cost_per_piece = cost_machine + tool_cost_per_piece;

      // Deflection approximate
      // moment of inertia I for circular shank: pi*d^4/64. use diameter D as shaft proxy mm^4
      const I = Math.PI * Math.pow(D,4) / 64;
      // approximate cutting force F_radial ~ Kc_h * Ae(mm^2) * some scale
      const F_radial = Kc_h * ae * ap * 0.001; // scaled to avoid huge numbers
      const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9);

      // stiffness & natural freq approx
      const k_eff = (3 * E * I) / Math.pow(L,3);
      const m_eff = 0.02; // kg, approximation of tool + holder effective mass
      const f_n = (1/(2*Math.PI))*Math.sqrt(Math.abs(k_eff / (m_eff*1000))); // convert units approx -> Hz

      // tooth frequency
      const toothHz = rpm/60 * z;

      // Pack A
      const A = {
        rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, power_kW, time_min, cost_machine, life_min, pieces_per_tool, tool_cost_per_piece, cost_per_piece, delta_mm, f_n, toothHz, F_radial
      };

      // If we need B scenario
      let B = null;
      if(useB){
        const vcB = parseFloat($('vcB').value)||vc;
        const fzB = parseFloat($('fzB').value)||fz;
        const aeB = parseFloat($('aeB').value)||ae;
        const apB = parseFloat($('apB').value)||ap;
        const rpmB = (vcB*1000)/(Math.PI*D);
        const feedB = rpmB * z * fzB;
        const mrrB = feedB * aeB * apB / 1000;
        const chip_hB = fzB * Math.abs(Math.sin(entryRad));
        const Kc_hB = Kc0 * Math.pow(chip_hB + 1e-6, -mexp);
        const powerB = (Kc_hB * feedB * aeB * apB) / (60*1000) / eta;
        const time_minB = volumen / Math.max(mrrB,1e-9);
        const lifeB = C / Math.pow(Math.max(vcB,1e-6), n);
        const pieces_per_toolB = Math.max(Math.floor(lifeB / Math.max(time_minB,1e-9)),1);
        const cost_machineB = (time_minB/60) * machineCost;
        const cost_per_pieceB = cost_machineB + (toolCost / pieces_per_toolB);
        B = {rpm:rpmB, feed_mm_min:feedB, mrr_cm3_min:mrrB, chip_h:chip_hB, Kc_h:Kc_hB, power_kW:powerB, time_min:time_minB, life_min:lifeB, pieces_per_tool:pieces_per_toolB, cost_per_piece:cost_per_pieceB};
      }

      return {A,B};
    }

    function render(){
      const enableCycle = $('enableCycle').checked;
      const enableToolLife = $('enableToolLife').checked;
      const enableKc = $('enableKc').checked;
      const enableDeflection = $('enableDeflection').checked;
      const enableStability = $('enableStability').checked;
      const enableCompare = $('enableCompare').checked;

      const {A,B} = computeAll(enableCompare);

      const out = $('results'); out.innerHTML='';

      // Summary block
      const s = document.createElement('div'); s.className='card small'; s.innerHTML = `
        <div class="font-bold">Resumen rápido</div>
        <div class="mt-2 grid grid-cols-2 gap-1">
          <div class="muted">RPM</div><div class="result-value">${fmt(A.rpm,0)}</div>
          <div class="muted">Avance (mm/min)</div><div class="result-value">${fmt(A.feed_mm_min,2)}</div>
          <div class="muted">MRR (cm³/min)</div><div class="result-value">${fmt(A.mrr_cm3_min,3)}</div>
          <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
        </div>`;
      out.appendChild(s);

      if(enableCycle){
        const c = document.createElement('div'); c.className='card small';
        c.innerHTML = `<div class="font-bold">Tiempo & Coste</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Tiempo por pieza (min)</div><div class="result-value">${fmt(A.time_min,2)}</div>
            <div class="muted">Costo máquina (MXN)</div><div class="result-value">${fmt(A.cost_machine,2)}</div>
            <div class="muted">Costo total por pieza (MXN)</div><div class="result-value">${fmt(A.cost_per_piece,2)}</div>
          </div>`;
        out.appendChild(c);
      }

      if(enableToolLife){
        const t = document.createElement('div'); t.className='card small';
        t.innerHTML = `<div class="font-bold">Vida de herramienta</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Vida estimada (min)</div><div class="result-value">${fmt(A.life_min,1)}</div>
            <div class="muted">Piezas por herramienta</div><div class="result-value">${fmt(A.pieces_per_tool,0)}</div>
            <div class="muted">Costo herramienta por pieza (MXN)</div><div class="result-value">${fmt(A.tool_cost_per_piece,2)}</div>
          </div>`;
        out.appendChild(t);
      }

      if(enableKc){
        const k = document.createElement('div'); k.className='card small';
        k.innerHTML = `<div class="font-bold">Kc(h) y Potencia</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Chip thickness (mm)</div><div class="result-value">${fmt(A.chip_h,4)}</div>
            <div class="muted">Kc(h) (N/mm²)</div><div class="result-value">${fmt(A.Kc_h,1)}</div>
            <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
          </div>
          <div class="mt-2 muted small">Nota: Kc(h) y potencia son aproximaciones. Valida con banco de pruebas antes de tomar decisiones comerciales.</div>`;
        out.appendChild(k);
      }

      if(enableDeflection){
        const d = document.createElement('div'); d.className='card small';
        d.innerHTML = `<div class="font-bold">Deflexión & Fuerza</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Fuerza radial (N aprox)</div><div class="result-value">${fmt(A.F_radial,2)}</div>
            <div class="muted">Deflexión (mm aprox)</div><div class="result-value">${fmt(A.delta_mm,4)}</div>
          </div>
          <div class="mt-2 muted small">Sugerencia: reduce stickout o usa portaherramientas más rígidos si δ > 0.05 mm.</div>`;
        out.appendChild(d);
      }

      if(enableStability){
        const st = document.createElement('div'); st.className='card small';
        st.innerHTML = `<div class="font-bold">Estimado de frecuencia natural</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">f_n (Hz aprox)</div><div class="result-value">${fmt(A.f_n,1)}</div>
            <div class="muted">Tooth frequency (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
          </div>
          <div class="mt-2 muted small">Si toothHz se acerca a f_n puede aumentar el riesgo de resonancia.</div>`;
        out.appendChild(st);
      }

      // Charts
      renderChart(A);

      // Table compare
      renderCompareTable(A, B);

    }

    // Chart.js
    let chartMRR = null;
    function renderChart(A){
      const ctx = $('chartMRR').getContext('2d');
      // create curve of RPM from 0.5x to 1.5x
      const D = parseFloat($('diam').value)||12; const z = parseInt($('z').value)||4; const fz = parseFloat($('fz').value)||0.06;
      const vc = parseFloat($('vc').value)||180;
      const vcs = [];
      const labels = [];
      const dataMRR = [];
      for(let k=0;k<=10;k++){ const vcx = vc*(0.6 + 0.08*k); vcs.push(vcx); labels.push(Math.round(vcx));
        const rpm = (vcx*1000)/(Math.PI*D); const feed = rpm*z*fz; const mrr = feed * parseFloat($('ae').value||10) * parseFloat($('ap').value||2)/1000; dataMRR.push(mrr);
      }
      if(chartMRR) chartMRR.destroy();
      chartMRR = new Chart(ctx,{type:'line',data:{labels, datasets:[{label:'MRR (cm3/min)', data:dataMRR, fill:true, tension:0.25}]}, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }

    function renderCompareTable(A,B){
      const tbody = $('tableCompare').querySelector('tbody'); tbody.innerHTML='';
      if(!B){
        const tr = document.createElement('tr'); tr.innerHTML = `<td class="muted">Comparador</td><td colspan="3" class="small muted">Activa "Comparador A vs P" y presiona Comparar</td>`; tbody.appendChild(tr); return;
      }
      const rows = [
        ['RPM', fmt(A.rpm,0), fmt(B.rpm,0), fmt(B.rpm - A.rpm,0)],
        ['MRR (cm3/min)', fmt(A.mrr_cm3_min,3), fmt(B.mrr_cm3_min,3), fmt(B.mrr_cm3_min - A.mrr_cm3_min,3)],
        ['Tiempo/pieza (min)', fmt(A.time_min,2), fmt(B.time_min,2), fmt(B.time_min - A.time_min,2)],
        ['Costo/pieza (MXN)', fmt(A.cost_per_piece,2), fmt(B.cost_per_piece,2), fmt(B.cost_per_piece - A.cost_per_piece,2)],
        ['Piezas por herramienta', fmt(A.pieces_per_tool,0), fmt(B.pieces_per_tool,0), fmt(B.pieces_per_tool - A.pieces_per_tool,0)]
      ];
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="muted small">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`; tbody.appendChild(tr); });
    }

    // Exports
    $('btnExportCsv').addEventListener('click', ()=>{
      const {A,B} = computeAll($('enableCompare').checked);
      const rows = [ ['metric','A','B'] , ['RPM',A.rpm,(B?B.rpm:'')], ['MRR_cm3_min',A.mrr_cm3_min,(B?B.mrr_cm3_min:'')], ['time_min',A.time_min,(B?B.time_min:'')], ['cost_piece',A.cost_per_piece,(B?B.cost_per_piece:'')] ];
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='calculadora_rpm_export.csv'; a.click(); URL.revokeObjectURL(url);
    });

    $('btnExportPdf').addEventListener('click', async ()=>{
      const element = document.body; // capture whole page
      const canvas = await html2canvas(element, {scale:1.5});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:'portrait',unit:'px',format:[canvas.width, canvas.height]});
      pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
      pdf.save('reporte_calculadora_rpm.pdf');
    });

    // Compare button
    $('btnCompare').addEventListener('click', ()=>{ render(); });

    // Auto render on input changes
    document.querySelectorAll('input').forEach(i=>i.addEventListener('input', ()=>{ render(); }));

    // Initial render
    render();
  </script>

</body>
</html>
