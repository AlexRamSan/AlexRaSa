<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Condiciones de Corte — AlexRaSa</title>
  <meta name="description" content="Calcula RPM, avance, MRR, potencia y vibración con presets y gráfica Avance vs RPM. Recomendación automática de Vc y fz." />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#0b1220" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent:#0ea5e9; --rose:#e11d48; --emerald:#10b981; --indigo:#6366f1;
    }
    .err { color:#fca5a5; font-size:.78rem; margin-top:4px }
    .err-hide { display:none }
    .input-err { border-color:#7f1d1d !important; box-shadow:0 0 0 2px rgba(127,29,29,.2) }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu;margin:0}
    .container{max-width:1180px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .lead{color:var(--muted)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);padding:.5rem .8rem;border-radius:8px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
    .tab{padding:.5rem .8rem;border-radius:8px;border:1px solid var(--border);background:rgba(148,163,184,.06)}
    .tab.is-on{background:var(--accent);border-color:var(--accent);color:#061018}
    .field>label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:.25rem}
    .field>input,.field>select{width:100%;border-radius:8px;padding:.5rem .6rem;background:var(--card)!important;border:1px solid var(--border);color:var(--ink)!important}
    .kpi-value{font-size:1.35rem;color:#eaf2ff}
    .muted{color:var(--muted)}
    .grid-2 { display:grid; grid-template-columns: 1fr 420px; gap:18px; align-items:start; }
    .grid-forms { display:grid;grid-template-columns: repeat(3, 1fr); gap:12px; }
    .section-title{ font-weight:700; color:var(--accent); margin-bottom:8px }
    .sidebar { width:420px; min-width:320px }
    @media(max-width:1100px){ .grid-2{grid-template-columns:1fr} .sidebar{width:100%} .grid-forms{grid-template-columns:1fr} }
    input[type=number] { background: rgba(255,255,255,0.02); color:var(--ink); }
    .result-value{ font-weight:700; font-size:1.05rem; color:var(--ink) }
    .badge{display:inline-block;padding:.1rem .4rem;border-radius:6px;border:1px solid var(--border);font-size:.72rem;color:var(--muted)}
    .has-tip{ position:relative; cursor:help }
    #_tt{ position:fixed; z-index:99999; max-width:320px; padding:10px 12px;
      background:#0b1220; color:#e5eefb; border:1px solid #1f2a3a; border-radius:10px;
      font-size:.85rem; line-height:1.25; box-shadow:0 8px 24px rgba(0,0,0,.35); pointer-events:none;
    }
    #_tt .tt-title{ font-weight:700; color:#0ea5e9; margin-bottom:4px }
    .badge-ok{ background:rgba(16,185,129,.12); border-color:#065f46; color:#d1fae5 }
    .badge-warn{ background:rgba(245,158,11,.10); border-color:#92400e; color:#fde68a }
    .badge-err{ background:rgba(225,29,72,.10); border-color:#7f1d1d; color:#fecaca }
  </style>
</head>

<body>
<header class="sticky top-0 z-50 bg-black/40 backdrop-blur border-b border-gray-800">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2"><img src="/assets/logo.png" alt="Logo" class="h-10" /></a>
      <nav class="hidden lg:flex gap-6 text-sm">
        <a href="/">Inicio</a><a href="/#soluciones">Soluciones</a><a href="/#recursos">Recursos</a>
      </nav>
    </div>
  </div>
</header>

<section class="relative">
  <div class="absolute inset-0 -z-10">
    <div class="absolute inset-0 bg-[url('/assets/hero-industrial.png')] bg-cover bg-center opacity-60"></div>
    <div class="absolute inset-0 bg-slate-900/60"></div>
  </div>
  <div class="max-w-6xl mx-auto px-4 py-10 md:py-20 text-white">
    <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
      Calculadora de <span class="text-sky-400">Condiciones de Corte</span>
    </h1>
    <p class="mt-3 text-white/90 max-w-3xl">
      Ajusta RPM y avance. Estima MRR, potencia y riesgo de vibración con una sola gráfica Avance vs RPM.
    </p>
  </div>
</section>

<main class="container">
  <div class="grid-2">
    <div>
      <div class="card mb-4">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0;font-weight:800">Entradas</h2>
            <div class="lead">Presets y parámetros</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="modeF" class="tab is-on">Fresado</button>
            <button id="modeT" class="tab">Torneado</button>
          </div>
        </div>
      </div>

      <div class="grid-forms">
        <!-- Col 1 -->
        <div class="card">
          <div class="section-title">Parámetros principales</div>
          <div style="display:grid;gap:10px">
            <div class="field"><label>Material</label><select id="materialSelect"></select></div>
            <div class="field"><label>Operación</label><select id="operationSelect"></select></div>

            <!-- Nivel Conservador/Estándar/Agresivo -->
            <div class="field"><label>Nivel (Vc/fz)</label>
              <select id="levelSelect">
                <option value="estandar">Estándar</option>
                <option value="conservador">Conservador</option>
                <option value="agresivo">Agresivo</option>
              </select>
            </div>

            <div class="field"><label>Sujeción / Holder</label><select id="holderSelect"></select></div>
            <div class="field"><label>Tipo herramienta</label><select id="toolTypeSelect"></select></div>

            <div id="modeFresadoFields">
  <div class="field"><label>Diámetro herramienta D (mm)</label><input id="diam" type="number" step="0.01" value="12" /></div>
  <div class="field"><label>Dientes (z)</label><input id="z" type="number" step="1" value="4" /></div>

  <div class="field"><label>Vel. corte Vc (m/min) <span class="badge" id="vcRecBadge">rec: —</span></label>
    <input id="vc" type="number" step="0.1" value="180" />
  </div>
  <div class="field"><label>fz (mm/tooth) <span class="badge" id="fzRecBadge">rec: —</span></label>
    <input id="fz" type="number" step="0.0001" value="0.06" />
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div class="field"><label>Ae (% de D)</label>
      <input id="aePct" type="number" step="1" min="1" max="100" value="30" />
    </div>
    <div class="field"><label>Ap (mm)</label>
      <input id="ap" type="number" step="0.01" value="2" />
    </div>
  </div>
</div>
            <div id="modeTorneadoFields" style="display:none">
              <div class="field"><label>Diámetro pieza D (mm)</label><input id="diamT" type="number" step="0.01" value="60" /></div>
              <div class="field"><label>Prof. corte ap (mm)</label><input id="apT" type="number" step="0.01" value="2" /></div>
              <div class="field"><label>Vc (m/min) <span class="badge" id="vcRecBadgeT">rec: —</span></label><input id="vcT" type="number" step="0.1" value="120" /></div>
              <div class="field"><label>Avance f (mm/rev) <span class="badge" id="fRecBadgeT">rec: —</span></label><input id="fT" type="number" step="0.001" value="0.15" /></div>
            </div>

            <div class="field"><label>Stickout L (mm)</label><input id="stickout" type="number" step="1" value="60" /></div>
          </div>
        </div>

        <!-- Col 2 -->
        <div class="card">
          <div class="section-title">Costos & Opciones</div>
          <div style="display:grid;gap:10px">
            <div class="field"><label>Costo hora máquina (USD)</label><input id="machineCost" type="number" step="0.1" value="25" /></div>
            <div class="field"><label>Costo herramienta (USD)</label><input id="toolCost" type="number" step="0.1" value="70" /></div>
            <div class="field"><label>Volumen a remover (cm³)</label><input id="volumen" type="number" step="0.01" value="18" /></div>
            <div class="field"><label>Constante Taylor C</label><input id="C" type="number" step="1" value="40000" /></div>
            <div class="field"><label>Exponente n (Taylor)</label><input id="n" type="number" step="0.01" value="0.25" /></div>
            <div style="display:flex;gap:8px;align-items:center">
              <label><input id="enableCycle" type="checkbox" class="toggle" checked /> <span class="muted">Tiempo</span></label>
              <label><input id="enableKc" type="checkbox" class="toggle" checked /> <span class="muted">Kc/Pot.</span></label>
              <label><input id="enableStability" type="checkbox" class="toggle" checked /> <span class="muted">Vibración</span></label>
            </div>
          </div>
        </div>

        <!-- Col 3 -->
        <div class="card">
          <div class="section-title">Parámetros de máquina</div>
          <div style="display:grid;gap:10px">
            <div class="field"><label>Máquina (preset)</label>
              <select id="machineSelect"><option value="custom">— Seleccionar máquina —</option></select>
            </div>
            <div class="field"><label>Marca / Modelo</label><input id="machineModel" type="text" value="" /></div>
            <div class="field"><label>Potencia husillo (kW)</label><input id="machinePower" type="number" step="0.1" value="15" /></div>
            <div class="field"><label>RPM máx</label><input id="machineMaxRpm" type="number" step="1" value="10000" /></div>
            <div class="field"><label>Base RPM (par constante)</label>
  <input id="machineBaseRpm" type="number" step="1" value="1500" />
</div>
<div class="field"><label>Límite avance máx (mm/min)</label>
  <input id="machineFeedMax" type="number" step="100" value="30000" />
</div>

            <!-- NUEVOS: curva par/potencia y límites de aceleración -->
            <div class="field"><label>Par base (N·m) @ rpm base</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <input id="machineBaseTorque" type="number" step="0.1" value="80" />
                <input id="machineBaseRpm" type="number" step="1" value="1500" />
              </div>
            </div>
            <div class="field"><label>Aceleración máx</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <input id="accelRpm" type="number" step="10" value="6000" placeholder="rpm/s" />
                <input id="accelFeed" type="number" step="10" value="5000" placeholder="mm/s²" />
              </div>
            </div>

            <div class="field"><label>Tipo de husillo</label><input id="spindleType" type="text" value="HSK63" /></div>
            <div class="field"><label>E aproximado (GPa)</label><input id="E" type="number" step="1" value="210" /></div>
            <div class="field"><label>Stickout por defecto (mm)</label><input id="stickoutDefault" type="number" step="1" value="60" /></div>
            <div class="muted">Presets en <code>CUTTING_DATA.machines</code>.</div>
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="card">
        <div class="section-title">Resultados</div>
        <div id="results" style="margin-top:10px"></div>

        <div style="margin-top:12px" class="card">
          <div class="section-title">Detalles Máquina / Herramienta</div>
          <div id="machineDetails" style="margin-top:8px"></div>
        </div>
      </div>
    </aside>
  </div>

  <section style="margin-top:18px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:14px;flex-wrap:wrap">
        <div>
          <h3 style="margin:0;font-weight:800">Gráfica Avance vs RPM</h3>
          <div class="muted">Curva óptima de mínima vibración, puntos seguros e isocurvas de MRR y par. Zona roja = “no factible”. El punto blanco es tu condición actual.</div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div class="field" style="min-width:220px">
            <label>Rango avance (mm/min)</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="feedMin" type="number" value="200"><input id="feedMax" type="number" value="2200">
            </div>
          </div>
          <div class="field" style="min-width:220px">
            <label>Rango RPM</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="rpmMin" type="number" value="200"><input id="rpmMax" type="number" value="10000">
            </div>
          </div>
          <div class="field" style="width:160px">
            <label>Umbral seguro (prob)</label>
            <input id="thSafe" type="number" step="0.05" value="0.4">
          </div>
        </div>
      </div>
      <div style="height:520px;margin-top:12px"><canvas id="chartRPMFeed"></canvas></div>
    </div>
  </section>
</main>

<script>
/* ========== Utilidades ========== */
const $ = id => document.getElementById(id);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const lerp=(a,b,t)=>a+(b-a)*t;
function fmt(n,dec=2){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec}); }

/* ========== Validación mínima (sin tocar tu UX) ========== */
const FIELDS_TO_VALIDATE = ['diam','z','vc','fz','aePct','ap','diamT','apT','vcT','fT','machineMaxRpm'];
function ensureErrorSlots(){FIELDS_TO_VALIDATE.forEach(id=>{const el=$(id);if(!el)return;const w=el.closest('.field');if(w&&!w.querySelector(`#err-${id}`)){const d=document.createElement('div');d.id=`err-${id}`;d.className='err err-hide';w.appendChild(d);}});}
function showError(id,msg){const el=$(id),slot=$(`err-${id}`);if(!el||!slot)return;slot.textContent=msg;slot.classList.remove('err-hide');el.classList.add('input-err');}
function clearError(id){const el=$(id),slot=$(`err-${id}`);if(!el||!slot)return;slot.textContent='';slot.classList.add('err-hide');el.classList.remove('input-err');}
function validateInputs(){
  let ok = true;
  const isT = $('modeT').classList.contains('is-on');
  FIELDS_TO_VALIDATE.forEach(clearError);

  const rpmMax = +$('machineMaxRpm').value || 0;
  if (rpmMax <= 0) { showError('machineMaxRpm','Debe ser > 0'); ok = false; }

  if (!isT) {
    const D=+$('diam').value, z=+$('z').value, vc=+$('vc').value, fz=+$('fz').value, aePct=+$('aePct').value, ap=+$('ap').value;
    if (D <= 0) { showError('diam','D > 0'); ok = false; }
    if (!Number.isInteger(z) || z < 1) { showError('z','z entero ≥ 1'); ok = false; }
    if (vc <= 0) { showError('vc','Vc > 0'); ok = false; }
    if (fz <= 0) { showError('fz','fz > 0'); ok = false; }
    if (aePct <= 0) { showError('aePct','Ae% > 0'); ok = false; }
    if (aePct > 100) { showError('aePct','Ae% ≤ 100'); ok = false; }
    const rpm_teo=(vc*1000)/(Math.PI*Math.max(D,1e-9));
    if (rpmMax>0 && rpm_teo>rpmMax*1.05) { showError('vc',`Pide ${Math.round(rpm_teo)} rpm > ${rpmMax}`); ok=false; }
  } else {
    const D=+$('diamT').value, apv=+$('apT').value, vct=+$('vcT').value, f=+$('fT').value;
    if (D <= 0) { showError('diamT','D > 0'); ok = false; }
    if (apv <= 0) { showError('apT','ap > 0'); ok = false; }
    if (vct <= 0) { showError('vcT','Vc > 0'); ok = false; }
    if (f <= 0) { showError('fT','f > 0'); ok = false; }
    const rpm_teo=(vct*1000)/(Math.PI*Math.max(D,1e-9));
    if (rpmMax>0 && rpm_teo>rpmMax*1.05) { showError('vcT',`Pide ${Math.round(rpm_teo)} rpm > ${rpmMax}`); ok=false; }
  }
  return ok;
}

/* ========== Tooltips: reusa los tuyos si ya están ========== */
const TIPS = window.TIPS || {};
let _ttEl=null;
function ensureTipEl(){ if(!_ttEl){ _ttEl=document.createElement('div'); _ttEl.id='_tt'; _ttEl.style.display='none'; document.body.appendChild(_ttEl);} }
function showTip(evt, tip){ if(!tip) return; ensureTipEl(); _ttEl.innerHTML=`<div class="tt-title">${tip.t||""}</div>${tip.d||""}`; _ttEl.style.display='block';
  const pad=12,vw=innerWidth,vh=innerHeight,rect=_ttEl.getBoundingClientRect(); let x=evt.clientX+pad,y=evt.clientY+pad;
  if(x+rect.width>vw) x=evt.clientX-rect.width-pad; if(y+rect.height>vh) y=evt.clientY-rect.height-pad; _ttEl.style.left=x+'px'; _ttEl.style.top=y+'px';}
function hideTip(){ if(_ttEl) _ttEl.style.display='none'; }

/* ========== Datos embebidos: se respetan. Añadimos Kte opcional y mexp por material ========== */
const CUTTING_DATA = window.CUTTING_DATA || {
  version:"3.4",
  defaults:{ rpm_limit:24000, efficiency:0.8, vibe_gauss:{mu:0.7,sigma:0.18}, default_flutes:4, windows:{vc_factor:[0.70,1.30], chip_factor:[0.70,1.30]} },
  vibration:{ avoid_band_hz:[600,900], risk_threshold:0.8, weights:{ld:0.5,ae:0.2,ap:0.2,fz:0.1} },
  holders:[], materials:[], operations:[], tool_types:[], machines:[]
};

/* ========== Niveles de agresividad (como ya usabas) ========== */
const LEVELS = { conservador:{vc:0.90, chip:0.90}, estandar:{vc:1.00, chip:1.00}, agresivo:{vc:1.15, chip:1.10} };
function getLevel(){ const k=$('levelSelect')?.value||'estandar'; return LEVELS[k]||LEVELS.estandar; }

/* ========== Poblado de selects existentes ========== */
const HOLDERS_BY_MODE={fresado:['ER_Collet','REGOFIX_powRgrip','ShrinkFit','HydraulicChuck','MillingChuck','SideLock','HeatShrink','SteadyRest'],torneado:['PortaInsertos','PowerChuck','SteadyRest','TurretToolHolder','BoringBarHolder']};
const TOOLTYPES_BY_MODE={fresado:['endmill','ballnose','facemill','indexable','highfeed','drill','reamer','slotmill','shellmill','lollipop','threadmill','boring_bar'],torneado:['turn_insert','groove','threading','tap']};

function ensureTurningEntries(){
  if(!CUTTING_DATA.tool_types) CUTTING_DATA.tool_types=[];
  if(!CUTTING_DATA.holders) CUTTING_DATA.holders=[];
  if(!CUTTING_DATA.tool_types.some(t=>t.id==='turn_insert')) CUTTING_DATA.tool_types.push({id:'turn_insert',label:'Herram. torneado',vc_factor:1,fz_factor:1,default_flutes:1});
  if(!CUTTING_DATA.holders.some(h=>h.id==='PortaInsertos')) CUTTING_DATA.holders.push({id:'PortaInsertos',label:'Porta-insertos',stiffness_factor:1.15});
}
function populateFromData(defaultMode='fresado'){
  const mSel=$('materialSelect'); if(mSel){ mSel.innerHTML=''; (CUTTING_DATA.materials||[]).forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.name;mSel.appendChild(o);}); }
  const oSel=$('operationSelect'); if(oSel){ oSel.innerHTML=''; (CUTTING_DATA.operations||[]).forEach(op=>{const o=document.createElement('option');o.value=op.id;o.textContent=op.label;oSel.appendChild(o);}); }
  const mPres=$('machineSelect'); if(mPres){ mPres.innerHTML='<option value="custom">— Seleccionar máquina —</option>'; (CUTTING_DATA.machines||[]).forEach(m=>{const opt=document.createElement('option');opt.value=m.id;opt.textContent=`${m.brand} · ${m.model} · ${m.type}`;mPres.appendChild(opt);}); }
  updateModeOptions(defaultMode);
}
function updateModeOptions(mode){
  ensureTurningEntries();
  const holderSel=$('holderSelect'); if(holderSel){ holderSel.innerHTML='';
    const idsH=(mode==='torneado')?HOLDERS_BY_MODE.torneado:HOLDERS_BY_MODE.fresado;
    const knownH=(CUTTING_DATA.holders||[]).map(h=>h.id);
    const finalH=idsH.filter(id=>knownH.includes(id));
    (finalH.length?finalH:(CUTTING_DATA.holders||[]).map(h=>h.id))
      .forEach(id=>{const h=(CUTTING_DATA.holders||[]).find(x=>x.id===id); if(h){const o=document.createElement('option');o.value=h.id;o.textContent=h.label||h.id;holderSel.appendChild(o);}}); }
  const toolSel=$('toolTypeSelect'); if(toolSel){ toolSel.innerHTML='';
    const idsT=(mode==='torneado')?TOOLTYPES_BY_MODE.torneado:TOOLTYPES_BY_MODE.fresado;
    const knownT=(CUTTING_DATA.tool_types||[]).map(t=>t.id);
    const finalT=idsT.filter(id=>knownT.includes(id));
    (finalT.length?finalT:(CUTTING_DATA.tool_types||[]).map(t=>t.id))
      .forEach(id=>{const t=(CUTTING_DATA.tool_types||[]).find(x=>x.id===id); if(t){const o=document.createElement('option');o.value=t.id;o.textContent=t.label||t.id;toolSel.appendChild(o);}}); }
  if(holderSel?.options.length) holderSel.value=holderSel.options[0].value;
  if(toolSel?.options.length) toolSel.value=toolSel.options[0].value;
}

/* ========== Ventanas por material (respetando tu lógica) ========== */
function materialWindows(mode){
  const mat=(CUTTING_DATA.materials||[]).find(m=>m.id===$('materialSelect').value)||{};
  const baseW=(CUTTING_DATA.defaults?.windows)||{vc_factor:[0.7,1.3],chip_factor:[0.7,1.3]};
  const mw=mat.windows||{};
  const vcF=mw.vc_factor||baseW.vc_factor;
  const chF=mw.chip_factor||baseW.chip_factor;
  const op=(CUTTING_DATA.operations||[]).find(x=>x.id===$('operationSelect').value)||{vc_factor:1,fz_factor:1};
  const tt=(CUTTING_DATA.tool_types||[]).find(t=>t.id===$('toolTypeSelect').value)||{vc_factor:1,fz_factor:1};
  const lvl=getLevel();
  const vc_base=(mat.vc_base??180)*(op.vc_factor||1)*(tt.vc_factor||1)*lvl.vc;
  const chip_base=((mat.fz_base??0.05)*(mode==='torneado'?1.2:1))*(op.fz_factor||1)*(tt.fz_factor||1)*lvl.chip;
  const vc_min=vc_base*vcF[0], vc_max=vc_base*vcF[1];
  const chip_min=chip_base*chF[0], chip_max=chip_base*chF[1];
  return { vc_min, vc_max, chip_min, chip_max, vc_base_adj:vc_base, chip_base_adj:chip_base };
}
function setBadge(id,level,text){const el=$(id); if(!el)return; el.classList.remove('badge-ok','badge-warn','badge-err'); el.classList.add(level); el.textContent=text;}
function gradeValue(v,lo,hi){ if(v<lo*0.97||v>hi*1.03) return 'err'; if(v<lo||v>hi) return 'warn'; return 'ok'; }

/* ========== Recomendación Vc/fz ========== */
function recommendVcFz(mode='fresado'){
  const mat=(CUTTING_DATA.materials||[]).find(m=>m.id===$('materialSelect').value)||CUTTING_DATA.materials[0];
  const op =(CUTTING_DATA.operations||[]).find(x=>x.id===$('operationSelect').value)||{vc_factor:1,fz_factor:1};
  const tt =(CUTTING_DATA.tool_types||[]).find(t=>t.id===$('toolTypeSelect').value)||{vc_factor:1,fz_factor:1,default_flutes:4};
  const lvl=getLevel();

  if(mode==='fresado'){
    const D=parseFloat($('diam').value)||12;
    const z=parseInt($('z').value)||(tt.default_flutes||4);
    const vc_base=mat.vc_base??180;
    const fz_base=mat.fz_base??0.05;
    const fz_d=fz_base*Math.pow(D/12,0.25);

    let vc_rec=vc_base*(tt.vc_factor||1)*(op.vc_factor||1)*lvl.vc;
    let fz_rec=fz_d   *(tt.fz_factor||1)*(op.fz_factor||1)*lvl.chip;

    const maxR=parseFloat($('machineMaxRpm').value)||CUTTING_DATA.defaults.rpm_limit;
    const rpm_rec=(vc_rec*1000)/(Math.PI*D);
    if(rpm_rec>maxR) vc_rec=(maxR*Math.PI*D)/1000;

    const win=materialWindows('fresado');
    const chip_curr=parseFloat($('fz').value)||fz_rec;
    const vc_curr=parseFloat($('vc').value)||vc_rec;
    const g_vc=gradeValue(vc_curr,win.vc_min,win.vc_max);
    const g_chip=gradeValue(chip_curr,win.chip_min,win.chip_max);
    const vc_txt=`rec: ${vc_rec.toFixed(0)} · win ${win.vc_min.toFixed(0)}–${win.vc_max.toFixed(0)} m/min`;
    const chip_txt=`rec: ${fz_rec.toFixed(3)} · win ${win.chip_min.toFixed(3)}–${win.chip_max.toFixed(3)} mm/z`;
    setBadge('vcRecBadge', g_vc==='ok'?'badge-ok':g_vc==='warn'?'badge-warn':'badge-err', vc_txt);
    setBadge('fzRecBadge', g_chip==='ok'?'badge-ok':g_chip==='warn'?'badge-warn':'badge-err', chip_txt);

    if(!$('vc').dataset.userSet) $('vc').value=vc_rec.toFixed(1);
    if(!$('fz').dataset.userSet) $('fz').value=fz_rec.toFixed(3);
    if(!$('z').value) $('z').value=z;

  } else {
    const D=parseFloat($('diamT').value)||60;
    const vc_base=mat.vc_base??180;
    const f_base=(mat.fz_base??0.05)*1.2;

    let vc_rec=vc_base*(op.vc_factor||1)*lvl.vc;
    let f_rec =f_base *(op.fz_factor||1)*lvl.chip;

    const maxR=parseFloat($('machineMaxRpm').value)||CUTTING_DATA.defaults.rpm_limit;
    const rpm_rec=(vc_rec*1000)/(Math.PI*D);
    if(rpm_rec>maxR) vc_rec=(maxR*Math.PI*D)/1000;

    const win=materialWindows('torneado');
    const chip_curr=parseFloat($('fT').value)||f_rec;
    const vc_curr=parseFloat($('vcT').value)||vc_rec;
    const g_vc=gradeValue(vc_curr,win.vc_min,win.vc_max);
    const g_chip=gradeValue(chip_curr,win.chip_min,win.chip_max);
    const vc_txt=`rec: ${vc_rec.toFixed(0)} · win ${win.vc_min.toFixed(0)}–${win.vc_max.toFixed(0)} m/min`;
    const f_txt =`rec: ${f_rec.toFixed(3)} · win ${win.chip_min.toFixed(3)}–${win.chip_max.toFixed(3)} mm/rev`;
    setBadge('vcRecBadgeT', g_vc==='ok'?'badge-ok':g_vc==='warn'?'badge-warn':'badge-err', vc_txt);
    setBadge('fRecBadgeT',  g_chip==='ok'?'badge-ok':g_chip==='warn'?'badge-warn':'badge-err', f_txt);

    if(!$('vcT').dataset.userSet) $('vcT').value=vc_rec.toFixed(1);
    if(!$('fT').dataset.userSet)  $('fT').value =f_rec.toFixed(3);
  }
}

/* ========== Modelo de potencia/par del husillo + límites “imposibles” ========== */
/* Supuesto estándar: par constante hasta base_rpm, luego potencia constante. */
function spindleLimits(){
  const PkW = +($('machinePower').value||15);
  const rpmMax = +($('machineMaxRpm').value||10000);
  const base = +($('machineBaseRpm')?.value||1500);
  const feedMax = +($('machineFeedMax')?.value||30000); // mm/min
  const T_const = 9550*PkW/Math.max(base,1); // N·m
  return {PkW,rpmMax,base,T_const,feedMax};
}
function availPowerTorque(rpm){
  const {PkW,base,T_const} = spindleLimits();
  if(rpm<=0) return {P_kW:0,T_Nm:T_const};
  if(rpm<=base){ const T=T_const; const P=T*rpm/9550; return {P_kW:P,T_Nm:T}; }
  return {P_kW:PkW, T_Nm:(9550*PkW)/rpm};
}

/* ========== Vibración y cálculos principales (añadimos Kte y par) ========== */
function vibrationRiskScore(params){
  const w=CUTTING_DATA.vibration.weights;
  const Lnorm=Math.min(1,(params.L||0)/200);
  const aenorm=Math.min(1,((params.ae||0)/(params.D||1)));
  const apnorm=Math.min(1,((params.ap||0)/((params.D||1)*1.5)));
  const fznorm=Math.min(1,((params.fz||0)/0.5));
  const score=((w.ld||0.5)*Lnorm+(w.ae||0.2)*aenorm+(w.ap||0.2)*apnorm+(w.fz||0.1)*fznorm);
  const mu=CUTTING_DATA.defaults.vibe_gauss.mu||0.7, sigma=CUTTING_DATA.defaults.vibe_gauss.sigma||0.18;
  const z=(score-mu)/sigma; let p=1/(1+Math.exp(-z));
  const band=CUTTING_DATA.vibration.avoid_band_hz||[600,900]; const c=(band[0]+band[1])/2, s=(band[1]-band[0])/2;
  const pen=Math.exp(-Math.pow((params.toothHz-c)/(s*0.8),2)/2); p=clamp(p+0.55*pen,0,1);
  return {raw:score,prob:p};
}
function matParams(){
  const mat=(CUTTING_DATA.materials||[]).find(m=>m.id===$('materialSelect').value)||(CUTTING_DATA.materials||[])[0]||{};
  const Kc0=mat.Kc_N_per_mm2 ?? 2000;
  const Kte=mat.Kte_N_per_mm ?? 0;         // opcional
  const mexp=mat.mexp ?? 0.20;             // opcional
  const lifeC=(mat.taylor?.C) ?? (+$('C').value||40000);
  const lifen=(mat.taylor?.n) ?? (+$('n').value||0.25);
  return {Kc0,Kte,mexp,lifeC,lifen};
}

/* — FRESADO — */
function computeFresado(override={}){
  const D=parseFloat(override.diam ?? $('diam').value)||0.001;
  const z=parseInt(override.z ?? $('z').value)||1;
  let vc=parseFloat(override.vc ?? $('vc').value)||0.1;
  let fz=parseFloat(override.fz ?? $('fz').value)||0.0001;
  const aePct=parseFloat(override.aePct ?? $('aePct').value)||30;
  const ae=(aePct/100)*D;
  const ap=parseFloat(override.ap ?? $('ap').value)||0.1;
  const {Kc0,Kte,mexp,lifeC,lifen}=matParams();

  // Factores de herramienta (igual que antes)
  const toolType=(CUTTING_DATA.tool_types||[]).find(t=>t.id===$('toolTypeSelect').value)||(CUTTING_DATA.tool_types||[])[0]||{vc_factor:1,fz_factor:1};
  vc*=toolType.vc_factor||1;
  fz*=toolType.fz_factor||1;

  // RPM y límites
  let rpm=(vc*1000)/(Math.PI*D);
  const maxR=+($('machineMaxRpm').value)||CUTTING_DATA.defaults.rpm_limit;
  if(rpm>maxR){ rpm=maxR; vc=(rpm*Math.PI*D)/1000; }

  // Cálculos base
  const feed_mm_min=rpm*z*fz;
  const mrr_mm3_min=feed_mm_min*ae*ap;
  const mrr_cm3_min=mrr_mm3_min/1000;
  const chip_h=fz;

  const Kc_h = Kc0 * Math.pow(chip_h+1e-6, -(mexp||0.2));
  const Fc_N = (Kc_h*ae*ap) + (Kte*(ap + ae)); // N, aprox. bordes + sección
  const eta=CUTTING_DATA.defaults.efficiency||0.8;
  const power_kW=(Kc_h*mrr_mm3_min)/(60*1000)/eta; // estándar
  const torque_Nm = rpm>0 ? (9550*power_kW)/rpm : Infinity;

  // Vida y costos
  const volumen=+($('volumen').value)||0.001;
  const time_min=volumen/Math.max(mrr_cm3_min,1e-9);
  const cost_machine=(time_min/60)*(+($('machineCost').value)||0);
  const toolLife_min=lifeC/Math.pow(Math.max(vc,1e-6),lifen);
  const pieces_per_tool=Math.max(Math.floor(toolLife_min/Math.max(time_min,1e-9)),1);
  const tool_cost_per_piece=(+($('toolCost').value)||0)/pieces_per_tool;

  // Rigidez y vibración
  const holder=(CUTTING_DATA.holders||[]).find(h=>h.id===$('holderSelect').value)||(CUTTING_DATA.holders||[])[0]||{stiffness_factor:1};
  const E=(+($('E')?.value)||210)*1000;
  const I=Math.PI*Math.pow(D,4)/64;
  const L=+($('stickout').value||60);
  const stiffness_factor=holder.stiffness_factor||1.0;
  const delta_mm=(Fc_N*Math.pow(L,3))/(3*E*I+1e-9)/stiffness_factor;
  const k_eff=(3*E*I)/Math.pow(L,3)*stiffness_factor;
  const m_eff=0.02;
  const f_n=(1/(2*Math.PI))*Math.sqrt(Math.abs(k_eff/(m_eff*1000)));

  const toothHz=(rpm/60)*z;
  const edgeR=0.02; // mm
  const ra_um=Math.max(0,(Math.pow(fz,2)/(32*edgeR)))*1000;
  const vib=vibrationRiskScore({L,ae,ap,fz,D,toothHz});

  return {mode:'fresado',rpm,feed_mm_min,mrr_cm3_min,chip_h,Kc_h,power_kW,torque_Nm,time_min,cost_machine,pieces_per_tool,tool_cost_per_piece,delta_mm,f_n,toothHz,Fc_N,vib,ra_um,ae,ap,D,z};
}

/* — TORNEADO — */
function computeTorneado(override={}){
  const D=parseFloat(override.diamT ?? $('diamT').value)||0.001;
  const ap=parseFloat(override.apT ?? $('apT').value)||0.5;
  let vc=parseFloat(override.vcT ?? $('vcT').value)||0.1;
  const f=parseFloat(override.fT ?? $('fT').value)||0.1;
  const {Kc0,Kte,mexp,lifeC,lifen}=matParams();
  const op=(CUTTING_DATA.operations||[]).find(x=>x.id===$('operationSelect').value)||{vc_factor:1,fz_factor:1};

  vc*=op.vc_factor||1;
  let rpm=(vc*1000)/(Math.PI*D);
  const maxR=+($('machineMaxRpm').value)||CUTTING_DATA.defaults.rpm_limit;
  if(rpm>maxR){ rpm=maxR; vc=(rpm*Math.PI*D)/1000; }

  const feed_mm_min=rpm*f;
  const mrr_mm3_min=Math.PI*D*ap*f*rpm/4;
  const mrr_cm3_min=mrr_mm3_min/1000;
  const chip_h=f;
  const Kc_h=Kc0*Math.pow(chip_h+1e-6, -(mexp||0.2));
  const Fc_N=(Kc_h*ap*f) + (Kte*(ap + f)); // simplificación
  const eta=CUTTING_DATA.defaults.efficiency||0.8;
  const power_kW=(Kc_h*mrr_mm3_min)/(60*1000)/eta;
  const torque_Nm = rpm>0 ? (9550*power_kW)/rpm : Infinity;

  const volumen=+($('volumen').value)||0.001;
  const time_min=volumen/Math.max(mrr_cm3_min,1e-9);
  const cost_machine=(time_min/60)*(+($('machineCost').value)||0);
  const toolLife_min=lifeC/Math.pow(Math.max(vc,1e-6),lifen);
  const pieces_per_tool=Math.max(Math.floor(toolLife_min/Math.max(time_min,1e-9)),1);
  const tool_cost_per_piece=(+($('toolCost').value)||0)/pieces_per_tool;

  const holder=(CUTTING_DATA.holders||[]).find(h=>h.id===$('holderSelect').value)||(CUTTING_DATA.holders||[])[0]||{stiffness_factor:1};
  const E=(+($('E')?.value)||210)*1000;
  const I=Math.PI*Math.pow(D,4)/64;
  const L=+($('stickout').value||60);
  const stiffness_factor=holder.stiffness_factor||1.0;
  const delta_mm=(Fc_N*Math.pow(L,3))/(3*E*I+1e-9)/stiffness_factor;
  const k_eff=(3*E*I)/Math.pow(L,3)*stiffness_factor;
  const m_eff=0.02;
  const f_n=(1/(2*Math.PI))*Math.sqrt(Math.abs(k_eff/(m_eff*1000)));
  const toothHz=rpm/60;

  const noseR=0.4;
  const ra_um=Math.max(0,(Math.pow(f,2)/(32*noseR)))*1000;
  const vib=vibrationRiskScore({L,ae:ap,ap,fz:f,D,toothHz});

  return {mode:'torneado',rpm,feed_mm_min,mrr_cm3_min,chip_h,Kc_h,power_kW,torque_Nm,time_min,cost_machine,pieces_per_tool,tool_cost_per_piece,delta_mm,f_n,toothHz,Fc_N,vib,ra_um,ae:ap,ap,D,z:1};
}

/* ========== Lóbulos ========== */
function calcLobeRpmLines(mode, f_n, z, rpmMin, rpmMax){
  const lines=[]; if(!isFinite(f_n)||f_n<=0) return lines;
  for(let k=1;k<=12;k++){ const rpm = mode==='fresado' ? (60*k*f_n)/Math.max(z,1) : (60*k*f_n); if(rpm>=rpmMin&&rpm<=rpmMax) lines.push({rpm,k}); }
  return lines;
}
function makeLobePlugin(lobeRpms){
  return { id:'lobes', afterDraw(chart){ const y=chart.scales.y, x=chart.scales.x, g=chart.ctx;
    g.save(); g.setLineDash([6,6]); g.lineWidth=1; g.strokeStyle='rgba(99,102,241,0.45)'; g.fillStyle='rgba(148,163,184,0.9)'; g.font='11px system-ui, sans-serif';
    lobeRpms.forEach(({rpm,k})=>{ const yPix=y.getPixelForValue(rpm); g.beginPath(); g.moveTo(x.left,yPix); g.lineTo(x.right,yPix); g.stroke(); g.fillText(`${k}·fₙ`, x.right-42, yPix-4); });
    g.restore(); } };
}

/* ========== Gráfica con isocurvas de MRR y par + zona evitada ========== */
let chart=null;
function computePointForGraph(mode,feed,rpm){
  if(mode==='torneado'){
    const D=parseFloat($('diamT').value)||60;
    return computeTorneado({ fT: feed/Math.max(rpm,1), vcT:(rpm*Math.PI*D)/1000 });
  } else {
    const Z=parseInt($('z').value)||4;
    const D=parseFloat($('diam').value)||12;
    return computeFresado({ fz: feed/Math.max(rpm*Z,1), vc:(rpm*Math.PI*D)/1000 });
  }
}
function currentPoint(){ return $('modeT').classList.contains('is-on') ? computeTorneado() : computeFresado(); }

/* — Isocurvas auxiliares — */
function buildIsoMRR(mode, feedMin, feedMax, rpmMin, rpmMax, targets){
  // MRR = feed*ae*ap (mm3/min). Usamos ae/ap actuales.
  const base = currentPoint();
  const iso = [];
  const A = Math.max(base.ae*base.ap, 1e-9); // mm^2
  targets.forEach(val_cm3=>{ // objetivo en cm3/min
    const val = val_cm3*1000; // a mm3/min
    const pts=[];
    for(let i=0;i<32;i++){
      const rpm=lerp(rpmMin,rpmMax,i/31);
      const feed = clamp(val/A, feedMin, feedMax);
      pts.push({x:feed, y:rpm});
    }
    iso.push({label:`MRR ${val_cm3} cm³/min`, data:pts});
  });
  return iso;
}
function buildIsoTorque(mode, feedMin, feedMax, rpmMin, rpmMax, targets){
  // Aproximación: usa Kc(h) con fz NOMINAL actual -> par ≈ (9550/rpm)*P(feed,rpm)
  const base=currentPoint();
  const Z = base.z||1;
  const {Kc0,mexp}=matParams();
  const fz_nom = (mode==='fresado') ? ( (base.feed_mm_min/Math.max(base.rpm*Z,1)) ) : (base.chip_h);
  const Kc_nom = Kc0*Math.pow(fz_nom+1e-6, -(mexp||0.2));
  const ae=base.ae, ap=base.ap;
  const eta=CUTTING_DATA.defaults.efficiency||0.8;

  const iso=[];
  targets.forEach(tNm=>{
    const pts=[];
    for(let i=0;i<48;i++){
      const rpm=lerp(rpmMin,rpmMax,i/47);
      if(rpm<=0){ pts.push({x:feedMin,y:rpm}); continue; }
      // torque = 9550/rpm * P;  P = (Kc_nom * feed * ae * ap)/(60*1000*eta)
      // => feed = torque * rpm * 60*1000*eta / (9550 * Kc_nom * ae * ap)
      const feed = (tNm * rpm * 60000 * eta) / (9550 * Math.max(Kc_nom*ae*ap,1e-9));
      pts.push({x:clamp(feed,feedMin,feedMax), y:rpm});
    }
    iso.push({label:`τ ${tNm} N·m`, data:pts});
  });
  return iso;
}

/* — Zona evitada por límites de máquina — */
function buildAvoided(mode, feedMin, feedMax, rpmMin, rpmMax){
  const avoided=[];
  const {feedMax:feedCap}=spindleLimits();
  const stepsR=36, stepsF=64;
  for(let i=0;i<stepsR;i++){
    const rpm=lerp(rpmMin,rpmMax,i/(stepsR-1));
    const avail=availPowerTorque(rpm);
    for(let j=0;j<stepsF;j++){
      const feed=lerp(feedMin,feedMax,j/(stepsF-1));
      const pt=computePointForGraph(mode,feed,rpm);
      const overPower = pt.power_kW > (avail.P_kW+1e-6);
      const overTorque = pt.torque_Nm > (avail.T_Nm+1e-6);
      const overFeed = feed > feedCap;
      if(overPower || overTorque || overFeed) avoided.push({x:feed,y:rpm});
    }
  }
  return avoided;
}

/* — Curva óptima, zona segura y render — */
function buildOptimalCurve(mode,feedMin,feedMax,rpmMin,rpmMax){
  const stepsR=48,stepsF=64; const curve=[],safe=[];
  for(let i=0;i<stepsR;i++){
    const rpm=lerp(rpmMin,rpmMax,i/(stepsR-1));
    let best={prob:1,feed:null};
    for(let j=0;j<stepsF;j++){
      const feed=lerp(feedMin,feedMax,j/(stepsF-1));
      const {vib}=computePointForGraph(mode,feed,rpm);
      const p=vib.prob;
      if(p<+$('thSafe').value) safe.push({x:feed,y:rpm});
      if(p<best.prob){best={prob:p,feed};}
    }
    curve.push({x:best.feed??feedMin,y:rpm});
  }
  return {curve,safe};
}

function renderChart(){
  const mode=$('modeT').classList.contains('is-on')?'torneado':'fresado';
  const feedMin=+$('feedMin').value||200, feedMax=+$('feedMax').value||2200;
  const rpmMin=+$('rpmMin').value||200, rpmMax=+$('rpmMax').value||10000;

  const cur=currentPoint();
  const {curve,safe}=buildOptimalCurve(mode,feedMin,feedMax,rpmMin,rpmMax);
  const avoided=buildAvoided(mode,feedMin,feedMax,rpmMin,rpmMax);

  // Isocurvas dinámicas
  const mrr0 = Math.max(cur.mrr_cm3_min, 1e-4);
  const isoMRR = buildIsoMRR(mode,feedMin,feedMax,rpmMin,rpmMax,[ (mrr0*0.5).toFixed(2)*1, (mrr0*1.0).toFixed(2)*1, (mrr0*2.0).toFixed(2)*1 ]);
  const {T_const,PkW,base}=spindleLimits();
  const isoTau = buildIsoTorque(mode,feedMin,feedMax,rpmMin,rpmMax,[ Math.max(5,Math.round(T_const*0.5)), Math.round(T_const), Math.round(T_const*1.5) ]);

  if(chart) chart.destroy();
  const ctx=$('chartRPMFeed').getContext('2d');

  const bandPlugin={ id:'band', afterDraw(c){
    const y=c.scales.y,x=c.scales.x; const Z=(mode==='fresado')?(parseInt($('z').value)||4):1;
    const [h0,h1]=CUTTING_DATA.vibration.avoid_band_hz||[600,900];
    const rpm0=h0*60/Math.max(Z,1), rpm1=h1*60/Math.max(Z,1);
    const yTop=y.getPixelForValue(Math.min(y.max,rpm1)), yBot=y.getPixelForValue(Math.max(y.min,rpm0));
    const g=c.ctx; g.save(); g.fillStyle='rgba(225,29,72,0.08)'; g.fillRect(x.left,yTop,x.right-x.left,yBot-yTop);
    g.strokeStyle='rgba(225,29,72,0.18)'; g.beginPath(); g.moveTo(x.left,yTop); g.lineTo(x.right,yTop); g.moveTo(x.left,yBot); g.lineTo(x.right,yBot); g.stroke();
    g.fillStyle='rgba(225,29,72,.7)'; g.font='12px sans-serif'; g.fillText('Banda 600–900 Hz', x.right-140, yTop+14); g.restore();
  }};

  const lobeRpms = calcLobeRpmLines(mode, cur.f_n, cur.z||1, rpmMin, rpmMax);
  const lobesPlugin = makeLobePlugin(lobeRpms);

  const datasets = [
    {type:'scatter',label:'Evitar (pot/par/avance)',data:avoided,pointRadius:2,pointBackgroundColor:'rgba(225,29,72,.30)'},
    {type:'scatter',label:'Zona segura',data:safe,pointRadius:2,pointBackgroundColor:'rgba(16,185,129,.75)'},
    {type:'line',label:'Óptimo',data:curve,borderColor:'#60a5fa',borderWidth:2,tension:0.3,pointRadius:0},
    {type:'scatter',label:'Actual',data:[{x:cur.feed_mm_min,y:cur.rpm}],pointBackgroundColor:'#fff',pointBorderColor:'#000',pointBorderWidth:2,pointRadius:6}
  ];

  // Añadimos isocurvas MRR
  isoMRR.forEach((serie,i)=>datasets.push({
    type:'line', label:serie.label, data:serie.data, borderColor:'rgba(14,165,233,.45)', borderWidth:1, pointRadius:0, borderDash:[4,4], tension:0
  }));
  // Añadimos isocurvas de par
  isoTau.forEach((serie,i)=>datasets.push({
    type:'line', label:serie.label, data:serie.data, borderColor:'rgba(99,102,241,.45)', borderWidth:1, pointRadius:0, borderDash:[6,6], tension:0
  }));

  chart = new Chart(ctx,{
    data:{datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`Av ${Math.round(ctx.raw.x)} mm/min · RPM ${Math.round(ctx.raw.y)}`}}},
      scales:{x:{type:'linear',title:{display:true,text:'Avance (mm/min)'},min:feedMin,max:feedMax},
              y:{type:'linear',title:{display:true,text:'RPM'},min:rpmMin,max:rpmMax}}
    },
    plugins:[bandPlugin, lobesPlugin]
  });
}

/* ========== Auto-rango ========== */
function adjustRangesToInclude(A){
  const maxR=+$('machineMaxRpm').value||CUTTING_DATA.defaults.rpm_limit;
  const minFeedWindow=400, minRpmWindow=600;
  const fCenter=Math.max(1,A.feed_mm_min||100), rCenter=Math.max(1,A.rpm||1000);
  let fSpan=Math.max(minFeedWindow,fCenter*1.0), rSpan=Math.max(minRpmWindow,rCenter*1.0);
  let fMin=Math.floor(clamp(fCenter-fSpan*0.5,1,Infinity)); let fMax=Math.ceil(clamp(fCenter+fSpan*0.5,fMin+50,Infinity));
  let rMin=Math.floor(clamp(rCenter-rSpan*0.5,1,maxR));     let rMax=Math.ceil (clamp(rCenter+rSpan*0.5,rMin+50,maxR));
  const near=(v,mi,ma)=> (v-mi)/(ma-mi)<0.2 || (ma-v)/(ma-mi)<0.2;
  if(near(fCenter,fMin,fMax)){ fMin=Math.floor(clamp(fCenter-fSpan*0.6,1,Infinity)); fMax=Math.ceil(clamp(fCenter+fSpan*0.6,fMin+50,Infinity)); }
  if(near(rCenter,rMin,rMax)){ rMin=Math.floor(clamp(rCenter-rSpan*0.6,1,maxR));     rMax=Math.ceil (clamp(rCenter+rSpan*0.6,rMin+50,maxR)); }
  $('feedMin').value=fMin; $('feedMax').value=fMax; $('rpmMin').value=rMin; $('rpmMax').value=rMax;
}

/* ========== Resultados ========== */
function renderResults(A){
  const out=$('results'); out.innerHTML='';
  const s=document.createElement('div'); s.className='card';
  s.innerHTML=`<div style="font-weight:800">Resumen — ${A.mode}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
      <div class="muted">RPM</div><div class="result-value">${fmt(A.rpm,0)}</div>
      <div class="muted">Avance (mm/min)</div><div class="result-value">${fmt(A.feed_mm_min,2)}</div>
      <div class="muted">MRR (cm³/min)</div><div class="result-value">${fmt(A.mrr_cm3_min,3)}</div>
      <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
      <div class="muted">Par (N·m)</div><div class="result-value">${fmt(A.torque_Nm,2)}</div>
      <div class="muted">Ra estimado (µm)</div><div class="result-value">${fmt(A.ra_um,2)}</div>
    </div>`;
  out.appendChild(s);

  if($('enableCycle').checked){
    const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div style="font-weight:800">Tiempo & Coste</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">Tiempo/pieza (min)</div><div class="result-value">${fmt(A.time_min,2)}</div>
        <div class="muted">Costo/herr. p/pieza (USD)</div><div class="result-value">${fmt(A.tool_cost_per_piece,2)}</div>
      </div>`; out.appendChild(c);
  }
  if($('enableKc').checked){
    const k=document.createElement('div'); k.className='card'; k.innerHTML=`<div style="font-weight:800">Kc/Kte & Esfuerzo</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">Chip thickness (mm)</div><div class="result-value">${fmt(A.chip_h,4)}</div>
        <div class="muted">Kc(h) (N/mm²)</div><div class="result-value">${fmt(A.Kc_h,1)}</div>
        <div class="muted">F corte aprox (N)</div><div class="result-value">${fmt(A.Fc_N,0)}</div>
      </div>`; out.appendChild(k);
  }
  if($('enableStability').checked){
    const st=document.createElement('div'); st.className='card';
    const riskColor=A.vib.prob > CUTTING_DATA.vibration.risk_threshold ? '#e11d48' : (A.vib.prob>0.5 ? '#f59e0b' : '#10b981');
    st.innerHTML=`<div style="font-weight:800">Vibración</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">f_n (Hz)</div><div class="result-value">${fmt(A.f_n,1)}</div>
        <div class="muted">Excitación (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
        <div class="muted">Prob. riesgo</div><div class="result-value"><span style="display:inline-block;background:${riskColor};width:10px;height:10px;border-radius:999px;margin-right:6px"></span>${fmt(A.vib.prob,2)}</div>
      </div>`; out.appendChild(st);
  }

  // Indicador de límites disponibles a la condición actual
  const lim=availPowerTorque(A.rpm); const lims=document.createElement('div'); lims.className='card';
  const feedCap=spindleLimits().feedMax;
  const overP=A.power_kW>(lim.P_kW+1e-6), overT=A.torque_Nm>(lim.T_Nm+1e-6), overF=A.feed_mm_min>feedCap;
  lims.innerHTML=`<div style="font-weight:800">Límites máquina</div>
    <div class="muted">Max P: ${fmt(lim.P_kW,2)} kW · Max τ: ${fmt(lim.T_Nm,1)} N·m · Max feed: ${fmt(feedCap,0)} mm/min</div>
    <div class="muted" style="margin-top:6px">${overP||overT||overF ? 'Condición excede algún límite' : 'Condición dentro de límites'}</div>`;
  out.appendChild(lims);
}
function renderMachineDetails(){
  const id=$('machineSelect').value; const m=(CUTTING_DATA.machines||[]).find(x=>x.id===id);
  const out=$('machineDetails'); out.innerHTML=''; if(!m){out.innerHTML=`<div class="muted">Sin preset. Ajusta manual.</div>`;return;}
  out.innerHTML=`<div><strong>${m.brand} ${m.model}</strong></div>
    <div class="muted">Tipo: ${m.type}</div>
    <div class="muted">Potencia: ${m.power_kW} kW · RPM máx: ${m.max_rpm}</div>
    <div class="muted">Stickout def.: ${m.stickout_default} mm · Husillo: ${m.spindle}</div>`;
}

/* ========== Defaults de operación ========== */
function applyOperationDefaults(force=false){
  const op=(CUTTING_DATA.operations||[]).find(x=>x.id===$('operationSelect').value);
  const D=parseFloat($('diam')?.value)||12; if(!op) return;
  if(op.default_ae_pct && $('aePct') && (force || !$('aePct').dataset.userSet)){ $('aePct').value=Math.max(1,Math.round(op.default_ae_pct)); }
  if(op.default_ap_per_d && $('ap') && (force || !$('ap').dataset.userSet)){ $('ap').value=Math.max(0.01,Math.round((op.default_ap_per_d*D)*100)/100); }
  if(op.default_ap && $('apT') && (force || !$('apT').dataset.userSet)){ $('apT').value=op.default_ap; }
}

/* ========== Render principal ========== */
function render(){
  const modeT=$('modeT').classList.contains('is-on');
  if(!validateInputs()){
    $('results').innerHTML='<div class="card"><div style="font-weight:800">Revisa los campos marcados</div><div class="muted">Corrige errores para recalcular.</div></div>';
    renderMachineDetails(); return;
  }
  recommendVcFz(modeT?'torneado':'fresado');

  const A=modeT?computeTorneado():computeFresado();

  // Alertas suaves contra ventana
  (function(){
    const win=materialWindows(modeT?'torneado':'fresado');
    const vc_now=modeT?(+$('vcT').value||0):(+$('vc').value||0);
    const chip_now=modeT?(+$('fT').value||0):(+$('fz').value||0);
    const alerts=[];
    if(gradeValue(vc_now,win.vc_min,win.vc_max)==='err') alerts.push(`Vc fuera de ventana (${vc_now.toFixed(1)} vs ${win.vc_min.toFixed(0)}–${win.vc_max.toFixed(0)} m/min)`);
    if(gradeValue(chip_now,win.chip_min,win.chip_max)==='err') alerts.push(`Chip fuera de ventana (${chip_now.toFixed(3)} vs ${win.chip_min.toFixed(3)}–${win.chip_max.toFixed(3)})`);
    const res=$('results'); const box=document.createElement('div'); box.className='card'; box.style.marginBottom='10px';
    box.innerHTML=alerts.length?`<div style="font-weight:800;color:#fecaca">Alertas</div><div class="muted">${alerts.join(' · ')}</div>`:`<div class="muted">Sin alertas de ventana.</div>`;
    res.innerHTML=''; res.appendChild(box);
  })();

  adjustRangesToInclude(A);
  renderResults(A);
  renderMachineDetails();
  renderChart();
}

/* ========== Eventos ========== */
function wireEvents(){
  [
    'materialSelect','operationSelect','holderSelect','toolTypeSelect','levelSelect',
    'diam','z','vc','fz','aePct','ap','diamT','apT','vcT','fT','stickout','machineMaxRpm',
    'machineCost','toolCost','volumen','C','n','enableCycle','enableKc','enableStability',
    'machinePower','machineBaseRpm','machineFeedMax'
  ].forEach(id=>{
    const el=$(id); if(!el)return;
    el.addEventListener('input', ()=>{ if(['aePct','ap','apT','vc','fz','vcT','fT'].includes(id)) el.dataset.userSet='1'; render(); });
    el.addEventListener('change',()=>{ if(['aePct','ap','apT','vc','fz','vcT','fT'].includes(id)) el.dataset.userSet='1'; render(); });
  });

  ['operationSelect','diam'].forEach(id=>{
    const el=$(id); if(!el)return;
    el.addEventListener('change', ()=>{
      if($('aePct')) $('aePct').dataset.userSet='';
      if($('ap'))  $('ap').dataset.userSet='';
      if($('apT')) $('apT').dataset.userSet='';
      applyOperationDefaults(true); render();
    });
  });

  $('machineSelect').addEventListener('change', ()=>{
    const id=$('machineSelect').value; const m=(CUTTING_DATA.machines||[]).find(x=>x.id===id);
    if(m){
      $('machineModel').value=`${m.brand} ${m.model}`;
      $('machinePower').value=m.power_kW;
      $('machineMaxRpm').value=m.max_rpm;
      $('spindleType').value=m.spindle;
      $('stickout').value=m.stickout_default;
      $('stickoutDefault').value=m.stickout_default;
      $('machineCost').value=Math.max(10,Math.round(m.power_kW*1.8));
      // heurística para base_rpm
      if($('machineBaseRpm')) $('machineBaseRpm').value = Math.round(Math.min(m.max_rpm*0.15, 2500));
    } else { $('machineModel').value=''; }
    render();
  });

  $('modeF').addEventListener('click', ()=>{
    $('modeF').classList.add('is-on'); $('modeT').classList.remove('is-on');
    $('modeFresadoFields').style.display='block'; $('modeTorneadoFields').style.display='none';
    updateModeOptions('fresado'); render();
  });
  $('modeT').addEventListener('click', ()=>{
    $('modeT').classList.add('is-on'); $('modeF').classList.remove('is-on');
    $('modeFresadoFields').style.display='none'; $('modeTorneadoFields').style.display='block';
    updateModeOptions('torneado'); render();
  });

  ['feedMin','feedMax','rpmMin','rpmMax','thSafe'].forEach(id=>$(id).addEventListener('input',renderChart));
}

/* ========== Init ========== */
(function init(){
  ensureErrorSlots();
  populateFromData();
  updateModeOptions('fresado');
  applyOperationDefaults();
  wireEvents();
  render();
})();
</script>
</body>
</html>
