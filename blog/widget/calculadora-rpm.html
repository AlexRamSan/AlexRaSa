<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de RPM y avance — Pro v3</title>
  <meta name="description" content="RPM, avance, MRR, potencia, torque, deflexión, Ra y vibración con gráfica Gauss. Presets por material y máquina. Métrico/imperial." />
  <link rel="canonical" href="https://alexrasa.store/blog/calculadora-rpm-avance.html" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent:#0ea5e9; --rose:#e11d48; --emerald:#10b981; --indigo:#6366f1;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7fafc; --card:#ffffff; --ink:#0b1220; --muted:#475569; --border:#d4dbe5; --accent:#2563eb; }
    }
    body{background:var(--bg);color:var(--ink)}
    .container{max-width:1180px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .lead{color:var(--muted)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);padding:.6rem .9rem;border-radius:10px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
    .tab{padding:.6rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(148,163,184,.08)}
    .tab.is-on{background:var(--accent);border-color:var(--accent);color:#061018}
    .field>label{display:block;font-size:.75rem;color:var(--muted);margin-bottom:.25rem}
    .field>input,.field>select{width:100%;border-radius:10px;padding:.6rem .7rem;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--ink)}
    .kpi{font-weight:700}
    .kpi-value{font-size:1.35rem;color:#eaf2ff;text-shadow:0 0 0.5px #a5c3ff,0 0 12px rgba(56,189,248,.35)}
    .pill{font-size:.7rem;border:1px solid var(--border);border-radius:999px;padding:.12rem .5rem;color:var(--muted)}
    .vibe-box{background:rgba(148,163,184,.08);border:1px dashed var(--border);border-radius:12px;padding:16px;transition:background .18s,border-color .18s}
    .vibe-box.ok   { border-color:#16a34a; background:rgba(22,163,74,.08) }
    .vibe-box.warn { border-color:#f59e0b; background:rgba(245,158,11,.10) }
    .vibe-box.bad  { border-color:#ef4444; background:rgba(239,68,68,.10) }
    .badge{font-size:.72rem;border-radius:999px;padding:.15rem .5rem;border:1px solid var(--border)}
    .badge.ok{background:#052e1b;color:#86efac;border-color:#166534}
    .badge.warn{background:#3a2801;color:#fde68a;border-color:#b45309}
    .badge.bad{background:#3b0a0a;color:#fecaca;border-color:#b91c1c}
    .hint{color:var(--muted);font-size:.75rem}
  </style>
</head>
<body>
  <section class="relative">
    <div class="absolute inset-0 -z-10">
      <div class="absolute inset-0 bg-[url('/assets/hero-industrial.png')] bg-cover bg-center opacity-70"></div>
      <div class="absolute inset-0 bg-slate-900/60"></div>
    </div>
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">Calculadora de <span class="text-sky-300">RPM</span> y <span class="text-sky-300">avance</span> · Pro v3</h1>
      <p class="lead mt-2">Presets por material/máquina, unidades por campo y gráfica Gauss de vibración.</p>
    </div>
  </section>

  <main class="container mx-auto px-4 pb-24">
    <section class="card p-5 mt-6">
      <div class="flex flex-wrap gap-3 items-center">
        <div class="flex gap-2">
          <button id="uMetric" class="tab is-on" type="button">Métrico</button>
          <button id="uImperial" class="tab" type="button">Imperial</button>
        </div>
        <div class="flex gap-2 ml-auto">
          <button id="modeSimple" class="tab is-on" type="button">Simple</button>
          <button id="modeAdv" class="tab" type="button">Avanzado</button>
        </div>
      </div>

      <!-- Presets -->
      <div class="grid md:grid-cols-4 gap-3 mt-4">
        <div class="field md:col-span-2">
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div class="field">
          <label>Operación</label>
          <select id="operation">
            <option value="rough">Desbaste</option>
            <option value="finish">Acabado</option>
            <option value="adaptive">Adaptativo</option>
            <option value="slot">Ranurado</option>
          </select>
        </div>
        <div class="field">
          <label>Máquina</label>
          <select id="machine"></select>
          <div class="text-xs text-slate-400 mt-1" id="machineMeta"></div>
        </div>
      </div>
      <div class="grid md:grid-cols-[1fr_auto] gap-3 mt-3 items-end">
        <button id="apply" class="btn">Aplicar preset</button>
        <div id="matBadge" class="justify-self-end text-xs text-slate-400"></div>
      </div>
      <div class="mt-2 text-sm"><span id="matNotes"></span></div>

      <!-- Entradas -->
      <div class="grid md:grid-cols-3 gap-3 mt-5">
        <div class="field">
          <label>Diámetro herramienta (<span id="u_diam">mm</span>)</label>
          <input id="diam" type="number" step="0.001" placeholder="">
        </div>
        <div class="field">
          <label>Filos (z)</label>
          <input id="flutes" type="number" min="1" step="1" value="3">
        </div>
        <div class="field">
          <label>Límite de RPM de máquina (<span id="u_rpm">rpm</span>)</label>
          <input id="rpmLimit" type="number" step="1" placeholder="">
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="field">
          <label>Velocidad de corte Vc (<span id="u_vc">m/min</span>)</label>
          <input id="vc" type="number" step="0.1" placeholder="">
        </div>
        <div class="field">
          <label>Chip por diente f<sub>z</sub> (<span id="u_fz">mm</span>)</label>
          <input id="fz" type="number" step="0.001" placeholder="">
        </div>
        <div class="field">
          <label>Factor prudencia F</label>
          <input id="prudence" type="number" step="0.01" placeholder="0.7–1.0">
        </div>
      </div>

      <!-- Avanzado -->
      <div id="advZone" class="grid md:grid-cols-4 gap-3 mt-4 hidden">
        <div class="field">
          <label>Step over a<sub>e</sub> (<span id="u_ae">%D</span>)</label>
          <input id="aePct" type="number" step="1" placeholder="">
        </div>
        <div class="field">
          <label>Profundidad a<sub>p</sub> (<span id="u_ap">mm</span>)</label>
          <input id="ap" type="number" step="0.01" placeholder="">
        </div>
        <div class="field">
          <label>Longitud expuesta L (<span id="u_stickout">mm</span>)</label>
          <input id="stickout" type="number" step="0.1" placeholder="">
        </div>
        <div class="field">
          <label>Holder</label>
          <select id="holder"></select>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mt-4">
        <button id="calcBtn" class="btn btn-primary">Calcular</button>
        <button id="resetBtn" class="btn">Reiniciar</button>
      </div>

      <!-- Resultados KPI -->
      <div class="grid md:grid-cols-3 gap-4 mt-6">
        <div class="bg-black/20 rounded-lg p-4">
          <div class="kpi">RPM teórico</div>
          <div class="kpi-value" id="rpmOut">—</div>
          <div id="rpmCap" class="text-xs text-amber-300 mt-1 hidden">Limitado por máquina</div>
        </div>
        <div class="bg-black/20 rounded-lg p-4">
          <div class="kpi">Avance programado</div>
          <div class="kpi-value"><span id="feedOut">—</span> <span id="feedUnit" class="text-slate-400 text-base align-middle">mm/min</span></div>
          <div class="text-xs" id="feedAdjNote"></div>
        </div>
        <div class="bg-black/20 rounded-lg p-4">
          <div class="kpi">Resumen</div>
          <div class="text-sm text-slate-300 mt-1" id="sumOut">Ingresa datos y calcula.</div>
        </div>
      </div>

      <!-- Gráfica Gauss + estado -->
      <div class="grid md:grid-cols-[2fr_1fr] gap-4 mt-6 items-center">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Distribución de vibración (Gauss)</div>
            <div class="text-xs text-slate-400">μ≈sweet spot · σ configurable</div>
          </div>
          <canvas id="gaussChart" height="120"></canvas>
        </div>
        <div class="vibe-box">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Vibración estimada</h3>
            <span class="pill">Auto con tu entrada</span>
          </div>
          <div class="grid md:grid-cols-1 gap-3 items-end">
            <div class="field">
              <label>Tipo de sujeción</label>
              <select id="holder2"></select>
            </div>
            <div class="text-sm" id="vibeInfo">L/D, ae y ap se estiman del diámetro y la operación.</div>
          </div>
          <p class="text-sm mt-2" id="vibeMsg"></p>
          <div class="text-xs hint" id="avoidBandNote"></div>
        </div>
      </div>

      <!-- Referencia rápida -->
      <div class="mt-6 text-sm text-slate-300" id="refQuick"></div>
    </section>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt0 = (n)=>Number.isFinite(n)?Math.round(n).toLocaleString('es-MX'):'—';
    const fmt1 = (n)=>Number.isFinite(n)?(Math.round(n*10)/10).toLocaleString('es-MX'):'—';
    const fmt2 = (n)=>Number.isFinite(n)?(Math.round(n*100)/100).toLocaleString('es-MX'):'—';

    let DATA={materials:[], holders:[], vibration:{}, defaults:{}, machine_profiles:[], ui_unit_labels:{}, conversion:{}},
        units='metric', adv=false, chart=null, gauss={mu:0.75, sigma:0.20};

    async function loadData(){
      const sources=['/data/cutting-data.json'];
      for(const url of sources){
        try{ const r=await fetch(url,{cache:'no-store'}); if(r.ok){ DATA=await r.json(); break; } }catch(_){}
      }
      if(!DATA.ui_unit_labels){
        DATA.ui_unit_labels={ metric:{diam:'mm',fz:'mm',ap:'mm',stickout:'mm',ae_percent:'%D',vc:'m/min',feed:'mm/min',rpm:'rpm',power:'kW',torque:'N·m',mrr:'cm³/min',ra:'µm'},
                              imperial:{diam:'in',fz:'in',ap:'in',stickout:'in',ae_percent:'%D',vc:'SFM',feed:'IPM',rpm:'rpm',power:'hp',torque:'lbf·ft',mrr:'in³/min',ra:'µin'} };
      }
      if(DATA.defaults?.vibe_gauss){ gauss = DATA.defaults.vibe_gauss; }
    }

    function applyUnitLabels(){
      const L=DATA.ui_unit_labels?.[units]||DATA.ui_unit_labels?.metric;
      $('u_diam').textContent = L.diam; $('u_fz').textContent=L.fz; $('u_ap').textContent=L.ap; $('u_stickout').textContent=L.stickout;
      $('u_ae').textContent = L.ae_percent; $('u_vc').textContent=L.vc; $('u_rpm').textContent=L.rpm;
      $('feedUnit').textContent = (units==='metric') ? 'mm/min' : 'IPM';
    }

    function fillSelectors(){
      // materiales
      const sel=$('material'); sel.innerHTML='';
      (DATA.materials?.length?DATA.materials:[{id:'alu_6061',name:'Aluminio 6061-T6'}]).forEach(m=>{
        sel.insertAdjacentHTML('beforeend',`<option value="${m.id}">${m.name}</option>`);
      });
      // holders
      const h1=$('holder'), h2=$('holder2'); h1.innerHTML=''; h2.innerHTML='';
      (DATA.holders||[]).forEach(h=>{
        h1.insertAdjacentHTML('beforeend',`<option value="${h.id}">${h.label}</option>`);
        h2.insertAdjacentHTML('beforeend',`<option value="${h.id}">${h.label}</option>`);
      });
      // machines
      const mach=$('machine'); mach.innerHTML='';
      (DATA.machine_profiles||[]).forEach(m=>{
        mach.insertAdjacentHTML('beforeend',`<option value="${m.id}">${m.brand} ${m.name} • ${m.type} • ${m.axes} ejes</option>`);
      });
      if(DATA.defaults?.rpm_limit) $('rpmLimit').value = DATA.defaults.rpm_limit;
      if(DATA.defaults?.stickout_mm) $('stickout').value = DATA.defaults.stickout_mm;
      if(DATA.defaults?.ae_percent) $('aePct').value = DATA.defaults.ae_percent;
      if(DATA.defaults?.ap_mm) $('ap').value = DATA.defaults.ap_mm;
      $('prudence').value = DATA.defaults?.prudence ?? 0.9;
      $('machineMeta').textContent = machineMetaText(getMachine());
      const mat=getMaterial(); $('matNotes').textContent = mat?.notes || ''; $('matBadge').textContent = mat ? `ID: ${mat.id}` : '';
    }

    function getMaterial(){ const id=$('material').value; return (DATA.materials||[]).find(m=>m.id===id)||null; }
    function getMachine(){ const id=$('machine').value; return (DATA.machine_profiles||[]).find(m=>m.id===id)||null; }

    function setUnits(u){
      units=u;
      $('uMetric').classList.toggle('is-on', u==='metric');
      $('uImperial').classList.toggle('is-on', u==='imperial');
      applyUnitLabels();
    }
    function setMode(a){
      adv=a; $('modeSimple').classList.toggle('is-on', !a); $('modeAdv').classList.toggle('is-on', a);
      $('advZone').classList.toggle('hidden', !a);
    }

    function machineMetaText(m){
      if(!m) return '';
      return `${m.brand||''} ${m.name||''} — ${m.type||''}, ${m.axes||3} ejes | ${m.rpm_max||'?'} rpm, ${m.power_kw||'?'} kW, ${m.torque_nm||'?'} N·m`;
    }

    function diaBucketFz(mat, Dmm, op){
      if(!mat?.fz_mm) return null;
      const arr=[...mat.fz_mm].sort((a,b)=>a.dia_max_mm-b.dia_max_mm);
      let picked = arr.find(b=>Dmm<=b.dia_max_mm) || arr[arr.length-1];
      const range = picked?.[op] || picked?.[op==='finish'?'finish':'rough'];
      return Array.isArray(range)?range:null;
    }

    function applyPreset(){
      const mat=getMaterial(); const op=$('operation').value; const D=parseFloat($('diam').value)||10; $('diam').value=D;
      const vcRange = mat?.vc_m_min?.[op] || [100,200];
      const fzRange = diaBucketFz(mat, (units==='metric'?D:(D*25.4)), op) || [0.03,0.08];
      if(units==='metric'){
        $('vc').value = Math.round((vcRange[0]+vcRange[1])/2);
        $('fz').value = ((fzRange[0]+fzRange[1])/2).toFixed(3);
      }else{
        const sfmMid = ((vcRange[0]+vcRange[1])/2)*3.28084;
        $('vc').value = Math.round(sfmMid);
        $('fz').value = (((fzRange[0]+fzRange[1])/2)/25.4).toFixed(3);
      }
      $('refQuick').innerHTML = mat ? `<div class="card p-3">
        <div class="font-semibold mb-1">Referencia rápida</div>
        <div class="text-sm">
          <div>${mat.name}</div>
          <div>Desbaste: ${mat.vc_m_min?.rough?.join('–')} m/min | Acabado: ${mat.vc_m_min?.finish?.join('–')} m/min</div>
        </div></div>` : '';
      $('machineMeta').textContent = machineMetaText(getMachine());
      const mat2=getMaterial(); $('matNotes').textContent = mat2?.notes || ''; $('matBadge').textContent = mat2 ? `ID: ${mat2.id}` : '';
    }

    // ===== Gauss utilities
    function pdf(x, mu, sigma){
      const a = 1/(sigma*Math.sqrt(2*Math.PI));
      const e = Math.exp(-0.5*Math.pow((x-mu)/sigma,2));
      return a*e;
    }
    function buildGaussData(mu, sigma){
      const xs=[], ys=[]; const min=0, max=1.8, steps=200;
      for(let i=0;i<=steps;i++){ const x = min + (max-min)*i/steps; xs.push(x); ys.push(pdf(x, mu, sigma)); }
      return {xs, ys};
    }
    let chart=null;
    function renderGauss(currentRisk=0.7){
      const ctx = $('gaussChart').getContext('2d');
      const g = buildGaussData(0.75, 0.20);
      if(chart){ chart.destroy(); }
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: g.xs, datasets: [{ label: 'Gauss', data: g.ys, fill: true, tension: 0.2, borderWidth: 1 }] },
        options: {
          responsive: true,
          plugins: { legend:{display:false}, tooltip:{callbacks:{ label:(c)=>`f(x)=${c.formattedValue}` }} },
          scales: {
            x: { title:{display:true,text:'Índice de riesgo (0=estable, >1=vibra)'}, ticks:{ callback:(v)=>g.xs[v]?g.xs[v].toFixed(2):'' } },
            y: { display:false }
          }
        }
      });
      const xScale = chart.scales.x, yScale = chart.scales.y;
      const x = xScale.getPixelForValue(currentRisk);
      const ctx2 = chart.ctx; ctx2.save(); ctx2.strokeStyle = '#f59e0b'; ctx2.lineWidth = 2; ctx2.beginPath(); ctx2.moveTo(x, yScale.top); ctx2.lineTo(x, yScale.bottom); ctx2.stroke(); ctx2.restore();
    }

    function estimateVibeParams(Dmm, op){
      const stick = parseFloat($('stickout').value) || 25;
      const L = Math.max(stick, (op==='finish' ? 2.0 : 3.0)*Dmm);
      const ae_pct = (op==='finish') ? 12 : (op==='adaptive'?25:30);
      const ap_mm = parseFloat($('ap').value) || Math.min((op==='finish'?0.2:0.5)*Dmm, Math.max(Dmm, 5));
      return { L, ae_pct, ap_mm };
    }

    function chipThinningAdjustedFz(fz_mm, Dmm, ae_pct){
      const ae = Math.max(0.01, Math.min(0.95, ae_pct/100));
      if(ae >= 0.5) return {fzEff:fz_mm, k:1};
      const phi_m = Math.acos(Math.max(-1, Math.min(1, 1 - 2*ae)));
      const k = 1/Math.max(0.3, Math.sin(phi_m));
      return { fzEff: fz_mm * k, k };
    }

    function calc(){
      const D = parseFloat($('diam').value);
      const z = parseInt($('flutes').value,10);
      let rpmLimit = parseFloat($('rpmLimit').value||'0');
      const prud = parseFloat($('prudence').value||'1');
      const V = parseFloat($('vc').value);
      let FZ = parseFloat($('fz').value);
      const op = $('operation').value;
      const mach = getMachine();
      if(mach?.rpm_max && !rpmLimit) rpmLimit = mach.rpm_max;
      if(!(D>0 && z>0 && V>0 && FZ>0)){ $('rpmOut').textContent='—'; $('feedOut').textContent='—'; $('vibeMsg').textContent='Faltan datos.'; return; }
      const Dmm = (units==='metric') ? D : D*25.4;
      const Vc_m_min = (units==='metric') ? V : (V/3.28084);
      let fz_mm = (units==='metric') ? FZ : FZ*25.4;

      let aePct = Number(parseFloat($('aePct').value));
      if(!Number.isFinite(aePct) || aePct<=0){ aePct = estimateVibeParams(Dmm,op).ae_pct; }
      const {fzEff, k:ctK} = chipThinningAdjustedFz(fz_mm, Dmm, aePct);
      const usedFz = fzEff;
      $('feedAdjNote').textContent = ctK>1 ? `Chip-thinning ×${fmt2(ctK)} (ae=${Math.round(aePct)}%D)` : '';

      let rpm = (Vc_m_min*1000)/(Math.PI*Dmm);
      let capped=false; if(rpmLimit>0 && rpm>rpmLimit){ rpm=rpmLimit; capped=true; }
      let feed_mm_min = rpm * z * usedFz * (Number.isFinite(prud) ? prud : 1);

      $('rpmOut').textContent = fmt0(rpm);
      $('feedOut').textContent = (units==='metric') ? fmt0(feed_mm_min) : fmt1(feed_mm_min/25.4);
      $('rpmCap').classList.toggle('hidden', !capped);
      $('sumOut').textContent = `D=${fmt1(D)} ${(units==='metric')?'mm':'in'}, z=${z}, Vc=${fmt1(V)} ${(units==='metric')?'m/min':'SFM'}, fz=${fmt2(FZ)} ${(units==='metric')?'mm':'in'}.`;

      const holderId = $('holder2').value || $('holder').value;
      const holder = (DATA.holders||[]).find(h=>h.id===holderId) || (DATA.holders||[])[0];
      const est = estimateVibeParams(Dmm, op);
      const ae_ratio = Math.max(0.01, Math.min(1, (aePct/100)));
      const ap_mm = Number.isFinite(parseFloat($('ap').value)) && parseFloat($('ap').value)>0 ? parseFloat($('ap').value) : est.ap_mm;
      const L_mm  = Number.isFinite(parseFloat($('stickout').value)) && parseFloat($('stickout').value)>0 ? parseFloat($('stickout').value) : est.L;
      $('vibeInfo').innerHTML = `L=${fmt1(L_mm)} mm · ae≈${Math.round(ae_ratio*100)}%D · ap≈${fmt1(ap_mm)} mm`;

      const W = DATA.vibration?.weights || {ld:0.55,ae:0.20,ap:0.15,fz:0.10};
      const stiff = holder?.stiffness_factor || 1.0; const L_over_D = L_mm / Dmm; const ap_ratio = Math.min(1.2, ap_mm/Math.max(1,Dmm));
      let risk = ( W.ld*(L_over_D/2.0) + W.ae*ae_ratio + W.ap*ap_ratio + W.fz*Math.min(1, usedFz/(0.1*Dmm+0.02)) ) / stiff;
      risk = Math.max(0, Math.min(1.8, risk));

      const band = DATA.vibration?.avoid_band_hz || [600,900];
      const toothHz = (rpm * z)/60;
      const inBand = (toothHz >= band[0] && toothHz <= band[1]);
      const SWEET=0.65, WARN=1.00; let state='ok'; if (risk >= WARN || inBand) state='bad'; else if (risk >= SWEET) state='warn';
      const vb = document.querySelector('.vibe-box'); vb.classList.remove('ok','warn','bad'); vb.classList.add(state);
      const badge = `<span class="badge ${state}">${state==='ok'?'Sweet spot':state==='warn'?'Atento':'Vibra'}</span>`;
      let msg = `${badge} · L/D=${fmt2(L_over_D)} · ${holder?.label||'N/A'} · f<sub>tp</sub>=${fmt1(toothHz)} Hz · riesgo=${fmt2(risk)}.`;
      if(state==='bad' && inBand){
        const shift = DATA.vibration?.rpm_shift_pct || 0.12;
        const targetHz = (Math.abs(toothHz-band[0]) < Math.abs(toothHz-band[1])) ? band[0] : band[1];
        let rpmAlt = (targetHz * 60) / z; rpmAlt *= (toothHz < targetHz ? (1+shift) : (1-shift));
        msg += ` Salir de banda → objetivo ${Math.round(targetHz)} Hz (ajusta RPM ±${Math.round(shift*100)}%).`;
      }
      $('vibeMsg').innerHTML = msg;
      $('avoidBandNote').textContent = `Evitar banda ${band[0]}–${band[1]} Hz`;

      renderGauss(risk);
    }

    function resetAll(){
      document.querySelectorAll('input').forEach(i=>i.value='');
      $('flutes').value=3; $('feedAdjNote').textContent='';
      $('rpmOut').textContent='—'; $('feedOut').textContent='—'; $('sumOut').textContent='Ingresa datos y calcula.'; $('vibeMsg').textContent='';
      $('rpmCap').classList.add('hidden'); renderGauss(0.75);
      applyPreset();
      const vb = document.querySelector('.vibe-box'); vb.classList.remove('ok','warn','bad');
    }

    (async function(){
      await loadData();
      applyUnitLabels();
      fillSelectors();
      $('uMetric').addEventListener('click',()=>{ setUnits('metric'); applyPreset(); });
      $('uImperial').addEventListener('click',()=>{ setUnits('imperial'); applyPreset(); });
      $('modeSimple').addEventListener('click',()=>setMode(false));
      $('modeAdv').addEventListener('click',()=>setMode(true));
      $('apply').addEventListener('click',()=>{ applyPreset(); calc(); });
      $('calcBtn').addEventListener('click',calc);
      $('resetBtn').addEventListener('click',resetAll);
      ['material','operation','holder','holder2','machine'].forEach(id=>$(id)?.addEventListener('change',()=>{ applyPreset(); }));
      setUnits('metric'); setMode(false); applyPreset(); renderGauss(0.75);
    })();
  </script>
</body>
</html>
