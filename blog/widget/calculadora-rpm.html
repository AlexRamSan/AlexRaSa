<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora de RPM y Avance (AlexRaSa)</title>
<meta name="color-scheme" content="dark" />
<link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#0b1220;--card:#0f172a;--ink:#e5eefb;--muted:#9fb3c8;--border:#1f2a3a;--accent:#0ea5e9;--rose:#e11d48;--emerald:#10b981}
html{scroll-behavior:smooth}body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu;margin:0}
.container{max-width:1180px;margin:0 auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.lead{color:var(--muted)}
.btn{border:1px solid var(--border);background:rgba(255,255,255,.04);padding:.5rem .8rem;border-radius:8px}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
.field>label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:.25rem}
.field>input,.field>select{width:100%;border-radius:8px;padding:.5rem .6rem;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--ink)}
.grid-2{display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start}
.grid-forms{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.section-title{font-weight:700;color:var(--accent);margin-bottom:8px}
.sidebar{width:420px;min-width:320px}
.canvas-wrap{width:100%;height:160px}
.canvas-wrap canvas{width:100%;height:100%}
.legend-dot{display:inline-block;width:12px;height:8px;border-radius:3px;margin-right:6px;vertical-align:middle}
@media(max-width:1100px){.grid-2{grid-template-columns:1fr}.sidebar{width:100%}.grid-forms{grid-template-columns:1fr}}
.muted{color:var(--muted)}
.result-value{font-weight:700;color:var(--ink)}
</style>
</head>
<body>
<header class="sticky top-0 z-50 bg-black/40 backdrop-blur border-b border-gray-200">
  <div class="max-w-6xl mx-auto px-4">
    <div style="height:64px;display:flex;align-items:center;justify-between">
      <a href="/" class="flex items-center gap-2"><img src="/assets/logo.png" alt="Logo" style="height:40px"/></a>
      <nav class="hidden lg:flex gap-6 text-sm"><a href="/">Inicio</a><a href="/#soluciones">Soluciones</a></nav>
    </div>
  </div>
</header>

<section class="py-8 text-white">
  <div class="max-w-6xl mx-auto px-4">
    <h1 style="font-size:1.6rem;font-weight:800">Calculadora de <span style="color:var(--accent)">RPM y Avance</span></h1>
    <p class="lead mt-2">Estimaciones de condiciones de corte, potencia y riesgo de vibración. Todo usando datos embebidos.</p>
  </div>
</section>

<main class="container">
  <div class="grid-2">
    <!-- Inputs -->
    <div>
      <div class="card mb-4" style="display:flex;justify-content:space-between;align-items:center">
        <div><h2 style="margin:0;font-weight:800">Entradas</h2><div class="lead">Presets y parámetros</div></div>
        <div style="display:flex;gap:8px"><button id="modeF" class="tab is-on">Fresado</button><button id="modeT" class="tab">Torneado</button></div>
      </div>

      <div class="grid-forms">
        <div class="card">
          <div class="section-title">Parámetros principales</div>
          <div style="display:grid;gap:8px">
            <div class="field"><label>Material</label><select id="materialSelect"></select></div>
            <div class="field"><label>Operación</label><select id="operationSelect"></select></div>
            <div class="field"><label>Sujeción / Holder</label><select id="holderSelect"></select></div>
            <div class="field"><label>Tipo herramienta</label><select id="toolTypeSelect"></select></div>

            <div id="modeFresadoFields">
              <div class="field"><label>Diámetro herramienta D (mm)</label><input id="diam" type="number" step="0.01" value="12" /></div>
              <div class="field"><label>Dientes (z)</label><input id="z" type="number" step="1" value="4" /></div>
              <div class="field"><label>Vel. corte Vc (m/min)</label><input id="vc" type="number" step="0.1" value="180" /></div>
              <div class="field"><label>fz (mm/tooth)</label><input id="fz" type="number" step="0.0001" value="0.06" /></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div class="field"><label>Ae (mm)</label><input id="ae" type="number" step="0.01" value="10" /></div>
                <div class="field"><label>Ap (mm)</label><input id="ap" type="number" step="0.01" value="2" /></div>
              </div>
            </div>

            <div id="modeTorneadoFields" style="display:none">
              <div class="field"><label>Diámetro pieza D (mm)</label><input id="diamT" type="number" step="0.01" value="60" /></div>
              <div class="field"><label>Prof. corte ap (mm)</label><input id="apT" type="number" step="0.01" value="2" /></div>
              <div class="field"><label>Vc (m/min)</label><input id="vcT" type="number" step="0.1" value="120" /></div>
              <div class="field"><label>Avance f (mm/rev)</label><input id="fT" type="number" step="0.001" value="0.15" /></div>
            </div>

            <div class="field"><label>Stickout L (mm)</label><input id="stickout" type="number" step="1" value="60" /></div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Costos & Opciones</div>
          <div style="display:grid;gap:8px">
            <div class="field"><label>Costo hora máquina (USD)</label><input id="machineCost" type="number" step="0.1" value="20" /></div>
            <div class="field"><label>Costo herramienta (USD)</label><input id="toolCost" type="number" step="0.1" value="60" /></div>
            <div class="field"><label>Volumen a remover (cm³)</label><input id="volumen" type="number" step="0.01" value="18" /></div>
            <div class="field"><label>Constante Taylor C</label><input id="C" type="number" step="1" value="40000" /></div>
            <div class="field"><label>Exponente n (Taylor)</label><input id="n" type="number" step="0.01" value="0.25" /></div>
            <div style="display:flex;gap:8px;align-items:center">
              <label style="font-size:.85rem"><input id="enableCycle" type="checkbox" checked /> <span class="muted">Tiempo</span></label>
              <label style="font-size:.85rem"><input id="enableKc" type="checkbox" checked /> <span class="muted">Kc/Pot.</span></label>
              <label style="font-size:.85rem"><input id="enableStability" type="checkbox" checked /> <span class="muted">Vibración</span></label>
            </div>
            <div class="field"><label>Exponente m (desgaste Kc(h))</label><input id="mexp" type="number" step="0.001" value="0.2" /></div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Parámetros de máquina</div>
          <div style="display:grid;gap:8px">
            <div class="field"><label>Máquina (preset)</label><select id="machineSelect"><option value="custom">— Seleccionar máquina —</option></select></div>
            <div class="field"><label>Marca / Modelo</label><input id="machineModel" type="text" /></div>
            <div class="field"><label>Potencia husillo (kW)</label><input id="machinePower" type="number" step="0.1" value="15" /></div>
            <div class="field"><label>RPM máx</label><input id="machineMaxRpm" type="number" step="1" value="10000" /></div>
            <div class="field"><label>Tipo de husillo</label><input id="spindleType" type="text" value="HSK63" /></div>
            <div class="field"><label>E aproximado (GPa)</label><input id="E" type="number" step="1" value="210" /></div>
            <div class="field"><label>Stickout por defecto (mm)</label><input id="stickoutDefault" type="number" step="1" value="60" /></div>
            <div class="hint">Presets en <code>CUTTING_DATA.machines</code> (embebido).</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card">
        <div class="section-title">Resultados</div>
        <div id="results" style="margin-top:8px"></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnExportPdf" class="btn btn-primary" style="flex:1">Exportar PDF</button>
          <button id="btnExportCsv" class="btn" style="flex:1">Exportar CSV</button>
        </div>

        <div style="margin-top:12px" class="card">
          <div class="section-title">Ajuste de Rango (gráfica)</div>
          <div style="display:grid;gap:8px">
            <div class="field"><label>Avance min (mm/min)</label><input id="feedMin" type="number" step="1" value="200" /></div>
            <div class="field"><label>Avance max (mm/min)</label><input id="feedMax" type="number" step="1" value="2200" /></div>
            <div class="field"><label>RPM min</label><input id="rpmMin" type="number" step="10" value="200" /></div>
            <div class="field"><label>RPM max</label><input id="rpmMax" type="number" step="10" value="10000" /></div>
            <div class="hint">Ajusta aquí los ejes de la gráfica combinada.</div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Combined chart area -->
  <section style="margin-top:18px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0;font-weight:800">Campana de Vibración & Gráficos</h3>
          <div class="muted">Gráfica única: eje X = Avance (mm/min), eje Y = RPM. Puntos coloreados por prob. vib. Banda 600–900 Hz (convertida a RPM según z).</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div style="display:flex;align-items:center"><span class="legend-dot" style="background:#10b981"></span><span class="muted">Seguro</span></div>
          <div style="display:flex;align-items:center"><span class="legend-dot" style="background:#f59e0b"></span><span class="muted">Advertencia</span></div>
          <div style="display:flex;align-items:center"><span class="legend-dot" style="background:#e11d48"></span><span class="muted">Riesgo</span></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px">
        <div style="height:560px"><canvas id="combinedChart"></canvas></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="card"><div class="section-title">Indicadores</div><div id="indicators" style="display:grid;gap:8px"></div></div>
          <div class="card"><div class="section-title">MRR (tendencia)</div><div class="canvas-wrap"><canvas id="chartMRR"></canvas></div></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div class="card"><div class="section-title">Tendencia Vibración</div><div class="canvas-wrap"><canvas id="chartVibTrend"></canvas></div></div>
        <div class="card"><div class="section-title">Detalles Máquina / Herramienta</div><div id="machineDetails" style="margin-top:8px"></div></div>
      </div>
    </div>
  </section>
</main>

<script>
/* ---------------- utils / datos embebidos ---------------- */
const $ = id => document.getElementById(id);
function fmt(n,dec=2){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec}); }

const CUTTING_DATA = (function(){ /* EMBEDDED copy (compact) */
  return {
    "defaults":{"rpm_limit":24000,"efficiency":0.8,"vibe_gauss":{"mu":0.7,"sigma":0.18},"default_flutes":4},
    "vibration":{"avoid_band_hz":[600,900],"risk_threshold":0.8,"weights":{"ld":0.5,"ae":0.2,"ap":0.2,"fz":0.1}},
    "holders":[{"id":"ER_Collet","label":"Portapinzas ER","stiffness_factor":1.00},{"id":"REGOFIX_powRgrip","label":"REGO-FIX powRgrip","stiffness_factor":1.45},{"id":"ShrinkFit","label":"Shrink-fit","stiffness_factor":1.60},{"id":"HydraulicChuck","label":"Mandril hidráulico","stiffness_factor":1.50},{"id":"PowerChuck","label":"Power chuck","stiffness_factor":1.30},{"id":"SteadyRest","label":"Steady rest / soporte","stiffness_factor":0.90},{"id":"PortaInsertos","label":"Porta-insertos","stiffness_factor":1.15},{"id":"ColletChuck","label":"Collet chuck","stiffness_factor":1.05},{"id":"FaceMillAdapter","label":"Adaptador para face mill","stiffness_factor":1.10},{"id":"ModularHolder","label":"Portaherramientas modular","stiffness_factor":1.00},{"id":"BoringBarHolder","label":"Porta barra / boring bar","stiffness_factor":1.08},{"id":"LiveToolHolder","label":"Porta-herramienta rotativa (live tool)","stiffness_factor":1.20},{"id":"ThreadingHolder","label":"Porta-herram. roscado","stiffness_factor":1.00},{"id":"TurretToolHolder","label":"Porta torreta (torneado)","stiffness_factor":1.15}],
    "materials":[{ "id":"alu_6061","name":"Aluminio 6061","Kc_N_per_mm2":800,"taylor": {"C":1000,"n":0.12}},{ "id":"steel_1018","name":"Acero 1018","Kc_N_per_mm2":1200,"taylor":{"C":5000,"n":0.18}},{ "id":"inox_304","name":"Inox 304","Kc_N_per_mm2":2200,"taylor":{"C":200,"n":0.18}},{ "id":"copper","name":"Cobre / Latón","Kc_N_per_mm2":600,"taylor":{"C":2000,"n":0.12}},{ "id":"ti_64","name":"Titanio Ti-6Al-4V","Kc_N_per_mm2":1200,"taylor":{"C":150,"n":0.18}}],
    "operations":[{"id":"rough","label":"Desbaste","default_ae_pct":30,"default_ap_per_d":0.5},{"id":"finish","label":"Acabado","default_ae_pct":12,"default_ap_per_d":0.2}],
    "tool_types":[{"id":"endmill","label":"Fresa (Endmill)","vc_factor":1.00,"fz_factor":1.00,"default_flutes":4},{"id":"ballnose","label":"Fresa hemisférica","vc_factor":0.90,"fz_factor":0.90,"default_flutes":4},{"id":"indexable","label":"Fresa indexable","vc_factor":1.15,"fz_factor":1.30,"default_flutes":2},{"id":"turn_insert","label":"Herram. torneado (insertos)","vc_factor":1.00,"fz_factor":1.00,"default_flutes":1}],
    "machines":[{ "id":"haas_vf2","brand":"Haas","model":"VF-2","type":"VMC","power_kW":15,"max_rpm":10000,"stickout_default":70,"spindle":"BT40"},{ "id":"doosan_vmc","brand":"Doosan","model":"DNM4500 VMC","type":"VMC","power_kW":15,"max_rpm":10000,"stickout_default":60,"spindle":"HSK63"}]
  };
})();

/* ----------------- populate selects ----------------- */
function populateFromData(){
  const mSel = $('materialSelect'); mSel.innerHTML=''; (CUTTING_DATA.materials||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.name; mSel.appendChild(o);});
  const oSel = $('operationSelect'); oSel.innerHTML=''; (CUTTING_DATA.operations||[]).forEach(op=>{ const o=document.createElement('option'); o.value=op.id; o.textContent=op.label; oSel.appendChild(o);});
  const hSel = $('holderSelect'); hSel.innerHTML=''; (CUTTING_DATA.holders||[]).forEach(h=>{ const o=document.createElement('option'); o.value=h.id; o.textContent=h.label; hSel.appendChild(o);});
  const tSel = $('toolTypeSelect'); tSel.innerHTML=''; (CUTTING_DATA.tool_types||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.label; tSel.appendChild(o);});
  const mPres = $('machineSelect'); mPres.innerHTML='<option value="custom">— Seleccionar máquina —</option>'; (CUTTING_DATA.machines||[]).forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=`${m.brand} · ${m.model} · ${m.type}`; mPres.appendChild(opt);});
}

/* ----------------- cálculo y scoring ----------------- */
function vibrationRiskScore(params){
  const w = CUTTING_DATA.vibration.weights;
  const Lnorm = Math.min(1,(params.L||0)/200);
  const aenorm = Math.min(1,((params.ae||0)/(params.D||1)));
  const apnorm = Math.min(1,((params.ap||0)/((params.D||1)*1.5)));
  const fznorm = Math.min(1,((params.fz||0)/0.5));
  const score = ((w.ld||0.5)*Lnorm + (w.ae||0.2)*aenorm + (w.ap||0.2)*apnorm + (w.fz||0.1)*fznorm);
  const mu = CUTTING_DATA.defaults.vibe_gauss.mu || 0.7;
  const sigma = CUTTING_DATA.defaults.vibe_gauss.sigma || 0.18;
  const z = (score - mu)/sigma;
  const p = 1/(1+Math.exp(-z));
  return {raw:score,prob:p};
}

function computeFresadoInputs(override={}){
  const D = parseFloat(override.diam ?? $('diam').value) || 0.001;
  const z = parseInt(override.z ?? $('z').value) || 1;
  const ae = parseFloat(override.ae ?? $('ae').value) || 0.1;
  const ap = parseFloat(override.ap ?? $('ap').value) || 0.1;
  const mat = (CUTTING_DATA.materials||[]).find(m=>m.id==$('materialSelect').value) || (CUTTING_DATA.materials||[])[0];
  const holder = (CUTTING_DATA.holders||[]).find(h=>h.id==$('holderSelect').value) || (CUTTING_DATA.holders||[])[0];
  const toolType = (CUTTING_DATA.tool_types||[]).find(t=>t.id==$('toolTypeSelect').value) || (CUTTING_DATA.tool_types||[])[0];
  const Kc0 = mat?.Kc_N_per_mm2 || 2000;
  const mexp = parseFloat($('mexp')?.value) || 0.2;
  return {D,z,ae,ap,mat,holder,toolType,Kc0,mexp};
}

function computeTorneadoInputs(override={}){
  const D = parseFloat(override.diamT ?? $('diamT').value) || 0.001;
  const ap = parseFloat(override.apT ?? $('apT').value) || 0.5;
  const mat = (CUTTING_DATA.materials||[]).find(m=>m.id==$('materialSelect').value) || (CUTTING_DATA.materials||[])[0];
  const holder = (CUTTING_DATA.holders||[]).find(h=>h.id==$('holderSelect').value) || (CUTTING_DATA.holders||[])[0];
  const toolType = (CUTTING_DATA.tool_types||[]).find(t=>t.id==$('toolTypeSelect').value) || (CUTTING_DATA.tool_types||[])[0];
  const Kc0 = mat?.Kc_N_per_mm2 || 2000;
  const mexp = parseFloat($('mexp')?.value) || 0.2;
  return {D,ap,mat,holder,toolType,Kc0,mexp};
}

/* compute for given feed (mm/min) and rpm */
function computeForGrid(mode, feed_mm_min, rpm, overrides={}){
  if(mode==='torneado'){
    const inp = computeTorneadoInputs(overrides);
    const f = rpm>0 ? feed_mm_min / Math.max(rpm,1e-6) : 1e-6; // mm/rev
    const chip_h = f;
    const Kc_h = inp.Kc0 * Math.pow(chip_h + 1e-6, -inp.mexp);
    const mrr_mm3_min = Math.PI * inp.D * inp.ap * f * rpm / 4;
    const mrr_cm3_min = mrr_mm3_min/1000;
    const F_radial = Kc_h * inp.ap * f * 0.001;
    const L = parseFloat($('stickout').value||inp.holder?.stickout_default||60);
    const E = (parseFloat($('E')?.value)||210) * 1000;
    const I = Math.PI * Math.pow(inp.D,4) / 64;
    const stiffness_factor = (inp.holder?.stiffness_factor||1.0);
    const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
    const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
    const m_eff = 0.02;
    const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
    const toothHz = rpm/60; // single-tooth for turning approx
    const vib = vibrationRiskScore({L, ae:inp.ap, ap:inp.ap, fz:f, D:inp.D});
    return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, F_radial, delta_mm, f_n, toothHz, vib, mode:'torneado'};
  } else {
    const inp = computeFresadoInputs(overrides);
    const z = inp.z;
    const fz = rpm>0 ? feed_mm_min / Math.max(rpm * z,1e-9) : 1e-6; // mm/tooth
    const chip_h = fz;
    const Kc_h = inp.Kc0 * Math.pow(chip_h + 1e-6, -inp.mexp);
    const mrr_mm3_min = feed_mm_min * inp.ae * inp.ap;
    const mrr_cm3_min = mrr_mm3_min/1000;
    const F_radial = Kc_h * inp.ae * inp.ap * 0.001;
    const L = parseFloat($('stickout').value||inp.holder?.stickout_default||60);
    const E = (parseFloat($('E')?.value)||210) * 1000;
    const I = Math.PI * Math.pow(inp.D,4) / 64;
    const stiffness_factor = (inp.holder?.stiffness_factor||1.0);
    const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
    const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
    const m_eff = 0.02;
    const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
    const toothHz = (rpm/60) * z;
    const vib = vibrationRiskScore({L, ae:inp.ae, ap:inp.ap, fz:fz, D:inp.D});
    return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, F_radial, delta_mm, f_n, toothHz, vib, mode:'fresado', z};
  }
}

/* ----------------- charting ----------------- */
let combinedChart = null, trendChart=null, mrrChart=null;

function colorForProb(p){
  if(p>0.8) return '#e11d48';
  if(p>0.5) return '#f59e0b';
  return '#10b981';
}

/* Build grid points (not too denso) */
function buildGridPoints(mode, feedMin, feedMax, rpmMin, rpmMax, cols=35, rows=22){
  const points = [];
  for(let i=0;i<cols;i++){
    const x = feedMin + (feedMax-feedMin) * (i/(cols-1));
    for(let j=0;j<rows;j++){
      const y = rpmMin + (rpmMax-rpmMin) * (j/(rows-1));
      const cell = computeForGrid(mode, x, y);
      points.push({x:x, y:y, prob:cell.vib.prob, score:cell.vib.raw});
    }
  }
  return points;
}

/* Draw combined scatter with band for avoid_band_hz converted to rpm band using z */
function renderCombined(){
  const mode = $('modeT').classList.contains('is-on') ? 'torneado' : 'fresado';
  const feedMin = Number($('feedMin').value)||200;
  const feedMax = Number($('feedMax').value)||2200;
  const rpmMin = Number($('rpmMin').value)||200;
  const rpmMax = Number($('rpmMax').value)||10000;
  const grid = buildGridPoints(mode, feedMin, feedMax, rpmMin, rpmMax, 36, 28);

  // dataset: color mapping
  const scatterData = grid.map(p=>({x:p.x,y:p.y,r:4 + 6*p.prob, backgroundColor: colorForProb(p.prob), prob:p.prob}));

  // current conditions point
  const modePoint = mode==='torneado'? computeForGrid('torneado', (parseFloat($('modeTorneadoFields')?0:0),0),0) : null;
  // compute current feed and rpm based on inputs
  let current;
  if(mode==='torneado'){
    const rpm = parseFloat($('vcT').value) && parseFloat($('diamT').value) ? Math.max(1, (parseFloat($('vcT').value)*1000)/(Math.PI*parseFloat($('diamT').value))) : (Number($('rpmMin').value)||1000);
    const feed_mm_min = rpm * (parseFloat($('fT').value)||0.15);
    current = computeForGrid('torneado', feed_mm_min, rpm);
  } else {
    const D = parseFloat($('diam').value)||12;
    const vc = parseFloat($('vc').value)||180;
    const rpm = Math.max(1, (vc*1000)/(Math.PI*D));
    const z = parseInt($('z').value)||4;
    const feed_mm_min = rpm * z * (parseFloat($('fz').value)||0.06);
    current = computeForGrid('fresado', feed_mm_min, rpm);
  }

  // prepare datasets
  const datasets = [
    {
      label:'Grid (prob vib)',
      data: scatterData,
      showLine:false,
      pointStyle:'circle',
      parsing: false // we provide x,y directly in objects
    },
    {
      label:'Condición actual',
      data:[{x: current.feed_mm_min, y: current.rpm}],
      pointBackgroundColor:'#ffffff',
      pointBorderColor:'#000000',
      pointRadius:10,
      pointStyle:'triangle'
    }
  ];

  // destroy old chart
  if(combinedChart) combinedChart.destroy();

  // Plugin: draw horizontal band for avoid_band_hz (converted to rpm by z)
  const pluginBand = {
    id: 'rpmBand',
    afterDraw: chart => {
      const ctx = chart.ctx;
      const xScale = chart.scales.x;
      const yScale = chart.scales.y;
      const z = parseInt($('z').value) || 4;
      const hzMin = (CUTTING_DATA.vibration.avoid_band_hz[0]||600);
      const hzMax = (CUTTING_DATA.vibration.avoid_band_hz[1]||900);
      // convert tooth freq to rpm: rpm = hz * 60 / z
      const rpmBandMin = hzMin * 60 / Math.max(z,1);
      const rpmBandMax = hzMax * 60 / Math.max(z,1);
      // If the band intersects chart Y range, draw a translucent rectangle
      const yTop = yScale.getPixelForValue(Math.min(chart.scales.y.max, rpmBandMax));
      const yBottom = yScale.getPixelForValue(Math.max(chart.scales.y.min, rpmBandMin));
      if(yBottom <= yTop) return; // no intersection
      ctx.save();
      ctx.fillStyle = 'rgba(225,29,72,0.08)'; // light red
      ctx.fillRect(xScale.left, yTop, xScale.right - xScale.left, yBottom - yTop);
      // draw border lines
      ctx.strokeStyle = 'rgba(225,29,72,0.18)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(xScale.left, yTop); ctx.lineTo(xScale.right, yTop);
      ctx.moveTo(xScale.left, yBottom); ctx.lineTo(xScale.right, yBottom);
      ctx.stroke();
      ctx.restore();
      // draw text labels on right side
      ctx.save();
      ctx.fillStyle = 'rgba(225,29,72,0.7)';
      ctx.font = '12px sans-serif';
      ctx.fillText(`Banda ${hzMin}-${hzMax} Hz (evitar)`, xScale.right - 180, yTop + 14);
      ctx.restore();
    }
  };

  // scatter config
  const ctx = $('combinedChart').getContext('2d');
  combinedChart = new Chart(ctx, {
    type:'scatter',
    data:{datasets:datasets},
    options:{
      maintainAspectRatio:false,
      parsing:false,
      plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>{
        const p = ctx.raw;
        if(p && p.prob!=null) return `Av: ${Math.round(p.x)} mm/min · RPM: ${Math.round(p.y)} · Prob vib: ${(p.prob*100).toFixed(1)}%`;
        return '';
      }}}},
      scales:{
        x:{type:'linear',title:{display:true,text:'Avance (mm/min)'},min:Number($('feedMin').value),max:Number($('feedMax').value)},
        y:{type:'linear',title:{display:true,text:'RPM'},min:Number($('rpmMin').value),max:Number($('rpmMax').value)}
      }
    },
    plugins:[pluginBand]
  });

  // color points after chart created (Chart.js scatter accepts custom drawing through dataset.pointBackgroundColor callback)
  // but easier: mutate dataset meta and re-render: create dataset with pointBackgroundColor function
  // Recreate with function-based colors:
  combinedChart.data.datasets[0].pointBackgroundColor = combinedChart.data.datasets[0].data.map(p => p.backgroundColor);
  combinedChart.data.datasets[0].pointRadius = combinedChart.data.datasets[0].data.map(p => p.r);
  combinedChart.update();

  // update indicators & other charts
  renderResults(current);
  renderMRRTrend(current);
  renderVibTrend(current);
  renderMachineDetails();
}

/* small MRR trend (line of MRR across feed multipliers) */
function renderMRRTrend(A){
  const ctx = $('chartMRR').getContext('2d');
  const labels = []; const data = [];
  for(let i=50;i<=150;i+=10){
    const mult = i/100;
    const override = (A.mode==='fresado') ? { } : { };
    let cell;
    if(A.mode==='fresado'){
      // compute feed scaled by multiplier
      const feed = A.feed_mm_min * mult;
      cell = computeForGrid('fresado', feed, A.rpm);
    } else {
      const feed = A.feed_mm_min * mult;
      cell = computeForGrid('torneado', feed, A.rpm);
    }
    labels.push(i+'%');
    data.push(cell.mrr_cm3_min);
  }
  if(mrrChart) mrrChart.destroy();
  mrrChart = new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'MRR cm³/min',data}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

/* vib trend across feed multipliers (prob) */
function renderVibTrend(A){
  const ctx = $('chartVibTrend').getContext('2d');
  const labels=[]; const data=[];
  for(let i=50;i<=150;i+=10){
    const mult=i/100;
    const feed = A.feed_mm_min * mult;
    const cell = computeForGrid(A.mode, feed, A.rpm);
    labels.push(i+'%');
    data.push(cell.vib.prob);
  }
  if(trendChart) trendChart.destroy();
  trendChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Prob. vib',data}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:1}}}});
}

/* render numeric results panel */
function renderResults(A){
  const out = $('results'); out.innerHTML='';
  const s = document.createElement('div'); s.className='card';
  s.innerHTML = `<div style="font-weight:800">Resumen — ${A.mode}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
      <div class="muted">RPM</div><div class="result-value">${fmt(A.rpm,0)}</div>
      <div class="muted">Avance (mm/min)</div><div class="result-value">${fmt(A.feed_mm_min,2)}</div>
      <div class="muted">MRR (cm³/min)</div><div class="result-value">${fmt(A.mrr_cm3_min,3)}</div>
      <div class="muted">Potencia estimada (kW)</div><div class="result-value">${fmt((A.Kc_h||0)*A.mrr_cm3_min/1000,3)}</div>
    </div>`;
  out.appendChild(s);

  // cycle & cost
  if($('enableCycle').checked){
    const time_min = parseFloat(A.mrr_cm3_min)>0 ? ( (parseFloat($('volumen').value)||1) / Math.max(A.mrr_cm3_min,1e-9) ) : 0;
    const cost_machine = (time_min/60) * (parseFloat($('machineCost').value)||0);
    const c=document.createElement('div'); c.className='card';
    c.innerHTML = `<div style="font-weight:800">Tiempo & Coste</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">Tiempo/pieza (min)</div><div class="result-value">${fmt(time_min,2)}</div>
        <div class="muted">Costo máquina (USD)</div><div class="result-value">${fmt(cost_machine,2)}</div>
      </div>`;
    out.appendChild(c);
  }

  if($('enableKc').checked){
    const k=document.createElement('div'); k.className='card';
    k.innerHTML=`<div style="font-weight:800">Kc & Potencia</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">Chip thickness (mm)</div><div class="result-value">${fmt(A.chip_h||0,4)}</div>
        <div class="muted">Kc(h) (N/mm²)</div><div class="result-value">${fmt(A.Kc_h||0,1)}</div>
        <div class="muted">Potencia aprox (kW)</div><div class="result-value">${fmt((A.Kc_h||0)*A.mrr_cm3_min/1000,3)}</div>
      </div>`;
    out.appendChild(k);
  }

  if($('enableStability').checked){
    const st=document.createElement('div'); st.className='card';
    const riskColor = A.vib.prob > CUTTING_DATA.vibration.risk_threshold ? '#e11d48' : (A.vib.prob>0.5 ? '#f59e0b' : '#10b981');
    st.innerHTML=`<div style="font-weight:800">Vibración</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">f_n (Hz)</div><div class="result-value">${fmt(A.f_n,1)}</div>
        <div class="muted">Freq excit (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
        <div class="muted">Score</div><div class="result-value">${fmt(A.vib.raw,3)}</div>
        <div class="muted">Prob. riesgo</div><div class="result-value"><span style="display:inline-block;background:${riskColor};width:10px;height:10px;border-radius:999px;margin-right:6px"></span>${fmt(A.vib.prob,2)}</div>
      </div>`;
    out.appendChild(st);
  }

  // indicators
  const ind = $('indicators'); ind.innerHTML = '';
  ind.innerHTML = `<div class="muted">Freq medios</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
      <div class="muted">f_n (Hz)</div><div class="result-value">${fmt(A.f_n,1)}</div>
      <div class="muted">Freq excit (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
    </div>`;
}

/* machine details */
function renderMachineDetails(){
  const id = $('machineSelect').value;
  const m = (CUTTING_DATA.machines||[]).find(x=>x.id===id);
  const out = $('machineDetails'); out.innerHTML='';
  if(!m){ out.innerHTML = `<div class="muted">No se seleccionó preset. Ajusta manualmente los parámetros de máquina.</div>`; return; }
  out.innerHTML = `<div><strong>${m.brand} ${m.model}</strong></div>
    <div class="muted">Tipo: ${m.type}</div>
    <div class="muted">Potencia: ${m.power_kW} kW · RPM máx: ${m.max_rpm}</div>
    <div class="muted">Stickout por defecto: ${m.stickout_default} mm · Husillo: ${m.spindle}</div>`;
}

/* ----------------- UI events ----------------- */
$('modeF').addEventListener('click',()=>{ $('modeF').classList.add('is-on'); $('modeT').classList.remove('is-on'); $('modeFresadoFields').style.display='block'; $('modeTorneadoFields').style.display='none'; renderAll();});
$('modeT').addEventListener('click',()=>{ $('modeT').classList.add('is-on'); $('modeF').classList.remove('is-on'); $('modeFresadoFields').style.display='none'; $('modeTorneadoFields').style.display='block'; renderAll();});
$('machineSelect').addEventListener('change', ()=>{
  const id = $('machineSelect').value;
  const m = (CUTTING_DATA.machines||[]).find(x=>x.id===id);
  if(m){
    $('machineModel').value = `${m.brand} ${m.model}`;
    $('machinePower').value = m.power_kW;
    $('machineMaxRpm').value = m.max_rpm;
    $('spindleType').value = m.spindle;
    $('stickout').value = m.stickout_default;
    $('stickoutDefault').value = m.stickout_default;
    $('machineCost').value = Math.max(10, Math.round(m.power_kW * 2));
  } else { $('machineModel').value=''; }
  renderAll();
});

/* wire inputs to render */
function attachAutoRender(){
  const nodes = document.querySelectorAll('input,select');
  nodes.forEach(n => n.addEventListener('input', ()=>{ debounceRender(); }));
  nodes.forEach(n => n.addEventListener('change', ()=>{ debounceRender(); }));
}
let renderTimer=null;
function debounceRender(){ if(renderTimer) clearTimeout(renderTimer); renderTimer = setTimeout(()=>{ renderAll(); },120); }

/* exports */
$('btnExportCsv').addEventListener('click', ()=>{
  const mode = $('modeT').classList.contains('is-on') ? 'torneado' : 'fresado';
  const A = (mode==='torneado') ? computeForGrid('torneado', (parseFloat($('vcT').value)* (parseFloat($('fT').value)||0.15)/1)||1, parseFloat($('vcT').value) && parseFloat($('diamT').value) ? Math.max(1,(parseFloat($('vcT').value)*1000)/(Math.PI*parseFloat($('diamT').value))) : 1000) : computeForGrid('fresado', (function(){ const D=parseFloat($('diam').value)||12; const rpm=(parseFloat($('vc').value)*1000)/(Math.PI*D); return rpm * (parseInt($('z').value)||4) * (parseFloat($('fz').value)||0.06); })(), Math.max(1, (parseFloat($('vc').value)*1000)/(Math.PI*parseFloat($('diam').value)||12)));
  const rows = [['metric','value'], ['RPM',A.rpm], ['MRR_cm3_min',A.mrr_cm3_min], ['time_min', (parseFloat($('volumen').value)||1)/Math.max(A.mrr_cm3_min,1e-9)], ['cost_piece', (parseFloat($('machineCost').value)||0)*((parseFloat($('volumen').value)||1)/Math.max(A.mrr_cm3_min,1e-9))/60], ['vib_prob',A.vib.prob]];
  const csv = rows.map(r=> r.join(',') ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='export_calculadora.csv'; a.click(); URL.revokeObjectURL(url);
});

$('btnExportPdf').addEventListener('click', async ()=>{
  // export combinedChart canvas as pdf page
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('landscape','pt','a4');
  const canvas = document.querySelector('#combinedChart');
  const img = canvas.toDataURL('image/png');
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  // scale preserving aspect
  pdf.addImage(img,'PNG',20,20,pageW-40,pageH-40);
  pdf.save('reporte_vibracion.pdf');
});

/* ----------------- main render ----------------- */
function renderAll(){
  // ensure selects populated
  renderCombined();
}

/* initial load */
populateFromData();
attachAutoRender();
renderAll();

</script>
</body>
</html>
