<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora RPM & Avance — AlexRaSa (Extendida, integrada)</title>
  <meta name="description" content="Calculadora extendida integrada con cutting-data.json: materiales, holders, operaciones, análisis de vibración y comparador A vs P." />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#0b1220;--card:#0f172a;--ink:#e6eef8;--muted:#9fb3c8;--accent:#0ea5e9}
    body{background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    .sidebar{width:380px;min-width:300px}
    .main{flex:1}
    .muted{color:var(--muted)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:1rem;border-radius:0.6rem}
    .small{font-size:0.85rem}
    .section-title{font-weight:700;color:var(--accent)}
    .result-value{font-weight:700;font-size:1.05rem}
    .toggle{appearance:none;width:44px;height:24px;background:#111827;border-radius:999px;position:relative;cursor:pointer}
    .toggle:checked{background:var(--accent)}
    .toggle:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:all .18s}
    .toggle:checked:before{transform:translateX(20px)}
    .risk-dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px}
  </style>
</head>
<body class="p-4">
  <div class="flex gap-4">
    <div class="main">
      <div class="card mb-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-xl font-bold">Calculadora RPM & Avance — Integrada</h1>
            <div class="muted small">Ahora usa presets de cutting-data.json para Material, Operación y Sujeción.</div>
          </div>
          <div class="text-right small muted">Archivo: <span class="font-mono">calculadora-rpm-extendida.html</span></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="card">
          <div class="section-title">Entradas — Parámetros principales</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Material</label>
            <select id="materialSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Operación</label>
            <select id="operationSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Sujeción / Holder</label>
            <select id="holderSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Tipo herramienta</label>
            <select id="toolTypeSelect" class="w-full p-2 rounded bg-[#071122] border border-gray-800"></select>

            <label class="small muted">Diámetro herramienta D (mm)</label>
            <input id="diam" type="number" step="0.01" value="12" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Dientes / cortantes (z)</label>
            <input id="z" type="number" step="1" value="4" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Velocidad de corte Vc (m/min)</label>
            <input id="vc" type="number" step="0.1" value="180" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Avance por diente fz (mm/tooth)</label>
            <input id="fz" type="number" step="0.0001" value="0.06" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="small muted">Ae (mm) ancho de corte</label>
                <input id="ae" type="number" step="0.01" value="10" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              </div>
              <div>
                <label class="small muted">Ap (mm) profundidad</label>
                <input id="ap" type="number" step="0.01" value="2" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
              </div>
            </div>

            <label class="small muted">Stickout L (mm)</label>
            <input id="stickout" type="number" step="1" value="60" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

          </div>
        </div>

        <div class="card">
          <div class="section-title">Costos y producción</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Costo hora máquina (MXN)</label>
            <input id="machineCost" type="number" step="0.1" value="400" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Costo herramienta (MXN)</label>
            <input id="toolCost" type="number" step="0.1" value="1200" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Volumen a remover por pieza (cm³)</label>
            <input id="volumen" type="number" step="0.01" value="18" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

            <label class="small muted">Producción objetivo (piezas/hora)</label>
            <input id="prodRate" type="number" step="0.1" value="30" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />

          </div>
        </div>

        <div class="card">
          <div class="section-title">Parámetros de herramienta / vida</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Constante Taylor C (m/min * min^n)</label>
            <input id="C" type="number" step="1" value="40000" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">Exponente n (Taylor)</label>
            <input id="n" type="number" step="0.01" value="0.25" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
          </div>
        </div>

        <div class="card">
          <div class="section-title">Kc & propiedades (auto desde material)</div>
          <div class="mt-3 grid gap-2">
            <label class="small muted">Kc0 (N/mm²)</label>
            <input id="Kc0" type="number" step="1" value="2000" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">Exponente m</label>
            <input id="mexp" type="number" step="0.01" value="0.2" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
            <label class="small muted">E (GPa)</label>
            <input id="E" type="number" step="1" value="210" class="w-full p-2 rounded bg-[#071122] border border-gray-800" />
          </div>
        </div>

      </div>

      <div class="mt-4 card">
        <div class="flex items-center justify-between">
          <div class="section-title">Opciones — habilitar cálculos</div>
          <div class="small muted">Activa para ver más resultados</div>
        </div>
        <div class="mt-3 grid grid-cols-3 gap-3">
          <label class="flex items-center gap-2"><input id="enableCycle" type="checkbox" class="toggle" checked /> <span class="small">Tiempo & Coste</span></label>
          <label class="flex items-center gap-2"><input id="enableToolLife" type="checkbox" class="toggle" checked /> <span class="small">Vida herramienta</span></label>
          <label class="flex items-center gap-2"><input id="enableKc" type="checkbox" class="toggle" checked /> <span class="small">Kc(h) & Potencia</span></label>
          <label class="flex items-center gap-2"><input id="enableDeflection" type="checkbox" class="toggle" /> <span class="small">Deflexión</span></label>
          <label class="flex items-center gap-2"><input id="enableStability" type="checkbox" class="toggle" checked /> <span class="small">Análisis vibración</span></label>
          <label class="flex items-center gap-2"><input id="enableCompare" type="checkbox" class="toggle" /> <span class="small">Comparador A vs P</span></label>
        </div>
      </div>

      <div class="mt-4 card">
        <div class="flex items-center justify-between">
          <div class="section-title">Comparador A vs P (si activado)</div>
          <div class="small muted">Introduce un segundo escenario y presiona "Comparar"</div>
        </div>
        <div class="mt-3 grid grid-cols-4 gap-2">
          <input id="vcB" type="number" step="0.1" value="120" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="Vc B" />
          <input id="fzB" type="number" step="0.0001" value="0.04" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="fz B" />
          <input id="aeB" type="number" step="0.01" value="8" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="ae B" />
          <input id="apB" type="number" step="0.01" value="1" class="p-2 rounded bg-[#071122] border border-gray-800" placeholder="ap B" />
        </div>
        <div class="mt-3">
          <button id="btnCompare" class="px-4 py-2 bg-accent text-black rounded font-bold">Comparar</button>
        </div>
      </div>

    </div>

    <aside class="sidebar card">
      <div class="flex items-center justify-between mb-2">
        <div class="section-title">Resultados</div>
        <div class="small muted">Panel derecho — exportable</div>
      </div>

      <div id="results" class="space-y-3 small">
        <!-- Results injected here -->
      </div>

      <div class="mt-3">
        <button id="btnExportPdf" class="w-full px-4 py-2 rounded bg-[#10b981] text-black font-bold">Exportar PDF</button>
        <button id="btnExportCsv" class="w-full mt-2 px-4 py-2 rounded bg-[#0ea5e9] text-black font-bold">Exportar CSV</button>
      </div>

      <div class="mt-4 card">
        <div class="section-title">Gráficos</div>
        <canvas id="chartMRR" height="160"></canvas>
      </div>

      <div class="mt-3 card">
        <div class="section-title">Tabla comparativa</div>
        <div class="mt-2 overflow-auto" style="max-height:200px">
          <table id="tableCompare" class="w-full text-left small">
            <thead><tr><th class="muted">Métrica</th><th class="muted">A</th><th class="muted">B</th><th class="muted">Δ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </aside>
  </div>

  <script>
    // Embedded cutting-data.json (extracted from your upload)
    const CUTTING_DATA = {
      "version": "3.0",
      "defaults": {"rpm_limit":12000,"prudence":0.9,"holder":"ER Collet","stickout_mm":25,"ae_percent":25,"ap_mm":5,"efficiency":0.8,"vibe_gauss":{"mu":0.75,"sigma":0.2},"units":"metric","default_flutes":4},
      "vibration": {"avoid_band_hz":[600,900],"rpm_shift_pct":0.12,"risk_threshold":0.85,"weights":{"ld":0.55,"ae":0.2,"ap":0.15,"fz":0.1}},
      "holders": [
        {"id":"ER Collet","label":"Portapinzas ER","stiffness_factor":1.0},
        {"id":"Heavy ER","label":"Portapinzas ER reforzado","stiffness_factor":1.1},
        {"id":"REGOFIX_powRgrip","label":"REGO-FIX powRgrip (PG)","stiffness_factor":1.4},
        {"id":"Shrinkfit","label":"Termoencogible (shrinkfit)","stiffness_factor":1.35},
        {"id":"MillingChuck","label":"Milling/Power Chuck","stiffness_factor":1.2}
      ],
      "materials": [
        {"id":"alu_6061","name":"Aluminio 6061-T6 (carburo)","Kc_N_per_mm2":800,"taylor":{"C":1000,"n":0.12}},
        {"id":"steel_1045","name":"Acero 1045 (carburo)","Kc_N_per_mm2":2000,"taylor":{"C":300,"n":0.2}},
        {"id":"steel_4140_ph","name":"Acero 4140 PH","Kc_N_per_mm2":3200,"taylor":{"C":120,"n":0.12}},
        {"id":"ti_64","name":"Titanio Ti-6Al-4V","Kc_N_per_mm2":1200,"taylor":{"C":150,"n":0.18}}
      ],
      "operations": [
        {"id":"rough","label":"Desbaste","default_ae_pct":30,"default_ap_per_d":0.5},
        {"id":"finish","label":"Acabado","default_ae_pct":12,"default_ap_per_d":0.2},
        {"id":"adaptive","label":"Trocoidal/Adaptativo","default_ae_pct":25,"default_ap_per_d":1.0}
      ],
      "tool_types": [
        {"id":"endmill","label":"Fresa (Endmill)","vc_factor":1.0,"fz_factor":1.0,"default_flutes":4}
      ]
    };

    // Helpers
    const $ = id => document.getElementById(id);
    function fmt(n,dec=2){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec}); }

    // Populate selects
    function populateFromData(){
      const mSel = $('materialSelect'); CUTTING_DATA.materials.forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.name; mSel.appendChild(opt); });
      const oSel = $('operationSelect'); CUTTING_DATA.operations.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=o.label; oSel.appendChild(opt); });
      const hSel = $('holderSelect'); CUTTING_DATA.holders.forEach(h=>{ const opt=document.createElement('option'); opt.value=h.id; opt.textContent=h.label; hSel.appendChild(opt); });
      const tSel = $('toolTypeSelect'); CUTTING_DATA.tool_types.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.label; tSel.appendChild(opt); });
      // defaults
      mSel.value = CUTTING_DATA.materials[0].id;
      oSel.value = CUTTING_DATA.operations[0].id;
      hSel.value = CUTTING_DATA.holders[0].id;
      tSel.value = CUTTING_DATA.tool_types[0].id;
    }

    function applyOperationDefaults(){
      const op = CUTTING_DATA.operations.find(x=>x.id==$('operationSelect').value);
      const D = parseFloat($('diam').value)||12;
      if(op){
        const ae_pct = op.default_ae_pct || CUTTING_DATA.defaults.ae_percent;
        const ap_per_d = op.default_ap_per_d || 0.2;
        $('ae').value = Math.max(1, Math.round((ae_pct/100)*D*100)/100);
        $('ap').value = Math.max(0.01, Math.round((ap_per_d*D)*100)/100);
      }
    }

    // Vibration scoring function
    function vibrationRiskScore(params){
      // params: stickout L, ae, ap, fz, rpm, toothHz, f_n
      const w = CUTTING_DATA.vibration.weights;
      // normalize each indicator between 0 and 1 using simple heuristics
      const Lnorm = Math.min(1, params.L/200); // 200 mm -> 1
      const aenorm = Math.min(1, (params.ae / params.D)); // ae relative to D
      const apnorm = Math.min(1, params.ap / (params.D*1.5));
      const fznorm = Math.min(1, params.fz / 0.5);
      const score = (w.ld*Lnorm + w.ae*aenorm + w.ap*apnorm + w.fz*fznorm);
      // map through gaussian preference (mu/sigma) to a probability-like score
      const mu = CUTTING_DATA.defaults.vibe_gauss.mu; const sigma = CUTTING_DATA.defaults.vibe_gauss.sigma;
      // simple transform
      const z = (score - mu)/sigma;
      const p = 1/(1+Math.exp(-z));
      return {raw:score,prob:p};
    }

    function computeAll(useB=false){
      // Read inputs A
      const D = parseFloat($('diam').value) || 0.001; // mm
      const z = parseInt($('z').value) || 1;
      let vc = parseFloat($('vc').value) || 0.1; // m/min
      let fz = parseFloat($('fz').value) || 0.0001; // mm
      let ae = parseFloat($('ae').value) || 0.1; // mm
      let ap = parseFloat($('ap').value) || 0.1; // mm
      const entryAngle = 90 * Math.PI/180;

      const machineCost = parseFloat($('machineCost').value) || 0;
      const toolCost = parseFloat($('toolCost').value) || 0;
      const volumen = parseFloat($('volumen').value) || 0; // cm3

      const mat = CUTTING_DATA.materials.find(m=>m.id==$('materialSelect').value) || CUTTING_DATA.materials[0];
      const holder = CUTTING_DATA.holders.find(h=>h.id==$('holderSelect').value) || CUTTING_DATA.holders[0];
      const toolType = CUTTING_DATA.tool_types.find(t=>t.id==$('toolTypeSelect').value) || CUTTING_DATA.tool_types[0];
      const op = CUTTING_DATA.operations.find(o=>o.id==$('operationSelect').value) || CUTTING_DATA.operations[0];

      // apply tool/operation factors
      vc = vc * (toolType.vc_factor || 1.0);
      fz = fz * (toolType.fz_factor || 1.0);

      // Kc & Taylor from material
      const Kc0 = mat.Kc_N_per_mm2 || parseFloat($('Kc0').value) || 2000;
      const C = mat.taylor?.C || parseFloat($('C').value) || 40000;
      const n = mat.taylor?.n || parseFloat($('n').value) || 0.25;

      // Basic conversions
      const rpm = (vc*1000)/(Math.PI*D); // rpm
      const feed_mm_min = rpm * z * fz; // mm/min
      const mrr_mm3_min = feed_mm_min * ae * ap; // mm3/min
      const mrr_cm3_min = mrr_mm3_min / 1000; // cm3/min

      // chip thickness approx: fz * sin(entryAngle)
      const chip_h = fz * Math.abs(Math.sin(entryAngle));
      const mexp = parseFloat($('mexp').value) || 0.2;
      const Kc_h = Kc0 * Math.pow(chip_h + 1e-6, -mexp);

      const eta = CUTTING_DATA.defaults.efficiency || 0.8;
      const power_kW = (Kc_h * mrr_mm3_min) / (60*1000) / eta;

      // Time & costs
      const time_min = volumen / Math.max(mrr_cm3_min, 1e-9);
      const time_h = time_min/60;
      const cost_machine = time_h * machineCost;

      // Tool life (Taylor) using Vc (m/min). T = C / Vc^n (min)
      const life_min = C / Math.pow(Math.max(vc,1e-6), n);
      const pieces_per_tool = Math.max(Math.floor(life_min / Math.max(time_min,1e-9)),1);
      const tool_cost_per_piece = toolCost / pieces_per_tool;
      const cost_per_piece = cost_machine + tool_cost_per_piece;

      // Deflection approximate enhanced with holder stiffness
      const I = Math.PI * Math.pow(D,4) / 64;
      const F_radial = Kc_h * ae * ap * 0.001;
      const stiffness_factor = holder.stiffness_factor || 1.0;
      const E = (parseFloat($('E').value)||210) * 1000; // GPa -> MPa as N/mm2
      const delta_mm = (F_radial * Math.pow(parseFloat($('stickout').value||60),3)) / (3 * E * I + 1e-9) / stiffness_factor;

      // stiffness & natural freq approx
      const L = parseFloat($('stickout').value||60);
      const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
      const m_eff = 0.02; // kg
      const f_n = (1/(2*Math.PI))*Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
      const toothHz = rpm/60 * z;

      // Vibration risk
      const vib = vibrationRiskScore({L, ae, ap, fz, D});
      const risk_flag = vib.prob > CUTTING_DATA.vibration.risk_threshold;

      const A = {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, power_kW, time_min, cost_machine, life_min, pieces_per_tool, tool_cost_per_piece, cost_per_piece, delta_mm, f_n, toothHz, F_radial, vib};

      let B = null;
      if(useB){
        const vcB = parseFloat($('vcB').value)||vc;
        const fzB = parseFloat($('fzB').value)||fz;
        const aeB = parseFloat($('aeB').value)||ae;
        const apB = parseFloat($('apB').value)||ap;
        const rpmB = (vcB*1000)/(Math.PI*D);
        const feedB = rpmB * z * fzB;
        const mrrB = feedB * aeB * apB / 1000;
        const chip_hB = fzB * Math.abs(Math.sin(entryAngle));
        const Kc_hB = Kc0 * Math.pow(chip_hB + 1e-6, -mexp);
        const powerB = (Kc_hB * feedB * aeB * apB) / (60*1000) / eta;
        const time_minB = volumen / Math.max(mrrB,1e-9);
        const lifeB = C / Math.pow(Math.max(vcB,1e-6), n);
        const pieces_per_toolB = Math.max(Math.floor(lifeB / Math.max(time_minB,1e-9)),1);
        const cost_machineB = (time_minB/60) * machineCost;
        const cost_per_pieceB = cost_machineB + (toolCost / pieces_per_toolB);
        B = {rpm:rpmB, feed_mm_min:feedB, mrr_cm3_min:mrrB, chip_h:chip_hB, Kc_h:Kc_hB, power_kW:powerB, time_min:time_minB, life_min:lifeB, pieces_per_tool:pieces_per_toolB, cost_per_piece:cost_per_pieceB};
      }

      return {A,B};
    }

    function render(){
      applyOperationDefaults();
      const enableCycle = $('enableCycle').checked;
      const enableToolLife = $('enableToolLife').checked;
      const enableKc = $('enableKc').checked;
      const enableDeflection = $('enableDeflection').checked;
      const enableStability = $('enableStability').checked;
      const enableCompare = $('enableCompare').checked;

      const {A,B} = computeAll(enableCompare);

      const out = $('results'); out.innerHTML='';

      const s = document.createElement('div'); s.className='card small'; s.innerHTML = `
        <div class="font-bold">Resumen rápido</div>
        <div class="mt-2 grid grid-cols-2 gap-1">
          <div class="muted">RPM</div><div class="result-value">${fmt(A.rpm,0)}</div>
          <div class="muted">Avance (mm/min)</div><div class="result-value">${fmt(A.feed_mm_min,2)}</div>
          <div class="muted">MRR (cm³/min)</div><div class="result-value">${fmt(A.mrr_cm3_min,3)}</div>
          <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
        </div>`;
      out.appendChild(s);

      if(enableCycle){
        const c = document.createElement('div'); c.className='card small';
        c.innerHTML = `<div class="font-bold">Tiempo & Coste</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Tiempo por pieza (min)</div><div class="result-value">${fmt(A.time_min,2)}</div>
            <div class="muted">Costo máquina (MXN)</div><div class="result-value">${fmt(A.cost_machine,2)}</div>
            <div class="muted">Costo total por pieza (MXN)</div><div class="result-value">${fmt(A.cost_per_piece,2)}</div>
          </div>`;
        out.appendChild(c);
      }

      if(enableToolLife){
        const t = document.createElement('div'); t.className='card small';
        t.innerHTML = `<div class="font-bold">Vida de herramienta</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Vida estimada (min)</div><div class="result-value">${fmt(A.life_min,1)}</div>
            <div class="muted">Piezas por herramienta</div><div class="result-value">${fmt(A.pieces_per_tool,0)}</div>
            <div class="muted">Costo herramienta por pieza (MXN)</div><div class="result-value">${fmt(A.tool_cost_per_piece,2)}</div>
          </div>`;
        out.appendChild(t);
      }

      if(enableKc){
        const k = document.createElement('div'); k.className='card small';
        k.innerHTML = `<div class="font-bold">Kc(h) y Potencia</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Chip thickness (mm)</div><div class="result-value">${fmt(A.chip_h,4)}</div>
            <div class="muted">Kc(h) (N/mm²)</div><div class="result-value">${fmt(A.Kc_h,1)}</div>
            <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.power_kW,3)}</div>
          </div>
          <div class="mt-2 muted small">Nota: Kc(h) y potencia son aproximaciones. Valida con banco de pruebas antes de tomar decisiones comerciales.</div>`;
        out.appendChild(k);
      }

      if(enableDeflection){
        const d = document.createElement('div'); d.className='card small';
        d.innerHTML = `<div class="font-bold">Deflexión & Fuerza</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">Fuerza radial (N aprox)</div><div class="result-value">${fmt(A.F_radial,2)}</div>
            <div class="muted">Deflexión (mm aprox)</div><div class="result-value">${fmt(A.delta_mm,4)}</div>
          </div>
          <div class="mt-2 muted small">Sugerencia: reduce stickout o usa portaherramientas más rígidos si δ &gt; 0.05 mm.</div>`;
        out.appendChild(d);
      }

      if(enableStability){
        const st = document.createElement('div'); st.className='card small';
        const riskColor = A.vib.prob > CUTTING_DATA.vibration.risk_threshold ? '#e11d48' : (A.vib.prob > 0.5 ? '#f59e0b' : '#10b981');
        st.innerHTML = `<div class="font-bold">Análisis de Vibración</div>
          <div class="mt-2 grid grid-cols-2 gap-1">
            <div class="muted">f_n (Hz aprox)</div><div class="result-value">${fmt(A.f_n,1)}</div>
            <div class="muted">Tooth frequency (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
            <div class="muted">Score raw</div><div class="result-value">${fmt(A.vib.raw,3)}</div>
            <div class="muted">Prob riesgo</div><div class="result-value"><span style="display:inline-block;background:${riskColor};width:10px;height:10px;border-radius:999px;margin-right:6px"></span>${fmt(A.vib.prob,2)}</div>
          </div>
          <div class="mt-2 muted small">Evitar bandas: ${CUTTING_DATA.vibration.avoid_band_hz.join('-')} Hz. Si toothHz cae dentro de la banda o la probabilidad es alta, considera cambiar parámetros o holder.</div>`;
        out.appendChild(st);
      }

      renderChart(A);
      renderCompareTable(A, B);
    }

    // Chart.js
    let chartMRR = null;
    function renderChart(A){
      const ctx = $('chartMRR').getContext('2d');
      const D = parseFloat($('diam').value)||12; const z = parseInt($('z').value)||4; const fz = parseFloat($('fz').value)||0.06;
      const vc = parseFloat($('vc').value)||180;
      const vcs = []; const labels=[]; const dataMRR=[];
      for(let k=0;k<=10;k++){ const vcx = vc*(0.6 + 0.08*k); labels.push(Math.round(vcx)); const rpm = (vcx*1000)/(Math.PI*D); const feed = rpm*z*fz; const mrr = feed * parseFloat($('ae').value||10) * parseFloat($('ap').value||2)/1000; dataMRR.push(mrr); }
      if(chartMRR) chartMRR.destroy();
      chartMRR = new Chart(ctx,{type:'line',data:{labels, datasets:[{label:'MRR (cm3/min)', data:dataMRR, fill:true, tension:0.25}]}, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }

    function renderCompareTable(A,B){
      const tbody = $('tableCompare').querySelector('tbody'); tbody.innerHTML='';
      if(!B){ const tr=document.createElement('tr'); tr.innerHTML = `<td class="muted">Comparador</td><td colspan="3" class="small muted">Activa "Comparador A vs P" y presiona Comparar</td>`; tbody.appendChild(tr); return; }
      const rows = [ ['RPM', fmt(A.rpm,0), fmt(B.rpm,0), fmt(B.rpm - A.rpm,0)], ['MRR (cm3/min)', fmt(A.mrr_cm3_min,3), fmt(B.mrr_cm3_min,3), fmt(B.mrr_cm3_min - A.mrr_cm3_min,3)], ['Tiempo/pieza (min)', fmt(A.time_min,2), fmt(B.time_min,2), fmt(B.time_min - A.time_min,2)], ['Costo/pieza (MXN)', fmt(A.cost_per_piece,2), fmt(B.cost_per_piece,2), fmt(B.cost_per_piece - A.cost_per_piece,2)], ['Piezas por herramienta', fmt(A.pieces_per_tool,0), fmt(B.pieces_per_tool,0), fmt(B.pieces_per_tool - A.pieces_per_tool,0)], ['Vib. prob', fmt(A.vib.prob,2), (B?fmt(vibrationRiskScore({L:parseFloat($('stickout').value||60),ae:parseFloat($('aeB').value||8),ap:parseFloat($('apB').value||1),fz:parseFloat($('fzB').value||0.04),D:parseFloat($('diam').value||12)}).prob:'') , fmt(((B? vibrationRiskScore({L:parseFloat($('stickout').value||60),ae:parseFloat($('aeB').value||8),ap:parseFloat($('apB').value||1),fz:parseFloat($('fzB').value||0.04),D:parseFloat($('diam').value||12)}).prob:0) - A.vib.prob),2)] ];
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="muted small">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`; tbody.appendChild(tr); });
    }

    // Exports
    $('btnExportCsv').addEventListener('click', ()=>{
      const {A,B} = computeAll($('enableCompare').checked);
      const rows = [ ['metric','A','B'] , ['RPM',A.rpm,(B?B.rpm:'')], ['MRR_cm3_min',A.mrr_cm3_min,(B?B.mrr_cm3_min:'')], ['time_min',A.time_min,(B?B.time_min:'')], ['cost_piece',A.cost_per_piece,(B?B.cost_per_piece:'')], ['vib_prob',A.vib.prob,(B? vibrationRiskScore({L:parseFloat($('stickout').value||60),ae:parseFloat($('aeB').value||8),ap:parseFloat($('apB').value||1),fz:parseFloat($('fzB').value||0.04),D:parseFloat($('diam').value||12)}).prob:'')] ];
      const csv = rows.map(r=>r.join(',')).join('
');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='calculadora_rpm_export.csv'; a.click(); URL.revokeObjectURL(url);
    });

    $('btnExportPdf').addEventListener('click', async ()=>{
      const element = document.body;
      const canvas = await html2canvas(element, {scale:1.5});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:'portrait',unit:'px',format:[canvas.width, canvas.height]});
      pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
      pdf.save('reporte_calculadora_rpm.pdf');
    });

    // Compare button
    $('btnCompare').addEventListener('click', ()=>{ render(); });

    // Auto render on input changes
    ['input','change'].forEach(ev=> document.querySelectorAll('input,select').forEach(i=>i.addEventListener(ev, ()=>{ render(); })));

    // Init
    populateFromData(); applyOperationDefaults(); render();

  </script>

</body>
</html>
