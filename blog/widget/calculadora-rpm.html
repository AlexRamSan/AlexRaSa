<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de RPM y avance — AlexRaSa</title>
  <meta name="description" content="Calcula RPM, avance e identifica riesgo de vibración por sujeción. Presets por material. Métrico/imperial." />
  <link rel="canonical" href="https://alexrasa.store/blog/calculadora-rpm-avance.html" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent:#0ea5e9; --rose:#e11d48; --emerald:#10b981; --indigo:#6366f1;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7fafc; --card:#ffffff; --ink:#0b1220; --muted:#475569; --border:#d4dbe5; --accent:#2563eb; }
    }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--ink)}
    .container{max-width:1100px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .lead{color:var(--muted)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);padding:.6rem .9rem;border-radius:10px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
    .btn:hover{filter:brightness(.98)}
    .tab{padding:.6rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(148,163,184,.08)}
    .tab.is-on{background:var(--accent);border-color:var(--accent);color:#061018}
    .field>label{display:block;font-size:.75rem;color:var(--muted);margin-bottom:.25rem}
    .field>input,.field>select{width:100%;border-radius:10px;padding:.6rem .7rem;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--ink)}
    .field>input::placeholder{color:var(--muted)}
    .kpi{font-weight:700}
    .kpi-value{font-size:1.4rem;color:#eaf2ff;text-shadow:0 0 0.5px #a5c3ff,0 0 12px rgba(56,189,248,.35)}
    .pill{font-size:.7rem;border:1px solid var(--border);border-radius:999px;padding:.12rem .5rem;color:var(--muted)}
    .vibe-box{background:rgba(148,163,184,.08);border:1px dashed var(--border);border-radius:12px;padding:16px;transition:background .18s,border-color .18s}
    .vibe-box code{color:#cde6ff}
    #matNotes{white-space:normal;overflow:visible;text-overflow:unset;display:block;color:var(--muted)}

    /* Selects y menú desplegado con contraste alto */
    select, option{ color: var(--ink); background-color: var(--card); }
    select:focus{ outline:2px solid var(--accent); outline-offset:1px }
    @supports (color-scheme: dark){ select, option{ color-scheme: dark; } }
    @media (prefers-color-scheme: light){
      select, option{ color:#0b1220; background:#ffffff; }
    }

    /* estados de vibración + badges */
    .vibe-box.ok   { border-color:#16a34a; background:rgba(22,163,74,.08) }
    .vibe-box.warn { border-color:#f59e0b; background:rgba(245,158,11,.10) }
    .vibe-box.bad  { border-color:#ef4444; background:rgba(239,68,68,.10) }
    .badge{font-size:.72rem;border-radius:999px;padding:.15rem .5rem;border:1px solid var(--border)}
    .badge.ok{background:#052e1b;color:#86efac;border-color:#166534}
    .badge.warn{background:#3a2801;color:#fde68a;border-color:#b45309}
    .badge.bad{background:#3b0a0a;color:#fecaca;border-color:#b91c1c}
  </style>
</head>
<body>

  <!-- HERO -->
  <section class="relative">
    <div class="absolute inset-0 -z-10">
      <div class="absolute inset-0 bg-[url('/assets/hero-industrial.png')] bg-cover bg-center opacity-70"></div>
      <div class="absolute inset-0 bg-slate-900/60"></div>
    </div>
    <div class="container mx-auto px-4 py-10">
      <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">
        Calculadora de <span class="text-sky-300">RPM</span> y <span class="text-sky-300">avance</span>
      </h1>
      <p class="lead mt-2">
        Métrico o imperial. Presets por material. Estimación de vibración por sujeción. Verifica contra el límite de máquina.
      </p>
      <div class="mt-4 flex gap-2">
        <span class="pill">SolidCAM</span><span class="pill">Lantek</span><span class="pill">Logopress</span>
      </div>
    </div>
  </section>

  <main class="container mx-auto px-4 pb-24">
    <!-- Fórmulas -->
    <section class="card p-5 mt-6">
      <h2 class="text-xl font-semibold mb-2">Fórmulas</h2>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div class="bg-black/20 rounded-lg p-3">
          <div class="font-semibold mb-1">Métrico</div>
          <div class="text-sky-200">RPM = (Vc · 1000) / (π · D<sub>mm</sub>)</div>
          <div class="text-sky-200">F = RPM · z · f<sub>z,mm</sub></div>
        </div>
        <div class="bg-black/20 rounded-lg p-3">
          <div class="font-semibold mb-1">Imperial</div>
          <div class="text-sky-200">RPM = (SFM · 3.82) / D<sub>in</sub></div>
          <div class="text-sky-200">F = RPM · z · f<sub>z,in</sub></div>
        </div>
      </div>
    </section>

    <!-- Calculadora -->
    <section class="card p-5 mt-6">
      <!-- Tabs unidades -->
      <div class="flex gap-3">
        <button id="uMetric" class="tab is-on" type="button">Métrico</button>
        <button id="uImperial" class="tab" type="button">Imperial</button>
      </div>

      <!-- Presets -->
      <div class="grid md:grid-cols-3 gap-3 mt-4">
        <div class="field md:col-span-2">
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div class="field">
          <label>Operación</label>
          <select id="operation">
            <option value="rough">Desbaste</option>
            <option value="finish">Acabado</option>
          </select>
        </div>
      </div>
      <div class="grid md:grid-cols-[1fr_auto] gap-3 mt-3 items-end">
        <button id="apply" class="btn">Aplicar preset</button>
        <div id="matBadge" class="justify-self-end text-xs text-slate-400"></div>
      </div>
      <div class="mt-2 text-sm"><span id="matNotes"></span></div>

      <!-- Entradas principales -->
      <div class="grid md:grid-cols-3 gap-3 mt-5">
        <div class="field">
          <label>Diámetro herramienta</label>
          <input id="diam" type="number" step="0.001" placeholder="mm o in según unidad">
        </div>
        <div class="field">
          <label>Filos (z)</label>
          <input id="flutes" type="number" min="1" step="1" value="3">
        </div>
        <div class="field">
          <label>Límite de RPM de máquina</label>
          <input id="rpmLimit" type="number" step="1" placeholder="p. ej. 12000">
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="field">
          <label>Velocidad de corte (Vc / SFM)</label>
          <input id="vc" type="number" step="0.1" placeholder="m/min o SFM">
        </div>
        <div class="field">
          <label>Chip por diente f<sub>z</sub></label>
          <input id="fz" type="number" step="0.001" placeholder="mm o in">
        </div>
        <div class="field">
          <label>Factor prudencia F</label>
          <input id="prudence" type="number" step="0.01" placeholder="0.7–1.0">
        </div>
      </div>

      <!-- Acciones -->
      <div class="flex flex-wrap gap-3 mt-4">
        <button id="calcBtn" class="btn btn-primary">Calcular</button>
        <button id="resetBtn" class="btn">Reiniciar</button>
      </div>

      <!-- Resultados -->
      <div class="grid md:grid-cols-3 gap-4 mt-6">
        <div class="bg-black/20 rounded-lg p-4">
          <div class="kpi">RPM teórico</div>
          <div class="kpi-value" id="rpmOut">—</div>
          <div id="rpmCap" class="text-xs text-amber-300 mt-1 hidden">Limitado por máquina</div>
        </div>
        <div class="bg-black/20 rounded-lg p-4">
          <div class="kpi">Avance programado</div>
          <div class="kpi-value"><span id="feedOut">—</span> <span id="feedUnit" class="text-slate-400 text-base align-middle">mm/min</span></div>
        </div>
        <div class="bg-black/20 rounded-lg p-4">
          <div class="kpi">Resumen</div>
          <div class="text-sm text-slate-300 mt-1" id="sumOut">Ingresa datos y calcula.</div>
        </div>
      </div>

      <!-- Vibración -->
      <div class="vibe-box mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Vibración estimada</h3>
          <span class="pill">Auto con tu entrada</span>
        </div>
        <div class="grid md:grid-cols-3 gap-3 items-end">
          <div class="field">
            <label>Tipo de sujeción</label>
            <select id="holder"></select>
          </div>
          <div class="md:col-span-2 text-sm" id="vibeInfo">L/D, ae y ap se estiman del diámetro y la operación.</div>
        </div>
        <p class="text-sm mt-2" id="vibeMsg"></p>
      </div>

      <!-- Referencia rápida -->
      <div class="mt-6 text-sm text-slate-300" id="refQuick"></div>
    </section>

    <!-- Relacionados -->
    <section class="mt-8">
      <h2 class="text-xl font-semibold mb-3">Entradas relacionadas</h2>
      <div id="relGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="relEmpty" class="text-slate-400 text-sm">Se mostrarán artículos recientes del blog.</div>
    </section>
  </main>

  <script>
    // ===== Helpers
    const $ = (id)=>document.getElementById(id);
    const fmt0 = (n)=>Number.isFinite(n)?Math.round(n).toLocaleString('es-MX'):'—';
    const fmt1 = (n)=>Number.isFinite(n)?(Math.round(n*10)/10).toLocaleString('es-MX'):'—';
    const fmt2 = (n)=>Number.isFinite(n)?(Math.round(n*100)/100).toLocaleString('es-MX'):'—';

    let DATA={materials:[], holders:[], vibration:{}, defaults:{}}, units='metric';

    async function loadData(){
      try{
        const r=await fetch('/data/cutting-data.json',{cache:'no-store'});
        if(r.ok){ DATA = await r.json(); }
      }catch(e){
        // Fallback mínimo si no carga el JSON
        DATA = {
          defaults:{rpm_limit:12000,prudence:0.9,stickout_mm:25,ap_mm:5},
          holders:[
            {id:'ER Collet',label:'Portapinzas ER',stiffness_factor:1.00},
            {id:'Hydraulic',label:'Portaherramienta hidráulico',stiffness_factor:1.25},
            {id:'Shrinkfit',label:'Termoencogible',stiffness_factor:1.35}
          ],
          vibration:{avoid_band_hz:[600,900],rpm_shift_pct:0.12,risk_threshold:0.85,weights:{ld:0.55,ae:0.20,ap:0.15,fz:0.10}},
          materials:[{
            id:'steel_1018',name:'Acero baja aleación 1018 (carburo)',
            vc_m_min:{rough:[120,180],finish:[160,220]},
            fz_mm:[{dia_max_mm:6,rough:[0.015,0.050],finish:[0.010,0.030]},
                   {dia_max_mm:12,rough:[0.030,0.080],finish:[0.015,0.050]},
                   {dia_max_mm:25,rough:[0.050,0.100],finish:[0.030,0.070]}],
            notes:'Usar refrigerante abundante; vigilar potencia en desbaste.'
          }]
        };
      }
    }

    function fillSelectors(){
      // materiales
      const sel=$('material'); sel.innerHTML='';
      DATA.materials.forEach(m=>{
        const o=document.createElement('option');
        o.value=m.id; o.textContent=m.name; sel.appendChild(o);
      });
      // holders
      const holderSel=$('holder'); holderSel.innerHTML='';
      DATA.holders.forEach(h=>{
        const o=document.createElement('option');
        o.value=h.id; o.textContent=h.label; holderSel.appendChild(o);
      });
      // defaults
      $('rpmLimit').value = DATA.defaults.rpm_limit || 12000;
      $('prudence').value = DATA.defaults.prudence || 0.9;
      // nota inicial
      const mat=getMaterial(); $('matNotes').textContent = mat?.notes || '';
      $('matBadge').textContent = mat ? `ID: ${mat.id}` : '';
    }

    function getMaterial(){
      const id=$('material').value;
      return DATA.materials.find(m=>m.id===id);
    }

    function diaBucketFz(mat, Dmm, op){
      if(!mat?.fz_mm) return null;
      const arr=[...mat.fz_mm].sort((a,b)=>a.dia_max_mm-b.dia_max_mm);
      let picked = arr.find(b=>Dmm<=b.dia_max_mm) || arr[arr.length-1];
      const range = picked?.[op==='finish'?'finish':'rough'];
      return Array.isArray(range)?range:null;
    }

    function setUnits(u){
      units=u;
      $('uMetric').classList.toggle('is-on', u==='metric');
      $('uImperial').classList.toggle('is-on', u==='imperial');
      $('feedUnit').textContent = (u==='metric') ? 'mm/min' : 'IPM';
      $('sumOut').textContent = 'Unidad: ' + (u==='metric'?'métrico':'imperial');
    }

    function applyPreset(){
      const mat=getMaterial(); const op=$('operation').value;
      const D=parseFloat($('diam').value)||10; $('diam').value=D;
      const vcRange = mat?.vc_m_min?.[op] || [100,200];
      const fzRange = diaBucketFz(mat, (units==='metric'?D:(D*25.4)), op) || [0.03,0.08];

      if(units==='metric'){
        $('vc').value = Math.round((vcRange[0]+vcRange[1])/2);
        $('fz').value = ((fzRange[0]+fzRange[1])/2).toFixed(3);
      }else{
        const sfmMid = ((vcRange[0]+vcRange[1])/2)*3.281;
        $('vc').value = Math.round(sfmMid);
        $('fz').value = (((fzRange[0]+fzRange[1])/2)/25.4).toFixed(3);
      }
      $('matNotes').textContent = mat?.notes || '';
      $('matBadge').textContent = mat ? `ID: ${mat.id}` : '';
      buildQuickRef(mat);
    }

    function estimateVibeParams(Dmm, op){
      const L = Math.max(DATA.defaults.stickout_mm || 25, (op==='finish' ? 2.0 : 3.0) * Dmm);
      const ae_pct = (op==='finish') ? 12 : 30;
      const ap_mm = Math.min((op==='finish' ? 0.2 : 0.5) * Dmm, Math.max(Dmm, DATA.defaults.ap_mm || 5));
      return { L, ae_pct, ap_mm };
    }

    function calc(){
      const D = parseFloat($('diam').value);
      const z = parseInt($('flutes').value,10);
      const rpmLimit = parseFloat($('rpmLimit').value||'0');
      const prud = parseFloat($('prudence').value||'1');
      const V = parseFloat($('vc').value);
      const FZ = parseFloat($('fz').value);
      const op = $('operation').value;

      if(!(D>0 && z>0 && V>0 && FZ>0)){
        $('rpmOut').textContent='—'; $('feedOut').textContent='—';
        $('vibeMsg').textContent='Faltan datos.'; return;
      }

      const Dmm = (units==='metric') ? D : D*25.4;
      const Vc_m_min = (units==='metric') ? V : (V/3.281);
      const fz_mm = (units==='metric') ? FZ : FZ*25.4;

      // RPM y feed
      let rpm = (Vc_m_min*1000)/(Math.PI*Dmm);
      let capped=false; if(rpmLimit>0 && rpm>rpmLimit){ rpm=rpmLimit; capped=true; }
      let feed = rpm * z * fz_mm * (Number.isFinite(prud) ? prud : 1);

      $('rpmOut').textContent = fmt0(rpm);
      $('feedOut').textContent = (units==='metric') ? fmt0(feed) : fmt1(feed/25.4);
      $('feedUnit').textContent = (units==='metric') ? 'mm/min' : 'IPM';
      $('rpmCap').classList.toggle('hidden', !capped);
      $('sumOut').textContent = `D=${fmt1(D)} ${(units==='metric')?'mm':'in'}, z=${z}, Vc=${fmt1(V)} ${(units==='metric')?'m/min':'SFM'}, fz=${fmt2(FZ)} ${(units==='metric')?'mm':'in'}.`;

      // Vibración con semáforo
      const holderId = $('holder').value;
      const holder = DATA.holders.find(h=>h.id===holderId) || DATA.holders[0];
      const est = estimateVibeParams(Dmm, op);
      $('vibeInfo').innerHTML = `Estimado: <code>L=${fmt1(est.L)} mm</code>, <code>ae≈${Math.round(est.ae_pct)}% D</code>, <code>ap≈${fmt1(est.ap_mm)} mm</code>.`;

      const W = DATA.vibration?.weights || {ld:0.55,ae:0.20,ap:0.15,fz:0.10};
      const stiff = holder?.stiffness_factor || 1.0;
      const L_over_D = est.L / Dmm;
      const ae_ratio = est.ae_pct/100;
      const ap_ratio = Math.min(1.2, est.ap_mm/Math.max(1, Dmm));

      let risk = ( W.ld*(L_over_D/2.0) + W.ae*ae_ratio + W.ap*ap_ratio + W.fz*Math.min(1, fz_mm/(0.1*Dmm+0.02)) ) / stiff;
      risk = Math.max(0, Math.min(2, risk));

      const band = DATA.vibration?.avoid_band_hz || [600,900];
      const shift = DATA.vibration?.rpm_shift_pct || 0.12;
      const toothHz = (rpm * z)/60;
      const inBand = (toothHz >= band[0] && toothHz <= band[1]);

      const SWEET = 0.65;  // verde
      const WARN  = 1.00;  // rojo a partir de aquí o si cae en banda
      let state = 'ok';
      if (risk >= WARN || inBand) state = 'bad';
      else if (risk >= SWEET)     state = 'warn';

      const vb = document.querySelector('.vibe-box');
      vb.classList.remove('ok','warn','bad'); vb.classList.add(state);

      let badge = `<span class="badge ${state}">${state==='ok'?'Sweet spot':state==='warn'?'Atento':'Vibra'}</span>`;
      let msg = `${badge} · L/D=${fmt2(L_over_D)} · sujeción=${holder?.label||'N/A'} · f<sub>tp</sub>=${fmt1(toothHz)} Hz · riesgo=${fmt2(risk)}.`;

      if(state==='bad' && inBand){
        const targetHz = (Math.abs(toothHz-band[0]) < Math.abs(toothHz-band[1])) ? band[0] : band[1];
        let rpmAlt = (targetHz * 60) / z;
        rpmAlt *= (toothHz < targetHz ? (1+shift) : (1-shift));
        if(rpmLimit>0 && rpmAlt>rpmLimit) rpmAlt = rpmLimit;
        const feedAlt = rpmAlt * z * fz_mm * (Number.isFinite(prud)?prud:1);
        msg += ` Sugerido salir de ${band[0]}–${band[1]} Hz → ${fmt0(rpmAlt)} RPM y ` +
               ((units==='metric') ? `${fmt0(feedAlt)} mm/min` : `${fmt1(feedAlt/25.4)} IPM`)+`.`;
      }
      $('vibeMsg').innerHTML = msg;
    }

    function resetAll(){
      document.querySelectorAll('input').forEach(i=>i.value='');
      $('flutes').value=3;
      $('rpmOut').textContent='—'; $('feedOut').textContent='—';
      $('sumOut').textContent='Ingresa datos y calcula.'; $('vibeMsg').textContent='';
      $('rpmCap').classList.add('hidden');
      applyPreset();
      const vb = document.querySelector('.vibe-box'); vb.classList.remove('ok','warn','bad');
    }

    function buildQuickRef(mat){
      if(!mat) return;
      const r=mat.vc_m_min?.rough, f=mat.vc_m_min?.finish;
      $('refQuick').innerHTML = `
        <div class="card p-3">
          <div class="font-semibold mb-1">Referencia rápida</div>
          <div class="text-sm">
            <div>${mat.name}</div>
            <div>Desbaste Vc: ${r?`${r[0]}–${r[1]} m/min`:'N/D'} | Acabado Vc: ${f?`${f[0]}–${f[1]} m/min`:'N/D'}</div>
          </div>
        </div>`;
    }

    // Relacionados: top 3 del feed si existe
    async function loadRelated(){
      try{
        const r=await fetch('/api/list-posts',{cache:'no-store'});
        if(!r.ok) throw 0;
        const j=await r.json();
        const items = (j.items||[]).slice(0,3);
        renderRel(items);
      }catch(e){/* silent */}
    }
    function renderRel(items){
      const GRID=$('relGrid'), EMPTY=$('relEmpty');
      if(!items||!items.length){ EMPTY.classList.remove('hidden'); return; }
      EMPTY.classList.add('hidden');
      GRID.innerHTML='';
      items.forEach(p=>{
        const url = p.url?.startsWith('http')||p.url?.startsWith('/') ? p.url : `/blog/${p.url}`;
        const img = p.image||'/assets/blog/placeholder.jpg';
        const el=document.createElement('article');
        el.className='card overflow-hidden';
        el.innerHTML=`
          <a href="${url}" class="block">
            <img src="${img}" class="w-full aspect-[1200/630] object-cover bg-slate-800" alt="">
          </a>
          <div class="p-3">
            <a href="${url}"><h3 class="text-base font-semibold">${p.title||'Post'}</h3></a>
            <p class="text-sm text-slate-400">${(p.description||'').slice(0,120)}</p>
          </div>`;
        GRID.appendChild(el);
      });
    }

    // ===== Init
    (async function(){
      await loadData();
      fillSelectors();
      buildQuickRef(getMaterial());

      $('uMetric').addEventListener('click',()=>setUnits('metric'));
      $('uImperial').addEventListener('click',()=>setUnits('imperial'));
      $('apply').addEventListener('click',applyPreset);
      $('calcBtn').addEventListener('click',calc);
      $('resetBtn').addEventListener('click',resetAll);
      $('material').addEventListener('change',applyPreset);
      $('operation').addEventListener('change',applyPreset);
      $('holder').addEventListener('change',calc);

      setUnits('metric');
      applyPreset();
      loadRelated();
    })();
  </script>
</body>
</html>
