<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de RPM y avance (AlexRaSa)</title>
  <meta name="description" content="Calcula RPM, avance, MRR, potencia y vibración. Presets embebidos." />
  <meta name="color-scheme" content="dark" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent:#0ea5e9; --rose:#e11d48; --emerald:#10b981; --indigo:#6366f1;
    }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu;margin:0}
    .container{max-width:1180px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .lead{color:var(--muted)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.03);padding:.5rem .8rem;border-radius:8px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
    .field>label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:.25rem}
    .field>input,.field>select{width:100%;border-radius:8px;padding:.5rem .6rem;background:var(--card);border:1px solid var(--border);color:var(--ink)}
    .field>select{background-image:none}
    .grid-2 { display:grid; grid-template-columns: 1fr 420px; gap:18px; align-items:start; }
    .grid-forms { display:grid;grid-template-columns: repeat(3, 1fr); gap:12px; }
    .section-title{ font-weight:700; color:var(--accent); margin-bottom:8px }
    .sidebar { width:420px; min-width:320px }
    .canvas-wrap{width:100%;height:160px}
    .canvas-wrap canvas{width:100%;height:100%}
    .muted{color:var(--muted)}
    .result-value{ font-weight:700; font-size:1.05rem; color:var(--ink) }
    .legend-dot{display:inline-block;width:12px;height:8px;border-radius:3px;margin-right:6px;vertical-align:middle}
    @media(max-width:1100px){ .grid-2{grid-template-columns:1fr} .sidebar{width:100%} .grid-forms{grid-template-columns:1fr} }

    /* Forzar selects oscuros en la mayor parte de navegadores */
    select, option {
      background-color: var(--card) !important;
      color: var(--ink) !important;
    }
    select { -webkit-appearance:none; -moz-appearance:none; appearance:none; padding-right:1rem; }
    select:focus { box-shadow: 0 0 0 3px rgba(14,165,233,0.08); border-color: var(--accent); }
    select::-ms-expand{ display:none; }
    option { padding:6px; }
  </style>
</head>
<body>
<header class="sticky top-0 z-50 bg-black/40 backdrop-blur border-b border-gray-200">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2"><img src="/assets/logo.png" alt="Logo" class="h-10" /></a>
      <nav class="hidden lg:flex gap-6 text-sm">
        <a href="/">Inicio</a><a href="/#soluciones">Soluciones</a><a href="/#recursos">Recursos</a>
      </nav>
    </div>
  </div>
</header>

<section class="py-10 text-white">
  <div class="max-w-6xl mx-auto px-4">
    <h1 class="text-3xl font-extrabold">Calculadora de <span style="color:var(--accent)">RPM y Avance</span></h1>
    <p class="lead mt-2">Estimaciones de condiciones de corte, potencia y riesgo de vibración. Datos embebidos.</p>
  </div>
</section>

<main class="container">
  <div class="grid-2">
    <!-- Inputs -->
    <div>
      <div class="card mb-4" style="display:flex;justify-content:space-between;align-items:center">
        <div><h2 style="margin:0;font-weight:800">Entradas</h2><div class="lead">Presets y parámetros</div></div>
        <div style="display:flex;gap:8px"><button id="modeF" class="tab is-on">Fresado</button><button id="modeT" class="tab">Torneado</button></div>
      </div>

      <div class="grid-forms">
        <!-- Parámetros principales (col 1) -->
        <div class="card">
          <div class="section-title">Parámetros principales</div>
          <div style="display:grid;gap:10px">
            <div class="field"><label>Material</label><select id="materialSelect"></select></div>
            <div class="field"><label>Operación</label><select id="operationSelect"></select></div>
            <div class="field"><label>Sujeción / Holder</label><select id="holderSelect"></select></div>
            <div class="field"><label>Tipo herramienta</label><select id="toolTypeSelect"></select></div>

            <div id="modeFresadoFields">
              <div class="field"><label>Diámetro herramienta D (mm)</label><input id="diam" type="number" step="0.01" value="12" /></div>
              <div class="field"><label>Dientes (z)</label><input id="z" type="number" step="1" value="4" /></div>
              <div class="field"><label>Vel. corte Vc (m/min)</label><input id="vc" type="number" step="0.1" value="180" /></div>
              <div class="field"><label>fz (mm/tooth)</label><input id="fz" type="number" step="0.0001" value="0.06" /></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div class="field"><label>Ae (mm)</label><input id="ae" type="number" step="0.01" value="10" /></div>
                <div class="field"><label>Ap (mm)</label><input id="ap" type="number" step="0.01" value="2" /></div>
              </div>
            </div>

            <div id="modeTorneadoFields" style="display:none">
              <div class="field"><label>Diámetro pieza D (mm)</label><input id="diamT" type="number" step="0.01" value="60" /></div>
              <div class="field"><label>Prof. corte ap (mm)</label><input id="apT" type="number" step="0.01" value="2" /></div>
              <div class="field"><label>Vc (m/min)</label><input id="vcT" type="number" step="0.1" value="120" /></div>
              <div class="field"><label>Avance f (mm/rev)</label><input id="fT" type="number" step="0.001" value="0.15" /></div>
            </div>

            <div class="field"><label>Stickout L (mm)</label><input id="stickout" type="number" step="1" value="60" /></div>
          </div>
        </div>

        <!-- Costos & Opciones (col 2) -->
        <div class="card">
          <div class="section-title">Costos & Opciones</div>
          <div style="display:grid;gap:10px">
            <div class="field"><label>Costo hora máquina (USD)</label><input id="machineCost" type="number" step="0.1" value="20" /></div>
            <div class="field"><label>Costo herramienta (USD)</label><input id="toolCost" type="number" step="0.1" value="60" /></div>
            <div class="field"><label>Volumen a remover (cm³)</label><input id="volumen" type="number" step="0.01" value="18" /></div>
            <div class="field"><label>Constante Taylor C</label><input id="C" type="number" step="1" value="40000" /></div>
            <div class="field"><label>Exponente n (Taylor)</label><input id="n" type="number" step="0.01" value="0.25" /></div>
            <div style="display:flex;gap:8px;align-items:center">
              <label><input id="enableCycle" type="checkbox" class="toggle" checked /> <span class="muted">Tiempo</span></label>
              <label><input id="enableKc" type="checkbox" class="toggle" checked /> <span class="muted">Kc/Pot.</span></label>
              <label><input id="enableStability" type="checkbox" class="toggle" checked /> <span class="muted">Vibración</span></label>
            </div>
            <div class="field"><label>Exponente m (desgaste Kc(h))</label><input id="mexp" type="number" step="0.001" value="0.2" /></div>
          </div>
        </div>

        <!-- Parámetros de máquina (col 3) -->
        <div class="card">
          <div class="section-title">Parámetros de máquina</div>
          <div style="display:grid;gap:10px">
            <div class="field"><label>Máquina (preset)</label>
              <select id="machineSelect"><option value="custom">— Seleccionar máquina —</option></select>
            </div>
            <div class="field"><label>Marca / Modelo</label><input id="machineModel" type="text" value="" /></div>
            <div class="field"><label>Potencia husillo (kW)</label><input id="machinePower" type="number" step="0.1" value="15" /></div>
            <div class="field"><label>RPM máx</label><input id="machineMaxRpm" type="number" step="1" value="10000" /></div>
            <div class="field"><label>Tipo de husillo</label><input id="spindleType" type="text" value="HSK63" /></div>
            <div class="field"><label>E aproximado (GPa)</label><input id="E" type="number" step="1" value="210" /></div>
            <div class="field"><label>Stickout por defecto (mm)</label><input id="stickoutDefault" type="number" step="1" value="60" /></div>
            <div class="hint">Los presets están embebidos en <code>CUTTING_DATA</code>.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card">
        <div class="section-title">Resultados</div>
        <div id="results" style="margin-top:10px"></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnExportPdf" class="btn btn-primary" style="flex:1">Exportar PDF</button>
          <button id="btnExportCsv" class="btn" style="flex:1">Exportar CSV</button>
        </div>

        <div style="margin-top:12px" class="card">
          <div class="section-title">Ajuste de Rango (gráfica)</div>
          <div style="display:grid;gap:8px">
            <div class="field"><label>Avance min (mm/min)</label><input id="feedMin" type="number" step="1" value="200" /></div>
            <div class="field"><label>Avance max (mm/min)</label><input id="feedMax" type="number" step="1" value="2200" /></div>
            <div class="field"><label>RPM min</label><input id="rpmMin" type="number" step="10" value="200" /></div>
            <div class="field"><label>RPM max</label><input id="rpmMax" type="number" step="10" value="10000" /></div>
            <div class="hint">Ajusta aquí los ejes de la gráfica combinada.</div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- FULL-WIDTH: Gráfica combinada -->
  <section style="margin-top:18px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0;font-weight:800">Campana de Vibración & Gráficos</h3>
          <div class="muted">Gráfica única: eje X = Avance (mm/min), eje Y = RPM. Puntos coloreados por prob. de vibración. Banda 600–900 Hz convertida.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="display:flex;gap:6px;align-items:center"><div class="legend-dot" style="background:#10b981"></div><div class="muted">Seguro</div></div>
          <div style="display:flex;gap:6px;align-items:center"><div class="legend-dot" style="background:#f59e0b"></div><div class="muted">Advertencia</div></div>
          <div style="display:flex;gap:6px;align-items:center"><div class="legend-dot" style="background:#e11d48"></div><div class="muted">Riesgo</div></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px">
        <div style="height:560px"><canvas id="combinedChart"></canvas></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="card"><div class="section-title">Indicadores</div><div id="indicators" style="display:grid;gap:8px"></div></div>
          <div class="card"><div class="section-title">MRR (tendencia)</div><div class="canvas-wrap"><canvas id="chartMRR"></canvas></div></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div class="card"><div class="section-title">Tendencia Vibración</div><div class="canvas-wrap"><canvas id="chartVibTrend"></canvas></div></div>
        <div class="card"><div class="section-title">Detalles Máquina / Herramienta</div><div id="machineDetails" style="margin-top:8px"></div></div>
      </div>
    </div>
  </section>
</main>

<script>
  const $ = id => document.getElementById(id);
  function fmt(n,dec=2){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec}); }

  /* ---------------- EMBEDDED CUTTING_DATA RESTAURADO (completo) ---------------- */
  const CUTTING_DATA = {
    "version":"3.0",
    "units_supported": ["metric","imperial"],
    "conversion": {
      "mm_to_in": 0.0393700787,
      "in_to_mm": 25.4,
      "m_to_ft": 3.280839895,
      "ft_to_m": 0.3048,
      "kw_to_hp": 1.34102209,
      "hp_to_kw": 0.745699872
    },
    "defaults":{"rpm_limit":24000,"efficiency":0.8,"vibe_gauss":{"mu":0.7,"sigma":0.18},"default_flutes":4},
    "vibration":{"avoid_band_hz":[600,900],"risk_threshold":0.8,"weights":{"ld":0.5,"ae":0.2,"ap":0.2,"fz":0.1}},
    "holders": [
      {"id":"ER_Collet","label":"Portapinzas ER","stiffness_factor":1.00},
      {"id":"REGOFIX_powRgrip","label":"REGO-FIX powRgrip","stiffness_factor":1.45},
      {"id":"ShrinkFit","label":"Shrink-fit","stiffness_factor":1.60},
      {"id":"HydraulicChuck","label":"Mandril hidráulico","stiffness_factor":1.50},
      {"id":"PowerChuck","label":"Power chuck","stiffness_factor":1.30},
      {"id":"SteadyRest","label":"Steady rest / soporte","stiffness_factor":0.90},
      {"id":"PortaInsertos","label":"Porta-insertos","stiffness_factor":1.15},
      {"id":"ColletChuck","label":"Collet chuck","stiffness_factor":1.05},
      {"id":"FaceMillAdapter","label":"Adaptador para face mill","stiffness_factor":1.10},
      {"id":"ModularHolder","label":"Portaherramientas modular","stiffness_factor":1.00},
      {"id":"BoringBarHolder","label":"Porta barra / boring bar","stiffness_factor":1.08},
      {"id":"LiveToolHolder","label":"Porta-herramienta rotativa (live tool)","stiffness_factor":1.20},
      {"id":"ThreadingHolder","label":"Porta-herram. roscado","stiffness_factor":1.00},
      {"id":"TurretToolHolder","label":"Porta torreta (torneado)","stiffness_factor":1.15}
    ],
    "materials": [
      { "id": "alu_1100", "name": "Aluminio 1100", "Kc_N_per_mm2": 300, "taylor": { "C": 2000, "n": 0.12 } },
      { "id": "alu_6061", "name": "Aluminio 6061", "Kc_N_per_mm2": 800, "taylor": { "C": 1000, "n": 0.12 } },
      { "id": "alu_7075", "name": "Aluminio 7075", "Kc_N_per_mm2": 950, "taylor": { "C": 900, "n": 0.12 } },
      { "id": "steel_1018", "name": "Acero 1018", "Kc_N_per_mm2": 1200, "taylor": { "C": 5000, "n": 0.18 } },
      { "id": "steel_1045", "name": "Acero 1045", "Kc_N_per_mm2": 2000, "taylor": { "C": 300, "n": 0.2 } },
      { "id": "steel_4140", "name": "Acero 4140", "Kc_N_per_mm2": 3200, "taylor": { "C": 120, "n": 0.12 } },
      { "id": "inox_304", "name": "Inox 304", "Kc_N_per_mm2": 2200, "taylor": { "C": 200, "n": 0.18 } },
      { "id": "ti_64", "name": "Titanio Ti-6Al-4V", "Kc_N_per_mm2": 1200, "taylor": { "C": 150, "n": 0.18 } },
      { "id": "inconel_718", "name": "Inconel 718", "Kc_N_per_mm2": 4500, "taylor": { "C": 60, "n": 0.12 } },
      { "id": "cast_iron", "name": "Fundición gris", "Kc_N_per_mm2": 1800, "taylor": { "C": 500, "n": 0.15 } },
      { "id": "copper", "name": "Cobre / Latón", "Kc_N_per_mm2": 600, "taylor": { "C": 2000, "n": 0.12 } },
      { "id": "peek", "name": "PEEK (plástico)", "Kc_N_per_mm2": 150, "taylor": { "C": 1200, "n": 0.08 } },
      { "id": "cfrp", "name": "CFRP (compuesto)", "Kc_N_per_mm2": 100, "taylor": { "C": 900, "n": 0.05 } }
    ],
    "operations": [
      { "id": "rough", "label": "Desbaste", "default_ae_pct": 30, "default_ap_per_d": 0.5 },
      { "id": "semi", "label": "Semidesbaste", "default_ae_pct": 18, "default_ap_per_d": 0.4 },
      { "id": "finish", "label": "Acabado", "default_ae_pct": 12, "default_ap_per_d": 0.2 },
      { "id": "adaptive", "label": "Trocoidal / Adaptativo", "default_ae_pct": 25, "default_ap_per_d": 1.0 },
      { "id": "face", "label": "Fresado de cara (face milling)" },
      { "id": "pocket", "label": "Pocketing" },
      { "id": "profiling", "label": "Perfilado / Contorneado" },
      { "id": "plunge", "label": "Plunge milling" },
      { "id": "slotting", "label": "Slotting / Ranurado" },
      { "id": "drilling", "label": "Taladrado (peck / through)" },
      { "id": "reaming", "label": "Escariado (Reaming)" },
      { "id": "boring", "label": "Mandrinado / Boring" },
      { "id": "threading", "label": "Roscar (threading)" },
      { "id": "turn_rough", "label": "Torneado - Desbaste", "default_ap": 2 },
      { "id": "turn_finish", "label": "Torneado - Acabado" }
    ],
    "tool_types": [
      {"id":"endmill","label":"Fresa (Endmill)","vc_factor":1.00,"fz_factor":1.00,"default_flutes":4},
      {"id":"ballnose","label":"Fresa hemisférica","vc_factor":0.90,"fz_factor":0.90,"default_flutes":4},
      {"id":"facemill","label":"Fresa frontal","vc_factor":1.05,"fz_factor":1.20,"default_flutes":6},
      {"id":"drill","label":"Broca","vc_factor":0.80,"fz_factor":1.00,"default_flutes":2},
      {"id":"reamer","label":"Escariador","vc_factor":0.85,"fz_factor":1.00,"default_flutes":2},
      {"id":"indexable","label":"Fresa indexable","vc_factor":1.15,"fz_factor":1.30,"default_flutes":2},
      {"id":"turn_insert","label":"Herram. torneado (insertos)","vc_factor":1.00,"fz_factor":1.00,"default_flutes":1},
      {"id":"groove","label":"Herram. ranurado","vc_factor":0.95,"fz_factor":0.90,"default_flutes":1},
      {"id":"threading","label":"Herram. roscado","vc_factor":0.70,"fz_factor":0.50,"default_flutes":1},
      {"id":"chamfer","label":"Fresa chaflán","vc_factor":0.90,"fz_factor":0.80,"default_flutes":2},
      {"id":"shellmill","label":"Shell mill","vc_factor":1.00,"fz_factor":1.10,"default_flutes":8},
      {"id":"slotmill","label":"Fresa ranura estrecha","vc_factor":0.95,"fz_factor":1.00,"default_flutes":2},
      {"id":"threadmill","label":"Herram. roscado (mill)","vc_factor":0.70,"fz_factor":0.60,"default_flutes":1},
      {"id":"boring_bar","label":"Barra de mandrinado","vc_factor":0.90,"fz_factor":1.00,"default_flutes":1},
      {"id":"tap","label":"Macho (tap)","vc_factor":0.60,"fz_factor":0.40,"default_flutes":1}
    ],
    "machines": [
      { "id": "doosan_vmc", "brand": "Doosan", "model": "DNM4500 VMC", "type": "VMC", "power_kW": 15, "max_rpm": 10000, "stickout_default": 60, "spindle": "HSK63" },
      { "id": "doosan_puma", "brand": "Doosan", "model": "PUMA 2600", "type": "Lathe", "power_kW": 22, "max_rpm": 3500, "stickout_default": 120, "spindle": "A2-8" },
      { "id": "okk_cmh", "brand": "OKK", "model": "CMH-800V", "type": "CMH", "power_kW": 18, "max_rpm": 9000, "stickout_default": 50, "spindle": "BT40" },
      { "id": "haas_vf2", "brand": "Haas", "model": "VF-2", "type": "VMC", "power_kW": 15, "max_rpm": 10000, "stickout_default": 70, "spindle": "BT40" },
      { "id": "mazak_vcn", "brand": "Mazak", "model": "VCN-530C", "type": "VMC", "power_kW": 18.5, "max_rpm": 12000, "stickout_default": 60, "spindle": "HSK63" },
      { "id": "dmgmori_dmu", "brand": "DMG MORI", "model": "DMU 50", "type": "VMC", "power_kW": 15, "max_rpm": 15000, "stickout_default": 50, "spindle": "HSK63" },
      { "id": "fanuc_robodrill", "brand": "Fanuc", "model": "α-DiB Robodrill", "type": "Robodrill", "power_kW": 3.7, "max_rpm": 24000, "stickout_default": 40, "spindle": "BT30" },
      { "id": "makino_a55", "brand": "Makino", "model": "A55 VMC", "type": "VMC", "power_kW": 22, "max_rpm": 10000, "stickout_default": 65, "spindle": "HSK63" },
      { "id": "okuma_genos_lathe", "brand": "Okuma", "model": "Genos L250", "type": "Lathe", "power_kW": 11, "max_rpm": 4000, "stickout_default": 110, "spindle": "A2-6" },
      { "id": "nakamura_tome", "brand": "Nakamura-Tome", "model": "NTY3", "type": "Lathe", "power_kW": 15, "max_rpm": 4000, "stickout_default": 100, "spindle": "A2-8" },
      { "id": "hurco_vmx", "brand": "Hurco", "model": "VMX42", "type": "VMC", "power_kW": 11, "max_rpm": 8000, "stickout_default": 70, "spindle": "BT40" },
      { "id": "hyundai_wia", "brand": "Hyundai WIA", "model": "KF-1600", "type": "VMC", "power_kW": 15, "max_rpm": 10000, "stickout_default": 60, "spindle": "BT40" },
      { "id": "mazak_hmc", "brand": "Mazak", "model": "HMX-630", "type": "HMC", "power_kW": 30, "max_rpm": 8000, "stickout_default": 80, "spindle": "HSK100" },
      { "id": "brother_s", "brand": "Brother", "model": "Speedio S700X1", "type": "Robodrill", "power_kW": 4, "max_rpm": 24000, "stickout_default": 40, "spindle": "BT30" },
      { "id": "okuma_mb", "brand": "Okuma", "model": "MB-46V", "type": "MillTurn", "power_kW": 37, "max_rpm": 8000, "stickout_default": 80, "spindle": "HSK63" }
    ]
  };

  /* ----------------- Helper utilities ----------------- */
  const HOLDERS_BY_MODE = { fresado:['ER_Collet','REGOFIX_powRgrip','ShrinkFit','HydraulicChuck','PowerChuck','SteadyRest'], torneado:['PortaInsertos','PowerChuck','SteadyRest'] };
  const TOOLTYPES_BY_MODE = { fresado:['endmill','ballnose','facemill','indexable','drill','reamer','shellmill'], torneado:['turn_insert','groove','threading'] };

  function populateFromData(){
    const mSel = $('materialSelect'); mSel.innerHTML=''; (CUTTING_DATA.materials||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.name; mSel.appendChild(o); });
    const oSel = $('operationSelect'); oSel.innerHTML=''; (CUTTING_DATA.operations||[]).forEach(op=>{ const o=document.createElement('option'); o.value=op.id; o.textContent=op.label; oSel.appendChild(o); });
    const hSel = $('holderSelect'); hSel.innerHTML=''; (CUTTING_DATA.holders||[]).forEach(h=>{ const o=document.createElement('option'); o.value=h.id; o.textContent=h.label; hSel.appendChild(o); });
    const tSel = $('toolTypeSelect'); tSel.innerHTML=''; (CUTTING_DATA.tool_types||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.label; tSel.appendChild(o); });
    const mPres = $('machineSelect'); mPres.innerHTML = '<option value="custom">— Seleccionar máquina —</option>';
    (CUTTING_DATA.machines||[]).forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=`${m.brand} · ${m.model} · ${m.type}`; mPres.appendChild(opt); });
    updateModeOptions('fresado');
  }

  function updateModeOptions(mode){
    const holderSel = $('holderSelect'); holderSel.innerHTML='';
    const idsH = (mode==='torneado')?HOLDERS_BY_MODE.torneado:HOLDERS_BY_MODE.fresado;
    const knownHolderIds = (CUTTING_DATA.holders||[]).map(h=>h.id);
    const finalHolderIds = idsH.filter(id=>knownHolderIds.includes(id));
    const holdersToShow = finalHolderIds.length ? finalHolderIds : (CUTTING_DATA.holders||[]).map(h=>h.id);
    holdersToShow.forEach(id=>{ const h = (CUTTING_DATA.holders||[]).find(x=>x.id===id); if(h){ const o=document.createElement('option'); o.value=h.id; o.textContent=h.label||h.id; holderSel.appendChild(o); } });

    const toolSel = $('toolTypeSelect'); toolSel.innerHTML='';
    const idsT = (mode==='torneado')?TOOLTYPES_BY_MODE.torneado:TOOLTYPES_BY_MODE.fresado;
    const knownToolIds = (CUTTING_DATA.tool_types||[]).map(t=>t.id);
    const finalToolIds = idsT.filter(id=>knownToolIds.includes(id));
    const toolsToShow = finalToolIds.length ? finalToolIds : (CUTTING_DATA.tool_types||[]).map(t=>t.id);
    toolsToShow.forEach(id=>{ const t=(CUTTING_DATA.tool_types||[]).find(x=>x.id===id); if(t){ const o=document.createElement('option'); o.value=t.id; o.textContent=t.label||t.id; toolSel.appendChild(o); } });

    if(holderSel.options.length) holderSel.value = holderSel.options[0].value;
    if(toolSel.options.length) toolSel.value = toolSel.options[0].value;
  }

  function vibrationRiskScore(params){
    const w = CUTTING_DATA.vibration.weights;
    const Lnorm = Math.min(1,(params.L||0)/200);
    const aenorm = Math.min(1,((params.ae||0)/(params.D||1)));
    const apnorm = Math.min(1,((params.ap||0)/((params.D||1)*1.5)));
    const fznorm = Math.min(1,((params.fz||0)/0.5));
    const score = ((w.ld||0.5)*Lnorm + (w.ae||0.2)*aenorm + (w.ap||0.2)*apnorm + (w.fz||0.1)*fznorm);
    const mu = CUTTING_DATA.defaults.vibe_gauss.mu || 0.7;
    const sigma = CUTTING_DATA.defaults.vibe_gauss.sigma || 0.18;
    const z = (score - mu)/sigma;
    const p = 1/(1+Math.exp(-z));
    return {raw:score,prob:p};
  }

  function computeFresado(override={}) {
    const D = parseFloat(override.diam ?? $('diam').value) || 0.001;
    const z = parseInt(override.z ?? $('z').value) || 1;
    let vc = parseFloat(override.vc ?? $('vc').value) || 0.1;
    let fz = parseFloat(override.fz ?? $('fz').value) || 0.0001;
    const ae = parseFloat(override.ae ?? $('ae').value) || 0.1;
    const ap = parseFloat(override.ap ?? $('ap').value) || 0.1;
    const mat = (CUTTING_DATA.materials||[]).find(m=>m.id==$('materialSelect').value) || (CUTTING_DATA.materials||[])[0];
    const holder = (CUTTING_DATA.holders||[]).find(h=>h.id==$('holderSelect').value) || (CUTTING_DATA.holders||[])[0];
    const toolType = (CUTTING_DATA.tool_types||[]).find(t=>t.id==$('toolTypeSelect').value) || (CUTTING_DATA.tool_types||[])[0];
    vc = vc * (toolType.vc_factor || 1.0);
    fz = fz * (toolType.fz_factor || 1.0);

    const Kc0 = mat?.Kc_N_per_mm2 || 2000;
    const mexp = parseFloat($('mexp')?.value) || 0.2;
    const rpm = (vc*1000)/(Math.PI*D);
    const feed_mm_min = rpm * z * fz;
    const mrr_mm3_min = feed_mm_min * ae * ap;
    const mrr_cm3_min = mrr_mm3_min / 1000;
    const chip_h = fz;
    const Kc_h = Kc0 * Math.pow(chip_h + 1e-6, -mexp);
    const eta = CUTTING_DATA.defaults.efficiency || 0.8;
    const power_kW = (Kc_h * mrr_mm3_min) / (60*1000) / eta;
    const volumen = parseFloat($('volumen').value)||0.001;
    const time_min = volumen / Math.max(mrr_cm3_min,1e-9);
    const cost_machine = (time_min/60) * (parseFloat($('machineCost').value)||0);
    const life_min = (mat?.taylor?.C) || parseFloat($('C').value) || 40000;
    const n = (mat?.taylor?.n) || parseFloat($('n').value) || 0.25;
    const toolLife_min = life_min / Math.pow(Math.max(vc,1e-6), n);
    const pieces_per_tool = Math.max(Math.floor(toolLife_min / Math.max(time_min,1e-9)),1);
    const tool_cost_per_piece = (parseFloat($('toolCost').value)||0) / pieces_per_tool;
    const F_radial = Kc_h * ae * ap * 0.001;
    const E = (parseFloat($('E')?.value)||210) * 1000;
    const I = Math.PI * Math.pow(D,4) / 64;
    const L = parseFloat($('stickout').value||60);
    const stiffness_factor = holder?.stiffness_factor || 1.0;
    const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
    const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
    const m_eff = 0.02;
    const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
    const toothHz = (rpm/60) * z;
    const vib = vibrationRiskScore({L, ae, ap, fz, D});
    return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, power_kW, time_min, cost_machine, pieces_per_tool, tool_cost_per_piece, delta_mm, f_n, toothHz, F_radial, vib, mode:'fresado', z};
  }

  function computeTorneado(override={}) {
    const D = parseFloat(override.diamT ?? $('diamT').value) || 0.001;
    const ap = parseFloat(override.apT ?? $('apT').value) || 0.5;
    let vc = parseFloat(override.vcT ?? $('vcT').value) || 0.1;
    const f = parseFloat(override.fT ?? $('fT').value) || 0.1;
    const mat = (CUTTING_DATA.materials||[]).find(m=>m.id==$('materialSelect').value) || (CUTTING_DATA.materials||[])[0];
    const holder = (CUTTING_DATA.holders||[]).find(h=>h.id==$('holderSelect').value) || (CUTTING_DATA.holders||[])[0];
    const toolType = (CUTTING_DATA.tool_types||[]).find(t=>t.id==$('toolTypeSelect').value) || (CUTTING_DATA.tool_types||[])[0];
    vc = vc * (toolType.vc_factor || 1.0);

    const rpm = (vc*1000)/(Math.PI*D);
    const feed_mm_min = rpm * f;
    const mrr_mm3_min = Math.PI * D * ap * f * rpm / 4;
    const mrr_cm3_min = mrr_mm3_min / 1000;
    const chip_h = f;
    const mexp = parseFloat($('mexp')?.value) || 0.2;
    const Kc0 = mat?.Kc_N_per_mm2 || 2000;
    const Kc_h = Kc0 * Math.pow(chip_h + 1e-6, -mexp);
    const eta = CUTTING_DATA.defaults.efficiency || 0.8;
    const power_kW = (Kc_h * mrr_mm3_min) / (60*1000) / eta;
    const volumen = parseFloat($('volumen').value)||0.001;
    const time_min = volumen / Math.max(mrr_cm3_min,1e-9);
    const cost_machine = (time_min/60) * (parseFloat($('machineCost').value)||0);
    const life_min = (mat?.taylor?.C) || parseFloat($('C').value) || 40000;
    const n = (mat?.taylor?.n) || parseFloat($('n').value) || 0.25;
    const toolLife_min = life_min / Math.pow(Math.max(vc,1e-6), n);
    const pieces_per_tool = Math.max(Math.floor(toolLife_min / Math.max(time_min,1e-9)),1);
    const tool_cost_per_piece = (parseFloat($('toolCost').value)||0) / pieces_per_tool;
    const F_radial = Kc_h * ap * f * 0.001;
    const E = (parseFloat($('E')?.value)||210) * 1000;
    const I = Math.PI * Math.pow(D,4) / 64;
    const L = parseFloat($('stickout').value||60);
    const stiffness_factor = (holder?.stiffness_factor||1.0);
    const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
    const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
    const m_eff = 0.02;
    const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
    const toothHz = rpm/60;
    const vib = vibrationRiskScore({L, ae:ap, ap, fz:f, D});
    return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, power_kW, time_min, cost_machine, pieces_per_tool, tool_cost_per_piece, delta_mm, f_n, toothHz, F_radial, vib, mode:'torneado'};
  }

  /* ----------------- Charts & rendering (combinada) ----------------- */
  let combinedChart=null, trendChart=null, mrrChart=null;

  function colorForProb(p){ if(p>0.8) return '#e11d48'; if(p>0.5) return '#f59e0b'; return '#10b981'; }

  function buildGridPoints(mode, feedMin, feedMax, rpmMin, rpmMax, cols=36, rows=28){
    const points=[];
    for(let i=0;i<cols;i++){
      const x = feedMin + (feedMax-feedMin)*(i/(cols-1));
      for(let j=0;j<rows;j++){
        const y = rpmMin + (rpmMax-rpmMin)*(j/(rows-1));
        const cell = computeForGridMode(mode,x,y);
        points.push({x, y, prob: cell.vib.prob, score: cell.vib.raw});
      }
    }
    return points;
  }

  function computeForGridMode(mode, feed_mm_min, rpm){
    if(mode==='torneado') return computeForGrid_Torneado(feed_mm_min, rpm);
    return computeForGrid_Fresado(feed_mm_min, rpm);
  }

  function computeForGrid_Torneado(feed_mm_min, rpm){
    // derive inputs from UI where needed (D, ap, etc.)
    const D = parseFloat($('diamT').value) || 60;
    const ap = parseFloat($('apT').value) || 2;
    const f = rpm>0 ? feed_mm_min / Math.max(rpm,1e-6) : 0.001;
    const mat = (CUTTING_DATA.materials||[]).find(m=>m.id==$('materialSelect').value) || CUTTING_DATA.materials[0];
    const holder = (CUTTING_DATA.holders||[]).find(h=>h.id==$('holderSelect').value) || CUTTING_DATA.holders[0];
    const Kc0 = mat?.Kc_N_per_mm2 || 2000;
    const mexp = parseFloat($('mexp')?.value) || 0.2;
    const chip_h = f;
    const Kc_h = Kc0 * Math.pow(chip_h+1e-6, -mexp);
    const mrr_mm3_min = Math.PI * D * ap * f * rpm / 4;
    const mrr_cm3_min = mrr_mm3_min/1000;
    const F_radial = Kc_h * ap * f * 0.001;
    const L = parseFloat($('stickout').value||60);
    const E = (parseFloat($('E')?.value)||210) * 1000;
    const I = Math.PI * Math.pow(D,4) / 64;
    const stiffness_factor = holder?.stiffness_factor || 1.0;
    const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
    const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
    const m_eff = 0.02;
    const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
    const toothHz = rpm/60;
    const vib = vibrationRiskScore({L, ae:ap, ap, fz:f, D});
    return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, F_radial, delta_mm, f_n, toothHz, vib};
  }

  function computeForGrid_Fresado(feed_mm_min, rpm){
    const D = parseFloat($('diam').value) || 12;
    const z = parseInt($('z').value) || 4;
    const fz = rpm>0 ? feed_mm_min / Math.max(rpm*z,1e-9) : 0.001;
    const ae = parseFloat($('ae').value) || 10;
    const ap = parseFloat($('ap').value) || 2;
    const mat = (CUTTING_DATA.materials||[]).find(m=>m.id==$('materialSelect').value) || CUTTING_DATA.materials[0];
    const holder = (CUTTING_DATA.holders||[]).find(h=>h.id==$('holderSelect').value) || CUTTING_DATA.holders[0];
    const Kc0 = mat?.Kc_N_per_mm2 || 2000;
    const mexp = parseFloat($('mexp')?.value) || 0.2;
    const chip_h = fz;
    const Kc_h = Kc0 * Math.pow(chip_h+1e-6, -mexp);
    const mrr_mm3_min = feed_mm_min * ae * ap;
    const mrr_cm3_min = mrr_mm3_min/1000;
    const F_radial = Kc_h * ae * ap * 0.001;
    const L = parseFloat($('stickout').value||60);
    const E = (parseFloat($('E')?.value)||210) * 1000;
    const I = Math.PI * Math.pow(D,4) / 64;
    const stiffness_factor = holder?.stiffness_factor || 1.0;
    const delta_mm = (F_radial * Math.pow(L,3)) / (3 * E * I + 1e-9) / stiffness_factor;
    const k_eff = (3 * E * I) / Math.pow(L,3) * stiffness_factor;
    const m_eff = 0.02;
    const f_n = (1/(2*Math.PI)) * Math.sqrt(Math.abs(k_eff / (m_eff*1000)));
    const toothHz = (rpm/60) * z;
    const vib = vibrationRiskScore({L, ae, ap, fz, D});
    return {rpm, feed_mm_min, mrr_cm3_min, chip_h, Kc_h, F_radial, delta_mm, f_n, toothHz, vib, z};
  }

  function renderCombined(){
    const mode = $('modeT').classList.contains('is-on') ? 'torneado' : 'fresado';
    const feedMin = Number($('feedMin').value)||200;
    const feedMax = Number($('feedMax').value)||2200;
    const rpmMin = Number($('rpmMin').value)||200;
    const rpmMax = Number($('rpmMax').value)||10000;

    // build grid
    const points = buildGridPoints(mode, feedMin, feedMax, rpmMin, rpmMax, 36, 28);
    const scatter = points.map(p=>({x:p.x,y:p.y,prob:p.prob, backgroundColor: colorForProb(p.prob), r: 3 + 6*p.prob}));

    // current condition
    let current;
    if(mode==='torneado'){
      const rpm = parseFloat($('vcT').value) && parseFloat($('diamT').value) ? Math.max(1, (parseFloat($('vcT').value)*1000)/(Math.PI*parseFloat($('diamT').value))) : (rpmMin+rpmMax)/2;
      const feed_mm_min = rpm * (parseFloat($('fT').value)||0.15);
      current = computeForGrid_Torneado(feed_mm_min, rpm);
      current.feed_mm_min = feed_mm_min;
    } else {
      const D = parseFloat($('diam').value)||12;
      const vc = parseFloat($('vc').value)||180;
      const rpm = Math.max(1, (vc*1000)/(Math.PI*D));
      const z = parseInt($('z').value)||4;
      const feed_mm_min = rpm * z * (parseFloat($('fz').value)||0.06);
      current = computeForGrid_Fresado(feed_mm_min, rpm);
      current.feed_mm_min = feed_mm_min;
    }

    const datasets = [
      { label:'Grid', data: scatter, showLine:false, pointStyle:'circle', parsing:false },
      { label:'Condición actual', data:[{x:current.feed_mm_min, y:current.rpm}], pointBackgroundColor:'#ffffff', pointBorderColor:'#000000', pointRadius:10, pointStyle:'triangle' }
    ];

    if(combinedChart) combinedChart.destroy();

    const pluginBand = {
      id: 'rpmBand',
      afterDraw: chart => {
        const ctx = chart.ctx;
        const xScale = chart.scales.x;
        const yScale = chart.scales.y;
        const z = parseInt($('z').value) || 4;
        const hzMin = (CUTTING_DATA.vibration.avoid_band_hz[0]||600);
        const hzMax = (CUTTING_DATA.vibration.avoid_band_hz[1]||900);
        const rpmBandMin = hzMin * 60 / Math.max(z,1);
        const rpmBandMax = hzMax * 60 / Math.max(z,1);
        const yTop = yScale.getPixelForValue(Math.min(yScale.max, rpmBandMax));
        const yBottom = yScale.getPixelForValue(Math.max(yScale.min, rpmBandMin));
        if(yBottom <= yTop) return;
        ctx.save();
        ctx.fillStyle = 'rgba(225,29,72,0.08)';
        ctx.fillRect(xScale.left, yTop, xScale.right - xScale.left, yBottom - yTop);
        ctx.strokeStyle = 'rgba(225,29,72,0.18)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(xScale.left, yTop); ctx.lineTo(xScale.right, yTop); ctx.moveTo(xScale.left, yBottom); ctx.lineTo(xScale.right, yBottom); ctx.stroke();
        ctx.restore();
        ctx.save();
        ctx.fillStyle = 'rgba(225,29,72,0.7)'; ctx.font = '12px sans-serif';
        ctx.fillText(`Banda ${hzMin}-${hzMax} Hz (evitar)`, xScale.right - 180, yTop + 14);
        ctx.restore();
      }
    };

    const ctx = $('combinedChart').getContext('2d');
    combinedChart = new Chart(ctx, {
      type:'scatter',
      data:{datasets},
      options:{
        maintainAspectRatio:false,
        parsing:false,
        plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>{
          const p = ctx.raw;
          if(p && p.prob!=null) return `Av: ${Math.round(p.x)} mm/min · RPM: ${Math.round(p.y)} · Prob vib: ${(p.prob*100).toFixed(1)}%`;
          return '';
        }}}},
        scales:{
          x:{type:'linear',title:{display:true,text:'Avance (mm/min)'},min:feedMin,max:feedMax},
          y:{type:'linear',title:{display:true,text:'RPM'},min:rpmMin,max:rpmMax}
        }
      },
      plugins:[pluginBand]
    });

    // set per-point colors/sizes
    combinedChart.data.datasets[0].pointBackgroundColor = combinedChart.data.datasets[0].data.map(p=>p.backgroundColor);
    combinedChart.data.datasets[0].pointRadius = combinedChart.data.datasets[0].data.map(p=>p.r);
    combinedChart.update();

    renderResults(current);
    renderMRRTrend(current);
    renderVibTrend(current);
    renderMachineDetails();
  }

  function renderMRRTrend(A){
    const ctx = $('chartMRR').getContext('2d');
    const labels=[]; const data=[];
    for(let i=50;i<=150;i+=10){
      const mult = i/100;
      const feed = A.feed_mm_min * mult;
      const cell = (A.mode==='torneado' || ('mode' in A && A.mode==='torneado')) ? computeForGrid_Torneado(feed,A.rpm) : computeForGrid_Fresado(feed,A.rpm);
      labels.push(i+'%'); data.push(cell.mrr_cm3_min || 0);
    }
    if(mrrChart) mrrChart.destroy();
    mrrChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'MRR cm³/min',data}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }

  function renderVibTrend(A){
    const ctx = $('chartVibTrend').getContext('2d');
    const labels=[]; const data=[];
    for(let i=50;i<=150;i+=10){
      const mult=i/100; const feed = A.feed_mm_min * mult;
      const cell = (A.mode==='torneado' || ('mode' in A && A.mode==='torneado')) ? computeForGrid_Torneado(feed,A.rpm) : computeForGrid_Fresado(feed,A.rpm);
      labels.push(i+'%'); data.push(cell.vib.prob || 0);
    }
    if(trendChart) trendChart.destroy();
    trendChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Prob. vib',data,borderRadius:4}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:1}}}});
  }

  function renderResults(A){
    const out = $('results'); out.innerHTML='';
    const s=document.createElement('div'); s.className='card';
    s.innerHTML=`<div style="font-weight:800">Resumen — ${A.mode||'fresado'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
        <div class="muted">RPM</div><div class="result-value">${fmt(A.rpm,0)}</div>
        <div class="muted">Avance (mm/min)</div><div class="result-value">${fmt(A.feed_mm_min,2)}</div>
        <div class="muted">MRR (cm³/min)</div><div class="result-value">${fmt(A.mrr_cm3_min,3)}</div>
        <div class="muted">Potencia (kW)</div><div class="result-value">${fmt(A.Kc_h ? (A.Kc_h*A.mrr_cm3_min/1000) : 0,3)}</div>
      </div>`; out.appendChild(s);

    if($('enableCycle').checked){
      const time_min = parseFloat(A.mrr_cm3_min)>0 ? ((parseFloat($('volumen').value)||1) / Math.max(A.mrr_cm3_min,1e-9)) : 0;
      const cost_machine = (time_min/60) * (parseFloat($('machineCost').value)||0);
      const c=document.createElement('div'); c.className='card';
      c.innerHTML=`<div style="font-weight:800">Tiempo & Coste</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
          <div class="muted">Tiempo/pieza (min)</div><div class="result-value">${fmt(time_min,2)}</div>
          <div class="muted">Costo máquina (USD)</div><div class="result-value">${fmt(cost_machine,2)}</div>
        </div>`; out.appendChild(c);
    }

    if($('enableKc').checked){
      const k=document.createElement('div'); k.className='card';
      k.innerHTML=`<div style="font-weight:800">Kc & Potencia</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
          <div class="muted">Chip thickness (mm)</div><div class="result-value">${fmt(A.chip_h||0,4)}</div>
          <div class="muted">Kc(h) (N/mm²)</div><div class="result-value">${fmt(A.Kc_h||0,1)}</div>
          <div class="muted">Potencia aprox (kW)</div><div class="result-value">${fmt((A.Kc_h||0)*A.mrr_cm3_min/1000,3)}</div>
        </div>`; out.appendChild(k);
    }

    if($('enableStability').checked){
      const st=document.createElement('div'); st.className='card';
      const riskColor = A.vib.prob > CUTTING_DATA.vibration.risk_threshold ? '#e11d48' : (A.vib.prob>0.5 ? '#f59e0b' : '#10b981');
      st.innerHTML=`<div style="font-weight:800">Vibración</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
          <div class="muted">f_n (Hz)</div><div class="result-value">${fmt(A.f_n,1)}</div>
          <div class="muted">Freq excit (Hz)</div><div class="result-value">${fmt(A.toothHz,1)}</div>
          <div class="muted">Score</div><div class="result-value">${fmt(A.vib.raw,3)}</div>
          <div class="muted">Prob. riesgo</div><div class="result-value"><span style="display:inline-block;background:${riskColor};width:10px;height:10px;border-radius:999px;margin-right:6px"></span>${fmt(A.vib.prob,2)}</div>
        </div>`; out.appendChild(st);
    }

    $('indicators').innerHTML = `<div class="muted">f_n (Hz): ${fmt(A.f_n,1)}</div><div class="muted">Freq excit (Hz): ${fmt(A.toothHz,1)}</div>`;
  }

  function renderMachineDetails(){
    const id = $('machineSelect').value;
    const m = (CUTTING_DATA.machines||[]).find(x=>x.id===id);
    const out = $('machineDetails'); out.innerHTML='';
    if(!m){ out.innerHTML = `<div class="muted">No se seleccionó preset. Ajusta manualmente los parámetros de máquina.</div>`; return; }
    out.innerHTML = `<div><strong>${m.brand} ${m.model}</strong></div>
      <div class="muted">Tipo: ${m.type}</div>
      <div class="muted">Potencia: ${m.power_kW} kW · RPM máx: ${m.max_rpm}</div>
      <div class="muted">Stickout por defecto: ${m.stickout_default} mm · Husillo: ${m.spindle}</div>`;
  }

  /* ----------------- UI wiring ----------------- */
  $('modeF').addEventListener('click', ()=>{ $('modeF').classList.add('is-on'); $('modeT').classList.remove('is-on'); document.getElementById('modeFresadoFields').style.display='block'; document.getElementById('modeTorneadoFields').style.display='none'; updateModeOptions('fresado'); renderCombined(); });
  $('modeT').addEventListener('click', ()=>{ $('modeT').classList.add('is-on'); $('modeF').classList.remove('is-on'); document.getElementById('modeFresadoFields').style.display='none'; document.getElementById('modeTorneadoFields').style.display='block'; updateModeOptions('torneado'); renderCombined(); });

  $('machineSelect').addEventListener('change', ()=>{
    const id = $('machineSelect').value;
    const m = (CUTTING_DATA.machines||[]).find(x=>x.id===id);
    if(m){
      $('machineModel').value = `${m.brand} ${m.model}`;
      $('machinePower').value = m.power_kW;
      $('machineMaxRpm').value = m.max_rpm;
      $('spindleType').value = m.spindle;
      $('stickout').value = m.stickout_default;
      $('stickoutDefault').value = m.stickout_default;
      $('machineCost').value = Math.max(10, Math.round(m.power_kW * 2));
    } else { $('machineModel').value=''; }
    renderCombined();
  });

  function attachAutoRender(){
    document.querySelectorAll('input,select').forEach(i=>{ i.addEventListener('input', debounceRender); i.addEventListener('change', debounceRender); });
  }
  let renderTimer=null;
  function debounceRender(){ if(renderTimer) clearTimeout(renderTimer); renderTimer = setTimeout(()=>{ renderCombined(); },120); }

  $('btnExportCsv').addEventListener('click', ()=>{
    const mode = $('modeT').classList.contains('is-on') ? 'torneado' : 'fresado';
    let A;
    if(mode==='torneado'){ const rpm = Math.max(1,(parseFloat($('vcT').value)*1000)/(Math.PI*parseFloat($('diamT').value||60))); const feed = rpm*(parseFloat($('fT').value)||0.15); A = computeForGrid_Torneado(feed,rpm); }
    else { const D=parseFloat($('diam').value)||12; const rpm = Math.max(1,(parseFloat($('vc').value)*1000)/(Math.PI*D)); const feed = rpm*(parseInt($('z').value)||4)*(parseFloat($('fz').value)||0.06); A = computeForGrid_Fresado(feed,rpm); }
    const rows = [['metric','value'], ['RPM',A.rpm], ['MRR_cm3_min',A.mrr_cm3_min], ['time_min', (parseFloat($('volumen').value)||1)/Math.max(A.mrr_cm3_min,1e-9)], ['cost_piece', (parseFloat($('machineCost').value)||0)*(((parseFloat($('volumen').value)||1)/Math.max(A.mrr_cm3_min,1e-9))/60)], ['vib_prob',A.vib.prob]];
    const csv = rows.map(r=> r.join(',') ).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='export_calculadora.csv'; a.click(); URL.revokeObjectURL(url);
  });

  $('btnExportPdf').addEventListener('click', ()=>{
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('landscape','pt','a4');
    const canvas = document.querySelector('#combinedChart');
    const img = canvas.toDataURL('image/png');
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    pdf.addImage(img,'PNG',20,20,pageW-40,pageH-40);
    pdf.save('reporte_vibracion.pdf');
  });

  /* ----------------- init ----------------- */
  populateFromData();
  attachAutoRender();
  renderCombined();
</script>
</body>
</html>
