<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Configurador de licencias SolidCAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: { 900: '#020617', 800: '#0F172A', 700: '#1E293B', 600: '#334155' },
            accent: { 400: '#38BDF8', 500: '#0EA5E9' },
          }
        }
      }
    };
  </script>
</head>
<body class="bg-base-900 text-slate-100">
  <div class="min-h-screen max-w-6xl mx-auto px-4 py-6 space-y-6">
    <header class="space-y-1">
      <h1 class="text-2xl font-semibold">Configurador de licencias SolidCAM</h1>
      <p class="text-sm text-slate-400">
        Define el contexto del cliente, su perfil de producción y prioridad. El sistema recomienda
        paquetes y tú puedes apagar módulos en las tablas (HSR, HSM, HSS, posts, cursos, etc.).
      </p>
      <div class="text-xs text-slate-500">
        Fórmulas (a partir del precio de sistema 1Y):
        Trade-in 2Y = (Lic+Subs 1Y) × (1 − 18.64%) ·
        Trade-in 3Y = (Lic+Subs 3Y) × (1 − 20.39%) ·
        Term = Lic × (1 − 58.7%) ·
        Subs 1Y ≈ 18% de Lic · Subs 3Y = 2.4 × Subs 1Y.
      </div>
    </header>

    <!-- FORMULARIO -->
    <section class="grid md:grid-cols-2 gap-6 bg-base-800/70 border border-base-700 rounded-xl p-4">
      <!-- Contexto cliente -->
      <div class="space-y-3">
        <h2 class="text-lg font-semibold">1. Contexto del cliente</h2>
        <p class="text-xs text-slate-400">
          Describe brevemente qué fabrica, materiales, lotes, tipo de piezas, etc.
          Esto se irá al resumen exportado.
        </p>
        <textarea id="client_desc" rows="5"
          class="w-full text-sm bg-base-900 border border-base-600 rounded-lg px-3 py-2 resize-y"
          placeholder="Ejemplo: fabrica moldes de inyección, acero P20 y H13, lotes cortos, 2 Haas 3 ejes y 1 torno Mazak…"></textarea>

        <div class="grid md:grid-cols-2 gap-3 text-sm">
          <div class="space-y-2">
            <h3 class="font-medium text-xs uppercase tracking-wide text-slate-400">
              Perfil de producción
            </h3>
            <select id="prod_profile"
              class="w-full bg-base-900 border border-base-600 rounded-lg px-2 py-1.5 text-sm">
              <option value="proto">Prototipos / alta mezcla, bajo volumen</option>
              <option value="serie_media">Series cortas / medias</option>
              <option value="serie_alta">Alta producción</option>
            </select>
          </div>
          <div class="space-y-2">
            <h3 class="font-medium text-xs uppercase tracking-wide text-slate-400">
              Prioridad principal
            </h3>
            <select id="priority"
              class="w-full bg-base-900 border border-base-600 rounded-lg px-2 py-1.5 text-sm">
              <option value="speed">Velocidad / reducción de ciclo</option>
              <option value="finish">Calidad superficial / precisión</option>
              <option value="std">Estandarización / plantillas / operadores</option>
            </select>
          </div>
        </div>

        <div class="space-y-2 text-sm pt-1">
          <h3 class="font-medium">Parque de máquinas</h3>
          <label class="flex items-center justify-between gap-2">
            <span>Centros de maquinado 3 ejes</span>
            <input id="cm_3x" type="number" min="0" value="1"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
          <label class="flex items-center justify-between gap-2">
            <span>Centros de maquinado 4 ejes (indexial / 3+1)</span>
            <input id="cm_4x" type="number" min="0" value="0"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
          <label class="flex items-center justify-between gap-2">
            <span>Centros de maquinado 5 ejes (3+2 / simultáneo)</span>
            <input id="cm_5x" type="number" min="0" value="0"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
          <label class="flex items-center justify-between gap-2">
            <span>Tornos CNC</span>
            <input id="cnc_turn" type="number" min="0" value="0"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
          <label class="flex items-center justify-between gap-2">
            <span>Tornos tipo suizo</span>
            <input id="cnc_swiss" type="number" min="0" value="0"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
          <label class="flex items-center justify-between gap-2">
            <span>Wirecut 2 ejes</span>
            <input id="wire_2x" type="number" min="0" value="0"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
          <label class="flex items-center justify-between gap-2">
            <span>Wirecut 4 ejes</span>
            <input id="wire_4x" type="number" min="0" value="0"
                   class="w-20 bg-base-900 border border-base-600 rounded px-2 py-1 text-right" />
          </label>
        </div>
      </div>

      <!-- Necesidades técnicas -->
      <div class="space-y-3">
        <h2 class="text-lg font-semibold">2. Necesidades de maquinado</h2>
        <p class="text-xs text-slate-400">
          Marca lo que el cliente pide explícitamente. El perfil/prioridad puede sugerir
          módulos extra (los puedes apagar después en la tabla).
        </p>

        <div class="space-y-1 text-sm">
          <label class="flex items-center gap-2">
            <input id="tec_imach" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>iMachining 2D/3D para reducción de ciclo</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_hsr" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>Roughing 3D (HSR / Pro 3D HSR)</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_hsm" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>Acabado 3D global (HSM)</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_hss" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>Acabado local por superficies críticas (HSS)</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_5x" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>5 ejes simultáneo</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_probe" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>Sonda en máquina (home position / medición)</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_gcode" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>Simulación G-Code / Machine Simulation</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_operators" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>Editor / Simulator para operadores</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="tec_imold" type="checkbox"
                   class="tec-input rounded border-base-600 bg-base-900" />
            <span>IMOLD Mold Designer / Electrode Designer</span>
          </label>
        </div>

        <div class="mt-3 flex flex-col gap-2 text-xs">
          <label class="flex items-center gap-2">
            <input id="add_impl" type="checkbox" checked
                   class="rounded border-base-600 bg-base-900" />
            <span>Incluir implementación CAM en sitio 8 hrs (puedes quitarla abajo)</span>
          </label>

          <div class="flex flex-wrap gap-2 pt-1">
            <button id="btn_calc"
                    class="px-4 py-2 rounded-lg bg-accent-500 text-xs font-semibold hover:bg-accent-400">
              Calcular recomendación
            </button>
            <button id="btn_reset"
                    class="px-4 py-2 rounded-lg border border-base-600 text-xs hover:bg-base-700">
              Borrar todo
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTADOS -->
    <section id="results" class="space-y-6 hidden">
      <!-- Módulos -->
      <div class="bg-base-800/80 border border-base-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Módulos recomendados (editable)</h2>
        <p class="text-xs text-slate-400">
          Desmarca “Incluir” para quitar un módulo (por ejemplo HSS). Si modificas el contexto
          y vuelves a pulsar “Calcular recomendación”, se recalcula desde cero.
        </p>

        <div class="overflow-x-auto text-xs">
          <table class="min-w-full text-right border-collapse">
            <thead class="bg-base-700 text-slate-300">
              <tr>
                <th class="px-2 py-1 text-left">Incluir</th>
                <th class="px-2 py-1 text-left">Módulo</th>
                <th class="px-2 py-1">Código sistema (1Y)</th>
                <th class="px-2 py-1">Licencia</th>
                <th class="px-2 py-1">Subs 1Y</th>
                <th class="px-2 py-1">Subs 3Y</th>
                <th class="px-2 py-1">Lic+Subs 1Y</th>
                <th class="px-2 py-1">Lic+Subs 3Y</th>
                <th class="px-2 py-1">Trade-in 2Y</th>
                <th class="px-2 py-1">Trade-in 3Y</th>
                <th class="px-2 py-1">Term</th>
                <th class="px-2 py-1">Cantidad</th>
              </tr>
            </thead>
            <tbody id="tbody_modules" class="divide-y divide-base-700"></tbody>
            <tfoot class="bg-base-900/60 font-semibold">
              <tr>
                <td class="px-2 py-1 text-left" colspan="3">Totales módulos (sólo incluidos)</td>
                <td class="px-2 py-1" id="tot_mod_lic"></td>
                <td class="px-2 py-1" id="tot_mod_s1"></td>
                <td class="px-2 py-1" id="tot_mod_s3"></td>
                <td class="px-2 py-1" id="tot_mod_ls1"></td>
                <td class="px-2 py-1" id="tot_mod_ls3"></td>
                <td class="px-2 py-1" id="tot_mod_tr2"></td>
                <td class="px-2 py-1" id="tot_mod_tr3"></td>
                <td class="px-2 py-1" id="tot_mod_term"></td>
                <td class="px-2 py-1" id="tot_mod_qty"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Posts / servicios -->
      <div class="bg-base-800/80 border border-base-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Postprocesadores y servicios (editable)</h2>
        <p class="text-xs text-slate-400">
          Incluye posts, dongle, licencias flotantes e implementación. Puedes desmarcar lo que no quieras cotizar.
        </p>

        <div class="overflow-x-auto text-xs">
          <table class="min-w-full text-right border-collapse">
            <thead class="bg-base-700 text-slate-300">
              <tr>
                <th class="px-2 py-1 text-left">Incluir</th>
                <th class="px-2 py-1 text-left">Producto</th>
                <th class="px-2 py-1">Código</th>
                <th class="px-2 py-1">Precio unitario</th>
                <th class="px-2 py-1">Cantidad</th>
                <th class="px-2 py-1">Subtotal</th>
              </tr>
            </thead>
            <tbody id="tbody_posts" class="divide-y divide-base-700"></tbody>
            <tfoot class="bg-base-900/60 font-semibold">
              <tr>
                <td class="px-2 py-1 text-left" colspan="4">Total posts / servicios</td>
                <td class="px-2 py-1" id="tot_posts_qty"></td>
                <td class="px-2 py-1" id="tot_posts_val"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Capacitaciones -->
      <div class="bg-base-800/80 border border-base-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Capacitaciones sugeridas (editable)</h2>
        <p class="text-xs text-slate-400">
          Se sugieren según módulos (Milling, iMachining, HSR/HSM/HSS, Turning, Probe, Wirecut, IMOLD).
          Desmarca lo que no quieras incluir.
        </p>

        <div class="overflow-x-auto text-xs">
          <table class="min-w-full text-right border-collapse">
            <thead class="bg-base-700 text-slate-300">
              <tr>
                <th class="px-2 py-1 text-left">Incluir</th>
                <th class="px-2 py-1 text-left">Curso</th>
                <th class="px-2 py-1">Código</th>
                <th class="px-2 py-1">Precio unitario</th>
                <th class="px-2 py-1">Cantidad</th>
                <th class="px-2 py-1">Subtotal</th>
              </tr>
            </thead>
            <tbody id="tbody_train" class="divide-y divide-base-700"></tbody>
            <tfoot class="bg-base-900/60 font-semibold">
              <tr>
                <td class="px-2 py-1 text-left" colspan="4">Total capacitación</td>
                <td class="px-2 py-1" id="tot_train_qty"></td>
                <td class="px-2 py-1" id="tot_train_val"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Resumen global + export -->
      <div class="bg-base-800/80 border border-base-700 rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Resumen económico global por modalidad</h2>

        <div class="overflow-x-auto text-xs">
          <table class="min-w-full text-right border-collapse">
            <thead class="bg-base-700 text-slate-300">
              <tr>
                <th class="px-2 py-1 text-left">Modalidad</th>
                <th class="px-2 py-1">Subtotal sin IVA</th>
                <th class="px-2 py-1">IVA 16%</th>
                <th class="px-2 py-1">Total con IVA</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-base-700">
              <tr>
                <td class="px-2 py-1 text-left">Licencia + 1 año de servicio</td>
                <td class="px-2 py-1" id="res_ls1_sub"></td>
                <td class="px-2 py-1" id="res_ls1_iva"></td>
                <td class="px-2 py-1 font-semibold text-accent-400" id="res_ls1_tot"></td>
              </tr>
              <tr>
                <td class="px-2 py-1 text-left">Licencia + 3 años de servicio</td>
                <td class="px-2 py-1" id="res_ls3_sub"></td>
                <td class="px-2 py-1" id="res_ls3_iva"></td>
                <td class="px-2 py-1 font-semibold text-accent-400" id="res_ls3_tot"></td>
              </tr>
              <tr>
                <td class="px-2 py-1 text-left">Trade-in + 2 años de servicio</td>
                <td class="px-2 py-1" id="res_tr2_sub"></td>
                <td class="px-2 py-1" id="res_tr2_iva"></td>
                <td class="px-2 py-1 font-semibold text-accent-400" id="res_tr2_tot"></td>
              </tr>
              <tr>
                <td class="px-2 py-1 text-left">Trade-in + 3 años de servicio</td>
                <td class="px-2 py-1" id="res_tr3_sub"></td>
                <td class="px-2 py-1" id="res_tr3_iva"></td>
                <td class="px-2 py-1 font-semibold text-accent-400" id="res_tr3_tot"></td>
              </tr>
              <tr>
                <td class="px-2 py-1 text-left">Sólo por 1 año sin servicio (Term)</td>
                <td class="px-2 py-1" id="res_term_sub"></td>
                <td class="px-2 py-1" id="res_term_iva"></td>
                <td class="px-2 py-1 font-semibold text-accent-400" id="res_term_tot"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-xs text-slate-400 space-y-1">
          <p>
            Cada modalidad suma:
            módulos según el esquema elegido (Lic+Subs / Trade-in / Term)
            + posts/servicios seleccionados
            + capacitación seleccionada.
          </p>
          <ul class="list-disc list-inside space-y-1">
            <li>Licencia + 1Y / 3Y = paquetes con mantenimiento incluido.</li>
            <li>Trade-in 2Y y 3Y aplican el descuento oficial sobre Lic+Subs.</li>
            <li>Term = licencia de término 12 meses, sin servicio.</li>
          </ul>
        </div>

        <div class="flex flex-wrap gap-2 text-xs pt-1">
          <button id="btn_export"
                  class="px-4 py-2 rounded-lg bg-accent-500 font-semibold hover:bg-accent-400">
            Exportar resumen (texto)
          </button>
        </div>

        <div id="export_panel" class="hidden space-y-1 text-xs">
          <p class="text-slate-400">
            Copia y pega este texto en tu CRM, correo o Excel:
          </p>
          <textarea id="export_text" rows="8"
            class="w-full bg-base-900 border border-base-600 rounded-lg px-3 py-2 font-mono text-[11px]"></textarea>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --------- CONSTANTES GENERALES ----------
    const IVA = 0.16;
    const SUB1_PCT = 0.18;
    const SUB3_FACTOR = 2.4;
    const TRADE2_DISC = 0.1864;
    const TRADE3_DISC = 0.2039;
    const TERM_DISC = 0.587;

    const PRICE = {
      // Paquetes sistema
      "SSA1008": 4602.00,
      "SSA1000": 5635.00,
      "SSA1017": 5062.20,
      "SSA1001": 8956.20,
      "SSA1028": 3894.00,
      "SSA1002": 7139.00,
      "SSA1004": 1947.00,
      "SSA1006": 1298.00,
      "SSA1031": 1298.00,
      "SSA1043": 5192.00,
      "SSA1044": 9086.00,
      "SSA1003": 2360.00,
      "SSA1035": 7659.00,
      "SSA1030": 5192.00,
      "SSA1011": 1947.00,
      "SSA1032": 1180.00,
      "SSA1033": 11210.00,
      "SSA1034": 9334.00,
      "SSA1039": 1298.00,
      "SSA1022": 2598.00,
      "SSA1036": 2467.00,
      "SSA1016": 5063.00,
      "SSA1019": 3350.00,
      "SSA1048": 3765.00,
      "SSA1049": 2467.00,
      "SSA1037": 2207.00,
      "SSA1038": 2396.00,
      "SSA1012": 2950.00,
      "SSA9013": 2814.00,
      "SSA9014": 5145.00,
      "SSA1020": 9200.00,
      "SSA1015": 12730.00,
      "SSA1005": 10133.00,
      "SSA1013": 6235.00,
      "SSA1021": 780.00,
      "SSA1027": 275.00,

      // Servicios / implementación / float / dongle
      "SSM0087": 1000.00,
      "SSM0033": 1320.00,
      "SSM0129": 150.00,

      // Postprocesadores unitarios
      "SSM0136": 500.00,
      "SSM0101": 500.00,
      "SSM0102": 1250.00,
      "SSM0100": 700.00,
      "SSM0098": 1500.00,
      "SSM0088": 2500.00,
      "SSM0134": 425.00,
      "SSM0135": 575.00,
      "SSM0086": 3076.00,
      "SSM0132": 4360.00,
      "SSM0130": 2385.00,

      // Entrenamientos
      "SSC0038": 200.00,
      "SSC0037": 200.00,
      "SSC0039": 200.00,
      "SSC0061": 750.00,
      "SSC0045": 450.00,
      "SSC0062": 450.00,
      "SSC0051": 750.00,
      "SSC0034": 450.00,
      "SSC0040": 350.00,
      "SSC0046": 350.00,
      "SSC0047": 350.00,
      "SSC0066": 320.00
    };

    const MOD_INFO = {
      "SSA1008": { name: "SolidCAM Milling (2.5D milling module)" },
      "SSA1000": { name: "Milling 2.5D + Feature recognition" },
      "SSA1017": { name: "iMachining 2D (sobre Milling)" },
      "SSA1001": { name: "iMachining 2D/3D (full)" },
      "SSA1028": { name: "iMachining 3D sin 2D" },
      "SSA1002": { name: "3D HSM module (incluye HSR)" },
      "SSA1004": { name: "HSM Rough milling module - HSR" },
      "SSA1006": { name: "HSS module (Simultaneous 3 axis)" },
      "SSA1031": { name: "Simultaneous 4 axis" },
      "SSA1043": { name: "Simultaneous 5 axis Standard" },
      "SSA1044": { name: "Simultaneous 5 axis Professional" },
      "SSA1003": { name: "Turning (base)" },
      "SSA1035": { name: "Swiss Type" },
      "SSA1030": { name: "Upgrade from HSR to full 3D HSM" },
      "SSA1011": { name: "Machine simulation / G-Code" },
      "SSA1032": { name: "Multi Axis machining" },
      "SSA1033": { name: "Multi-blade machining" },
      "SSA1034": { name: "Port machining" },
      "SSA1039": { name: "Integration (G-Code simulation)" },
      "SSA1022": { name: "Postprocessor 4 axis (paquete)" },
      "SSA1036": { name: "Solid Probe Level 1" },
      "SSA1016": { name: "Solid Probe Level 2" },
      "SSA1019": { name: "Electrode Designer (IMOLD)" },
      "SSA1048": { name: "SolidCAM for Operators Editor" },
      "SSA1049": { name: "SolidCAM for Operators Simulator" },
      "SSA1037": { name: "SolidCAM Xpress Milling" },
      "SSA1038": { name: "Upgrade to SolidCAM 2.5D" },
      "SSA1012": { name: "SolidCAM Turning (paquete)" },
      "SSA9013": { name: "SolidCAM Wirecut 2 axis (1Y)" },
      "SSA9014": { name: "SolidCAM Wirecut 2+4 axis (1Y)" },
      "SSA1020": { name: "IMOLD Mold Designer (paquete)" },
      "SSA1015": { name: "DCAMCUT Expert (paquete)" },
      "SSA1005": { name: "DCAMCUT Professional (paquete)" },
      "SSA1013": { name: "DCAMCUT Standard (paquete)" },
      "SSA1021": { name: "Floating license fee DCAM" },
      "SSA1027": { name: "Producto de prueba 1" },
      "SSM0087": { name: "Implementación CAM en sitio 8 hrs" },
      "SSM0033": { name: "Floating license fee SolidCAM" },
      "SSM0129": { name: "USB Dongle SolidCAM" }
    };

    const state = {
      modules: [],
      posts: [],
      train: []
    };

    function fmt(v) {
      if (!v || isNaN(v)) return "$ 0.00";
      return "$ " + v.toFixed(2);
    }

    function breakdownFromSystem(code, qty) {
      const ls1 = PRICE[code] || 0;
      const lic = ls1 / (1 + SUB1_PCT);
      const s1  = lic * SUB1_PCT;
      const s3  = s1 * SUB3_FACTOR;
      const ls3 = lic + s3;
      const tr2 = ls1 * (1 - TRADE2_DISC);
      const tr3 = ls3 * (1 - TRADE3_DISC);
      const term = lic * (1 - TERM_DISC);

      return {
        code,
        name: (MOD_INFO[code] && MOD_INFO[code].name) || code,
        lic, s1, s3, ls1, ls3, tr2, tr3, term,
        qty,
        included: true
      };
    }

    function addOrInc(map, code, qty) {
      if (!code || !PRICE[code]) return;
      if (!map[code]) map[code] = 0;
      map[code] += qty;
    }

    function gatherSelections() {
      const n3 = parseInt(document.getElementById("cm_3x").value || "0", 10);
      const n4 = parseInt(document.getElementById("cm_4x").value || "0", 10);
      const n5 = parseInt(document.getElementById("cm_5x").value || "0", 10);
      const nt = parseInt(document.getElementById("cnc_turn").value || "0", 10);
      const nsw = parseInt(document.getElementById("cnc_swiss").value || "0", 10);
      const w2 = parseInt(document.getElementById("wire_2x").value || "0", 10);
      const w4 = parseInt(document.getElementById("wire_4x").value || "0", 10);

      const tec = {
        imach: document.getElementById("tec_imach").checked,
        hsr:   document.getElementById("tec_hsr").checked,
        hsm:   document.getElementById("tec_hsm").checked,
        hss:   document.getElementById("tec_hss").checked,
        sim5x: document.getElementById("tec_5x").checked,
        probe: document.getElementById("tec_probe").checked,
        gcode: document.getElementById("tec_gcode").checked,
        operators: document.getElementById("tec_operators").checked,
        imold: document.getElementById("tec_imold").checked
      };
      const addImpl = document.getElementById("add_impl").checked;
      const prodProfile = document.getElementById("prod_profile").value;
      const priority = document.getElementById("priority").value;

      return { n3, n4, n5, nt, nsw, w2, w4, tec, addImpl, prodProfile, priority };
    }

    function buildRecommendation() {
      const sel = gatherSelections();
      const modMap = {};
      const postMap = {};
      const trainMap = {};
      const extraMap = {};

      const totalMills = sel.n3 + sel.n4 + sel.n5;
      const prod = sel.prodProfile;
      const pri = sel.priority;

      const wantsSpeed = pri === "speed";
      const wantsFinish = pri === "finish";
      const wantsStd = pri === "std";

      let needIMach = sel.tec.imach;
      if (!needIMach && totalMills > 0 && (wantsSpeed || prod === "serie_media" || prod === "serie_alta")) {
        needIMach = true;
      }

      let needHSR = sel.tec.hsr;
      let needHSM = sel.tec.hsm;
      let needHSS = sel.tec.hss;

      if (totalMills > 0) {
        if (wantsFinish || wantsStd) {
          if (!needHSM) needHSM = true;
        }
        if (wantsFinish && prod !== "proto") {
          if (!needHSS) needHSS = true;
        }
      }

      let needOperators = sel.tec.operators;
      if (wantsStd) needOperators = true;

      // ---- BASE MILLING ----
      if (totalMills > 0) {
        addOrInc(modMap, "SSA1008", 1);
      }

      // iMachining
      if (needIMach && totalMills > 0) {
        addOrInc(modMap, "SSA1001", 1);
        trainMap["SSC0039"] = (trainMap["SSC0039"] || 0) + 1;
      }

      // HSR / HSM / HSS lógica combinada
      if (totalMills > 0) {
        if (needHSR && needHSM) {
          addOrInc(modMap, "SSA1002", 1);
          trainMap["SSC0038"] = (trainMap["SSC0038"] || 0) + 1;
        } else if (needHSR && !needHSM) {
          addOrInc(modMap, "SSA1004", 1);
          trainMap["SSC0038"] = (trainMap["SSC0038"] || 0) + 1;
        } else if (!needHSR && needHSM) {
          addOrInc(modMap, "SSA1002", 1);
        }

        if (needHSS) {
          addOrInc(modMap, "SSA1006", 1);
          trainMap["SSC0037"] = (trainMap["SSC0037"] || 0) + 1;
        }
      }

      // 4 y 5 ejes
      if (sel.n4 > 0) {
        addOrInc(modMap, "SSA1031", 1);
        addOrInc(postMap, "SSM0101", 1);
      }
      if (sel.n5 > 0 || sel.tec.sim5x) {
        addOrInc(modMap, "SSA1043", 1);
        addOrInc(postMap, "SSM0102", 1);
      }

      // Probe
      if (sel.tec.probe) {
        addOrInc(modMap, "SSA1036", 1);
        trainMap["SSC0062"] = (trainMap["SSC0062"] || 0) + 1;
      }

      // Machine simulation / G-code
      if (sel.tec.gcode) {
        addOrInc(modMap, "SSA1011", 1);
        addOrInc(modMap, "SSA1039", 1);
      }

      // Operators
      if (needOperators) {
        addOrInc(modMap, "SSA1048", 1);
        addOrInc(modMap, "SSA1049", 1);
      }

      // IMOLD
      if (sel.tec.imold) {
        addOrInc(modMap, "SSA1020", 1);
        addOrInc(modMap, "SSA1019", 1);
        trainMap["SSC0061"] = (trainMap["SSC0061"] || 0) + 1;
        trainMap["SSC0051"] = (trainMap["SSC0051"] || 0) + 1;
      }

      // Turning / Swiss
      if (sel.nt > 0) {
        addOrInc(modMap, "SSA1012", 1);
        addOrInc(postMap, "SSM0088", 1);
        trainMap["SSC0040"] = (trainMap["SSC0040"] || 0) + 1;
      }
      if (sel.nsw > 0) {
        addOrInc(modMap, "SSA1035", 1);
        addOrInc(postMap, "SSM0100", 1);
        addOrInc(postMap, "SSM0098", 1);
        trainMap["SSC0045"] = (trainMap["SSC0045"] || 0) + 1;
      }

      // Wirecut
      if (sel.w2 > 0 || sel.w4 > 0) {
        if (sel.w4 > 0) {
          addOrInc(modMap, "SSA9014", 1);
          addOrInc(postMap, "SSM0134", 1);
          addOrInc(postMap, "SSM0135", 1);
        } else {
          addOrInc(modMap, "SSA9013", 1);
          addOrInc(postMap, "SSM0134", 1);
        }
        trainMap["SSC0046"] = (trainMap["SSC0046"] || 0) + 1;
        if (sel.w4 > 0) {
          trainMap["SSC0047"] = (trainMap["SSC0047"] || 0) + 1;
        }
      }

      // Servicios / extras (perfil serie_alta o prioridad std fuerzan implementación sugerida)
      if (sel.addImpl || prod === "serie_alta" || wantsStd) {
        extraMap["SSM0087"] = (extraMap["SSM0087"] || 0) + 1;
      }
      extraMap["SSM0129"] = (extraMap["SSM0129"] || 0) + 1;
      extraMap["SSM0033"] = (extraMap["SSM0033"] || 0) + 1;

      // Siempre un curso base de Milling si hay milling
      if (totalMills > 0) {
        trainMap["SSC0034"] = (trainMap["SSC0034"] || 0) + 1;
      }
      // Taller general
      trainMap["SSC0066"] = (trainMap["SSC0066"] || 0) + 1;

      return { modMap, postMap, trainMap, extraMap };
    }

    function renderAll() {
      const tbodyModules = document.getElementById("tbody_modules");
      const tbodyPosts   = document.getElementById("tbody_posts");
      const tbodyTrain   = document.getElementById("tbody_train");
      tbodyModules.innerHTML = "";
      tbodyPosts.innerHTML = "";
      tbodyTrain.innerHTML = "";

      state.modules.forEach((m, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1 text-left">
            <input type="checkbox" class="toggle-row rounded border-base-600 bg-base-900"
                   data-type="modules" data-idx="${idx}" ${m.included ? "checked" : ""} />
          </td>
          <td class="px-2 py-1 text-left">${m.name}</td>
          <td class="px-2 py-1">${m.code}</td>
          <td class="px-2 py-1">${fmt(m.lic * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.s1 * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.s3 * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.ls1 * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.ls3 * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.tr2 * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.tr3 * m.qty)}</td>
          <td class="px-2 py-1">${fmt(m.term * m.qty)}</td>
          <td class="px-2 py-1">${m.qty}</td>
        `;
        tbodyModules.appendChild(tr);
      });

      state.posts.forEach((p, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1 text-left">
            <input type="checkbox" class="toggle-row rounded border-base-600 bg-base-900"
                   data-type="posts" data-idx="${idx}" ${p.included ? "checked" : ""} />
          </td>
          <td class="px-2 py-1 text-left">${p.name}</td>
          <td class="px-2 py-1">${p.code}</td>
          <td class="px-2 py-1">${fmt(p.price)}</td>
          <td class="px-2 py-1">${p.qty}</td>
          <td class="px-2 py-1">${fmt(p.price * p.qty)}</td>
        `;
        tbodyPosts.appendChild(tr);
      });

      state.train.forEach((t, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1 text-left">
            <input type="checkbox" class="toggle-row rounded border-base-600 bg-base-900"
                   data-type="train" data-idx="${idx}" ${t.included ? "checked" : ""} />
          </td>
          <td class="px-2 py-1 text-left">${t.name}</td>
          <td class="px-2 py-1">${t.code}</td>
          <td class="px-2 py-1">${fmt(t.price)}</td>
          <td class="px-2 py-1">${t.qty}</td>
          <td class="px-2 py-1">${fmt(t.price * t.qty)}</td>
        `;
        tbodyTrain.appendChild(tr);
      });

      document.querySelectorAll(".toggle-row").forEach(cb => {
        cb.addEventListener("change", (e) => {
          const type = e.target.dataset.type;
          const idx  = parseInt(e.target.dataset.idx, 10);
          const arr = state[type];
          if (!arr) return;
          arr[idx].included = e.target.checked;
          recalcTotals();
        });
      });

      recalcTotals();
      document.getElementById("results").classList.remove("hidden");
    }

    function recalcTotals() {
      let totLic=0, totS1=0, totS3=0, totLs1=0, totLs3=0, totTr2=0, totTr3=0, totTerm=0, totQty=0;
      state.modules.forEach(m => {
        if (!m.included) return;
        totLic  += m.lic  * m.qty;
        totS1   += m.s1   * m.qty;
        totS3   += m.s3   * m.qty;
        totLs1  += m.ls1  * m.qty;
        totLs3  += m.ls3  * m.qty;
        totTr2  += m.tr2  * m.qty;
        totTr3  += m.tr3  * m.qty;
        totTerm += m.term * m.qty;
        totQty  += m.qty;
      });
      document.getElementById("tot_mod_lic").textContent  = fmt(totLic);
      document.getElementById("tot_mod_s1").textContent   = fmt(totS1);
      document.getElementById("tot_mod_s3").textContent   = fmt(totS3);
      document.getElementById("tot_mod_ls1").textContent  = fmt(totLs1);
      document.getElementById("tot_mod_ls3").textContent  = fmt(totLs3);
      document.getElementById("tot_mod_tr2").textContent  = fmt(totTr2);
      document.getElementById("tot_mod_tr3").textContent  = fmt(totTr3);
      document.getElementById("tot_mod_term").textContent = fmt(totTerm);
      document.getElementById("tot_mod_qty").textContent  = totQty.toString();

      let totPostsVal = 0, totPostsQty = 0;
      state.posts.forEach(p => {
        if (!p.included) return;
        totPostsVal += p.price * p.qty;
        totPostsQty += p.qty;
      });
      document.getElementById("tot_posts_val").textContent = fmt(totPostsVal);
      document.getElementById("tot_posts_qty").textContent = totPostsQty.toString();

      let totTrainVal = 0, totTrainQty = 0;
      state.train.forEach(t => {
        if (!t.included) return;
        totTrainVal += t.price * t.qty;
        totTrainQty += t.qty;
      });
      document.getElementById("tot_train_val").textContent = fmt(totTrainVal);
      document.getElementById("tot_train_qty").textContent = totTrainQty.toString();

      const extras = totPostsVal + totTrainVal;

      // Modalidad: Lic+Subs 1Y
      const ls1_sub = totLs1 + extras;
      const ls1_iva = ls1_sub * IVA;
      const ls1_tot = ls1_sub + ls1_iva;

      // Modalidad: Lic+Subs 3Y
      const ls3_sub = totLs3 + extras;
      const ls3_iva = ls3_sub * IVA;
      const ls3_tot = ls3_sub + ls3_iva;

      // Modalidad: Trade-in 2Y
      const tr2_sub = totTr2 + extras;
      const tr2_iva = tr2_sub * IVA;
      const tr2_tot = tr2_sub + tr2_iva;

      // Modalidad: Trade-in 3Y
      const tr3_sub = totTr3 + extras;
      const tr3_iva = tr3_sub * IVA;
      const tr3_tot = tr3_sub + tr3_iva;

      // Modalidad: Term (1 año sin servicio)
      const term_sub = totTerm + extras;
      const term_iva = term_sub * IVA;
      const term_tot = term_sub + term_iva;

      document.getElementById("res_ls1_sub").textContent = fmt(ls1_sub);
      document.getElementById("res_ls1_iva").textContent = fmt(ls1_iva);
      document.getElementById("res_ls1_tot").textContent = fmt(ls1_tot);

      document.getElementById("res_ls3_sub").textContent = fmt(ls3_sub);
      document.getElementById("res_ls3_iva").textContent = fmt(ls3_iva);
      document.getElementById("res_ls3_tot").textContent = fmt(ls3_tot);

      document.getElementById("res_tr2_sub").textContent = fmt(tr2_sub);
      document.getElementById("res_tr2_iva").textContent = fmt(tr2_iva);
      document.getElementById("res_tr2_tot").textContent = fmt(tr2_tot);

      document.getElementById("res_tr3_sub").textContent = fmt(tr3_sub);
      document.getElementById("res_tr3_iva").textContent = fmt(tr3_iva);
      document.getElementById("res_tr3_tot").textContent = fmt(tr3_tot);

      document.getElementById("res_term_sub").textContent = fmt(term_sub);
      document.getElementById("res_term_iva").textContent = fmt(term_iva);
      document.getElementById("res_term_tot").textContent = fmt(term_tot);
    }

    function regenerateFromForm() {
      const { modMap, postMap, trainMap, extraMap } = buildRecommendation();

      state.modules = Object.keys(modMap).map(code => breakdownFromSystem(code, modMap[code]));

      const postCombined = { ...postMap, ...extraMap };
      state.posts = Object.keys(postCombined).map(code => {
        const price = PRICE[code] || 0;
        const qty = postCombined[code];
        let name =
          (MOD_INFO[code] && MOD_INFO[code].name) ||
          (code.startsWith("SSM01") ? "Postprocesador" : "Servicio / extra");
        return { code, name, price, qty, included: true };
      });

      const trainNames = {
        "SSC0038": "Capacitación HSM Rough / HSR",
        "SSC0037": "Capacitación HSS module",
        "SSC0039": "Capacitación iMachining 2D/3D",
        "SSC0061": "Capacitación IMOLD Mold Designer",
        "SSC0045": "Capacitación Mill-Turn",
        "SSC0062": "Capacitación Solid Probe",
        "SSC0051": "Capacitación Electrode Designer (IMOLD)",
        "SSC0034": "Capacitación SolidCAM Milling 2.5D",
        "SSC0040": "Capacitación Turning",
        "SSC0046": "Capacitación Wire EDM DCAMCUT 2 ejes",
        "SSC0047": "Capacitación Wire EDM DCAMCUT 4 ejes",
        "SSC0066": "Taller de capacitación SolidCAM"
      };
      state.train = Object.keys(trainMap).map(code => {
        const price = PRICE[code] || 0;
        const qty = trainMap[code];
        const name = trainNames[code] || ("Capacitación " + code);
        return { code, name, price, qty, included: true };
      });

      renderAll();
    }

    function buildExportText() {
      const lines = [];
      const desc = document.getElementById("client_desc").value.trim();
      const sel = gatherSelections();

      const profileLabel = {
        "proto": "Prototipos / alta mezcla, bajo volumen",
        "serie_media": "Series cortas / medias",
        "serie_alta": "Alta producción"
      }[sel.prodProfile] || sel.prodProfile;

      const priorityLabel = {
        "speed": "Velocidad / reducción de ciclo",
        "finish": "Calidad superficial / precisión",
        "std": "Estandarización / plantillas / operadores"
      }[sel.priority] || sel.priority;

      lines.push("Perfil de producción: " + profileLabel);
      lines.push("Prioridad principal: " + priorityLabel);
      lines.push("");

      if (desc) {
        lines.push("Descripción del cliente:");
        lines.push(desc);
        lines.push("");
      }

      lines.push("MÓDULOS SELECCIONADOS:");
      state.modules.forEach(m => {
        if (!m.included) return;
        lines.push(`- ${m.code} | ${m.name} | Cant: ${m.qty}`);
      });
      lines.push("");

      lines.push("POSTPROCESADORES / SERVICIOS SELECCIONADOS:");
      state.posts.forEach(p => {
        if (!p.included) return;
        lines.push(`- ${p.code} | ${p.name} | Cant: ${p.qty}`);
      });
      lines.push("");

      lines.push("CAPACITACIONES SELECCIONADAS:");
      state.train.forEach(t => {
        if (!t.included) return;
        lines.push(`- ${t.code} | ${t.name} | Cant: ${t.qty}`);
      });
      lines.push("");

      return lines.join("\n");
    }

    // --------- EVENTOS ---------
    document.getElementById("btn_calc").addEventListener("click", regenerateFromForm);

    document.getElementById("btn_reset").addEventListener("click", () => {
      ["cm_3x","cm_4x","cm_5x","cnc_turn","cnc_swiss","wire_2x","wire_4x"]
        .forEach(id => document.getElementById(id).value = 0);
      document.getElementById("cm_3x").value = 1;
      document.querySelectorAll(".tec-input").forEach(el => el.checked = false);
      document.getElementById("add_impl").checked = true;
      document.getElementById("client_desc").value = "";
      document.getElementById("prod_profile").value = "proto";
      document.getElementById("priority").value = "speed";
      state.modules = [];
      state.posts = [];
      state.train = [];
      document.getElementById("results").classList.add("hidden");
      document.getElementById("export_panel").classList.add("hidden");
    });

    document.getElementById("btn_export").addEventListener("click", () => {
      const txt = buildExportText();
      const panel = document.getElementById("export_panel");
      const area  = document.getElementById("export_text");
      area.value = txt;
      panel.classList.remove("hidden");
      area.scrollIntoView({ behavior: "smooth", block: "center" });
    });
  </script>
</body>
</html>
