<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Configurador SolidCAM — Módulos y Paquetes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: { 900: '#020617', 800: '#0f172a', 700: '#1e293b' }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-base-900 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Título -->
    <header class="border-b border-slate-800 pb-4">
      <h1 class="text-2xl font-semibold">Configurador SolidCAM</h1>
      <p class="text-sm text-slate-400 mt-1">
        Define máquinas y proceso, genera recomendación de módulos, ajusta a mano y calcula precios en todas las modalidades.
      </p>
    </header>

    <!-- 1. Descripción del cliente -->
    <section class="bg-base-800/70 border border-slate-700 rounded-xl p-4 space-y-3">
      <h2 class="text-lg font-semibold">1. Proceso del cliente</h2>
      <textarea id="clienteDescripcion" rows="3"
        class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-sky-500"
        placeholder="Ejemplo: Fabrican moldes 3D en acero P20 y H13, series cortas, dos Haas 3 ejes y un centro 3 ejes Haitiano con Mitsubishi..."></textarea>
    </section>

    <!-- 2. Máquinas -->
    <section class="bg-base-800/70 border border-slate-700 rounded-xl p-4 space-y-4">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-lg font-semibold">2. Máquinas</h2>
        <button type="button" onclick="addMachineRow()"
          class="text-xs px-3 py-1.5 rounded-md border border-sky-500 text-sky-300 hover:bg-sky-500/10">
          + Agregar máquina
        </button>
      </div>

      <div id="machinesContainer" class="space-y-3"></div>
    </section>

    <!-- 3. Módulos recomendados / seleccionados -->
    <section class="bg-base-800/70 border border-slate-700 rounded-xl p-4 space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 class="text-lg font-semibold">3. Módulos SolidCAM</h2>
        <div class="flex flex-wrap gap-2">
          <button type="button" onclick="recommendModules()"
            class="text-xs px-3 py-1.5 rounded-md bg-sky-600 hover:bg-sky-500">
            Generar recomendación desde máquinas
          </button>
          <button type="button" onclick="calculateTotals()"
            class="text-xs px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500">
            Recalcular totales
          </button>
        </div>
      </div>

      <!-- Agregar manualmente módulo -->
      <div class="flex flex-wrap items-center gap-3 text-xs">
        <label class="text-slate-300">Agregar módulo manualmente:</label>
        <select id="manualModuleSelect"
          class="bg-base-900 border border-slate-700 rounded-md px-2 py-1 text-xs min-w-[220px]">
        </select>
        <button type="button" onclick="addManualModule()"
          class="px-3 py-1.5 rounded-md border border-slate-700 text-xs hover:bg-slate-800">
          Agregar
        </button>
      </div>

      <!-- Tabla de módulos -->
      <div class="overflow-x-auto border border-slate-700 rounded-lg">
        <table class="min-w-full text-xs">
          <thead class="bg-base-900/80">
            <tr>
              <th class="px-2 py-2 text-left">Incluir</th>
              <th class="px-2 py-2 text-left">Código</th>
              <th class="px-2 py-2 text-left">Módulo</th>
              <th class="px-2 py-2 text-right">Cantidad</th>
              <th class="px-2 py-2 text-right">Precio sistema (Lic+1Y)</th>
            </tr>
          </thead>
          <tbody id="modulesBody" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>
    </section>

    <!-- 4. Postprocesadores y servicios -->
    <section class="bg-base-800/70 border border-slate-700 rounded-xl p-4 space-y-4">
      <h2 class="text-lg font-semibold">4. Postprocesadores y servicios</h2>

      <div class="grid md:grid-cols-2 gap-4 text-xs">
        <!-- Postprocesadores -->
        <div class="space-y-2">
          <h3 class="font-semibold text-sm">Postprocesadores</h3>
          <p class="text-slate-400 text-[11px] mb-1">
            Post de 3 ejes son sin costo (solo se listan). Los demás sí suman al total.
          </p>
          <div class="space-y-1">
            <div class="flex items-center justify-between gap-2">
              <label for="post3ax" class="text-slate-300">Milling 3 ejes (SSM0136 – sin costo)</label>
              <input id="post3ax" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="post4ax" class="text-slate-300">Milling 4 ejes (SSM0101 – 500 USD c/u)</label>
              <input id="post4ax" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="post5ax" class="text-slate-300">Milling 5 ejes (SSM0102 – 1,250 USD c/u)</label>
              <input id="post5ax" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="postMt4" class="text-slate-300">MillTurn 4 ejes (SSM0100 – 700 USD c/u)</label>
              <input id="postMt4" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="postMt5" class="text-slate-300">MillTurn 5 ejes (SSM0098 – 1,500 USD c/u)</label>
              <input id="postMt5" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="postTurn" class="text-slate-300">Torno (SSM0088 – 2,500 USD c/u)</label>
              <input id="postTurn" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="postWire2" class="text-slate-300">Wirecut 2 ejes (SSM0134 – 425 USD c/u)</label>
              <input id="postWire2" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
            <div class="flex items-center justify-between gap-2">
              <label for="postWire4" class="text-slate-300">Wirecut 4 ejes (SSM0135 – 575 USD c/u)</label>
              <input id="postWire4" type="number" min="0" value="0"
                class="w-20 bg-base-900 border border-slate-700 rounded px-2 py-1 text-right">
            </div>
          </div>
        </div>

        <!-- Servicios -->
        <div class="space-y-2">
          <h3 class="font-semibold text-sm">Servicios / implementación</h3>
          <p class="text-slate-400 text-[11px]">
            Estos conceptos se suman igual a todas las modalidades (no tienen suscripción).
          </p>
          <div class="space-y-1">
            <label class="flex items-center justify-between gap-2">
              <span>Implementación CAM en sitio 8 h (IMP_CAM_8H – 1,000 USD)</span>
              <input id="impCam8h" type="checkbox"
                class="w-4 h-4 border-slate-500 rounded bg-base-900">
            </label>
            <label class="flex items-center justify-between gap-2">
              <span>Taller de capacitación SolidCAM (SSC0066 – 320 USD)</span>
              <input id="capGeneral" type="checkbox"
                class="w-4 h-4 border-slate-500 rounded bg-base-900">
            </label>
            <label class="flex items-center justify-between gap-2">
              <span>Capacitación HSM / HSR (SSC0038 – 200 USD)</span>
              <input id="capHsm" type="checkbox"
                class="w-4 h-4 border-slate-500 rounded bg-base-900">
            </label>
          </div>
        </div>
      </div>
    </section>

    <!-- 5. Totales -->
    <section class="bg-base-800/70 border border-slate-700 rounded-xl p-4 space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 class="text-lg font-semibold">5. Totales por modalidad</h2>
        <div class="flex flex-wrap gap-2">
          <button type="button" onclick="calculateTotals()"
            class="text-xs px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500">
            Recalcular
          </button>
          <button type="button" onclick="exportQuote()"
            class="text-xs px-3 py-1.5 rounded-md bg-slate-700 hover:bg-slate-600">
            Exportar listado
          </button>
          <button type="button" onclick="resetAll()"
            class="text-xs px-3 py-1.5 rounded-md border border-red-500 text-red-300 hover:bg-red-500/10">
            Borrar y empezar de cero
          </button>
        </div>
      </div>

      <!-- Totales sin IVA -->
      <div class="overflow-x-auto border border-slate-700 rounded-lg">
        <table class="min-w-full text-xs">
          <thead class="bg-base-900/80">
            <tr>
              <th class="px-2 py-2 text-left">Modalidad</th>
              <th class="px-2 py-2 text-right">USD sin IVA</th>
            </tr>
          </thead>
          <tbody id="totalsBody" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>

      <!-- Totales + IVA -->
      <div class="grid md:grid-cols-2 gap-4 text-xs" id="totalsVatBox"></div>

      <!-- Export -->
      <div class="space-y-1">
        <label for="exportBox" class="text-xs text-slate-300">Listado para copiar/pegar:</label>
        <textarea id="exportBox" rows="6" class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-[11px]"
          placeholder="Aquí aparecerá el listado de módulos, códigos, cantidades y totales cuando pulses Exportar."></textarea>
      </div>
    </section>
  </div>

  <script>
    // Parámetros globales
    const VAT_RATE = 0.16;
    const TRADEIN_2Y_DISCOUNT = 0.1864; // 18.64 %
    const TRADEIN_3Y_DISCOUNT = 0.2039; // 20.39 %
    const TERM_DISCOUNT = 0.587;        // 58.7 %
    const SUB1_RATIO = 0.18;            // Sub 1Y = 18% de la licencia
    const LIC_PLUS_SUB1_FACTOR = 1 + SUB1_RATIO; // 1.18

    // Catálogo de módulos (los precios SSA* son "Licencia + 1 año de servicio")
    const MODULES = {
      // Milling base
      "SSA1008": {
        name: "Package SolidCAM Milling (2.5D milling module)",
        priceSystem: 4602.00, // Lic+1Y
        kind: "license"
      },
      "SSA1000": {
        name: "Package Milling 2.5D + Feature recognition",
        priceSystem: 5635.00,
        kind: "license"
      },

      // iMachining
      "SSA1001": {
        name: "Package + iMachining 3D (iMachining 2D incluido)",
        priceSystem: 8956.20,
        kind: "license"
      },

      // HSM / HSR / HSS según tu definición
      "SSA1004": {
        name: "HSM básico (sin 3D) – Package HSM Rough milling module (HSR)",
        priceSystem: 1947.00,
        kind: "license"
      },
      "SSA1002": {
        name: "HSM 3D completo (incluye HSM básico / HSR)",
        priceSystem: 7139.00,
        kind: "license"
      },
      "SSA1006": {
        name: "HSS module (Simultaneous 3 axis)",
        priceSystem: 1298.00,
        kind: "license"
      },

      // Turning base + extensiones
      "SSA1012": {
        name: "Package SolidCAM Turning",
        priceSystem: 2950.00,
        kind: "license"
      },
      "SSA1035": {
        name: "Package + Swiss Type",
        priceSystem: 7659.00,
        kind: "license"
      },
      "SSA1018": {
        name: "Package + Multi-Turret Synchronization",
        priceSystem: 3765.00,
        kind: "license"
      },

      // Wirecut como paquetes 1 año
      "SSA9013": {
        name: "Package SolidCAM Wirecut 2 axis - 1 year",
        priceSystem: 2814.00,
        kind: "license"
      },
      "SSA9014": {
        name: "Package SolidCAM Wirecut 2 axis + 4 axis - 1 year",
        priceSystem: 5145.00,
        kind: "license"
      },

      // Xpress / Upgrade
      "SSA1037": {
        name: "Package SolidCAM Xpress Milling",
        priceSystem: 2207.00,
        kind: "license"
      },
      "SSA1038": {
        name: "Package Upgrade to SolidCAM 2.5D milling",
        priceSystem: 2396.00,
        kind: "license"
      },

      // Probing
      "SSA1036": {
        name: "Package Solid Probe Level 1 - Home Position",
        priceSystem: 2467.00,
        kind: "license"
      },
      "SSA1016": {
        name: "Package Solid Probe Level 2 - Home Position & Measurement",
        priceSystem: 5063.00,
        kind: "license"
      },

      // IMOLD / Electrode
      "SSA1020": {
        name: "Package IMOLD Mold Designer",
        priceSystem: 9200.00,
        kind: "license"
      },
      "SSA1019": {
        name: "Package SolidCAM Electrode Designer (IMOLD)",
        priceSystem: 3350.00,
        kind: "license"
      },

      // SolidCAM for Operators
      "SSA1048": {
        name: "Package SolidCAM for Operators Editor",
        priceSystem: 3765.00,
        kind: "license"
      },
      "SSA1049": {
        name: "Package SolidCAM for Operators Simulator",
        priceSystem: 2467.00,
        kind: "license"
      },

      // Integration / Post package
      "SSA1039": {
        name: "Package Integration (G-Code simulation)",
        priceSystem: 1298.00,
        kind: "license"
      },
      "SSA1022": {
        name: "Package Postprocessor 4 axis",
        priceSystem: 2598.00,
        kind: "license"
      },

      // Candado
      "SSM0091": {
        name: "Candado SOLIDCAM",
        priceSystem: 0.00,
        kind: "service"
      },

      // Servicios / implementación / capacitación
      "IMP_CAM_8H": {
        name: "Implementación CAM en sitio 8 horas",
        priceSystem: 1000.00,
        kind: "service"
      },
      "SSC0066": {
        name: "Taller de capacitación SOLIDCAM",
        priceSystem: 320.00,
        kind: "service"
      },
      "SSC0038": {
        name: "Capacitación HSM Rough / HSR",
        priceSystem: 200.00,
        kind: "service"
      },

      // Postprocesadores unitarios (los usamos en cálculo, no en recomendación)
      "SSM0136": {
        name: "Post-Procesador Milling 3 Axis | General",
        priceSystem: 500.00, // pero lo tratamos como 0 en el cálculo de totales
        kind: "post3free"
      },
      "SSM0101": {
        name: "Post-Procesador Milling 4 Axis | General",
        priceSystem: 500.00,
        kind: "service"
      },
      "SSM0102": {
        name: "Post-Procesador Milling 5 Axis | General",
        priceSystem: 1250.00,
        kind: "service"
      },
      "SSM0100": {
        name: "Post-Procesador MillTurn 4 Axis | General",
        priceSystem: 700.00,
        kind: "service"
      },
      "SSM0098": {
        name: "Post-Procesador MillTurn 5 Axis | General",
        priceSystem: 1500.00,
        kind: "service"
      },
      "SSM0088": {
        name: "Postprocessor Turning",
        priceSystem: 2500.00,
        kind: "service"
      },
      "SSM0134": {
        name: "PostProcessor Wirecut 2 axis",
        priceSystem: 425.00,
        kind: "service"
      },
      "SSM0135": {
        name: "PostProcessor Wirecut 4 axis",
        priceSystem: 575.00,
        kind: "service"
      }
    };

    // ---------- UTILIDADES DE PRECIO ----------

    function getPriceBreakdown(priceSystem, kind) {
      // priceSystem = Licencia + 1 año
      if (kind !== "license") {
        // Servicios: se suman igual a todas las modalidades, sin suscripción
        return {
          license: priceSystem,
          sub1: 0,
          sub3: 0,
          licPlus1: priceSystem,
          licPlus3: priceSystem,
          trade2: priceSystem,
          trade3: priceSystem,
          term: priceSystem
        };
      }

      const lic = priceSystem / LIC_PLUS_SUB1_FACTOR;
      const sub1 = lic * SUB1_RATIO;
      const sub3 = sub1 * 2.4;          // 3 años con 20% off
      const licPlus1 = priceSystem;     // dado
      const licPlus3 = lic + sub3;
      const trade2 = licPlus1 * (1 - TRADEIN_2Y_DISCOUNT);
      const trade3 = licPlus3 * (1 - TRADEIN_3Y_DISCOUNT);
      const term = lic * (1 - TERM_DISCOUNT);

      return {
        license: lic,
        sub1,
        sub3,
        licPlus1,
        licPlus3,
        trade2,
        trade3,
        term
      };
    }

    // ---------- UI: MÁQUINAS ----------

    let machineCounter = 0;

    function addMachineRow() {
      const container = document.getElementById("machinesContainer");
      const id = ++machineCounter;

      const wrapper = document.createElement("div");
      wrapper.className = "border border-slate-700 rounded-lg p-3 space-y-2 bg-base-900/60";
      wrapper.dataset.machineId = id;

      wrapper.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="font-semibold text-sm">Máquina #${id}</div>
          <button type="button" class="text-[11px] text-red-300 hover:text-red-200"
            onclick="removeMachineRow(${id})">Eliminar</button>
        </div>
        <div class="grid md:grid-cols-4 gap-2 text-xs">
          <div class="space-y-1">
            <label class="block text-slate-300">Tipo de máquina</label>
            <select class="machine-type w-full bg-base-900 border border-slate-700 rounded px-2 py-1">
              <option value="cm">Centro de maquinado</option>
              <option value="tl">Torno</option>
              <option value="wire">Wirecut</option>
            </select>
          </div>
          <div class="space-y-1">
            <label class="block text-slate-300">Configuración ejes</label>
            <select class="machine-axes w-full bg-base-900 border border-slate-700 rounded px-2 py-1">
              <option value="3ax">3 ejes</option>
              <option value="3ax_mold">3 ejes (moldes 3D)</option>
              <option value="4ax_index">4 ejes indexado</option>
              <option value="4ax_sim">4 ejes simultáneo</option>
              <option value="5ax_std">5 ejes estándar</option>
              <option value="5ax_prem">5 ejes avanzado</option>
            </select>
          </div>
          <div class="space-y-1">
            <label class="block text-slate-300">Enfoque principal</label>
            <select class="machine-process w-full bg-base-900 border border-slate-700 rounded px-2 py-1">
              <option value="25d">2.5D / producción prismaticos</option>
              <option value="moldes">Moldes 3D / cavidades</option>
              <option value="electrodos">Electrodos / IMOLD</option>
              <option value="general">Maquinado general</option>
            </select>
          </div>
          <div class="space-y-1">
            <label class="block text-slate-300">Control</label>
            <input type="text" class="machine-control w-full bg-base-900 border border-slate-700 rounded px-2 py-1"
              placeholder="Ej. Haas / Fanuc / Mitsubishi">
          </div>
        </div>
        <div class="grid md:grid-cols-3 gap-2 text-[11px] mt-2">
          <div class="space-y-1">
            <div class="font-semibold text-slate-300">Opciones Milling</div>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-imachining w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>iMachining 2D/3D</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-hsm-basic w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>HSM básico (sin 3D)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-hsm-3d w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>HSM 3D completo</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-hss w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>HSS superficies locales</span>
            </label>
          </div>
          <div class="space-y-1">
            <div class="font-semibold text-slate-300">Opciones Turning</div>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-swiss w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>Swiss Type</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-multiturret w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>Multi-Turret Sync</span>
            </label>
          </div>
          <div class="space-y-1">
            <div class="font-semibold text-slate-300">Extras</div>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-probing w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>Probing (nivel 1 / 2)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-imold w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>IMOLD / Electrodos</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" class="opt-ops w-4 h-4 bg-base-900 border-slate-500 rounded">
              <span>SolidCAM for Operators</span>
            </label>
          </div>
        </div>
      `;

      container.appendChild(wrapper);
    }

    function removeMachineRow(id) {
      const container = document.getElementById("machinesContainer");
      const row = container.querySelector(`[data-machine-id="${id}"]`);
      if (row) container.removeChild(row);
    }

    // ---------- UI: MÓDULOS ----------

    function rebuildManualModuleSelect() {
      const select = document.getElementById("manualModuleSelect");
      select.innerHTML = "";
      Object.entries(MODULES).forEach(([code, m]) => {
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = `${code} — ${m.name}`;
        select.appendChild(opt);
      });
    }

    function addModuleRow(code, qty = 1) {
      const tbody = document.getElementById("modulesBody");
      // Evitar duplicados: si ya existe, solo incrementa qty
      const existing = tbody.querySelector(`tr[data-code="${code}"]`);
      if (existing) {
        const input = existing.querySelector(".module-qty");
        const current = parseInt(input.value || "0", 10);
        input.value = current + qty;
        return;
      }

      const module = MODULES[code];
      if (!module) return;

      const tr = document.createElement("tr");
      tr.dataset.code = code;

      tr.innerHTML = `
        <td class="px-2 py-1 text-center">
          <input type="checkbox" class="include-module w-4 h-4 bg-base-900 border-slate-500 rounded" checked>
        </td>
        <td class="px-2 py-1 font-mono">${code}</td>
        <td class="px-2 py-1">${module.name}</td>
        <td class="px-2 py-1 text-right">
          <input type="number" min="1" value="${qty}"
            class="module-qty w-16 bg-base-900 border border-slate-700 rounded px-2 py-0.5 text-right">
        </td>
        <td class="px-2 py-1 text-right">$${module.priceSystem.toFixed(2)}</td>
      `;

      tbody.appendChild(tr);
    }

    function addManualModule() {
      const select = document.getElementById("manualModuleSelect");
      const code = select.value;
      if (!code) return;
      addModuleRow(code, 1);
    }

    function recommendModules() {
      const container = document.getElementById("machinesContainer");
      const rows = Array.from(container.querySelectorAll("[data-machine-id]"));
      const recSet = new Set();

      rows.forEach(row => {
        const type = row.querySelector(".machine-type")?.value || "cm";
        const axes = row.querySelector(".machine-axes")?.value || "3ax";
        const process = row.querySelector(".machine-process")?.value || "25d";

        const optImach = row.querySelector(".opt-imachining")?.checked;
        const optHsmBasic = row.querySelector(".opt-hsm-basic")?.checked;
        const optHsm3d = row.querySelector(".opt-hsm-3d")?.checked;
        const optHss = row.querySelector(".opt-hss")?.checked;

        const optSwiss = row.querySelector(".opt-swiss")?.checked;
        const optMultiT = row.querySelector(".opt-multiturret")?.checked;

        const optProbing = row.querySelector(".opt-probing")?.checked;
        const optImold = row.querySelector(".opt-imold")?.checked;
        const optOps = row.querySelector(".opt-ops")?.checked;

        if (type === "cm") {
          // Base milling
          recSet.add("SSA1008");

          if (process === "moldes") {
            // Moldes → iMachining + HSM 3D por default
            recSet.add("SSA1001");
            recSet.add("SSA1002");
          } else if (optImach) {
            recSet.add("SSA1001");
          }

          if (optHsm3d) {
            recSet.add("SSA1002");
          } else if (optHsmBasic) {
            recSet.add("SSA1004");
          }

          if (optHss) {
            recSet.add("SSA1006");
          }

          if (optProbing) {
            // Si solo queremos algo básico, Level 1; tú lo puedes ajustar a mano
            recSet.add("SSA1036");
          }

          if (optImold || process === "electrodos") {
            recSet.add("SSA1020");
            recSet.add("SSA1019");
          }

          if (optOps) {
            recSet.add("SSA1048");
            recSet.add("SSA1049");
          }
        }

        if (type === "tl") {
          recSet.add("SSA1012");
          if (optSwiss) recSet.add("SSA1035");
          if (optMultiT) recSet.add("SSA1018");
        }

        if (type === "wire") {
          // Wirecut: elegimos paquete según ejes
          if (axes === "3ax" || axes === "4ax_index") {
            recSet.add("SSA9013");
          } else {
            recSet.add("SSA9014");
          }
        }

        // Ejes extra → puedes luego agregar posts según controles
        // Aquí no forzamos postprocesadores; los defines en la sección de posts.
      });

      // Siempre agregar candado
      recSet.add("SSM0091");

      // Reconstruir tabla de módulos recomendados,
      // pero respetando cantidades manuales existentes donde coincida el código.
      const tbody = document.getElementById("modulesBody");
      const oldRows = Array.from(tbody.querySelectorAll("tr[data-code]"));
      const oldQtyMap = {};
      const oldIncludeMap = {};

      oldRows.forEach(tr => {
        const code = tr.dataset.code;
        const qty = parseInt(tr.querySelector(".module-qty")?.value || "1", 10);
        const inc = tr.querySelector(".include-module")?.checked;
        oldQtyMap[code] = qty;
        oldIncludeMap[code] = inc;
      });

      tbody.innerHTML = "";
      recSet.forEach(code => {
        const m = MODULES[code];
        if (!m) return;
        const qty = oldQtyMap[code] ?? 1;
        addModuleRow(code, qty);
        // restaurar inclusión
        const tr = tbody.querySelector(`tr[data-code="${code}"]`);
        if (tr && oldIncludeMap[code] === false) {
          tr.querySelector(".include-module").checked = false;
        }
      });
    }

    // ---------- CÁLCULO DE TOTALES ----------

    function calculateTotals() {
      const totals = {
        license: 0,
        sub1: 0,
        sub3: 0,
        licPlus1: 0,
        licPlus3: 0,
        trade2: 0,
        trade3: 0,
        term: 0
      };

      const tbody = document.getElementById("modulesBody");
      const rows = Array.from(tbody.querySelectorAll("tr[data-code]"));

      rows.forEach(tr => {
        const code = tr.dataset.code;
        const include = tr.querySelector(".include-module")?.checked;
        if (!include) return;

        const module = MODULES[code];
        if (!module) return;

        const qty = parseInt(tr.querySelector(".module-qty")?.value || "1", 10) || 1;

        const breakdown = getPriceBreakdown(module.priceSystem, module.kind);
        totals.license += breakdown.license * qty;
        totals.sub1 += breakdown.sub1 * qty;
        totals.sub3 += breakdown.sub3 * qty;
        totals.licPlus1 += breakdown.licPlus1 * qty;
        totals.licPlus3 += breakdown.licPlus3 * qty;
        totals.trade2 += breakdown.trade2 * qty;
        totals.trade3 += breakdown.trade3 * qty;
        totals.term += breakdown.term * qty;
      });

      // Postprocesadores
      const n3 = parseInt(document.getElementById("post3ax").value || "0", 10) || 0;
      const n4 = parseInt(document.getElementById("post4ax").value || "0", 10) || 0;
      const n5 = parseInt(document.getElementById("post5ax").value || "0", 10) || 0;
      const nMt4 = parseInt(document.getElementById("postMt4").value || "0", 10) || 0;
      const nMt5 = parseInt(document.getElementById("postMt5").value || "0", 10) || 0;
      const nTurn = parseInt(document.getElementById("postTurn").value || "0", 10) || 0;
      const nW2 = parseInt(document.getElementById("postWire2").value || "0", 10) || 0;
      const nW4 = parseInt(document.getElementById("postWire4").value || "0", 10) || 0;

      // 3 ejes no suma costo
      const postExtras =
        n4 * MODULES["SSM0101"].priceSystem +
        n5 * MODULES["SSM0102"].priceSystem +
        nMt4 * MODULES["SSM0100"].priceSystem +
        nMt5 * MODULES["SSM0098"].priceSystem +
        nTurn * MODULES["SSM0088"].priceSystem +
        nW2 * MODULES["SSM0134"].priceSystem +
        nW4 * MODULES["SSM0135"].priceSystem;

      if (postExtras > 0) {
        totals.license += postExtras;
        totals.licPlus1 += postExtras;
        totals.licPlus3 += postExtras;
        totals.trade2 += postExtras;
        totals.trade3 += postExtras;
        totals.term += postExtras;
      }

      // Servicios extra (checkboxes)
      if (document.getElementById("impCam8h").checked) {
        const br = getPriceBreakdown(MODULES["IMP_CAM_8H"].priceSystem, "service");
        Object.keys(totals).forEach(k => totals[k] += br[k]);
      }
      if (document.getElementById("capGeneral").checked) {
        const br = getPriceBreakdown(MODULES["SSC0066"].priceSystem, "service");
        Object.keys(totals).forEach(k => totals[k] += br[k]);
      }
      if (document.getElementById("capHsm").checked) {
        const br = getPriceBreakdown(MODULES["SSC0038"].priceSystem, "service");
        Object.keys(totals).forEach(k => totals[k] += br[k]);
      }

      renderTotals(totals);
    }

    function renderTotals(t) {
      const body = document.getElementById("totalsBody");
      body.innerHTML = "";

      const rows = [
        ["Licencia (solo perpetua)", t.license],
        ["Subscripción 1 año", t.sub1],
        ["Subscripción 3 años", t.sub3],
        ["Licencia + Subs 1 año", t.licPlus1],
        ["Licencia + Subs 3 años", t.licPlus3],
        ["Trade-in Lic + 2 años servicio", t.trade2],
        ["Trade-in Lic + 3 años servicio", t.trade3],
        ["Licencia de término 1 año (Term)", t.term]
      ];

      rows.forEach(([label, value]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1">${label}</td>
          <td class="px-2 py-1 text-right">$${value.toFixed(2)}</td>
        `;
        body.appendChild(tr);
      });

      // Bloque con IVA
      const vatBox = document.getElementById("totalsVatBox");
      vatBox.innerHTML = "";

      rows.forEach(([label, value]) => {
        const card = document.createElement("div");
        const totalIva = value * (1 + VAT_RATE);
        card.className = "border border-slate-700 rounded-lg p-3 bg-base-900/60";
        card.innerHTML = `
          <div class="text-[11px] text-slate-400">${label}</div>
          <div class="text-sm font-semibold mt-1">Total + IVA (16%): $${totalIva.toFixed(2)}</div>
        `;
        vatBox.appendChild(card);
      });
    }

    // ---------- EXPORTAR ----------

    function exportQuote() {
      const desc = document.getElementById("clienteDescripcion").value.trim();
      const tbody = document.getElementById("modulesBody");
      const rows = Array.from(tbody.querySelectorAll("tr[data-code]"));

      const n3 = parseInt(document.getElementById("post3ax").value || "0", 10) || 0;
      const n4 = parseInt(document.getElementById("post4ax").value || "0", 10) || 0;
      const n5 = parseInt(document.getElementById("post5ax").value || "0", 10) || 0;
      const nMt4 = parseInt(document.getElementById("postMt4").value || "0", 10) || 0;
      const nMt5 = parseInt(document.getElementById("postMt5").value || "0", 10) || 0;
      const nTurn = parseInt(document.getElementById("postTurn").value || "0", 10) || 0;
      const nW2 = parseInt(document.getElementById("postWire2").value || "0", 10) || 0;
      const nW4 = parseInt(document.getElementById("postWire4").value || "0", 10) || 0;

      const lines = [];

      if (desc) {
        lines.push("DESCRIPCIÓN DEL PROCESO DEL CLIENTE:");
        lines.push(desc);
        lines.push("");
      }

      lines.push("MÓDULOS SELECCIONADOS:");
      if (rows.length === 0) {
        lines.push("  (sin módulos en tabla)");
      } else {
        rows.forEach(tr => {
          const code = tr.dataset.code;
          const inc = tr.querySelector(".include-module")?.checked;
          if (!inc) return;
          const qty = parseInt(tr.querySelector(".module-qty")?.value || "1", 10) || 1;
          const m = MODULES[code];
          const base = m ? m.priceSystem : 0;
          lines.push(`  x${qty}  ${code}  ${m ? m.name : ""}  (Precio sistema: ${base.toFixed(2)} USD)`);
        });
      }
      lines.push("");

      lines.push("POSTPROCESADORES:");
      lines.push(`  Milling 3 ejes (SSM0136 – sin costo): ${n3}`);
      lines.push(`  Milling 4 ejes (SSM0101): ${n4}`);
      lines.push(`  Milling 5 ejes (SSM0102): ${n5}`);
      lines.push(`  MillTurn 4 ejes (SSM0100): ${nMt4}`);
      lines.push(`  MillTurn 5 ejes (SSM0098): ${nMt5}`);
      lines.push(`  Turning (SSM0088): ${nTurn}`);
      lines.push(`  Wirecut 2 ejes (SSM0134): ${nW2}`);
      lines.push(`  Wirecut 4 ejes (SSM0135): ${nW4}`);
      lines.push("");

      const servicios = [];
      if (document.getElementById("impCam8h").checked) {
        servicios.push("IMP_CAM_8H – Implementación CAM 8 h");
      }
      if (document.getElementById("capGeneral").checked) {
        servicios.push("SSC0066 – Taller de capacitación SolidCAM");
      }
      if (document.getElementById("capHsm").checked) {
        servicios.push("SSC0038 – Capacitación HSM / HSR");
      }
      lines.push("SERVICIOS / IMPLEMENTACIÓN:");
      if (servicios.length === 0) {
        lines.push("  (sin servicios marcados)");
      } else {
        servicios.forEach(s => lines.push("  " + s));
      }

      // Incluir totales actuales (si ya se calcularon)
      const totalsBody = document.getElementById("totalsBody");
      const tRows = Array.from(totalsBody.querySelectorAll("tr"));
      if (tRows.length > 0) {
        lines.push("");
        lines.push("TOTALES (USD sin IVA):");
        tRows.forEach(tr => {
          const tds = tr.querySelectorAll("td");
          if (tds.length === 2) {
            lines.push(`  ${tds[0].textContent.trim()}: ${tds[1].textContent.trim()}`);
          }
        });
      }

      document.getElementById("exportBox").value = lines.join("\n");
    }

    function resetAll() {
      document.getElementById("clienteDescripcion").value = "";
      document.getElementById("machinesContainer").innerHTML = "";
      document.getElementById("modulesBody").innerHTML = "";
      document.getElementById("totalsBody").innerHTML = "";
      document.getElementById("totalsVatBox").innerHTML = "";
      document.getElementById("exportBox").value = "";

      document.getElementById("post3ax").value = 0;
      document.getElementById("post4ax").value = 0;
      document.getElementById("post5ax").value = 0;
      document.getElementById("postMt4").value = 0;
      document.getElementById("postMt5").value = 0;
      document.getElementById("postTurn").value = 0;
      document.getElementById("postWire2").value = 0;
      document.getElementById("postWire4").value = 0;

      document.getElementById("impCam8h").checked = false;
      document.getElementById("capGeneral").checked = false;
      document.getElementById("capHsm").checked = false;

      machineCounter = 0;
      addMachineRow();
    }

    // Inicializar
    document.addEventListener("DOMContentLoaded", () => {
      rebuildManualModuleSelect();
      addMachineRow();
    });
  </script>
</body>
</html>
