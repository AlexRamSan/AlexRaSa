<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Configurador de licencias SolidCAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: {
              900: '#020617',
              800: '#0f172a',
              700: '#1f2937'
            },
            accent: {
              500: '#e11d48'
            }
          }
        }
      }
    };
  </script>
</head>
<body class="bg-base-900 text-slate-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Configurador de licencias SolidCAM</h1>
        <p class="text-slate-400 text-sm md:text-base mt-1">
          Configura uno o varios entornos de máquinas (CM, torno, Mill-Turn, Wire). Cada entorno tiene sus módulos sugeridos;
          puedes quitar o agregar lo que gustes y el sistema suma todo para calcular licencias, servicio y escenarios.
        </p>
      </div>
    </header>

    <!-- MÁQUINAS / ENTORNOS -->
    <section class="space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div>
          <h2 class="font-semibold text-lg">1. Máquinas / entornos del cliente</h2>
          <p class="text-xs text-slate-400">
            Agrega un entorno por tipo de máquina / configuración relevante. Cada entorno puede tener diferentes módulos.
          </p>
        </div>
        <button id="btnAgregarMaquina" type="button"
          class="inline-flex items-center gap-1 bg-accent-500 text-white text-xs font-semibold px-3 py-2 rounded-lg shadow hover:brightness-110 transition">
          + Agregar máquina / entorno
        </button>
      </div>

      <div id="contenedorMaquinas" class="space-y-4">
        <!-- Tarjetas de máquinas dinámicas -->
      </div>
    </section>

    <!-- Descripción general -->
    <section class="bg-base-800 rounded-xl border border-slate-700 p-4 space-y-2">
      <h2 class="font-semibold text-lg">2. Descripción general del proceso</h2>
      <textarea id="descripcionProceso" rows="4"
        placeholder="Ejemplo: 2 Haas 3 ejes para moldes de aluminio/acero, 1 torno Doosan con subhusillo para producción en serie. Buscan reducir ciclo y mejorar vida de herramienta."
        class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500"></textarea>
      <p class="text-xs text-slate-400">
        Texto para usar en el resumen / propuesta. No afecta el cálculo.
      </p>
    </section>

    <!-- Botones generales -->
    <section class="flex flex-wrap gap-3">
      <button id="btnCalcular" type="button"
        class="inline-flex items-center gap-2 bg-accent-500 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow hover:brightness-110 transition">
        Calcular recomendación
      </button>
      <button id="btnExportar" type="button"
        class="inline-flex items-center gap-2 border border-slate-600 text-sm px-3 py-2 rounded-lg hover:bg-slate-800">
        Exportar resumen
      </button>
      <button id="btnLimpiar" type="button"
        class="inline-flex items-center gap-2 border border-slate-600 text-sm px-3 py-2 rounded-lg hover:bg-slate-800">
        Borrar y empezar de nuevo
      </button>
    </section>

    <!-- Resultados -->
    <section id="resultados" class="space-y-4">
      <!-- Módulos seleccionados -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Módulos recomendados (suma de todos los entornos)</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Módulo</th>
                <th class="px-3 py-2 text-right font-semibold">Cantidad (máquinas)</th>
                <th class="px-3 py-2 text-right font-semibold">Licencia</th>
                <th class="px-3 py-2 text-right font-semibold">Subs 1Y</th>
                <th class="px-3 py-2 text-right font-semibold">Subs 3Y</th>
                <th class="px-3 py-2 text-right font-semibold">Lic+Subs 1Y</th>
                <th class="px-3 py-2 text-right font-semibold">Lic+Subs 3Y</th>
                <th class="px-3 py-2 text-right font-semibold">Trade-in 2Y</th>
                <th class="px-3 py-2 text-right font-semibold">Trade-in 3Y</th>
                <th class="px-3 py-2 text-right font-semibold">Term (1Y)</th>
                <th class="px-3 py-2 text-left font-semibold">Código sistema (1Y)</th>
              </tr>
            </thead>
            <tbody id="tablaModulos" class="divide-y divide-slate-700">
              <!-- Renglones dinámicos -->
            </tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 font-semibold text-right" colspan="2">Totales módulos</td>
                <td class="px-3 py-2 text-right" id="totLicencia">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totSubs1Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totSubs3Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totLicSubs1Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totLicSubs3Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totTrade2Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totTrade3Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totTerm">$ 0.00</td>
                <td class="px-3 py-2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Posts -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Postprocesadores especiales</h3>

        <!-- Editor de posts -->
        <div class="flex flex-wrap items-end gap-3 mb-3">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-xs font-medium text-slate-200">Tipo de post</label>
            <select id="postTipo" class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent-500">
            </select>
          </div>
          <div class="flex-1 min-w-[160px]">
            <label class="block text-xs font-medium text-slate-200">Control / máquina</label>
            <input id="postControl" type="text"
              placeholder="Ej. Haas VF-2, Doosan Puma, Fanuc 31i"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent-500">
          </div>
          <div class="w-24">
            <label class="block text-xs font-medium text-slate-200">Cantidad</label>
            <input id="postCantidad" type="number" min="1" value="1"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent-500">
          </div>
          <button id="btnAgregarPost" type="button"
            class="inline-flex items-center h-9 mt-1.5 bg-accent-500 text-white text-xs font-semibold px-3 rounded-lg shadow hover:brightness-110 transition">
            Agregar post
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Postprocesador</th>
                <th class="px-3 py-2 text-left font-semibold">Control / máquina</th>
                <th class="px-3 py-2 text-right font-semibold">Precio unitario</th>
                <th class="px-3 py-2 text-right font-semibold">Cantidad</th>
                <th class="px-3 py-2 text-right font-semibold">Total</th>
                <th class="px-3 py-2 text-left font-semibold">Código</th>
                <th class="px-3 py-2 text-left font-semibold">Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaPosts" class="divide-y divide-slate-700"></tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 text-right font-semibold" colspan="4">Total posts</td>
                <td class="px-3 py-2 text-right" id="totPosts">$ 0.00</td>
                <td></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <p class="text-[11px] text-slate-400 mt-2">
          Nota: El post de Milling 3 ejes general se considera sin costo. Aquí solo se contabilizan 4/5 ejes, Mill-Turn, Turning dedicado, Wire, etc.
        </p>
      </div>

      <!-- Capacitaciones -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Capacitaciones sugeridas</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Curso</th>
                <th class="px-3 py-2 text-right font-semibold">Precio</th>
                <th class="px-3 py-2 text-left font-semibold">Código</th>
                <th class="px-3 py-2 text-left font-semibold">Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaCaps" class="divide-y divide-slate-700"></tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 text-right font-semibold">Total capacitación</td>
                <td class="px-3 py-2 text-right" id="totCaps">$ 0.00</td>
                <td></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Agregados manuales -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Agregados manuales (servicios / extras)</h3>

        <div class="flex flex-wrap items-end gap-3 mb-3">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-xs font-medium text-slate-200">Concepto</label>
            <select id="extraItem" class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent-500">
            </select>
          </div>
          <div class="w-24">
            <label class="block text-xs font-medium text-slate-200">Cantidad</label>
            <input id="extraQty" type="number" min="1" value="1"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent-500">
          </div>
          <button id="btnAgregarExtra" type="button"
            class="inline-flex items-center h-9 mt-1.5 bg-accent-500 text-white text-xs font-semibold px-3 rounded-lg shadow hover:brightness-110 transition">
            Agregar extra
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Concepto</th>
                <th class="px-3 py-2 text-left font-semibold">Código</th>
                <th class="px-3 py-2 text-right font-semibold">Precio unitario</th>
                <th class="px-3 py-2 text-right font-semibold">Cantidad</th>
                <th class="px-3 py-2 text-right font-semibold">Total</th>
                <th class="px-3 py-2 text-left font-semibold">Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaExtras" class="divide-y divide-slate-700"></tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 text-right font-semibold" colspan="4">Total agregados</td>
                <td class="px-3 py-2 text-right" id="totExtras">$ 0.00</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Resumen global -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Resumen económico global (módulos + posts + capacitación + agregados)</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Escenario</th>
                <th class="px-3 py-2 text-right font-semibold">Total USD</th>
                <th class="px-3 py-2 text-right font-semibold">Total + IVA (16%)</th>
              </tr>
            </thead>
            <tbody id="tablaGlobal" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>

      <!-- Comparativo de escenarios -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Comparativo entre escenarios</h3>

        <div class="flex flex-wrap items-end gap-3 mb-3">
          <div class="min-w-[200px]">
            <label class="block text-xs font-medium text-slate-200">Escenario base</label>
            <select id="escenarioBaseSelect"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent-500">
            </select>
          </div>
          <div class="flex-1 min-w-[220px]">
            <span class="block text-[11px] font-medium text-slate-200">Escenarios a comparar (marca uno o varios)</span>
            <div id="escenariosCheckContainer" class="flex flex-wrap gap-2 mt-1 text-[11px]">
            </div>
          </div>
        </div>

        <p class="text-[11px] text-slate-400 mb-2">
          Puedes elegir cualquier escenario como base y seleccionar cuáles quieres comparar contra él.
        </p>

        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Escenario</th>
                <th class="px-3 py-2 text-right font-semibold">Total USD</th>
                <th class="px-3 py-2 text-right font-semibold">Diferencia vs base</th>
                <th class="px-3 py-2 text-right font-semibold">% Diferencia</th>
              </tr>
            </thead>
            <tbody id="tablaComparativo" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
        <p class="text-[11px] text-slate-400 mt-2">
          Valores negativos en diferencia y porcentaje indican un monto menor (ahorro) respecto al escenario base seleccionado.
        </p>
      </div>
    </section>
  </div>

  <script>
    // --------------------- Datos base ---------------------

    const priceTable = {
      millingBase: 3900,
      iMach2D: 4290,
      iMach3D: 7590,
      iMach3Dwo2D: 3300,
      featureRec: 1100,
      hsm3D: 6050,
      hss: 1100,
      hsr: 1650,
      hsrToHsm: 4400,
      sim4X: 1100,
      sim5Std: 4400,
      sim5Pro: 7700,
      sim5Prem: 9900,
      rotary: 1100,
      turningAddOn: 2000,

      turningBase: 2500,
      swiss: 6490,
      multit: 3190,
      machineSim: 1650,

      probe1: 2090,
      probe2: 4290,

      xpress: 1870,
      xpressToMilling: 2030,

      gcodeSimPkg: 1298,
      imoldDesignerPkg: 9200,
      imoldElectrodePkg: 3350
    };

    const SUB_1Y_FACTOR = 0.18;
    const SUB_3Y_FACTOR = 0.432;

    const TRADE_2Y_DISCOUNT = 0.1864;
    const TRADE_3Y_DISCOUNT = 0.2039;
    const TERM_DISCOUNT = 0.587;

    const systemPackages = {
      SSA1008: { name: 'Package SolidCAM Milling (2.5D milling module)', licSubs1Y: 4602 },
      SSA1000: { name: 'Package SolidCAM Milling (2.5D milling module) + Feature recognition', licSubs1Y: 5635 },
      SSA1004: { name: 'Package + HSM Rough milling module - HSR', licSubs1Y: 1947 },
      SSA1001: { name: 'Package + iMachining 3D (iMachining 2D is already included)', licSubs1Y: 8956.2 },
      SSA1002: { name: 'Package + 3D HSM module (HSM Rough milling module - HSR is already included)', licSubs1Y: 7139 },
      SSA1035: { name: 'Package + Swiss Type', licSubs1Y: 7659 },
      SSA1018: { name: 'Package + Multi-Turret Synchronization', licSubs1Y: 3765 },
      SSA1039: { name: 'Package Integration (G-Code simulation)', licSubs1Y: 1298 },
      SSA1019: { name: 'Package SolidCAM Electrode Designer (IMOLD)', licSubs1Y: 3350 },
      SSA1020: { name: 'Package IMOLD Mold Designer', licSubs1Y: 9200 },
      SSA1036: { name: 'Package Solid Probe Level 1 - Home Position', licSubs1Y: 2467 },
      SSA1016: { name: 'Package Solid Probe Level 2 - Home Position & Measurement', licSubs1Y: 5063 },
      SSA1037: { name: 'Package SolidCAM Xpress Milling', licSubs1Y: 2207 },
      SSA1038: { name: 'Package Upgrade to SolidCAM 2.5D milling', licSubs1Y: 2396 },
      SSA1012: { name: 'Package SolidCAM Turning', licSubs1Y: 2950 },
      SSA9013: { name: 'Package SolidCAM Wirecut 2 axis - 1 year', licSubs1Y: 2814 },
      SSA9014: { name: 'Package SolidCAM Wirecut 2 axis + 4 axis - 1 year', licSubs1Y: 5145 },
    };

    const postPrices = {
      milling4: { name: 'Post-Procesador Milling 4 Axis | G/M Code | General', code: 'SSM0101', price: 500 },
      milling5: { name: 'Post-Procesador Milling 5 Axis | G/M Code | General', code: 'SSM0102', price: 1250 },
      millturn4: { name: 'Post-Procesador MillTurn 4 Axis | G/M Code | General', code: 'SSM0100', price: 700 },
      millturn5: { name: 'Postprecessor MillTurn 5 axis - GM Code - General', code: 'SSM0098', price: 1500 },
      turning: { name: 'Postprocessor Turning', code: 'SSM0088', price: 2500 },
      wire2: { name: 'PostProcessor Wirecut 2 axis', code: 'SSM0134', price: 425 },
      wire4: { name: 'PostProcessor Wirecut 4 axis', code: 'SSM0135', price: 575 },
      post4pkg: { name: 'Package Postprocessor 4 axis', code: 'SSA1022', price: 2598 }
    };

    const trainingCatalog = {
      millingBase: { name: 'Capacitación SolidCAM Milling (2.5D milling module)', code: 'SSC0034', price: 450 },
      hsr: { name: 'Capacitación HSM Rough milling module - HSR', code: 'SSC0038', price: 200 },
      hss: { name: 'Capacitación HSS module (Simultaneous 3 axis)', code: 'SSC0037', price: 200 },
      hsm3d: { name: 'Capacitación 3D HSM module + HSR Milling', code: 'SSC0036', price: 250 },
      sim4: { name: 'Capacitación + Simultaneous 4 axis', code: 'SSC0041', price: 100 },
      sim5: { name: 'Capacitación + Simultaneous 5 axis', code: 'SSC0042', price: 450 },
      probe: { name: 'Capacitación SOLID Probe', code: 'SSC0062', price: 450 },
      turning: { name: 'Capacitación Turning', code: 'SSC0040', price: 350 },
      imold: { name: 'Capacitación IMOLD Mold Designer', code: 'SSC0061', price: 750 },
      generalWorkshop: { name: 'Taller de Capacitación SOLIDCAM', code: 'SSC0066', price: 320 }
    };

    const implementationItem = {
      name: 'Implementación CAM en sitio 8 hrs',
      code: 'SSM0087',
      price: 1000
    };

    const axisOptionsByMachine = {
      cm: [
        { value: '3x', label: '3 ejes' },
        { value: '3x_moldes', label: '3 ejes (moldes 3D)' },
        { value: '4x_index', label: '4 ejes indexado' },
        { value: '4x_sim', label: '4 ejes simultáneo' },
        { value: '5x_std', label: '5 ejes estándar' },
        { value: '5x_adv', label: '5 ejes avanzado' }
      ],
      torno: [
        { value: '2x', label: '2 ejes' },
        { value: '2x_y', label: '2 ejes + Y / C' },
        { value: 'subspindle', label: 'Torno con sub-husillo / Mill-Turn básico' }
      ],
      millturn: [
        { value: 'mt_2t', label: 'Mill-Turn 2 torretas' },
        { value: 'mt_yc', label: 'Mill-Turn Y+C' },
        { value: 'mt_complex', label: 'Mill-Turn avanzado' }
      ],
      wire: [
        { value: 'wire2', label: 'Wire EDM 2 ejes' },
        { value: 'wire4', label: 'Wire EDM 4 ejes' }
      ]
    };

    const moduleCatalog = {
      millingBase: { name: 'SolidCAM Milling (2.5D milling module)', price: priceTable.millingBase, packageCode: 'SSA1008' },
      iMach2D: { name: 'iMachining 2D', price: priceTable.iMach2D, packageCode: 'SSA1017' },
      iMach3D: { name: 'iMachining 3D (incluye 2D)', price: priceTable.iMach3D, packageCode: 'SSA1001' },
      iMach3Dwo2D: { name: 'iMachining 3D sin 2D', price: priceTable.iMach3Dwo2D, packageCode: 'SSA1028' },
      featureRec: { name: 'Feature recognition', price: priceTable.featureRec, packageCode: 'SSM0004' },
      hsm3D: { name: '3D HSM module', price: priceTable.hsm3D, packageCode: 'SSA1002' },
      hss: { name: 'HSS module (Simultaneous 3 axis)', price: priceTable.hss, packageCode: 'SSA1006' },
      hsr: { name: 'HSM Rough milling module - HSR', price: priceTable.hsr, packageCode: 'SSA1004' },
      sim4X: { name: 'Simultaneous 4 axis', price: priceTable.sim4X, packageCode: 'SSA1031' },
      sim5Std: { name: 'Simultaneous 5 axis Standard', price: priceTable.sim5Std, packageCode: 'SSA1043' },
      sim5Pro: { name: 'Simultaneous 5 axis Professional', price: priceTable.sim5Pro, packageCode: 'SSA1044' },
      sim5Prem: { name: 'Simultaneous 5 axis Premium', price: priceTable.sim5Prem, packageCode: '' },
      rotary: { name: 'Rotary Machining (Screw)', price: priceTable.rotary, packageCode: 'SSA1032' },
      machineSim: { name: 'Machine simulation / G-Code simulation', price: priceTable.machineSim, packageCode: 'SSA1039' },
      probe1: { name: 'Solid Probe Level 1 - Home Position', price: priceTable.probe1, packageCode: 'SSA1036' },
      probe2: { name: 'Solid Probe Level 2 - Home Position & Measurement', price: priceTable.probe2, packageCode: 'SSA1016' },
      xpress: { name: 'SolidCAM Xpress Milling', price: priceTable.xpress, packageCode: 'SSA1037' },

      turningBase: { name: 'SolidCAM Turning', price: priceTable.turningBase, packageCode: 'SSA1012' },
      swiss: { name: 'Swiss Type', price: priceTable.swiss, packageCode: 'SSA1035' },
      multit: { name: 'Multi-Turret Synchronization', price: priceTable.multit, packageCode: 'SSA1018' },

      imoldDesigner: { name: 'IMOLD Mold Designer', price: priceTable.imoldDesignerPkg, packageCode: 'SSA1020' },
      imoldElectrode: { name: 'SolidCAM Electrode Designer (IMOLD)', price: priceTable.imoldElectrodePkg, packageCode: 'SSA1019' },

      wire2: { name: 'Wirecut 2 axis SolidCAM', price: 2385, packageCode: 'SSM0130' },
      wire24: { name: 'Wirecut 2 axis + 4 axis SolidCAM', price: 4360, packageCode: 'SSM0132' },
    };

    // Agregados manuales: catálogo dinámico con módulos, capacitaciones y servicios
    let extrasCatalog = {};

    function buildExtrasCatalog() {
      extrasCatalog = {};

      // Módulos
      Object.entries(moduleCatalog).forEach(([key, def]) => {
        extrasCatalog['mod:' + key] = {
          type: 'module',
          refKey: key,
          name: 'Módulo: ' + def.name,
          code: def.packageCode || '---',
          price: def.price
        };
      });

      // Capacitaciones
      Object.entries(trainingCatalog).forEach(([key, def]) => {
        extrasCatalog['cap:' + key] = {
          type: 'training',
          refKey: key,
          name: 'Capacitación: ' + def.name,
          code: def.code,
          price: def.price
        };
      });

      // Servicios / implementación
      extrasCatalog['extra:impl8h'] = {
        type: 'extra',
        refKey: 'impl8h',
        name: 'Servicio: ' + implementationItem.name,
        code: implementationItem.code,
        price: implementationItem.price
      };
    }

    // --------------------- Estado global ---------------------

    const moduleOverrides = {};
    const trainingOverrides = {};

    let currentPosts = [];
    let extras = [];

    let machines = [];
    let nextMachineId = 1;

    let escenariosActuales = [];
    let escenarioBaseKey = 'lic1';
    let escenariosSeleccionados = new Set();

    // --------------------- Utilidades ---------------------

    function formatUSD(value) {
      return '$ ' + value.toFixed(2);
    }

    function formatUSDFlex(value) {
      const sign = value < 0 ? '-' : '';
      return sign + '$ ' + Math.abs(value).toFixed(2);
    }

    function calcSubs1Y(licPrice) {
      return licPrice * SUB_1Y_FACTOR;
    }
    function calcSubs3Y(licPrice) {
      return licPrice * SUB_3Y_FACTOR;
    }
    function calcTrade2Y(licPrice) {
      const licSubs1Y = licPrice + calcSubs1Y(licPrice);
      return licSubs1Y * (1 - TRADE_2Y_DISCOUNT);
    }
    function calcTrade3Y(licPrice) {
      const licSubs3Y = licPrice + calcSubs3Y(licPrice);
      return licSubs3Y * (1 - TRADE_3Y_DISCOUNT);
    }
    function calcTerm(licPrice) {
      return licPrice * (1 - TERM_DISCOUNT);
    }

    // --------------------- Máquinas dinámicas ---------------------

    const machinesContainer = document.getElementById('contenedorMaquinas');
    const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');

    function updateRemoveButtonsVisibility() {
      const buttons = machinesContainer.querySelectorAll('[data-remove-machine]');
      if (buttons.length <= 1) {
        buttons.forEach(btn => btn.classList.add('hidden'));
      } else {
        buttons.forEach(btn => btn.classList.remove('hidden'));
      }
    }

    function createMachineCard() {
      const id = nextMachineId++;
      const card = document.createElement('div');
      card.className = 'bg-base-800 rounded-xl border border-slate-700 p-4 space-y-4';
      card.dataset.machineId = String(id);

      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold text-sm md:text-base">Máquina / entorno ${id}</h3>
            <p class="text-[11px] text-slate-400">
              Define tipo de máquina, ejes y enfoque; los módulos sugeridos se pueden ajustar con los checkboxes.
            </p>
          </div>
          <button type="button" data-remove-machine
            class="text-[11px] px-2 py-1 border border-slate-600 rounded hover:bg-slate-800">
            Quitar máquina
          </button>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="space-y-1">
              <label class="block text-xs font-medium text-slate-200">Tipo de máquina</label>
              <select class="js-tipoMaquina w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
                <option value="cm">Centro de maquinado</option>
                <option value="torno">Torno CNC</option>
                <option value="millturn">Mill-Turn / Y-axis</option>
                <option value="wire">Wire EDM</option>
              </select>
              <p class="js-ayudaEjes text-[11px] text-slate-400"></p>
            </div>

            <div class="space-y-1">
              <label class="block text-xs font-medium text-slate-200">Configuración de ejes</label>
              <select class="js-configEjes w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500"></select>
            </div>

            <div class="space-y-1">
              <label class="block text-xs font-medium text-slate-200">Cantidad de máquinas en este entorno</label>
              <input type="number" min="1" value="1"
                class="js-numMaquinas w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
            </div>
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium text-slate-200">Enfoque principal</label>
              <select class="js-enfoque w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
                <option value="2d">2.5D / prismatico</option>
                <option value="3d_moldes">Moldes 3D (cavidades, insertos)</option>
                <option value="produccion">Producción en serie (tiempo de ciclo)</option>
                <option value="multi_eje">5 ejes / indexado complejo</option>
                <option value="electrodos">Electrodos / IMOLD</option>
                <option value="wire">Wire EDM / cortadora hilo</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-200">Prioridad principal</label>
              <select class="js-prioridad w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
                <option value="equilibrado">Equilibrado (ciclo + acabado)</option>
                <option value="ciclo">Reducir tiempo de ciclo</option>
                <option value="acabado">Mejorar acabado superficial</option>
                <option value="plantillas">Estandarizar plantillas / operadores</option>
              </select>
            </div>

            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs font-medium text-slate-200">Módulos sugeridos</span>
                <button type="button" data-select-all
                  class="text-[11px] px-2 py-1 border border-slate-600 rounded-md hover:bg-slate-800">
                  Seleccionar todos
                </button>
              </div>
              <div class="js-listaModulos grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs"></div>
              <p class="text-[11px] text-slate-400">
                Activa o desactiva los módulos de este entorno. Por ejemplo: Milling + iMachining en el CM y Turning en el torno.
              </p>
            </div>
          </div>
        </div>
      `;

      const tipoSelect = card.querySelector('.js-tipoMaquina');
      const ejesSelect = card.querySelector('.js-configEjes');
      const ayudaEjes = card.querySelector('.js-ayudaEjes');
      const enfoqueSelect = card.querySelector('.js-enfoque');
      const prioridadSelect = card.querySelector('.js-prioridad');
      const numMaquinasInput = card.querySelector('.js-numMaquinas');
      const listaModulosDiv = card.querySelector('.js-listaModulos');
      const btnSelectAll = card.querySelector('[data-select-all]');
      const btnRemove = card.querySelector('[data-remove-machine]');

      function refillAxisOptionsForMachine() {
        const tipo = tipoSelect.value;
        const opts = axisOptionsByMachine[tipo] || [];
        ejesSelect.innerHTML = '';
        opts.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          ejesSelect.appendChild(opt);
        });

        let msg = '';
        if (tipo === 'cm') {
          msg = 'Para 3/4/5 ejes de fresado se propondrán Milling, iMachining, HSR/HSM/HSS, 4/5X y sonda según aplique.';
        } else if (tipo === 'torno') {
          msg = 'Solo Turning / Swiss / Multi-Turret. No se muestran módulos exclusivos de fresado.';
        } else if (tipo === 'millturn') {
          msg = 'Se combinan Turning + Milling + sincronización / turrets / sub-husillo según el escenario.';
        } else if (tipo === 'wire') {
          msg = 'Solo módulos Wirecut 2/4 ejes y sus posts.';
        }
        ayudaEjes.textContent = msg;
      }

      function sugerirModulosForMachine() {
        const tipo = tipoSelect.value;
        const ejes = ejesSelect.value;
        const enfoque = enfoqueSelect.value;
        const prioridad = prioridadSelect.value;

        const sugeridos = new Set();

        if (tipo === 'cm' || tipo === 'millturn') {
          sugeridos.add('millingBase');

          if (enfoque === '3d_moldes' || enfoque === 'produccion') {
            sugeridos.add('iMach3D');
          } else if (enfoque === '2d') {
            sugeridos.add('iMach2D');
          }

          if (enfoque === '3d_moldes' || enfoque === 'multi_eje') {
            sugeridos.add('hsm3D');
            if (prioridad === 'acabado' || prioridad === 'equilibrado') {
              sugeridos.add('hss');
            }
          }

          if (prioridad === 'ciclo') {
            sugeridos.add('iMach3D');
          }

          if (ejes === '4x_index' || ejes === '4x_sim') {
            sugeridos.add('sim4X');
          }
          if (ejes === '5x_std' || ejes === '5x_adv') {
            sugeridos.add('sim5Std');
          }

          if (enfoque === 'electrodos') {
            sugeridos.add('imoldDesigner');
            sugeridos.add('imoldElectrode');
          }

          if (enfoque === '3d_moldes' || enfoque === 'produccion') {
            sugeridos.add('probe1');
          }

          if (ejes === '4x_sim' || ejes === '5x_std' || ejes === '5x_adv' || tipo === 'millturn') {
            sugeridos.add('machineSim');
          }

        } else if (tipo === 'torno') {
          sugeridos.add('turningBase');
          if (ejes === 'subspindle') {
            sugeridos.add('multit');
          }
        } else if (tipo === 'wire') {
          if (ejes === 'wire2') sugeridos.add('wire2');
          if (ejes === 'wire4') sugeridos.add('wire24');
        }

        listaModulosDiv.innerHTML = '';
        const overrides = moduleOverrides[id] || {};

        Object.entries(moduleCatalog).forEach(([key, def]) => {
          if (tipo === 'torno') {
            const soloTorno = ['turningBase', 'swiss', 'multit'];
            if (!soloTorno.includes(key)) return;
          }
          if (tipo === 'wire') {
            const soloWire = ['wire2', 'wire24'];
            if (!soloWire.includes(key)) return;
          }
          if (tipo === 'cm' || tipo === 'millturn') {
            const soloMilling = [
              'millingBase', 'iMach2D', 'iMach3D', 'iMach3Dwo2D',
              'featureRec', 'hsm3D', 'hss', 'hsr', 'sim4X',
              'sim5Std', 'sim5Pro', 'sim5Prem', 'rotary', 'machineSim',
              'probe1', 'probe2', 'xpress', 'imoldDesigner', 'imoldElectrode'
            ];
            if (!soloMilling.includes(key)) return;
          }

          const wrapper = document.createElement('label');
          wrapper.className = 'flex items-start gap-2 bg-base-900/40 border border-slate-700 rounded-lg px-2 py-2 cursor-pointer hover:border-accent-500';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.dataset.key = key;
          input.className = 'mt-1 h-3 w-3 rounded border-slate-600 bg-base-900';

          const sugerido = sugeridos.has(key);
          const override = overrides[key];

          if (override === 'forceOn') input.checked = true;
          else if (override === 'forceOff') input.checked = false;
          else input.checked = sugerido;

          input.addEventListener('change', () => {
            if (!moduleOverrides[id]) moduleOverrides[id] = {};
            if (input.checked === sugerido) {
              delete moduleOverrides[id][key];
            } else {
              moduleOverrides[id][key] = input.checked ? 'forceOn' : 'forceOff';
            }
            calcular();
          });

          wrapper.appendChild(input);

          const infoDiv = document.createElement('div');
          infoDiv.className = 'flex-1';
          infoDiv.innerHTML = `
            <div class="font-medium text-[11px]">${def.name}</div>
            <div class="text-[10px] text-slate-400">${def.packageCode || 'Sin código sistema definido'}</div>
          `;
          wrapper.appendChild(infoDiv);

          const priceDiv = document.createElement('div');
          priceDiv.className = 'text-[11px] text-slate-200 whitespace-nowrap';
          priceDiv.textContent = formatUSD(def.price);
          wrapper.appendChild(priceDiv);

          listaModulosDiv.appendChild(wrapper);
        });
      }

      tipoSelect.addEventListener('change', () => {
        refillAxisOptionsForMachine();
        sugerirModulosForMachine();
        calcular();
      });
      ejesSelect.addEventListener('change', () => {
        sugerirModulosForMachine();
        calcular();
      });
      enfoqueSelect.addEventListener('change', () => {
        sugerirModulosForMachine();
        calcular();
      });
      prioridadSelect.addEventListener('change', () => {
        sugerirModulosForMachine();
        calcular();
      });
      numMaquinasInput.addEventListener('input', () => {
        calcular();
      });

      btnSelectAll.addEventListener('click', () => {
        const overrides = moduleOverrides[id] || (moduleOverrides[id] = {});
        listaModulosDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
          overrides[cb.dataset.key] = 'forceOn';
        });
        calcular();
      });

      btnRemove.addEventListener('click', () => {
        const idx = machines.findIndex(m => m.id === id);
        if (idx !== -1) machines.splice(idx, 1);
        card.remove();
        updateRemoveButtonsVisibility();
        calcular();
      });

      refillAxisOptionsForMachine();
      sugerirModulosForMachine();

      return card;
    }

    function addMachine() {
      const card = createMachineCard();
      machines.push({ id: parseInt(card.dataset.machineId, 10) });
      machinesContainer.appendChild(card);
      updateRemoveButtonsVisibility();
    }

    btnAgregarMaquina.addEventListener('click', () => {
      addMachine();
    });

    // --------------------- Posts ---------------------

    const postTipoSelect = document.getElementById('postTipo');
    const postControlInput = document.getElementById('postControl');
    const postCantidadInput = document.getElementById('postCantidad');
    const btnAgregarPost = document.getElementById('btnAgregarPost');

    function fillPostTipoOptions() {
      postTipoSelect.innerHTML = '';
      Object.entries(postPrices).forEach(([key, def]) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = `${def.name} (${def.code})`;
        postTipoSelect.appendChild(opt);
      });
    }

    btnAgregarPost.addEventListener('click', () => {
      const key = postTipoSelect.value;
      const control = (postControlInput.value || '').trim();
      const qty = parseInt(postCantidadInput.value || '1', 10);

      if (!key || !postPrices[key]) return;
      if (isNaN(qty) || qty <= 0) return;

      currentPosts.push({ key, control, qty });
      postControlInput.value = '';
      postCantidadInput.value = '1';
      calcular();
    });

    // --------------------- Agregados ---------------------

    const extraItemSelect = document.getElementById('extraItem');
    const extraQtyInput = document.getElementById('extraQty');
    const btnAgregarExtra = document.getElementById('btnAgregarExtra');

    function fillExtrasOptions() {
      extraItemSelect.innerHTML = '';
      Object.entries(extrasCatalog).forEach(([key, def]) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = `${def.name} (${def.code})`;
        extraItemSelect.appendChild(opt);
      });
    }

    btnAgregarExtra.addEventListener('click', () => {
      const key = extraItemSelect.value;
      const qty = parseInt(extraQtyInput.value || '1', 10);
      if (!key || !extrasCatalog[key]) return;
      if (isNaN(qty) || qty <= 0) return;

      extras.push({ key, qty });
      extraQtyInput.value = '1';
      calcular();
    });

    // --------------------- Comparativa ---------------------

    const escenarioBaseSelect = document.getElementById('escenarioBaseSelect');
    const escenariosCheckContainer = document.getElementById('escenariosCheckContainer');
    const tablaComparativoBody = document.getElementById('tablaComparativo');

    function refrescarUIComparativa(escenarios) {
      escenarioBaseSelect.innerHTML = '';
      const prevBase = escenarioBaseKey;
      let existePrevio = false;

      escenarios.forEach(esc => {
        const opt = document.createElement('option');
        opt.value = esc.key;
        opt.textContent = esc.label;
        if (esc.key === prevBase) existePrevio = true;
        escenarioBaseSelect.appendChild(opt);
      });

      if (existePrevio) {
        escenarioBaseSelect.value = prevBase;
        escenarioBaseKey = prevBase;
      } else if (escenarios.length) {
        escenarioBaseSelect.value = escenarios[0].key;
        escenarioBaseKey = escenarios[0].key;
      }

      [...escenariosSeleccionados].forEach(k => {
        if (!escenarios.some(e => e.key === k)) {
          escenariosSeleccionados.delete(k);
        }
      });

      if (escenariosSeleccionados.size === 0) {
        escenarios.forEach(esc => {
          if (esc.key !== escenarioBaseKey) escenariosSeleccionados.add(esc.key);
        });
      }

      escenariosCheckContainer.innerHTML = '';
      escenarios.forEach(esc => {
        const label = document.createElement('label');
        label.className = 'inline-flex items-center gap-1 bg-base-900/40 border border-slate-700 rounded px-2 py-1';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'h-3 w-3';
        cb.value = esc.key;
        cb.checked = escenariosSeleccionados.has(esc.key);

        cb.addEventListener('change', () => {
          if (cb.checked) escenariosSeleccionados.add(esc.key);
          else escenariosSeleccionados.delete(esc.key);
          recalcularTablaComparativo();
        });

        const span = document.createElement('span');
        span.className = 'text-[11px]';
        span.textContent = esc.label;

        label.appendChild(cb);
        label.appendChild(span);
        escenariosCheckContainer.appendChild(label);
      });
    }

    function recalcularTablaComparativo() {
      tablaComparativoBody.innerHTML = '';
      const base = escenariosActuales.find(e => e.key === escenarioBaseKey);
      if (!base || base.total === 0) return;

      escenariosActuales.forEach(esc => {
        if (esc.key === escenarioBaseKey) return;
        if (escenariosSeleccionados.size > 0 && !escenariosSeleccionados.has(esc.key)) return;

        const diff = esc.total - base.total;
        const pct = (diff / base.total) * 100;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${esc.label}</td>
          <td class="px-3 py-2 text-right">${formatUSD(esc.total)}</td>
          <td class="px-3 py-2 text-right">${formatUSDFlex(diff)}</td>
          <td class="px-3 py-2 text-right">${pct.toFixed(1)} %</td>
        `;
        tablaComparativoBody.appendChild(tr);
      });
    }

    escenarioBaseSelect.addEventListener('change', () => {
      escenarioBaseKey = escenarioBaseSelect.value;
      recalcularTablaComparativo();
    });

    // --------------------- Cálculo principal ---------------------

    const tablaModulosBody = document.getElementById('tablaModulos');
    const tablaPostsBody = document.getElementById('tablaPosts');
    const tablaCapsBody = document.getElementById('tablaCaps');
    const tablaGlobalBody = document.getElementById('tablaGlobal');
    const tablaExtrasBody = document.getElementById('tablaExtras');

    function calcular() {
      // 1) Módulos de todos los entornos
      const moduleAgg = {};

      machines.forEach(m => {
        const card = machinesContainer.querySelector(`[data-machine-id="${m.id}"]`);
        if (!card) return;
        const numMaquinasInput = card.querySelector('.js-numMaquinas');
        const listaModulosDiv = card.querySelector('.js-listaModulos');
        const numMaquinas = parseInt(numMaquinasInput.value || '1', 10) || 1;

        listaModulosDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
          const key = cb.dataset.key;
          const def = moduleCatalog[key];
          if (!def) return;
          if (!moduleAgg[key]) moduleAgg[key] = { def, qty: 0 };
          moduleAgg[key].qty += numMaquinas;
        });
      });

      let totLic = 0, totSubs1Y = 0, totSubs3Y = 0, totLicSubs1Y = 0, totLicSubs3Y = 0, totTrade2Y = 0, totTrade3Y = 0, totTerm = 0;

      tablaModulosBody.innerHTML = '';

      Object.values(moduleAgg).forEach(({ def, qty }) => {
        const lic = def.price * qty;
        const subs1 = calcSubs1Y(def.price) * qty;
        const subs3 = calcSubs3Y(def.price) * qty;
        const pkg = def.packageCode ? systemPackages[def.packageCode] : undefined;
        const licSubs1 = pkg ? pkg.licSubs1Y * qty : (lic + subs1);
        const licSubs3 = lic + subs3;
        const trade2 = calcTrade2Y(def.price) * qty;
        const trade3 = calcTrade3Y(def.price) * qty;
        const term = calcTerm(def.price) * qty;

        totLic += lic;
        totSubs1Y += subs1;
        totSubs3Y += subs3;
        totLicSubs1Y += licSubs1;
        totLicSubs3Y += licSubs3;
        totTrade2Y += trade2;
        totTrade3Y += trade3;
        totTerm += term;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${def.name}</td>
          <td class="px-3 py-2 text-right">${qty}</td>
          <td class="px-3 py-2 text-right">${formatUSD(lic)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(subs1)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(subs3)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(licSubs1)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(licSubs3)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(trade2)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(trade3)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(term)}</td>
          <td class="px-3 py-2 text-xs">${def.packageCode || '-'}</td>
        `;
        tablaModulosBody.appendChild(tr);
      });

      document.getElementById('totLicencia').textContent = formatUSD(totLic);
      document.getElementById('totSubs1Y').textContent = formatUSD(totSubs1Y);
      document.getElementById('totSubs3Y').textContent = formatUSD(totSubs3Y);
      document.getElementById('totLicSubs1Y').textContent = formatUSD(totLicSubs1Y);
      document.getElementById('totLicSubs3Y').textContent = formatUSD(totLicSubs3Y);
      document.getElementById('totTrade2Y').textContent = formatUSD(totTrade2Y);
      document.getElementById('totTrade3Y').textContent = formatUSD(totTrade3Y);
      document.getElementById('totTerm').textContent = formatUSD(totTerm);

      // 2) Posts
      tablaPostsBody.innerHTML = '';
      let totalPosts = 0;
      currentPosts.forEach((p, idx) => {
        const def = postPrices[p.key];
        if (!def) return;
        const rowTotal = def.price * p.qty;
        totalPosts += rowTotal;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${def.name}</td>
          <td class="px-3 py-2">${p.control || '-'}</td>
          <td class="px-3 py-2 text-right">${formatUSD(def.price)}</td>
          <td class="px-3 py-2 text-right">${p.qty}</td>
          <td class="px-3 py-2 text-right">${formatUSD(rowTotal)}</td>
          <td class="px-3 py-2 text-xs">${def.code}</td>
          <td class="px-3 py-2">
            <button type="button" data-index="${idx}" class="text-[11px] px-2 py-1 border border-slate-600 rounded hover:bg-slate-800">
              Quitar
            </button>
          </td>
        `;
        tablaPostsBody.appendChild(tr);
      });
      tablaPostsBody.querySelectorAll('button[data-index]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.dataset.index, 10);
          if (!isNaN(i)) {
            currentPosts.splice(i, 1);
            calcular();
          }
        });
      });
      document.getElementById('totPosts').textContent = formatUSD(totalPosts);

      // 3) Capacitaciones sugeridas
      tablaCapsBody.innerHTML = '';
      let totalCaps = 0;

      const selectedKeys = Object.keys(moduleAgg);
      const suggestedCaps = new Set();
      if (selectedKeys.includes('millingBase')) suggestedCaps.add('millingBase');
      if (selectedKeys.includes('hsr')) suggestedCaps.add('hsr');
      if (selectedKeys.includes('hss')) suggestedCaps.add('hss');
      if (selectedKeys.includes('hsm3D')) suggestedCaps.add('hsm3d');
      if (selectedKeys.includes('sim4X')) suggestedCaps.add('sim4');
      if (selectedKeys.includes('sim5Std') || selectedKeys.includes('sim5Pro')) suggestedCaps.add('sim5');
      if (selectedKeys.includes('probe1') || selectedKeys.includes('probe2')) suggestedCaps.add('probe');
      if (selectedKeys.includes('turningBase')) suggestedCaps.add('turning');
      if (selectedKeys.includes('imoldDesigner')) suggestedCaps.add('imold');
      suggestedCaps.add('generalWorkshop');

      function shouldIncludeCap(key) {
        const sugerido = suggestedCaps.has(key);
        const override = trainingOverrides[key];
        if (override === 'forceOn') return true;
        if (override === 'forceOff') return false;
        return sugerido;
      }

      Object.entries(trainingCatalog).forEach(([capKey, cap]) => {
        if (!shouldIncludeCap(capKey)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${cap.name}</td>
          <td class="px-3 py-2 text-right">${formatUSD(cap.price)}</td>
          <td class="px-3 py-2 text-xs">${cap.code}</td>
          <td class="px-3 py-2">
            <button type="button" data-cap="${capKey}" class="text-[11px] px-2 py-1 border border-slate-600 rounded hover:bg-slate-800">
              Quitar
            </button>
          </td>
        `;
        tablaCapsBody.appendChild(tr);
        totalCaps += cap.price;
      });
      tablaCapsBody.querySelectorAll('button[data-cap]').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.cap;
          trainingOverrides[key] = 'forceOff';
          calcular();
        });
      });
      document.getElementById('totCaps').textContent = formatUSD(totalCaps);

      // 4) Agregados manuales
      tablaExtrasBody.innerHTML = '';
      let totalExtras = 0;
      extras.forEach((ex, idx) => {
        const def = extrasCatalog[ex.key];
        if (!def) return;
        const rowTotal = def.price * ex.qty;
        totalExtras += rowTotal;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${def.name}</td>
          <td class="px-3 py-2 text-xs">${def.code}</td>
          <td class="px-3 py-2 text-right">${formatUSD(def.price)}</td>
          <td class="px-3 py-2 text-right">${ex.qty}</td>
          <td class="px-3 py-2 text-right">${formatUSD(rowTotal)}</td>
          <td class="px-3 py-2">
            <button type="button" data-extra-index="${idx}" class="text-[11px] px-2 py-1 border border-slate-600 rounded hover:bg-slate-800">
              Quitar
            </button>
          </td>
        `;
        tablaExtrasBody.appendChild(tr);
      });
      tablaExtrasBody.querySelectorAll('button[data-extra-index]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.dataset.extraIndex, 10);
          if (!isNaN(i)) {
            extras.splice(i, 1);
            calcular();
          }
        });
      });
      document.getElementById('totExtras').textContent = formatUSD(totalExtras);

      // 5) Resumen global y escenarios
      tablaGlobalBody.innerHTML = '';
      tablaComparativoBody.innerHTML = '';

      const baseLic1Y = totLicSubs1Y + totalPosts + totalCaps + totalExtras;
      const baseLic = totLic + totalPosts + totalCaps + totalExtras;

      const escenarios = [];
      function addScenario(key, label, montoUSD) {
        escenarios.push({ key, label, total: montoUSD });
        const totalIVA = montoUSD * 1.16;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${label}</td>
          <td class="px-3 py-2 text-right">${formatUSD(montoUSD)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(totalIVA)}</td>
        `;
        tablaGlobalBody.appendChild(tr);
      }

      addScenario('lic1', 'Licencia + 1 año de servicio', baseLic1Y);
      addScenario('lic3', 'Licencia + 3 años de servicio', baseLic + totSubs3Y);
      addScenario('trade2', 'Trade-in 2 años (Lic + Subs1Y con desc.)', totTrade2Y + totalPosts + totalCaps + totalExtras);
      addScenario('trade3', 'Trade-in 3 años (Lic + Subs3Y con desc.)', totTrade3Y + totalPosts + totalCaps + totalExtras);
      addScenario('term1', 'Term 1 año (solo licencia sin servicio)', totTerm + totalPosts + totalCaps + totalExtras);

      escenariosActuales = escenarios;
      refrescarUIComparativa(escenarios);
      recalcularTablaComparativo();
    }

    document.getElementById('btnCalcular').addEventListener('click', calcular);

    // --------------------- Exportar ---------------------

    document.getElementById('btnExportar').addEventListener('click', () => {
      calcular();

      const descripcion = (document.getElementById('descripcionProceso').value || '(sin descripción)').replace(/\n/g, '<br>');

      const entornoRows = [];
      machines.forEach(m => {
        const card = machinesContainer.querySelector(`[data-machine-id="${m.id}"]`);
        if (!card) return;
        const tipoSelect = card.querySelector('.js-tipoMaquina');
        const ejesSelect = card.querySelector('.js-configEjes');
        const enfoqueSelect = card.querySelector('.js-enfoque');
        const prioridadSelect = card.querySelector('.js-prioridad');
        const numMaquinasInput = card.querySelector('.js-numMaquinas');

        entornoRows.push({
          idx: m.id,
          tipo: tipoSelect.options[tipoSelect.selectedIndex]?.textContent || '',
          ejes: ejesSelect.options[ejesSelect.selectedIndex]?.textContent || '',
          enfoque: enfoqueSelect.options[enfoqueSelect.selectedIndex]?.textContent || '',
          prioridad: prioridadSelect.options[prioridadSelect.selectedIndex]?.textContent || '',
          qty: numMaquinasInput.value || '1'
        });
      });

      const modLines = [];
      tablaModulosBody.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 11) return;
        modLines.push({
          name: tds[0].textContent.trim(),
          qty: tds[1].textContent.trim(),
          lic: tds[2].textContent.trim(),
          licSubs1Y: tds[5].textContent.trim(),
          code: tds[10].textContent.trim()
        });
      });

      const postLines = [];
      tablaPostsBody.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 6) return;
        postLines.push({
          name: tds[0].textContent.trim(),
          control: tds[1].textContent.trim(),
          unit: tds[2].textContent.trim(),
          qty: tds[3].textContent.trim(),
          total: tds[4].textContent.trim(),
          code: tds[5].textContent.trim()
        });
      });

      const extraLines = [];
      tablaExtrasBody.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 5) return;
        extraLines.push({
          name: tds[0].textContent.trim(),
          code: tds[1].textContent.trim(),
          unit: tds[2].textContent.trim(),
          qty: tds[3].textContent.trim(),
          total: tds[4].textContent.trim()
        });
      });

      const escenariosExport = [];
      tablaGlobalBody.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 3) return;
        escenariosExport.push({
          label: tds[0].textContent.trim(),
          total: tds[1].textContent.trim(),
          totalIVA: tds[2].textContent.trim()
        });
      });

      let html = `
<h2 style="font-family: system-ui, -apple-system, sans-serif; color:#0f172a;">Resumen propuesta SolidCAM</h2>
<p style="font-size:13px;"><strong>Descripción general del proceso:</strong><br>${descripcion}</p>
<hr style="margin:16px 0;">
<h3 style="font-family: system-ui, -apple-system, sans-serif; color:#0f172a;">Entornos configurados</h3>
<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font-family: system-ui, -apple-system, sans-serif; font-size:13px;">
  <thead style="background:#e5e7eb;">
    <tr>
      <th align="left">#</th>
      <th align="left">Tipo de máquina</th>
      <th align="left">Ejes</th>
      <th align="left">Enfoque</th>
      <th align="left">Prioridad</th>
      <th align="right">Cantidad de máquinas</th>
    </tr>
  </thead>
  <tbody>
`;

      entornoRows.forEach(r => {
        html += `
    <tr>
      <td>${r.idx}</td>
      <td>${r.tipo}</td>
      <td>${r.ejes}</td>
      <td>${r.enfoque}</td>
      <td>${r.prioridad}</td>
      <td align="right">${r.qty}</td>
    </tr>`;
      });

      html += `
  </tbody>
</table>
<hr style="margin:16px 0;">
<h3 style="font-family: system-ui, -apple-system, sans-serif; color:#0f172a;">Módulos de licencia</h3>
<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font-family: system-ui, -apple-system, sans-serif; font-size:13px;">
  <thead style="background:#e5e7eb;">
    <tr>
      <th align="left">Módulo</th>
      <th align="right">Cantidad (máquinas)</th>
      <th align="left">Código sistema</th>
      <th align="right">Licencia (USD)</th>
      <th align="right">Lic+Subs 1Y (USD)</th>
    </tr>
  </thead>
  <tbody>
`;

      modLines.forEach(m => {
        html += `
    <tr>
      <td>${m.name}</td>
      <td align="right">${m.qty}</td>
      <td>${m.code}</td>
      <td align="right">${m.lic}</td>
      <td align="right">${m.licSubs1Y}</td>
    </tr>`;
      });

      html += `
  </tbody>
</table>
<hr style="margin:16px 0;">
<h3 style="font-family: system-ui, -apple-system, sans-serif; color:#0f172a;">Postprocesadores especiales</h3>
<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font-family: system-ui, -apple-system, sans-serif; font-size:13px;">
  <thead style="background:#e5e7eb;">
    <tr>
      <th align="left">Postprocesador</th>
      <th align="left">Control / máquina</th>
      <th align="left">Código</th>
      <th align="right">Cantidad</th>
      <th align="right">Precio unitario</th>
      <th align="right">Total</th>
    </tr>
  </thead>
  <tbody>
`;

      postLines.forEach(p => {
        html += `
    <tr>
      <td>${p.name}</td>
      <td>${p.control}</td>
      <td>${p.code}</td>
      <td align="right">${p.qty}</td>
      <td align="right">${p.unit}</td>
      <td align="right">${p.total}</td>
    </tr>`;
      });

      html += `
  </tbody>
</table>
`;

      if (extraLines.length > 0) {
        html += `
<hr style="margin:16px 0;">
<h3 style="font-family: system-ui, -apple-system, sans-serif; color:#0f172a;">Agregados / servicios adicionales</h3>
<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font-family: system-ui, -apple-system, sans-serif; font-size:13px;">
  <thead style="background:#e5e7eb;">
    <tr>
      <th align="left">Concepto</th>
      <th align="left">Código</th>
      <th align="right">Cantidad</th>
      <th align="right">Precio unitario</th>
      <th align="right">Total</th>
    </tr>
  </thead>
  <tbody>
`;
        extraLines.forEach(e => {
          html += `
    <tr>
      <td>${e.name}</td>
      <td>${e.code}</td>
      <td align="right">${e.qty}</td>
      <td align="right">${e.unit}</td>
      <td align="right">${e.total}</td>
    </tr>`;
        });
        html += `
  </tbody>
</table>
`;
      }

      html += `
<hr style="margin:16px 0;">
<h3 style="font-family: system-ui, -apple-system, sans-serif; color:#0f172a;">Escenarios económicos</h3>
<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font-family: system-ui, -apple-system, sans-serif; font-size:13px;">
  <thead style="background:#e5e7eb;">
    <tr>
      <th align="left">Escenario</th>
      <th align="right">Total USD</th>
      <th align="right">Total + IVA</th>
    </tr>
  </thead>
  <tbody>
`;

      escenariosExport.forEach(e => {
        html += `
    <tr>
      <td>${e.label}</td>
      <td align="right">${e.total}</td>
      <td align="right">${e.totalIVA}</td>
    </tr>`;
      });

      html += `
  </tbody>
</table>
<p style="font-size:11px; color:#6b7280; margin-top:8px;">
  Montos en USD, IVA calculado al 16% como referencia. Sujeto a validación final de lista de precios y condiciones comerciales.
</p>
`;

      const w = window.open('', '_blank');
      if (w) {
        w.document.write(`
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Resumen propuesta SolidCAM</title>
</head>
<body style="background:#f9fafb; padding:16px;">
${html}
  <script src="/assets/js/cnc-express-popup.js" defer></script>
</body>
</html>`);
        w.document.close();
      } else {
        alert('No se pudo abrir la ventana de exportación. Verifica que el navegador permita pop-ups.');
      }
    });

    // --------------------- Limpiar ---------------------

    document.getElementById('btnLimpiar').addEventListener('click', () => {
      document.getElementById('descripcionProceso').value = '';
      currentPosts = [];
      extras = [];
      machines = [];
      nextMachineId = 1;
      for (const k in moduleOverrides) delete moduleOverrides[k];
      for (const k in trainingOverrides) delete trainingOverrides[k];
      escenariosActuales = [];
      escenarioBaseKey = 'lic1';
      escenariosSeleccionados = new Set();

      machinesContainer.innerHTML = '';
      tablaModulosBody.innerHTML = '';
      tablaPostsBody.innerHTML = '';
      tablaCapsBody.innerHTML = '';
      tablaExtrasBody.innerHTML = '';
      tablaGlobalBody.innerHTML = '';
      tablaComparativoBody.innerHTML = '';
      document.getElementById('totLicencia').textContent = '$ 0.00';
      document.getElementById('totSubs1Y').textContent = '$ 0.00';
      document.getElementById('totSubs3Y').textContent = '$ 0.00';
      document.getElementById('totLicSubs1Y').textContent = '$ 0.00';
      document.getElementById('totLicSubs3Y').textContent = '$ 0.00';
      document.getElementById('totTrade2Y').textContent = '$ 0.00';
      document.getElementById('totTrade3Y').textContent = '$ 0.00';
      document.getElementById('totTerm').textContent = '$ 0.00';
      document.getElementById('totPosts').textContent = '$ 0.00';
      document.getElementById('totCaps').textContent = '$ 0.00';
      document.getElementById('totExtras').textContent = '$ 0.00';
      escenarioBaseSelect.innerHTML = '';
      escenariosCheckContainer.innerHTML = '';

      addMachine();
      calcular();
    });

    // --------------------- Init ---------------------

    fillPostTipoOptions();
    buildExtrasCatalog();
    fillExtrasOptions();
    addMachine();
    calcular();
  </script>
</body>
</html>
