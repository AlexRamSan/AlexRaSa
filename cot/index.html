<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Configurador de licencias SolidCAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: {
              900: '#020617',
              800: '#0f172a',
              700: '#1f2937'
            },
            accent: {
              500: '#e11d48'
            }
          }
        }
      }
    };
  </script>
</head>
<body class="bg-base-900 text-slate-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Configurador de licencias SolidCAM</h1>
        <p class="text-slate-400 text-sm md:text-base mt-1">
          Define el tipo de máquina, proceso y nivel de complejidad. El sistema propondrá módulos (Milling / Turning, iMachining, HSR/HSM/HSS, 4/5 ejes, sonda, etc.), 
          podrás quitar o agregar lo que quieras y recalcular los precios de Licencia + Servicio.
        </p>
      </div>
    </header>

    <!-- Panel principal -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- Lado izquierdo: descripción de máquinas / proceso -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4 space-y-4">
        <h2 class="font-semibold text-lg mb-1">1. Entorno del cliente</h2>

        <!-- Tipo de máquina -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-slate-200">Tipo de máquina principal</label>
          <select id="tipoMaquina" class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
            <option value="cm">Centro de maquinado</option>
            <option value="torno">Torno CNC</option>
            <option value="millturn">Mill-Turn / Y-axis</option>
            <option value="wire">Wire EDM</option>
          </select>
          <p class="text-xs text-slate-400">
            Esto controlará qué módulos se consideran base (Milling vs Turning) y qué opciones de ejes/postprocesadores son válidas.
          </p>
        </div>

        <!-- Configuración de ejes (dinámica según tipo) -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-slate-200">Configuración de ejes</label>
          <select id="configEjes" class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
            <!-- Se llena por JS según tipo de máquina -->
          </select>
          <p class="text-xs text-slate-400" id="ayudaConfigEjes"></p>
        </div>

        <!-- Producción / piezas -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-slate-200">Cantidad de máquinas</label>
            <input id="numMaquinas" type="number" min="1" value="1"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-200">Tipos de control / posts</label>
            <input id="numPosts" type="number" min="0" value="1"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
            <p class="text-xs text-slate-500 mt-1">
              Los post de 3 ejes Milling generales se consideran sin costo; aquí se cuentan posts especiales (4/5 ejes, Mill-Turn, Turning dedicado, Wire).
            </p>
          </div>
        </div>

        <!-- Descripción libre del proceso -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-slate-200">Describe qué hace el cliente</label>
          <textarea id="descripcionProceso" rows="5"
            placeholder="Ejemplo: 2 Haas 3 ejes y una prensa de moldes Haitían (Mitsubishi). Moldes de aluminio y acero, series cortas-medias. Buscan reducir ciclo y mejorar acabado."
            class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500"></textarea>
          <p class="text-xs text-slate-400">
            Esta descripción no afecta el cálculo todavía, pero te sirve como bloque para el resumen / exportación y como guía para ajustar los módulos sugeridos.
          </p>
        </div>
      </div>

      <!-- Lado derecho: enfoque de maquinado y módulos sugeridos -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4 space-y-4">
        <h2 class="font-semibold text-lg mb-1">2. Enfoque de maquinado y módulos sugeridos</h2>

        <div class="space-y-3">
          <!-- Enfoque principal -->
          <div>
            <label class="block text-sm font-medium text-slate-200">Enfoque principal</label>
            <select id="enfoquePrincipal"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
              <option value="2d">2.5D / prismatico</option>
              <option value="3d_moldes">Moldes 3D (cavidades, insertos)</option>
              <option value="produccion">Producción en serie (tiempo de ciclo)</option>
              <option value="multi_eje">5 ejes / indexado complejo</option>
              <option value="electrodos">Electrodos / IMOLD</option>
              <option value="wire">Wire EDM / cortadora hilo</option>
            </select>
          </div>

          <!-- Nivel de automatización deseado -->
          <div>
            <label class="block text-sm font-medium text-slate-200">Prioridad principal</label>
            <select id="prioridad"
              class="w-full bg-base-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-500">
              <option value="equilibrado">Equilibrado (ciclo + acabado)</option>
              <option value="ciclo">Reducir tiempo de ciclo</option>
              <option value="acabado">Mejorar acabado superficial</option>
              <option value="plantillas">Estandarizar plantillas / operadores</option>
            </select>
          </div>

          <!-- Checkboxes de módulos sugeridos (se llenan por JS) -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-slate-200">Módulos sugeridos</span>
              <button id="btnSeleccionarTodos" type="button"
                class="text-xs px-2 py-1 border border-slate-600 rounded-md hover:bg-slate-800">
                Seleccionar todos
              </button>
            </div>
            <div id="listaModulos" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
              <!-- Relleno dinámico -->
            </div>
            <p class="text-[11px] text-slate-400">
              Puedes activar o desactivar cualquier módulo antes de calcular. Por ejemplo: dejar iMachining 3D + HSM pero quitar HSS, o agregar sonda / operadores.
            </p>
          </div>
        </div>

        <div class="flex flex-wrap gap-3 pt-2">
          <button id="btnCalcular" type="button"
            class="inline-flex items-center gap-2 bg-accent-500 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow hover:brightness-110 transition">
            Calcular recomendación
          </button>
          <button id="btnExportar" type="button"
            class="inline-flex items-center gap-2 border border-slate-600 text-sm px-3 py-2 rounded-lg hover:bg-slate-800">
            Exportar resumen
          </button>
          <button id="btnLimpiar" type="button"
            class="inline-flex items-center gap-2 border border-slate-600 text-sm px-3 py-2 rounded-lg hover:bg-slate-800">
            Borrar y empezar de nuevo
          </button>
        </div>
      </div>
    </section>

    <!-- Resultados -->
    <section id="resultados" class="space-y-4">
      <!-- Módulos seleccionados -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Módulos recomendados (ajustables)</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Módulo</th>
                <th class="px-3 py-2 text-right font-semibold">Licencia</th>
                <th class="px-3 py-2 text-right font-semibold">Subs 1Y</th>
                <th class="px-3 py-2 text-right font-semibold">Subs 3Y</th>
                <th class="px-3 py-2 text-right font-semibold">Lic+Subs 1Y</th>
                <th class="px-3 py-2 text-right font-semibold">Lic+Subs 3Y</th>
                <th class="px-3 py-2 text-right font-semibold">Trade-in 2Y</th>
                <th class="px-3 py-2 text-right font-semibold">Trade-in 3Y</th>
                <th class="px-3 py-2 text-right font-semibold">Term (1Y)</th>
                <th class="px-3 py-2 text-left font-semibold">Código sistema (1Y)</th>
              </tr>
            </thead>
            <tbody id="tablaModulos" class="divide-y divide-slate-700">
              <!-- Renglones dinámicos -->
            </tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 font-semibold text-right">Totales módulos</td>
                <td class="px-3 py-2 text-right" id="totLicencia">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totSubs1Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totSubs3Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totLicSubs1Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totLicSubs3Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totTrade2Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totTrade3Y">$ 0.00</td>
                <td class="px-3 py-2 text-right" id="totTerm">$ 0.00</td>
                <td class="px-3 py-2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Posts -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Postprocesadores especiales</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Postprocesador</th>
                <th class="px-3 py-2 text-right font-semibold">Precio unitario</th>
                <th class="px-3 py-2 text-right font-semibold">Cantidad</th>
                <th class="px-3 py-2 text-right font-semibold">Total</th>
                <th class="px-3 py-2 text-left font-semibold">Código</th>
              </tr>
            </thead>
            <tbody id="tablaPosts" class="divide-y divide-slate-700"></tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 text-right font-semibold">Total posts</td>
                <td></td><td></td>
                <td class="px-3 py-2 text-right" id="totPosts">$ 0.00</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <p class="text-[11px] text-slate-400 mt-2">
          Nota: El post de Milling 3 ejes general se considera sin costo. Aquí solo se contabilizan 4/5 ejes, Mill-Turn, Turning dedicado, Wire, etc.
        </p>
      </div>

      <!-- Capacitaciones -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Capacitaciones sugeridas</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Curso</th>
                <th class="px-3 py-2 text-right font-semibold">Precio</th>
                <th class="px-3 py-2 text-left font-semibold">Código</th>
              </tr>
            </thead>
            <tbody id="tablaCaps" class="divide-y divide-slate-700"></tbody>
            <tfoot class="bg-base-900/60">
              <tr>
                <td class="px-3 py-2 text-right font-semibold">Total capacitación</td>
                <td class="px-3 py-2 text-right" id="totCaps">$ 0.00</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Resumen global -->
      <div class="bg-base-800 rounded-xl border border-slate-700 p-4">
        <h3 class="font-semibold mb-2 text-sm md:text-base">Resumen económico global (módulos + posts + capacitación)</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="bg-base-900/70">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Escenario</th>
                <th class="px-3 py-2 text-right font-semibold">Total USD</th>
                <th class="px-3 py-2 text-right font-semibold">Total + IVA (16%)</th>
              </tr>
            </thead>
            <tbody id="tablaGlobal" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --------------------- Datos base ---------------------

    // Precios de lista (licencia) de la tabla grande inicial
    const priceTable = {
      millingBase: 3900,
      iMach2D: 4290,
      iMach3D: 7590,
      iMach3Dwo2D: 3300,
      featureRec: 1100,
      hsm3D: 6050,
      hss: 1100,
      hsr: 1650,
      hsrToHsm: 4400,
      sim4X: 1100,
      sim5Std: 4400,
      sim5Pro: 7700,
      sim5Prem: 9900,
      rotary: 1100,
      turningAddOn: 2000,

      turningBase: 2500,
      swiss: 6490,
      multit: 3190,
      machineSim: 1650,

      probe1: 2090,
      probe2: 4290,

      xpress: 1870,
      xpressToMilling: 2030,

      // Integraciones / IMOLD etc. (usamos solo algunos como ejemplo)
      gcodeSimPkg: 1298,
      imoldDesignerPkg: 9200,
      imoldElectrodePkg: 3350
    };

    // Lógica de suscripciones y variantes
    const SUB_1Y_FACTOR = 0.18; // ya está en la tabla, pero lo usamos como aproximado
    const SUB_3Y_FACTOR = 0.432; // 3Y con 20% descuento: 0.18 * 3 * 0.8 ≈ 0.432

    const TRADE_2Y_DISCOUNT = 0.1864; // (Lic + Subs1Y) * (1 - 0.1864)
    const TRADE_3Y_DISCOUNT = 0.2039;
    const TERM_DISCOUNT = 0.587; // Lic * (1 - 0.587)

    // Productos de sistema (packages) con código y precio final 1Y ya dado por ti
    const systemPackages = {
      SSA1008: { name: 'Package SolidCAM Milling (2.5D milling module)', licSubs1Y: 4602 },
      SSA1000: { name: 'Package SolidCAM Milling (2.5D milling module) + Feature recognition', licSubs1Y: 5635 },
      SSA1004: { name: 'Package + HSM Rough milling module - HSR', licSubs1Y: 1947 },
      SSA1001: { name: 'Package + iMachining 3D (iMachining 2D is already included)', licSubs1Y: 8956.2 },
      SSA1002: { name: 'Package + 3D HSM module (HSM Rough milling module - HSR is already included)', licSubs1Y: 7139 },
      SSA1035: { name: 'Package + Swiss Type', licSubs1Y: 7659 },
      SSA1018: { name: 'Package + Multi-Turret Synchronization', licSubs1Y: 3765 },
      SSA1039: { name: 'Package Integration (G-Code simulation)', licSubs1Y: 1298 },
      SSA1019: { name: 'Package SolidCAM Electrode Designer (IMOLD)', licSubs1Y: 3350 },
      SSA1020: { name: 'Package IMOLD Mold Designer', licSubs1Y: 9200 },
      SSA1036: { name: 'Package Solid Probe Level 1 - Home Position', licSubs1Y: 2467 },
      SSA1016: { name: 'Package Solid Probe Level 2 - Home Position & Measurement', licSubs1Y: 5063 },
      SSA1037: { name: 'Package SolidCAM Xpress Milling', licSubs1Y: 2207 },
      SSA1038: { name: 'Package Upgrade to SolidCAM 2.5D milling', licSubs1Y: 2396 },
      SSA1012: { name: 'Package SolidCAM Turning', licSubs1Y: 2950 },
      SSA9013: { name: 'Package SolidCAM Wirecut 2 axis - 1 year', licSubs1Y: 2814 },
      SSA9014: { name: 'Package SolidCAM Wirecut 2 axis + 4 axis - 1 year', licSubs1Y: 5145 },
    };

    // Posts
    const postPrices = {
      milling4: { name: 'Post-Procesador Milling 4 Axis | G/M Code | General', code: 'SSM0101', price: 500 },
      milling5: { name: 'Post-Procesador Milling 5 Axis | G/M Code | General', code: 'SSM0102', price: 1250 },
      millturn4: { name: 'Post-Procesador MillTurn 4 Axis | G/M Code | General', code: 'SSM0100', price: 700 },
      millturn5: { name: 'Postprecessor MillTurn 5 axis - GM Code - General', code: 'SSM0098', price: 1500 },
      turning: { name: 'Postprocessor Turning', code: 'SSM0088', price: 2500 },
      wire2: { name: 'PostProcessor Wirecut 2 axis', code: 'SSM0134', price: 425 },
      wire4: { name: 'PostProcessor Wirecut 4 axis', code: 'SSM0135', price: 575 },
      post4pkg: { name: 'Package Postprocessor 4 axis', code: 'SSA1022', price: 2598 } // por si quieres usar package
    };

    // Capacitaciones (solo algunas claves relevantes)
    const trainingCatalog = {
      millingBase: { name: 'Capacitación SolidCAM Milling (2.5D milling module)', code: 'SSC0034', price: 450 },
      hsr: { name: 'Capacitación HSM Rough milling module - HSR', code: 'SSC0038', price: 200 },
      hss: { name: 'Capacitación HSS module (Simultaneous 3 axis)', code: 'SSC0037', price: 200 },
      hsm3d: { name: 'Capacitación 3D HSM module + HSR Milling', code: 'SSC0036', price: 250 },
      sim4: { name: 'Capacitación + Simultaneous 4 axis', code: 'SSC0041', price: 100 },
      sim5: { name: 'Capacitación + Simultaneous 5 axis', code: 'SSC0042', price: 450 },
      probe: { name: 'Capacitación SOLID Probe', code: 'SSC0062', price: 450 },
      turning: { name: 'Capacitación Turning', code: 'SSC0040', price: 350 },
      imold: { name: 'Capacitación IMOLD Mold Designer', code: 'SSC0061', price: 750 },
      generalWorkshop: { name: 'Taller de Capacitación SOLIDCAM', code: 'SSC0066', price: 320 }
    };

    // Implementación genérica
    const implementationItem = {
      name: 'Implementación CAM en sitio 8 hrs',
      code: 'SSM0087',
      price: 1000
    };

    // Ejes por tipo de máquina
    const axisOptionsByMachine = {
      cm: [
        { value: '3x', label: '3 ejes' },
        { value: '3x_moldes', label: '3 ejes (moldes 3D)' },
        { value: '4x_index', label: '4 ejes indexado' },
        { value: '4x_sim', label: '4 ejes simultáneo' },
        { value: '5x_std', label: '5 ejes estándar' },
        { value: '5x_adv', label: '5 ejes avanzado' }
      ],
      torno: [
        { value: '2x', label: '2 ejes' },
        { value: '2x_y', label: '2 ejes + Y / C' },
        { value: 'subspindle', label: 'Torno con sub-husillo / Mill-Turn básico' }
      ],
      millturn: [
        { value: 'mt_2t', label: 'Mill-Turn 2 torretas' },
        { value: 'mt_yc', label: 'Mill-Turn Y+C' },
        { value: 'mt_complex', label: 'Mill-Turn avanzado' }
      ],
      wire: [
        { value: 'wire2', label: 'Wire EDM 2 ejes' },
        { value: 'wire4', label: 'Wire EDM 4 ejes' }
      ]
    };

    // Mapeo: selección → módulos sugeridos (ids internos)
    const moduleCatalog = {
      // Milling base + opciones
      millingBase: { name: 'SolidCAM Milling (2.5D milling module)', price: priceTable.millingBase, packageCode: 'SSA1008' },
      iMach2D: { name: 'iMachining 2D', price: priceTable.iMach2D, packageCode: 'SSA1017' },
      iMach3D: { name: 'iMachining 3D (incluye 2D)', price: priceTable.iMach3D, packageCode: 'SSA1001' },
      iMach3Dwo2D: { name: 'iMachining 3D sin 2D', price: priceTable.iMach3Dwo2D, packageCode: 'SSA1028' },
      featureRec: { name: 'Feature recognition', price: priceTable.featureRec, packageCode: 'SSM0004' },
      hsm3D: { name: '3D HSM module', price: priceTable.hsm3D, packageCode: 'SSA1002' },
      hss: { name: 'HSS module (Simultaneous 3 axis)', price: priceTable.hss, packageCode: 'SSA1006' },
      hsr: { name: 'HSM Rough milling module - HSR', price: priceTable.hsr, packageCode: 'SSA1004' },
      sim4X: { name: 'Simultaneous 4 axis', price: priceTable.sim4X, packageCode: 'SSA1031' },
      sim5Std: { name: 'Simultaneous 5 axis Standard', price: priceTable.sim5Std, packageCode: 'SSA1043' },
      sim5Pro: { name: 'Simultaneous 5 axis Professional', price: priceTable.sim5Pro, packageCode: 'SSA1044' },
      sim5Prem: { name: 'Simultaneous 5 axis Premium', price: priceTable.sim5Prem, packageCode: '' },
      rotary: { name: 'Rotary Machining (Screw)', price: priceTable.rotary, packageCode: 'SSA1032' },
      machineSim: { name: 'Machine simulation / G-Code simulation', price: priceTable.machineSim, packageCode: 'SSA1039' },
      probe1: { name: 'Solid Probe Level 1 - Home Position', price: priceTable.probe1, packageCode: 'SSA1036' },
      probe2: { name: 'Solid Probe Level 2 - Home Position & Measurement', price: priceTable.probe2, packageCode: 'SSA1016' },
      xpress: { name: 'SolidCAM Xpress Milling', price: priceTable.xpress, packageCode: 'SSA1037' },

      // Turning / Mill-Turn
      turningBase: { name: 'SolidCAM Turning', price: priceTable.turningBase, packageCode: 'SSA1012' },
      swiss: { name: 'Swiss Type', price: priceTable.swiss, packageCode: 'SSA1035' },
      multit: { name: 'Multi-Turret Synchronization', price: priceTable.multit, packageCode: 'SSA1018' },

      // IMOLD / electrodos
      imoldDesigner: { name: 'IMOLD Mold Designer', price: priceTable.imoldDesignerPkg, packageCode: 'SSA1020' },
      imoldElectrode: { name: 'SolidCAM Electrode Designer (IMOLD)', price: priceTable.imoldElectrodePkg, packageCode: 'SSA1019' },

      // Wire
      wire2: { name: 'Wirecut 2 axis SolidCAM', price: 2385, packageCode: 'SSM0130' },
      wire24: { name: 'Wirecut 2 axis + 4 axis SolidCAM', price: 4360, packageCode: 'SSM0132' },
    };

    // --------------------- Utilidades ---------------------
    function formatUSD(value) {
      return '$ ' + value.toFixed(2);
    }

    function calcSubs1Y(licPrice) {
      return licPrice * SUB_1Y_FACTOR;
    }
    function calcSubs3Y(licPrice) {
      return licPrice * SUB_3Y_FACTOR;
    }
    function calcTrade2Y(licPrice) {
      const licSubs1Y = licPrice + calcSubs1Y(licPrice);
      return licSubs1Y * (1 - TRADE_2Y_DISCOUNT);
    }
    function calcTrade3Y(licPrice) {
      const licSubs3Y = licPrice + calcSubs3Y(licPrice);
      return licSubs3Y * (1 - TRADE_3Y_DISCOUNT);
    }
    function calcTerm(licPrice) {
      return licPrice * (1 - TERM_DISCOUNT);
    }

    // --------------------- UI dinámica ---------------------

    const tipoMaquinaSelect = document.getElementById('tipoMaquina');
    const configEjesSelect = document.getElementById('configEjes');
    const ayudaConfigEjes = document.getElementById('ayudaConfigEjes');

    function refillAxisOptions() {
      const tipo = tipoMaquinaSelect.value;
      const opts = axisOptionsByMachine[tipo] || [];
      configEjesSelect.innerHTML = '';
      for (const o of opts) {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        configEjesSelect.appendChild(opt);
      }
      // Mensaje de ayuda por tipo
      let msg = '';
      if (tipo === 'cm') {
        msg = 'Para 3/4/5 ejes de fresado se propondrán módulos Milling, iMachining, HSR/HSM/HSS, 4/5X y sonda según aplique.';
      } else if (tipo === 'torno') {
        msg = 'Para torno solo se considerarán Turning, Swiss / Multi-Turret, posts de Turning y eventualmente Mill-Turn básico.';
      } else if (tipo === 'millturn') {
        msg = 'En Mill-Turn se combinan Turning + Milling + sincronización / turrets / sub-husillo según el escenario.';
      } else if (tipo === 'wire') {
        msg = 'Para Wire EDM se usarán únicamente módulos de Wirecut 2/4 ejes y sus posts correspondientes.';
      }
      ayudaConfigEjes.textContent = msg;
    }

    tipoMaquinaSelect.addEventListener('change', refillAxisOptions);

    // Módulos sugeridos (checkboxes) según enfoque / tipo
    const listaModulosDiv = document.getElementById('listaModulos');

    function sugerirModulos() {
      const tipo = tipoMaquinaSelect.value;
      const ejes = configEjesSelect.value;
      const enfoque = document.getElementById('enfoquePrincipal').value;
      const prioridad = document.getElementById('prioridad').value;

      const sugeridos = new Set();

      if (tipo === 'cm' || tipo === 'millturn') {
        sugeridos.add('millingBase');

        if (enfoque === '3d_moldes' || enfoque === 'produccion') {
          sugeridos.add('iMach3D');
        } else if (enfoque === '2d') {
          sugeridos.add('iMach2D');
        }

        if (enfoque === '3d_moldes' || enfoque === 'multi_eje') {
          sugeridos.add('hsm3D');
          if (prioridad === 'acabado' || prioridad === 'equilibrado') {
            sugeridos.add('hss');
          }
        }

        if (prioridad === 'ciclo') {
          sugeridos.add('iMach3D');
        }

        if (ejes === '4x_index' || ejes === '4x_sim') {
          sugeridos.add('sim4X');
        }
        if (ejes === '5x_std' || ejes === '5x_adv') {
          sugeridos.add('sim5Std');
        }

        if (enfoque === 'electrodos') {
          sugeridos.add('imoldDesigner');
          sugeridos.add('imoldElectrode');
        }

        // sonda casi siempre útil si hay moldes / producción
        if (enfoque === '3d_moldes' || enfoque === 'produccion') {
          sugeridos.add('probe1');
        }

        // machine simulation sólo si hay 4/5X o MillTurn
        if (ejes === '4x_sim' || ejes === '5x_std' || ejes === '5x_adv' || tipo === 'millturn') {
          sugeridos.add('machineSim');
        }

      } else if (tipo === 'torno') {
        sugeridos.add('turningBase');

        if (ejes === 'subspindle') {
          sugeridos.add('multit');
        }

      } else if (tipo === 'wire') {
        if (ejes === 'wire2') sugeridos.add('wire2');
        if (ejes === 'wire4') sugeridos.add('wire24');
      }

      // Render checkboxes
      listaModulosDiv.innerHTML = '';
      Object.entries(moduleCatalog).forEach(([key, def]) => {
        // Filtrar por tipo de máquina para no mostrar cosas absurdas
        if (tipo === 'torno') {
          // solo Turning / Swiss / Multiturret / quizá machineSim
          const soloTornoKeys = ['turningBase', 'swiss', 'multit'];
          if (!soloTornoKeys.includes(key)) return;
        }
        if (tipo === 'wire') {
          const soloWireKeys = ['wire2', 'wire24'];
          if (!soloWireKeys.includes(key)) return;
        }

        const id = 'mod_' + key;
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-start gap-2 bg-base-900/40 border border-slate-700 rounded-lg px-2 py-2 cursor-pointer hover:border-accent-500';
        wrapper.innerHTML = `
          <input type="checkbox" id="${id}" data-key="${key}" class="mt-1 h-3 w-3 rounded border-slate-600 bg-base-900">
          <div class="flex-1">
            <div class="font-medium text-[11px]">${def.name}</div>
            <div class="text-[10px] text-slate-400">${def.packageCode ? def.packageCode : 'Sin código sistema definido'}</div>
          </div>
          <div class="text-[11px] text-slate-200 whitespace-nowrap">${formatUSD(def.price)}</div>
        `;
        listaModulosDiv.appendChild(wrapper);

        if (sugeridos.has(key)) {
          wrapper.querySelector('input').checked = true;
        }
      });
    }

    document.getElementById('enfoquePrincipal').addEventListener('change', sugerirModulos);
    document.getElementById('prioridad').addEventListener('change', sugerirModulos);
    configEgesListener();

    function configEgesListener() {
      configEjesSelect.addEventListener('change', sugerirModulos);
    }

    document.getElementById('btnSeleccionarTodos').addEventListener('click', () => {
      listaModulosDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });

    // Inicializar
    refillAxisOptions();
    sugerirModulos();

    // --------------------- Cálculo de resultados ---------------------
    const tablaModulosBody = document.getElementById('tablaModulos');
    const tablaPostsBody = document.getElementById('tablaPosts');
    const tablaCapsBody = document.getElementById('tablaCaps');
    const tablaGlobalBody = document.getElementById('tablaGlobal');

    function calcular() {
      const tipo = tipoMaquinaSelect.value;
      const numMaquinas = parseInt(document.getElementById('numMaquinas').value || '1', 10);
      const numPosts = parseInt(document.getElementById('numPosts').value || '0', 10);

      // 1) Módulos seleccionados
      const selectedModules = [];
      listaModulosDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        const key = cb.dataset.key;
        const def = moduleCatalog[key];
        if (def) selectedModules.push(def);
      });

      // Calcular precios por módulo (multiplicados por # máquinas)
      let totLic = 0, totSubs1Y = 0, totSubs3Y = 0, totLicSubs1Y = 0, totLicSubs3Y = 0, totTrade2Y = 0, totTrade3Y = 0, totTerm = 0;

      tablaModulosBody.innerHTML = '';
      selectedModules.forEach(def => {
        const lic = def.price * numMaquinas;
        const subs1 = calcSubs1Y(def.price) * numMaquinas;
        const subs3 = calcSubs3Y(def.price) * numMaquinas;
        const licSubs1 = lic + subs1;
        const licSubs3 = lic + subs3;
        const trade2 = calcTrade2Y(def.price) * numMaquinas;
        const trade3 = calcTrade3Y(def.price) * numMaquinas;
        const term = calcTerm(def.price) * numMaquinas;

        totLic += lic;
        totSubs1Y += subs1;
        totSubs3Y += subs3;
        totLicSubs1Y += licSubs1;
        totLicSubs3Y += licSubs3;
        totTrade2Y += trade2;
        totTrade3Y += trade3;
        totTerm += term;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${def.name}</td>
          <td class="px-3 py-2 text-right">${formatUSD(lic)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(subs1)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(subs3)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(licSubs1)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(licSubs3)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(trade2)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(trade3)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(term)}</td>
          <td class="px-3 py-2 text-xs">${def.packageCode || '-'}</td>
        `;
        tablaModulosBody.appendChild(tr);
      });

      document.getElementById('totLicencia').textContent = formatUSD(totLic);
      document.getElementById('totSubs1Y').textContent = formatUSD(totSubs1Y);
      document.getElementById('totSubs3Y').textContent = formatUSD(totSubs3Y);
      document.getElementById('totLicSubs1Y').textContent = formatUSD(totLicSubs1Y);
      document.getElementById('totLicSubs3Y').textContent = formatUSD(totLicSubs3Y);
      document.getElementById('totTrade2Y').textContent = formatUSD(totTrade2Y);
      document.getElementById('totTrade3Y').textContent = formatUSD(totTrade3Y);
      document.getElementById('totTerm').textContent = formatUSD(totTerm);

      // 2) Posts
      tablaPostsBody.innerHTML = '';
      let totalPosts = 0;
      if (numPosts > 0) {
        // Lógica simple: si tipo = cm, usar posts 4/5X; si torno, Turning; si millturn, MillTurn; si wire, wire
        let postKey;
        if (tipo === 'cm') {
          postKey = 'milling4';
        } else if (tipo === 'torno') {
          postKey = 'turning';
        } else if (tipo === 'millturn') {
          postKey = 'millturn4';
        } else if (tipo === 'wire') {
          postKey = 'wire2';
        }
        const postDef = postPrices[postKey];
        if (postDef) {
          const rowTotal = postDef.price * numPosts;
          totalPosts += rowTotal;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2">${postDef.name}</td>
            <td class="px-3 py-2 text-right">${formatUSD(postDef.price)}</td>
            <td class="px-3 py-2 text-right">${numPosts}</td>
            <td class="px-3 py-2 text-right">${formatUSD(rowTotal)}</td>
            <td class="px-3 py-2 text-xs">${postDef.code}</td>
          `;
          tablaPostsBody.appendChild(tr);
        }
      }
      document.getElementById('totPosts').textContent = formatUSD(totalPosts);

      // 3) Capacitaciones sugeridas
      tablaCapsBody.innerHTML = '';
      let totalCaps = 0;
      // Regla simple: si hay millingBase → curso milling, si hay iMach → generalWorkshop + hsm/hsr, etc.
      const moduleNames = selectedModules.map(m => m.name);

      function addCap(capKey) {
        const cap = trainingCatalog[capKey];
        if (!cap) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${cap.name}</td>
          <td class="px-3 py-2 text-right">${formatUSD(cap.price)}</td>
          <td class="px-3 py-2 text-xs">${cap.code}</td>
        `;
        tablaCapsBody.appendChild(tr);
        totalCaps += cap.price;
      }

      if (moduleNames.includes(moduleCatalog.millingBase?.name)) addCap('millingBase');
      if (moduleNames.includes(moduleCatalog.hsr?.name)) addCap('hsr');
      if (moduleNames.includes(moduleCatalog.hss?.name)) addCap('hss');
      if (moduleNames.includes(moduleCatalog.hsm3D?.name)) addCap('hsm3d');
      if (moduleNames.includes(moduleCatalog.sim4X?.name)) addCap('sim4');
      if (moduleNames.includes(moduleCatalog.sim5Std?.name) || moduleNames.includes(moduleCatalog.sim5Pro?.name)) addCap('sim5');
      if (moduleNames.includes(moduleCatalog.probe1?.name) || moduleNames.includes(moduleCatalog.probe2?.name)) addCap('probe');
      if (moduleNames.includes(moduleCatalog.turningBase?.name)) addCap('turning');
      if (moduleNames.includes(moduleCatalog.imoldDesigner?.name)) addCap('imold');

      // siempre puedes agregar un taller general
      addCap('generalWorkshop');

      document.getElementById('totCaps').textContent = formatUSD(totalCaps);

      // 4) Resumen global de escenarios (módulos + posts + caps + implementación)
      const baseTotalLic = totLic + totalPosts + totalCaps + implementationItem.price;

      tablaGlobalBody.innerHTML = '';
      function addScenario(label, montoLic, extraSubs, termLike) {
        const total = montoLic + (extraSubs || 0);
        const totalIVA = total * 1.16;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${label}</td>
          <td class="px-3 py-2 text-right">${formatUSD(total)}</td>
          <td class="px-3 py-2 text-right">${formatUSD(totalIVA)}</td>
        `;
        tablaGlobalBody.appendChild(tr);
      }

      addScenario('Licencia + 1 año de servicio', totLic + totalPosts + totalCaps + implementationItem.price, totSubs1Y);
      addScenario('Licencia + 3 años de servicio', totLic + totalPosts + totalCaps + implementationItem.price, totSubs3Y);
      addScenario('Trade-in 2 años (Lic + Subs1Y con desc.)', totTrade2Y + totalPosts + totalCaps + implementationItem.price, 0);
      addScenario('Trade-in 3 años (Lic + Subs3Y con desc.)', totTrade3Y + totalPosts + totalCaps + implementationItem.price, 0);
      addScenario('Term 1 año (solo licencia sin servicio)', totTerm + totalPosts + totalCaps, 0);
    }

    document.getElementById('btnCalcular').addEventListener('click', calcular);

    // Exportación sencilla: genera texto en un popup
    document.getElementById('btnExportar').addEventListener('click', () => {
      const descripcion = document.getElementById('descripcionProceso').value || '(sin descripción)';
      let text = 'Resumen configurador SolidCAM\n\n';
      text += 'Descripción del proceso:\n' + descripcion + '\n\n';
      text += 'Módulos seleccionados:\n';
      listaModulosDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        const key = cb.dataset.key;
        const def = moduleCatalog[key];
        if (def) {
          text += `- ${def.name} (${def.packageCode || 'sin código'}) - ${formatUSD(def.price)}\n`;
        }
      });
      alert(text);
    });

    // Limpiar todo
    document.getElementById('btnLimpiar').addEventListener('click', () => {
      document.getElementById('numMaquinas').value = 1;
      document.getElementById('numPosts').value = 1;
      document.getElementById('descripcionProceso').value = '';
      tipoMaquinaSelect.value = 'cm';
      refillAxisOptions();
      sugerirModulos();
      tablaModulosBody.innerHTML = '';
      tablaPostsBody.innerHTML = '';
      tablaCapsBody.innerHTML = '';
      tablaGlobalBody.innerHTML = '';
      document.getElementById('totLicencia').textContent = '$ 0.00';
      document.getElementById('totSubs1Y').textContent = '$ 0.00';
      document.getElementById('totSubs3Y').textContent = '$ 0.00';
      document.getElementById('totLicSubs1Y').textContent = '$ 0.00';
      document.getElementById('totLicSubs3Y').textContent = '$ 0.00';
      document.getElementById('totTrade2Y').textContent = '$ 0.00';
      document.getElementById('totTrade3Y').textContent = '$ 0.00';
      document.getElementById('totTerm').textContent = '$ 0.00';
      document.getElementById('totPosts').textContent = '$ 0.00';
      document.getElementById('totCaps').textContent = '$ 0.00';
    });
  </script>
</body>
</html>
