<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROI REGO-FIX Holders — Calculadora modular | AlexRaSa</title>
  <meta name="description" content="Calculadora modular de ROI enfocada en holders y consumibles REGO-FIX. Carrito con búsqueda por SKU/nombre, precios manuales, ahorros por tiempo/vida de herramienta/proceso." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --rego-green: #B7C91F;
      --rego-green-2:#AAC82D;
      --rego-turq:  #58D5D3;
      --rego-blue:  #28556C;
      --rego-red:   #D31B23;
      --rego-black: #121314;
      --rego-gd:    #44474A;
      --rego-gm:    #677071;
      --rego-gl:    #E5E6E4;
      --card: #ffffff;
      --bg: #ffffff;
      --border: rgba(40,85,108,.18);
      --shadow: 0 10px 30px rgba(18,19,20,.08);
    }
    html,body{ background: var(--bg) !important; color: var(--rego-black); }
    /* Fuerza modo blanco aunque el navegador quiera “dark” */
    @media (prefers-color-scheme: dark){
      html,body{ background:#fff !important; color:#121314 !important; }
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 20px;
    }
    .chip{
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .35rem .65rem;
      font-size: .8rem;
      color: var(--rego-blue);
      background: #fff;
    }
    .btn{
      border-radius: 16px;
      padding: .75rem 1rem;
      font-weight: 700;
      border: 1px solid transparent;
      transition: .15s ease;
      user-select:none;
    }
    .btn-primary{ background: var(--rego-green); color: #121314; }
    .btn-primary:hover{ filter: brightness(.96); }
    .btn-outline{ background:#fff; border-color: var(--border); color: var(--rego-black); }
    .btn-outline:hover{ background: rgba(183,201,31,.10); }
    .btn-danger{ background: var(--rego-red); color:#fff; }
    .btn-danger:hover{ filter: brightness(.95); }
    .kpi{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: .9rem 1rem;
      background: #fff;
    }
    .muted{ color: var(--rego-gm); }
    .label{ color: var(--rego-gd); font-weight: 700; font-size:.9rem; }
    .input{
      width:100%;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: .65rem .8rem;
      outline: none;
      background:#fff;
    }
    .input:focus{ border-color: rgba(40,85,108,.45); box-shadow: 0 0 0 4px rgba(88,213,211,.18); }
    .switch{
      position:relative; width: 52px; height: 30px; border-radius: 999px;
      background: rgba(103,112,113,.25);
      border:1px solid var(--border);
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch[data-on="true"]{ background: rgba(183,201,31,.85); }
    .switch .knob{
      position:absolute; top: 3px; left: 3px;
      width: 24px; height: 24px; border-radius: 999px;
      background:#fff; box-shadow: 0 6px 16px rgba(18,19,20,.15);
      transition: .15s ease;
    }
    .switch[data-on="true"] .knob{ transform: translateX(22px); }
    .hr{ height:1px; background: rgba(40,85,108,.14); border:0; }
    .badge{
      display:inline-flex; align-items:center; gap:.35rem;
      border-radius: 999px;
      padding:.25rem .55rem;
      font-size: .78rem;
      font-weight:700;
      border:1px solid var(--border);
      background:#fff;
    }
    .badge.inv{ color: var(--rego-blue); }
    .badge.cons{ color: var(--rego-red); }
    .small{ font-size:.85rem; }
    .by{
      font-size:.78rem;
      color: var(--rego-gm);
      letter-spacing: .02em;
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-6 pb-4">
    <div class="card p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3">
          <img id="logo" src="./regofixlogo.png" alt="REGO-FIX" class="h-10 w-auto" onerror="this.style.display='none'">
          <div>
            <div class="text-xl sm:text-2xl font-extrabold" style="color:var(--rego-black)">
              ROI Holders REGO-FIX
            </div>
            <div class="muted small">
              Calculadora modular (inversión + consumibles) · carrito con búsqueda SKU/nombre
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap justify-start sm:justify-end">
          <span class="chip">Modo blanco fijo</span>
          <span class="chip">Colores REGO-FIX</span>
          <span class="chip">100% funcional (sin “switches de adorno”)</span>
        </div>
      </div>

      <div class="mt-4 rounded-2xl overflow-hidden border" style="border-color:var(--border); background:linear-gradient(90deg, rgba(183,201,31,.18), rgba(88,213,211,.18), rgba(40,85,108,.10));">
        <div class="p-4 sm:p-5 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <div class="flex-1">
            <div class="font-extrabold" style="color:var(--rego-blue)">Enfoque: holders + items REGO-FIX</div>
            <div class="muted small">Los precios se capturan manualmente. El catálogo es una lista editable/importable (CSV) para que puedas meter TODO tu catálogo sin pelearte con el PDF.</div>
          </div>
          <div class="text-right">
            <div class="by">by alexrasa</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-10 space-y-6">

    <!-- 1) Configuración base -->
    <section class="card p-4 sm:p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg sm:text-xl font-extrabold" style="color:var(--rego-black)">1) Configuración base</h2>
          <p class="muted small mt-1">Define el costo de máquina/hora y el volumen. Todo lo demás se calcula con tus switches.</p>
        </div>
        <span class="badge inv">Base</span>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div>
          <div class="label">Costo máquina (MXN/h)</div>
          <input id="costHour" class="input" type="number" min="0" step="1" value="850">
          <div class="muted small mt-1">Incluye operador, carga, overhead, etc.</div>
        </div>

        <div>
          <div class="label">Piezas por mes</div>
          <input id="partsMonth" class="input" type="number" min="0" step="1" value="5000">
          <div class="muted small mt-1">Para vida de herramienta y ciclo.</div>
        </div>

        <div>
          <div class="label">Días por mes</div>
          <input id="daysMonth" class="input" type="number" min="1" step="1" value="22">
        </div>

        <div>
          <div class="label">Horas por turno</div>
          <input id="hoursShift" class="input" type="number" min="1" step="0.5" value="8">
        </div>
      </div>
    </section>

    <!-- 2) Carrito: items REGO-FIX -->
    <section class="card p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div>
          <h2 class="text-lg sm:text-xl font-extrabold" style="color:var(--rego-black)">2) Carrito REGO-FIX (inversión + consumibles)</h2>
          <p class="muted small mt-1">Busca por SKU o nombre. Agrega cantidades. Captura precios manuales. Clasifica cada línea como <b>Inversión</b> o <b>Consumible mensual</b>.</p>
        </div>
        <div class="flex gap-2">
          <button id="btnClearCart" class="btn btn-outline">Vaciar carrito</button>
          <button id="btnAddCustom" class="btn btn-primary">+ Línea manual</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Catálogo -->
        <div class="card p-4">
          <div class="flex items-center justify-between gap-2">
            <div class="font-extrabold" style="color:var(--rego-blue)">Catálogo (editable)</div>
            <span class="chip" id="catalogCount">0 items</span>
          </div>

          <div class="mt-3">
            <input id="catalogSearch" class="input" placeholder="Buscar por SKU o nombre (ej. 4340.11136 o ER 16)">
            <div class="muted small mt-1">Tip: si tu catálogo es gigante, usa SKU y listo. Es el “control numérico” de las compras.</div>
          </div>

          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnImportCsv" class="btn btn-outline">Importar CSV</button>
            <button id="btnExportCsv" class="btn btn-outline">Exportar CSV</button>
          </div>

          <!-- Import CSV drawer -->
          <div id="csvPanel" class="mt-3 hidden">
            <div class="muted small mb-2">
              Pega CSV con columnas: <b>sku,name,category</b> (category opcional). Una línea por item.
            </div>
            <textarea id="csvTextarea" class="input" rows="6" placeholder="sku,name,category&#10;4340.11136,CAT+ 40/ER 11 x 050 H,holders"></textarea>
            <div class="mt-2 flex gap-2">
              <button id="btnCsvApply" class="btn btn-primary">Aplicar</button>
              <button id="btnCsvClose" class="btn btn-outline">Cerrar</button>
            </div>
          </div>

          <hr class="hr my-4"/>

          <div id="catalogResults" class="space-y-2 max-h-[420px] overflow-auto pr-1">
            <!-- results rendered -->
          </div>
        </div>

        <!-- Carrito -->
        <div class="card p-4">
          <div class="flex items-center justify-between gap-2">
            <div class="font-extrabold" style="color:var(--rego-blue)">Carrito</div>
            <span class="chip" id="cartCount">0 líneas</span>
          </div>

          <div id="cartList" class="mt-3 space-y-2">
            <!-- cart rows -->
          </div>

          <hr class="hr my-4"/>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="kpi">
              <div class="muted small">Total Inversión</div>
              <div id="totalInv" class="text-2xl font-extrabold">MXN 0</div>
              <div class="muted small">Pago único (holders, kits, etc.)</div>
            </div>
            <div class="kpi">
              <div class="muted small">Consumibles mensuales</div>
              <div id="totalCons" class="text-2xl font-extrabold">MXN 0</div>
              <div class="muted small">Líquidos, limpiadores, collets si lo manejas así, etc.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) Ahorros (switches reales) -->
    <section class="card p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div>
          <h2 class="text-lg sm:text-xl font-extrabold" style="color:var(--rego-black)">3) Ahorros estimados (3 frentes)</h2>
          <p class="muted small mt-1">Activa solo lo que aplique. Cada módulo se suma a los ahorros mensuales.</p>
        </div>
        <span class="badge inv">Ahorros</span>
      </div>

      <!-- cards -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">

        <!-- A) Tiempo -->
        <div class="card p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-extrabold" style="color:var(--rego-blue)">A) Ahorro por tiempo</div>
              <div class="muted small">Setups, cambios, paros por cambios</div>
            </div>
            <div class="switch" id="swTime" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="mt-3 space-y-3" id="timeBody">
            <div class="flex items-center justify-between">
              <div class="small font-bold" style="color:var(--rego-gd)">Incluir: Cambios/mes * min/cambio</div>
              <div class="switch" id="swTimeChanges" data-on="true"><div class="knob"></div></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="label">Cambios/mes (actual)</div>
                <input id="chgAct" class="input" type="number" min="0" step="1" value="180">
              </div>
              <div>
                <div class="label">Cambios/mes (nuevo)</div>
                <input id="chgNew" class="input" type="number" min="0" step="1" value="140">
              </div>
              <div>
                <div class="label">Min/cambio (actual)</div>
                <input id="chgMinAct" class="input" type="number" min="0" step="0.1" value="6">
              </div>
              <div>
                <div class="label">Min/cambio (nuevo)</div>
                <input id="chgMinNew" class="input" type="number" min="0" step="0.1" value="4.5">
              </div>
            </div>

            <hr class="hr"/>

            <div class="flex items-center justify-between">
              <div class="small font-bold" style="color:var(--rego-gd)">Incluir: Setups/mes * min/setup</div>
              <div class="switch" id="swTimeSetups" data-on="false"><div class="knob"></div></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="label">Setups/mes (actual)</div>
                <input id="setAct" class="input" type="number" min="0" step="1" value="20">
              </div>
              <div>
                <div class="label">Setups/mes (nuevo)</div>
                <input id="setNew" class="input" type="number" min="0" step="1" value="18">
              </div>
              <div>
                <div class="label">Min/setup (actual)</div>
                <input id="setMinAct" class="input" type="number" min="0" step="0.1" value="25">
              </div>
              <div>
                <div class="label">Min/setup (nuevo)</div>
                <input id="setMinNew" class="input" type="number" min="0" step="0.1" value="20">
              </div>
            </div>

            <hr class="hr"/>

            <div class="flex items-center justify-between">
              <div class="small font-bold" style="color:var(--rego-gd)">Incluir: Paros/mes * min/paro</div>
              <div class="switch" id="swTimeStops" data-on="false"><div class="knob"></div></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="label">Paros/mes (actual)</div>
                <input id="stpAct" class="input" type="number" min="0" step="1" value="12">
              </div>
              <div>
                <div class="label">Paros/mes (nuevo)</div>
                <input id="stpNew" class="input" type="number" min="0" step="1" value="8">
              </div>
              <div>
                <div class="label">Min/paro (actual)</div>
                <input id="stpMinAct" class="input" type="number" min="0" step="0.1" value="18">
              </div>
              <div>
                <div class="label">Min/paro (nuevo)</div>
                <input id="stpMinNew" class="input" type="number" min="0" step="0.1" value="12">
              </div>
            </div>

            <div class="kpi mt-3">
              <div class="muted small">Ahorro por tiempo (mensual)</div>
              <div id="saveTime" class="text-xl font-extrabold">MXN 0</div>
            </div>
          </div>
        </div>

        <!-- B) Vida herramienta -->
        <div class="card p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-extrabold" style="color:var(--rego-blue)">B) Vida de herramienta</div>
              <div class="muted small">Mis mismas condiciones, más ciclos por herramienta</div>
            </div>
            <div class="switch" id="swLife" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="mt-3 space-y-3" id="lifeBody">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="label">Ciclos por herramienta (actual)</div>
                <input id="lifeAct" class="input" type="number" min="1" step="1" value="100">
              </div>
              <div>
                <div class="label">Ciclos por herramienta (nuevo)</div>
                <input id="lifeNew" class="input" type="number" min="1" step="1" value="160">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="label">Costo por herramienta (MXN)</div>
                <input id="toolCost" class="input" type="number" min="0" step="1" value="650">
              </div>
              <div>
                <div class="label">Herramientas iguales en proceso</div>
                <input id="toolCount" class="input" type="number" min="1" step="1" value="3">
              </div>
            </div>

            <div class="kpi">
              <div class="muted small">Ahorro por vida (mensual)</div>
              <div id="saveLife" class="text-xl font-extrabold">MXN 0</div>
              <div class="muted small">Asume consumo proporcional a piezas/mes.</div>
            </div>
          </div>
        </div>

        <!-- C) Proceso -->
        <div class="card p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-extrabold" style="color:var(--rego-blue)">C) Mejora de proceso</div>
              <div class="muted small">Ciclo menor por sujeción más robusta</div>
            </div>
            <div class="switch" id="swProc" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="mt-3 space-y-3" id="procBody">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="label">Ciclo actual (min/pieza)</div>
                <input id="cycAct" class="input" type="number" min="0" step="0.01" value="3.20">
              </div>
              <div>
                <div class="label">Ciclo nuevo (min/pieza)</div>
                <input id="cycNew" class="input" type="number" min="0" step="0.01" value="2.85">
              </div>
            </div>

            <div class="kpi">
              <div class="muted small">Ahorro por proceso (mensual)</div>
              <div id="saveProc" class="text-xl font-extrabold">MXN 0</div>
              <div class="muted small">Ahorro = (min ahorrados * piezas/mes) * costo/min.</div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- 4) Resultados ROI -->
    <section class="card p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div>
          <h2 class="text-lg sm:text-xl font-extrabold" style="color:var(--rego-black)">4) Resultados</h2>
          <p class="muted small mt-1">Payback, ahorro neto mensual y ROI anual estimado.</p>
        </div>
        <div class="flex gap-2">
          <button id="btnCopySummary" class="btn btn-outline">Copiar resumen</button>
          <button id="btnResetAll" class="btn btn-danger">Reset</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="kpi">
          <div class="muted small">Ahorro bruto mensual</div>
          <div id="grossSave" class="text-2xl font-extrabold">MXN 0</div>
          <div class="muted small">Tiempo + vida + proceso</div>
        </div>
        <div class="kpi">
          <div class="muted small">Ahorro neto mensual</div>
          <div id="netSave" class="text-2xl font-extrabold">MXN 0</div>
          <div class="muted small">Bruto − consumibles mensuales</div>
        </div>
        <div class="kpi">
          <div class="muted small">Payback (meses)</div>
          <div id="payback" class="text-2xl font-extrabold">—</div>
          <div class="muted small">Inversión / ahorro neto mensual</div>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="kpi">
          <div class="muted small">ROI anual estimado</div>
          <div id="roiAnnual" class="text-2xl font-extrabold">—</div>
          <div class="muted small">((neto*12) / inversión) · si inversión = 0, se omite</div>
        </div>
        <div class="kpi">
          <div class="muted small">Notas</div>
          <div class="small" style="color:var(--rego-gd)">
            Esta calculadora es intencionalmente “manual” en precios: tú mandas.  
            (Como debe ser. Si compras por intuición, luego no te quejes del retrabajo financiero.)
          </div>
        </div>
      </div>
    </section>

    <!-- footer small -->
    <footer class="text-center pb-4">
      <div class="by">by alexrasa</div>
    </footer>

  </main>

<script>
/* =========================
   Datos: Catálogo inicial
   =========================
   Nota: el PDF que compartiste viene mayormente como imagen (no texto).
   Por eso, aquí dejo un “starter” de SKUs (extraídos de algunas páginas) y
   te doy importación CSV para que metas TODO tu catálogo sin sufrir.

   Formato item: { sku, name, category }
*/
const DEFAULT_CATALOG = [
  // Sample holders/portapinzas (OCR parcial)
  { sku:"4340.11136", name:"CAT+ 40/ER 11 x 050 H", category:"holders" },
  { sku:"4340.11236", name:"CAT+ 40/ER 11 x 070 H", category:"holders" },
  { sku:"4340.11336", name:"CAT+ 40/ER 11 x 100 H", category:"holders" },
  { sku:"4340.11436", name:"CAT+ 40/ER 11 x 150 H", category:"holders" },
  { sku:"4340.11536", name:"CAT+ 40/ER 11 x 200 H", category:"holders" },
  { sku:"4340.11636", name:"CAT+ 40/ER 11 x 250 H", category:"holders" },
  { sku:"4340.11736", name:"CAT+ 40/ER 11 x 300 H", category:"holders" },
  { sku:"4350.11166", name:"CAT+ 40/ER 16 x 050 H", category:"holders" },
  { sku:"4350.11266", name:"CAT+ 40/ER 16 x 070 H", category:"holders" },
  { sku:"4350.11366", name:"CAT+ 40/ER 16 x 100 H", category:"holders" },
  { sku:"4350.11466", name:"CAT+ 40/ER 16 x 150 H", category:"holders" },
  { sku:"4350.11566", name:"CAT+ 40/ER 16 x 200 H", category:"holders" },
  { sku:"4350.11666", name:"CAT+ 40/ER 16 x 250 H", category:"holders" },

  { sku:"4805.13250", name:"CS/ER 32 x 100H", category:"holders" },
  { sku:"4806.11170", name:"(C6/ER 11x 1S0H)", category:"holders" },
  { sku:"4806.11630", name:"C6/ER 16 x 070H", category:"holders" },
  { sku:"4806.11650", name:"C6/ER 16 x 100 H", category:"holders" },
  { sku:"4806.11670", name:"C6/ER 16 x 150H", category:"holders" },

  { sku:"8886.13050", name:"CO/ER 16 x 225 XL", category:"holders" },
  { sku:"8886.13070", name:"CO/ER 16 x 240 XL", category:"holders" },
  { sku:"8886.13090", name:"CO/ER 16 x 260 XL", category:"holders" },
  { sku:"8886.13130", name:"CO/ER 16 x 300 XL", category:"holders" },
  { sku:"8886.13150", name:"CO/ER 16 x 325 XL", category:"holders" },
  { sku:"8886.13170", name:"C6/ER 16 x 340 XL", category:"holders" },
  { sku:"8886.13190", name:"C6/ER 16 x 360 XL", category:"holders" },

  { sku:"2806.12020", name:"C6/ER 20 x 060", category:"holders" },
  { sku:"2808.15040", name:"CB/ER 50 x 080", category:"holders" },

  // Ejemplos de “consumibles/limpieza” (agrega lo tuyo por CSV)
  { sku:"CLEAN-001", name:"Limpiador (ejemplo) — captura SKU real por CSV", category:"cleaning" },
  { sku:"ACC-001",   name:"Accesorio (ejemplo) — captura SKU real por CSV", category:"accessories" }
];

/* =========================
   Estado
   ========================= */
const state = {
  catalog: [],
  cart: [], // {id, sku, name, qty, price, type:"inv"|"cons"}
  switches: {
    time: true,
    timeChanges: true,
    timeSetups: false,
    timeStops: false,
    life: true,
    proc: true
  }
};

const $ = (id)=>document.getElementById(id);
const money = (n)=>{
  const v = Number(n||0);
  return "MXN " + v.toLocaleString("es-MX",{maximumFractionDigits:0});
};
const clamp0 = (n)=>Math.max(0, Number(n||0));

function uid(){
  return Math.random().toString(16).slice(2)+Date.now().toString(16);
}

/* =========================
   Switch helpers
   ========================= */
function setSwitch(el, on){
  el.dataset.on = on ? "true":"false";
}
function getSwitch(el){
  return el.dataset.on === "true";
}
function bindSwitch(id, key, onChange){
  const el = $(id);
  setSwitch(el, !!state.switches[key]);
  const toggle = ()=>{
    const next = !getSwitch(el);
    setSwitch(el, next);
    state.switches[key] = next;
    onChange && onChange(next);
    renderAll();
  };
  el.addEventListener("click", toggle);
  el.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggle(); }
  });
}

/* =========================
   Catálogo
   ========================= */
function loadInitial(){
  // localStorage
  const savedCat = localStorage.getItem("rego_catalog_v1");
  const savedCart = localStorage.getItem("rego_cart_v1");
  const savedSw  = localStorage.getItem("rego_switches_v1");

  state.catalog = savedCat ? safeJson(savedCat, DEFAULT_CATALOG) : DEFAULT_CATALOG.slice();
  state.cart    = savedCart ? safeJson(savedCart, []) : [];
  state.switches= savedSw ? safeJson(savedSw, state.switches) : state.switches;

  // ensure minimal
  if(!Array.isArray(state.catalog)) state.catalog = DEFAULT_CATALOG.slice();
  if(!Array.isArray(state.cart)) state.cart = [];
}

function persist(){
  localStorage.setItem("rego_catalog_v1", JSON.stringify(state.catalog));
  localStorage.setItem("rego_cart_v1", JSON.stringify(state.cart));
  localStorage.setItem("rego_switches_v1", JSON.stringify(state.switches));
}

function safeJson(str, fallback){
  try{ return JSON.parse(str); }catch{ return fallback; }
}

function renderCatalog(){
  $("catalogCount").textContent = `${state.catalog.length} items`;
  const q = ($("catalogSearch").value||"").trim().toLowerCase();
  const results = state.catalog
    .filter(it=>{
      if(!q) return true;
      return (it.sku||"").toLowerCase().includes(q) || (it.name||"").toLowerCase().includes(q);
    })
    .slice(0, 60); // UI cap

  const wrap = $("catalogResults");
  wrap.innerHTML = "";

  if(results.length===0){
    const empty = document.createElement("div");
    empty.className="muted small";
    empty.textContent="Sin resultados. Importa CSV o prueba con SKU.";
    wrap.appendChild(empty);
    return;
  }

  results.forEach(it=>{
    const row = document.createElement("div");
    row.className="border rounded-2xl p-3 bg-white";
    row.style.borderColor="var(--border)";

    row.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-extrabold" style="color:var(--rego-black)">${escapeHtml(it.sku||"")}</div>
          <div class="small muted truncate">${escapeHtml(it.name||"")}</div>
          <div class="mt-2 flex gap-2 flex-wrap">
            <span class="badge inv">${escapeHtml(it.category||"item")}</span>
          </div>
        </div>
        <button class="btn btn-primary" style="padding:.55rem .8rem; border-radius:14px">Agregar</button>
      </div>
    `;
    row.querySelector("button").addEventListener("click", ()=>{
      addToCart(it);
    });
    wrap.appendChild(row);
  });
}

function addToCart(it){
  // If exists, increase qty
  const found = state.cart.find(x=>x.sku===it.sku && x.type==="inv");
  if(found){
    found.qty = clamp0(found.qty)+1;
  }else{
    state.cart.push({
      id: uid(),
      sku: it.sku || "",
      name: it.name || "",
      qty: 1,
      price: 0,
      type: "inv" // default: inversión
    });
  }
  persist();
  renderAll();
}

function addCustomLine(){
  state.cart.push({
    id: uid(),
    sku: "",
    name: "Línea manual",
    qty: 1,
    price: 0,
    type: "inv"
  });
  persist();
  renderAll();
}

function clearCart(){
  state.cart = [];
  persist();
  renderAll();
}

function renderCart(){
  $("cartCount").textContent = `${state.cart.length} líneas`;
  const wrap = $("cartList");
  wrap.innerHTML = "";

  if(state.cart.length===0){
    const empty = document.createElement("div");
    empty.className="muted small";
    empty.textContent="Carrito vacío. Agrega items del catálogo o crea una línea manual.";
    wrap.appendChild(empty);
    return;
  }

  state.cart.forEach(line=>{
    const row = document.createElement("div");
    row.className="border rounded-2xl p-3 bg-white";
    row.style.borderColor="var(--border)";

    row.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0 flex-1">
          <div class="flex gap-2 flex-wrap items-center">
            <span class="font-extrabold">${escapeHtml(line.sku||"—")}</span>
            <span class="badge ${line.type==="inv"?"inv":"cons"}">${line.type==="inv"?"Inversión":"Consumible mensual"}</span>
          </div>

          <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div>
              <div class="label">SKU</div>
              <input class="input" data-k="sku" value="${escapeAttr(line.sku||"")}">
            </div>
            <div>
              <div class="label">Nombre</div>
              <input class="input" data-k="name" value="${escapeAttr(line.name||"")}">
            </div>

            <div>
              <div class="label">Cantidad</div>
              <input class="input" data-k="qty" type="number" min="0" step="1" value="${Number(line.qty||0)}">
            </div>
            <div>
              <div class="label">Precio unitario (MXN)</div>
              <input class="input" data-k="price" type="number" min="0" step="1" value="${Number(line.price||0)}">
            </div>

            <div class="sm:col-span-2">
              <div class="label">Tipo</div>
              <select class="input" data-k="type">
                <option value="inv" ${line.type==="inv"?"selected":""}>Inversión</option>
                <option value="cons" ${line.type==="cons"?"selected":""}>Consumible mensual</option>
              </select>
            </div>
          </div>

          <div class="mt-2 flex items-center justify-between">
            <div class="muted small">Subtotal</div>
            <div class="font-extrabold">${money(clamp0(line.qty)*clamp0(line.price))}</div>
          </div>
        </div>

        <button class="btn btn-outline" title="Eliminar" style="padding:.55rem .7rem; border-radius:14px">✕</button>
      </div>
    `;

    // Bind inputs
    row.querySelectorAll("[data-k]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==="qty"||k==="price") v = Number(v||0);
        line[k] = v;
        persist();
        renderAll(false);
      });
      inp.addEventListener("change", ()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==="qty"||k==="price") v = Number(v||0);
        line[k] = v;
        persist();
        renderAll();
      });
    });

    row.querySelector("button").addEventListener("click", ()=>{
      state.cart = state.cart.filter(x=>x.id!==line.id);
      persist();
      renderAll();
    });

    wrap.appendChild(row);
  });
}

/* =========================
   Cálculos
   ========================= */
function calc(){
  const costHour = clamp0($("costHour").value);
  const costMin  = costHour / 60;

  // Cart totals
  let inv = 0, cons = 0;
  state.cart.forEach(l=>{
    const sub = clamp0(l.qty) * clamp0(l.price);
    if(l.type==="cons") cons += sub;
    else inv += sub;
  });

  // Savings
  let saveTime = 0, saveLife = 0, saveProc = 0;

  // A) Time
  if(state.switches.time){
    const doChanges = state.switches.timeChanges;
    const doSetups  = state.switches.timeSetups;
    const doStops   = state.switches.timeStops;

    let minSaved = 0;

    if(doChanges){
      const a = clamp0($("chgAct").value), b = clamp0($("chgNew").value);
      const ma = clamp0($("chgMinAct").value), mb = clamp0($("chgMinNew").value);
      minSaved += Math.max(0, (a*ma) - (b*mb));
    }
    if(doSetups){
      const a = clamp0($("setAct").value), b = clamp0($("setNew").value);
      const ma = clamp0($("setMinAct").value), mb = clamp0($("setMinNew").value);
      minSaved += Math.max(0, (a*ma) - (b*mb));
    }
    if(doStops){
      const a = clamp0($("stpAct").value), b = clamp0($("stpNew").value);
      const ma = clamp0($("stpMinAct").value), mb = clamp0($("stpMinNew").value);
      minSaved += Math.max(0, (a*ma) - (b*mb));
    }

    saveTime = minSaved * costMin;
  }

  // B) Tool life
  if(state.switches.life){
    const partsMonth = clamp0($("partsMonth").value);
    const lifeAct = Math.max(1, clamp0($("lifeAct").value));
    const lifeNew = Math.max(1, clamp0($("lifeNew").value));
    const toolCost = clamp0($("toolCost").value);
    const toolCount = Math.max(1, clamp0($("toolCount").value));

    // tools needed per month = partsMonth / life
    const toolsAct = (partsMonth / lifeAct) * toolCount;
    const toolsNew = (partsMonth / lifeNew) * toolCount;
    const spendAct = toolsAct * toolCost;
    const spendNew = toolsNew * toolCost;

    saveLife = Math.max(0, spendAct - spendNew);
  }

  // C) Process
  if(state.switches.proc){
    const partsMonth = clamp0($("partsMonth").value);
    const cycAct = clamp0($("cycAct").value);
    const cycNew = clamp0($("cycNew").value);
    const minSavedPer = Math.max(0, cycAct - cycNew);
    saveProc = (minSavedPer * partsMonth) * costMin;
  }

  const gross = saveTime + saveLife + saveProc;
  const net   = Math.max(0, gross - cons);

  let payback = null;
  if(inv > 0 && net > 0){
    payback = inv / net;
  }

  let roiAnnual = null;
  if(inv > 0){
    roiAnnual = (net*12) / inv;
  }

  return { inv, cons, saveTime, saveLife, saveProc, gross, net, payback, roiAnnual };
}

/* =========================
   Render
   ========================= */
function renderSavingsVisibility(){
  // hide bodies if module off
  toggleBlock("timeBody", state.switches.time);
  toggleBlock("lifeBody", state.switches.life);
  toggleBlock("procBody", state.switches.proc);
}
function toggleBlock(id, on){
  const el = $(id);
  el.style.opacity = on ? "1" : ".45";
  el.style.pointerEvents = on ? "auto" : "none";
}

function renderKPIs(){
  const r = calc();

  $("totalInv").textContent = money(r.inv);
  $("totalCons").textContent = money(r.cons);

  $("saveTime").textContent = money(r.saveTime);
  $("saveLife").textContent = money(r.saveLife);
  $("saveProc").textContent = money(r.saveProc);

  $("grossSave").textContent = money(r.gross);
  $("netSave").textContent   = money(r.net);

  $("payback").textContent = (r.payback===null) ? "—" : (r.payback.toFixed(1) + " meses");
  $("roiAnnual").textContent = (r.roiAnnual===null) ? "—" : ((r.roiAnnual*100).toFixed(0) + "%");
}

function renderAll(doCatalog=true){
  renderSavingsVisibility();
  renderCart();
  if(doCatalog) renderCatalog();
  renderKPIs();
}

/* =========================
   CSV Import/Export
   ========================= */
function showCsvPanel(show){
  $("csvPanel").classList.toggle("hidden", !show);
}
function applyCsv(){
  const txt = $("csvTextarea").value || "";
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  for(const line of lines){
    // split CSV naive (works for simple data)
    const parts = line.split(",");
    if(parts.length < 2) continue;
    const sku = parts[0].trim();
    const name = parts.slice(1, parts.length-1>=1?parts.length-1:parts.length).join(",").trim();
    // if 3 columns: sku,name,category
    let category = "";
    if(parts.length >= 3){
      category = parts[parts.length-1].trim();
    }
    // if user pasted 2 columns, category blank
    out.push({ sku, name, category: category || "item" });
  }
  if(out.length===0){
    alert("CSV inválido. Usa: sku,name,category (category opcional).");
    return;
  }
  // merge: replace same sku
  const map = new Map(state.catalog.map(x=>[x.sku, x]));
  out.forEach(x=>{
    map.set(x.sku, x);
  });
  state.catalog = Array.from(map.values());
  persist();
  showCsvPanel(false);
  renderAll();
}

function exportCsv(){
  const rows = state.catalog.map(x=>`${csvEscape(x.sku)},${csvEscape(x.name)},${csvEscape(x.category||"")}`);
  const blob = new Blob([ "sku,name,category\n" + rows.join("\n") ], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "regofix_catalog.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function csvEscape(s){
  const v = String(s??"");
  if(/[",\n]/.test(v)) return `"${v.replaceAll('"','""')}"`;
  return v;
}

/* =========================
   UX helpers
   ========================= */
function escapeHtml(s){
  return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escapeAttr(s){
  return escapeHtml(s).replaceAll('"',"&quot;");
}

function copySummary(){
  const r = calc();
  const lines = [
    "ROI Holders REGO-FIX — Resumen",
    `Inversión total: ${money(r.inv)}`,
    `Consumibles mensuales: ${money(r.cons)}`,
    `Ahorro por tiempo (mensual): ${money(r.saveTime)}`,
    `Ahorro por vida herramienta (mensual): ${money(r.saveLife)}`,
    `Ahorro por proceso (mensual): ${money(r.saveProc)}`,
    `Ahorro bruto mensual: ${money(r.gross)}`,
    `Ahorro neto mensual: ${money(r.net)}`,
    `Payback: ${r.payback===null?"—":(r.payback.toFixed(1)+" meses")}`,
    `ROI anual: ${r.roiAnnual===null?"—":((r.roiAnnual*100).toFixed(0)+"%")}`,
  ];
  navigator.clipboard.writeText(lines.join("\n")).then(()=>{
    alert("Resumen copiado.");
  }).catch(()=>{
    alert("No se pudo copiar. (Tu navegador anda de malas.)");
  });
}

function resetAll(){
  if(!confirm("¿Reset total? Se borra carrito, switches y catálogo importado.")) return;
  localStorage.removeItem("rego_catalog_v1");
  localStorage.removeItem("rego_cart_v1");
  localStorage.removeItem("rego_switches_v1");
  loadInitial();
  bindAllSwitches();
  renderAll();
}

function bindAllSwitches(){
  bindSwitch("swTime","time", (on)=>{});
  bindSwitch("swTimeChanges","timeChanges", ()=>{});
  bindSwitch("swTimeSetups","timeSetups", ()=>{});
  bindSwitch("swTimeStops","timeStops", ()=>{});
  bindSwitch("swLife","life", ()=>{});
  bindSwitch("swProc","proc", ()=>{});

  // init visual state after load
  setSwitch($("swTime"), !!state.switches.time);
  setSwitch($("swTimeChanges"), !!state.switches.timeChanges);
  setSwitch($("swTimeSetups"), !!state.switches.timeSetups);
  setSwitch($("swTimeStops"), !!state.switches.timeStops);
  setSwitch($("swLife"), !!state.switches.life);
  setSwitch($("swProc"), !!state.switches.proc);
}

/* =========================
   Events
   ========================= */
function bindInputs(){
  [
    "costHour","partsMonth","daysMonth","hoursShift",
    "chgAct","chgNew","chgMinAct","chgMinNew",
    "setAct","setNew","setMinAct","setMinNew",
    "stpAct","stpNew","stpMinAct","stpMinNew",
    "lifeAct","lifeNew","toolCost","toolCount",
    "cycAct","cycNew"
  ].forEach(id=>{
    $(id).addEventListener("input", ()=>renderAll(false));
    $(id).addEventListener("change", ()=>renderAll(false));
  });

  $("catalogSearch").addEventListener("input", ()=>renderCatalog());
  $("btnClearCart").addEventListener("click", clearCart);
  $("btnAddCustom").addEventListener("click", addCustomLine);

  $("btnImportCsv").addEventListener("click", ()=>showCsvPanel(true));
  $("btnCsvClose").addEventListener("click", ()=>showCsvPanel(false));
  $("btnCsvApply").addEventListener("click", applyCsv);
  $("btnExportCsv").addEventListener("click", exportCsv);

  $("btnCopySummary").addEventListener("click", copySummary);
  $("btnResetAll").addEventListener("click", resetAll);
}

/* =========================
   Init
   ========================= */
loadInitial();
bindAllSwitches();
bindInputs();
renderAll();
</script>
</body>
</html>
