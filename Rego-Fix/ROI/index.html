<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora ROI REGO-FIX — by AlexRaSa</title>
  <meta name="description" content="Calcula ROI y payback enfocado a holders e items REGO-FIX. Ahorro por tiempo, vida de herramienta y mejora de proceso, modular por switches." />
  <meta name="theme-color" content="#121314" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://alexrasa.store/calculadora-roi-regofix/" />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="preload" as="image" href="/assets/regofix/hero-holders.jpg" />
  <meta name="color-scheme" content="dark">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      color-scheme: dark;

      /* REGO-FIX palette (user provided) */
      --rf-green: #B7C91F;
      --rf-green-2:#AAC82D;
      --rf-teal:  #58D5D3;
      --rf-blue:  #28556C;
      --rf-red:   #D31B23;

      --rf-black: #121314;
      --rf-gray-1:#44474A;
      --rf-gray-2:#677071;
      --rf-gray-3:#E5E6E4;

      --rf-text:  #E5E6E4;
      --rf-muted: rgba(229,230,228,.72);
      --rf-line:  rgba(229,230,228,.10);
      --rf-card:  rgba(229,230,228,.03);

      --good: var(--rf-green);
      --warn: var(--rf-green-2);
      --bad:  var(--rf-red);
      --cyan: var(--rf-teal);
      --ink:  var(--rf-blue);
    }

    html,body{
      background:var(--rf-black);
      color:var(--rf-text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{ color: var(--rf-teal); }
    #siteHeader{
      background:rgba(18,19,20,0.82);
      border-bottom:1px solid var(--rf-line);
      backdrop-filter: blur(10px);
    }

    .card{
      background: linear-gradient(180deg, rgba(229,230,228,0.04), rgba(229,230,228,0.02));
      border:1px solid var(--rf-line);
      border-radius: 14px;
    }
    input,select,textarea{
      background: rgba(229,230,228,0.04);
      color: var(--rf-text);
      border:1px solid rgba(229,230,228,0.14);
      padding:.55rem .65rem;
      border-radius:.65rem;
    }
    input:focus,select:focus{
      box-shadow:0 0 0 6px rgba(88,213,211,0.14);
      outline:none;
      border-color: rgba(88,213,211,0.35);
    }
    select option { color:#000; background:#fff; }

    .btn-primary{
      background: linear-gradient(180deg, var(--rf-red), #B8141B);
      color:#fff;
      border: 1px solid rgba(211,27,35,0.35);
    }
    .btn-primary:hover{ filter: brightness(1.05); }

    .btn-secondary{
      background: linear-gradient(180deg, rgba(40,85,108,0.35), rgba(40,85,108,0.18));
      color: var(--rf-text);
      border:1px solid rgba(40,85,108,0.45);
    }
    .btn-ghost{
      background: rgba(229,230,228,0.04);
      border:1px solid rgba(229,230,228,0.14);
      color: var(--rf-text);
    }

    .hero-bg{
      position:relative;
      background-image:url('/assets/regofix/hero-holders.jpg');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      min-height:360px;
      overflow:hidden;
    }
    .hero-bg::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(18,19,20,0.35), rgba(18,19,20,0.88));
      z-index:1;
      pointer-events:none;
    }
    .hero-content{ position:relative; z-index:2; }

    /* Switch */
    .switch{
      width: 44px; height: 26px;
      border-radius: 999px;
      background: rgba(229,230,228,0.10);
      border:1px solid rgba(229,230,228,0.14);
      position:relative;
      transition: background .15s ease, border-color .15s ease;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:3px; left:3px;
      width:20px; height:20px;
      border-radius:999px;
      background: rgba(229,230,228,0.75);
      transition: transform .15s ease, background .15s ease;
    }
    input[type="checkbox"].sw{
      position:absolute;
      opacity:0;
      width:44px;
      height:26px;
      cursor:pointer;
      z-index:2;
    }
    .sw:checked + .switch{
      background: rgba(183,201,31,0.25);
      border-color: rgba(183,201,31,0.55);
    }
    .sw:checked + .switch::after{
      transform: translateX(18px);
      background: var(--rf-green);
    }

    /* Badges */
    .stat-badge{
      display:inline-block;
      padding: .28rem .66rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 11px;
      min-width: 64px;
      text-align: center;
      line-height: 1;
      border: 1px solid rgba(229,230,228,0.14);
      background: rgba(229,230,228,0.05);
      color: var(--rf-text);
    }
    .stat-badge.badge-up{
      background: linear-gradient(180deg, rgba(183,201,31,0.95), rgba(170,200,45,0.95));
      color:#121314;
      border-color: rgba(183,201,31,0.55);
    }
    .stat-badge.badge-mid{
      background: linear-gradient(180deg, rgba(88,213,211,0.45), rgba(88,213,211,0.25));
      color:#121314;
      border-color: rgba(88,213,211,0.45);
    }
    .stat-badge.badge-down{
      background: linear-gradient(180deg, rgba(211,27,35,0.92), rgba(184,20,27,0.92));
      color:#fff;
      border-color: rgba(211,27,35,0.45);
    }

    /* SVG text color */
    #vizAhorros svg text, #vizPerf svg text, #vizCash svg text { fill: var(--rf-text) !important; }

    .safe-bottom{ padding-bottom: max(env(safe-area-inset-bottom), 1rem); }

    /* Print: 1-page report */
    @media print{
      @page{ size: Letter; margin: .4in; }
      html,body{ background:#fff !important; color:#000 !important; font-size: 8.5pt !important; }
      header, footer, .hero-bg, main > .lg\:col-span-2, #btnCalcularMobile, #itemsSection { display:none !important; }
      main{ display:block !important; padding:0 !important; margin:0 !important; max-width:100% !important; width:100% !important; }
      #reportSection{
        width:100% !important;
        display:grid !important;
        grid-template-columns: repeat(3,1fr) !important;
        gap:.5rem !important;
      }
      #reportSection > .lg\:col-span-4{ grid-column: span 1 !important; }
      #reportSection > .lg\:col-span-2{ grid-column: span 1 !important; }
      #reportSection > #visuales{ grid-column: span 1 !important; }
      .card{ border:1px solid #ccc !important; background:#fff !important; box-shadow:none !important; page-break-inside:avoid; padding:.5rem !important; }
      h1,h2,h3,p,span,div,text,svg,path{ color:#000 !important; fill:#000 !important; stroke:#000 !important; }
      .viz, .min-h-\[320px\]{ min-height: 150px !important; }
      #vizPerf svg { height: 200px !important; }
      svg text{ font-size: 8px !important; }
      .stat-badge.badge-up{ background:#B7C91F !important; color:#121314 !important; -webkit-print-color-adjust:exact; }
      .stat-badge.badge-mid{ background:#58D5D3 !important; color:#121314 !important; -webkit-print-color-adjust:exact; }
      .stat-badge.badge-down{ background:#D31B23 !important; color:#fff !important; -webkit-print-color-adjust:exact; }
    }
  </style>
</head>

<body class="antialiased">

<header id="siteHeader" class="sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between gap-3">
      <a href="/" class="flex items-center gap-3 shrink-0" aria-label="Ir al inicio">
        <img src="/assets/brand/regofixlogo.png" alt="Logo REGO-FIX" class="h-9 w-auto" width="170" height="36" />
        <span class="hidden sm:inline text-sm font-semibold tracking-tight" style="color:var(--rf-muted)">ROI Calculator</span>
      </a>

      <nav class="hidden lg:flex items-center gap-6 text-sm">
        <a href="/" class="hover:opacity-90">Inicio</a>
        <a href="/SolidCAM/" class="hover:opacity-90">Soluciones</a>
        <a href="/#servicios" class="hover:opacity-90">Servicios</a>
        <a href="/#recursos" class="hover:opacity-90">Recursos</a>
        <a href="/#contacto" class="hover:opacity-90">Contacto</a>
      </nav>

      <button id="mobileOpenBtn" class="lg:hidden p-2 rounded" aria-label="Abrir menú">
        <svg class="h-6 w-6" viewBox="0 0 24 24" stroke="currentColor" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
  </div>
</header>

<div id="mobileBackdrop" class="fixed inset-0 lg:hidden bg-black/70 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" style="z-index:9998;"></div>
<aside id="mobilePanel" class="fixed inset-0 lg:hidden translate-x-full transition-transform duration-300 ease-out" role="dialog" aria-modal="true" aria-labelledby="mobileMenuTitle" style="z-index:9999;">
  <div class="absolute inset-0 flex flex-col" style="background:var(--rf-black); color:var(--rf-text);">
    <div class="h-16 flex items-center justify-between px-4 border-b" style="border-color:var(--rf-line);">
      <span id="mobileMenuTitle" class="text-base font-semibold">Menú</span>
      <button id="mobileCloseBtn" class="p-2 rounded" aria-label="Cerrar menú" style="background:rgba(229,230,228,0.04); border:1px solid rgba(229,230,228,0.10);">
        <svg class="h-6 w-6" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto">
      <nav class="p-4">
        <ul class="space-y-1 text-[17px]">
          <li><a href="/" class="mobile-link block px-3 py-3 rounded-lg" style="background:rgba(229,230,228,0.04);">Inicio</a></li>
          <li><a href="/SolidCAM/" class="mobile-link block px-3 py-3 rounded-lg hover:opacity-90">Soluciones</a></li>
          <li><a href="/#servicios" class="mobile-link block px-3 py-3 rounded-lg hover:opacity-90">Servicios</a></li>
          <li><a href="/#recursos" class="mobile-link block px-3 py-3 rounded-lg hover:opacity-90">Recursos</a></li>
          <li><a href="/#contacto" class="mobile-link block px-3 py-3 rounded-lg hover:opacity-90">Contacto</a></li>
        </ul>

        <div class="mt-6 grid grid-cols-2 gap-2 px-1">
          <a href="/#soporte" class="px-3 py-2 text-center rounded-md btn-ghost">Soporte</a>
          <a href="/#agenda" class="px-3 py-2 text-center rounded-md btn-primary">Agendar</a>
        </div>
      </nav>
    </div>
  </div>
</aside>

<section aria-label="Hero" class="hero-bg">
  <div class="hero-content max-w-6xl mx-auto px-4 py-10 md:py-16">
    <div class="max-w-3xl">
      <h1 class="text-3xl md:text-5xl font-extrabold">Calculadora ROI <span style="color:var(--rf-green)">REGO-FIX</span></h1>
      <p class="mt-3 text-base md:text-lg" style="color:var(--rf-muted)">
        Enfocada a <strong>holders</strong> e <strong>items</strong>. Evalúa ahorro por <strong>tiempo</strong>, <strong>vida de herramienta</strong> y <strong>mejora de proceso</strong>.
        Modular por switches: incluye solo lo que aplique.
      </p>
      <div class="mt-4 flex flex-wrap gap-2">
        <span class="stat-badge badge-mid">Modular</span>
        <span class="stat-badge badge-up">Ahorro</span>
        <span class="stat-badge" style="border-color:rgba(88,213,211,.35); background:rgba(88,213,211,.12); color:#121314;">Payback</span>
      </div>
    </div>
  </div>
</section>

<main id="calc" class="max-w-6xl mx-auto px-4 pt-8 pb-28 md:pb-14 grid gap-4 sm:gap-6 lg:grid-cols-8">

  <!-- LEFT: Inputs -->
  <section class="card p-5 lg:col-span-2">
    <h2 class="text-lg font-semibold">Entradas</h2>
    <p class="text-sm mt-1" style="color:var(--rf-muted)">Activa/desactiva módulos para “solo lo real”.</p>

    <!-- Module switches -->
    <div class="mt-4 grid gap-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">Ahorro por tiempo</div>
          <div class="text-xs" style="color:var(--rf-muted)">Setups, cambios en máquina, paros.</div>
        </div>
        <div class="relative w-[44px] h-[26px]">
          <input id="modTiempo" class="sw" type="checkbox" checked>
          <div class="switch"></div>
        </div>
      </div>

      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">Ahorro por vida</div>
          <div class="text-xs" style="color:var(--rf-muted)">Más ciclos con mismo corte (mejor sujeción).</div>
        </div>
        <div class="relative w-[44px] h-[26px]">
          <input id="modVida" class="sw" type="checkbox" checked>
          <div class="switch"></div>
        </div>
      </div>

      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">Mejora de proceso</div>
          <div class="text-xs" style="color:var(--rf-muted)">Mejor sujeción → más agresivo → más pzas/turno.</div>
        </div>
        <div class="relative w-[44px] h-[26px]">
          <input id="modProceso" class="sw" type="checkbox" checked>
          <div class="switch"></div>
        </div>
      </div>
    </div>

    <!-- Common -->
    <div class="grid gap-3 mt-5">
      <label class="text-sm" title="Costo total de operar la máquina por hora (incluye MO, energía, overhead).">Costo por hora máquina (USD)
        <input id="costoHora" type="number" value="50" class="mt-1 w-full">
      </label>

      <label class="text-sm" title="Piezas producidas por mes para este proceso.">Piezas por mes
        <input id="pmes" type="number" value="10000" class="mt-1 w-full">
      </label>

      <label class="text-sm" title="CAPEX único (holders, accesorios, capacitación, etc).">Inversión inicial (USD)
        <input id="capex" type="number" value="2000" class="mt-1 w-full">
      </label>

      <label class="text-sm" title="OPEX mensual (mantenimiento/servicio, si aplica).">Mensualidad (USD)
        <input id="mensualidad" type="number" value="0" class="mt-1 w-full">
      </label>
    </div>

    <!-- Tiempo module -->
    <div id="boxTiempo" class="mt-5 card p-4" style="background:rgba(40,85,108,0.10); border-color:rgba(40,85,108,0.35);">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Tiempo</h3>
        <span class="text-xs" style="color:var(--rf-muted)">switch granular</span>
      </div>

      <div class="grid gap-3 mt-3">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm">Ciclo (Actual vs Propuesta)</div>
          <div class="relative w-[44px] h-[26px]">
            <input id="incCiclo" class="sw" type="checkbox" checked>
            <div class="switch"></div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Ciclo actual (s)
            <input id="cicloA" type="number" value="60" class="mt-1 w-full">
          </label>
          <label class="text-xs">Ciclo propuesto (s)
            <input id="cicloP" type="number" value="45" class="mt-1 w-full">
          </label>
        </div>

        <div class="flex items-center justify-between gap-3">
          <div class="text-sm">Cambios en máquina (cambios/mes × min/cambio)</div>
          <div class="relative w-[44px] h-[26px]">
            <input id="incCambios" class="sw" type="checkbox" checked>
            <div class="switch"></div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Cambios/mes (actual)
            <input id="cambiosA" type="number" value="20" class="mt-1 w-full">
          </label>
          <label class="text-xs">Cambios/mes (propuesto)
            <input id="cambiosP" type="number" value="12" class="mt-1 w-full">
          </label>
          <label class="text-xs">Min/cambio (actual)
            <input id="minCambioA" type="number" value="8" class="mt-1 w-full">
          </label>
          <label class="text-xs">Min/cambio (propuesto)
            <input id="minCambioP" type="number" value="6" class="mt-1 w-full">
          </label>
        </div>

        <div class="flex items-center justify-between gap-3">
          <div class="text-sm">Tiempo muerto mensual (min/mes)</div>
          <div class="relative w-[44px] h-[26px]">
            <input id="incTM" class="sw" type="checkbox" checked>
            <div class="switch"></div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">T. muerto actual (min/mes)
            <input id="tmuertoA" type="number" value="120" class="mt-1 w-full">
          </label>
          <label class="text-xs">T. muerto propuesto (min/mes)
            <input id="tmuertoP" type="number" value="30" class="mt-1 w-full">
          </label>
        </div>
      </div>
    </div>

    <!-- Vida module -->
    <div id="boxVida" class="mt-5 card p-4" style="background:rgba(183,201,31,0.08); border-color:rgba(183,201,31,0.32);">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Vida de herramienta</h3>
        <span class="text-xs" style="color:var(--rf-muted)">por ciclo útil</span>
      </div>

      <div class="grid gap-3 mt-3">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm">Incluir cálculo de vida</div>
          <div class="relative w-[44px] h-[26px]">
            <input id="incVida" class="sw" type="checkbox" checked>
            <div class="switch"></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Vida actual (pzas)
            <input id="vidaA" type="number" value="1300" class="mt-1 w-full">
          </label>
          <label class="text-xs">Vida propuesta (pzas)
            <input id="vidaP" type="number" value="2500" class="mt-1 w-full">
          </label>
        </div>

        <label class="text-xs" title="Costo por inserto/herramienta que se consume por vida.">Costo herramienta (USD)
          <input id="costoHerr" type="number" value="128.87" class="mt-1 w-full">
        </label>
      </div>
    </div>

    <!-- Proceso module -->
    <div id="boxProceso" class="mt-5 card p-4" style="background:rgba(88,213,211,0.09); border-color:rgba(88,213,211,0.30);">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Mejora de proceso</h3>
        <span class="text-xs" style="color:var(--rf-muted)">más velocidad por robustez</span>
      </div>

      <div class="grid gap-3 mt-3">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm">Aumentar output (pzas/mes)</div>
          <div class="relative w-[44px] h-[26px]">
            <input id="incOutput" class="sw" type="checkbox">
            <div class="switch"></div>
          </div>
        </div>
        <label class="text-xs" title="Si el proceso mejora y permite producir más, captura el incremento mensual (pzas).">Incremento de piezas/mes (Δ)
          <input id="deltaPmes" type="number" value="0" class="mt-1 w-full">
        </label>
        <label class="text-xs" title="Margen estimado por pieza (si quieres monetizar el output extra).">Margen por pieza (USD)
          <input id="margenPza" type="number" value="0" class="mt-1 w-full">
        </label>
      </div>
    </div>

    <div class="space-y-3 mt-5">
      <button id="btnCalcular" class="hidden md:block w-full px-4 py-2 rounded-md btn-primary">Calcular</button>
      <button id="btnPrint" class="w-full px-4 py-2 rounded-md btn-secondary">Generar Reporte (PDF)</button>
    </div>
  </section>

  <!-- RIGHT: report -->
  <div id="reportSection" class="lg:col-span-6 grid gap-4 sm:gap-6 lg:grid-cols-6">

    <section class="card p-5 lg:col-span-4">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-lg font-semibold">Comparativa</h2>
        <span class="text-xs" style="color:var(--rf-muted)">Actual vs Propuesta</span>
      </div>
      <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
        <table class="w-full border-separate [border-spacing:0_8px] text-sm">
          <thead>
            <tr style="color:var(--rf-muted)">
              <th class="text-left font-medium px-2">Métrica</th>
              <th class="text-right font-medium px-2">Actual</th>
              <th class="text-right font-medium px-2">Propuesta</th>
              <th class="text-right font-medium px-2">Δ</th>
            </tr>
          </thead>
          <tbody id="tbodyComp"></tbody>
        </table>
      </div>
    </section>

    <section class="card p-5 lg:col-span-2">
      <h2 class="text-lg font-semibold">Resultados</h2>
      <div class="mt-3 grid gap-3">
        <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(183,201,31,0.10), rgba(229,230,228,0.02)); border:1px solid rgba(183,201,31,0.20);">
          <div class="text-sm">Ahorro mensual (bruto)</div>
          <div id="ahorro" class="text-right font-bold text-xl" style="color:var(--good)">$0</div>
        </div>

        <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(88,213,211,0.09), rgba(229,230,228,0.02)); border:1px solid rgba(88,213,211,0.18);">
          <div class="text-sm">Ahorro por tiempo muerto (USD/mes)</div>
          <div id="ahorroTM" class="text-right font-bold text-lg" style="color:var(--cyan)">$0</div>
        </div>

        <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(40,85,108,0.10), rgba(229,230,228,0.02)); border:1px solid rgba(40,85,108,0.22);">
          <div class="text-sm">Neto mensual (ahorro - mensualidad)</div>
          <div id="netoMensual" class="text-right font-bold text-lg">$0</div>
        </div>

        <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(40,85,108,0.08), rgba(229,230,228,0.02)); border:1px solid rgba(40,85,108,0.18);">
          <div class="text-sm">ROI anual</div>
          <div id="roi" class="text-right font-bold text-lg" style="color:var(--rf-teal)">0%</div>
        </div>

        <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(170,200,45,0.10), rgba(229,230,228,0.02)); border:1px solid rgba(170,200,45,0.20);">
          <div class="text-sm">Payback (mes)</div>
          <div id="payback" class="text-right font-bold text-lg" style="color:var(--warn)">—</div>
        </div>
      </div>

      <div class="mt-4 text-xs" style="color:var(--rf-muted)">
        Nota: ROI usa <strong>neto</strong> (ahorro − mensualidad). Payback cuenta meses hasta recuperar el CAPEX.
      </div>
    </section>

    <!-- Visuals -->
    <section id="visuales" class="card p-5 lg:col-span-6">
      <h2 class="text-lg font-semibold">Visuales</h2>
      <div class="mt-3 grid grid-cols-1 gap-6 max-w-5xl mx-auto">
        <div class="rounded-lg p-3" style="border:1px solid var(--rf-line);">
          <p class="text-sm font-semibold">Distribución de ahorros</p>
          <div id="vizAhorros" class="mt-4 min-h-[320px]"></div>
        </div>
        <div class="rounded-lg p-3" style="border:1px solid var(--rf-line);">
          <p class="text-sm font-semibold">Comparativa rápida</p>
          <div id="vizPerf" class="mt-4"></div>
        </div>
        <div class="rounded-lg p-3" style="border:1px solid var(--rf-line);">
          <p class="text-sm font-semibold">Flujo mensual y payback</p>
          <div id="vizCash" class="mt-4 min-h-[320px]"></div>
        </div>
      </div>
    </section>

    <!-- Items / Holders selection (optional) -->
    <section id="itemsSection" class="card p-5 lg:col-span-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Items REGO-FIX (holders & accesorios)</h2>
          <p class="text-sm" style="color:var(--rf-muted)">Lista editable: define tu paquete y que se sume al CAPEX.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnAddItem" class="px-3 py-2 rounded-md btn-ghost text-sm">+ Agregar item</button>
          <button id="btnClearItems" class="px-3 py-2 rounded-md btn-ghost text-sm">Limpiar</button>
        </div>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="w-full text-sm">
          <thead>
            <tr style="color:var(--rf-muted)">
              <th class="text-left py-2">Incluir</th>
              <th class="text-left py-2">Item</th>
              <th class="text-left py-2">Categoría</th>
              <th class="text-right py-2">Qty</th>
              <th class="text-right py-2">Precio (USD)</th>
              <th class="text-right py-2">Subtotal</th>
              <th class="text-right py-2"></th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>

      <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="text-sm" style="color:var(--rf-muted)">
          Tip: si tu CAPEX viene “del paquete”, activa “Incluir” en los items y listo.
        </div>
        <div class="text-sm font-semibold">
          CAPEX (manual): <span class="font-mono" id="capexManual">$0.00</span> |
          Items incluidos: <span class="font-mono" id="capexItems">$0.00</span> |
          <span style="color:var(--rf-green)">CAPEX total:</span> <span class="font-mono" id="capexTotal">$0.00</span>
        </div>
      </div>
    </section>

  </div>
</main>

<div class="md:hidden fixed inset-x-0 bottom-0 z-40 safe-bottom px-4 py-2">
  <button id="btnCalcularMobile" class="w-full px-4 py-3 rounded-md btn-primary">Calcular</button>
</div>

<footer class="py-8 mt-10 text-center">
  <div class="max-w-6xl mx-auto px-4 text-sm" style="color:var(--rf-muted)">
    © 2026 REGO-FIX ROI Calculator — <span style="color:var(--rf-gray-3)">by alexrasa</span>
  </div>
</footer>

<script>
  // ===== Mobile menu =====
  const mOpen  = document.getElementById('mobileOpenBtn');
  const mClose = document.getElementById('mobileCloseBtn');
  const mPanel = document.getElementById('mobilePanel');
  const mBg    = document.getElementById('mobileBackdrop');
  const mLinks = document.querySelectorAll('.mobile-link');

  function toggleMenu(open){
    if(open){
      mBg?.classList.remove('pointer-events-none','opacity-0');
      mBg?.classList.add('pointer-events-auto','opacity-100');
      mPanel?.classList.remove('translate-x-full');
      mPanel?.classList.add('translate-x-0');
      document.body.style.overflow='hidden';
    }else{
      mBg?.classList.remove('pointer-events-auto','opacity-100');
      mBg?.classList.add('pointer-events-none','opacity-0');
      mPanel?.classList.remove('translate-x-0');
      mPanel?.classList.add('translate-x-full');
      document.body.style.overflow='';
    }
  }
  mOpen?.addEventListener('click',()=>toggleMenu(true));
  mClose?.addEventListener('click',()=>toggleMenu(false));
  mBg?.addEventListener('click',()=>toggleMenu(false));
  mLinks.forEach(l=>l.addEventListener('click',()=>toggleMenu(false)));
  window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') toggleMenu(false); });

  // ===== Utilities =====
  const $ = (id)=>document.getElementById(id);
  function num(id){ return +($(id)?.value ?? 0) || 0; }
  function fmt(n){
    return Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  }
  function safeDiv(a,b){ return b===0 ? 0 : a/b; }

  // ===== Items model =====
  const defaultItems = [
    {on:true,  name:'Holder principal', cat:'Holders', qty:1, price:1200},
    {on:true,  name:'Collets ER',       cat:'Collets', qty:6, price:35},
    {on:false, name:'Tuerca/Accesorio', cat:'Accesorios', qty:2, price:25},
  ];
  let items = JSON.parse(localStorage.getItem('rf_items') || 'null') || defaultItems;

  function itemRow(i, it){
    const cats = ['Holders','Collets','PowRgrip','Accesorios','Torque','Presetting','Otro'];
    const opts = cats.map(c=>`<option value="${c}" ${it.cat===c?'selected':''}>${c}</option>`).join('');
    const subtotal = (it.on ? (it.qty*it.price) : 0);
    return `
      <tr class="border-t" style="border-color:var(--rf-line)">
        <td class="py-2">
          <input type="checkbox" ${it.on?'checked':''} data-act="toggle" data-i="${i}">
        </td>
        <td class="py-2">
          <input type="text" value="${escapeHtml(it.name)}" class="w-full" data-act="name" data-i="${i}">
        </td>
        <td class="py-2">
          <select class="w-full" data-act="cat" data-i="${i}">${opts}</select>
        </td>
        <td class="py-2 text-right">
          <input type="number" min="0" step="1" value="${it.qty}" class="w-24 text-right" data-act="qty" data-i="${i}">
        </td>
        <td class="py-2 text-right">
          <input type="number" min="0" step="0.01" value="${it.price}" class="w-28 text-right" data-act="price" data-i="${i}">
        </td>
        <td class="py-2 text-right font-mono tabular-nums">$${fmt(subtotal)}</td>
        <td class="py-2 text-right">
          <button class="px-2 py-1 rounded btn-ghost text-xs" data-act="del" data-i="${i}">Eliminar</button>
        </td>
      </tr>
    `;
  }
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  }
  function saveItems(){
    localStorage.setItem('rf_items', JSON.stringify(items));
  }
  function capexItemsTotal(){
    return items.reduce((s,it)=> s + (it.on ? (Number(it.qty||0)*Number(it.price||0)) : 0), 0);
  }
  function renderItems(){
    const tbody = $('itemsTbody'); if(!tbody) return;
    tbody.innerHTML = items.map((it,i)=>itemRow(i,it)).join('');
    const manual = num('capex');
    const itemsTot = capexItemsTotal();
    $('capexManual').textContent = `$${fmt(manual)}`;
    $('capexItems').textContent  = `$${fmt(itemsTot)}`;
    $('capexTotal').textContent  = `$${fmt(manual + itemsTot)}`;
  }

  $('btnAddItem')?.addEventListener('click', ()=>{
    items.push({on:true,name:'Nuevo item',cat:'Otro',qty:1,price:0});
    saveItems(); renderItems(); calcular();
  });
  $('btnClearItems')?.addEventListener('click', ()=>{
    items = [];
    saveItems(); renderItems(); calcular();
  });
  $('itemsTbody')?.addEventListener('input', (e)=>{
    const t = e.target;
    const i = +t.getAttribute('data-i');
    const act = t.getAttribute('data-act');
    if(Number.isNaN(i) || !act) return;

    if(act==='toggle') items[i].on = t.checked;
    if(act==='name')   items[i].name = t.value;
    if(act==='cat')    items[i].cat = t.value;
    if(act==='qty')    items[i].qty = +t.value || 0;
    if(act==='price')  items[i].price = +t.value || 0;
    saveItems(); renderItems(); calcular();
  });
  $('itemsTbody')?.addEventListener('click', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;
    const act = t.getAttribute('data-act');
    if(act!=='del') return;
    const i = +t.getAttribute('data-i');
    items.splice(i,1);
    saveItems(); renderItems(); calcular();
  });

  // ===== Enable/disable module sections =====
  function setDisabled(sectionId, disabled){
    const box = $(sectionId); if(!box) return;
    box.style.opacity = disabled ? '0.45' : '1';
    box.querySelectorAll('input,select,textarea,button').forEach(el=>{
      if(el.id === 'btnPrint') return;
      if(el.classList.contains('sw')) return; // switches remain clickable
      el.disabled = disabled;
    });
  }
  function applyModules(){
    const t = $('modTiempo')?.checked ?? true;
    const v = $('modVida')?.checked ?? true;
    const p = $('modProceso')?.checked ?? true;
    setDisabled('boxTiempo', !t);
    setDisabled('boxVida', !v);
    setDisabled('boxProceso', !p);
  }

  ['modTiempo','modVida','modProceso'].forEach(id=> $(id)?.addEventListener('change', ()=>{ applyModules(); calcular(); }));

  // ===== Calculator =====
  function calcular(){
    // Modules
    const modTiempo  = $('modTiempo')?.checked ?? true;
    const modVida    = $('modVida')?.checked ?? true;
    const modProceso = $('modProceso')?.checked ?? true;

    // Common
    const costoHora  = num('costoHora');
    const pmesBase   = num('pmes');
    const capexManual= num('capex');
    const capexItems = capexItemsTotal();
    const capex      = capexManual + capexItems;
    const mensualidad= num('mensualidad');

    // Proceso module (optional output)
    const incOutput = $('incOutput')?.checked ?? false;
    const deltaPmes = num('deltaPmes');
    const margenPza = num('margenPza');
    const extraOutputUSD = (modProceso && incOutput) ? Math.max(0, deltaPmes) * Math.max(0, margenPza) : 0;

    // Tiempo module
    const incCiclo   = $('incCiclo')?.checked ?? true;
    const incCambios = $('incCambios')?.checked ?? true;
    const incTM      = $('incTM')?.checked ?? true;

    const cicloA = num('cicloA');
    const cicloP = num('cicloP');

    // ahorro por ciclo: horas actuales (pmes*cicloA/3600) * costoHora * %reducción
    const ahorroCiclo = (modTiempo && incCiclo && cicloA>0 && cicloP>0)
      ? Math.max(0, (1 - (cicloP/cicloA))) * costoHora * (pmesBase * cicloA / 3600)
      : 0;

    // Cambios/mes * min/cambio -> se convierte a horas * costoHora
    const cambiosA = num('cambiosA');
    const cambiosP = num('cambiosP');
    const minCambioA = num('minCambioA');
    const minCambioP = num('minCambioP');
    const ahorroCambios = (modTiempo && incCambios)
      ? Math.max(0, ((cambiosA*minCambioA) - (cambiosP*minCambioP))) / 60 * costoHora
      : 0;

    // Tiempo muerto (min/mes)
    const tmuertoA = num('tmuertoA');
    const tmuertoP = num('tmuertoP');
    const ahorroTM = (modTiempo && incTM)
      ? Math.max(0, (tmuertoA - tmuertoP)) / 60 * costoHora
      : 0;

    // Vida module
    const incVida = $('incVida')?.checked ?? true;
    const vidaA = num('vidaA');
    const vidaP = num('vidaP');
    const costoHerr = num('costoHerr');

    const consA = (vidaA>0) ? (pmesBase / vidaA) : 0;
    const consP = (vidaP>0) ? (pmesBase / vidaP) : 0;
    const costoHerrA = consA * costoHerr;
    const costoHerrP = consP * costoHerr;
    const ahorroVida = (modVida && incVida) ? Math.max(0, costoHerrA - costoHerrP) : 0;

    // Total
    const ahorroTotal = Math.max(0, ahorroCiclo + ahorroCambios + ahorroTM + ahorroVida + extraOutputUSD);
    const neto = ahorroTotal - mensualidad;

    // ROI + Payback
    const roiAnual = capex > 0 ? ((neto*12) / capex) * 100 : (neto>0 ? Infinity : 0);
    const paybackMes = (capex > 0 && neto > 0) ? Math.ceil(capex / neto) : -1;

    // Paint KPIs
    $('ahorro').textContent = `$${fmt(ahorroTotal)}`;
    $('ahorroTM').textContent = `$${fmt(ahorroTM)}`;

    const netoEl = $('netoMensual');
    if(netoEl){
      netoEl.textContent = `$${fmt(neto)}`;
      netoEl.style.color = neto >= 0 ? 'var(--good)' : 'var(--bad)';
    }
    $('roi').textContent = isFinite(roiAnual) ? `${fmt(roiAnual)}%` : '∞%';
    $('payback').textContent = paybackMes !== -1 ? `M${paybackMes}` : '—';

    // Table rows
    const pphA = cicloA>0 ? 3600/cicloA : 0;
    const pphP = cicloP>0 ? 3600/cicloP : 0;
    const costPerPieceA = vidaA>0 ? (costoHerr/vidaA) : 0;
    const costPerPieceP = vidaP>0 ? (costoHerr/vidaP) : 0;

    function delta(a,p,{higherIsBetter=true}={}){
      if(a===0 && p===0) return {val:0};
      const d = ((p-a) / (a===0 ? 1 : a)) * 100;
      return {val:d, higherIsBetter};
    }
    function badge(d){
      const thresholdPct = 3;
      const absVal = Math.abs(d.val||0);
      const isImprovement = d.higherIsBetter ? (d.val > 0) : (d.val < 0);
      let cls = 'badge-mid';
      if(absVal >= thresholdPct) cls = isImprovement ? 'badge-up' : 'badge-down';
      const displayed = isFinite(d.val) ? ((d.val>=0?'+':'') + fmt(d.val) + '%') : '—';
      return `<span class="stat-badge ${cls}">${displayed}</span>`;
    }
    function row(name,a,p,opt){
      const d = delta(a,p,opt||{});
      return `<tr style="background:transparent; border-bottom:1px solid rgba(229,230,228,0.06);">
        <td class="px-2 py-2">${name}</td>
        <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(a)?fmt(a):'—'}</td>
        <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(p)?fmt(p):'—'}</td>
        <td class="px-2 py-2 text-right">${badge(d)}</td>
      </tr>`;
    }

    const rows = [
      modTiempo && incCiclo   ? row('Tiempo de ciclo (s)', cicloA, cicloP, {higherIsBetter:false}) : '',
      modTiempo && incCiclo   ? row('Piezas por hora', pphA, pphP, {higherIsBetter:true}) : '',
      modVida   && incVida    ? row('Vida útil (pzas)', vidaA, vidaP, {higherIsBetter:true}) : '',
      modVida   && incVida    ? row('Costo herramienta/pza (USD)', costPerPieceA, costPerPieceP, {higherIsBetter:false}) : '',
      modTiempo && incCambios ? row('Cambios/mes', cambiosA, cambiosP, {higherIsBetter:false}) : '',
      modTiempo && incTM      ? row('Tiempo muerto (min/mes)', tmuertoA, tmuertoP, {higherIsBetter:false}) : '',
      row('CAPEX total (USD) [manual + items]', 0, capex, {higherIsBetter:true}),
      row('Ahorro mensual total (USD)', 0, ahorroTotal, {higherIsBetter:true}),
    ].filter(Boolean).join('');

    $('tbodyComp').innerHTML = rows;

    // Visuals data
    const parts=[], labels=[];
    if(ahorroCiclo>0)   { parts.push(ahorroCiclo);   labels.push('Ciclo'); }
    if(ahorroCambios>0) { parts.push(ahorroCambios); labels.push('Cambios'); }
    if(ahorroTM>0)      { parts.push(ahorroTM);      labels.push('T. muerto'); }
    if(ahorroVida>0)    { parts.push(ahorroVida);    labels.push('Vida'); }
    if(extraOutputUSD>0){ parts.push(extraOutputUSD);labels.push('Output'); }

    renderDonut('vizAhorros', parts, labels);
    renderBars('vizPerf', [
      ['T. Ciclo (s)', cicloA, cicloP, true],
      ['Pzas/h', pphA, pphP, false],
      ['Vida Útil (pzas)', vidaA, vidaP, false],
      ['T. Muerto (min/mes)', tmuertoA, tmuertoP, true]
    ].filter(x => {
      // hide irrelevant rows
      if(x[0].includes('Ciclo') && !(modTiempo && incCiclo)) return false;
      if(x[0].includes('Vida') && !(modVida && incVida)) return false;
      if(x[0].includes('Muerto') && !(modTiempo && incTM)) return false;
      return true;
    }));
    renderCashflow('vizCash', { ahorroMes: ahorroTotal, cuota: mensualidad, capex });
  }

  // ===== Visuals =====
  function renderCashflow(targetId, {ahorroMes, cuota, capex}){
    const el=$(targetId); if(!el) return;
    const meses=Array.from({length:12},(_,i)=>`M${i+1}`);
    const W = 820, H = 400;
    const pad = { top: 40, right: 10, bottom: 50, left: 60 };
    const barW = 18, barGap = 6, gap = 38;
    const H_drawable = H - pad.top - pad.bottom;

    const neto = (ahorroMes||0) - (cuota||0);
    let acc = -capex;
    const accArr = meses.map(()=>{ acc += neto; return acc; });

    const allValues = [ahorroMes||0, cuota||0, ...accArr, -capex];
    const dataMax = Math.max(1, ...allValues.map(v => Math.max(0, v)));
    const dataMin = Math.min(0, ...allValues.map(v => Math.min(0, v)));
    const totalRange = dataMax - dataMin;

    const scaleY = (v)=>{
      if(totalRange===0) return H - pad.bottom;
      return (H - pad.bottom) - (((v - dataMin) / totalRange) * H_drawable);
    };
    const yZero = scaleY(0);

    let x = pad.left + gap/2;
    const bars = meses.map((m,i)=>{
      const yA = scaleY(ahorroMes); const hA = yZero - yA;
      const yP = scaleY(cuota);     const hP = yZero - yP;
      const xa = x, xp = x + barW + barGap;
      const labelY = H - pad.bottom + 20;

      const rects = `
        <rect x="${xa}" y="${yA}" width="${barW}" height="${hA}" fill="${cssVar('--rf-green')}"></rect>
        <rect x="${xp}" y="${yP}" width="${barW}" height="${hP}" fill="${cssVar('--rf-red')}"></rect>
      `;
      const txt = `<text x="${x + barW + barGap/2}" y="${labelY}" font-size="14" fill="var(--rf-text)" text-anchor="middle">${m}</text>`;
      x += (barW * 2 + barGap + gap);
      return rects + txt;
    }).join('');

    const linePts = accArr.map((v,i)=>{
      const xi = pad.left + gap/2 + i*(barW*2+barGap+gap) + (barW + barGap/2);
      const yi = scaleY(v);
      return `${xi},${yi}`;
    }).join(' ');
    const x0 = pad.left + gap/2 - (barW*2+barGap+gap) + (barW + barGap/2);
    const y0 = scaleY(-capex);

    const polyline = `<polyline points="${x0},${y0} ${linePts}" fill="none" stroke="${cssVar('--rf-teal')}" stroke-width="3"></polyline>`;

    let marker='';
    if(capex > 0){
      const idx = accArr.findIndex(v => v >= 0);
      if(idx !== -1){
        const xi = pad.left + gap/2 + idx*(barW*2+barGap+gap) + (barW + barGap/2);
        const yi = scaleY(accArr[idx]);
        marker = `
          <circle cx="${xi}" cy="${yi}" r="6" fill="${cssVar('--rf-teal')}" stroke="var(--rf-black)" stroke-width="2"></circle>
          <text x="${xi + 10}" y="${yi - 10}" font-size="14" fill="${cssVar('--rf-teal')}">Payback M${idx+1}</text>
        `;
      }
    }

    const legendX = W - pad.right - 170, legendY = pad.top;
    const legend = `
      <rect x="${legendX}" y="${legendY - 12}" width="160" height="82" rx="10" fill="rgba(229,230,228,0.04)" stroke="rgba(229,230,228,0.12)"></rect>
      <rect x="${legendX+12}" y="${legendY}" width="12" height="12" fill="${cssVar('--rf-green')}"></rect>
      <text x="${legendX+30}" y="${legendY+10}" font-size="14" fill="var(--rf-text)">Ahorro</text>
      <rect x="${legendX+12}" y="${legendY+26}" width="12" height="12" fill="${cssVar('--rf-red')}"></rect>
      <text x="${legendX+30}" y="${legendY+36}" font-size="14" fill="var(--rf-text)">Cuota</text>
      <line x1="${legendX+12}" y1="${legendY+60}" x2="${legendX+24}" y2="${legendY+60}" stroke="${cssVar('--rf-teal')}" stroke-width="2.5"></line>
      <text x="${legendX+30}" y="${legendY+62}" font-size="14" fill="var(--rf-text)">Acumulado</text>
    `;

    const axis = `
      <line x1="${pad.left}" y1="${pad.top - 10}" x2="${pad.left}" y2="${H - pad.bottom}" stroke="rgba(229,230,228,.22)"></line>
      <line x1="${pad.left}" y1="${yZero}" x2="${W - pad.right}" y2="${yZero}" stroke="rgba(229,230,228,.22)"></line>
      <text x="${pad.left - 10}" y="${yZero + 5}" font-size="14" text-anchor="end" fill="rgba(229,230,228,.75)">$0</text>
      <text x="${pad.left - 10}" y="${scaleY(dataMax) + 5}" font-size="14" text-anchor="end" fill="rgba(229,230,228,.75)">$${fmt(dataMax)}</text>
      ${dataMin < 0 ? `<text x="${pad.left - 10}" y="${scaleY(dataMin) + 5}" font-size="14" text-anchor="end" fill="rgba(229,230,228,.75)">$${fmt(dataMin)}</text>` : ''}
    `;

    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${axis}${bars}${polyline}${marker}${legend}</svg>`;
  }

  function renderDonut(targetId, parts, labels){
    const el=$(targetId); if(!el) return;
    const data=parts.map((p,i)=>[labels[i],p]).filter(x=>x[1]>0);
    const total=data.reduce((s,p)=>s+p[1],0);

    const W=640, H=400;
    const cx=220, cy=H/2, r=H*0.40, th=52;
    let start=0;
    const colors=[cssVar('--rf-blue'), cssVar('--rf-green'), cssVar('--rf-teal'), cssVar('--rf-green-2'), cssVar('--rf-red')];

    const legendX=400;
    const legendFontSize=18, legendLineHeight=30;
    const legendBlockHeight=data.length*legendLineHeight;
    const legendStartY=(H-legendBlockHeight)/2 + (legendFontSize/2);

    const segs=data.map((p,i)=>{
      const f= total ? (p[1]/total) : 0;
      const a0=start*2*Math.PI, a1=(start+f)*2*Math.PI;
      start+=f;
      const L=(a1-a0)>Math.PI?1:0;
      const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0);
      const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
      const x0i=cx+(r-th)*Math.cos(a0), y0i=cy+(r-th)*Math.sin(a0);
      const x1i=cx+(r-th)*Math.cos(a1), y1i=cy+(r-th)*Math.sin(a1);
      const d=`M ${x0} ${y0} A ${r} ${r} 0 ${L} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${L} 0 ${x0i} ${y0i} Z`;
      const pct=Math.round(f*100);
      const ly=legendStartY + (i*legendLineHeight);
      return `<path d="${d}" fill="${colors[i%colors.length]}" opacity="0.95"></path>
              <text x="${legendX}" y="${ly}" font-size="${legendFontSize}" fill="var(--rf-text)">${p[0]}: ${pct}%</text>`;
    }).join('');

    const centerText = total>0 ? ('$'+fmt(total)) : '—';
    const centerFontSize = Math.max(20, Math.round(r*0.2));
    const center = `
      <circle cx="${cx}" cy="${cy}" r="${r-th+1}" fill="rgba(229,230,228,0.06)"></circle>
      <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" font-size="${centerFontSize}" fill="var(--rf-text)">${centerText}</text>
    `;

    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${segs}${center}</svg>`;
  }

  function renderBars(targetId, pairs){
    const rowsData = pairs.map(([lbl,a,b,lowerIsBetter]) => ({
      lines: String(lbl).replace(' (','\n(').split('\n'),
      a: isFinite(a)?a:0,
      b: isFinite(b)?b:0,
      lowerIsBetter
    }));

    const approxChar = 7;
    const labelCol = Math.max(160, Math.min(260, Math.max(...rowsData.map(r => Math.max(...r.lines.map(s => s.length))*approxChar))));
    const barStartX = labelCol + 16;
    const barMax = 520;
    const rowH = 40, rowGap = 16, padY = 20;
    const W = barStartX + barMax + 160;
    const H = padY + rowsData.length * (rowH + rowGap) + 40;

    let y = padY;
    const rows = rowsData.map(r=>{
      const maxVal = Math.max(Math.abs(r.a), Math.abs(r.b), 1);
      const aw = Math.round((Math.abs(r.a)/maxVal)*barMax);
      const bw = Math.round((Math.abs(r.b)/maxVal)*barMax);

      const goodB = r.lowerIsBetter ? (r.b < r.a) : (r.b > r.a);
      const colorP = goodB ? cssVar('--rf-green') : cssVar('--rf-red');

      const label = `<text x="0" y="${y + 14}" font-size="14" fill="var(--rf-text)">
        ${r.lines[0]}
        ${r.lines.length>1 ? `<tspan x="0" dy="1.2em">${r.lines.slice(1).join(' ')}</tspan>` : ''}
      </text>`;

      const bars = `
        <rect x="${barStartX}" y="${y}" width="${aw}" height="12" fill="rgba(229,230,228,0.35)"></rect>
        <rect x="${barStartX}" y="${y+16}" width="${bw}" height="12" fill="${colorP}"></rect>
        <text x="${barStartX + aw + 10}" y="${y + 10}" font-size="12" fill="var(--rf-text)">${r.a.toFixed(1)}</text>
        <text x="${barStartX + bw + 10}" y="${y + 26}" font-size="12" fill="var(--rf-text)">${r.b.toFixed(1)}</text>
      `;
      y += rowH + rowGap;
      return label + bars;
    }).join('');

    const legendY = H - 20;
    const legendX = barStartX;
    const legend = `
      <rect x="${legendX}" y="${legendY - 14}" width="210" height="28" rx="8" fill="rgba(229,230,228,0.04)" stroke="rgba(229,230,228,0.12)"></rect>
      <rect x="${legendX+10}" y="${legendY - 6}" width="12" height="12" fill="rgba(229,230,228,0.35)"></rect>
      <text x="${legendX+28}" y="${legendY + 4}" font-size="12" fill="var(--rf-text)">Actual</text>
      <rect x="${legendX+96}" y="${legendY - 6}" width="12" height="12" fill="${cssVar('--rf-green')}"></rect>
      <text x="${legendX+114}" y="${legendY + 4}" font-size="12" fill="var(--rf-text)">Propuesta</text>
    `;

    const el=$(targetId); if(el) el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${rows}${legend}</svg>`;
  }

  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#ffffff';
  }

  // ===== Wiring =====
  $('btnCalcular')?.addEventListener('click', calcular);
  $('btnCalcularMobile')?.addEventListener('click', calcular);
  $('btnPrint')?.addEventListener('click', ()=>window.print());

  // Auto-calc on desktop typing
  [
    'costoHora','pmes','capex','mensualidad',
    'cicloA','cicloP','tmuertoA','tmuertoP',
    'cambiosA','cambiosP','minCambioA','minCambioP',
    'vidaA','vidaP','costoHerr',
    'deltaPmes','margenPza'
  ].forEach(id => $(id)?.addEventListener('input', ()=>{ renderItems(); if(window.innerWidth>=768) calcular(); }));

  // Switches
  [
    'incCiclo','incCambios','incTM','incVida','incOutput'
  ].forEach(id => $(id)?.addEventListener('change', ()=>{ renderItems(); calcular(); }));

  // init
  renderItems();
  applyModules();
  calcular();
</script>

</body>
</html>
