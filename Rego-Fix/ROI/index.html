<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora ROI — Toolholding (REGO-FIX style) | AlexRaSa</title>
  <meta name="description" content="Calcula ahorro por ciclo, vida de herramienta, scrap y tiempos muertos. ROI, payback y CAPEX por items (holders, collets, tuercas y unidades tipo powRgrip)." />
  <meta name="theme-color" content="#CAD42E" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://alexrasa.store/calculadora-costo-beneficio/" />
  <link rel="alternate" hreflang="es-MX" href="https://alexrasa.store/calculadora-costo-beneficio/" />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="preload" as="image" href="/assets/hero-industrial.png" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff;
      --surface:#f6f7f8;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5b6472;
      --border:rgba(15,23,42,0.10);

      /* “REGO-FIX-ish”: negro + verde lima del flyer */
      --rego-green:#cad42e;
      --rego-green-2:#b9c81f;
      --rego-dark:#111827;
      --rego-gray:#1f2937;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --accent:var(--rego-green);
    }

    html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    a{color:var(--rego-dark);}
    .topbar{
      background:rgba(255,255,255,0.92);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.06);
    }
    .soft{
      background:linear-gradient(180deg, rgba(202,212,46,0.18), rgba(255,255,255,0));
      border:1px solid rgba(202,212,46,0.25);
    }
    input,select,textarea{
      background:#fff;
      color:var(--text);
      border:1px solid rgba(15,23,42,0.14);
      padding:.55rem .65rem;
      border-radius:.65rem;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      box-shadow:0 0 0 6px rgba(202,212,46,0.22);
      border-color: rgba(202,212,46,0.55);
    }
    select option { color:#000; background:#fff; }

    label[title]{
      cursor:help;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-decoration-color: rgba(2,6,23,0.35);
    }

    .btn-primary{
      background: linear-gradient(180deg, var(--rego-green), var(--rego-green-2));
      color:#111827;
      font-weight:800;
      border:1px solid rgba(17,24,39,0.12);
      box-shadow: 0 12px 28px rgba(202,212,46,0.22);
    }
    .btn-primary:hover{ filter: brightness(0.98); transform: translateY(-1px); }
    .btn-secondary{
      background:#111827;
      color:#fff;
      font-weight:800;
      border:1px solid rgba(17,24,39,0.12);
    }
    .btn-secondary:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    .stat-badge{
      display:inline-block;
      padding:.28rem .66rem;
      border-radius:999px;
      font-weight:800;
      font-size:11px;
      min-width: 68px;
      text-align:center;
      line-height:1;
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(246,247,248,1);
      color: var(--rego-dark);
    }
    .badge-up{ background: rgba(22,163,74,0.12); border-color: rgba(22,163,74,0.25); color:#14532d;}
    .badge-mid{ background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25); color:#7c2d12;}
    .badge-down{ background: rgba(220,38,38,0.12); border-color: rgba(220,38,38,0.25); color:#7f1d1d;}

    /* Hero (limpio, tipo corporativo) */
    .hero{
      position:relative;
      background: radial-gradient(1200px 520px at 20% 0%, rgba(202,212,46,0.25), rgba(255,255,255,0)),
                  linear-gradient(180deg, rgba(15,23,42,0.05), rgba(255,255,255,0));
      border-bottom:1px solid var(--border);
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:0;
      background-image: url('/assets/hero-industrial.png');
      background-size: cover;
      background-position: center;
      opacity: 0.06;
      pointer-events:none;
      mix-blend-mode: multiply;
    }
    .hero > *{ position:relative; z-index:1; }

    /* SVG text styling */
    #vizAhorros svg text, #vizPerf svg text, #vizCash svg text { fill: var(--rego-dark) !important; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

    /* PRINT: 1 página, blanco */
    @media print{
      @page{ size: Letter; margin: 0.45in; }
      html,body{ background:#fff !important; color:#000 !important; font-size: 8.6pt !important; }
      header, footer, .hero, #mobileBar { display:none !important; }
      main{ padding:0 !important; margin:0 !important; max-width:100% !important; }
      .card{ box-shadow:none !important; border:1px solid #d1d5db !important; }
      #reportSection{
        display:grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 0.5rem !important;
      }
      #reportSection > .col-table{ grid-column: span 1 !important; }
      #reportSection > .col-kpi{ grid-column: span 1 !important; }
      #reportSection > .col-viz{ grid-column: span 1 !important; }
      .viz, .min-h-\[320px\]{ min-height: 150px !important; }
      #vizPerf svg{ height: 200px !important; }
      h1,h2,h3,p,span,div,text,svg,path{ color:#000 !important; fill:#000 !important; stroke:#000 !important; }
      .btn-primary,.btn-secondary{ display:none !important; }
      .stat-badge.badge-up{ background:#16a34a !important; color:#fff !important; -webkit-print-color-adjust: exact; }
      .stat-badge.badge-mid{ background:#f59e0b !important; color:#111 !important; -webkit-print-color-adjust: exact; }
      .stat-badge.badge-down{ background:#dc2626 !important; color:#fff !important; -webkit-print-color-adjust: exact; }
    }
  </style>
</head>

<body class="antialiased">
  <!-- Header -->
  <header id="siteHeader" class="sticky top-0 z-50 topbar">
    <div class="max-w-6xl mx-auto px-4">
      <div class="h-16 flex items-center justify-between gap-3">
        <a href="/" class="flex items-center gap-3 shrink-0" aria-label="Ir al inicio">
          <img src="/assets/logo.png" alt="Logo AlexRaSa" class="h-9 w-auto" width="150" height="36" />
          <span class="hidden sm:inline text-base font-bold tracking-tight text-slate-900">
            AlexRaSa<span style="color:var(--rego-green-2)">.store</span>
          </span>
        </a>

        <nav class="hidden lg:flex items-center gap-6 text-sm font-semibold text-slate-700">
          <a href="/" class="hover:text-slate-900">Inicio</a>
          <a href="/SolidCAM/" class="hover:text-slate-900">Soluciones</a>
          <a href="/#servicios" class="hover:text-slate-900">Servicios</a>
          <a href="/#recursos" class="hover:text-slate-900">Recursos</a>
          <a href="/#contacto" class="hover:text-slate-900">Contacto</a>
        </nav>

        <button id="mobileOpenBtn" class="lg:hidden p-2 rounded-md border" style="border-color:var(--border)" aria-label="Abrir menú">
          <svg class="h-6 w-6 text-slate-900" viewBox="0 0 24 24" stroke="currentColor" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile menu -->
  <div id="mobileBackdrop" class="fixed inset-0 lg:hidden bg-slate-900/50 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" style="z-index:9998;"></div>
  <aside id="mobilePanel" class="fixed inset-0 lg:hidden translate-x-full transition-transform duration-300 ease-out" role="dialog" aria-modal="true" aria-labelledby="mobileMenuTitle" style="z-index:9999;">
    <div class="absolute inset-0 flex flex-col bg-white text-slate-900">
      <div class="h-16 flex items-center justify-between px-4 border-b" style="border-color:var(--border)">
        <span id="mobileMenuTitle" class="text-base font-extrabold">Menú</span>
        <button id="mobileCloseBtn" class="p-2 rounded-md border" style="border-color:var(--border)" aria-label="Cerrar menú">
          <svg class="h-6 w-6" viewBox="0 0 24 24" stroke="currentColor" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto">
        <nav class="p-4">
          <ul class="space-y-1 text-[17px] font-semibold">
            <li><a href="/" class="mobile-link block px-3 py-3 rounded-lg hover:bg-slate-100">Inicio</a></li>
            <li><a href="/SolidCAM/" class="mobile-link block px-3 py-3 rounded-lg hover:bg-slate-100">Soluciones</a></li>
            <li><a href="/#servicios" class="mobile-link block px-3 py-3 rounded-lg hover:bg-slate-100">Servicios</a></li>
            <li><a href="/#recursos" class="mobile-link block px-3 py-3 rounded-lg hover:bg-slate-100">Recursos</a></li>
            <li><a href="/#contacto" class="mobile-link block px-3 py-3 rounded-lg hover:bg-slate-100">Contacto</a></li>
          </ul>

          <div class="mt-6 grid grid-cols-2 gap-2 px-1">
            <a href="/#soporte" class="px-3 py-2 text-center rounded-md border hover:bg-slate-50" style="border-color:var(--border)">Soporte</a>
            <a href="/#agenda" class="px-3 py-2 text-center rounded-md btn-primary">Agendar</a>
          </div>
        </nav>
      </div>
    </div>
  </aside>

  <!-- Hero -->
  <section class="hero">
    <div class="max-w-6xl mx-auto px-4 py-10 md:py-16">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
        <div class="max-w-3xl">
          <p class="text-xs font-extrabold tracking-widest uppercase text-slate-600">ROI de Toolholding</p>
          <h1 class="mt-2 text-3xl md:text-5xl font-black text-slate-900">
            Calculadora de <span style="color:var(--rego-green-2)">Retorno de Inversión</span>
          </h1>
          <p class="mt-3 text-slate-700">
            Enfocada en <strong>portaherramientas, collets/pinzas y accesorios</strong>.
            Estima ahorro por <strong>ciclo</strong>, <strong>vida de herramienta</strong>, <strong>scrap</strong> y <strong>tiempos muertos</strong>,
            con <strong>CAPEX por items</strong>, <strong>ROI</strong> y <strong>payback</strong>.
          </p>
        </div>

        <div class="card soft p-4 w-full lg:w-[420px]">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs font-extrabold text-slate-700">Estilo REGO-FIX (paleta)</p>
              <p class="text-sm text-slate-700">Negro + verde lima corporativo</p>
            </div>
            <!-- Placeholder: sube tu logo -->
            <img src="/assets/rego-fix-logo.svg" alt="Logo REGO-FIX (placeholder)" class="h-8 w-auto" onerror="this.style.display='none'" />
          </div>
          <div class="mt-3 text-xs text-slate-600 leading-relaxed">
            powRgrip se compone de <strong>collet/pinza</strong>, <strong>toolholder</strong> y <strong>unidad de sujeción</strong>. :contentReference[oaicite:3]{index=3}
          </div>
        </div>
      </div>
    </div>
  </section>

  <main id="calc" class="max-w-6xl mx-auto px-4 pt-8 pb-24 grid gap-4 sm:gap-6 lg:grid-cols-8">

    <!-- Inputs -->
    <section class="card p-5 lg:col-span-3">
      <div class="flex items-start justify-between gap-3">
        <h2 class="text-lg font-black text-slate-900">Parámetros (Baseline vs Propuesta)</h2>
        <span class="text-xs font-bold px-2 py-1 rounded-full" style="background:rgba(202,212,46,0.22); border:1px solid rgba(202,212,46,0.40);">
          Toolholding ROI
        </span>
      </div>

      <div class="grid gap-3 mt-4">
        <!-- Sistemas -->
        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Sistema de sujeción actual (referencia).">
            Sistema actual
            <select id="sysActual" class="mt-1 w-full">
              <option value="shrink">Shrink-fit</option>
              <option value="hydraulic">Hidráulico</option>
              <option value="er">ER (collet)</option>
              <option value="side-lock">Weldon / Side-lock</option>
              <option value="otro">Otro</option>
            </select>
          </label>

          <label class="text-sm font-semibold text-slate-800" title="Sistema propuesto. Para powRgrip, el CAPEX típicamente incluye unidad + holders + collets.">
            Sistema propuesto
            <select id="sysPropuesta" class="mt-1 w-full">
              <option value="powrgrip">powRgrip (REGO-FIX)</option>
              <option value="er">ER (REGO-FIX)</option>
              <option value="otro">Otro</option>
            </select>
          </label>
        </div>

        <!-- Proceso -->
        <div class="grid grid-cols-2 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Tiempo de ciclo actual por pieza (segundos).">
            Ciclo actual (s)
            <input id="cicloA" type="number" value="60" class="mt-1 w-full">
          </label>
          <label class="text-sm font-semibold text-slate-800" title="Tiempo de ciclo propuesto por pieza (segundos).">
            Ciclo propuesto (s)
            <input id="cicloP" type="number" value="45" class="mt-1 w-full">
          </label>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Piezas que dura la herramienta actual (pzas).">
            Vida herramienta actual (pzas)
            <input id="vidaA" type="number" value="1300" class="mt-1 w-full">
          </label>
          <label class="text-sm font-semibold text-slate-800" title="Piezas objetivo con la propuesta (pzas).">
            Vida herramienta propuesta (pzas)
            <input id="vidaP" type="number" value="2500" class="mt-1 w-full">
          </label>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Costo de la herramienta/inserto (USD).">
            Costo herramienta (USD)
            <input id="costoHerr" type="number" value="128.87" class="mt-1 w-full">
          </label>
          <label class="text-sm font-semibold text-slate-800" title="Costo total por hora de máquina (USD/hr).">
            Costo máquina/hr (USD)
            <input id="costoHora" type="number" value="50" class="mt-1 w-full">
          </label>
        </div>

        <label class="text-sm font-semibold text-slate-800" title="Volumen mensual de producción del proceso.">
          Piezas por mes
          <input id="pmes" type="number" value="10000" class="mt-1 w-full">
        </label>

        <!-- Tiempos muertos -->
        <div class="grid grid-cols-2 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Minutos de paro por mes (cambios, ajustes, retrabajo).">
            T. muerto actual (min/mes)
            <input id="tmuertoA" type="number" value="120" class="mt-1 w-full">
          </label>
          <label class="text-sm font-semibold text-slate-800" title="Minutos de paro objetivo por mes.">
            T. muerto propuesto (min/mes)
            <input id="tmuertoP" type="number" value="30" class="mt-1 w-full">
          </label>
        </div>

        <!-- Scrap -->
        <div class="grid grid-cols-3 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Tasa de scrap actual (% sobre producción mensual).">
            Scrap actual (%)
            <input id="scrapA" type="number" value="1.2" step="0.1" class="mt-1 w-full">
          </label>
          <label class="text-sm font-semibold text-slate-800" title="Tasa de scrap propuesta (%).">
            Scrap propuesto (%)
            <input id="scrapP" type="number" value="0.4" step="0.1" class="mt-1 w-full">
          </label>
          <label class="text-sm font-semibold text-slate-800" title="Costo promedio por pieza scrappeada (material + retrabajo + logística + oportunidad).">
            Costo scrap/pza (USD)
            <input id="costoScrap" type="number" value="12" step="0.1" class="mt-1 w-full">
          </label>
        </div>

        <!-- OPEX / CAPEX -->
        <div class="grid grid-cols-2 gap-2">
          <label class="text-sm font-semibold text-slate-800" title="Costo recurrente mensual (mantenimiento, servicio, etc.).">
            OPEX mensual (USD)
            <input id="mensualidad" type="number" value="0" class="mt-1 w-full">
          </label>

          <label class="text-sm font-semibold text-slate-800" title="CAPEX total. Por defecto se calcula desde la tabla de items; puedes sobrescribirlo.">
            CAPEX (USD)
            <input id="inversion" type="number" value="0" class="mt-1 w-full">
          </label>
        </div>

        <div class="flex items-center justify-between gap-3 mt-2">
          <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-800" title="Si está activo, el CAPEX se recalcula desde la tabla de items REGO-FIX.">
            <input id="useItemsCapex" type="checkbox" checked class="h-4 w-4">
            <span>Calcular CAPEX desde items</span>
          </label>

          <button id="btnResetItems" class="text-xs font-bold px-3 py-2 rounded-md border hover:bg-slate-50" style="border-color:var(--border)">
            Preset por sistema
          </button>
        </div>

        <!-- Inclusiones -->
        <div class="mt-3 p-3 rounded-xl" style="background:var(--surface); border:1px solid var(--border);">
          <h3 class="text-sm font-black text-slate-900">Tipos de ahorro a incluir</h3>
          <div class="grid grid-cols-2 gap-2 text-sm mt-2">
            <label class="inline-flex items-center gap-2 font-semibold"><input id="incCiclo" type="checkbox" checked class="h-4 w-4"><span>Ciclo</span></label>
            <label class="inline-flex items-center gap-2 font-semibold"><input id="incHerr" type="checkbox" checked class="h-4 w-4"><span>Herramienta</span></label>
            <label class="inline-flex items-center gap-2 font-semibold"><input id="incTM" type="checkbox" checked class="h-4 w-4"><span>Tiempo muerto</span></label>
            <label class="inline-flex items-center gap-2 font-semibold"><input id="incScrap" type="checkbox" checked class="h-4 w-4"><span>Scrap</span></label>
          </div>
        </div>

        <!-- Acciones -->
        <div class="grid grid-cols-2 gap-2 mt-3">
          <button id="btnCalcular" class="w-full px-4 py-2 rounded-md btn-primary">Calcular</button>
          <button id="btnPrint" class="w-full px-4 py-2 rounded-md btn-secondary">Reporte (PDF)</button>
        </div>

        <!-- Nota producto -->
        <div class="mt-3 text-xs text-slate-600 leading-relaxed">
          Tip: si estás modelando powRgrip, el set típico contempla <strong>unidad + holders + collets</strong> (y en algunos casos inserts).
          El flyer resalta “sin calor, sin vapores” y tiempos de cambio rápidos (p.ej. “tool ready en 8s” en PGU). :contentReference[oaicite:4]{index=4}
        </div>
      </div>
    </section>

    <!-- Report -->
    <div id="reportSection" class="lg:col-span-5 grid gap-4 sm:gap-6 lg:grid-cols-6">

      <!-- Items / CAPEX -->
      <section class="card p-5 lg:col-span-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-black text-slate-900">Items (CAPEX REGO-FIX)</h2>
            <p class="text-sm text-slate-600 mt-1">Define cantidades y costos unitarios. El CAPEX se calcula automáticamente si está activado.</p>
          </div>
          <div class="text-right">
            <div class="text-xs font-bold text-slate-600">CAPEX calculado</div>
            <div id="capexCalc" class="text-xl font-black text-slate-900">$0.00</div>
          </div>
        </div>

        <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
          <table class="w-full text-sm border-separate [border-spacing:0_10px]">
            <thead>
              <tr class="text-slate-600">
                <th class="text-left font-bold px-2">Item</th>
                <th class="text-center font-bold px-2">Incluir</th>
                <th class="text-right font-bold px-2">Qty</th>
                <th class="text-right font-bold px-2">Unit (USD)</th>
                <th class="text-right font-bold px-2">Subtotal</th>
              </tr>
            </thead>
            <tbody id="tbodyItems"></tbody>
          </table>
        </div>

        <div class="mt-2 text-xs text-slate-600">
          powRgrip se compone de: <strong>collet</strong> + <strong>toolholder</strong> + <strong>clamping unit</strong>. :contentReference[oaicite:5]{index=5}
        </div>
      </section>

      <!-- Comparativa -->
      <section class="card p-5 lg:col-span-4 col-table">
        <h2 class="text-lg font-black text-slate-900">Comparativa (Actual vs Propuesta)</h2>
        <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
          <table class="w-full border-separate [border-spacing:0_8px] text-sm">
            <thead>
              <tr class="text-slate-600">
                <th class="text-left font-bold px-2">Métrica</th>
                <th class="text-right font-bold px-2">Actual</th>
                <th class="text-right font-bold px-2">Propuesta</th>
                <th class="text-right font-bold px-2">Δ</th>
              </tr>
            </thead>
            <tbody id="tbodyComp"></tbody>
          </table>
        </div>
      </section>

      <!-- KPIs -->
      <section class="card p-5 lg:col-span-2 col-kpi">
        <h2 class="text-lg font-black text-slate-900">Resultados</h2>

        <div class="mt-3 grid gap-3">
          <div class="rounded-xl p-3 soft">
            <div class="text-sm font-bold text-slate-700">Ahorro mensual total</div>
            <div id="ahorro" class="text-right font-black text-2xl text-slate-900">$0.00</div>
          </div>

          <div class="rounded-xl p-3" style="background:rgba(15,23,42,0.03); border:1px solid var(--border);">
            <div class="text-sm font-bold text-slate-700">Neto mensual (ahorro − OPEX)</div>
            <div id="netoMensual" class="text-right font-black text-xl">$0.00</div>
          </div>

          <div class="rounded-xl p-3" style="background:rgba(202,212,46,0.14); border:1px solid rgba(202,212,46,0.28);">
            <div class="text-sm font-bold text-slate-700">ROI anual</div>
            <div id="roi" class="text-right font-black text-xl">0%</div>
          </div>

          <div class="rounded-xl p-3" style="background:rgba(15,23,42,0.03); border:1px solid var(--border);">
            <div class="text-sm font-bold text-slate-700">Payback (mes)</div>
            <div id="payback" class="text-right font-black text-xl">—</div>
          </div>

          <div class="rounded-xl p-3" style="background:rgba(15,23,42,0.03); border:1px solid var(--border);">
            <div class="text-sm font-bold text-slate-700">Liberación de capacidad</div>
            <div class="text-right">
              <div id="hrsLib" class="font-black text-xl text-slate-900">0.0 hrs/mes</div>
              <div class="text-xs text-slate-600">ciclo + tiempo muerto</div>
            </div>
          </div>

          <div class="rounded-xl p-3" style="background:rgba(15,23,42,0.03); border:1px solid var(--border);">
            <div class="text-sm font-bold text-slate-700">Ahorro por scrap</div>
            <div id="ahorroScrap" class="text-right font-black text-lg">$0.00</div>
          </div>
        </div>

        <div class="mt-3 text-xs text-slate-600 leading-relaxed">
          Checklist ROI recomendado: incluir ciclo, vida de herramienta, scrap, paros y costos directos. :contentReference[oaicite:6]{index=6}
        </div>
      </section>

      <!-- Visuales -->
      <section id="visuales" class="card p-5 lg:col-span-6 col-viz">
        <h2 class="text-lg font-black text-slate-900">Visuales</h2>

        <div class="mt-3 grid grid-cols-1 gap-6 max-w-5xl mx-auto">
          <div class="rounded-xl p-3" style="border:1px solid var(--border); background:var(--surface);">
            <p class="text-sm font-black text-slate-900">Distribución de ahorros</p>
            <div id="vizAhorros" class="mt-4 min-h-[320px]"></div>
          </div>

          <div class="rounded-xl p-3" style="border:1px solid var(--border); background:var(--surface);">
            <p class="text-sm font-black text-slate-900">Comparativa rápida</p>
            <div id="vizPerf" class="mt-4"></div>
          </div>

          <div class="rounded-xl p-3" style="border:1px solid var(--border); background:var(--surface);">
            <p class="text-sm font-black text-slate-900">Flujo mensual y payback</p>
            <div id="vizCash" class="mt-4 min-h-[320px]"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Mobile bar -->
  <div id="mobileBar" class="md:hidden fixed inset-x-0 bottom-0 z-40 px-4 py-2 bg-white/90 backdrop-blur border-t" style="border-color:var(--border)">
    <button id="btnCalcularMobile" class="w-full px-4 py-3 rounded-md btn-primary">Calcular</button>
  </div>

  <footer class="py-10 mt-10 text-center">
    <div class="max-w-6xl mx-auto px-4 text-sm text-slate-600">
      © 2026 AlexRaSa — Ingeniería, innovación y eficiencia.
    </div>
  </footer>

  <script>
    // ---------- Mobile menu ----------
    const mOpen  = document.getElementById('mobileOpenBtn');
    const mClose = document.getElementById('mobileCloseBtn');
    const mPanel = document.getElementById('mobilePanel');
    const mBg    = document.getElementById('mobileBackdrop');
    const mLinks = document.querySelectorAll('.mobile-link');

    function toggleMenu(open) {
      if (open) {
        mBg?.classList.remove('pointer-events-none', 'opacity-0');
        mBg?.classList.add('pointer-events-auto', 'opacity-100');
        mPanel?.classList.remove('translate-x-full');
        mPanel?.classList.add('translate-x-0');
        document.body.style.overflow = 'hidden';
      } else {
        mBg?.classList.remove('pointer-events-auto', 'opacity-100');
        mBg?.classList.add('pointer-events-none', 'opacity-0');
        mPanel?.classList.remove('translate-x-0');
        mPanel?.classList.add('translate-x-full');
        document.body.style.overflow = '';
      }
    }

    mOpen?.addEventListener('click', () => toggleMenu(true));
    mClose?.addEventListener('click', () => toggleMenu(false));
    mBg?.addEventListener('click', () => toggleMenu(false));
    mLinks.forEach(link => link.addEventListener('click', () => toggleMenu(false)));
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggleMenu(false); });

    // ---------- Utils ----------
    function fmt(n){
      const v = Number(n || 0);
      return v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function clampPct(v){ return Math.max(0, Math.min(100, Number(v||0))); }

    function setEnabled(ids,on){
      ids.forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.disabled = !on;
        el.style.opacity = on ? '1' : '0.55';
      });
    }
    function applyInclusions(){
      setEnabled(['cicloA','cicloP'], document.getElementById('incCiclo')?.checked ?? true);
      setEnabled(['vidaA','vidaP','costoHerr'], document.getElementById('incHerr')?.checked ?? true);
      setEnabled(['tmuertoA','tmuertoP'], document.getElementById('incTM')?.checked ?? true);
      setEnabled(['scrapA','scrapP','costoScrap'], document.getElementById('incScrap')?.checked ?? true);
    }

    // ---------- Items / CAPEX ----------
    const items = [
      { id:'unit',   name:'Unidad de sujeción (PGU/PGS/PGA/PGC)', inc:true, qty:1,  unit:0 },
      { id:'holder', name:'Portaherramientas (toolholders)',     inc:true, qty:10, unit:0 },
      { id:'collet', name:'Pinzas/Collets (powRgrip o ER)',      inc:true, qty:10, unit:0 },
      { id:'nut',    name:'Tuercas (solo ER)',                   inc:false,qty:10, unit:0 },
      { id:'insert', name:'Insertos/Accesorios (APG / otros)',   inc:false,qty:1,  unit:0 },
      { id:'gauge',  name:'Medición / preset / accesorios',      inc:false,qty:1,  unit:0 },
    ];

    function tbodyItemsRow(it){
      const subtotal = (it.inc ? (Number(it.qty||0) * Number(it.unit||0)) : 0);
      return `
        <tr style="background:#fff; border:1px solid var(--border);">
          <td class="px-2 py-2 font-semibold text-slate-800">${it.name}</td>
          <td class="px-2 py-2 text-center">
            <input type="checkbox" data-item-inc="${it.id}" ${it.inc ? 'checked' : ''} class="h-4 w-4">
          </td>
          <td class="px-2 py-2 text-right">
            <input type="number" min="0" step="1" data-item-qty="${it.id}" value="${it.qty}" class="w-24 text-right">
          </td>
          <td class="px-2 py-2 text-right">
            <input type="number" min="0" step="0.01" data-item-unit="${it.id}" value="${it.unit}" class="w-28 text-right">
          </td>
          <td class="px-2 py-2 text-right font-black text-slate-900">$${fmt(subtotal)}</td>
        </tr>
      `;
    }

    function renderItems(){
      const tbody = document.getElementById('tbodyItems');
      if(!tbody) return;
      tbody.innerHTML = items.map(tbodyItemsRow).join('');
    }

    function computeCapexFromItems(){
      return items.reduce((s,it) => s + (it.inc ? (Number(it.qty||0) * Number(it.unit||0)) : 0), 0);
    }

    function syncCapexUI(){
      const capex = computeCapexFromItems();
      document.getElementById('capexCalc').textContent = `$${fmt(capex)}`;
      const use = document.getElementById('useItemsCapex')?.checked ?? true;
      if(use){
        const invEl = document.getElementById('inversion');
        if(invEl) invEl.value = String(capex.toFixed(2));
      }
    }

    function attachItemsEvents(){
      const tbody = document.getElementById('tbodyItems');
      if(!tbody) return;

      tbody.addEventListener('input', (e) => {
        const t = e.target;
        if(!(t instanceof HTMLElement)) return;

        const incId = t.getAttribute('data-item-inc');
        const qtyId = t.getAttribute('data-item-qty');
        const unitId= t.getAttribute('data-item-unit');

        if(incId){
          const it = items.find(x => x.id === incId);
          if(it) it.inc = t.checked;
        }
        if(qtyId){
          const it = items.find(x => x.id === qtyId);
          if(it) it.qty = Number(t.value || 0);
        }
        if(unitId){
          const it = items.find(x => x.id === unitId);
          if(it) it.unit = Number(t.value || 0);
        }

        renderItems();
        syncCapexUI();
        calcular();
      });
    }

    function presetBySystem(){
      const sys = document.getElementById('sysPropuesta')?.value || 'powrgrip';

      // valores default: conservadores (precios en 0 para que el usuario los ponga)
      items.forEach(it => { it.unit = Number(it.unit||0); });

      if(sys === 'powrgrip'){
        // powRgrip: unidad + holders + collets (tuercas off)
        items.find(i=>i.id==='unit').inc = true;
        items.find(i=>i.id==='holder').inc = true;
        items.find(i=>i.id==='collet').inc = true;
        items.find(i=>i.id==='nut').inc = false;
        items.find(i=>i.id==='insert').inc = true; // a veces aplica
        items.find(i=>i.id==='gauge').inc = false;

        items.find(i=>i.id==='unit').qty = 1;
        items.find(i=>i.id==='holder').qty = 10;
        items.find(i=>i.id==='collet').qty = 10;
        items.find(i=>i.id==='insert').qty = 1;

      } else if(sys === 'er'){
        // ER: holders + collets + nuts (unidad off)
        items.find(i=>i.id==='unit').inc = false;
        items.find(i=>i.id==='holder').inc = true;
        items.find(i=>i.id==='collet').inc = true;
        items.find(i=>i.id==='nut').inc = true;
        items.find(i=>i.id==='insert').inc = false;
        items.find(i=>i.id==='gauge').inc = false;

        items.find(i=>i.id==='holder').qty = 10;
        items.find(i=>i.id==='collet').qty = 10;
        items.find(i=>i.id==='nut').qty = 10;

      } else {
        // otro: deja todo editable sin supuestos
        items.forEach(it => it.inc = true);
      }

      renderItems();
      syncCapexUI();
      calcular();
    }

    // ---------- Core calculator ----------
    function delta(a,p,{higherIsBetter=true}={}){
      if(a===0 && p===0) return {val:0, up:false};
      const d = (p-a) / (a===0 ? 1 : a) * 100;
      const up = higherIsBetter ? d>0 : d<0;
      return {val:d, up};
    }
    function row(name,a,p,opt){
      const d = delta(a,p,opt||{});
      const higherIsBetter = (opt && typeof opt.higherIsBetter !== 'undefined') ? opt.higherIsBetter : true;
      const displayed = isFinite(d.val) ? (d.val >= 0 ? '+' : '') + fmt(d.val) + '%' : '—';
      const thresholdPct = 3;
      const absVal = Math.abs(d.val || 0);
      const isImprovement = higherIsBetter ? (d.val > 0) : (d.val < 0);
      let badgeClass;
      if (absVal < thresholdPct) badgeClass = 'badge-mid';
      else badgeClass = isImprovement ? 'badge-up' : 'badge-down';
      const badge = `<span class="stat-badge ${badgeClass}" title="${isImprovement ? 'Mejora' : 'Empeora'}">${displayed}</span>`;

      return `<tr style="background:transparent;">
        <td class="px-2 py-2 font-semibold text-slate-800">${name}</td>
        <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(a)?fmt(a):'—'}</td>
        <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(p)?fmt(p):'—'}</td>
        <td class="px-2 py-2 text-right">${badge}</td>
      </tr>`;
    }

    function calcular(){
      // Pull inputs
      const mensualidad = +document.getElementById('mensualidad').value || 0;
      const cicloA = +document.getElementById('cicloA').value || 0;
      const cicloP = +document.getElementById('cicloP').value || 0;
      const vidaA  = +document.getElementById('vidaA').value  || 0;
      const vidaP  = +document.getElementById('vidaP').value  || 0;
      const costoHerr = +document.getElementById('costoHerr').value || 0;
      const costoHora = +document.getElementById('costoHora').value || 0;
      const pmes = +document.getElementById('pmes').value || 0;
      const inversion = +document.getElementById('inversion').value || 0;
      const tmuertoA = +document.getElementById('tmuertoA').value || 0;
      const tmuertoP = +document.getElementById('tmuertoP').value || 0;

      const scrapA = clampPct(document.getElementById('scrapA').value);
      const scrapP = clampPct(document.getElementById('scrapP').value);
      const costoScrap = +document.getElementById('costoScrap').value || 0;

      // inclusions
      const incCiclo = document.getElementById('incCiclo')?.checked ?? true;
      const incHerr  = document.getElementById('incHerr')?.checked ?? true;
      const incTM    = document.getElementById('incTM')?.checked ?? true;
      const incScrap = document.getElementById('incScrap')?.checked ?? true;

      // Baseline hours
      const horasMesA = (pmes * cicloA) / 3600;
      const horasMesP = (pmes * cicloP) / 3600;
      const ahorroHorasCiclo = Math.max(0, horasMesA - horasMesP);

      // Savings: cycle
      const ahorroCiclo = (cicloA>0 && cicloP>0)
        ? Math.max(0, (horasMesA - horasMesP) * costoHora)
        : 0;

      // Savings: tooling consumption
      const consA = (vidaA>0) ? (pmes / vidaA) : 0;
      const consP = (vidaP>0) ? (pmes / vidaP) : 0;
      const costoHerrA = consA * costoHerr;
      const costoHerrP = consP * costoHerr;
      const ahorroHerr = Math.max(0, costoHerrA - costoHerrP);

      // Savings: downtime
      const ahorroTM = Math.max(0, (tmuertoA - tmuertoP)) / 60 * costoHora;
      const ahorroHorasTM = Math.max(0, (tmuertoA - tmuertoP)) / 60;

      // Savings: scrap
      const scrapPzasA = (scrapA/100) * pmes;
      const scrapPzasP = (scrapP/100) * pmes;
      const ahorroScrap = Math.max(0, (scrapPzasA - scrapPzasP) * costoScrap);

      // Total
      const ahorroTotal = Math.max(0,
        (incCiclo ? ahorroCiclo : 0) +
        (incHerr  ? ahorroHerr  : 0) +
        (incTM    ? ahorroTM    : 0) +
        (incScrap ? ahorroScrap : 0)
      );

      const neto = ahorroTotal - mensualidad;

      // ROI (neto vs capex)
      const roiMensual = inversion > 0 ? (neto / inversion) * 100 : (neto > 0 ? Infinity : 0);
      const roiAnual   = inversion > 0 ? ((neto * 12) / inversion) * 100 : (neto > 0 ? Infinity : 0);

      const idxPayback = (inversion > 0 && neto > 0) ? Math.ceil(inversion / neto) : -1;

      // KPIs
      document.getElementById('ahorro').textContent = `$${fmt(ahorroTotal)}`;
      document.getElementById('ahorroScrap').textContent = `$${fmt(ahorroScrap)}`;

      document.getElementById('roi').textContent = isFinite(roiAnual) ? `${fmt(roiAnual)}%` : '∞%';
      document.getElementById('payback').textContent = idxPayback !== -1 ? `${idxPayback}` : '—';

      const netoEl = document.getElementById('netoMensual');
      netoEl.textContent = `$${fmt(neto)}`;
      netoEl.style.color = neto >= 0 ? 'var(--good)' : 'var(--bad)';

      const hrsLib = (incCiclo ? ahorroHorasCiclo : 0) + (incTM ? ahorroHorasTM : 0);
      document.getElementById('hrsLib').textContent = `${(hrsLib || 0).toFixed(1)} hrs/mes`;

      // Table rows
      const pphA = cicloA>0 ? 3600/cicloA : 0;
      const pphP = cicloP>0 ? 3600/cicloP : 0;
      const costPerPieceA = vidaA>0 ? (costoHerr/vidaA) : 0;
      const costPerPieceP = vidaP>0 ? (costoHerr/vidaP) : 0;

      const rows = [
        row('Tiempo de ciclo (s)', cicloA, cicloP, {higherIsBetter:false}),
        row('Piezas por hora', pphA, pphP, {higherIsBetter:true}),
        row('Vida herramienta (pzas)', vidaA, vidaP, {higherIsBetter:true}),
        row('Costo herramienta/pza (USD)', costPerPieceA, costPerPieceP, {higherIsBetter:false}),
        row('Consumo herramienta (USD/mes)', costoHerrA, costoHerrP, {higherIsBetter:false}),
        row('Tiempo muerto (min/mes)', tmuertoA, tmuertoP, {higherIsBetter:false}),
        row('Scrap (%)', scrapA, scrapP, {higherIsBetter:false}),
        row('Ahorro mensual total (USD)', 0, ahorroTotal, {higherIsBetter:true}),
      ].join('');

      document.getElementById('tbodyComp').innerHTML = rows;

      // Visuals
      const parts=[], labels=[];
      if(incCiclo){ parts.push(Math.max(0,ahorroCiclo)); labels.push('Ciclo'); }
      if(incHerr){ parts.push(Math.max(0,ahorroHerr)); labels.push('Herramienta'); }
      if(incTM){ parts.push(Math.max(0,ahorroTM)); labels.push('Tiempo muerto'); }
      if(incScrap){ parts.push(Math.max(0,ahorroScrap)); labels.push('Scrap'); }

      renderDonut('vizAhorros', parts, labels);

      renderBars('vizPerf', [
        ['T. Ciclo (s)', cicloA, cicloP, true],
        ['Pzas/h', pphA, pphP, false],
        ['Vida (pzas)', vidaA, vidaP, false],
        ['Scrap (%)', scrapA, scrapP, true],
      ]);

      renderCashflow('vizCash', { ahorroMes: ahorroTotal, cuota: mensualidad, capex: inversion });
    }

    // ---------- Charts ----------
    function renderCashflow(targetId, {ahorroMes, cuota, capex}){
      const el=document.getElementById(targetId); if(!el) return;
      const meses=Array.from({length:12},(_,i)=>`M${i+1}`);

      const W = 800, H = 400;
      const pad = { top: 40, right: 10, bottom: 50, left: 60 };
      const barW = 18, barGap = 6, gap = 38;
      const H_drawable = H - pad.top - pad.bottom;

      const neto = (ahorroMes||0) - (cuota||0);
      let acc = -capex;
      const accArr = meses.map(() => { acc += neto; return acc; });

      const allValues = [ahorroMes||0, cuota||0, ...accArr, -capex];
      const dataMax = Math.max(1, ...allValues.map(v => Math.max(0, v)));
      const dataMin = Math.min(0, ...allValues.map(v => Math.min(0, v)));
      const totalRange = dataMax - dataMin;

      const scaleY = (v) => {
        if (totalRange === 0) return H - pad.bottom;
        return (H - pad.bottom) - (((v - dataMin) / totalRange) * H_drawable);
      };
      const yZero = scaleY(0);

      let x = pad.left + gap/2;
      const bars = meses.map((m,i)=>{
        const yA = scaleY(ahorroMes); const hA = yZero - yA;
        const yP = scaleY(cuota);     const hP = yZero - yP;
        const xa = x, xp = x + barW + barGap;
        const labelY = H - pad.bottom + 20;

        const rects = `
          <rect x="${xa}" y="${yA}" width="${barW}" height="${hA}" fill="#16a34a"></rect>
          <rect x="${xp}" y="${yP}" width="${barW}" height="${hP}" fill="#dc2626"></rect>
        `;
        const txt = `<text x="${x + barW + barGap/2}" y="${labelY}" font-size="14" fill="#111827" text-anchor="middle">${m}</text>`;
        x += (barW * 2 + barGap + gap);
        return rects + txt;
      }).join('');

      const linePts = accArr.map((v,i)=>{
        const xi = pad.left + gap/2 + i*(barW*2+barGap+gap) + (barW + barGap/2);
        const yi = scaleY(v);
        return `${xi},${yi}`;
      }).join(' ');

      const x0 = pad.left + gap/2 - (barW*2+barGap+gap) + (barW + barGap/2);
      const y0 = scaleY(-capex);
      const polyline = `<polyline points="${x0},${y0} ${linePts}" fill="none" stroke="#111827" stroke-width="3" opacity="0.65"></polyline>`;

      let marker='';
      if (capex > 0){
        const idx = accArr.findIndex(v => v >= 0);
        if(idx !== -1){
          const xi_marker = pad.left + gap/2 + idx*(barW*2+barGap+gap) + (barW + barGap/2);
          const yi_marker = scaleY(accArr[idx]);
          marker = `
            <circle cx="${xi_marker}" cy="${yi_marker}" r="6" fill="#cad42e" stroke="#111827" stroke-width="2"></circle>
            <text x="${xi_marker + 10}" y="${yi_marker - 10}" font-size="14" fill="#111827" font-weight="700">Payback M${idx+1}</text>
          `;
        }
      }

      const legendX = W - pad.right - 160, legendY = pad.top;
      const legend = `
        <rect x="${legendX}" y="${legendY - 12}" width="150" height="82" rx="12" fill="rgba(255,255,255,0.85)" stroke="rgba(15,23,42,0.14)"></rect>
        <rect x="${legendX+12}" y="${legendY}" width="12" height="12" fill="#16a34a"></rect>
        <text x="${legendX+30}" y="${legendY+10}" font-size="14" fill="#111827" font-weight="700">Ahorro</text>
        <rect x="${legendX+12}" y="${legendY+26}" width="12" height="12" fill="#dc2626"></rect>
        <text x="${legendX+30}" y="${legendY+36}" font-size="14" fill="#111827" font-weight="700">OPEX</text>
        <line x1="${legendX+12}" y1="${legendY+60}" x2="${legendX+24}" y2="${legendY+60}" stroke="#111827" stroke-width="2.5" opacity="0.65"></line>
        <text x="${legendX+30}" y="${legendY+62}" font-size="14" fill="#111827" font-weight="700">Acumulado</text>
      `;

      const axis = `
        <line x1="${pad.left}" y1="${pad.top - 10}" x2="${pad.left}" y2="${H - pad.bottom}" stroke="rgba(15,23,42,.25)"></line>
        <line x1="${pad.left}" y1="${yZero}" x2="${W - pad.right}" y2="${yZero}" stroke="rgba(15,23,42,.25)"></line>
        <text x="${pad.left - 10}" y="${yZero + 5}" font-size="14" text-anchor="end" fill="rgba(15,23,42,.65)">$0</text>
        <text x="${pad.left - 10}" y="${scaleY(dataMax) + 5}" font-size="14" text-anchor="end" fill="rgba(15,23,42,.65)">$${fmt(dataMax)}</text>
        ${dataMin < 0 ? `<text x="${pad.left - 10}" y="${scaleY(dataMin) + 5}" font-size="14" text-anchor="end" fill="rgba(15,23,42,.65)">$${fmt(dataMin)}</text>` : ''}
      `;

      el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${axis}${bars}${polyline}${marker}${legend}</svg>`;
    }

    function renderDonut(targetId, parts, labels){
      const el=document.getElementById(targetId); if(!el) return;
      const data=parts.map((p,i)=> [labels[i], p]).filter(p=>p[1]>0);
      const total=data.reduce((s,p)=> s + p[1], 0);

      const W=600, H=400;
      const cx = 210, cy = H / 2, r = H * 0.4, th = 50;
      let start=0;
      const colors=['#111827','#16a34a','#dc2626','#cad42e','#f59e0b','#0ea5e9'];

      const legendX = 390;
      const legendFontSize = 18;
      const legendLineHeight = 30;
      const legendBlockHeight = data.length * legendLineHeight;
      const legendStartY = (H - legendBlockHeight) / 2 + (legendFontSize / 2);

      const segs=data.map((p,i)=>{
        const f= total? p[1]/total:0;
        const a0=start*2*Math.PI, a1=(start+f)*2*Math.PI;
        start+=f;
        const L=(a1-a0)>Math.PI?1:0;

        const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0);
        const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
        const x0i=cx+(r-th)*Math.cos(a0), y0i=cy+(r-th)*Math.sin(a0);
        const x1i=cx+(r-th)*Math.cos(a1), y1i=cy+(r-th)*Math.sin(a1);

        const d=`M ${x0} ${y0} A ${r} ${r} 0 ${L} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${L} 0 ${x0i} ${y0i} Z`;
        const pct=Math.round(f*100);
        const ly = legendStartY + (i * legendLineHeight);

        return `
          <path d="${d}" fill="${colors[i%colors.length]}" opacity="0.90"></path>
          <text x="${legendX}" y="${ly}" font-size="${legendFontSize}" fill="#111827" font-weight="700">${p[0]}: ${pct}%</text>
        `;
      }).join('');

      const centerFontSize = Math.max(20, Math.round(r * 0.18));
      const centerText = total > 0 ? ('$' + fmt(total)) : '—';
      const center = `
        <circle cx="${cx}" cy="${cy}" r="${r-th+1}" fill="rgba(255,255,255,0.95)" stroke="rgba(15,23,42,0.12)"></circle>
        <text x="${cx}" y="${cy-6}" text-anchor="middle" dominant-baseline="middle" font-size="${Math.round(centerFontSize*0.9)}" fill="#111827" font-weight="900">Ahorro</text>
        <text x="${cx}" y="${cy+18}" text-anchor="middle" dominant-baseline="middle" font-size="${centerFontSize}" fill="#111827" font-weight="900">${centerText}</text>
      `;

      el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${segs}${center}</svg>`;
    }

    function renderBars(targetId, pairs){
      const rowsData = pairs.map(([lbl,a,b,lowerIsBetter]) => ({
        lines: String(lbl).replace(' (','\n(').split('\n'),
        a: Number(a||0),
        b: Number(b||0),
        lowerIsBetter
      }));

      const approxChar = 7;
      const labelCol = Math.max(160, Math.min(260, Math.max(...rowsData.map(r => Math.max(...r.lines.map(s => s.length)) * approxChar))));
      const barStartX = labelCol + 16;
      const barMax = 520;
      const rowH = 40, rowGap = 16, padY = 20;

      const W = barStartX + barMax + 170;
      const H = padY + rowsData.length * (rowH + rowGap) + 40;

      let y = padY;
      const rows = rowsData.map(r => {
        const maxVal = Math.max(Math.abs(r.a), Math.abs(r.b), 1);
        const aw = Math.round((Math.abs(r.a) / maxVal) * barMax);
        const bw = Math.round((Math.abs(r.b) / maxVal) * barMax);

        const goodB = r.lowerIsBetter ? (r.b < r.a) : (r.b > r.a);
        const colorP = goodB ? '#16a34a' : '#dc2626';

        const label = `
          <text x="0" y="${y + 14}" font-size="14" fill="#111827" font-weight="800">
            ${r.lines[0]}
            ${r.lines.length > 1 ? `<tspan x="0" dy="1.2em">${r.lines.slice(1).join(' ')}</tspan>` : ''}
          </text>
        `;

        const bars = `
          <rect x="${barStartX}" y="${y}"      width="${aw}" height="12" fill="rgba(15,23,42,0.18)"></rect>
          <rect x="${barStartX}" y="${y + 16}" width="${bw}" height="12" fill="${colorP}"></rect>
          <text x="${barStartX + aw + 10}" y="${y + 10}"  font-size="12" fill="#111827" font-weight="700">${isFinite(r.a) ? r.a.toFixed(2) : '—'}</text>
          <text x="${barStartX + bw + 10}" y="${y + 26}" font-size="12" fill="#111827" font-weight="700">${isFinite(r.b) ? r.b.toFixed(2) : '—'}</text>
        `;

        y += rowH + rowGap;
        return label + bars;
      }).join('');

      const legendY = H - 20;
      const legendX = barStartX;
      const legend = `
        <rect x="${legendX}" y="${legendY - 14}" width="210" height="28" rx="10" fill="rgba(255,255,255,0.95)" stroke="rgba(15,23,42,0.14)"></rect>
        <rect x="${legendX + 10}" y="${legendY - 6}" width="12" height="12" fill="rgba(15,23,42,0.18)"></rect>
        <text x="${legendX + 28}" y="${legendY + 4}" font-size="12" fill="#111827" font-weight="800">Actual</text>
        <rect x="${legendX + 88}" y="${legendY - 6}" width="12" height="12" fill="#16a34a"></rect>
        <text x="${legendX + 106}" y="${legendY + 4}" font-size="12" fill="#111827" font-weight="800">Propuesta</text>
      `;

      const svg = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}" role="img" aria-label="Comparativa">${rows}${legend}</svg>`;
      const el = document.getElementById(targetId);
      if(el) el.innerHTML = svg;
    }

    // ---------- Wiring ----------
    document.getElementById('btnCalcular')?.addEventListener('click', calcular);
    document.getElementById('btnCalcularMobile')?.addEventListener('click', calcular);
    document.getElementById('btnPrint')?.addEventListener('click', () => window.print());

    document.getElementById('useItemsCapex')?.addEventListener('change', () => {
      syncCapexUI();
      calcular();
    });

    document.getElementById('btnResetItems')?.addEventListener('click', presetBySystem);
    document.getElementById('sysPropuesta')?.addEventListener('change', presetBySystem);

    [
      'cicloA','cicloP','vidaA','vidaP','costoHerr','costoHora','pmes','inversion','tmuertoA','tmuertoP','mensualidad','scrapA','scrapP','costoScrap'
    ].forEach(id => document.getElementById(id)?.addEventListener('input', () => {
      // recalcula en desktop al teclear
      if (window.innerWidth >= 768) calcular();
    }));

    ['incCiclo','incHerr','incTM','incScrap'].forEach(id => document.getElementById(id)?.addEventListener('change', () => {
      applyInclusions();
      calcular();
    }));

    // init
    renderItems();
    attachItemsEvents();
    presetBySystem();
    applyInclusions();
    syncCapexUI();
    calcular();
  </script>

  <script src="/assets/chatbot.js"></script>
</body>
</html>
