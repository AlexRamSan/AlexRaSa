<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROI Toolholding (REGO-FIX) ‚Äî by AlexRaSa</title>
  <meta name="description" content="Calculadora ROI enfocada en toolholding (holders, collets y clamping units). Ahorros por tiempo, vida de herramienta y mejora de proceso. ROI, payback y reporte PDF." />
  <meta name="theme-color" content="#0B0F17" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://alexrasa.store/roi-regofix/" />
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      color-scheme: dark;

      /* REGO-FIX-ish palette (clean industrial) */
      --bg: #070A10;            /* almost black */
      --panel:#0B0F17;          /* deep navy-black */
      --card: #0E1420;          /* card */
      --muted: rgba(255,255,255,.68);
      --text: #EAF0FF;

      --rf-red:#E30613;
      --rf-red-2:#B90410;

      --rf-slate:#94A3B8;
      --rf-line: rgba(255,255,255,.08);

      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --cyan:#06B6D4;
      --violet:#A78BFA;
    }
    html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    a{color:var(--text)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--rf-line);
      border-radius: 16px;
    }
    .soft{
      background: radial-gradient(1000px 420px at 20% 0%, rgba(227,6,19,.14), transparent 60%),
                  radial-gradient(900px 420px at 80% 0%, rgba(167,139,250,.10), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: .32rem .6rem;
      font-weight: 700;
      font-size: 11px;
      color: rgba(255,255,255,.85);
      display:inline-flex;
      align-items:center;
      gap:.4rem;
    }
    .btn{
      border-radius: 12px;
      padding: .72rem 1rem;
      font-weight: 800;
      border:1px solid rgba(255,255,255,.10);
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn-primary{
      background: linear-gradient(180deg, var(--rf-red), var(--rf-red-2));
      border-color: rgba(227,6,19,.35);
      color: white;
    }
    .btn-ghost{
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.92);
    }
    .field{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: .58rem .65rem;
      color: var(--text);
      outline:none;
    }
    .field:focus{ box-shadow:0 0 0 6px rgba(227,6,19,.14); border-color: rgba(227,6,19,.35); }
    select option{ color:#000; background:#fff; }
    label[title]{
      cursor: help;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-decoration-color: rgba(255,255,255,.35);
    }

    /* KPI badges */
    .kpi{
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: 16px;
      padding: .9rem;
    }
    .kpi .v{ font-weight: 900; font-size: 1.35rem; letter-spacing: -0.01em; }
    .kpi .t{ font-size:.85rem; color: rgba(255,255,255,.74); }

    .badge{
      display:inline-block;
      min-width: 68px;
      text-align:center;
      padding:.30rem .66rem;
      border-radius:999px;
      font-weight: 900;
      font-size: 11px;
      border:1px solid rgba(255,255,255,.10);
    }
    .badge.up{ background: linear-gradient(180deg, #16a34a 0%, #059669 100%); color:#fff; border-color: rgba(5,118,78,.35); }
    .badge.mid{ background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); color:#101010; border-color: rgba(217,119,6,.25); }
    .badge.down{ background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); color:#fff; border-color: rgba(220,38,38,.30); }

    /* SVG text */
    #vizAhorros svg text, #vizPerf svg text, #vizCash svg text { fill: var(--text) !important; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    /* Mobile bottom safe area */
    .safe-bottom{ padding-bottom: max(env(safe-area-inset-bottom), 1rem); }

    /* Print: 1-page report */
    @media print{
      @page{ size: Letter; margin: 0.4in; }
      html,body{ background:#fff !important; color:#000 !important; font-size: 8.5pt !important; }
      header, footer, .soft, #leftPanel, #btnCalcularMobile{ display:none !important; }

      main{ display:block !important; padding:0 !important; margin:0 !important; max-width: 100% !important; }
      #reportWrap{ width:100% !important; margin:0 !important; padding:0 !important; }

      #reportGrid{
        display:grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: .5rem !important;
      }
      .card, .kpi{
        background:#fff !important;
        border: 1px solid #ccc !important;
        box-shadow:none !important;
        page-break-inside: avoid;
      }
      h1,h2,h3,p,span,div,svg,text{ color:#000 !important; fill:#000 !important; }
      .badge.up{ background:#16a34a !important; color:#fff !important; border-color:#16a34a !important; -webkit-print-color-adjust: exact; }
      .badge.mid{ background:#f59e0b !important; color:#111 !important; -webkit-print-color-adjust: exact; }
      .badge.down{ background:#dc2626 !important; color:#fff !important; -webkit-print-color-adjust: exact; }
      .vizBox{ min-height: 150px !important; }
      #vizPerf svg { height: 200px !important; }
    }
  </style>
</head>

<body class="antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-50" style="background:rgba(7,10,16,.85); backdrop-filter: blur(10px); border-bottom:1px solid rgba(255,255,255,.06);">
    <div class="max-w-7xl mx-auto px-4">
      <div class="h-16 flex items-center justify-between gap-4">
        <a href="/" class="flex items-center gap-3 shrink-0" aria-label="Ir al inicio">
          <!-- usa tu archivo: regofixlogo.png -->
          <img src="regofixlogo.png" alt="REGO-FIX" class="h-9 w-auto" />
          <div class="leading-tight">
            <div class="font-extrabold tracking-tight">ROI Toolholding</div>
            <div class="text-xs" style="color:rgba(255,255,255,.65)">holders ‚Ä¢ collets ‚Ä¢ clamping units</div>
          </div>
        </a>

        <div class="hidden md:flex items-center gap-2">
          <span class="chip">
            <span class="inline-block h-2 w-2 rounded-full" style="background:var(--rf-red)"></span>
            Estilo REGO-FIX
          </span>
          <span class="chip">
            <span class="inline-block h-2 w-2 rounded-full" style="background:var(--violet)"></span>
            Reporte 1 p√°gina
          </span>
          <button id="btnPrintTop" class="btn btn-ghost text-sm">Generar Reporte (PDF)</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="soft">
    <div class="max-w-7xl mx-auto px-4 py-8 md:py-10">
      <div class="grid md:grid-cols-12 gap-6 items-start">
        <div class="md:col-span-7">
          <h1 class="text-3xl md:text-5xl font-black tracking-tight">
            Calcula ROI con <span style="color:var(--rf-red)">toolholding</span> (REGO-FIX)
          </h1>
          <p class="mt-3 text-base md:text-lg" style="color:rgba(255,255,255,.78)">
            Tres frentes: <b>ahorro por tiempo</b>, <b>vida de herramienta</b> y <b>mejora de proceso</b> (scrap / estabilidad / m√°s piezas por turno).
          </p>

          <div class="mt-5 flex flex-wrap gap-2">
            <span class="chip">ER</span>
            <span class="chip">powRgrip</span>
            <span class="chip">micRun</span>
            <span class="chip">Measuring</span>
            <span class="chip">uniTec</span>
          </div>

          <!-- Placeholder de fotos (t√∫ las agregar√°s) -->
          <div class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="card p-3 text-sm" style="color:rgba(255,255,255,.70)">üì∑ Placeholder foto 1 (holder)</div>
            <div class="card p-3 text-sm" style="color:rgba(255,255,255,.70)">üì∑ Placeholder foto 2 (collet)</div>
            <div class="card p-3 text-sm hidden md:block" style="color:rgba(255,255,255,.70)">üì∑ Placeholder foto 3 (PGU)</div>
          </div>
        </div>

        <div class="md:col-span-5">
          <div class="card p-5">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="font-extrabold text-lg">Modo de c√°lculo</div>
                <div class="text-sm" style="color:rgba(255,255,255,.70)">
                  Puedes incluir/excluir m√≥dulos y decidir si el ahorro de tiempo se monetiza.
                </div>
              </div>
              <span class="chip" title="Enfocado a holders y sistema de sujeci√≥n">Toolholding ROI</span>
            </div>

            <div class="mt-4 grid gap-3">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="font-bold text-sm">Monetizar ahorro de tiempo</div>
                  <div class="text-xs" style="color:rgba(255,255,255,.65)">Si lo apagas, el tiempo se reporta en horas, no en USD.</div>
                </div>
                <label class="inline-flex items-center gap-2">
                  <input id="swMonetizar" type="checkbox" class="h-5 w-5" checked />
                </label>
              </div>

              <div class="grid sm:grid-cols-2 gap-3">
                <label class="text-sm" title="Costo total hora (m√°quina+MO). Se usa para monetizar tiempo y rework.">
                  Valor hora (USD/h)
                  <input id="valorHora" type="number" value="50" class="field mt-1 w-full" />
                </label>
                <label class="text-sm" title="Volumen mensual para el proceso evaluado.">
                  Piezas / mes
                  <input id="pmes" type="number" value="10000" class="field mt-1 w-full" />
                </label>
              </div>

              <div class="grid sm:grid-cols-2 gap-3">
                <label class="text-sm" title="Costo mensual (mantenimiento / servicio).">
                  Mensualidad (USD/mes)
                  <input id="mensualidad" type="number" value="600" class="field mt-1 w-full" />
                </label>
                <label class="text-sm" title="CAPEX adicional fuera de los √≠tems REGO-FIX (opcional).">
                  CAPEX adicional (USD)
                  <input id="capexExtra" type="number" value="0" class="field mt-1 w-full" />
                </label>
              </div>

              <div class="flex gap-2">
                <button id="btnCalcularTop" class="btn btn-primary w-full">Calcular</button>
                <button id="btnResetTop" class="btn btn-ghost">Reset</button>
              </div>
            </div>
          </div>

          <div class="mt-3 text-xs" style="color:rgba(255,255,255,.55)">
            Nota: esta herramienta calcula ‚ÄúROI operativo‚Äù con base mensual (y anual). Ajusta supuestos a tu realidad: turnos, OEE, scrap y costos. (S√≠, los n√∫meros tambi√©n mienten si los alimentas mal.)
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 pt-6 pb-24 md:pb-14 grid gap-5 lg:grid-cols-12">
    <!-- Left panel (inputs) -->
    <section id="leftPanel" class="lg:col-span-4 card p-5">
      <div class="flex items-start justify-between gap-3">
        <h2 class="text-lg font-extrabold">M√≥dulos de an√°lisis</h2>
        <span class="chip" title="Activa/desactiva para hacer el an√°lisis modular">Modular</span>
      </div>

      <!-- Toggles -->
      <div class="mt-4 grid gap-3 text-sm">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-bold">Ahorro por tiempo</div>
            <div class="text-xs" style="color:rgba(255,255,255,.65)">Ciclo + cambios + tiempos muertos</div>
          </div>
          <input id="incTiempo" type="checkbox" class="h-5 w-5" checked />
        </div>

        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-bold">Vida de herramienta</div>
            <div class="text-xs" style="color:rgba(255,255,255,.65)">Menos consumo por mejor sujeci√≥n</div>
          </div>
          <input id="incVida" type="checkbox" class="h-5 w-5" checked />
        </div>

        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-bold">Mejora de proceso</div>
            <div class="text-xs" style="color:rgba(255,255,255,.65)">Scrap / rework / estabilidad</div>
          </div>
          <input id="incProceso" type="checkbox" class="h-5 w-5" checked />
        </div>
      </div>

      <!-- TIME MODULE -->
      <div class="mt-5 card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-extrabold">Tiempo</h3>
          <span class="chip" style="border-color: rgba(227,6,19,.25)"><span class="inline-block h-2 w-2 rounded-full" style="background:var(--rf-red)"></span>Tiempo</span>
        </div>

        <div class="mt-3 grid gap-3">
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Tiempo de ciclo actual por pieza (segundos).">
              Ciclo actual (s)
              <input id="cicloA" type="number" value="60" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Tiempo de ciclo propuesto por pieza (segundos).">
              Ciclo propuesto (s)
              <input id="cicloP" type="number" value="45" class="field mt-1 w-full">
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Cambios/mes (herramienta / seteo / ajuste en m√°quina).">
              Cambios/mes (A)
              <input id="cambiosA" type="number" value="80" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Cambios/mes con la propuesta (mejor sujeci√≥n suele estabilizar y reducir ajustes).">
              Cambios/mes (P)
              <input id="cambiosP" type="number" value="40" class="field mt-1 w-full">
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Minutos promedio por cambio en condici√≥n actual. (Cambios/mes * min/cambio).">
              Min/cambio (A)
              <input id="minCambioA" type="number" value="6" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Minutos promedio por cambio con la propuesta.">
              Min/cambio (P)
              <input id="minCambioP" type="number" value="4" class="field mt-1 w-full">
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Tiempo muerto total por mes (otros paros: ajustes, vibraci√≥n, medici√≥n extra).">
              T. muerto (A) min/mes
              <input id="tmuertoA" type="number" value="120" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Tiempo muerto objetivo con la propuesta (mejor estabilidad y repetibilidad).">
              T. muerto (P) min/mes
              <input id="tmuertoP" type="number" value="30" class="field mt-1 w-full">
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Opcional: mejora adicional por robustez (subir avances/velocidades) aplicado sobre el ciclo propuesto.">
              Extra proceso (%)
              <input id="extraProcPct" type="number" value="0" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Si activas este switch, el % extra se aplica al ciclo propuesto (lo hace m√°s corto).">
              Aplicar % extra
              <div class="mt-1 flex items-center justify-between card p-3">
                <span class="text-xs" style="color:rgba(255,255,255,.65)">Ciclo P = cicloP*(1-extra%)</span>
                <input id="swExtraProc" type="checkbox" class="h-5 w-5">
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- TOOL LIFE MODULE -->
      <div class="mt-4 card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-extrabold">Vida de herramienta</h3>
          <span class="chip"><span class="inline-block h-2 w-2 rounded-full" style="background:var(--good)"></span>Vida</span>
        </div>

        <div class="mt-3 grid gap-3">
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Piezas que dura la herramienta en condici√≥n actual.">
              Vida (A) pzas
              <input id="vidaA" type="number" value="1300" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Piezas que dura la herramienta con la propuesta (holder/collet/nut).">
              Vida (P) pzas
              <input id="vidaP" type="number" value="2500" class="field mt-1 w-full">
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Costo por herramienta/inserto (USD).">
              Costo herramienta (USD)
              <input id="costoHerr" type="number" value="128.87" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Si adem√°s reduces consumo por menos retrabajo, captura costo adicional aqu√≠ (opcional).">
              Costo extra / pza (USD)
              <input id="costoExtraPza" type="number" value="0" class="field mt-1 w-full">
            </label>
          </div>
        </div>
      </div>

      <!-- PROCESS MODULE -->
      <div class="mt-4 card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-extrabold">Mejora de proceso</h3>
          <span class="chip"><span class="inline-block h-2 w-2 rounded-full" style="background:var(--warn)"></span>Proceso</span>
        </div>

        <div class="mt-3 grid gap-3">
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Scrap actual (% del volumen).">
              Scrap (A) %
              <input id="scrapA" type="number" value="2" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Scrap esperado con la propuesta (% del volumen).">
              Scrap (P) %
              <input id="scrapP" type="number" value="0.5" class="field mt-1 w-full">
            </label>
          </div>

          <label class="text-sm" title="Costo por pieza scrappeada (material+proceso+inspecci√≥n).">
            Costo scrap por pieza (USD)
            <input id="costoScrap" type="number" value="3.5" class="field mt-1 w-full">
          </label>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm" title="Horas/mes de retrabajo actuales (rework).">
              Rework (A) h/mes
              <input id="reworkHA" type="number" value="10" class="field mt-1 w-full">
            </label>
            <label class="text-sm" title="Horas/mes de retrabajo con la propuesta.">
              Rework (P) h/mes
              <input id="reworkHP" type="number" value="4" class="field mt-1 w-full">
            </label>
          </div>
        </div>
      </div>

      <!-- INVESTMENT (REGO-FIX items) -->
      <div class="mt-4 card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-extrabold">Inversi√≥n (√≠tems REGO-FIX)</h3>
          <span class="chip"><span class="inline-block h-2 w-2 rounded-full" style="background:var(--violet)"></span>CAPEX</span>
        </div>
        <p class="mt-2 text-xs" style="color:rgba(255,255,255,.65)">
          Selecciona lo que aplica. Incluye unidades powRgrip como en el flyer (PGU/PGS/PGA/PGC). Ajusta precios/qty.
        </p>

        <div class="mt-3 overflow-auto">
          <table class="w-full text-sm">
            <thead>
              <tr style="color:rgba(255,255,255,.70)">
                <th class="text-left py-2">Incluir</th>
                <th class="text-left py-2">√çtem</th>
                <th class="text-right py-2">Qty</th>
                <th class="text-right py-2">USD</th>
              </tr>
            </thead>
            <tbody id="tbodyItems"></tbody>
          </table>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="btnAddItem" class="btn btn-ghost w-full">Agregar √≠tem</button>
          <button id="btnClearItems" class="btn btn-ghost">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- Report side -->
    <section id="reportWrap" class="lg:col-span-8 grid gap-5">
      <div id="reportGrid" class="grid gap-5 lg:grid-cols-12">
        <!-- KPIs -->
        <section class="lg:col-span-4 card p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-extrabold">Resultados</h2>
            <span class="chip" title="ROI y payback con base mensual">ROI</span>
          </div>

          <div class="mt-4 grid gap-3">
            <div class="kpi">
              <div class="t">Ahorro mensual total</div>
              <div id="kpiAhorro" class="v" style="color:var(--good)">$0</div>
              <div id="kpiAhorroSub" class="text-xs mt-1" style="color:rgba(255,255,255,.70)">‚Äî</div>
            </div>

            <div class="kpi">
              <div class="t">Neto mensual (ahorro - mensualidad)</div>
              <div id="kpiNeto" class="v">$0</div>
              <div class="text-xs mt-1" style="color:rgba(255,255,255,.70)">base para ROI / payback</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="kpi">
                <div class="t">ROI mensual</div>
                <div id="kpiRoiM" class="v" style="color:var(--cyan)">0%</div>
              </div>
              <div class="kpi">
                <div class="t">ROI anual</div>
                <div id="kpiRoiA" class="v" style="color:var(--violet)">0%</div>
              </div>
            </div>

            <div class="kpi">
              <div class="t">Payback (mes)</div>
              <div id="kpiPayback" class="v" style="color:var(--warn)">‚Äî</div>
              <div id="kpiCapex" class="text-xs mt-1" style="color:rgba(255,255,255,.70)">CAPEX: $0</div>
            </div>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="btnCalcular" class="btn btn-primary w-full">Calcular</button>
            <button id="btnPrint" class="btn btn-ghost">PDF</button>
          </div>
        </section>

        <!-- Comparison table -->
        <section class="lg:col-span-8 card p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-extrabold">Comparativa A vs P</h2>
            <span class="chip" title="Mejora relativa con badges">Œî</span>
          </div>

          <div class="mt-3 overflow-auto">
            <table class="w-full border-separate [border-spacing:0_8px] text-sm">
              <thead>
                <tr style="color:rgba(255,255,255,.70)">
                  <th class="text-left font-medium px-2">M√©trica</th>
                  <th class="text-right font-medium px-2">Actual</th>
                  <th class="text-right font-medium px-2">Propuesta</th>
                  <th class="text-right font-medium px-2">Œî</th>
                </tr>
              </thead>
              <tbody id="tbodyComp"></tbody>
            </table>
          </div>

          <div class="mt-2 text-xs" style="color:rgba(255,255,255,.60)">
            Nota: para m√©tricas ‚Äúm√°s bajo es mejor‚Äù (ciclo, scrap, tiempos), el badge verde significa reducci√≥n.
          </div>
        </section>

        <!-- Visuals -->
        <section class="lg:col-span-12 card p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-extrabold">Visuales</h2>
            <div class="flex gap-2">
              <span class="chip">Distribuci√≥n</span>
              <span class="chip">Comparativa</span>
              <span class="chip">Payback</span>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-3 gap-4">
            <div class="card p-4">
              <div class="text-sm font-extrabold">Distribuci√≥n de ahorros</div>
              <div id="vizAhorros" class="mt-3 vizBox min-h-[300px]"></div>
            </div>

            <div class="card p-4">
              <div class="text-sm font-extrabold">Comparativa r√°pida</div>
              <div id="vizPerf" class="mt-3"></div>
            </div>

            <div class="card p-4">
              <div class="text-sm font-extrabold">Flujo mensual y payback</div>
              <div id="vizCash" class="mt-3 vizBox min-h-[300px]"></div>
            </div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- Mobile calc button -->
  <div class="md:hidden fixed inset-x-0 bottom-0 z-40 safe-bottom px-4 py-2">
    <button id="btnCalcularMobile" class="btn btn-primary w-full">Calcular</button>
  </div>

  <footer class="py-8 text-center">
    <div class="text-xs" style="color:rgba(255,255,255,.55)">
      by <span style="color:rgba(255,255,255,.78); font-weight:800;">alexrasa</span>
    </div>
  </footer>

  <script>
    /***********************
     * Small utilities
     ***********************/
    const $ = (id) => document.getElementById(id);
    const clamp0 = (n) => Math.max(0, Number(n||0));
    const num = (v) => Number(v||0);
    const fmt2 = (n) => Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2});
    const fmt0 = (n) => Number(n||0).toLocaleString('en-US',{maximumFractionDigits:0});
    const pct2 = (n) => isFinite(n) ? `${fmt2(n)}%` : '‚àû%';

    function safeDiv(a,b){ return (b===0) ? 0 : (a/b); }

    /***********************
     * Catalog (modular items)
     * - Includes powRgrip units from flyer:
     *   PGC 2506, PGU 9500, PGU 9800, PGA 9500, PGS 25, PGS 48
     ***********************/
    const CATALOG = [
      { sku: 'PGU 9500', cat:'powRgrip unit', name:'PGU 9500 (unidad autom√°tica)', usd: 0 },
      { sku: 'PGU 9800', cat:'powRgrip unit', name:'PGU 9800 (unidad avanzada)', usd: 0 },
      { sku: 'PGA 9500', cat:'powRgrip unit', name:'PGA 9500 (automatizaci√≥n / ethernet)', usd: 0 },
      { sku: 'PGS 25',   cat:'powRgrip unit', name:'PGS 25 (one-size / PG 6-25)', usd: 0 },
      { sku: 'PGS 48',   cat:'powRgrip unit', name:'PGS 48 (hasta 40 mm)', usd: 0 },
      { sku: 'PGC 2506', cat:'powRgrip unit', name:'PGC 2506 (manual)', usd: 0 },

      { sku: 'powRgrip toolholder', cat:'toolholder', name:'powRgrip Toolholder', usd: 0 },
      { sku: 'powRgrip collet',     cat:'collet',     name:'powRgrip Collet (pinza)', usd: 0 },
      { sku: 'powRgrip nut',        cat:'nut',       name:'powRgrip Nut (tuerca)', usd: 0 },

      { sku: 'ER holder',           cat:'toolholder', name:'ER Toolholder', usd: 0 },
      { sku: 'ER collet',           cat:'collet',     name:'ER Collet (DIN 6499)', usd: 0 },
      { sku: 'ER nut',              cat:'nut',       name:'ER Nut (alta velocidad / etc.)', usd: 0 },

      { sku: 'micRun holder',       cat:'toolholder', name:'micRun Toolholder', usd: 0 },
      { sku: 'micRun collet',       cat:'collet',     name:'micRun Collet', usd: 0 },

      { sku: 'Measuring device',    cat:'measuring',  name:'Measuring (preset / gauge / certificaci√≥n)', usd: 0 },
      { sku: 'Accessories',         cat:'accessory',  name:'Accesorios (pull stud, coolant, etc.)', usd: 0 },
    ];

    const DEFAULT_ITEMS = [
      { include:true, sku:'PGU 9500', qty:1, usd:0 },
      { include:false, sku:'PGU 9800', qty:1, usd:0 },
      { include:false, sku:'PGA 9500', qty:1, usd:0 },
      { include:false, sku:'PGS 25', qty:1, usd:0 },
      { include:false, sku:'PGS 48', qty:1, usd:0 },
      { include:false, sku:'PGC 2506', qty:1, usd:0 },
      { include:true, sku:'powRgrip toolholder', qty:2, usd:0 },
      { include:true, sku:'powRgrip collet', qty:6, usd:0 },
      { include:true, sku:'powRgrip nut', qty:2, usd:0 },
    ];

    let itemsState = JSON.parse(JSON.stringify(DEFAULT_ITEMS));

    function catalogLabel(sku){
      const f = CATALOG.find(x=>x.sku===sku);
      if(!f) return sku;
      return `${f.name}`;
    }

    function renderItemsTable(){
      const tb = $('tbodyItems');
      if(!tb) return;
      tb.innerHTML = itemsState.map((row, idx) => {
        const options = CATALOG.map(x => {
          const sel = x.sku === row.sku ? 'selected' : '';
          return `<option value="${x.sku}" ${sel}>${x.cat.toUpperCase()} ‚Äî ${x.name}</option>`;
        }).join('');

        return `
          <tr class="border-t" style="border-color: rgba(255,255,255,.06)">
            <td class="py-2 pr-2">
              <input type="checkbox" ${row.include ? 'checked' : ''} data-act="inc" data-idx="${idx}" class="h-4 w-4" />
            </td>
            <td class="py-2 pr-2">
              <select class="field w-full" data-act="sku" data-idx="${idx}">${options}</select>
            </td>
            <td class="py-2 pr-2 text-right">
              <input type="number" min="0" class="field w-24 text-right" value="${row.qty}" data-act="qty" data-idx="${idx}" />
            </td>
            <td class="py-2 text-right">
              <input type="number" min="0" class="field w-28 text-right" value="${row.usd}" data-act="usd" data-idx="${idx}" />
            </td>
          </tr>
        `;
      }).join('');

      tb.querySelectorAll('[data-act]').forEach(el=>{
        el.addEventListener('input', (e)=>{
          const idx = Number(e.target.dataset.idx);
          const act = e.target.dataset.act;
          if(!itemsState[idx]) return;
          if(act === 'inc') itemsState[idx].include = e.target.checked;
          if(act === 'sku') itemsState[idx].sku = e.target.value;
          if(act === 'qty') itemsState[idx].qty = num(e.target.value);
          if(act === 'usd') itemsState[idx].usd = num(e.target.value);
          autoCalc();
        });
        el.addEventListener('change', ()=>autoCalc());
      });
    }

    function capexFromItems(){
      return itemsState.reduce((s,r)=>{
        if(!r.include) return s;
        return s + clamp0(r.qty) * clamp0(r.usd);
      }, 0);
    }

    /***********************
     * Read config
     ***********************/
    function readCfg(){
      return {
        monetize: $('swMonetizar')?.checked ?? true,
        valorHora: clamp0($('valorHora')?.value),
        pmes: clamp0($('pmes')?.value),

        mensualidad: clamp0($('mensualidad')?.value),
        capexExtra: clamp0($('capexExtra')?.value),

        incTiempo: $('incTiempo')?.checked ?? true,
        incVida: $('incVida')?.checked ?? true,
        incProceso: $('incProceso')?.checked ?? true,

        cicloA: clamp0($('cicloA')?.value),
        cicloP: clamp0($('cicloP')?.value),

        cambiosA: clamp0($('cambiosA')?.value),
        cambiosP: clamp0($('cambiosP')?.value),
        minCambioA: clamp0($('minCambioA')?.value),
        minCambioP: clamp0($('minCambioP')?.value),

        tmuertoA: clamp0($('tmuertoA')?.value),
        tmuertoP: clamp0($('tmuertoP')?.value),

        extraProcPct: num($('extraProcPct')?.value),
        swExtraProc: $('swExtraProc')?.checked ?? false,

        vidaA: clamp0($('vidaA')?.value),
        vidaP: clamp0($('vidaP')?.value),
        costoHerr: clamp0($('costoHerr')?.value),
        costoExtraPza: clamp0($('costoExtraPza')?.value),

        scrapA: clamp0($('scrapA')?.value),
        scrapP: clamp0($('scrapP')?.value),
        costoScrap: clamp0($('costoScrap')?.value),
        reworkHA: clamp0($('reworkHA')?.value),
        reworkHP: clamp0($('reworkHP')?.value),

        capexItems: capexFromItems(),
      };
    }

    /***********************
     * Core math (modular)
     ***********************/
    function compute(cfg){
      // Effective proposed cycle if extra process applied
      const extraFactor = (cfg.swExtraProc && isFinite(cfg.extraProcPct)) ? (1 - (cfg.extraProcPct/100)) : 1;
      const cicloPEff = cfg.cicloP * extraFactor;

      // Time (hours saved)
      const horasCiclo = (cfg.cicloA > 0 && cicloPEff > 0)
        ? clamp0((cfg.cicloA - cicloPEff) * cfg.pmes / 3600)
        : 0;

      const horasCambios = clamp0((cfg.cambiosA * cfg.minCambioA - cfg.cambiosP * cfg.minCambioP) / 60);

      const horasMuerto = clamp0((cfg.tmuertoA - cfg.tmuertoP) / 60);

      const horasTiempo = horasCiclo + horasCambios + horasMuerto;

      // Monetize time if enabled
      const usdTiempo = cfg.monetize ? (horasTiempo * cfg.valorHora) : 0;

      // Tool life (tool consumption)
      const consA = (cfg.vidaA > 0) ? (cfg.pmes / cfg.vidaA) : 0;
      const consP = (cfg.vidaP > 0) ? (cfg.pmes / cfg.vidaP) : 0;
      const costoHerrA = consA * cfg.costoHerr;
      const costoHerrP = consP * cfg.costoHerr;

      // Extra per-piece cost (optional) reduced by improved stability: treat as "waste cost" that goes away with P
      const extraA = cfg.pmes * cfg.costoExtraPza;
      const extraP = 0;

      const usdVida = clamp0((costoHerrA - costoHerrP) + (extraA - extraP));

      // Process improvement: scrap + rework
      const scrapQtyA = cfg.pmes * (cfg.scrapA / 100);
      const scrapQtyP = cfg.pmes * (cfg.scrapP / 100);
      const usdScrap = clamp0((scrapQtyA - scrapQtyP) * cfg.costoScrap);

      // Rework hours saved valued at valorHora (always monetary, regardless of monetize toggle)
      const usdRework = clamp0((cfg.reworkHA - cfg.reworkHP) * cfg.valorHora);

      const usdProceso = usdScrap + usdRework;

      // Apply module switches
      const ahorroTiempo = cfg.incTiempo ? usdTiempo : 0;
      const ahorroVida = cfg.incVida ? usdVida : 0;
      const ahorroProceso = cfg.incProceso ? usdProceso : 0;

      const ahorroTotal = ahorroTiempo + ahorroVida + ahorroProceso;

      // CAPEX
      const capex = cfg.capexItems + cfg.capexExtra;

      // Net and ROI
      const neto = ahorroTotal - cfg.mensualidad;
      const roiMensual = (capex > 0) ? (neto / capex) * 100 : (neto > 0 ? Infinity : 0);
      const roiAnual = (capex > 0) ? ((neto * 12) / capex) * 100 : (neto > 0 ? Infinity : 0);
      const payback = (capex > 0 && neto > 0) ? (capex / neto) : Infinity;
      const paybackMes = isFinite(payback) ? Math.ceil(payback) : null;

      // For table comparisons
      const pphA = cfg.cicloA > 0 ? 3600 / cfg.cicloA : 0;
      const pphP = cicloPEff > 0 ? 3600 / cicloPEff : 0;

      return {
        cicloPEff,
        horas: { ciclo: horasCiclo, cambios: horasCambios, muerto: horasMuerto, total: horasTiempo },
        ahorro: { tiempo: ahorroTiempo, vida: ahorroVida, proceso: ahorroProceso, total: ahorroTotal },
        detalle: { usdTiempo, usdVida, usdScrap, usdRework, capex, neto, roiMensual, roiAnual, paybackMes },
        base: { pphA, pphP, costoHerrA, costoHerrP, scrapQtyA, scrapQtyP }
      };
    }

    /***********************
     * Comparison rows (A vs P)
     ***********************/
    function deltaPct(a,p, higherIsBetter=true){
      if(a===0 && p===0) return { d: 0, isImprovement: false };
      const d = ((p - a) / (a===0 ? 1 : a)) * 100;
      const isImprovement = higherIsBetter ? (d > 0) : (d < 0);
      return { d, isImprovement };
    }

    function badgeForDelta(d, isImprovement){
      const absVal = Math.abs(d || 0);
      const threshold = 3; // small changes -> amber
      const label = isFinite(d) ? ((d>=0?'+':'') + fmt2(d) + '%') : '‚Äî';
      if(absVal < threshold) return `<span class="badge mid" title="Cambio menor">${label}</span>`;
      return isImprovement
        ? `<span class="badge up" title="Mejora">${label}</span>`
        : `<span class="badge down" title="Empeora">${label}</span>`;
    }

    function rowHTML(name,a,p, opts){
      const higherIsBetter = opts?.higherIsBetter ?? true;
      const showMoney = opts?.money ?? false;
      const fmt = showMoney ? (x)=>`$${fmt2(x)}` : (x)=>fmt2(x);

      const { d, isImprovement } = deltaPct(a,p, higherIsBetter);
      const badge = badgeForDelta(d, isImprovement);

      return `
        <tr style="background:rgba(255,255,255,.01); border:1px solid rgba(255,255,255,.06)">
          <td class="px-2 py-2">${name}</td>
          <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(a)?fmt(a):'‚Äî'}</td>
          <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(p)?fmt(p):'‚Äî'}</td>
          <td class="px-2 py-2 text-right">${badge}</td>
        </tr>
      `;
    }

    /***********************
     * Visuals (SVG)
     ***********************/
    function renderDonut(targetId, parts, labels){
      const el = $(targetId); if(!el) return;
      const data = parts.map((v,i)=>({ label: labels[i], v: clamp0(v) })).filter(x=>x.v>0);
      const total = data.reduce((s,x)=>s+x.v, 0);

      const W=600, H=380;
      const cx = 200, cy = H/2, r = 140, th = 46;

      let start=0;
      const colors = ['#E30613','#22C55E','#06B6D4','#A78BFA','#F59E0B','#94A3B8'];

      const legendX = 380;
      const legendFontSize = 16;
      const lh = 28;
      const legendStartY = (H - data.length*lh)/2 + 8;

      const segs = data.map((p,i)=>{
        const f = total ? p.v/total : 0;
        const a0 = start*2*Math.PI, a1 = (start+f)*2*Math.PI;
        start += f;
        const L = (a1-a0) > Math.PI ? 1 : 0;
        const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0);
        const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
        const x0i=cx+(r-th)*Math.cos(a0), y0i=cy+(r-th)*Math.sin(a0);
        const x1i=cx+(r-th)*Math.cos(a1), y1i=cy+(r-th)*Math.sin(a1);
        const d=`M ${x0} ${y0} A ${r} ${r} 0 ${L} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${L} 0 ${x0i} ${y0i} Z`;
        const pct = Math.round(f*100);
        const ly = legendStartY + i*lh;

        return `
          <path d="${d}" fill="${colors[i%colors.length]}" opacity="0.95"></path>
          <text x="${legendX}" y="${ly}" font-size="${legendFontSize}">${p.label}: ${pct}%</text>
        `;
      }).join('');

      const centerText = total>0 ? `$${fmt2(total)}` : '‚Äî';
      const center = `
        <circle cx="${cx}" cy="${cy}" r="${r-th+1}" fill="rgba(255,255,255,0.04)"></circle>
        <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" font-size="22">${centerText}</text>
      `;

      el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${segs}${center}</svg>`;
    }

    // Horizontal bars with independent scale per row
    function renderBars(targetId, pairs){
      const el = $(targetId); if(!el) return;

      const rows = pairs.map(([lbl,a,b,lowerIsBetter])=>({
        lines: String(lbl).replace(' (','\n(').split('\n'),
        a: num(a), b: num(b), lowerIsBetter: !!lowerIsBetter
      }));

      const approxChar = 7;
      const labelCol = Math.max(160, Math.min(280, Math.max(...rows.map(r=>Math.max(...r.lines.map(s=>s.length))*approxChar))));
      const barStartX = labelCol + 16;
      const barMax = 520;
      const rowH = 40, rowGap = 14, padY = 18;
      const W = barStartX + barMax + 160;
      const H = padY + rows.length*(rowH+rowGap) + 44;

      let y = padY;

      const out = rows.map(r=>{
        const maxVal = Math.max(Math.abs(r.a), Math.abs(r.b), 1);
        const aw = Math.round((Math.abs(r.a)/maxVal)*barMax);
        const bw = Math.round((Math.abs(r.b)/maxVal)*barMax);

        const goodB = r.lowerIsBetter ? (r.b < r.a) : (r.b > r.a);
        const colorP = goodB ? '#22C55E' : '#EF4444';

        const label = `
          <text x="0" y="${y+14}" font-size="14">
            ${r.lines[0]}
            ${r.lines.length>1 ? `<tspan x="0" dy="1.2em">${r.lines.slice(1).join(' ')}</tspan>` : ''}
          </text>
        `;

        const bars = `
          <rect x="${barStartX}" y="${y}" width="${aw}" height="12" fill="#94A3B8"></rect>
          <rect x="${barStartX}" y="${y+16}" width="${bw}" height="12" fill="${colorP}"></rect>

          <text x="${barStartX+aw+10}" y="${y+10}" font-size="12">${isFinite(r.a)?r.a.toFixed(1):'‚Äî'}</text>
          <text x="${barStartX+bw+10}" y="${y+26}" font-size="12">${isFinite(r.b)?r.b.toFixed(1):'‚Äî'}</text>
        `;

        y += rowH + rowGap;
        return label + bars;
      }).join('');

      const legendY = H - 24;
      const legendX = barStartX;
      const legend = `
        <rect x="${legendX}" y="${legendY-14}" width="220" height="28" rx="10" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.06)"></rect>
        <rect x="${legendX+10}" y="${legendY-6}" width="12" height="12" fill="#94A3B8"></rect>
        <text x="${legendX+28}" y="${legendY+4}" font-size="12">Actual</text>
        <rect x="${legendX+92}" y="${legendY-6}" width="12" height="12" fill="#22C55E"></rect>
        <text x="${legendX+110}" y="${legendY+4}" font-size="12">Propuesta</text>
      `;

      el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${out}${legend}</svg>`;
    }

    function renderCashflow(targetId, {ahorroMes, cuota, capex}){
      const el = $(targetId); if(!el) return;

      const meses = Array.from({length:12}, (_,i)=>`M${i+1}`);
      const W=780, H=360;
      const pad={top:34,right:12,bottom:48,left:56};
      const barW=18, barGap=6, gap=34;
      const drawable = H - pad.top - pad.bottom;

      const neto = num(ahorroMes) - num(cuota);
      let acc = -num(capex);
      const accArr = meses.map(()=>{ acc += neto; return acc; });

      const all = [num(ahorroMes), num(cuota), ...accArr, -num(capex)];
      const maxV = Math.max(1, ...all.map(v=>Math.max(0,v)));
      const minV = Math.min(0, ...all.map(v=>Math.min(0,v)));
      const range = maxV - minV;

      const y = (v)=>{
        if(range===0) return H-pad.bottom;
        return (H-pad.bottom) - (((v-minV)/range)*drawable);
      };
      const y0 = y(0);

      let x = pad.left + gap/2;

      const bars = meses.map((m,i)=>{
        const yA = y(num(ahorroMes)); const hA = y0 - yA;
        const yC = y(num(cuota));     const hC = y0 - yC;

        const xa=x, xb=x+barW+barGap;
        const labelY = H - pad.bottom + 20;

        const rects = `
          <rect x="${xa}" y="${yA}" width="${barW}" height="${hA}" fill="#22C55E"></rect>
          <rect x="${xb}" y="${yC}" width="${barW}" height="${hC}" fill="#EF4444"></rect>
        `;
        const txt = `<text x="${x+barW+(barGap/2)}" y="${labelY}" font-size="12" text-anchor="middle">${m}</text>`;

        x += (barW*2 + barGap + gap);
        return rects + txt;
      }).join('');

      const linePts = accArr.map((v,i)=>{
        const xi = pad.left + gap/2 + i*(barW*2+barGap+gap) + (barW + barGap/2);
        const yi = y(v);
        return `${xi},${yi}`;
      }).join(' ');

      const x0line = pad.left + gap/2 - (barW*2+barGap+gap) + (barW + barGap/2);
      const y0line = y(-num(capex));
      const poly = `<polyline points="${x0line},${y0line} ${linePts}" fill="none" stroke="#A78BFA" stroke-width="3"></polyline>`;

      let marker='';
      if(num(capex)>0 && neto>0){
        const idx = accArr.findIndex(v=>v>=0);
        if(idx!==-1){
          const xm = pad.left + gap/2 + idx*(barW*2+barGap+gap) + (barW + barGap/2);
          const ym = y(accArr[idx]);
          marker = `
            <circle cx="${xm}" cy="${ym}" r="6" fill="#A78BFA" stroke="var(--bg)" stroke-width="2"></circle>
            <text x="${xm+10}" y="${ym-10}" font-size="12" fill="#A78BFA">Payback M${idx+1}</text>
          `;
        }
      }

      const axis = `
        <line x1="${pad.left}" y1="${pad.top-10}" x2="${pad.left}" y2="${H-pad.bottom}" stroke="rgba(255,255,255,.22)"></line>
        <line x1="${pad.left}" y1="${y0}" x2="${W-pad.right}" y2="${y0}" stroke="rgba(255,255,255,.22)"></line>
        <text x="${pad.left-10}" y="${y0+5}" font-size="12" text-anchor="end" fill="rgba(255,255,255,.70)">$0</text>
        <text x="${pad.left-10}" y="${y(maxV)+5}" font-size="12" text-anchor="end" fill="rgba(255,255,255,.70)">$${fmt2(maxV)}</text>
        ${minV < 0 ? `<text x="${pad.left-10}" y="${y(minV)+5}" font-size="12" text-anchor="end" fill="rgba(255,255,255,.70)">$${fmt2(minV)}</text>` : ''}
      `;

      const legendX = W - pad.right - 160, legendY = pad.top;
      const legend = `
        <rect x="${legendX}" y="${legendY-12}" width="150" height="76" rx="12" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.06)"></rect>
        <rect x="${legendX+12}" y="${legendY}" width="12" height="12" fill="#22C55E"></rect>
        <text x="${legendX+30}" y="${legendY+10}" font-size="12">Ahorro</text>
        <rect x="${legendX+12}" y="${legendY+24}" width="12" height="12" fill="#EF4444"></rect>
        <text x="${legendX+30}" y="${legendY+34}" font-size="12">Cuota</text>
        <line x1="${legendX+12}" y1="${legendY+52}" x2="${legendX+24}" y2="${legendY+52}" stroke="#A78BFA" stroke-width="2.5"></line>
        <text x="${legendX+30}" y="${legendY+54}" font-size="12">Acumulado</text>
      `;

      el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${axis}${bars}${poly}${marker}${legend}</svg>`;
    }

    /***********************
     * Render everything
     ***********************/
    function render(result, cfg){
      // KPIs
      $('kpiAhorro').textContent = `$${fmt2(result.ahorro.total)}`;
      $('kpiAhorroSub').textContent =
        cfg.monetize
          ? `Tiempo $${fmt2(result.detalle.usdTiempo)} ‚Ä¢ Vida $${fmt2(result.ahorro.vida)} ‚Ä¢ Proceso $${fmt2(result.ahorro.proceso)}`
          : `Tiempo ${fmt2(result.horas.total)} h (no monetizado) ‚Ä¢ Vida $${fmt2(result.ahorro.vida)} ‚Ä¢ Proceso $${fmt2(result.ahorro.proceso)}`;

      $('kpiNeto').textContent = `$${fmt2(result.detalle.neto)}`;
      $('kpiNeto').style.color = (result.detalle.neto >= 0) ? 'var(--good)' : 'var(--bad)';

      $('kpiRoiM').textContent = pct2(result.detalle.roiMensual);
      $('kpiRoiA').textContent = pct2(result.detalle.roiAnual);

      $('kpiPayback').textContent = (result.detalle.paybackMes && isFinite(result.detalle.paybackMes)) ? result.detalle.paybackMes : '‚Äî';
      $('kpiCapex').textContent = `CAPEX: $${fmt2(result.detalle.capex)}`;

      // Comparativa table
      const rows = [];

      // Tiempo
      rows.push(rowHTML('Tiempo de ciclo (s)', cfg.cicloA, result.cicloPEff, {higherIsBetter:false}));
      rows.push(rowHTML('Piezas por hora', result.base.pphA, result.base.pphP, {higherIsBetter:true}));
      rows.push(rowHTML('Horas ahorradas (tiempo) h/mes', (cfg.incTiempo?0:0), (cfg.incTiempo?result.horas.total:0), {higherIsBetter:true}));
      if(cfg.monetize){
        rows.push(rowHTML('Ahorro por tiempo (USD/mes)', 0, (cfg.incTiempo?result.ahorro.tiempo:0), {higherIsBetter:true, money:true}));
      }

      // Cambios/mes * min/cambio (tu requerimiento)
      const minMesA = cfg.cambiosA * cfg.minCambioA;
      const minMesP = cfg.cambiosP * cfg.minCambioP;
      rows.push(rowHTML('Cambios: (cambios/mes * min/cambio)', minMesA, minMesP, {higherIsBetter:false}));

      // Tiempo muerto
      rows.push(rowHTML('Tiempo muerto (min/mes)', cfg.tmuertoA, cfg.tmuertoP, {higherIsBetter:false}));

      // Vida de herramienta
      rows.push(rowHTML('Vida √∫til (pzas)', cfg.vidaA, cfg.vidaP, {higherIsBetter:true}));
      const costPerPieceA = cfg.vidaA>0 ? cfg.costoHerr/cfg.vidaA : 0;
      const costPerPieceP = cfg.vidaP>0 ? cfg.costoHerr/cfg.vidaP : 0;
      rows.push(rowHTML('Costo herramienta/pza (USD)', costPerPieceA, costPerPieceP, {higherIsBetter:false}));
      rows.push(rowHTML('Consumo herramienta/mes (USD)', result.base.costoHerrA, result.base.costoHerrP, {higherIsBetter:false, money:true}));
      rows.push(rowHTML('Ahorro por vida (USD/mes)', 0, (cfg.incVida?result.ahorro.vida:0), {higherIsBetter:true, money:true}));

      // Proceso: scrap + rework
      rows.push(rowHTML('Scrap (%)', cfg.scrapA, cfg.scrapP, {higherIsBetter:false}));
      rows.push(rowHTML('Scrap (pzas/mes)', result.base.scrapQtyA, result.base.scrapQtyP, {higherIsBetter:false}));
      rows.push(rowHTML('Ahorro por scrap (USD/mes)', 0, (cfg.incProceso?result.detalle.usdScrap:0), {higherIsBetter:true, money:true}));
      rows.push(rowHTML('Ahorro por rework (USD/mes)', 0, (cfg.incProceso?result.detalle.usdRework:0), {higherIsBetter:true, money:true}));

      // Total
      rows.push(rowHTML('Ahorro mensual total (USD)', 0, result.ahorro.total, {higherIsBetter:true, money:true}));

      $('tbodyComp').innerHTML = rows.join('');

      // Visuals
      const parts = [];
      const labels = [];
      if(cfg.incTiempo) { parts.push(result.ahorro.tiempo); labels.push(cfg.monetize ? 'Tiempo' : 'Tiempo (hrs->0 USD)'); }
      if(cfg.incVida)   { parts.push(result.ahorro.vida); labels.push('Vida'); }
      if(cfg.incProceso){ parts.push(result.ahorro.proceso); labels.push('Proceso'); }
      renderDonut('vizAhorros', parts, labels);

      renderBars('vizPerf', [
        ['T. Ciclo (s)', cfg.cicloA, result.cicloPEff, true],
        ['Pzas/h', result.base.pphA, result.base.pphP, false],
        ['Vida (pzas)', cfg.vidaA, cfg.vidaP, false],
        ['Scrap (%)', cfg.scrapA, cfg.scrapP, true],
      ]);

      renderCashflow('vizCash', { ahorroMes: result.ahorro.total, cuota: cfg.mensualidad, capex: result.detalle.capex });
    }

    function calcular(){
      const cfg = readCfg();
      const result = compute(cfg);
      render(result, cfg);
    }

    function autoCalc(){
      // auto-calc only for desktop to avoid jitter on mobile
      if(window.innerWidth >= 768) calcular();
    }

    /***********************
     * Wire events
     ***********************/
    function bind(){
      // Buttons
      $('btnCalcular')?.addEventListener('click', calcular);
      $('btnCalcularTop')?.addEventListener('click', calcular);
      $('btnCalcularMobile')?.addEventListener('click', calcular);

      $('btnPrint')?.addEventListener('click', ()=>window.print());
      $('btnPrintTop')?.addEventListener('click', ()=>window.print());

      $('btnResetTop')?.addEventListener('click', ()=>{
        // Keep items; reset numeric fields to defaults (simple approach: reload)
        location.reload();
      });

      // Toggles
      ['swMonetizar','incTiempo','incVida','incProceso','swExtraProc'].forEach(id=>{
        $(id)?.addEventListener('change', ()=>calcular());
      });

      // Inputs to recalc
      [
        'valorHora','pmes','mensualidad','capexExtra',
        'cicloA','cicloP','cambiosA','cambiosP','minCambioA','minCambioP','tmuertoA','tmuertoP','extraProcPct',
        'vidaA','vidaP','costoHerr','costoExtraPza',
        'scrapA','scrapP','costoScrap','reworkHA','reworkHP'
      ].forEach(id=>{
        $(id)?.addEventListener('input', autoCalc);
      });

      // Items table actions
      $('btnAddItem')?.addEventListener('click', ()=>{
        itemsState.push({ include:true, sku: CATALOG[0].sku, qty:1, usd:0 });
        renderItemsTable();
        calcular();
      });

      $('btnClearItems')?.addEventListener('click', ()=>{
        itemsState = [];
        renderItemsTable();
        calcular();
      });
    }

    /***********************
     * Init
     ***********************/
    renderItemsTable();
    bind();
    calcular();
  </script>
</body>
</html>
