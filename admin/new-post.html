<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuevo Post | Admin AlexRaSa</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">Nuevo Post</h1>

    <form id="postForm" class="space-y-6">
      <div>
        <label class="block text-sm font-medium">Título *</label>
        <input id="title" type="text" required class="mt-1 w-full rounded-lg border-slate-300" placeholder="Caso de éxito: …" />
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Fecha *</label>
          <input id="date" type="date" required class="mt-1 w-full rounded-lg border-slate-300" />
        </div>
        <div>
          <label class="block text-sm font-medium">Slug (opcional)</label>
          <input id="slug" type="text" class="mt-1 w-full rounded-lg border-slate-300" placeholder="imachining-success" />
          <p class="text-xs text-slate-500 mt-1">Si lo dejas vacío se genera del título.</p>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Descripción (SEO) *</label>
        <textarea id="description" required rows="3" class="mt-1 w-full rounded-lg border-slate-300" placeholder="Resumen breve…"></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium">Contenido HTML *</label>
        <textarea id="content" required rows="10" class="mt-1 w-full rounded-lg border-slate-300" placeholder="<h2>…"></textarea>
        <p class="text-xs text-slate-500 mt-1">Pega HTML limpio. Se envuelve con Tailwind automáticamente.</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Imagen principal</label>
          <input id="image" type="file" accept="image/*" class="mt-1 w-full rounded-lg border-slate-300" />
          <p class="text-xs text-slate-500 mt-1">Se sube a <code>/assets/blog/</code>. Tamaño sugerido 1200×630.</p>
        </div>
        <div>
          <label class="block text-sm font-medium">Previsualización</label>
          <div class="mt-1 rounded-xl overflow-hidden bg-slate-200">
            <img id="preview" alt="Preview" class="w-full h-auto aspect-[1200/630] object-cover" />
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="publishBtn" type="submit" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Publicar</button>
        <span id="status" class="text-sm text-slate-600"></span>
      </div>
    </form>
  </main>

  <script>
  /** ====== CONFIG ====== */
  const GIT = {
    owner: "TU_USUARIO_GITHUB",   // ej: AlexRaSa
    repo:  "TU_REPO",             // ej: alexrasa.store
    branch:"main",
    token: "GITHUB_TOKEN"         // PAT con scope repo
  };
  const PATHS = {
    postsJson: "blog/posts.json",
    blogDir:   "blog/",
    imgDir:    "assets/blog/"
  };
  const PLACEHOLDER = "/assets/blog/placeholder.jpg";
  /** ===================== */

  // Preview
  document.getElementById("image").addEventListener("change", e => {
    const f = e.target.files?.[0];
    if (!f) return document.getElementById("preview").src = PLACEHOLDER;
    const url = URL.createObjectURL(f);
    document.getElementById("preview").src = url;
  });

  // Helpers GitHub
  const gh = async (path, opt = {}) => {
    const url = `https://api.github.com/repos/${GIT.owner}/${GIT.repo}/${path}`;
    const res = await fetch(url, {
      ...opt,
      headers: {
        "Authorization": `token ${GIT.token}`,
        "Accept": "application/vnd.github+json",
        ...(opt.headers || {})
      }
    });
    if (!res.ok) throw new Error(`GitHub ${res.status}: ${await res.text()}`);
    return res.json();
  };

  const getContent = (path) =>
    gh(`contents/${encodeURIComponent(path)}?ref=${GIT.branch}`);

  const putContent = (path, contentBase64, message, sha = null) =>
    gh(`contents/${encodeURIComponent(path)}`, {
      method: "PUT",
      body: JSON.stringify({
        message, content: contentBase64, branch: GIT.branch, ...(sha ? { sha } : {})
      })
    });

  const toBase64Text = (str) => btoa(unescape(encodeURIComponent(str)));

  const fileToBase64 = (file) => new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const bytes = new Uint8Array(fr.result);
      let bin = "";
      for (let i = 0; i < bytes.byteLength; i++) bin += String.fromCharCode(bytes[i]);
      resolve(btoa(bin));
    };
    fr.onerror = () => reject(fr.error);
    fr.readAsArrayBuffer(file);
  });

  const slugify = (s) =>
    (s || "post")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "")
      .slice(0, 60);

  async function uploadImage(file, baseName) {
    if (!file) return PLACEHOLDER; // no imagen -> placeholder
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const fname = `${baseName}.${ext}`;
    const path = `${PATHS.imgDir}${fname}`;
    const b64 = await fileToBase64(file);

    let sha = null;
    try { const cur = await getContent(path); sha = cur.sha; } catch(_) {}
    await putContent(path, b64, `blog: add image ${fname}`, sha);
    return `/${path}`;
  }

  function buildPostHTML({ title, date, description, image, content, slug }) {
    const safeDesc = description.replace(/"/g, "&quot;");
    const canonical = `https://alexrasa.store/${PATHS.blogDir}${slug}.html`;
    return `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${title} | AlexRaSa</title>
  <meta name="description" content="${safeDesc}" />
  <link rel="canonical" href="${canonical}" />
  <meta name="robots" content="index,follow" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto px-4 py-10">
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
      <img src="${image}" alt="${title}" class="w-full h-auto object-cover aspect-[1200/630] bg-slate-200" />
      <div class="p-6">
        <h1 class="text-3xl font-bold">${title}</h1>
        <p class="mt-2 text-sm text-slate-500">${date}</p>
        <div class="prose prose-slate max-w-none mt-6">${content}</div>
        <div class="mt-8 border-t pt-6">
          <a href="/#contacto" class="inline-flex items-center px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">
            Quiero optimizar mi proceso
          </a>
        </div>
      </div>
    </article>
  </main>
</body>
</html>`;
  }

  async function readPostsJson() {
    try {
      const r = await getContent(PATHS.postsJson);
      const list = JSON.parse(atob(r.content));
      return { list: Array.isArray(list) ? list : [], sha: r.sha };
    } catch {
      return { list: [], sha: null };
    }
  }

  async function updatePostsJson(newPost) {
    const { list, sha } = await readPostsJson();
    const filtered = list.filter(p => p.url !== newPost.url);
    filtered.unshift(newPost);
    const b64 = toBase64Text(JSON.stringify(filtered, null, 2));
    await putContent(PATHS.postsJson, b64, `blog: update posts.json (${newPost.slug})`, sha);
  }

  async function createOrUpdate(path, text) {
    let sha = null;
    try { const cur = await getContent(path); sha = cur.sha; } catch(_) {}
    const b64 = toBase64Text(text);
    await putContent(path, b64, `blog: publish ${path}`, sha);
  }

  // Submit
  document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const status = document.getElementById("status");
    const btn = document.getElementById("publishBtn");
    btn.disabled = true; status.textContent = "Publicando…";

    try {
      const title = document.getElementById("title").value.trim();
      const date  = document.getElementById("date").value || new Date().toISOString().slice(0,10);
      const description = document.getElementById("description").value.trim();
      const content = document.getElementById("content").value.trim();
      const imageFile = document.getElementById("image").files[0] || null;
      const slugInput = document.getElementById("slug").value.trim();
      const slug = slugInput || slugify(title);

      if (!title || !description || !content) throw new Error("Faltan campos obligatorios.");

      // 1) Imagen
      const imageUrl = await uploadImage(imageFile, slug); // absoluta /assets/blog/...
      // 2) HTML del post
      const html = buildPostHTML({ title, date, description, image: imageUrl, content, slug });
      await createOrUpdate(`${PATHS.blogDir}${slug}.html`, html);
      // 3) posts.json
      const newPost = {
        title,
        description,
        image: imageUrl,              // absoluta -> el grid la mostrará
        url: `/${PATHS.blogDir}${slug}.html`,
        date,
        slug
      };
      await updatePostsJson(newPost);

      status.textContent = "Listo. Abre /blog/ para ver el post.";
      console.log("Publicado:", newPost);
    } catch (err) {
      console.error(err);
      status.textContent = "Error: " + err.message;
      alert(err.message);
    } finally {
      btn.disabled = false;
    }
  });
  </script>
</body>
</html>
