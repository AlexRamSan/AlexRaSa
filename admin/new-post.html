<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuevo Post — AlexRaSa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast UI Editor (WYSIWYG) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <style>
    :root{ --brand:#0F172A; --sc-red:#E30613; }
    .brand-gradient{ background:linear-gradient(45deg,#0b1220,#101827); }
    .shadow-soft{ box-shadow:0 10px 30px rgba(2,8,23,.18); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
  <!-- Header -->
  <header class="brand-gradient text-white">
    <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/logo.png" class="h-8 w-auto" alt="AlexRaSa" />
        <h1 class="font-semibold">Panel de Blog</h1>
      </div>
      <a href="/blog/" class="text-sm opacity-90 hover:opacity-100 underline">Ver blog</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 grid lg:grid-cols-2 gap-8">
    <!-- Lado izquierdo: Formulario + Editor -->
    <section class="bg-white rounded-2xl border border-gray-200 shadow-soft p-6">
      <h2 class="text-xl font-semibold mb-5">Nuevo Post</h2>

      <form id="postForm" class="space-y-5">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Título <span class="text-red-500">*</span></label>
            <input id="title" required class="mt-1 w-full border rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Caso de éxito: 80% menos ciclo con iMachining" />
          </div>
          <div>
            <label class="block text-sm font-medium">Fecha</label>
            <input id="date" type="date" class="mt-1 w-full border rounded-md p-2" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">Descripción (SEO) <span class="text-red-500">*</span></label>
          <textarea id="description" rows="2" required class="mt-1 w-full border rounded-md p-2" placeholder="Resumen breve que aparece en tarjetas y buscadores."></textarea>
        </div>

        <!-- Imagen: URL + archivo con preview y drag&drop -->
        <div class="space-y-3">
          <label class="block text-sm font-medium">Imagen principal</label>

          <div class="grid md:grid-cols-3 gap-4 items-start">
            <div class="md:col-span-2 space-y-2">
              <input id="imageUrl" class="w-full border rounded-md p-2" placeholder="/assets/blog/post.jpg (opcional si subes archivo)" />

              <div id="drop" class="flex items-center gap-3 p-3 border rounded-md bg-white">
                <input id="coverInput" type="file" accept="image/*" class="block text-sm">
                <button id="clearCover" type="button" class="px-2 py-1 text-xs border rounded">Quitar archivo</button>
                <span class="text-xs text-gray-500">Arrastra una imagen aquí o selecciónala.</span>
              </div>
            </div>

            <div class="text-sm text-gray-500">
              <div class="aspect-[16/9] rounded-md border overflow-hidden bg-gray-100">
                <img id="imagePreview" alt="" class="w-full h-full object-cover hidden">
              </div>
              <p class="mt-2">Se usa en la tarjeta y en la cabecera del post. Sugerido 1200×630.</p>
            </div>
          </div>
        </div>

        <!-- Botones rápidos de plantillas -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="text-gray-500 mr-1">Plantillas:</span>
          <button type="button" data-tpl="exito" class="tpl-btn px-3 py-1 rounded-full border hover:bg-gray-50">Caso de éxito</button>
          <button type="button" data-tpl="tecnologia" class="tpl-btn px-3 py-1 rounded-full border hover:bg-gray-50">Tecnología</button>
          <button type="button" data-tpl="nota" class="tpl-btn px-3 py-1 rounded-full border hover:bg-gray-50">Nota rápida</button>
        </div>

        <!-- Editor visual -->
        <div>
          <label class="block text-sm font-medium mb-2">Contenido</label>
          <div id="editor" class="border rounded-md overflow-hidden"></div>
          <p class="text-xs text-gray-500 mt-2">Puedes alternar WYSIWYG/Markdown en la barra del editor.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Clave de administrador <span class="text-red-500">*</span></label>
            <input id="adminKey" type="password" required class="mt-1 w-full border rounded-md p-2" placeholder="ADMIN_KEY" />
          </div>
          <div class="flex items-end gap-2">
            <button id="btnPreview" type="button" class="px-4 py-2 rounded-md border">Previsualizar</button>
            <button id="btnPublish" type="submit" class="px-5 py-2 rounded-md text-white" style="background:var(--sc-red)">Publicar</button>
          </div>
        </div>

        <div id="status" class="text-sm mt-1"></div>
      </form>
    </section>

    <!-- Lado derecho: Preview con estilo del sitio -->
    <aside class="space-y-6">
      <!-- Tarjeta estilo /blog -->
      <div class="bg-white rounded-2xl border border-gray-200 shadow-soft p-0 overflow-hidden">
        <div class="aspect-[16/9] bg-gray-100">
          <img id="cardImg" class="w-full h-full object-cover hidden" alt="">
        </div>
        <div class="p-5">
          <span class="text-xs uppercase tracking-wide text-gray-500">Blog</span>
          <h3 id="cardTitle" class="text-xl font-bold mt-1">Título de ejemplo</h3>
          <p id="cardDesc" class="text-gray-600 mt-2">Aquí se verá la descripción corta del post.</p>
          <div class="mt-4 text-sm text-gray-500 flex items-center gap-2">
            <svg viewBox="0 0 24 24" class="h-4 w-4"><path fill="currentColor" d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0-6a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1Zm9 7h-2a1 1 0 1 1 0-2h2a1 1 0 1 1 0 2ZM5 10H3a1 1 0 1 1 0-2h2a1 1 0 1 1 0 2Zm12.657 7.657a1 1 0 0 1 1.414 1.415l-1.414 1.414a1 1 0 0 1-1.415-1.414l1.415-1.415ZM6.343 4.929A1 1 0 0 1 7.758 6.34L6.343 7.757A1 1 0 1 1 4.93 6.343L6.343 4.93Zm11.314 0 1.414 1.414A1 1 0 1 1 17.657 7.76L16.24 6.343A1 1 0 1 1 17.657 4.93ZM6.343 17.657l1.414 1.414a1 1 0 1 1-1.414 1.415L4.93 19.07a1 1 0 1 1 1.414-1.414Z"/></svg>
            <span id="cardDate">—</span>
          </div>
        </div>
      </div>

      <!-- Preview del contenido renderizado -->
      <div class="bg-white rounded-2xl border border-gray-200 shadow-soft p-6">
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Preview del contenido</h4>
        <article id="postPreview" class="prose max-w-none">
          <h2>Encabezado de ejemplo</h2>
          <p>Tu contenido renderizado aparecerá aquí.</p>
        </article>
      </div>
    </aside>
  </main>

 <script>
/* ========= CONFIG ========= */
const GIT = {
  owner: "TU_USUARIO_GITHUB",   // ejemplo: alexrasa
  repo: "TU_REPO",              // ejemplo: alexrasa.store
  branch: "main",
  token: "GITHUB_TOKEN"         // PAT con permisos de repo
};
const PATHS = {
  postsJson: "blog/posts.json",
  blogDir: "blog/",
  imgDir: "assets/blog/"
};
/* ========================== */

// Helpers
const toBase64Text = (txt) => btoa(unescape(encodeURIComponent(txt)));
const slugify = (s) => (s || "post")
  .toLowerCase()
  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/^-+|-+$/g, "")
  .slice(0, 60);

const gh = async (path, opt={}) => {
  const url = `https://api.github.com/repos/${GIT.owner}/${GIT.repo}/${path}`;
  const res = await fetch(url, {
    ...opt,
    headers: {
      "Authorization": `token ${GIT.token}`,
      "Accept": "application/vnd.github+json",
      ...(opt.headers || {})
    }
  });
  if (!res.ok) throw new Error(`GitHub ${res.status}: ${await res.text()}`);
  return res.json();
};

const getContent = (p) => gh(`contents/${encodeURIComponent(p)}?ref=${GIT.branch}`);
const putContent = (p, base64, msg, sha=null) =>
  gh(`contents/${encodeURIComponent(p)}`, {
    method: "PUT",
    body: JSON.stringify({
      message: msg,
      content: base64,
      branch: GIT.branch,
      ...(sha ? { sha } : {})
    })
  });

// ===== Imagen =====
async function uploadImage(base64, ext, slug) {
  const filename = `${slug}.${ext}`;
  const path = `${PATHS.imgDir}${filename}`;
  let sha=null;
  try { const cur=await getContent(path); sha=cur.sha; } catch(_) {}
  await putContent(path, base64, `blog: add image ${filename}`, sha);
  return `/${path}`;
}

// ===== HTML del post =====
function buildPostHTML({title, description, date, image, content, slug}) {
  return `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${title} | AlexRaSa</title>
  <meta name="description" content="${description.replace(/"/g,'&quot;')}" />
  <link rel="canonical" href="https://alexrasa.store/${PATHS.blogDir}${slug}.html" />
  <meta name="robots" content="index,follow" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto px-4 py-10">
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
      <img src="${image}" alt="${title}" class="w-full h-auto object-cover aspect-[1200/630] bg-slate-200" />
      <div class="p-6">
        <h1 class="text-3xl font-bold">${title}</h1>
        <p class="mt-2 text-sm text-slate-500">${date}</p>
        <div class="prose prose-slate max-w-none mt-6">${content}</div>
        <div class="mt-8 border-t pt-6">
          <a href="/#contacto" class="inline-flex items-center px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">
            Quiero optimizar mi proceso
          </a>
        </div>
      </div>
    </article>
  </main>
</body>
</html>`;
}

// ===== posts.json =====
async function readPostsJson() {
  try {
    const r = await getContent(PATHS.postsJson);
    return { list: JSON.parse(atob(r.content)), sha: r.sha };
  } catch {
    return { list: [], sha: null };
  }
}
async function updatePostsJson(newPost) {
  const { list, sha } = await readPostsJson();
  const clean = list.filter(p => p.url !== newPost.url);
  clean.unshift(newPost);
  const b64 = toBase64Text(JSON.stringify(clean, null, 2));
  await putContent(PATHS.postsJson, b64, `blog: update posts.json (${newPost.slug})`, sha);
}

// ===== Eventos =====
document.querySelector("#postForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const statusEl = document.querySelector("#status");
  const adminKey = document.querySelector("#adminKey").value.trim();
  const btn = document.querySelector("#btnPublish");
  btn.disabled = true; statusEl.textContent = "Publicando…";

  try {
    // Campos
    const title = document.querySelector("#title").value.trim();
    const description = document.querySelector("#description").value.trim();
    const content = editor.getHTML();
    const date = document.querySelector("#date").value || new Date().toISOString().slice(0,10);
    const imageUrl = document.querySelector("#imageUrl").value.trim();
    const slug = slugify(title);

    if (!title || !description || !content)
      throw new Error("Completa título, descripción y contenido.");

    // Imagen
    let imageFinal = imageUrl;
    if (!imageUrl && imageData) {
      imageFinal = await uploadImage(imageData, imageExt || "jpg", slug);
    }

    // Crear HTML del post
    const html = buildPostHTML({title, description, date, image: imageFinal, content, slug});
    const htmlPath = `${PATHS.blogDir}${slug}.html`;
    let sha=null; try { const cur=await getContent(htmlPath); sha=cur.sha; } catch(_) {}
    await putContent(htmlPath, toBase64Text(html), `blog: publish ${slug}`, sha);

    // Actualizar JSON
    const newPost = { title, description, image: imageFinal, url:`/${htmlPath}`, date, slug };
    await updatePostsJson(newPost);

    statusEl.innerHTML = `✅ Publicado: <a href="${newPost.url}" target="_blank" class="text-blue-600 underline">${newPost.url}</a>`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error: " + err.message;
  } finally {
    btn.disabled = false;
  }
});
</script>

</body>
</html>
