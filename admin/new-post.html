<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuevo Post — AlexRaSa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <!-- Plugin: Code Syntax Highlight (incluye Java) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css" />
  <script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>

  <style>
    :root {
      --brand:#0F172A;
      --sc-red:#E30613;
    }
    .brand-gradient{ background:linear-gradient(135deg,#020617,#0b1220,#0f172a); }
    .shadow-soft{ box-shadow:0 16px 40px rgba(15,23,42,.18); }

    #editor, .toastui-editor-defaultUI { min-height: 500px; }

    body { font-size: 14px; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900 antialiased">

  <!-- Header -->
  <header class="brand-gradient text-white border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-white/5 flex items-center justify-center shadow-sm border border-white/10">
          <img src="/assets/logo.png" class="h-6 w-auto" alt="AlexRaSa" />
        </div>
        <div>
          <h1 class="font-semibold leading-tight">Panel de Blog</h1>
          <p class="text-xs text-slate-200/80">Crea y publica artículos para alexrasa.store</p>
        </div>
      </div>
      <a href="/blog/" class="text-xs sm:text-sm inline-flex items-center gap-1 opacity-90 hover:opacity-100 underline-offset-4 hover:underline">
        Ver blog
        <span aria-hidden="true">↗</span>
      </a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-10">
    <!-- Título de sección -->
    <div class="mb-6 flex items-center justify-between gap-3">
      <div>
        <h2 class="text-xl md:text-2xl font-semibold text-slate-900 tracking-tight">Nuevo post</h2>
        <p class="mt-1 text-xs sm:text-sm text-slate-600">
          Completa los campos, revisa la vista previa y publica en un solo lugar.
        </p>
      </div>
    </div>

    <!-- Layout principal -->
    <div class="grid lg:grid-cols-[minmax(0,1.25fr)_minmax(0,1fr)] gap-8 lg:gap-10 xl:gap-12 items-start">

      <!-- Izquierda: Formulario + Editor -->
      <section class="bg-white rounded-2xl border border-slate-200 shadow-soft p-5 sm:p-6 lg:p-7">
        <form id="postForm" class="space-y-6">
          <!-- Meta básica -->
          <div class="space-y-4 pb-5 border-b border-slate-100">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-slate-700 uppercase tracking-wide">
                  Título <span class="text-red-500">*</span>
                </label>
                <input
                  id="title"
                  required
                  class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  placeholder="Caso de éxito: 80% menos ciclo con iMachining"
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700 uppercase tracking-wide">
                  Fecha
                </label>
                <input
                  id="date"
                  type="date"
                  class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                />
              </div>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-700 uppercase tracking-wide">
                Descripción (SEO) <span class="text-red-500">*</span>
              </label>
              <textarea
                id="description"
                rows="2"
                required
                class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 resize-none"
                placeholder="Resumen breve que aparece en tarjetas y buscadores."
              ></textarea>
            </div>
          </div>

          <!-- Imagen -->
          <div class="space-y-3 pb-5 border-b border-slate-100">
            <div class="flex items-center justify-between gap-2">
              <h3 class="text-sm font-semibold text-slate-800">Imagen principal</h3>
              <p class="text-xs text-slate-500">Sugerido 1200×630 (16:9)</p>
            </div>

            <div class="grid md:grid-cols-[minmax(0,1.4fr)_minmax(0,1fr)] gap-5 items-start">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-slate-600 mb-1">URL (opcional)</label>
                  <input
                    id="imageUrl"
                    class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                    placeholder="/assets/blog/post.jpg"
                  />
                </div>

                <div
                  id="drop"
                  class="flex flex-wrap items-center gap-3 px-3 py-3 border border-dashed border-slate-300 rounded-lg bg-slate-50/60 hover:bg-slate-50 transition-colors"
                >
                  <div class="shrink-0">
                    <input id="coverInput" type="file" accept="image/*" class="block text-xs text-slate-700" />
                  </div>
                  <button
                    id="clearCover"
                    type="button"
                    class="px-2.5 py-1 text-[11px] border border-slate-300 rounded-full text-slate-600 hover:bg-slate-100"
                  >
                    Quitar archivo
                  </button>
                  <span class="text-xs text-slate-500">
                    Puedes arrastrar una imagen aquí o seleccionarla desde tu equipo. Máx. 6 MB.
                  </span>
                </div>
              </div>

              <div class="space-y-2 text-xs text-slate-500">
                <div class="aspect-[16/9] rounded-lg border border-slate-200 overflow-hidden bg-slate-100">
                  <img id="imagePreview" alt="" class="w-full h-full object-cover hidden">
                </div>
                <p>
                  Esta imagen se usará en la tarjeta del blog y en la cabecera del post.
                </p>
              </div>
            </div>
          </div>

          <!-- Editor visual -->
          <div class="space-y-2 pb-5 border-b border-slate-100">
            <div class="flex items-center justify-between gap-2">
              <label class="block text-xs font-medium text-slate-700 uppercase tracking-wide">
                Contenido
              </label>
              <p class="text-[11px] text-slate-500">
                Puedes alternar WYSIWYG / Markdown en la barra del editor.
              </p>
            </div>
            <div id="editor" class="border border-slate-300 rounded-xl overflow-hidden bg-white"></div>
          </div>

          <!-- Seguridad y acciones -->
          <div class="space-y-4">
            <div class="grid md:grid-cols-[minmax(0,1.1fr)_auto] gap-4 items-end">
              <div>
                <label class="block text-xs font-medium text-slate-700 uppercase tracking-wide">
                  Clave de administrador <span class="text-red-500">*</span>
                </label>
                <input
                  id="adminKey"
                  type="password"
                  required
                  class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  placeholder="ADMIN_KEY"
                />
              </div>
              <div class="flex flex-wrap justify-end gap-2">
                <button
                  id="btnPreview"
                  type="button"
                  class="px-4 py-2 rounded-lg border border-slate-300 text-sm text-slate-700 bg-white hover:bg-slate-50"
                >
                  Previsualizar contenido
                </button>
                <button
                  id="btnPublish"
                  type="submit"
                  class="px-5 py-2 rounded-lg text-sm font-medium text-white shadow-sm hover:shadow bg-[var(--sc-red)] hover:opacity-95"
                >
                  Publicar
                </button>
              </div>
            </div>

            <div id="status" class="text-xs sm:text-sm mt-1 text-slate-700"></div>
          </div>
        </form>
      </section>

      <!-- Derecha: Preview -->
      <aside class="space-y-6 lg:space-y-7 lg:sticky lg:top-24 h-fit">
        <!-- Tarjeta -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-soft overflow-hidden">
          <div class="aspect-[16/9] bg-slate-100">
            <img id="cardImg" class="w-full h-full object-cover hidden" alt="">
          </div>
          <div class="p-5 sm:p-6">
            <span class="inline-flex items-center rounded-full bg-slate-100 text-[11px] font-medium uppercase tracking-wide text-slate-600 px-2 py-0.5">
              Blog
            </span>
            <h3 id="cardTitle" class="text-lg md:text-xl font-semibold mt-2 text-slate-900">
              Título de ejemplo
            </h3>
            <p id="cardDesc" class="text-sm text-slate-600 mt-2">
              Aquí se verá la descripción corta del post.
            </p>
            <div class="mt-4 text-xs text-slate-500 flex items-center gap-2">
              <span class="inline-block w-1 h-1 rounded-full bg-slate-400"></span>
              <span id="cardDate">—</span>
            </div>
          </div>
        </div>

        <!-- Preview del contenido -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-soft p-5 sm:p-6">
          <h4 class="text-xs font-medium text-slate-700 uppercase tracking-wide mb-3">
            Preview del contenido
          </h4>
          <article id="postPreview" class="prose prose-sm max-w-none prose-slate">
            <h2>Encabezado de ejemplo</h2>
            <p>Tu contenido renderizado aparecerá aquí cuando presiones "Previsualizar contenido".</p>
          </article>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ===== Editor =====
    const editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      usageStatistics: false,
      toolbarItems: [
        ['heading','bold','italic','strike'],
        ['hr','quote'],
        ['ul','ol','task'],
        ['table','link'],
        ['code','codeblock'],
        ['image']
      ],
      // Plugin de resaltado (incluye Java)
      plugins: [toastui.Editor.plugin.codeSyntaxHighlight],
      hooks: {
        // Inserta la imagen como dataURL (base64) sin pedir URL manualmente
        addImageBlobHook: (blob, callback) => {
          const reader = new FileReader();
          reader.onload = () => {
            callback(reader.result, 'image'); // src = data:image/...
          };
          reader.readAsDataURL(blob);
          return false; // evita comportamiento por defecto
        }
      }
    });

    // ===== Helpers DOM =====
    const $ = (s)=>document.querySelector(s);

    const titleEl     = $('#title');
    const dateEl      = $('#date');
    const descEl      = $('#description');
    const imageUrlEl  = $('#imageUrl');
    const imagePrev   = $('#imagePreview');
    const statusEl    = $('#status');
    const cardImg     = $('#cardImg');
    const cardTitle   = $('#cardTitle');
    const cardDesc    = $('#cardDesc');
    const cardDate    = $('#cardDate');
    const postPreview = $('#postPreview');

    // Imagen por archivo (portada)
    let imageData=null, imageExt=null, imageName=null;
    const coverInput = $('#coverInput');
    const clearCover = $('#clearCover');
    const drop       = $('#drop');

    // Fecha por defecto hoy
    dateEl.valueAsDate = new Date();

    // Preview URL directa
    imageUrlEl.addEventListener('input', ()=>{
      const v = imageUrlEl.value.trim();
      if(v){
        imagePrev.src = v;
        imagePrev.classList.remove('hidden');
        cardImg.src = v;
        cardImg.classList.remove('hidden');
      } else {
        imagePrev.classList.add('hidden');
        cardImg.classList.add('hidden');
      }
    });

    // Archivo -> base64 + preview (portada)
    coverInput.addEventListener('change', async ()=>{
      const f = coverInput.files?.[0];
      if(!f) return clearImage();

      if (f.size > 6*1024*1024) {
        alert('Imagen > 6 MB');
        return clearImage();
      }

      imageExt  = (f.name.split('.').pop()||'jpg').toLowerCase().replace(/[^a-z0-9]/g,'');
      imageName = f.name;

      const r = new FileReader();
      r.onload = () => {
        const u = String(r.result);
        imageData = u.split(',')[1];
        imagePrev.src = u;
        imagePrev.classList.remove('hidden');
        cardImg.src = u;
        cardImg.classList.remove('hidden');
      };
      r.readAsDataURL(f);
    });

    clearCover.addEventListener('click', clearImage);

    function clearImage(){
      imageData=null;
      imageExt=null;
      imageName=null;
      coverInput.value='';
      imagePrev.removeAttribute('src');
      imagePrev.classList.add('hidden');
      cardImg.removeAttribute('src');
      cardImg.classList.add('hidden');
    }

    // Drag & drop (portada)
    ['dragenter','dragover'].forEach(ev =>
      drop.addEventListener(ev, e=>{
        e.preventDefault();
        drop.classList.add('ring','ring-sky-300','bg-slate-50');
      })
    );
    ['dragleave','drop'].forEach(ev =>
      drop.addEventListener(ev, e=>{
        e.preventDefault();
        drop.classList.remove('ring','ring-sky-300','bg-slate-50');
      })
    );
    drop.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if(f){
        coverInput.files = e.dataTransfer.files;
        coverInput.dispatchEvent(new Event('change'));
      }
    });

    // Tarjeta y preview
    function updateCard(){
      cardTitle.textContent = titleEl.value || 'Título de ejemplo';
      cardDesc.textContent  = descEl.value || 'Aquí se verá la descripción corta del post.';
      cardDate.textContent  = dateEl.value || new Date().toISOString().slice(0,10);
    }
    titleEl.addEventListener('input', updateCard);
    descEl.addEventListener('input', updateCard);
    dateEl.addEventListener('change', updateCard);
    updateCard();

    function renderPreview(){
      postPreview.innerHTML = editor.getHTML();
    }
    $('#btnPreview').addEventListener('click', renderPreview);

    // ===== Publicar (usa tu API) =====
    $('#postForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const payload = {
        title: titleEl.value.trim(),
        description: descEl.value.trim(),
        image: imageUrlEl.value.trim(),   // si pegaste URL
        imageData, imageExt, imageName,   // si subiste archivo de portada
        content: editor.getHTML(),        // HTML del editor
        date: dateEl.value || undefined
      };
      const adminKey = $('#adminKey').value.trim();

      const btn = $('#btnPublish');
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Publicando…';
      statusEl.textContent = '';

      try {
        const resp = await fetch('/api/new-post', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+adminKey
          },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data?.error || 'Error al publicar');

        statusEl.textContent = '✔️ Publicado';
        if (data?.url) {
          const link = document.createElement('a');
          link.href = data.url;
          link.target = '_blank';
          link.rel = 'noopener';
          link.className = 'text-sky-600 underline ml-2';
          link.textContent = data.url;
          statusEl.appendChild(link);
        }
      } catch(err){
        statusEl.textContent = 'Error: '+err.message;
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  </script>
  <script src="/assets/js/cnc-express-popup.js" defer></script>
</body>
</html>
