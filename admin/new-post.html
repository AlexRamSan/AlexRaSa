<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuevo Post — AlexRaSa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast UI Editor (WYSIWYG) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <style>
    :root{ --brand:#0F172A; --sc-red:#E30613; }
    .brand-gradient{ background:linear-gradient(45deg,#0b1220,#101827); }
    .shadow-soft{ box-shadow:0 10px 30px rgba(2,8,23,.18); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
  <!-- Header -->
  <header class="brand-gradient text-white">
    <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/logo.png" class="h-8 w-auto" alt="AlexRaSa" />
        <h1 class="font-semibold">Panel de Blog</h1>
      </div>
      <a href="/blog/" class="text-sm opacity-90 hover:opacity-100 underline">Ver blog</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 grid lg:grid-cols-2 gap-8">
    <!-- Lado izquierdo: Formulario + Editor -->
    <section class="bg-white rounded-2xl border border-gray-200 shadow-soft p-6">
      <h2 class="text-xl font-semibold mb-5">Nuevo Post</h2>

      <form id="postForm" class="space-y-5">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Título <span class="text-red-500">*</span></label>
            <input id="title" required class="mt-1 w-full border rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Caso de éxito: 80% menos ciclo con iMachining" />
          </div>
          <div>
            <label class="block text-sm font-medium">Fecha</label>
            <input id="date" type="date" class="mt-1 w-full border rounded-md p-2" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">Descripción (SEO) <span class="text-red-500">*</span></label>
          <textarea id="description" rows="2" required class="mt-1 w-full border rounded-md p-2" placeholder="Resumen breve que aparece en tarjetas y buscadores."></textarea>
        </div>

        <!-- Imagen: URL + archivo con preview y drag&drop -->
        <div class="space-y-3">
          <label class="block text-sm font-medium">Imagen principal</label>

          <div class="grid md:grid-cols-3 gap-4 items-start">
            <div class="md:col-span-2 space-y-2">
              <input id="imageUrl" class="w-full border rounded-md p-2" placeholder="/assets/blog/post.jpg (opcional si subes archivo)" />

              <div id="drop" class="flex items-center gap-3 p-3 border rounded-md bg-white">
                <input id="coverInput" type="file" accept="image/*" class="block text-sm">
                <button id="clearCover" type="button" class="px-2 py-1 text-xs border rounded">Quitar archivo</button>
                <span class="text-xs text-gray-500">Arrastra una imagen aquí o selecciónala.</span>
              </div>
            </div>

            <div class="text-sm text-gray-500">
              <div class="aspect-[16/9] rounded-md border overflow-hidden bg-gray-100">
                <img id="imagePreview" alt="" class="w-full h-full object-cover hidden">
              </div>
              <p class="mt-2">Se usa en la tarjeta y en la cabecera del post. Sugerido 1200×630.</p>
            </div>
          </div>
        </div>

        <!-- Botones rápidos de plantillas -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="text-gray-500 mr-1">Plantillas:</span>
          <button type="button" data-tpl="exito" class="tpl-btn px-3 py-1 rounded-full border hover:bg-gray-50">Caso de éxito</button>
          <button type="button" data-tpl="tecnologia" class="tpl-btn px-3 py-1 rounded-full border hover:bg-gray-50">Tecnología</button>
          <button type="button" data-tpl="nota" class="tpl-btn px-3 py-1 rounded-full border hover:bg-gray-50">Nota rápida</button>
        </div>

        <!-- Editor visual -->
        <div>
          <label class="block text-sm font-medium mb-2">Contenido</label>
          <div id="editor" class="border rounded-md overflow-hidden"></div>
          <p class="text-xs text-gray-500 mt-2">Puedes alternar WYSIWYG/Markdown en la barra del editor.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Clave de administrador <span class="text-red-500">*</span></label>
            <input id="adminKey" type="password" required class="mt-1 w-full border rounded-md p-2" placeholder="ADMIN_KEY" />
          </div>
          <div class="flex items-end gap-2">
            <button id="btnPreview" type="button" class="px-4 py-2 rounded-md border">Previsualizar</button>
            <button id="btnPublish" type="submit" class="px-5 py-2 rounded-md text-white" style="background:var(--sc-red)">Publicar</button>
          </div>
        </div>

        <div id="status" class="text-sm mt-1"></div>
      </form>
    </section>

    <!-- Lado derecho: Preview con estilo del sitio -->
    <aside class="space-y-6">
      <!-- Tarjeta estilo /blog -->
      <div class="bg-white rounded-2xl border border-gray-200 shadow-soft p-0 overflow-hidden">
        <div class="aspect-[16/9] bg-gray-100">
          <img id="cardImg" class="w-full h-full object-cover hidden" alt="">
        </div>
        <div class="p-5">
          <span class="text-xs uppercase tracking-wide text-gray-500">Blog</span>
          <h3 id="cardTitle" class="text-xl font-bold mt-1">Título de ejemplo</h3>
          <p id="cardDesc" class="text-gray-600 mt-2">Aquí se verá la descripción corta del post.</p>
          <div class="mt-4 text-sm text-gray-500 flex items-center gap-2">
            <svg viewBox="0 0 24 24" class="h-4 w-4"><path fill="currentColor" d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0-6a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1Zm9 7h-2a1 1 0 1 1 0-2h2a1 1 0 1 1 0 2ZM5 10H3a1 1 0 1 1 0-2h2a1 1 0 1 1 0 2Zm12.657 7.657a1 1 0 0 1 1.414 1.415l-1.414 1.414a1 1 0 0 1-1.415-1.414l1.415-1.415ZM6.343 4.929A1 1 0 0 1 7.758 6.34L6.343 7.757A1 1 0 1 1 4.93 6.343L6.343 4.93Zm11.314 0 1.414 1.414A1 1 0 1 1 17.657 7.76L16.24 6.343A1 1 0 1 1 17.657 4.93ZM6.343 17.657l1.414 1.414a1 1 0 1 1-1.414 1.415L4.93 19.07a1 1 0 1 1 1.414-1.414Z"/></svg>
            <span id="cardDate">—</span>
          </div>
        </div>
      </div>

      <!-- Preview del contenido renderizado -->
      <div class="bg-white rounded-2xl border border-gray-200 shadow-soft p-6">
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Preview del contenido</h4>
        <article id="postPreview" class="prose max-w-none">
          <h2>Encabezado de ejemplo</h2>
          <p>Tu contenido renderizado aparecerá aquí.</p>
        </article>
      </div>
    </aside>
  </main>

  <script>
    // ---- Editor ----
    const editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      usageStatistics: false,
      toolbarItems: [
        ['heading','bold','italic','strike'],
        ['hr','quote'],
        ['ul','ol','task'],
        ['table','link'],
        ['code','codeblock'],
        ['image']
      ],
      hooks: {
        addImageBlobHook: async (blob, callback) => {
          const url = prompt('URL de la imagen:');
          if (url) callback(url, 'image');
        }
      }
    });

    // ---- DOM ----
    const $ = (s)=>document.querySelector(s);
    const titleEl = $('#title');
    const dateEl  = $('#date');
    const descEl  = $('#description');
    const imageUrlEl = $('#imageUrl');
    const imagePrev = $('#imagePreview');
    const statusEl = $('#status');
    const cardImg = $('#cardImg');
    const cardTitle = $('#cardTitle');
    const cardDesc  = $('#cardDesc');
    const cardDate  = $('#cardDate');
    const postPreview = $('#postPreview');

    // Imagen por archivo
    let imageData=null, imageExt=null, imageName=null;
    const coverInput=$('#coverInput');
    const clearCover=$('#clearCover');
    const drop=$('#drop');

    // Fecha por defecto hoy
    dateEl.valueAsDate = new Date();

    // Preview URL
    imageUrlEl.addEventListener('input', ()=>{
      const v=imageUrlEl.value.trim();
      if(v){ imagePrev.src=v; imagePrev.classList.remove('hidden'); cardImg.src=v; cardImg.classList.remove('hidden'); }
      else { imagePrev.classList.add('hidden'); cardImg.classList.add('hidden'); }
    });

    // Archivo -> base64 + preview
    coverInput.addEventListener('change', async ()=>{
      const f = coverInput.files?.[0]; if(!f) return clearImage();
      if (f.size > 6*1024*1024) { alert('Imagen > 6 MB'); return clearImage(); }
      imageExt=(f.name.split('.').pop()||'jpg').toLowerCase().replace(/[^a-z0-9]/g,'');
      imageName=f.name;
      const r=new FileReader();
      r.onload=()=>{ const u=String(r.result); imageData=u.split(',')[1]; imagePrev.src=u; imagePrev.classList.remove('hidden'); cardImg.src=u; cardImg.classList.remove('hidden'); };
      r.readAsDataURL(f);
    });
    clearCover.addEventListener('click', clearImage);
    function clearImage(){ imageData=null; imageExt=null; imageName=null; coverInput.value=''; imagePrev.removeAttribute('src'); imagePrev.classList.add('hidden'); }

    // Drag & drop
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('ring','ring-blue-300');}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('ring','ring-blue-300');}));
    drop.addEventListener('drop', e => { const f=e.dataTransfer.files?.[0]; if(f){ coverInput.files=e.dataTransfer.files; coverInput.dispatchEvent(new Event('change')); }});

    // Tarjeta y preview
    function updateCard(){
      cardTitle.textContent = titleEl.value || 'Título de ejemplo';
      cardDesc.textContent  = descEl.value || 'Aquí se verá la descripción corta del post.';
      cardDate.textContent  = dateEl.value || new Date().toISOString().slice(0,10);
    }
    titleEl.addEventListener('input', updateCard);
    descEl.addEventListener('input', updateCard);
    dateEl.addEventListener('change', updateCard);
    updateCard();

    function renderPreview(){ postPreview.innerHTML = editor.getHTML(); }
    $('#btnPreview').addEventListener('click', renderPreview);
    renderPreview();

    // ---- Publicar ----
    $('#postForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent = 'Publicando…';

      const payload = {
        title: titleEl.value.trim(),
        description: descEl.value.trim(),
        image: imageUrlEl.value.trim(),   // si pegaste URL
        imageData, imageExt, imageName,   // si subiste archivo
        content: editor.getHTML(),        // HTML del editor
        date: dateEl.value || undefined
      };

      const adminKey = $('#adminKey').value.trim();

      try {
        const resp = await fetch('/api/new-post', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+adminKey },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data?.error || 'Error al publicar');

        statusEl.innerHTML = `✔️ Publicado: <a class="text-blue-600 underline" href="${data.url}" target="_blank" rel="noopener">${data.url}</a>`;
      } catch(err){
        statusEl.textContent = 'Error: '+err.message;
        console.error(err);
      }
    });
  </script>
</body>
</html>
