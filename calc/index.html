<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de RPM y avance — extendida</title>
  <meta name="description" content="Calcula RPM, avance, MRR, potencia, torque, deflexión, Ra y riesgo de vibración. Presets por material, máquina, operación y herramienta. Métrico/imperial." />
  <link rel="canonical" href="https://alexrasa.store/blog/calculadora-rpm-avance.html" />
  <!-- Forzar modo oscuro SIEMPRE -->
  <meta name="color-scheme" content="dark" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Dependencias para generación PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ==== TEMA SIEMPRE OSCURO ==== */
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefb; --muted:#9fb3c8; --border:#1f2a3a;
      --accent:#0ea5e9; --rose:#e11d48; --emerald:#10b981; --indigo:#6366f1;
    }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--ink)}
    .container{max-width:1180px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .lead{color:var(--muted)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);padding:.6rem .9rem;border-radius:10px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#061018}
    .btn:hover{filter:brightness(.98)}
    .tab{padding:.6rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(148,163,184,.08)}
    .tab.is-on{background:var(--accent);border-color:var(--accent);color:#061018}
    .field>label{display:block;font-size:.75rem;color:var(--muted);margin-bottom:.25rem}
    .field>input,.field>select{width:100%;border-radius:10px;padding:.6rem .7rem;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--ink)}
    .field>input::placeholder{color:var(--muted)}
    .kpi{font-weight:700}
    .kpi-value{font-size:1.35rem;color:#eaf2ff;text-shadow:0 0 0.5px #a5c3ff,0 0 12px rgba(56,189,248,.35)}
    .pill{font-size:.7rem;border:1px solid var(--border);border-radius:999px;padding:.12rem .5rem;color:var(--muted)}
    .vibe-box{background:rgba(148,163,184,.08);border:1px dashed var(--border);border-radius:12px;padding:16px;transition:background .18s,border-color .18s}
    .vibe-box code{color:#cde6ff}
    #matNotes{white-space:normal;overflow:visible;text-overflow:unset;display:block;color:var(--muted)}
    select, option{ color: var(--ink); background-color: var(--card); }
    select:focus{ outline:2px solid var(--accent); outline-offset:1px }
    @supports (color-scheme: dark){ select, option{ color-scheme: dark; } }
    .vibe-box.ok   { border-color:#16a34a; background:rgba(22,163,74,.08) }
    .vibe-box.warn { border-color:#f59e0b; background:rgba(245,158,11,.10) }
    .vibe-box.bad  { border-color:#ef4444; background:rgba(239,68,68,.10) }
    .badge{font-size:.72rem;border-radius:999px;padding:.15rem .5rem;border:1px solid var(--border)}
    .badge.ok{background:#052e1b;color:#86efac;border-color:#166534}
    .badge.warn{background:#3a2801;color:#fde68a;border-color:#b45309}
    .badge.bad{background:#3b0a0a;color:#fecaca;border-color:#b91c1c}
    .hint{color:var(--muted);font-size:.75rem}
    .canvas-wrap{width:100%;height:220px}
    .canvas-wrap canvas{width:100%;height:100%}

    /* Nota: NO ocultamos la clase .pdf-template-root globalmente porque el clon necesita renderizarse.
       En cambio eliminamos cualquier elemento legado que estuviera en el DOM fuera de un <template>. */
  </style>
</head>
<body>
  <!-- HERO -->
  <section class="relative">
    <div class="absolute inset-0 -z-10">
      <div class="absolute inset-0 bg-[url('/assets/hero-industrial.png')] bg-cover bg-center opacity-70"></div>
      <div class="absolute inset-0 bg-slate-900/60"></div>
    </div>
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">Calculadora de <span class="text-sky-300">RPM</span> y <span class="text-sky-300">avance</span> · Pro</h1>
      <p class="lead mt-2">MRR, potencia, torque, deflexión, Ra y vibración. Presets por material, máquina, operación y herramienta.</p>
      <div class="mt-3 flex gap-2"><span class="pill">SolidCAM</span><span class="pill">iMachining</span><span class="pill">QA</span></div>
    </div>
  </section>

  <main class="container mx-auto px-4 pb-24">
    <!-- (contenido de la calculadora idéntico al que enviaste) -->
    <!-- Mantén exactamente tu markup de inputs/resultados aquí (no lo reescribo para no duplicarlo) -->
    <!-- START calculadora: pega tu sección tal cual aquí si la separas en otro archivo -->
    <!-- END calculadora -->

    <!-- TEMPLATE: REPORTE PDF A4 COMPLETO (queda dentro de <template>; no está en DOM hasta generar) -->
    <template id="pdf-template">
      <div class="pdf-template-root" style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
                width:794px; min-height:1123px;
                background:#f3f4f6; color:#0f172a;
                margin:0; padding:0;">
        <!-- Header -->
        <div style="background:#0f172a; color:white; padding:16px 20px; border-radius:14px 14px 0 0;
                    display:flex; justify-content:space-between; gap:12px; align-items:center;">
          <div>
            <div style="font-size:13px; opacity:.8;">Reporte de condiciones de maquinado</div>
            <div style="font-size:19px; font-weight:700;">Calculadora RPM y Avance — Pro</div>
          </div>
          <div style="text-align:right;">
            <div style="background:rgba(15,23,42,.35); border:1px solid rgba(148,163,184,.35); border-radius:999px;
                        padding:4px 12px; font-size:12px;">AlexRaSa — Manufactura CNC</div>
            <div id="rptDate" style="font-size:11px; opacity:.6; margin-top:4px;"></div>
          </div>
        </div>

        <!-- Body -->
        <div style="padding:18px 20px 10px 20px;">
          <!-- Contexto -->
          <div style="font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:#4b5563; margin-bottom:8px;">Contexto</div>
          <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; margin-bottom:16px;">
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px;">
              <div style="font-size:11px; color:#6b7280;">Material de pieza</div>
              <div id="rptMaterial" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px;">
              <div style="font-size:11px; color:#6b7280;">Operación</div>
              <div id="rptOp" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px;">
              <div style="font-size:11px; color:#6b7280;">Máquina</div>
              <div id="rptMachine" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px;">
              <div style="font-size:11px; color:#6b7280;">Holder</div>
              <div id="rptHolder" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px;">
              <div style="font-size:11px; color:#6b7280;">Tipo de herramienta</div>
              <div id="rptToolType" style="font-size:13px; font-weight:600;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px;">
              <div style="font-size:11px; color:#6b7280;">Material de herramienta</div>
              <div id="rptToolMat" style="font-size:13px; font-weight:600;">—</div>
            </div>
          </div>

          <!-- Parámetros -->
          <div style="font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:#4b5563; margin-bottom:8px;">Parámetros calculados</div>
          <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-bottom:16px;">
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">Diámetro</div>
              <div id="rptDiam" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">RPM</div>
              <div id="rptRPM" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">Avance</div>
              <div id="rptFeed" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">MRR</div>
              <div id="rptMRR" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">Potencia</div>
              <div id="rptPwr" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">Torque</div>
              <div id="rptTq" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">Carga husillo</div>
              <div id="rptLoad" style="font-size:16px; font-weight:700;">—</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;">
              <div style="font-size:11px; color:#6b7280;">Ra estimado</div>
              <div id="rptRa" style="font-size:16px; font-weight:700;">—</div>
            </div>
          </div>

          <!-- Vibración -->
          <div style="font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:#4b5563; margin-bottom:8px;">Vibración</div>
          <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <div id="rptVibeState" style="font-size:11px; font-weight:600; background:#e5e7eb; padding:3px 10px; border-radius:999px;">—</div>
              <div style="font-size:11px; color:#6b7280;">Evaluación dinámica por L/D, ae, ap y banda evitada</div>
            </div>
            <div id="rptVibe" style="font-size:12px; color:#111827; line-height:1.4;">—</div>
          </div>

          <!-- Relleno para que no quede sábana -->
          <div style="display:grid; grid-template-columns:1.4fr .6fr; gap:14px; margin-top:18px;">
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-height:120px;">
              <div style="font-size:11px; color:#6b7280; margin-bottom:4px;">Notas</div>
              <div style="font-size:12px; color:#111827;">Ajustar en máquina real según herramienta instalada, sujeción, condiciones de corte del proveedor (Sandvik, Seco, Kennametal, Iscar, etc.) y política interna de la planta. Generado desde alexrasa.store.</div>
            </div>
            <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-height:120px;">
              <div style="font-size:11px; color:#6b7280; margin-bottom:18px;">Aprobación</div>
              <div style="height:38px; border-bottom:1px solid #e5e7eb;"></div>
              <div style="font-size:10px; color:#6b7280; margin-top:4px;">Firma / fecha</div>
            </div>
          </div>
        </div>

        <!-- Footer fijo para llenar hasta abajo -->
        <div style="margin-top:10px; padding:8px 20px 14px 20px; text-align:right; font-size:10px; color:#9ca3af;">
          Reporte generado automáticamente · alexrasa.store · Página 1/1
        </div>
      </div>
    </template>
    <!-- FIN TEMPLATE -->
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt0 = (n)=>Number.isFinite(n)?Math.round(n).toLocaleString('es-MX'):'—';
    const fmt1 = (n)=>Number.isFinite(n)?(Math.round(n*10)/10).toLocaleString('es-MX'):'—';
    const fmt2 = (n)=>Number.isFinite(n)?(Math.round(n*100)/100).toLocaleString('es-MX'):'—';

    let DATA={materials:[], holders:[], vibration:{}, defaults:{}, machine_profiles:[], tool_types:[], tool_materials:[], operations:[]}, units='metric';

    /****************************************************************
     * LIMPIEZA INICIAL Y OBSERVER
     * - Borra cualquier bloque legado que tenga id="pdf-report"
     * - Borra cualquier .pdf-template-root que esté fuera de un <template>
     * - Observador corta re-inyecciones por 15s
     ****************************************************************/
    (function cleanupLegacyPdfReport(){
      try{
        // borrar id legacy
        document.querySelectorAll('#pdf-report').forEach(n => n.remove());
        // borrar clones legacy con id pdf-report-clone si quedaran
        document.querySelectorAll('#pdf-report-clone').forEach(n => n.remove());
        // borrar cualquier .pdf-template-root que NO esté dentro de un <template>
        document.querySelectorAll('.pdf-template-root').forEach(el=>{
          if(!el.closest('template')) el.remove();
        });
      }catch(e){
        console.warn('cleanupLegacyPdfReport error', e);
      }

      // Observador para bloquear re-inyecciones accidentales (ej. scripts externos)
      window._pdfGenerationInProgress = false;
      const mo = new MutationObserver((mutList)=>{
        if(window._pdfGenerationInProgress) return; // si estamos generando PDF, no tocamos
        for(const m of mutList){
          for(const n of m.addedNodes){
            try{
              if(!(n && (n.nodeType === 1))) continue;
              if(n.id === 'pdf-report' || n.id === 'pdf-report-clone') { n.remove(); continue; }
              // si alguien inyecta la plantilla completa fuera del template, bórrala
              if(n.classList && n.classList.contains('pdf-template-root') && !n.closest('template')) {
                n.remove(); continue;
              }
              // si el nodo tiene hijos con id legacy, remuévelos
              const legacy = n.querySelectorAll && n.querySelectorAll('#pdf-report, #pdf-report-clone, .pdf-template-root');
              if(legacy && legacy.length){
                legacy.forEach(el => { if(!el.closest('template')) el.remove(); });
              }
            }catch(err){}
          }
        }
      });
      mo.observe(document.documentElement || document.body, { childList: true, subtree: true });
      // desconectamos el observer a los 15s (protección temporal en carga)
      setTimeout(()=>mo.disconnect(),15000);
    })();

    async function loadData(){
      try{
        const r=await fetch('/data/cutting-data.json',{cache:'no-store'});
        if(r.ok) DATA=await r.json();
      }catch(e){}
      window.DATA=DATA;
    }

    function fillSelectors(){
      const sel=$('material'); if(sel) sel.innerHTML='';
      (DATA.materials||[]).forEach(m=>sel && sel.insertAdjacentHTML('beforeend',`<option value="${m.id}">${m.name}</option>`));

      const ops=(DATA.operations&&DATA.operations.length)?DATA.operations:[
        {id:'rough',label:'Desbaste'},{id:'finish',label:'Acabado'},{id:'adaptive',label:'Trocoidal/Adaptativo'},{id:'slot',label:'Ranurado'},
        {id:'cut',label:'Corte'},{id:'part',label:'Tronzado'},{id:'drill',label:'Barrenado'}
      ];
      const opSel=$('operation'); if(opSel) opSel.innerHTML='';
      ops.forEach(o=>opSel && opSel.insertAdjacentHTML('beforeend',`<option value="${o.id}">${o.label}</option>`));

      const tSel=$('toolType'); if(tSel) tSel.innerHTML='';
      const ttypes=(DATA.tool_types&&DATA.tool_types.length)?DATA.tool_types:[
        {id:'endmill',label:'Fresa (Endmill)'},{id:'drill',label:'Broca'},{id:'face_mill',label:'Careador/Planeado'},
        {id:'slot_saw',label:'Sierra ranuradora'},{id:'part_groove',label:'Tronzador'},{id:'reamer',label:'Escariador'},
        {id:'boring',label:'Barra de barrenado'},{id:'thread_mill',label:'Fresa de roscas'},{id:'tap',label:'Machuelo'}
      ];
      ttypes.forEach(t=>tSel && tSel.insertAdjacentHTML('beforeend',`<option value="${t.id}">${t.label}</option>`));

      const tmSel=$('toolMat'); if(tmSel) tmSel.innerHTML='';
      const tmats=(DATA.tool_materials&&DATA.tool_materials.length)?DATA.tool_materials:[
        {id:'carbide',label:'Carburo',vc_factor:1,fz_factor:1},
        {id:'hss',label:'Acero rápido (HSS)',vc_factor:0.5,fz_factor:0.85},
        {id:'ceramic',label:'Cerámico',vc_factor:2.0,fz_factor:0.9},
        {id:'cbn',label:'CBN',vc_factor:3.0,fz_factor:0.8},
        {id:'pcd',label:'PCD',vc_factor:4.0,fz_factor:1.1},
        {id:'diamond',label:'Diamante',vc_factor:4.5,fz_factor:1.1},
        {id:'cermet',label:'Cermet',vc_factor:1.3,fz_factor:1.0}
      ];
      tmats.forEach(t=>tmSel && tmSel.insertAdjacentHTML('beforeend',`<option value="${t.id}">${t.label}</option>`));

      const holderSel=$('holder'); if(holderSel) holderSel.innerHTML='';
      (DATA.holders||[]).forEach(h=>holderSel && holderSel.insertAdjacentHTML('beforeend',`<option value="${h.id}">${h.label}</option>`));

      const mach=$('machine'); if(mach) mach.innerHTML='';
      (DATA.machine_profiles||[]).forEach(m=>mach && mach.insertAdjacentHTML('beforeend',`<option value="${m.id}">${m.name}</option>`));

      if($('rpmLimit')) $('rpmLimit').value=DATA.defaults?.rpm_limit||12000;
      if($('prudence')) $('prudence').value=DATA.defaults?.prudence||0.9;
      if($('stickout')) $('stickout').value=DATA.defaults?.stickout_mm||25;
      if($('ap')) $('ap').value=DATA.defaults?.ap_mm||5;

      const mat=getMaterial(); if($('matNotes')) $('matNotes').textContent=mat?.notes||''; if($('matBadge')) $('matBadge').textContent=mat?`ID: ${mat.id}`:'';
    }

    /* --- incluye el resto de tus funciones aquí tal cual (getMaterial, getMachine, chart, calc, recalc, applyPreset, etc.) --- */
    /* Para mantenerlo compacto aquí reutilizo exactamente tus funciones de la versión anterior. */
    /* ... (tu JS original) ... */

    // --- funciones clave para PDF (ajustadas para la nueva estrategia) ---

    // rellena los elementos del clone del reporte (scoped dentro del root)
    function populatePdfClone(root){
      const q = (sel)=>root.querySelector(sel);

      const matSel = $('material'), opSel = $('operation'), toolSel = $('toolType'),
            toolMatSel = $('toolMat'), machSel = $('machine'), holderSel = $('holder');

      if(q('#rptMaterial')) q('#rptMaterial').textContent = matSel?.options[matSel.selectedIndex]?.text || '—';
      if(q('#rptOp')) q('#rptOp').textContent       = opSel?.options[opSel.selectedIndex]?.text || '—';
      if(q('#rptToolType')) q('#rptToolType').textContent = toolSel?.options[toolSel.selectedIndex]?.text || '—';
      if(q('#rptToolMat')) q('#rptToolMat').textContent  = toolMatSel?.options[toolMatSel.selectedIndex]?.text || '—';
      if(q('#rptMachine')) q('#rptMachine').textContent  = machSel?.options[machSel.selectedIndex]?.text || '—';
      if(q('#rptHolder')) q('#rptHolder').textContent   = holderSel?.options[holderSel.selectedIndex]?.text || '—';

      if(q('#rptDiam')) q('#rptDiam').textContent = ($('diam')?.value||'—') + (units==='metric'?' mm':' in');
      if(q('#rptRPM')) q('#rptRPM').textContent  = ($('rpmOut')?.textContent||'—') + ' rpm';
      if(q('#rptFeed')) q('#rptFeed').textContent = ($('feedOut')?.textContent||'—') + ' ' + ($('feedUnit')?.textContent||'');
      if(q('#rptMRR')) q('#rptMRR').textContent  = ($('mrrOut')?.textContent||'—') + ' cm³/min';
      if(q('#rptPwr')) q('#rptPwr').textContent  = ($('pwrOut')?.textContent||'—') + ' kW';
      if(q('#rptTq')) q('#rptTq').textContent   = ($('tqOut')?.textContent||'—') + ' N·m';
      if(q('#rptLoad')) q('#rptLoad').textContent = ($('loadOut')?.textContent||'—') + ' %';
      if(q('#rptRa')) q('#rptRa').textContent   = ($('raOut')?.textContent||'—') + ' µm';

      const vibeBox = document.querySelector('.vibe-box');
      let state = '—';
      if(vibeBox && vibeBox.classList.contains('ok')) state='Sweet spot';
      else if(vibeBox && vibeBox.classList.contains('warn')) state='Atento';
      else if(vibeBox && vibeBox.classList.contains('bad')) state='Vibra';
      if(q('#rptVibeState')) q('#rptVibeState').textContent = state;

      const raw = ($('vibeMsg')?.innerHTML||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
      if(q('#rptVibe')) q('#rptVibe').textContent = raw || '—';

      if(q('#rptDate')) q('#rptDate').textContent = new Date().toLocaleString('es-MX');
    }

    // renderiza el template en DOM fuera de vista, lo captura y lo elimina
    async function downloadPdf(){
      const tpl = document.getElementById('pdf-template');
      if(!tpl){ alert('No se encontró #pdf-template'); return; }

      // marcar que estamos en generación para que el observer no borre nuestro clone
      window._pdfGenerationInProgress = true;

      // clonar la raíz del template (ahora la div tiene clase .pdf-template-root)
      const cloneEl = tpl.content.firstElementChild.cloneNode(true);
      // asignar id temporal único para depuración/limpieza
      cloneEl.id = 'pdf-report-clone';

      // mantener fuera de la pantalla y renderizable
      cloneEl.style.position = 'fixed';
      cloneEl.style.left = '-9999px';
      cloneEl.style.top = '0';
      cloneEl.style.display = 'block';
      cloneEl.setAttribute('aria-hidden','true');

      document.body.appendChild(cloneEl);

      try{
        // poblar con datos (scoped al clone)
        populatePdfClone(cloneEl);

        // esperar fuentes e imágenes dentro del clone
        if (document.fonts && document.fonts.ready) await document.fonts.ready;
        const imgs = Array.from(cloneEl.querySelectorAll('img'));
        await Promise.all(imgs.map(img => new Promise(res => {
          if (!img) return res();
          if (img.complete) return res();
          img.onload = img.onerror = res;
          setTimeout(res, 3000);
        })));

        await new Promise(r=>setTimeout(r,120)); // pequeño buffer

        const canvas = await html2canvas(cloneEl, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff',
          width: cloneEl.scrollWidth,
          height: cloneEl.scrollHeight,
          windowWidth: cloneEl.scrollWidth,
          windowHeight: cloneEl.scrollHeight
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;

        let imgWidth = pageWidth - margin * 2;
        let imgHeight = (canvas.height * imgWidth) / canvas.width;
        if (imgHeight > pageHeight - margin * 2) {
          imgHeight = pageHeight - margin * 2;
          imgWidth = (canvas.width * imgHeight) / canvas.height;
        }
        const x = (pageWidth - imgWidth) / 2;
        const y = (pageHeight - imgHeight) / 2;

        doc.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        doc.save('reporte-condiciones-maquinado.pdf');

      }catch(e){
        console.error('Error generando PDF', e);
        alert('Ocurrió un error generando el PDF. Revisa la consola.');
      }finally{
        // limpiar el clone y permitir que el observer actúe de nuevo
        try{ cloneEl.remove(); }catch(e){}
        window._pdfGenerationInProgress = false;
      }
    }

    (async function(){
      await loadData();
      fillSelectors();
      if(typeof buildQuickRef === 'function') buildQuickRef(getMaterial && getMaterial());

      // eventos principales (si los elementos existen)
      $('uMetric')?.addEventListener('click',()=>{setUnits && setUnits('metric');applyPreset && applyPreset();});
      $('uImperial')?.addEventListener('click',()=>{setUnits && setUnits('imperial');applyPreset && applyPreset();});
      $('apply')?.addEventListener('click',applyPreset);
      $('calcBtn')?.addEventListener('click',()=>{calc && calc();recalc && recalc();});
      $('resetBtn')?.addEventListener('click',()=>{resetAll && resetAll();recalc && recalc();});
      $('pdfBtn')?.addEventListener('click',downloadPdf);

      ['material','operation','toolType','toolMat','holder','machine'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener('change',()=>{applyPreset && applyPreset();calc && calc();recalc && recalc();});
      });

      setUnits && setUnits('metric');
      applyPreset && applyPreset();
      chart && chart.init && chart.init(); chart && chart.draw && chart.draw(0.5);
      calc && calc(); recalc && recalc();
      loadRelated && loadRelated();

      $('rpmSlider')?.addEventListener('input',recalc);
      $('feedSlider')?.addEventListener('input',recalc);
    })();
  </script>
</body>
</html>
