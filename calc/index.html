<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Costo-Beneficio — AlexRaSa</title>
<meta name="description" content="Calcula ahorros por ciclo, vida de herramienta y tiempos muertos. ROI, payback y comparativas A vs P para procesos de maquinado." />
<meta name="theme-color" content="#0F172A" />
<meta name="robots" content="index,follow" />
<link rel="canonical" href="https://alexrasa.store/calculadora-costo-beneficio/" />
<link rel="alternate" hreflang="es-MX" href="https://alexrasa.store/calculadora-costo-beneficio/" />
<link rel="alternate" hreflang="es" href="https://alexrasa.store/calculadora-costo-beneficio/" />
<link rel="alternate" hreflang="x-default" href="https://alexrasa.store/calculadora-costo-beneficio/" />
<link rel="icon" href="/favicon.ico" sizes="any" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
<link rel="preload" as="image" href="/assets/hero-industrial.png">
<script src="https://cdn.tailwindcss.com"></script>
<meta name="color-scheme" content="dark">
<style>
  /* Badges de mejora: verde / ámbar / rojo */
.badge-up {
  background: linear-gradient(180deg, rgba(34,197,94,0.14), rgba(34,197,94,0.06));
  color: #064e3b;
  border: 1px solid rgba(34,197,94,0.12);
  box-shadow: 0 1px 0 rgba(34,197,94,0.03);
}
.badge-mid {
  background: linear-gradient(180deg, rgba(245,158,11,0.12), rgba(245,158,11,0.04));
  color: #7c2d12;
  border: 1px solid rgba(245,158,11,0.08);
}
.badge-down {
  background: linear-gradient(180deg, rgba(239,68,68,0.12), rgba(239,68,68,0.04));
  color: #7f1d1d;
  border: 1px solid rgba(239,68,68,0.08);
}
.stat-badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; font-weight:700; font-size:11px; min-width:56px; text-align:center; }

  :root{
    color-scheme: dark;
    --bg:#071027;
    --card:#0f172a;
    --text:#e6eef8;
    --accent:#60a5fa;
    --accent-2:#6366F1;
    --good:#22C55E;
    --warn:#F59E0B;
    --bad:#EF4444;
  }
  html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  a{color:var(--accent);}
  #siteHeader{background:rgba(2,6,23,0.65);border-bottom:1px solid rgba(255,255,255,0.03);}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); color:var(--text); border-radius:12px;}
  input,select,textarea{background:rgba(255,255,255,0.02); color:var(--text); border:1px solid rgba(255,255,255,0.06); padding:.5rem; border-radius:.5rem;}
  input:focus,select:focus{box-shadow:0 0 0 6px rgba(96,165,250,0.08); outline:none}

  .hero-bg{
    position:relative;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    min-height:360px;
    will-change:background-image,opacity;
    -webkit-backface-visibility:hidden;
    backface-visibility:hidden;
    overflow:hidden;
  }
  .hero-bg::before{ content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(2,6,23,0.25), rgba(2,6,23,0.65)); z-index:1; pointer-events:none; }
  .hero-content{ position:relative; z-index:2; }
  .hero-title{ color:var(--text); }
  .hero-sub{ color:rgba(230,238,248,0.9); }

  #vizAhorros svg text, #vizAhorros svg tspan, #vizPerf svg text, #vizPerf svg tspan, #vizCash svg text {
    fill:var(--text) !important;
    font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  
  select option {
    color: #000; 
    background: #fff;
  }
  
  label[title] {
    cursor: help;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: rgba(255,255,255,0.4);
  }

  .stat-badge{ display:inline-block; padding:.25rem .5rem; border-radius:999px; background:rgba(255,255,255,0.03); color:var(--text); font-weight:700; font-size:11px; }

  .no-reveal{ opacity:1 !important; transform:none !important; }

  .safe-bottom{ padding-bottom: max(env(safe-area-inset-bottom), 1rem); }

.stat-badge{
  display:inline-block;
  padding: .28rem .66rem;
  border-radius: 999px;
  font-weight: 700;
  font-size: 11px;
  min-width: 64px;
  text-align: center;
  line-height: 1;
  border: 1px solid rgba(255,255,255,0.04);
  background: rgba(255,255,255,0.03);
  color: var(--text);
  box-shadow: none;
  transition: transform .12s ease, box-shadow .12s ease;
  -webkit-font-smoothing:antialiased;
}

.stat-badge.badge-up{
  background: linear-gradient(180deg, #16a34a 0%, #059669 100%) !important;
  color: #ffffff !important;
  border-color: rgba(5,118,78,0.25) !important;
  box-shadow: 0 6px 18px rgba(6,182,104,0.09);
}

.stat-badge.badge-mid{
  background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%) !important;
  color: #101010 !important;
  border-color: rgba(217,119,6,0.14) !important;
  box-shadow: 0 6px 18px rgba(245,158,11,0.06);
}

.stat-badge.badge-down{
  background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%) !important;
  color: #ffffff !important;
  border-color: rgba(220,38,38,0.18) !important;
  box-shadow: 0 6px 18px rgba(239,68,68,0.09);
}

.stat-badge:hover{ transform: translateY(-1px); cursor:default; }
</style>
  
</head>
<body class="antialiased">

<header id="siteHeader" class="sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4">
    <div class="h-16 flex items-center justify-between gap-3">
      <a href="/" class="flex items-center gap-2 shrink-0" aria-label="Ir al inicio">
        <img src="/assets/logo.png" alt="Logo AlexRaSa" class="h-10 w-auto" width="160" height="40" />
        <span class="hidden sm:inline text-base font-semibold tracking-tight" style="color:var(--text)">AlexRaSa<span style="color:var(--accent)">.store</span></span>
      </a>
      <nav class="hidden lg:flex items-center gap-6 text-sm">
        <a href="/" class="hover:text-sky-400">Inicio</a>
        <a href="/SolidCAM/" class="hover:text-sky-400">Soluciones</a>
        <a href="/#servicios" class="hover:text-sky-400">Servicios</a>
        <a href="/#recursos" class="hover:text-sky-400">Recursos</a>
        <a href="/#contacto" class="hover:text-sky-400">Contacto</a>
      </nav>
      <button id="mobileOpenBtn" class="lg:hidden p-2 rounded" aria-label="Abrir menú" style="color:var(--text)">
        <svg class="h-6 w-6" viewBox="0 0 24 24" stroke="currentColor" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
  </div>
</header>

<section aria-label="Hero" class="hero-bg no-reveal" style="background-image:url('/assets/hero-industrial.png');">
  <div class="hero-content max-w-6xl mx-auto px-4 py-10 md:py-20">
    <h1 class="text-3xl md:text-5xl font-extrabold hero-title">Calculadora de <span style="color:var(--accent)">Costo-Beneficio</span></h1>
    <p class="mt-3 max-w-3xl hero-sub">Estima ahorros por <strong>tiempo de ciclo</strong>, <strong>vida de herramienta</strong> y <strong>tiempos muertos</strong>. Obtén <strong>ROI</strong>, <strong>payback</strong> y una comparativa <em>Actual vs Propuesta</em>.</p>
  </div>
</section>

<main id="calc" class="max-w-6xl mx-auto px-4 pt-8 pb-28 md:pb-14 grid gap-4 sm:gap-6 lg:grid-cols-8 reveal">
  <section class="card p-5 lg:col-span-2">
    <h2 class="text-lg font-semibold">Parámetros del proceso</h2>
    <div class="grid gap-3 mt-3">
      <label class="text-sm" title="Tiempo de ciclo actual, en segundos, para una pieza.">Tiempo de ciclo actual (s)
        <input id="cicloA" type="number" value="60" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Tiempo de ciclo propuesto (con la nueva herramienta/proceso).">Tiempo de ciclo propuesto (s)
        <input id="cicloP" type="number" value="45" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Número de piezas que dura la herramienta actual.">Vida útil actual (pzas)
        <input id="vidaA" type="number" value="1300" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Número de piezas objetivo que dura la nueva herramienta.">Vida útil propuesta (pzas)
        <input id="vidaP" type="number" value="2500" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Costo de un solo inserto o herramienta de reemplazo.">Costo de herramienta (USD)
        <input id="costoHerr" type="number" value="128.87" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Costo total de operar la máquina por hora (incluye depreciación, energía, herramental y mano de obra).">Costo por hora máquina (USD)
        <input id="costoHora" type="number" value="50" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Volumen de producción mensual total para este proceso.">Piezas por mes
        <input id="pmes" type="number" value="10000" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Inversión total única (CAPEX) en herramientas, software o capacitación.">Inversión inicial (USD)
        <input id="inversion" type="number" value="2000" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Costo recurrente (OPEX) por suscripción o mantenimiento.">Mensualidad acordada (USD)
        <input id="mensualidad" type="number" value="600" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Minutos totales de paro de máquina por mes (ej. cambios de herramienta, ajustes).">T. muerto actual (min/mes)
        <input id="tmuertoA" type="number" value="120" class="mt-1 w-full">
      </label>
      <label class="text-sm" title="Minutos de paro de máquina objetivo con la nueva solución.">T. muerto propuesto (min/mes)
        <input id="tmuertoP" type="number" value="30" class="mt-1 w-full">
      </label>

      <h3 class="text-sm font-semibold mt-2">Tipos de ahorro a incluir</h3>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <label class="inline-flex items-center gap-2"><input id="incCiclo" type="checkbox" checked class="h-4 w-4"><span>Tiempo de ciclo</span></label>
        <label class="inline-flex items-center gap-2"><input id="incHerr" type="checkbox" checked class="h-4 w-4"><span>Vida herramienta</span></label>
        <label class="inline-flex items-center gap-2"><input id="incTM" type="checkbox" checked class="h-4 w-4"><span>Tiempo muerto</span></label>
      </div>

      <button id="btnCalcular" class="hidden md:block mt-3 w-full px-4 py-2 rounded-md" style="background:var(--accent-2); color:white">Calcular</button>
    </div>
  </section>

  <section class="card p-5 lg:col-span-4">
    <h2 class="text-lg font-semibold">Comparativa A vs P</h2>
    <div class="mt-3 overflow-auto -mx-2 sm:mx-0">
      <table class="w-full border-separate [border-spacing:0_8px] text-sm">
        <thead>
          <tr class="text-slate-300">
            <th class="text-left font-medium px-2">Métrica</th>
            <th class="text-right font-medium px-2">Actual</th>
            <th class="text-right font-medium px-2">Propuesta</th>
            <th class="text-right font-medium px-2">Δ Mejora</th>
          </tr>
        </thead>
        <tbody id="tbodyComp"></tbody>
      </table>
    </div>
  </section>

  <section class="card p-5 lg:col-span-2">
    <h2 class="text-lg font-semibold">Resultados</h2>
    <div class="mt-3 grid gap-3">
      <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(34,197,94,0.06), rgba(255,255,255,0.01));">
        <div class="text-sm">Ahorro mensual</div>
        <div id="ahorro" class="text-right font-bold text-xl" style="color:var(--good)">$0</div>
      </div>
      <div id="kpiTMBox" class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(6,182,212,0.03), rgba(255,255,255,0.01));">
        <div class="text-sm">Ahorro por tiempo muerto (USD/mes)</div>
        <div id="ahorroTM" class="text-right font-bold text-lg" style="color:#06b6d4">$0</div>
      </div>
      <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(99,102,241,0.04), rgba(255,255,255,0.01));">
        <div class="text-sm">ROI anual</div>
        <div id="roi" class="text-right font-bold text-lg" style="color:var(--accent-2)">0%</div>
      </div>
      <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(99,102,241,0.02), rgba(255,255,255,0.01));">
        <div class="text-sm">ROI mensual</div>
        <div id="roiMensual" class="text-right font-bold text-lg" style="color:var(--accent)">0%</div>
      </div>
      <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(245,158,11,0.03), rgba(255,255,255,0.01));">
        <div class="text-sm">Payback (meses)</div>
        <div id="payback" class="text-right font-bold text-lg" style="color:var(--warn)">0</div>
      </div>
      <div class="rounded-lg p-3" style="background:linear-gradient(180deg, rgba(34,197,94,0.04), rgba(255,255,255,0.01));">
        <div class="text-sm">Neto mensual (ahorro - mensualidad)</div>
        <div id="netoMensual" class="text-right font-bold text-lg">$0</div>
      </div>

    </div>
  </section>

  <section id="visuales" class="card p-5 lg:col-span-8 lg:col-start-1">
    <h2 class="text-lg font-semibold">Visuales</h2>
    <div class="mt-3 grid grid-cols-1 gap-6 max-w-5xl mx-auto">
      <div class="rounded-lg p-3" style="border:1px solid rgba(255,255,255,0.03);">
        <p class="text-sm font-semibold">Distribución de ahorros</p>
        <div id="vizAhorros" class="mt-4 min-h-[320px]"></div>
      </div>
      <div class="rounded-lg p-3" style="border:1px solid rgba(255,255,255,0.03);">
        <p class="text-sm font-semibold">Comparativa rápida</p>
        <div id="vizPerf" class="mt-4"></div>
      </div>
      <div class="rounded-lg p-3" style="border:1px solid rgba(255,255,255,0.03);">
        <p class="text-sm font-semibold">Flujo mensual y payback</p>
        <div id="vizCash" class="mt-4 min-h-[320px]"></div>
      </div>
    </div>
  </section>
</main>

<div class="md:hidden fixed inset-x-0 bottom-0 z-40 safe-bottom px-4 py-2">
  <button id="btnCalcularMobile" class="w-full px-4 py-3 rounded-md" style="background:var(--accent-2); color:white">Calcular</button>
</div>

<footer class="py-6 mt-16 text-center">
  <div class="max-w-6xl mx-auto px-4 text-sm" style="color:rgba(230,238,248,0.65)">© 2025 AlexRaSa — Ingeniería, innovación y eficiencia.</div>
</footer>

<script>
  // small util
  function fmt(n){ return Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

  // --- ¡FUNCIONES RESTAURADAS! ---
  function setEnabled(ids,on){ ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.disabled=!on; }); }
  function applyInclusions(){ setEnabled(['cicloA','cicloP'], document.getElementById('incCiclo')?.checked ?? true); setEnabled(['vidaA','vidaP','costoHerr'], document.getElementById('incHerr')?.checked ?? true); setEnabled(['tmuertoA','tmuertoP'], document.getElementById('incTM')?.checked ?? true); }
  // --- FIN DE LA CORRECCIÓN ---

  // calculator logic
  function calcular(){
    const mensualidad = +document.getElementById('mensualidad').value || 0;
    const cicloA = +document.getElementById('cicloA').value || 0;
    const cicloP = +document.getElementById('cicloP').value || 0;
    const vidaA = +document.getElementById('vidaA').value || 0;
    const vidaP = +document.getElementById('vidaP').value || 0;
    const costoHerr = +document.getElementById('costoHerr').value || 0;
    const costoHora = +document.getElementById('costoHora').value || 0;
    const pmes = +document.getElementById('pmes').value || 0;
    const inversion = +document.getElementById('inversion').value || 0;
    const tmuertoA = +document.getElementById('tmuertoA').value || 0;
    const tmuertoP = +document.getElementById('tmuertoP').value || 0;

    const ahorroCiclo = (cicloA>0 && cicloP>0) ? (1 - cicloP / cicloA) * costoHora * (pmes * cicloA / 3600) : 0;
    const consA = (vidaA>0) ? (pmes / vidaA) : 0;
    const consP = (vidaP>0) ? (pmes / vidaP) : 0;
    const costoHerrA = consA * costoHerr;
    const costoHerrP = consP * costoHerr;
    const ahorroHerr = Math.max(0, costoHerrA - costoHerrP);
    const ahorroTM = Math.max(0, (tmuertoA - tmuertoP)) / 60 * costoHora;

    const incCiclo = document.getElementById('incCiclo')?.checked ?? true;
    const incHerr  = document.getElementById('incHerr')?.checked ?? true;
    const incTM    = document.getElementById('incTM')?.checked ?? true;

    const ahorroTotal = Math.max(0,
      (incCiclo ? ahorroCiclo : 0) +
      (incHerr  ? ahorroHerr  : 0) +
      (incTM    ? ahorroTM    : 0)
    );

    const neto = ahorroTotal - mensualidad;
    const roiMensual = inversion > 0 ? (neto / inversion) * 100 : (neto > 0 ? Infinity : 0);
    const roiAnual   = inversion > 0 ? ((neto * 12) / inversion) * 100 : (neto > 0 ? Infinity : 0);
    const payback    = inversion > 0 && neto > 0 ? inversion / neto : 0;
    const idxPayback = inversion > 0 && neto > 0 ? Math.ceil(inversion / neto) : -1;

    const netoEl = document.getElementById('netoMensual');
    if (netoEl) {
      netoEl.textContent = `$${fmt(neto)}`;
      netoEl.style.color = neto >= 0 ? 'var(--good)' : 'var(--bad)';
    }

    // Llamada a renderCashflow actualizada
    renderCashflow('vizCash', {
      ahorroMes: ahorroTotal, // Ahorro bruto
      cuota: mensualidad,     // Costo mensual
      capex: inversion        // Inversión inicial
    });

    document.getElementById('ahorro').textContent    = `$${fmt(ahorroTotal)}`;
    document.getElementById('roi').textContent       = isFinite(roiAnual) ? `${fmt(roiAnual)}%` : '∞%';
    document.getElementById('roiMensual').textContent = isFinite(roiMensual) ? `${fmt(roiMensual)}%` : '∞%';
    document.getElementById('payback').textContent = idxPayback !== -1 ? (idxPayback) : '—';
    document.getElementById('ahorroTM').textContent  = `$${fmt(ahorroTM)}`;

    const pphA = cicloA>0 ? 3600/cicloA : 0;
    const pphP = cicloP>0 ? 3600/cicloP : 0;
    const costPerPieceA = vidaA>0 ? (costoHerr/vidaA) : 0;
    const costPerPieceP = vidaP>0 ? (costoHerr/vidaP) : 0;

    function delta(a,p,{higherIsBetter=true}={}){
      if(a===0 && p===0) return {val:0, up:false};
      const d = (p-a) / (a===0 ? 1 : a) * 100;
      const up = higherIsBetter ? d>0 : d<0;
      return {val:d, up};
    }
    function row(name,a,p,opt){
      const d = delta(a,p,opt||{});
      const higherIsBetter = (opt && typeof opt.higherIsBetter !== 'undefined') ? opt.higherIsBetter : true;
      const displayed = isFinite(d.val) ? (d.val >= 0 ? '+' : '') + fmt(d.val) + '%' : '—';
      const thresholdPct = 3;
      const absVal = Math.abs(d.val || 0);
      const isImprovement = higherIsBetter ? (d.val > 0) : (d.val < 0);
      let badgeClass;
      if (absVal < thresholdPct) badgeClass = 'badge-mid';
      else badgeClass = isImprovement ? 'badge-up' : 'badge-down';
      const badge = `<span class="stat-badge ${badgeClass}" title="${isImprovement ? 'Mejora' : 'Empeora'}">${displayed}</span>`;
      return `<tr style="background:transparent; border-bottom:1px solid rgba(255,255,255,0.02);">
        <td class="px-2 py-2">${name}</td>
        <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(a)?fmt(a):'—'}</td>
        <td class="px-2 py-2 text-right font-mono tabular-nums">${isFinite(p)?fmt(p):'—'}</td>
        <td class="px-2 py-2 text-right">${badge}</td>
      </tr>`;
    }

    const rows = [
      row('Tiempo de ciclo (s)', cicloA, cicloP, {higherIsBetter:false}),
      row('Piezas por hora', pphA, pphP, {higherIsBetter:true}),
      row('Vida útil (pzas)', vidaA, vidaP, {higherIsBetter:true}),
      row('Costo herramienta/pza (USD)', costPerPieceA, costPerPieceP, {higherIsBetter:false}),
      row('Consumo mensual herramienta (USD)', (vidaA? (pmes/vidaA)*costoHerr:0), (vidaP? (pmes/vidaP)*costoHerr:0), {higherIsBetter:false}),
      row('Tiempo muerto (min/mes)', tmuertoA, tmuertoP, {higherIsBetter:false}),
      row('Ahorro por tiempo muerto (USD/mes)', 0, ahorroTM, {higherIsBetter:true}),
      row('Ahorro mensual total (USD)', 0, ahorroTotal, {higherIsBetter:true}),
    ].join('');
    document.getElementById('tbodyComp').innerHTML = rows;

    // visuals
    const parts=[], labels=[];
    if(incCiclo) { parts.push(Math.max(0, ahorroCiclo)); labels.push('Ciclo'); }
    if(incHerr)  { parts.push(Math.max(0, ahorroHerr));  labels.push('Herramienta'); }
    if(incTM)    { parts.push(Math.max(0, ahorroTM));    labels.push('Tiempo muerto'); }
    
    renderDonut('vizAhorros', parts, labels);
    renderBars('vizPerf', [ ['Pzas/h', pphA, pphP, false], ['T. muerto (min/mes)', tmuertoA, tmuertoP, true] ]);
  }
  
  // --- `renderCashflow` REEMPLAZADA ---
  function renderCashflow(targetId, {ahorroMes, cuota, capex}){
    const el=document.getElementById(targetId); if(!el) return;
    const meses=Array.from({length:12},(_,i)=>`M${i+1}`);
    
    const W = 800, H = 400;
    const pad = { top: 40, right: 10, bottom: 50, left: 60 };
    const barW = 18, barGap = 6, gap = 38;
    const H_drawable = H - pad.top - pad.bottom;
    
    const neto = (ahorroMes||0) - (cuota||0);
    let acc = -capex; // Flujo acumulado empieza en negativo con el CAPEX
    const accArr = meses.map(() => { acc += neto; return acc; });

    const allValues = [ahorroMes||0, cuota||0, ...accArr, -capex];
    const dataMax = Math.max(1, ...allValues.map(v => Math.max(0, v)));
    const dataMin = Math.min(0, ...allValues.map(v => Math.min(0, v)));
    const totalRange = dataMax - dataMin;

    const scaleY = (v) => {
      if (totalRange === 0) return H - pad.bottom;
      return (H - pad.bottom) - (((v - dataMin) / totalRange) * H_drawable);
    };

    const yZero = scaleY(0);

    let x = pad.left + gap/2;
    
    const bars = meses.map((m,i)=>{
      const yA = scaleY(ahorroMes); const hA = yZero - yA;
      const yP = scaleY(cuota); const hP = yZero - yP; // "cuota" es la mensualidad
      const xa = x, xp = x + barW + barGap;
      const labelY = H - pad.bottom + 20;
      
      const rects = `<rect x="${xa}" y="${yA}" width="${barW}" height="${hA}" fill="#22C55E"></rect>
                     <rect x="${xp}" y="${yP}" width="${barW}" height="${hP}" fill="#EF4444"></rect>`;
      const txt = `<text x="${x + barW + barGap/2}" y="${labelY}" font-size="14" fill="var(--text)" text-anchor="middle">${m}</text>`;
      
      x += (barW * 2 + barGap + gap);
      return rects+txt;
    }).join('');

    const linePts = accArr.map((v,i)=>{
      const xi = pad.left + gap/2 + i*(barW*2+barGap+gap) + (barW + barGap/2);
      const yi = scaleY(v);
      return `${xi},${yi}`;
    }).join(' ');
    const x0 = pad.left + gap/2 - (barW*2+barGap+gap) + (barW + barGap/2);
    const y0 = scaleY(-capex);
    const polyline = `<polyline points="${x0},${y0} ${linePts}" fill="none" stroke="#A78BFA" stroke-width="3"></polyline>`;

    let marker=''; 
    if (capex > 0){
      const idx = accArr.findIndex(v => v >= 0);
      if(idx !== -1){
        const xi_marker = pad.left + gap/2 + idx*(barW*2+barGap+gap) + (barW + barGap/2);
        const yi_marker = scaleY(accArr[idx]);
        marker = `<circle cx="${xi_marker}" cy="${yi_marker}" r="6" fill="#A78BFA" stroke="var(--bg)" stroke-width="2"></circle>
                  <text x="${xi_marker + 10}" y="${yi_marker - 10}" font-size="14" fill="#A78BFA">Payback M${idx+1}</text>`;
      }
    }
    
    const legendX = W - pad.right - 150, legendY = pad.top;
    const legend = `
        <rect x="${legendX}" y="${legendY - 12}" width="140" height="82" rx="10" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.06)"></rect>
        <rect x="${legendX+12}" y="${legendY}" width="12" height="12" fill="#22C55E"></rect>
        <text x="${legendX+30}" y="${legendY+10}" font-size="14" fill="var(--text)">Ahorro</text>
        <rect x="${legendX+12}" y="${legendY+26}" width="12" height="12" fill="#EF4444"></rect>
        <text x="${legendX+30}" y="${legendY+36}" font-size="14" fill="var(--text)">Cuota</text>
        <line x1="${legendX+12}" y1="${legendY+60}" x2="${legendX+24}" y2="${legendY+60}" stroke="#A78BFA" stroke-width="2.5"></line>
        <text x="${legendX+30}" y="${legendY+62}" font-size="14" fill="var(--text)">Acumulado</text>`;

    const axis = `
        <line x1="${pad.left}" y1="${pad.top - 10}" x2="${pad.left}" y2="${H - pad.bottom}" stroke="rgba(255,255,255,.2)"></line>
        <line x1="${pad.left}" y1="${yZero}" x2="${W - pad.right}" y2="${yZero}" stroke="rgba(255,255,255,.2)"></line>
        <text x="${pad.left - 10}" y="${yZero + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$0</text>
        <text x="${pad.left - 10}" y="${scaleY(dataMax) + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$${fmt(dataMax)}</text>
        ${dataMin < 0 ? `<text x="${pad.left - 10}" y="${scaleY(dataMin) + 5}" font-size="14" text-anchor="end" fill="rgba(255,255,255,.65)">$${fmt(dataMin)}</text>` : ''}
    `;

    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">
      ${axis}${bars}${polyline}${marker}${legend}
    </svg>`;
  }
  // --- **FIN: `renderCashflow` REEMPLAZADA** ---


  // --- **INICIO: `renderDonut` REEMPLAZADA** ---
  function renderDonut(targetId, parts, labels){
    const el=document.getElementById(targetId); if(!el) return;
    const data=parts.map((p,i)=> [labels[i], p]).filter(p=>p[1]>0);
    const total=data.reduce((s,p)=>s[1]+p[1],0);
    
    const W=600, H=400; 
    const cx = 210, cy = H / 2, r = H * 0.4, th = 50;
    let start=0; const colors=['#6366F1','#16A34A','#F59E0B','#06B6D4','#EF4444'];

    const legendX = 390;
    const legendFontSize = 18;
    const legendLineHeight = 30;
    const legendBlockHeight = data.length * legendLineHeight;
    const legendStartY = (H - legendBlockHeight) / 2 + (legendFontSize / 2);

    const segs=data.map((p,i)=>{ 
      const f= total? p[1]/total:0; const a0=start*2*Math.PI, a1=(start+f)*2*Math.PI; start+=f;
      const L=(a1-a0)>Math.PI?1:0;
      const x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0),x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
      const x0i=cx+(r-th)*Math.cos(a0),y0i=cy+(r-th)*Math.sin(a0),x1i=cx+(r-th)*Math.cos(a1),y1i=cy+(r-th)*Math.sin(a1);
      const d=`M ${x0} ${y0} A ${r} ${r} 0 ${L} 1 ${x1} ${y1} L ${x1i} ${y1i} A ${r-th} ${r-th} 0 ${L} 0 ${x0i} ${y0i} Z`;
      
      const pct=Math.round(f*100);
      const ly = legendStartY + (i * legendLineHeight);

      return `<path d="${d}" fill="${colors[i%colors.length]}" opacity="0.95"></path>
              <text x="${legendX}" y="${ly}" font-size="${legendFontSize}" fill="var(--text)">${p[0]}: ${pct}%</text>`;
    }).join('');

    const centerFontSize = Math.max(20, Math.round(r * 0.2));
    const centerText = total ? ('$' + fmt(total)) : '—';

    const center = `<circle cx="${cx}" cy="${cy}" r="${r-th+1}" fill="rgba(255,255,255,0.04)"></circle>
                  <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" font-size="${centerFontSize}" fill="var(--text)">${centerText}</text>`;
    
    el.innerHTML = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}">${segs}${center}</svg>`;
  }
  // --- **FIN: `renderDonut` REEMPLAZADA** ---


  function renderBars(targetId, pairs){
    const rowsData = pairs.map(([lbl,a,b,lowerIsBetter]) => ({ lines:String(lbl).replace(' (','\n(').split('\n'), a,b,lowerIsBetter }));
    const approxChar=7;
    const labelCol = Math.max(160, Math.min(260, Math.max(...rowsData.map(r=>Math.max(...r.lines.map(s=>s.length))*approxChar))));
    const barStartX = labelCol + 16;
    const barMax = 560;
    const rowH = 40, rowGap = 16, padY = 20;
    const W = barStartX + barMax + 160;
    const H = padY + rowsData.length * (rowH + rowGap) + 40;
    const maxVal = Math.max(...rowsData.flatMap(r=>[r.a,r.b].map(v=>Math.abs(v)||0)),1);

    let y = padY;
    const rows = rowsData.map(r=>{
      const aw = Math.round((Math.abs(r.a)/maxVal)*barMax);
      const bw = Math.round((Math.abs(r.b)/maxVal)*barMax);
      const goodB = r.lowerIsBetter ? (r.b < r.a) : (r.b > r.a);
      const label = `<text x="0" y="${y+14}" font-size="14" fill="var(--text)">${r.lines[0]}${r.lines.length>1?`<tspan x="0" dy="1.2em">${r.lines.slice(1).join(' ')}</tspan>`:''}</text>`;
      const bars = `
        <rect x="${barStartX}" y="${y}"    width="${aw}" height="12" fill="#94a3b8"></rect>
        <rect x="${barStartX}" y="${y+16}"  width="${bw}" height="12" fill="${goodB ? '#22C55E' : '#ef4444'}"></rect>
        <text x="${barStartX + aw + 10}" y="${y+10}"  font-size="12" fill="var(--text)">${isFinite(r.a)?r.a.toFixed(1):'—'}</text>
        <text x="${barStartX + bw + 10}" y="${y+26}" font-size="12" fill="var(--text)">${isFinite(r.b)?r.b.toFixed(1):'—'}</text>
      `;
      y += rowH + rowGap;
      return label + bars;
    }).join('');

    const legendY = H - 20;
    const legend = `
      <rect x="${barStartX}"     y="${legendY-14}" width="200" height="28" rx="8" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.06)"></rect>
      <rect x="${barStartX+10}" y="${legendY-6}" width="12" height="12" fill="#94a3b8"></rect>
      <text x="${barStartX + 28}" y="${legendY+4}" font-size="12" fill="var(--text)">Actual</text>
      <rect x="${barStartX + 88}" y="${legendY-6}" width="12" height="12" fill="#22C55E"></rect>
      <text x="${barStartX + 106}" y="${legendY+4}" font-size="12" fill="var(--text)">Propuesta</text>
    `;
    const svg = `<svg class="w-full h-auto" viewBox="0 0 ${W} ${H}" role="img" aria-label="Comparativa">${rows}${legend}</svg>`;
    const el = document.getElementById(targetId); if(el) el.innerHTML = svg;
  }

  // event wiring
  document.getElementById('btnCalcular')?.addEventListener('click', calcular);
  document.getElementById('btnCalcularMobile')?.addEventListener('click', calcular);
  ['cicloA','cicloP','vidaA','vidaP','costoHerr','costoHora','pmes','inversion','tmuertoA','tmuertoP','mensualidad'].forEach(id=>document.getElementById(id)?.addEventListener('input',()=>{ if(window.innerWidth>=768) calcular(); }));
  ['incCiclo','incHerr','incTM'].forEach(id=>document.getElementById(id)?.addEventListener('change',()=>{ applyInclusions(); calcular(); }));

  // reveal observer
  (function(){
    const els = document.querySelectorAll('.reveal');
    if(!('IntersectionObserver' in window)){ els.forEach(el=>el.classList.add('show')); return; }
    const io = new IntersectionObserver((entries, obs)=>{
      entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('show'); obs.unobserve(e.target); }});
    },{threshold:0.12});
    els.forEach(el=>io.observe(el));
  })();

  // init
  applyInclusions();
  calcular();
</script>
</body>
</html>
