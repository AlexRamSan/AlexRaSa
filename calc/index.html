<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora Costo‑Beneficio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{color-scheme:light dark}
    .card{ @apply rounded-2xl shadow p-4 md:p-6 bg-white/70 dark:bg-slate-900/70 backdrop-blur; }
    .grid-2{ @apply grid gap-4 md:gap-6 md:grid-cols-2; }
    .grid-3{ @apply grid gap-4 md:gap-6 md:grid-cols-3; }
    input[type="number"], select { @apply w-full rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900; }
    label { @apply text-sm font-medium text-slate-700 dark:text-slate-300; }
    .kpi{ @apply text-2xl font-semibold; }
    .muted{ @apply text-slate-500 text-sm; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100">
  <header class="max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-8">
    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Calculadora Costo‑Beneficio</h1>
    <p class="muted mt-1">Comparación Actual vs Propuesta. Edita los parámetros y los ahorros se recalculan al instante. <span class="italic">(Valores iniciales precargados desde tu hoja)</span></p>
  </header>

  <main class="max-w-7xl mx-auto px-4 md:px-6 pb-20">
    <!-- CONTROLES GLOBALES -->
    <section class="grid-3 mb-6">
      <div class="card">
        <label>Días productivos al mes</label>
        <input id="diasMes" type="number" step="1" value="30" />
        <p class="muted mt-1">Usado para convertir métricas diarias a mensuales.</p>
      </div>
      <div class="card">
        <label>Costo hora máquina (USD/hr)</label>
        <input id="costoHora" type="number" step="0.01" value="125" />
      </div>
      <div class="card">
        <label>Costo por pieza (USD/pza)</label>
        <input id="costoPieza" type="number" step="0.01" value="60" />
        <p class="muted mt-1">Si prefieres valorar pérdidas por tiempo de máquina, cambia el método abajo.</p>
      </div>
    </section>

    <!-- JORNADA -->
    <section class="card mb-6">
      <h2 class="text-xl font-semibold mb-4">Jornada y disponibilidad</h2>
      <div class="grid-4 grid gap-4 md:grid-cols-4">
        <div>
          <label>Horas por turno</label>
          <input id="horasTurno" type="number" step="0.25" value="8" />
        </div>
        <div>
          <label>Hora de comida (por turno)</label>
          <input id="horaComida" type="number" step="0.25" value="0.5" />
        </div>
        <div>
          <label>Turnos por día</label>
          <input id="turnos" type="number" step="1" value="3" />
        </div>
        <div>
          <label>Horas productivas/día</label>
          <input id="horasProductivas" type="number" step="0.25" value="22.5" />
          <p class="muted">Puedes fijarlo manualmente o dejar que sea tu meta.</p>
        </div>
      </div>
    </section>

    <!-- PROCESO -->
    <section class="card mb-6">
      <h2 class="text-xl font-semibold mb-4">Parámetros del proceso</h2>
      <div class="grid-2">
        <div>
          <h3 class="font-semibold mb-2">Actual</h3>
          <div class="grid gap-3">
            <div>
              <label>Tiempo de ciclo (s)</label>
              <input id="cicloA" type="number" step="0.1" value="370" />
            </div>
            <div>
              <label>Vida herramienta (pzas)</label>
              <input id="vidaA" type="number" step="1" value="1500" />
            </div>
            <div>
              <label>Tiempo de ajuste (min/día)</label>
              <input id="ajusteMinA" type="number" step="1" value="1440" />
            </div>
            <div>
              <label>Tiempo de programación (h/mes)</label>
              <input id="progHA" type="number" step="0.1" value="4" />
            </div>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Propuesta</h3>
          <div class="grid gap-3">
            <div>
              <label>Tiempo de ciclo (s)</label>
              <input id="cicloP" type="number" step="0.1" value="360" />
            </div>
            <div>
              <label>Vida herramienta (pzas)</label>
              <input id="vidaP" type="number" step="1" value="2500" />
            </div>
            <div>
              <label>Tiempo de ajuste (min/día)</label>
              <input id="ajusteMinP" type="number" step="1" value="20" />
            </div>
            <div>
              <label>Tiempo de programación (h/mes)</label>
              <input id="progHP" type="number" step="0.1" value="0" />
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2 mt-4">
        <div>
          <label>Costo herramienta (USD)</label>
          <input id="costoHerr" type="number" step="0.01" value="15" />
        </div>
        <div>
          <label>Método para valorar piezas perdidas</label>
          <select id="metodoPerdidas">
            <option value="pieza" selected>Por valor de pieza perdida (USD/pza)</option>
            <option value="hora">Por costo hora máquina (tiempo de ajuste)</option>
          </select>
        </div>
      </div>
    </section>

    <!-- INVERSION Y KPI -->
    <section class="grid-3 mb-6">
      <div class="card">
        <label>Inversión inicial (USD)</label>
        <input id="inversion" type="number" step="0.01" value="0" />
        <p class="muted mt-1">Usado para ROI y Payback.</p>
      </div>
      <div class="card">
        <div class="muted">Payback</div>
        <div id="payback" class="kpi">—</div>
        <div class="muted">meses</div>
      </div>
      <div class="card">
        <div class="muted">ROI anual</div>
        <div id="roi" class="kpi">—</div>
        <div class="muted">(Ahorro anual neto / Inversión)</div>
      </div>
    </section>

    <!-- RESULTADOS -->
    <section class="card mb-6">
      <h2 class="text-xl font-semibold mb-4">Resultados & Ahorros</h2>
      <div class="grid-3">
        <div>
          <div class="muted">Ahorro mensual total</div>
          <div id="ahorroTotal" class="kpi">$0</div>
        </div>
        <div>
          <div class="muted">Mejora productiva (mensual)</div>
          <div id="ahorroProd" class="kpi">$0</div>
        </div>
        <div>
          <div class="muted">Ahorro por herramienta (mensual)</div>
          <div id="ahorroHerr" class="kpi">$0</div>
        </div>
      </div>

      <div class="grid-3 mt-6">
        <div>
          <div class="muted">Ahorro por piezas perdidas (mensual)</div>
          <div id="ahorroPerdidas" class="kpi">$0</div>
        </div>
        <div>
          <div class="muted">Ahorro tiempo de ajuste (mensual)</div>
          <div id="ahorroAjuste" class="kpi">$0</div>
          <div class="muted">(solo si método = hora)</div>
        </div>
        <div>
          <div class="muted">Ahorro por programación (mensual)</div>
          <div id="ahorroProg" class="kpi">$0</div>
        </div>
      </div>

      <div class="mt-6 grid gap-6 md:grid-cols-2">
        <canvas id="chartAhorros"></canvas>
        <canvas id="chartProductividad"></canvas>
      </div>

      <div class="mt-6 flex gap-3">
        <button id="btnReset" class="px-4 py-2 rounded-xl bg-slate-800 text-white">Restablecer</button>
        <button id="btnExport" class="px-4 py-2 rounded-xl border border-slate-400">Exportar JSON</button>
      </div>
    </section>

    <!-- DETALLES CALCULADOS -->
    <section class="grid-2">
      <div class="card">
        <h3 class="font-semibold mb-3">Productividad</h3>
        <ul class="space-y-1 text-sm">
          <li><span class="muted">Pzas/h actual → propuesta:</span> <span id="pph"></span></li>
          <li><span class="muted">Pzas/día actual → propuesta:</span> <span id="pdia"></span></li>
          <li><span class="muted">Pzas/mes actual → propuesta:</span> <span id="pmes"></span></li>
        </ul>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-3">Herramienta & Ajustes</h3>
        <ul class="space-y-1 text-sm">
          <li><span class="muted">Costo herramienta diario A → P:</span> <span id="costHerrDia"></span></li>
          <li><span class="muted">Pzas perdidas por ajuste (día) A → P:</span> <span id="perdidasDia"></span></li>
          <li><span class="muted">Tiempo de ajuste (h/día) A → P:</span> <span id="ajusteH"></span></li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 md:px-6 py-10 text-center muted">
    Hecha por AlexRaSa + GPT · Tailwind + Chart.js
  </footer>

<script>
  // Helpers
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => n.toLocaleString(undefined, {maximumFractionDigits: 2});
  const money = (n) => `$${fmt(n)}`;

  const inputs = [
    'diasMes','costoHora','costoPieza','horasTurno','horaComida','turnos','horasProductivas',
    'cicloA','vidaA','ajusteMinA','progHA','cicloP','vidaP','ajusteMinP','progHP','costoHerr','metodoPerdidas','inversion'
  ].map($);

  let chartA, chartB;

  function recalc(){
    const diasMes = +$('diasMes').value || 0;
    const costoHora = +$('costoHora').value || 0;
    const costoPieza = +$('costoPieza').value || 0;
    const horasTurno = +$('horasTurno').value || 0;
    const horaComida = +$('horaComida').value || 0;
    const turnos = +$('turnos').value || 0;
    let horasProductivas = +$('horasProductivas').value || 0;
    if(!horasProductivas){
      horasProductivas = turnos * Math.max(0, (horasTurno - horaComida));
      $('horasProductivas').value = horasProductivas;
    }

    const cicloA = +$('cicloA').value || 1;
    const vidaA = +$('vidaA').value || 1;
    const ajusteMinA = +$('ajusteMinA').value || 0;
    const progHA = +$('progHA').value || 0;

    const cicloP = +$('cicloP').value || 1;
    const vidaP = +$('vidaP').value || 1;
    const ajusteMinP = +$('ajusteMinP').value || 0;
    const progHP = +$('progHP').value || 0;

    const costoHerr = +$('costoHerr').value || 0;
    const metodoPerdidas = $('metodoPerdidas').value;
    const inversion = +$('inversion').value || 0;

    // Productividad
    const pphA = 3600 / cicloA; // piezas por hora
    const pphP = 3600 / cicloP;
    const pdiaA = pphA * horasProductivas;
    const pdiaP = pphP * horasProductivas;
    const pmesA = pdiaA * diasMes;
    const pmesP = pdiaP * diasMes;

    // Mejora productiva valorada por valor de pieza (ingreso evitado / output extra)
    const mejoraProdMensual = Math.max(0, (pmesP - pmesA)) * costoPieza;

    // Herramienta: costo diario ≈ (pzas/día / vida) * costo
    const costHerrDiaA = (vidaA>0) ? (pdiaA / vidaA) * costoHerr : 0;
    const costHerrDiaP = (vidaP>0) ? (pdiaP / vidaP) * costoHerr : 0;
    const ahorroHerrMensual = Math.max(0, (costHerrDiaA - costHerrDiaP)) * diasMes;

    // Piezas perdidas por ajuste (día)
    const perdidasDiaA = (ajusteMinA * 60) / cicloA;
    const perdidasDiaP = (ajusteMinP * 60) / cicloP;

    let ahorroPerdidasMensual = 0;
    let ahorroAjusteMensual = 0;
    if(metodoPerdidas === 'pieza'){
      ahorroPerdidasMensual = Math.max(0, (perdidasDiaA - perdidasDiaP)) * costoPieza * diasMes;
    } else {
      const horasAjusteA = ajusteMinA / 60;
      const horasAjusteP = ajusteMinP / 60;
      ahorroAjusteMensual = Math.max(0, (horasAjusteA - horasAjusteP)) * costoHora * diasMes;
    }

    // Programación (horas/mes)
    const ahorroProgMensual = Math.max(0, (progHA - progHP)) * costoHora;

    const ahorroTotalMensual = mejoraProdMensual + ahorroHerrMensual + ahorroPerdidasMensual + ahorroAjusteMensual + ahorroProgMensual;

    // KPI ROI / Payback
    const ahorroAnual = ahorroTotalMensual * 12;
    const paybackMeses = (inversion > 0 && ahorroTotalMensual > 0) ? (inversion / ahorroTotalMensual) : null;
    const roiAnual = (inversion > 0) ? (ahorroAnual - inversion) / inversion : null;

    // PINTA
    $('ahorroTotal').textContent = money(ahorroTotalMensual);
    $('ahorroProd').textContent = money(mejoraProdMensual);
    $('ahorroHerr').textContent = money(ahorroHerrMensual);
    $('ahorroPerdidas').textContent = money(ahorroPerdidasMensual);
    $('ahorroAjuste').textContent = money(ahorroAjusteMensual);
    $('ahorroProg').textContent = money(ahorroProgMensual);

    $('pph').textContent = `${fmt(pphA)} → ${fmt(pphP)} pzas/h`;
    $('pdia').textContent = `${fmt(pdiaA)} → ${fmt(pdiaP)} pzas/día`;
    $('pmes').textContent = `${fmt(pmesA)} → ${fmt(pmesP)} pzas/mes`;
    $('costHerrDia').textContent = `${money(costHerrDiaA)} → ${money(costHerrDiaP)}`;
    $('perdidasDia').textContent = `${fmt(perdidasDiaA)} → ${fmt(perdidasDiaP)} pzas/día`;
    $('ajusteH').textContent = `${fmt(ajusteMinA/60)} → ${fmt(ajusteMinP/60)} h/día`;

    $('payback').textContent = (paybackMeses==null || !isFinite(paybackMeses)) ? '—' : fmt(paybackMeses);
    $('roi').textContent = (roiAnual==null) ? '—' : (fmt(roiAnual*100) + '%');

    drawCharts({
      data: [mejoraProdMensual, ahorroHerrMensual, (metodoPerdidas==='pieza'?ahorroPerdidasMensual:ahorroAjusteMensual), ahorroProgMensual],
      labels: ['Productividad','Herramienta', (metodoPerdidas==='pieza'?'Piezas perdidas':'Tiempo de ajuste'), 'Programación']
    }, {
      pphA, pphP, pdiaA, pdiaP
    });
  }

  function drawCharts(ahorros, prod){
    const ctxA = document.getElementById('chartAhorros');
    const ctxB = document.getElementById('chartProductividad');

    if(chartA) chartA.destroy();
    if(chartB) chartB.destroy();

    chartA = new Chart(ctxA, {
      type: 'bar',
      data: {
        labels: ahorros.labels,
        datasets: [{ label: 'USD/mes', data: ahorros.data }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    chartB = new Chart(ctxB, {
      type: 'bar',
      data: {
        labels: ['Pzas/h (A)', 'Pzas/h (P)', 'Pzas/día (A)', 'Pzas/día (P)'],
        datasets: [{ label: 'Productividad', data: [prod.pphA, prod.pphP, prod.pdiaA, prod.pdiaP] }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  // Eventos
  inputs.forEach(el => el.addEventListener('input', recalc));
  $('btnReset').addEventListener('click', () => { window.location.reload(); });
  $('btnExport').addEventListener('click', () => {
    const payload = {};
    inputs.forEach(el => payload[el.id] = el.value);
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'config_calculadora.json'; a.click();
    URL.revokeObjectURL(url);
  });

  // Init
  recalc();
</script>
</body>
</html>
