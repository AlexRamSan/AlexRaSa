<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora Costo‑Beneficio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{color-scheme:light dark}
    /* ===== Layout Base ===== */
    .wrap{ @apply max-w-7xl mx-auto px-4 md:px-6 pb-16; }
    .card{ @apply rounded-2xl shadow p-5 md:p-6 bg-white/85 dark:bg-slate-900/75 border border-slate-200/60 dark:border-slate-800/60; }
    .section{ @apply space-y-4 md:space-y-5; }
    .h2{ @apply text-xl md:text-2xl font-bold tracking-tight; }
    .h3{ @apply text-lg md:text-xl font-semibold; }
    .muted{ @apply text-slate-600 dark:text-slate-400; }
    .kpi{ @apply text-3xl font-extrabold tracking-tight; }

    /* ===== Inputs compactos ===== */
    .input{ width:100%; border-radius:0.75rem; border:1px solid; padding:0.45rem 0.65rem; background:white; color:#0f172a; border-color:#cbd5e1; height:2.25rem; font-size:16px; }
    .dark .input{ background:#0f172a; color:#f8fafc; border-color:#1f2937; }
    .input:focus{ outline:none; box-shadow:0 0 0 3px rgba(99,102,241,.25); border-color:#6366f1; }
    input[type=number]{ text-align:right; font-variant-numeric:tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }

    /* ===== Tabla ===== */
    table.comp{ @apply w-full text-sm border-separate; border-spacing:0 8px; }
    table.comp th{ @apply text-left text-slate-500 dark:text-slate-400 px-4; }
    table.comp td{ @apply px-4 py-3; }
    tr.row{ @apply bg-white/70 dark:bg-slate-900/70 shadow rounded-xl border border-slate-200/60 dark:border-slate-800/60; }
    .delta{ @apply inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold border; }
    .delta.up{ @apply text-emerald-600 dark:text-emerald-400 border-emerald-300/40 bg-emerald-500/10; }
    .delta.down{ @apply text-rose-600 dark:text-rose-400 border-rose-300/40 bg-rose-500/10; }

    /* ===== Charts ===== */
    .chart-wrap{ @apply rounded-2xl p-4 bg-white/60 dark:bg-slate-900/50 border border-slate-200/60 dark:border-slate-800/60; }
    canvas{ display:block; width:100% !important; height:260px !important; }

    /* ===== Header compacto ===== */
    .hero{ @apply relative overflow-hidden border-b border-slate-200/60 dark:border-slate-800/60; }
    .hero .inner{ @apply wrap py-6 md:py-8; } /* menos alto */
    .hero h1{ @apply text-2xl md:text-3xl font-black tracking-tight; }
    .hero p{ @apply muted mt-2; }
    .hero-bg{ @apply absolute inset-0 -z-10 opacity-40; }

    /* ===== Responsive Grid principal: izquierda (formularios) / derecha (KPIs+gráficas) ===== */
    .grid-main{ @apply wrap grid gap-8 lg:gap-10 lg:grid-cols-[520px,1fr]; }
    @media (max-width:1023px){ .grid-main{ @apply grid-cols-1; } }
  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100">
  <!-- HEADER COMPACTO -->
  <header class="hero">
    <div class="hero-bg">
      <svg viewBox="0 0 1200 260" class="w-full h-full" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="#6366F1"/>
            <stop offset="50%" stop-color="#0EA5E9"/>
            <stop offset="100%" stop-color="#22C55E"/>
          </linearGradient>
        </defs>
        <path d="M0,200 C260,240 420,120 720,160 C960,180 1080,100 1200,140 L1200,0 L0,0 Z" fill="url(#g1)" opacity="0.25"></path>
      </svg>
    </div>
    <div class="inner">
      <div class="flex items-end justify-between">
        <div>
          <h1>Calculadora Costo‑Beneficio</h1>
          <p>Secciones claras, campos compactos y **gráficas al lado derecho**. Autosave + PDF.</p>
        </div>
        <div class="hidden md:flex gap-2">
          <button id="btnReset" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700">Restablecer</button>
          <button id="btnExport" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700">Exportar JSON</button>
        </div>
      </div>
    </div>
  </header>

  <!-- GRID PRINCIPAL: IZQ (FORM) / DER (KPIs + CHARTS + COMP) -->
  <div class="grid-main">
    <!-- COLUMNA IZQUIERDA: FORMULARIOS POR SECCIONES -->
    <main class="space-y-6">
      <section class="card section">
        <h2 class="h2">Parámetros</h2>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm font-semibold mb-1">Días productivos/mes</label>
            <input id="diasMes" type="number" step="1" value="30" class="input" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Costo hora máquina (USD/hr)</label>
            <input id="costoHora" type="number" step="0.01" value="125" class="input" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">Costo por pieza (USD/pza)</label>
            <input id="costoPieza" type="number" step="0.01" value="60" class="input" />
          </div>
        </div>
      </section>

      <section class="card section">
        <h2 class="h2">Jornada y disponibilidad</h2>
        <div class="grid gap-4 md:grid-cols-2">
          <div><label class="block text-sm font-semibold mb-1">Horas por turno</label><input id="horasTurno" type="number" step="0.25" value="8" class="input" /></div>
          <div><label class="block text-sm font-semibold mb-1">Hora de comida (por turno)</label><input id="horaComida" type="number" step="0.25" value="0.5" class="input" /></div>
          <div><label class="block text-sm font-semibold mb-1">Turnos por día</label><input id="turnos" type="number" step="1" value="3" class="input" /></div>
          <div><label class="block text-sm font-semibold mb-1">Horas productivas/día</label><input id="horasProductivas" type="number" step="0.25" value="22.5" class="input" /></div>
        </div>
      </section>

      <section class="card section">
        <h2 class="h2">Proceso</h2>
        <div class="grid gap-6">
          <div>
            <h3 class="h3 mb-2">Actual</h3>
            <div class="grid gap-3 md:grid-cols-2">
              <div><label class="block text-sm font-semibold mb-1">Tiempo de ciclo (s)</label><input id="cicloA" type="number" step="0.1" value="370" class="input" /></div>
              <div><label class="block text-sm font-semibold mb-1">Vida herramienta (pzas)</label><input id="vidaA" type="number" step="1" value="1500" class="input" /></div>
              <div><label class="block text-sm font-semibold mb-1">Tiempo de ajuste (min/día)</label><input id="ajusteMinA" type="number" step="1" value="1440" class="input" /></div>
              <div><label class="block text-sm font-semibold mb-1">Tiempo de programación (h/mes)</label><input id="progHA" type="number" step="0.1" value="4" class="input" /></div>
            </div>
          </div>
          <div>
            <h3 class="h3 mb-2">Propuesta</h3>
            <div class="grid gap-3 md:grid-cols-2">
              <div><label class="block text-sm font-semibold mb-1">Tiempo de ciclo (s)</label><input id="cicloP" type="number" step="0.1" value="360" class="input" /></div>
              <div><label class="block text-sm font-semibold mb-1">Vida herramienta (pzas)</label><input id="vidaP" type="number" step="1" value="2500" class="input" /></div>
              <div><label class="block text-sm font-semibold mb-1">Tiempo de ajuste (min/día)</label><input id="ajusteMinP" type="number" step="1" value="20" class="input" /></div>
              <div><label class="block text-sm font-semibold mb-1">Tiempo de programación (h/mes)</label><input id="progHP" type="number" step="0.1" value="0" class="input" /></div>
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-2">
            <div><label class="block text-sm font-semibold mb-1">Costo herramienta (USD)</label><input id="costoHerr" type="number" step="0.01" value="15" class="input" /></div>
            <div><label class="block text-sm font-semibold mb-1">Inversión inicial (USD)</label><input id="inversion" type="number" step="0.01" value="0" class="input" /></div>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm font-semibold">Método de pérdidas</label>
            <select id="metodoPerdidas" class="input">
              <option value="pieza" selected>Por valor de pieza</option>
              <option value="hora">Por costo hora (ajuste)</option>
            </select>
          </div>
        </div>
      </section>
    </main>

    <!-- COLUMNA DERECHA: KPIs + GRÁFICAS + COMPARATIVA + PDF -->
    <aside class="space-y-6">
      <section class="card section">
        <h2 class="h2">ROI & Payback</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="muted text-xs">Ahorro mensual total</div>
            <div id="ahorroTotal" class="kpi select-none">$0</div>
          </div>
          <div>
            <div class="muted text-xs">ROI anual</div>
            <div id="roi" class="kpi select-none">—</div>
          </div>
          <div class="col-span-2">
            <div class="muted text-xs">Payback</div>
            <div class="flex items-end gap-2">
              <div id="payback" class="kpi select-none">—</div>
              <span class="muted mb-1">meses</span>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 pt-2">
          <button id="btnPDF" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700">Descargar PDF</button>
          <button id="btnClearStorage" class="px-3 py-2 rounded-xl border border-rose-300 text-rose-700 dark:border-rose-700 dark:text-rose-300">Borrar guardado</button>
        </div>
      </section>

      <section class="section">
        <div class="chart-wrap"><canvas id="chartAhorros"></canvas></div>
        <div class="chart-wrap"><canvas id="chartProductividad"></canvas></div>
      </section>

      <section class="card section" id="comparativa">
        <h2 class="h2">Comparativa rápida</h2>
        <div class="overflow-x-auto">
          <table class="comp">
            <thead>
              <tr>
                <th>Métrica</th>
                <th>Actual</th>
                <th>Propuesta</th>
                <th>Δ Mejora</th>
              </tr>
            </thead>
            <tbody id="tbodyComp"></tbody>
          </table>
        </div>
        <div class="grid gap-2 md:grid-cols-2 text-sm pt-2">
          <div><span class="muted">Pzas/h:</span> <span id="pph"></span></div>
          <div><span class="muted">Pzas/día:</span> <span id="pdia"></span></div>
          <div><span class="muted">Pzas/mes:</span> <span id="pmes"></span></div>
          <div><span class="muted">Costo herr. diario A→P:</span> <span id="costHerrDia"></span></div>
          <div><span class="muted">Pzas perdidas/día A→P:</span> <span id="perdidasDia"></span></div>
          <div><span class="muted">Ajuste (h/día) A→P:</span> <span id="ajusteH"></span></div>
        </div>
      </section>
    </aside>
  </div>

  <footer class="wrap py-10 text-center muted">
    Hecha por AlexRaSa + GPT · Tailwind + Chart.js · <span class="text-xs">Autosave</span>
  </footer>

<script>
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=2) => Number(n).toLocaleString(undefined, {maximumFractionDigits: d});
  const money = (n) => `$${fmt(n)}`;
  const FIELD_IDS = ['diasMes','costoHora','costoPieza','horasTurno','horaComida','turnos','horasProductivas','cicloA','vidaA','ajusteMinA','progHA','cicloP','vidaP','ajusteMinP','progHP','costoHerr','metodoPerdidas','inversion'];
  const LS_KEY = 'calc_cb_config_v4';
  let chartA, chartB;
  let chartReady = false;

  function loadFromStorage(){ try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return; const obj = JSON.parse(raw); FIELD_IDS.forEach(id => { if(obj[id] !== undefined) $(id).value = obj[id]; }); }catch(e){}
  }
  function saveToStorage(){ const payload = {}; FIELD_IDS.forEach(id => payload[id] = $(id).value); localStorage.setItem(LS_KEY, JSON.stringify(payload)); }

  function recalc(){
    if(!chartReady){ scheduleChartsInit(); }

    const diasMes = +$('diasMes').value || 0;
    const costoHora = +$('costoHora').value || 0;
    const costoPieza = +$('costoPieza').value || 0;
    const horasTurno = +$('horasTurno').value || 0;
    const horaComida = +$('horaComida').value || 0;
    const turnos = +$('turnos').value || 0;
    let horasProductivas = +$('horasProductivas').value || 0;
    if(!horasProductivas){ horasProductivas = turnos * Math.max(0, (horasTurno - horaComida)); $('horasProductivas').value = horasProductivas; }

    const cicloA = +$('cicloA').value || 1;
    const vidaA = +$('vidaA').value || 1;
    const ajusteMinA = +$('ajusteMinA').value || 0;
    const progHA = +$('progHA').value || 0;
    const cicloP = +$('cicloP').value || 1;
    const vidaP = +$('vidaP').value || 1;
    const ajusteMinP = +$('ajusteMinP').value || 0;
    const progHP = +$('progHP').value || 0;

    const costoHerr = +$('costoHerr').value || 0;
    const metodoPerdidas = $('metodoPerdidas').value;
    const inversion = +$('inversion').value || 0;

    // Productividad
    const pphA = 3600 / cicloA, pphP = 3600 / cicloP;
    const pdiaA = pphA * horasProductivas, pdiaP = pphP * horasProductivas;
    const pmesA = pdiaA * diasMes, pmesP = pdiaP * diasMes;

    const mejoraProdMensual = Math.max(0, (pmesP - pmesA)) * costoPieza;

    const costHerrDiaA = (vidaA>0) ? (pdiaA / vidaA) * costoHerr : 0;
    const costHerrDiaP = (vidaP>0) ? (pdiaP / vidaP) * costoHerr : 0;
    const ahorroHerrMensual = Math.max(0, (costHerrDiaA - costHerrDiaP)) * diasMes;

    const perdidasDiaA = (ajusteMinA * 60) / cicloA;
    const perdidasDiaP = (ajusteMinP * 60) / cicloP;

    let ahorroPerdidasMensual = 0, ahorroAjusteMensual = 0;
    if(metodoPerdidas === 'pieza'){
      ahorroPerdidasMensual = Math.max(0, (perdidasDiaA - perdidasDiaP)) * costoPieza * diasMes;
    } else {
      const horasAjusteA = ajusteMinA / 60, horasAjusteP = ajusteMinP / 60;
      ahorroAjusteMensual = Math.max(0, (horasAjusteA - horasAjusteP)) * costoHora * diasMes;
    }

    const ahorroProgMensual = Math.max(0, (progHA - progHP)) * costoHora;
    const ahorroTotalMensual = mejoraProdMensual + ahorroHerrMensual + ahorroPerdidasMensual + ahorroAjusteMensual + ahorroProgMensual;

    const ahorroAnual = ahorroTotalMensual * 12;
    const paybackMeses = (inversion > 0 && ahorroTotalMensual > 0) ? (inversion / ahorroTotalMensual) : null;
    const roiAnual = (inversion > 0) ? (ahorroAnual - inversion) / inversion : null;

    // KPIs
    $('ahorroTotal').textContent = money(ahorroTotalMensual);
    $('roi').textContent = (roiAnual==null) ? '—' : (fmt(roiAnual*100)+'%');
    $('payback').textContent = (paybackMeses==null || !isFinite(paybackMeses)) ? '—' : fmt(paybackMeses);

    // Resultados
    $('ahorroProd').textContent = money(mejoraProdMensual);
    $('ahorroHerr').textContent = money(ahorroHerrMensual);
    document.getElementById('ahorroPerdidas')?.replaceChildren(document.createTextNode(money(ahorroPerdidasMensual + ahorroAjusteMensual)));
    $('ahorroProg').textContent = money(ahorroProgMensual);

    // Resumen comparativo
    $('pph').textContent = `${fmt(pphA)} → ${fmt(pphP)} pzas/h`;
    $('pdia').textContent = `${fmt(pdiaA)} → ${fmt(pdiaP)} pzas/día`;
    $('pmes').textContent = `${fmt(pmesA)} → ${fmt(pmesP)} pzas/mes`;
    $('costHerrDia').textContent = `${money(costHerrDiaA)} → ${money(costHerrDiaP)}`;
    $('perdidasDia').textContent = `${fmt(perdidasDiaA)} → ${fmt(perdidasDiaP)} pzas/día`;
    $('ajusteH').textContent = `${fmt(ajusteMinA/60)} → ${fmt(ajusteMinP/60)} h/día`;

    drawCharts({
      labels:['Productividad','Herramienta','Pérdidas/Ajuste','Programación'],
      data:[mejoraProdMensual, ahorroHerrMensual, (metodoPerdidas==='pieza'?ahorroPerdidasMensual:ahorroAjusteMensual), ahorroProgMensual]
    }, { pphA, pphP, pdiaA, pdiaP });

    renderTabla([
      ['Tiempo de ciclo (s)', cicloA, cicloP, ((cicloA-cicloP)/cicloA*100)],
      ['Pzas/h', pphA, pphP, ((pphP-pphA)/pphA*100)],
      ['Pzas/día', pdiaA, pdiaP, ((pdiaP-pdiaA)/pdiaA*100)],
      ['Vida herramienta (pzas)', vidaA, vidaP, ((vidaP-vidaA)/vidaA*100)],
      ['Ajuste (min/día)', ajusteMinA, ajusteMinP, ((ajusteMinA-ajusteMinP)/ajusteMinA*100)],
    ]);

    saveToStorage();
  }

  function drawCharts(ahorros, prod){
    const ctxA = document.getElementById('chartAhorros');
    const ctxB = document.getElementById('chartProductividad');
    if(!window.Chart || !ctxA || !ctxB){ return; }
    if(chartA) chartA.destroy(); if(chartB) chartB.destroy();
    chartA = new Chart(ctxA, { type:'doughnut', data:{ labels:ahorros.labels, datasets:[{ data:ahorros.data }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
    chartB = new Chart(ctxB, { type:'bar', data:{ labels:['Pzas/h (A)','Pzas/h (P)','Pzas/día (A)','Pzas/día (P)'], datasets:[{ data:[prod.pphA, prod.pphP, prod.pdiaA, prod.pdiaP] }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
  }
  function scheduleChartsInit(){
    // Espera a que Chart.js esté disponible y el layout esté pintado
    const tryInit = () => {
      const ok = !!window.Chart && document.getElementById('chartAhorros') && document.getElementById('chartProductividad');
      if(ok){ chartReady = true; recalc(); }
      else { setTimeout(tryInit, 100); }
    };
    if(!chartReady) setTimeout(tryInit, 100);
  }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
    chartB = new Chart(ctxB, { type:'bar', data:{ labels:['Pzas/h (A)','Pzas/h (P)','Pzas/día (A)','Pzas/día (P)'], datasets:[{ data:[prod.pphA, prod.pphP, prod.pdiaA, prod.pdiaP] }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
  }

  function renderTabla(rows){
    const tbody = document.getElementById('tbodyComp');
    tbody.innerHTML = '';
    rows.forEach(([name,a,p,delta]) => {
      const up = (typeof a==='number' && typeof p==='number') ? (p>a) : false;
      const cls = up ? 'delta up' : 'delta down';
      const row = document.createElement('tr'); row.className = 'row';
      row.innerHTML = `<td>${name}</td><td>${fmt(a)}</td><td>${fmt(p)}</td><td><span class="${cls}">${(delta>=0?'+':'')+fmt(delta,1)}%</span></td>`;
      tbody.appendChild(row);
    });
  }

  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4' });
    const margin = 32; let y = margin;
    const date = new Date().toLocaleString();

    pdf.setFont('helvetica','bold'); pdf.setFontSize(16);
    pdf.text('Resumen Costo‑Beneficio', margin, y); y += 18;
    pdf.setFont('helvetica','normal'); pdf.setFontSize(10);
    pdf.text(`Generado: ${date}`, margin, y); y += 16;

    const ahorro = document.getElementById('ahorroTotal').textContent;
    const roi = document.getElementById('roi').textContent;
    const payback = document.getElementById('payback').textContent;
    pdf.setFontSize(12);
    pdf.text(`Ahorro mensual total: ${ahorro}`, margin, y); y += 16;
    pdf.text(`ROI anual: ${roi}`, margin, y); y += 16;
    pdf.text(`Payback: ${payback} meses`, margin, y); y += 24;

    const c1 = document.getElementById('chartAhorros');
    const c2 = document.getElementById('chartProductividad');
    for (const c of [c1,c2]){ const dataURL = c.toDataURL('image/png', 1.0); pdf.addImage(dataURL, 'PNG', margin, y, 531, 200); y += 210; }

    const comp = document.getElementById('comparativa');
    const canvas = await html2canvas(comp, { scale: 2, backgroundColor: null });
    const img = canvas.toDataURL('image/png', 1.0);
    if (y + 300 > 800) { pdf.addPage(); y = margin; }
    pdf.addImage(img, 'PNG', margin, y, 531, 0);

    pdf.save('Resumen_Costo_Beneficio.pdf');
  }

  // Eventos
  FIELD_IDS.forEach(id => $(id).addEventListener('input', recalc));
  document.getElementById('btnExport').addEventListener('click', () => { const payload = {}; FIELD_IDS.forEach(id => payload[id] = $(id).value); const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href = url; a.download = 'config_calculadora.json'; a.click(); URL.revokeObjectURL(url); });
  document.getElementById('btnReset').addEventListener('click', () => { localStorage.removeItem(LS_KEY); window.location.reload(); });
  document.getElementById('btnClearStorage').addEventListener('click', () => { localStorage.removeItem(LS_KEY); alert('Guardado local eliminado'); });
  document.getElementById('btnPDF').addEventListener('click', generatePDF);

  // INIT
  (function init(){
    loadFromStorage();
    // Asegurar que las gráficas se inicialicen cuando Chart.js esté listo
    if(window.Chart){ chartReady = true; }
    // Recalc inicial tras primer frame para que los canvas tengan tamaño
    requestAnimationFrame(() => { recalc(); });
    // Redibujar al redimensionar
    window.addEventListener('resize', () => { if(chartA||chartB) recalc(); });
  })();
</script>
</body>
</html>
