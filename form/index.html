<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Leads — Evento | AlexRaSa</title>
  <meta name="description" content="Formulario rápido para capturar leads. Guarda localmente y sincroniza con Google Sheets." />
  <meta name="theme-color" content="#0F172A" />

  <!-- Tailwind (rápido para evento). Si luego quieres build local, te paso guía. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{base:{900:'#0F172A',800:'#1E293B'}}}}}</script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="bg-base-900 text-white">
    <div class="max-w-xl mx-auto px-4 h-14 flex items-center justify-between">
      <h1 class="text-base font-semibold">Registro de Leads — Evento</h1>
      <span id="cloudStatus" class="text-xs inline-flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
        Sincronización pendiente
      </span>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
      <form id="leadForm" class="grid gap-3">
        <input type="hidden" id="leadId" />
        <div>
          <label class="block text-sm font-medium">Empresa *</label>
          <input id="empresa" required class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Nombre de la empresa" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Contacto *</label>
            <input id="contacto" required class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Nombre completo" />
          </div>
          <div>
            <label class="block text-sm font-medium">Puesto</label>
            <input id="puesto" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Puesto / rol" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Teléfono</label>
            <input id="telefono" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="WhatsApp / fijo" />
          </div>
          <div>
            <label class="block text-sm font-medium">Email</label>
            <input id="email" type="email" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="correo@empresa.com" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Ciudad</label>
            <input id="ciudad" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Querétaro" />
          </div>
          <div>
            <label class="block text-sm font-medium">Estado</label>
            <input id="estado" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Qro." />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Industria</label>
          <input id="industria" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Automotriz, aeroespacial..." />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium"># Máquinas CNC</label>
            <input id="maquinas" type="number" min="0" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="p.ej. 5" />
          </div>
          <div>
            <label class="block text-sm font-medium">Interés</label>
            <select id="interes" class="mt-1 w-full rounded-md border border-slate-300 p-2">
              <option value="">—</option><option>Bajo</option><option>Medio</option><option>Alto</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Origen</label>
            <select id="origen" class="mt-1 w-full rounded-md border border-slate-300 p-2">
              <option>Evento</option><option>Webinar</option><option>Referencia</option><option>LinkedIn</option><option>Otro</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Siguiente paso</label>
            <input id="nextDate" type="date" class="mt-1 w-full rounded-md border border-slate-300 p-2" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Notas</label>
          <textarea id="notas" rows="3" class="mt-1 w-full rounded-md border border-slate-300 p-2" placeholder="Resumen, oportunidades, módulos de interés..."></textarea>
        </div>

        <button type="submit" class="mt-1 px-4 py-2 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700">
          Guardar lead
        </button>

        <p id="miniMsg" class="text-xs text-slate-600 mt-1">Se guarda localmente y se sincroniza con la nube cuando hay conexión.</p>
      </form>
    </section>
  </main>

  <script>
    /* ===== Config ===== */
    const WEB_APP_URL = '/api/sendLead';               // proxy en Vercel (evita CORS)
    const STORAGE_KEY = 'alexrasa_event_leads_v1';     // leads guardados
    const PENDING_KEY = 'alexrasa_event_leads_pending_v1'; // cola para sincronizar

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const statusEl = $('#cloudStatus');
    const form = $('#leadForm');
    const miniMsg = $('#miniMsg');

    const inputs = {
      id: $('#leadId'), empresa: $('#empresa'), contacto: $('#contacto'), puesto: $('#puesto'),
      telefono: $('#telefono'), email: $('#email'), ciudad: $('#ciudad'), estado: $('#estado'),
      industria: $('#industria'), maquinas: $('#maquinas'), interes: $('#interes'),
      origen: $('#origen'), nextDate: $('#nextDate'), notas: $('#notas')
    };

    const nowISO = ()=> new Date().toISOString();
    const load  = (k,d=[]) => { try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };
    const save  = (k,v) => localStorage.setItem(k, JSON.stringify(v));

    function setStatus(state){
      // state: 'pending' | 'syncing' | 'ok'
      if(state==='syncing'){
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-400"></span> Sincronizando...';
      } else if(state==='ok'){
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Sincronizado';
      } else {
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-400"></span> Sincronización pendiente';
      }
    }

    function formToLead(){
      return {
        id: inputs.id.value || crypto.randomUUID(),
        fecha: new Date().toLocaleDateString('es-MX'),
        createdAt: nowISO(),
        empresa: inputs.empresa.value.trim(),
        contacto: inputs.contacto.value.trim(),
        puesto: inputs.puesto.value.trim(),
        telefono: inputs.telefono.value.trim(),
        email: inputs.email.value.trim(),
        ciudad: inputs.ciudad.value.trim(),
        estado: inputs.estado.value.trim(),
        industria: inputs.industria.value.trim(),
        maquinas: inputs.maquinas.value ? Number(inputs.maquinas.value) : '',
        interes: inputs.interes.value,
        origen: inputs.origen.value,
        nextDate: inputs.nextDate.value,
        notas: inputs.notas.value.trim()
      };
    }

    function queuePending(lead){
      const q = load(PENDING_KEY,[]);
      if (!q.find(x=>x.id===lead.id)) q.push(lead);
      save(PENDING_KEY,q);
      setStatus('pending');
    }

    async function sendToCloud(lead){
      try{
        const r = await fetch(WEB_APP_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(lead) });
        const text = await r.text(); let data=null; try{ data=JSON.parse(text) }catch{}
        return (r.ok && data && data.ok);
      }catch{ return false; }
    }

    async function syncPending(){
      const q = load(PENDING_KEY,[]);
      if (!q.length){ setStatus('ok'); return; }
      setStatus('syncing');
      const okIds = [];
      for (const it of q){
        const ok = await sendToCloud(it);
        if (ok) okIds.push(it.id);
      }
      const remaining = q.filter(x=>!okIds.includes(x.id));
      save(PENDING_KEY, remaining);
      setStatus(remaining.length ? 'pending' : 'ok');
    }

    /* ===== Eventos ===== */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!inputs.empresa.value.trim() || !inputs.contacto.value.trim()){
        miniMsg.textContent = 'Empresa y Contacto son obligatorios.'; miniMsg.className='text-xs text-rose-700 mt-1';
        return;
      }
      const lead = formToLead();

      // Guarda local
      const all = load(STORAGE_KEY,[]);
      const idx = all.findIndex(l=>l.id===lead.id);
      if (idx>=0) all[idx] = { ...all[idx], ...lead }; else all.push(lead);
      save(STORAGE_KEY, all);

      // Intenta nube
      const ok = await sendToCloud(lead);
      if(!ok) queuePending(lead); else setStatus('ok');

      // Reset y feedback
      form.reset(); inputs.id.value='';
      miniMsg.textContent = ok ? 'Guardado y sincronizado.' : 'Guardado local. Se sincronizará cuando haya conexión.';
      miniMsg.className = ok ? 'text-xs text-emerald-700 mt-1' : 'text-xs text-amber-700 mt-1';
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // Sincroniza automáticamente cuando vuelva la conexión o al cargar
    window.addEventListener('online', syncPending);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') syncPending(); });
    window.addEventListener('load', ()=>{ const pending = load(PENDING_KEY,[]); setStatus(pending.length ? 'pending' : 'ok'); syncPending(); });
  </script>
</body>
</html>
