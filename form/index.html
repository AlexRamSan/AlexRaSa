<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Leads — Evento | AlexRaSa</title>
  <meta name="description" content="Formulario offline para capturar leads durante un evento. Persiste en LocalStorage y también sube a Google Sheets." />
  <meta name="theme-color" content="#0F172A" />
  <link rel="icon" href="/assets/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{base:{900:'#0F172A',800:'#1E293B'}}}}}</script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="bg-base-900 text-white py-4">
    <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">Registro de Leads — Evento</h1>
      <div class="text-sm opacity-80 flex items-center gap-2">
        <span id="cloudStatus" class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> Sincronización pendiente</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-6 md:grid-cols-3">
    <section class="md:col-span-1 bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">Nuevo lead</h2>
      <form id="leadForm" class="grid gap-3">
        <input type="hidden" id="leadId" />
        <div><label class="block text-sm font-medium">Empresa *</label><input id="empresa" required class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Nombre de la empresa"/></div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-medium">Contacto *</label><input id="contacto" required class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Nombre completo"/></div>
          <div><label class="block text-sm font-medium">Puesto</label><input id="puesto" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Puesto / rol"/></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-medium">Teléfono</label><input id="telefono" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="WhatsApp / fijo"/></div>
          <div><label class="block text-sm font-medium">Email</label><input id="email" type="email" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="correo@empresa.com"/></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-medium">Ciudad</label><input id="ciudad" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Querétaro"/></div>
          <div><label class="block text-sm font-medium">Estado</label><input id="estado" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Qro."/></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-medium">Industria</label><input id="industria" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Automotriz, aeroespacial..."/></div>
          <div><label class="block text-sm font-medium">Tamaño (máquinas CNC)</label><input id="maquinas" type="number" min="0" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="p.ej. 5"/></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-medium">Interés</label><select id="interes" class="mt-1 w-full rounded-xl border border-slate-300 p-2"><option value="">—</option><option>Bajo</option><option>Medio</option><option>Alto</option></select></div>
          <div><label class="block text-sm font-medium">Origen</label><select id="origen" class="mt-1 w-full rounded-xl border border-slate-300 p-2"><option>Evento</option><option>Webinar</option><option>Referencia</option><option>LinkedIn</option><option>Otro</option></select></div>
        </div>
        <div><label class="block text-sm font-medium">Siguiente paso (fecha)</label><input id="nextDate" type="date" class="mt-1 w-full rounded-xl border border-slate-300 p-2"/></div>
        <div><label class="block text-sm font-medium">Notas</label><textarea id="notas" rows="3" class="mt-1 w-full rounded-xl border border-slate-300 p-2" placeholder="Resumen, oportunidades, objetivos..."></textarea></div>
        <div class="flex gap-2 pt-1">
          <button type="submit" class="px-3 py-2 rounded-xl bg-base-800 text-white font-medium hover:opacity-90" id="btnGuardar">Guardar</button>
          <button type="button" class="px-3 py-2 rounded-xl border border-slate-300" id="btnLimpiar">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="md:col-span-2 grid gap-6">
      <div class="bg-white rounded-2xl shadow p-4 flex flex-wrap items-center gap-3">
        <div class="flex gap-2">
          <button id="btnExportXLSX" class="px-3 py-2 rounded-xl bg-base-800 text-white hover:opacity-90">Exportar Excel (.xlsx)</button>
          <button id="btnExportCSV" class="px-3 py-2 rounded-xl border border-slate-300">Exportar CSV</button>
          <button id="btnBackup" class="px-3 py-2 rounded-xl border border-slate-300">Respaldo (.json)</button>
        </div>
        <div class="flex items-center gap-2 ml-auto">
          <button id="btnTestCloud" class="px-3 py-2 rounded-xl border border-emerald-300 text-emerald-700">Probar conexión</button>
          <button id="btnSync" class="px-3 py-2 rounded-xl border border-blue-300 text-blue-700">Sincronizar</button>
          <button id="btnBorrarTodo" class="px-3 py-2 rounded-xl border border-rose-300 text-rose-700">Borrar todo</button>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="tabla"><thead class="bg-slate-100 text-slate-700"><tr><th class="px-3 py-2 text-left">#</th><th class="px-3 py-2 text-left">Fecha</th><th class="px-3 py-2 text-left">Empresa</th><th class="px-3 py-2 text-left">Contacto</th><th class="px-3 py-2 text-left">Teléfono</th><th class="px-3 py-2 text-left">Email</th><th class="px-3 py-2 text-left">Interés</th><th class="px-3 py-2 text-left">Origen</th><th class="px-3 py-2 text-left">Notas</th></tr></thead><tbody id="tbody"></tbody></table>
        </div>
      </div>
    </section>
  </main>

  <script>
    const WEB_APP_URL = '/api/sendLead'; // Reemplaza con tu URL
    const STORAGE_KEY='alexrasa_event_leads_v1';

    const form=document.querySelector('#leadForm');
    const tbody=document.querySelector('#tbody');
    const status=document.querySelector('#cloudStatus');

    function saveLocal(leads){localStorage.setItem(STORAGE_KEY,JSON.stringify(leads))}
    function loadLocal(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{return[]}}

    function render(){const leads=loadLocal();tbody.innerHTML=leads.map((l,i)=>`<tr><td class='px-3 py-1'>${i+1}</td><td class='px-3 py-1'>${l.fecha}</td><td class='px-3 py-1'>${l.empresa}</td><td class='px-3 py-1'>${l.contacto}</td><td class='px-3 py-1'>${l.telefono}</td><td class='px-3 py-1'>${l.email}</td><td class='px-3 py-1'>${l.interes}</td><td class='px-3 py-1'>${l.origen}</td><td class='px-3 py-1 truncate max-w-[20ch]'>${l.notas}</td></tr>`).join('')||`<tr><td colspan='9' class='text-center py-3 text-slate-500'>Sin datos</td></tr>`}

    async function sendToCloud(lead){try{const r=await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(lead)});const d=await r.json();if(d.ok){status.innerHTML='<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Conectado a Google Sheets';}else{status.innerHTML='<span class="w-2 h-2 rounded-full bg-yellow-400"></span> Error al enviar';}}catch{status.innerHTML='<span class="w-2 h-2 rounded-full bg-yellow-400"></span> No hay conexión';}}

    form.addEventListener('submit',e=>{e.preventDefault();const fd={id:crypto.randomUUID(),fecha:new Date().toLocaleDateString('es-MX'),empresa:empresa.value,contacto:contacto.value,telefono:telefono.value,email:email.value,interes:interes.value,origen:origen.value,notas:notas.value};const leads=loadLocal();leads.push(fd);saveLocal(leads);render();sendToCloud(fd);form.reset();});

    document.querySelector('#btnTestCloud').addEventListener('click',async()=>{status.innerHTML='Probando conexión...';try{const testLead={id:crypto.randomUUID(),fecha:new Date().toLocaleDateString('es-MX'),createdAt:new Date().toISOString(),empresa:'TEST',contacto:'Conexión',puesto:'',telefono:'',email:'',ciudad:'',estado:'',industria:'',maquinas:'',interes:'Test',origen:'Prueba',nextDate:'',notas:'Prueba de conexión desde el formulario'};const r=await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(testLead)});const d=await r.json();if(d.ok){alert('✅ Conectado correctamente a Google Sheets. Revisa tu hoja, verás un registro TEST.');status.innerHTML='<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Conectado';}else{throw new Error('Respuesta no OK');}}catch(e){alert('⚠️ Error al conectar. Revisa que tu Apps Script esté publicado como Web App.');status.innerHTML='<span class="w-2 h-2 rounded-full bg-yellow-400"></span> Fallo';}});

    render();
  </script>
</body>
</html>
